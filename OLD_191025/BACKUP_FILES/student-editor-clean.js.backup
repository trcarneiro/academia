(function() {
    'use strict';
    
    console.log('üöÄ Student Editor Clean - Starting...');

    // State variables
    let studentId = null;
    let studentData = null;
    let currentTab = 'profile';
    let isInitialized = false;

    // Main initialization function
    function initialize() {
        if (isInitialized) {
            console.log('‚ö†Ô∏è Student Editor already initialized');
            return;
        }

        console.log('üìã Initializing Student Editor Clean...');
        isInitialized = true;
        
        try {
            // Hide any loading states immediately
            hideLoadingStates();
            
            // Get student ID
            getStudentId();
            
            // Setup basic UI
            setupBasicUI();
            
            // Setup event listeners
            setupEventListeners();
            
            // Load data if we have an ID
            if (studentId) {
                loadStudentData();
            } else {
                showFallbackUI();
            }
            
            console.log('‚úÖ Student Editor Clean initialized successfully');
            
        } catch (error) {
            console.error('‚ùå Initialization error:', error);
            showFallbackUI();
        }
    }

    // Hide all loading states
    function hideLoadingStates() {
        const loadingState = document.getElementById('loadingState');
        if (loadingState) {
            loadingState.style.display = 'none';
        }
        
        const spinners = document.querySelectorAll('.loading-spinner, .spinner');
        spinners.forEach(spinner => {
            if (spinner.parentNode) {
                spinner.remove();
            }
        });
        
        console.log('üö´ Loading states hidden');
    }

    // Get student ID from localStorage
    function getStudentId() {
        try {
            const stored = localStorage.getItem('studentEditorMode');
            if (stored) {
                const data = JSON.parse(stored);
                if (data.studentId) {
                    studentId = data.studentId;
                    console.log('‚úÖ Student ID from localStorage:', studentId);
                    return;
                }
            }
        } catch (e) {
            console.warn('‚ö†Ô∏è Could not read from localStorage:', e);
        }

        // Fallback ID for testing
        studentId = 'd897294b-7baf-4249-ac55-8daf03affb73';
        console.log('‚ö†Ô∏è Using fallback student ID:', studentId);
    }

    // Setup basic UI elements
    function setupBasicUI() {
        // Update header
        setElementText('editPageStudentName', 'Carregando dados do aluno...');
        setElementText('editPageStudentId', `ID: ${studentId || 'N/A'}`);
        setElementText('editPageStudentCategory', 'Categoria: Aguardando...');
        
        // Ensure profile tab is active
        const profileTab = document.querySelector('[data-tab="profile"]');
        const profileContent = document.getElementById('profile-content');
        
        if (profileTab) {
            profileTab.classList.add('active');
        }
        
        if (profileContent) {
            profileContent.classList.add('active');
            profileContent.style.display = 'block';
        }
        
        console.log('üé® Basic UI setup complete');
    }

    // Setup event listeners
    function setupEventListeners() {
        // Back button
        const backBtn = document.getElementById('back-to-list-btn');
        if (backBtn) {
            backBtn.addEventListener('click', handleBackClick);
        }

        // Save button
        const saveBtn = document.getElementById('save-student-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', handleSaveClick);
        }

        // Tab buttons
        document.querySelectorAll('.page-tab').forEach(button => {
            button.addEventListener('click', (e) => {
                const tabId = button.dataset.tab;
                switchTab(tabId);
            });
        });

        console.log('üéØ Event listeners setup complete');
    }

    // Event handlers
    function handleBackClick(e) {
        e.preventDefault();
        console.log('üîô Back button clicked');
        if (window.navigateToModule) {
            window.navigateToModule('students');
        } else {
            history.back();
        }
    }

    function handleSaveClick(e) {
        e.preventDefault();
        console.log('üíæ Save button clicked');
        saveStudentData();
    }

    // Switch between tabs
    function switchTab(tabId) {
        if (currentTab === tabId) return;
        
        console.log(`üîÑ Switching to tab: ${tabId}`);
        currentTab = tabId;

        // Update tab buttons
        document.querySelectorAll('.page-tab').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.tab === tabId) {
                btn.classList.add('active');
            }
        });

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            content.style.display = 'none';
        });
        
        const targetContent = document.getElementById(`${tabId}-content`);
        if (targetContent) {
            targetContent.classList.add('active');
            targetContent.style.display = 'block';
        }

        // Load financial data if needed
        if (tabId === 'financial') {
            loadFinancialData();
        }

        console.log(`‚úÖ Tab switched to: ${tabId}`);
    }

    // Load student data from API
    async function loadStudentData() {
        try {
            console.log(`üì° Loading student data for ID: ${studentId}`);
            
            const response = await fetch(`/api/students/${studentId}`);
            
            if (response.ok) {
                studentData = await response.json();
                console.log('‚úÖ Student data loaded:', studentData);
                populateStudentForm();
            } else {
                console.warn(`‚ö†Ô∏è API returned ${response.status}, using fallback`);
                showFallbackUI();
            }
            
        } catch (error) {
            console.warn('‚ö†Ô∏è Error loading student data, using fallback:', error.message);
            showFallbackUI();
        }
    }

    // Populate form with student data
    function populateStudentForm() {
        if (!studentData) {
            console.log('‚ö†Ô∏è No student data available');
            return;
        }

        const user = studentData.user || {};
        console.log('üìù Populating form with user data:', user);
        
        // Build full name
        const firstName = user.firstName || '';
        const lastName = user.lastName || '';
        const fullName = `${firstName} ${lastName}`.trim() || 'Aluno Sem Nome';
        
        // Update header
        setElementText('editPageStudentName', fullName);
        setElementText('editPageStudentId', `ID: ${studentData.id || studentId}`);
        setElementText('editPageStudentCategory', `Categoria: ${studentData.category || 'MASTER_2'}`);

        // Populate form fields
        setFieldValue('studentName', fullName);
        setFieldValue('studentEmail', user.email || '');
        setFieldValue('studentPhone', user.phone || studentData.phone || '');
        setFieldValue('studentWhatsapp', studentData.whatsapp || '');
        setFieldValue('studentEmergencyContact', studentData.emergencyContact || '');
        setFieldValue('studentAddress', studentData.address || '');
        setFieldValue('studentNotes', studentData.notes || '');
        setFieldValue('studentCPF', studentData.cpf || '');
        setFieldValue('studentStatus', studentData.isActive ? 'ativo' : 'inativo');

        // Handle birth date
        if (studentData.birthDate) {
            try {
                const date = new Date(studentData.birthDate);
                setFieldValue('studentBirthdate', date.toISOString().split('T')[0]);
            } catch (e) {
                console.warn('‚ö†Ô∏è Invalid birth date format:', studentData.birthDate);
            }
        }

        console.log('‚úÖ Student form populated successfully');
    }

    // Show fallback UI when data loading fails
    function showFallbackUI() {
        setElementText('editPageStudentName', 'Modo Edi√ß√£o - Dados Limitados');
        setElementText('editPageStudentId', `ID: ${studentId || 'N/A'}`);
        setElementText('editPageStudentCategory', 'Categoria: A definir');
        
        // Enable all form fields for manual input
        const formFields = document.querySelectorAll('input, select, textarea');
        formFields.forEach(field => {
            field.disabled = false;
        });

        console.log('‚úÖ Fallback UI displayed - form enabled for manual input');
    }

    // Load financial data
    async function loadFinancialData() {
        console.log('üí≥ Loading financial data...');
        
        try {
            const response = await fetch(`/api/students/${studentId}/subscription`);
            
            if (response.status === 404) {
                showNoSubscription();
            } else if (response.ok) {
                const subscription = await response.json();
                showSubscriptionData(subscription);
            } else {
                showFinancialError();
            }
            
        } catch (error) {
            console.warn('‚ö†Ô∏è Financial data error:', error.message);
            showFinancialError();
        }
    }

    // Show subscription data
    function showSubscriptionData(subscription) {
        const plan = subscription.plan || {};
        
        setElementText('planName', plan.name || 'Plano Padr√£o');
        setElementText('planPrice', `R$ ${plan.price || '150,00'}`);
        setElementText('nextDueDate', subscription.nextPayment ? 
            new Date(subscription.nextPayment).toLocaleDateString('pt-BR') : 'A definir');
        setElementText('paymentStatus', subscription.status || 'Em dia');

        // Hide no subscription state
        const noSubState = document.getElementById('noSubscriptionState');
        if (noSubState) {
            noSubState.style.display = 'none';
        }

        console.log('‚úÖ Subscription data displayed');
    }

    // Show no subscription state
    function showNoSubscription() {
        const noSubState = document.getElementById('noSubscriptionState');
        if (noSubState) {
            noSubState.style.display = 'block';
        }
        
        const subCard = document.querySelector('.subscription-card');
        if (subCard) {
            subCard.style.display = 'none';
        }

        console.log('üìã No subscription state displayed');
    }

    // Show financial error
    function showFinancialError() {
        setElementText('planName', 'Erro ao carregar');
        setElementText('planPrice', 'R$ --,--');
        setElementText('nextDueDate', 'Indispon√≠vel');
        setElementText('paymentStatus', 'Erro na conex√£o');

        console.log('‚ö†Ô∏è Financial error state displayed');
    }

    // Save student data
    async function saveStudentData() {
        try {
            console.log('üíæ Saving student data...');

            const fullName = getFieldValue('studentName');
            const nameParts = fullName.split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';

            const formData = {
                user: {
                    firstName: firstName,
                    lastName: lastName,
                    email: getFieldValue('studentEmail'),
                    phone: getFieldValue('studentPhone')
                },
                phone: getFieldValue('studentPhone'),
                whatsapp: getFieldValue('studentWhatsapp'),
                emergencyContact: getFieldValue('studentEmergencyContact'),
                address: getFieldValue('studentAddress'),
                notes: getFieldValue('studentNotes'),
                cpf: getFieldValue('studentCPF'),
                isActive: getFieldValue('studentStatus') === 'ativo',
                birthDate: getFieldValue('studentBirthdate') || null
            };

            console.log('üì§ Sending data:', formData);

            const response = await fetch(`/api/students/${studentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                studentData = await response.json();
                alert('‚úÖ Dados salvos com sucesso!');
                console.log('‚úÖ Student data saved successfully');
                
                // Update header with new data
                populateStudentForm();
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

        } catch (error) {
            console.error('‚ùå Save error:', error);
            alert('‚ùå Erro ao salvar dados: ' + error.message);
        }
    }

    // Utility functions
    function setElementText(id, text) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = text;
        } else {
            console.warn(`‚ö†Ô∏è Element not found: ${id}`);
        }
    }

    function setFieldValue(id, value) {
        const field = document.getElementById(id);
        if (field) {
            field.value = value || '';
        } else {
            console.warn(`‚ö†Ô∏è Field not found: ${id}`);
        }
    }

    function getFieldValue(id) {
        const field = document.getElementById(id);
        return field ? field.value : '';
    }

    // Global functions for UI actions
    window.selectPlan = function(planType) {
        console.log('üìã Plan selected:', planType);
        alert(`Plano selecionado: ${planType}`);
    };

    window.createNewSubscription = function() {
        console.log('‚ûï Create new subscription clicked');
        alert('Criar nova assinatura - Em desenvolvimento');
    };

    window.editCurrentSubscription = function() {
        console.log('‚úèÔ∏è Edit subscription clicked');
        alert('Editar assinatura atual - Em desenvolvimento');
    };

    window.changeSubscriptionPlan = function() {
        console.log('üîÑ Change subscription plan clicked');
        alert('Trocar plano - Em desenvolvimento');
    };

    window.cancelSubscription = function() {
        console.log('‚ùå Cancel subscription clicked');
        if (confirm('Deseja realmente cancelar a assinatura?')) {
            alert('Cancelamento de assinatura - Em desenvolvimento');
        }
    };

    // Export main function for global access
    window.initializeStudentEditor = initialize;

    // Auto-initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        // DOM already loaded, initialize with a small delay
        setTimeout(initialize, 50);
    }

    console.log('üìã Student Editor Clean script loaded and ready');

})();
