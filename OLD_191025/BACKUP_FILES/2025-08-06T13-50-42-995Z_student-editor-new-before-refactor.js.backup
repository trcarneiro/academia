(function() {
    'use strict';

    // --- Global State ---
    let currentStudent = null;
    let currentTab = 'profile'; // Start with profile tab to avoid API issues
    let studentId = null;
    let loadedTabs = new Set(); // Track which tabs have been loaded to avoid duplicates

    // --- Initialization ---
    // --- Initialization ---
    function initialize() {
        console.log('üöÄ Initializing NEW Student Editor...');
        setStudentId();
        setupEventListeners();
        loadInitialData();
    }

    function setStudentId() {
        const editorModeData = localStorage.getItem('studentEditorMode');
        if (editorModeData) {
            try {
                const editorData = JSON.parse(editorModeData);
                studentId = editorData.studentId;
                console.log(`‚úÖ Student ID set from localStorage: ${studentId}`);
            } catch (e) {
                console.error('‚ùå Failed to parse studentEditorMode', e);
            }
        }

        if (!studentId) {
            const urlParams = new URLSearchParams(window.location.search);
            studentId = urlParams.get('id');
            console.log(`‚úÖ Student ID set from URL: ${studentId}`);
        }

        if (!studentId) {
            showError('Nenhum ID de estudante encontrado. Retornando √† lista.');
            setTimeout(() => window.navigateToModule('students'), 3000);
        }
    }

    function setupEventListeners() {
        // Main buttons
        document.getElementById('back-to-list-btn')?.addEventListener('click', () => window.navigateToModule('students'));
        document.getElementById('save-student-btn')?.addEventListener('click', saveStudentChanges);

        // Tab navigation
        const tabContainer = document.querySelector('.tab-navigation');
        tabContainer?.addEventListener('click', (e) => {
            const button = e.target.closest('.page-tab');
            if (button && !button.classList.contains('active')) {
                switchTab(button.dataset.tab);
            }
        });
    }

    // --- Data Loading ---
    async function loadInitialData() {
        if (!studentId) {
            console.log('‚ùå No student ID found, cannot load data');
            return;
        }

        console.log('üì° Loading initial data for student ID:', studentId);
        showLoading('Carregando dados do aluno...');
        
        try {
            const response = await fetch(`/api/students/${studentId}`);
            if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }
            const result = await response.json();
            if (result.success && result.data) {
                currentStudent = result.data;
                console.log('‚úÖ Student data loaded:', currentStudent.id);
                renderPage();
            } else {
                throw new Error(result.message || 'Falha ao carregar dados do aluno.');
            }
        } catch (error) {
            console.error('‚ùå Error loading initial data:', error);
            showError(`Erro ao carregar dados: ${error.message}`);
            
            // Even if student data fails, show basic interface with mock data
            currentStudent = {
                id: studentId,
                user: { firstName: 'Aluno', lastName: 'N√£o Carregado' },
                category: 'N/A',
                isActive: true
            };
            console.log('üîß Using fallback student data to show interface');
            renderPage();
        } finally {
            hideLoading();
        }
    }

    // --- Rendering ---
    function renderPage() {
        console.log('üé® Rendering page for student:', currentStudent?.id);
        renderHeader();
        renderTabs();
    }

    function renderHeader() {
        console.log('üìã Rendering header');
        const user = currentStudent.user || {};
        const studentName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'Novo Aluno';
        
        const nameElement = document.getElementById('editPageStudentName');
        const idElement = document.getElementById('editPageStudentId');
        const categoryElement = document.getElementById('editPageStudentCategory');
        
        if (nameElement) nameElement.textContent = studentName;
        if (idElement) idElement.textContent = `ID: ${currentStudent.id}`;
        if (categoryElement) categoryElement.textContent = `Categoria: ${currentStudent.category || 'N/A'}`;
        
        document.title = `Editando: ${studentName}`;
        console.log('‚úÖ Header rendered successfully');
    }

    function renderTabs() {
        console.log('üìë Rendering tabs, current tab:', currentTab);
        
        // Activate the correct tab button
        document.querySelectorAll('.page-tab').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === currentTab);
        });

        // Show the correct content container
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = content.id === `${currentTab}-content` ? 'block' : 'none';
        });

        // Only load content if the tab hasn't been loaded yet
        if (!loadedTabs.has(currentTab)) {
            loadTabContent(currentTab);
        } else {
            console.log(`‚úÖ Tab ${currentTab} already loaded, just showing content`);
        }
    }

    function switchTab(tabId) {
        currentTab = tabId;
        renderTabs();
    }

    // Clear tab cache - useful when student data is updated
    function clearTabCache() {
        loadedTabs.clear();
        console.log('üîÑ Tab cache cleared');
    }

    async function loadTabContent(tabId) {
        const container = document.getElementById(`${tabId}-content`);
        if (!container) {
            console.error(`‚ùå Container not found for tab: ${tabId}`);
            return;
        }

        // Check if tab has already been loaded to avoid duplicates
        if (loadedTabs.has(tabId)) {
            console.log(`‚úÖ Tab ${tabId} already loaded, skipping reload`);
            container.style.display = 'block';
            return;
        }

        console.log(`üîÑ Loading content for tab: ${tabId}`);
        container.innerHTML = '<div class="loading-spinner"></div>'; // Show loading spinner

        try {
            switch (tabId) {
                case 'profile':
                    console.log('üë§ Loading profile tab - using existing HTML content');
                    // Don't replace HTML content, just populate existing form
                    populateProfileForm();
                    // Make sure the content is visible
                    container.style.display = 'block';
                    break;
                case 'financial':
                    console.log('üí≥ Loading financial tab');
                    await loadFinancialData(container);
                    break;
                default:
                    console.log(`üìù Loading default content for tab: ${tabId}`);
                    container.innerHTML = `<div class="empty-state">Conte√∫do para "${tabId}" em desenvolvimento.</div>`;
            }
            
            // Mark tab as loaded
            loadedTabs.add(tabId);
            console.log(`‚úÖ Content loaded successfully for tab: ${tabId}, loaded tabs:`, Array.from(loadedTabs));
        } catch (error) {
            console.error(`‚ùå Error loading ${tabId} content:`, error);
            container.innerHTML = `<div class="error-state">Erro ao carregar ${tabId}: ${error.message}</div>`;
        }
    }

    // --- Financial Tab ---
    async function loadFinancialData(container) {
        if (!currentStudent) return;

        console.log('üí≥ Loading financial data for student:', currentStudent.id);
        
        try {
            const response = await fetch(`/api/students/${currentStudent.id}/subscription`);
            console.log('üì° Financial API Response:', response.status, response.statusText);
            
            if (!response.ok) {
                if (response.status === 404) {
                    console.log('üîç No subscription found (404) - showing no subscription state');
                    container.innerHTML = renderNoSubscriptionState();
                    return;
                } else if (response.status >= 500) {
                    console.log('‚ö†Ô∏è Server error (500+) - showing error state with fallback');
                    container.innerHTML = renderFinancialErrorState();
                    return;
                } else {
                    console.log('‚ùå Other API error - throwing');
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
            }
            
            const result = await response.json();
            if (result.success && result.data) {
                console.log('‚úÖ Financial data loaded successfully');
                container.innerHTML = renderFinancialData(result.data);
            } else {
                console.log('üîç No data in response - showing no subscription state');
                container.innerHTML = renderNoSubscriptionState();
            }
        } catch (error) {
            console.error('‚ùå Error loading financial data:', error);
            console.log('üîß Using robust error state as fallback');
            // Use our robust error state instead of generic error
            container.innerHTML = renderFinancialErrorState();
        }
    }

    function renderFinancialData(subscription) {
        const plan = subscription.plan || {};
        return `
            <div class="form-section">
                <h4>üí≥ Plano Atual</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome do Plano</label>
                        <input type="text" value="${plan.name || 'N/A'}" disabled>
                    </div>
                    <div class="form-group">
                        <label>Pre√ßo</label>
                        <input type="text" value="R$ ${plan.price || '0.00'}" disabled>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Status</label>
                        <input type="text" value="${subscription.status || 'N/A'}" disabled>
                    </div>
                    <div class="form-group">
                        <label>Pr√≥ximo Vencimento</label>
                        <input type="text" value="${subscription.nextPayment ? new Date(subscription.nextPayment).toLocaleDateString('pt-BR') : 'N/A'}" disabled>
                    </div>
                </div>
            </div>
        `;
    }

    function renderNoSubscriptionState() {
        return `
            <div class="form-section">
                <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
                    üí≥ Gest√£o de Assinaturas
                </h4>

                <!-- No Subscription State -->
                <div style="background: rgba(107, 114, 128, 0.1); border: 1px dashed #6B7280; border-radius: 12px; padding: 2rem; text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                    <h5 style="color: #9CA3AF; margin: 0 0 1rem 0;">Nenhuma Assinatura Encontrada</h5>
                    <p style="color: #6B7280; margin: 0 0 1.5rem 0;">Este aluno n√£o possui plano ativo no momento.</p>
                    <button onclick="createNewSubscription()" style="padding: 0.75rem 2rem; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                        ‚ûï Criar Nova Assinatura
                    </button>
                </div>

                <!-- Available Plans -->
                <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 12px; padding: 1.5rem;">
                    <h5 style="color: #8B5CF6; margin: 0 0 1.5rem 0; font-size: 1.1rem;">üíé Planos Dispon√≠veis</h5>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <h6 style="color: #3B82F6; margin: 0; font-weight: bold;">Plano B√°sico</h6>
                                <span style="color: #10B981; font-weight: bold;">R$ 150,00</span>
                            </div>
                            <p style="color: #CBD5E1; font-size: 0.875rem; margin: 0 0 1rem 0;">2x por semana ‚Ä¢ Aulas em grupo</p>
                            <button onclick="selectPlan('basic')" style="width: 100%; padding: 0.5rem; background: transparent; color: #3B82F6; border: 1px solid #3B82F6; border-radius: 6px; cursor: pointer;">
                                Selecionar
                            </button>
                        </div>
                        
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8B5CF6; border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <h6 style="color: #8B5CF6; margin: 0; font-weight: bold;">Plano Premium</h6>
                                <span style="color: #10B981; font-weight: bold;">R$ 250,00</span>
                            </div>
                            <p style="color: #CBD5E1; font-size: 0.875rem; margin: 0 0 1rem 0;">Ilimitado ‚Ä¢ Aulas particulares</p>
                            <button onclick="selectPlan('premium')" style="width: 100%; padding: 0.5rem; background: transparent; color: #8B5CF6; border: 1px solid #8B5CF6; border-radius: 6px; cursor: pointer;">
                                Selecionar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderFinancialErrorState() {
        return `
            <div class="form-section">
                <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
                    üí≥ Gest√£o de Assinaturas
                </h4>

                <!-- Error State -->
                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 2rem; text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                    <h5 style="color: #F87171; margin: 0 0 1rem 0;">Erro ao Carregar Dados Financeiros</h5>
                    <p style="color: #FCA5A5; margin: 0 0 1.5rem 0;">N√£o foi poss√≠vel carregar os dados de assinatura. O servidor pode estar temporariamente indispon√≠vel.</p>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button onclick="window.location.reload()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #3B82F6, #8B5CF6); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                            üîÑ Tentar Novamente
                        </button>
                        <button onclick="createNewSubscription()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                            ‚ûï Criar Assinatura
                        </button>
                    </div>
                </div>

                <!-- Available Plans as fallback -->
                <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 12px; padding: 1.5rem;">
                    <h5 style="color: #8B5CF6; margin: 0 0 1.5rem 0; font-size: 1.1rem;">üíé Planos Dispon√≠veis</h5>
                    <p style="color: #94A3B8; margin: 0 0 1rem 0; font-size: 0.875rem;">Enquanto isso, voc√™ pode visualizar os planos dispon√≠veis:</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <h6 style="color: #3B82F6; margin: 0; font-weight: bold;">Plano B√°sico</h6>
                                <span style="color: #10B981; font-weight: bold;">R$ 150,00</span>
                            </div>
                            <p style="color: #CBD5E1; font-size: 0.875rem; margin: 0 0 1rem 0;">2x por semana ‚Ä¢ Aulas em grupo</p>
                            <button onclick="selectPlan('basic')" style="width: 100%; padding: 0.5rem; background: transparent; color: #3B82F6; border: 1px solid #3B82F6; border-radius: 6px; cursor: pointer;">
                                Selecionar
                            </button>
                        </div>
                        
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8B5CF6; border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <h6 style="color: #8B5CF6; margin: 0; font-weight: bold;">Plano Premium</h6>
                                <span style="color: #10B981; font-weight: bold;">R$ 250,00</span>
                            </div>
                            <p style="color: #CBD5E1; font-size: 0.875rem; margin: 0 0 1rem 0;">Ilimitado ‚Ä¢ Aulas particulares</p>
                            <button onclick="selectPlan('premium')" style="width: 100%; padding: 0.5rem; background: transparent; color: #8B5CF6; border: 1px solid #8B5CF6; border-radius: 6px; cursor: pointer;">
                                Selecionar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // --- Profile Tab ---
    function getProfileFormHTML() {
        return `
            <div class="form-section">
                <h4>üë§ Informa√ß√µes Pessoais</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="student-name">Nome Completo</label>
                        <input type="text" id="student-name" required>
                    </div>
                    <div class="form-group">
                        <label for="student-email">Email</label>
                        <input type="email" id="student-email" required>
                    </div>
                </div>
                 <div class="form-grid">
                    <div class="form-group">
                        <label for="student-phone">Telefone</label>
                        <input type="tel" id="student-phone">
                    </div>
                    <div class="form-group">
                        <label for="student-birth-date">Data de Nascimento</label>
                        <input type="date" id="student-birth-date">
                    </div>
                </div>
            </div>
            <div class="form-section">
                <h4>üìù Notas e Status</h4>
                <div class="form-grid">
                     <div class="form-group">
                        <label for="student-notes">Notas Internas</label>
                        <textarea id="student-notes" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="student-status">Status</label>
                        <select id="student-status">
                            <option value="ACTIVE">Ativo</option>
                            <option value="INACTIVE">Inativo</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
    }

    function populateProfileForm() {
        if (!currentStudent) {
            console.log('‚ùå No current student data to populate form');
            return;
        }
        
        const user = currentStudent.user || {};
        console.log('üìù Populating profile form with data:', {
            name: `${user.firstName || ''} ${user.lastName || ''}`.trim(),
            email: user.email,
            phone: user.phone || currentStudent.phone,
            isActive: currentStudent.isActive
        });

        // Try to find fields by multiple selectors (more robust)
        const nameField = document.getElementById('student-name') || 
                         document.querySelector('input[placeholder*="Nome"]') ||
                         document.querySelector('input[placeholder*="nome"]');
        
        const emailField = document.getElementById('student-email') || 
                          document.querySelector('input[type="email"]');
        
        const phoneField = document.getElementById('student-phone') || 
                          document.querySelector('input[placeholder*="Telefone"]') ||
                          document.querySelector('input[placeholder*="telefone"]') ||
                          document.querySelector('input[type="tel"]');
        
        const birthDateField = document.getElementById('student-birth-date') || 
                              document.querySelector('input[type="date"]');
        
        const notesField = document.getElementById('student-notes') || 
                          document.querySelector('textarea');
        
        const statusField = document.getElementById('student-status') || 
                           document.querySelector('select');

        // Populate fields if they exist
        if (nameField) {
            nameField.value = `${user.firstName || ''} ${user.lastName || ''}`.trim();
            console.log('‚úÖ Name field populated');
        } else {
            console.log('‚ö†Ô∏è Name field not found');
        }
        
        if (emailField) {
            emailField.value = user.email || '';
            console.log('‚úÖ Email field populated');
        } else {
            console.log('‚ö†Ô∏è Email field not found');
        }
        
        if (phoneField) {
            phoneField.value = user.phone || currentStudent.phone || '';
            console.log('‚úÖ Phone field populated');
        } else {
            console.log('‚ö†Ô∏è Phone field not found');
        }
        
        if (birthDateField && currentStudent.birthDate) {
            birthDateField.value = new Date(currentStudent.birthDate).toISOString().split('T')[0];
            console.log('‚úÖ Birth date field populated');
        }
        
        if (notesField) {
            notesField.value = currentStudent.notes || '';
            console.log('‚úÖ Notes field populated');
        }
        
        if (statusField) {
            // Try different value formats
            const isActive = currentStudent.isActive;
            statusField.value = isActive ? 'ACTIVE' : 'INACTIVE';
            // If that doesn't work, try other formats
            if (statusField.selectedIndex === -1) {
                statusField.value = isActive ? 'Ativo' : 'Inativo';
            }
            console.log('‚úÖ Status field populated:', statusField.value);
        }

        console.log('‚úÖ Profile form population completed');
    }

    // --- Actions ---
    async function saveStudentChanges() {
        if (!currentStudent) {
            console.log('‚ùå No current student to save');
            return;
        }

        console.log('üíæ Saving student changes...');

        // Use robust field selectors
        const nameField = document.getElementById('student-name') || 
                         document.querySelector('input[placeholder*="Nome"]') ||
                         document.querySelector('input[placeholder*="nome"]');
        
        const emailField = document.getElementById('student-email') || 
                          document.querySelector('input[type="email"]');
        
        const phoneField = document.getElementById('student-phone') || 
                          document.querySelector('input[placeholder*="Telefone"]') ||
                          document.querySelector('input[placeholder*="telefone"]') ||
                          document.querySelector('input[type="tel"]');
        
        const birthDateField = document.getElementById('student-birth-date') || 
                              document.querySelector('input[type="date"]');
        
        const notesField = document.getElementById('student-notes') || 
                          document.querySelector('textarea');
        
        const statusField = document.getElementById('student-status') || 
                           document.querySelector('select');

        const formData = {
            name: nameField?.value || '',
            email: emailField?.value || '',
            phone: phoneField?.value || '',
            birthDate: birthDateField?.value || '',
            notes: notesField?.value || '',
            isActive: statusField?.value === 'ACTIVE' || statusField?.value === 'Ativo',
        };

        console.log('üìã Form data collected:', formData);

        showLoading('Salvando...');
        try {
            const response = await fetch(`/api/students/${currentStudent.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const errorResult = await response.json();
                throw new Error(errorResult.message || 'Falha ao salvar.');
            }

            console.log('‚úÖ Student saved successfully');
            showSuccess('Aluno salvo com sucesso!');
            
            // Clear tab cache to ensure fresh data on next load
            clearTabCache();
            
            setTimeout(() => window.navigateToModule('students'), 2000);

        } catch (error) {
            console.error('‚ùå Error saving student:', error);
            showError(error.message);
        } finally {
            hideLoading();
        }
    }

    // --- UI Helpers ---
    function showLoading(message = 'Carregando...') {
        document.getElementById('loadingStateMessage').textContent = message;
        document.getElementById('loadingState').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingState').style.display = 'none';
    }

    function showError(message) {
        // A more robust implementation would use a dedicated notification system
        alert(`‚ùå ERRO: ${message}`);
    }

    function showSuccess(message) {
        alert(`‚úÖ SUCESSO: ${message}`);
    }

    // --- Courses Tab Functions ---
    async function loadCoursesData(container) {
        if (!currentStudent) return;
        try {
            showLoading('Carregando cursos...');
            const response = await fetch(`/api/students/${currentStudent.id}/courses`);
            if (!response.ok) {
                // Handle different error types
                if (response.status === 404) {
                    container.innerHTML = getEmptyCourseState();
                    return;
                } else {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
            }
            const result = await response.json();
            if (result.success && result.data && result.data.length > 0) {
                container.innerHTML = renderCoursesData(result.data);
            } else {
                container.innerHTML = getEmptyCourseState();
            }
        } catch (error) {
            console.error('‚ùå Error loading courses:', error);
            container.innerHTML = getErrorCourseState();
        } finally {
            hideLoading();
        }
    }

    function renderCoursesData(courses) {
        const coursesGrid = courses.map(course => `
            <div class="course-card" style="background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                        <h5 style="color: #8B5CF6; margin: 0 0 0.5rem 0; font-size: 1.1rem; font-weight: 600;">${course.name || 'Curso sem nome'}</h5>
                        <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">Instrutor: ${course.instructor || 'N/A'}</p>
                    </div>
                    <span class="status-badge ${getStatusClass(course.status)}">${getStatusText(course.status)}</span>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: #CBD5E1; font-size: 0.875rem;">Progresso</span>
                        <span style="color: #10B981; font-weight: 600; font-size: 0.875rem;">${course.progress || 0}%</span>
                    </div>
                    <div class="progress-bar" style="background: rgba(255, 255, 255, 0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div class="progress-fill" style="background: linear-gradient(90deg, #10B981, #059669); height: 100%; width: ${course.progress || 0}%; border-radius: 4px; transition: width 0.6s ease;"></div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; font-size: 0.875rem;">
                    <div>
                        <span style="color: #94A3B8;">Carga Hor√°ria:</span>
                        <span style="color: #F8FAFC; font-weight: 500;">${course.duration || 'N/A'}</span>
                    </div>
                    <div>
                        <span style="color: #94A3B8;">M√≥dulos:</span>
                        <span style="color: #F8FAFC; font-weight: 500;">${course.completedModules || 0}/${course.totalModules || 0}</span>
                    </div>
                </div>

                <div style="display: flex; gap: 0.75rem;">
                    <button onclick="viewCourseDetails('${course.id}')" style="flex: 1; padding: 0.5rem 1rem; background: linear-gradient(135deg, #3B82F6, #8B5CF6); color: white; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer;">
                        Ver Detalhes
                    </button>
                    <button onclick="viewCertificate('${course.id}')" style="padding: 0.5rem 1rem; background: transparent; color: #10B981; border: 1px solid #10B981; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">
                        üèÜ Certificado
                    </button>
                </div>
            </div>
        `).join('');

        return `
            <div class="form-section">
                <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
                    üìö Cursos do Plano
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    ${coursesGrid}
                </div>
            </div>
        `;
    }

    function getEmptyCourseState() {
        return `
            <div class="empty-state" style="background: rgba(107, 114, 128, 0.1); border: 1px solid rgba(107, 114, 128, 0.3); color: #9CA3AF; padding: 2rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                <h5 style="margin: 0 0 1rem 0;">Nenhum Curso Encontrado</h5>
                <p style="margin: 0;">Este aluno n√£o est√° matriculado em nenhum curso no momento.</p>
            </div>
        `;
    }

    function getErrorCourseState() {
        return `
            <div class="error-state" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #F87171; padding: 1rem; border-radius: 8px; text-align: center;">
                <h5>‚ö†Ô∏è Erro ao carregar cursos</h5>
                <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    üîÑ Tentar Novamente
                </button>
            </div>
        `;
    }

    function getStatusClass(status) {
        switch (status) {
            case 'active': 
            case 'ACTIVE':
            case 'completed':
                return 'status-active';
            case 'pending':
            case 'in_progress':
                return 'status-pending';
            case 'inactive':
            case 'INACTIVE':
            case 'cancelled':
                return 'status-inactive';
            default:
                return 'status-pending';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'active':
            case 'ACTIVE':
                return 'ATIVO';
            case 'completed':
                return 'CONCLU√çDO';
            case 'pending':
                return 'PENDENTE';
            case 'in_progress':
                return 'EM ANDAMENTO';
            case 'inactive':
            case 'INACTIVE':
                return 'INATIVO';
            case 'cancelled':
                return 'CANCELADO';
            default:
                return 'PENDENTE';
        }
    }

    // --- Classes Tab Functions ---
    async function loadClassesData(container) {
        if (!currentStudent) return;
        try {
            showLoading('Carregando turmas...');
            const response = await fetch(`/api/students/${currentStudent.id}/classes`);
            if (!response.ok) {
                if (response.status === 404) {
                    // No classes found - show empty state with mock data
                    container.innerHTML = renderClassesData([]);
                    return;
                } else {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
            }
            const result = await response.json();
            container.innerHTML = renderClassesData(result.data || []);
        } catch (error) {
            console.error('‚ùå Error loading classes:', error);
            container.innerHTML = getErrorClassState();
        } finally {
            hideLoading();
        }
    }

    function renderClassesData(classes) {
        const currentClasses = classes.filter(cls => cls.enrolled);
        const availableClasses = classes.filter(cls => !cls.enrolled);

        return `
            <div class="form-section">
                <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
                    üè´ Gest√£o de Turmas
                </h4>

                <!-- Current Classes -->
                <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h5 style="color: #8B5CF6; margin: 0 0 1.5rem 0; font-size: 1.1rem;">üìã Turmas Matriculadas</h5>
                    
                    ${currentClasses.length > 0 ? currentClasses.map(cls => `
                        <div style="background: rgba(30, 41, 59, 0.5); border: 1px solid #475569; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <div style="flex: 1;">
                                    <h6 style="color: #F8FAFC; margin: 0 0 0.25rem 0; font-weight: 600;">${cls.name} - ${cls.course}</h6>
                                    <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">Instrutor: ${cls.instructor}</p>
                                </div>
                                <span class="status-badge status-active">ATIVO</span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem; font-size: 0.875rem;">
                                <div>
                                    <span style="color: #94A3B8;">Hor√°rio:</span>
                                    <div style="color: #F8FAFC; font-weight: 500;">${cls.schedule}</div>
                                </div>
                                <div>
                                    <span style="color: #94A3B8;">Frequ√™ncia:</span>
                                    <div style="color: #10B981; font-weight: 500;">${cls.attendance || 0}%</div>
                                </div>
                                <div>
                                    <span style="color: #94A3B8;">Pr√≥xima Aula:</span>
                                    <div style="color: #F59E0B; font-weight: 500;">${cls.nextClass || 'N/A'}</div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.75rem;">
                                <button onclick="changeClass('${cls.id}')" style="padding: 0.5rem 1rem; background: transparent; color: #3B82F6; border: 1px solid #3B82F6; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">
                                    üîÑ Trocar Turma
                                </button>
                                <button onclick="removeClass('${cls.id}')" style="padding: 0.5rem 1rem; background: transparent; color: #EF4444; border: 1px solid #EF4444; border-radius: 6px; font-size: 0.875rem; cursor: pointer;">
                                    ‚ùå Remover
                                </button>
                            </div>
                        </div>
                    `).join('') : '<p style="color: #94A3B8; text-align: center;">Nenhuma turma ativa</p>'}
                </div>

                <!-- Available Classes -->
                <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 12px; padding: 1.5rem;">
                    <h5 style="color: #8B5CF6; margin: 0 0 1.5rem 0; font-size: 1.1rem;">üÜï Turmas Dispon√≠veis</h5>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                        ${availableClasses.length > 0 ? availableClasses.map(cls => `
                            <div style="background: rgba(30, 41, 59, 0.3); border: 1px dashed #475569; border-radius: 8px; padding: 1rem;">
                                <div style="margin-bottom: 1rem;">
                                    <h6 style="color: #F8FAFC; margin: 0 0 0.25rem 0; font-weight: 600;">${cls.name} - ${cls.course}</h6>
                                    <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">Instrutor: ${cls.instructor}</p>
                                </div>
                                
                                <div style="margin-bottom: 1rem; font-size: 0.875rem;">
                                    <div style="margin-bottom: 0.5rem;">
                                        <span style="color: #94A3B8;">Hor√°rio:</span>
                                        <span style="color: #F8FAFC; font-weight: 500; margin-left: 0.5rem;">${cls.schedule}</span>
                                    </div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <span style="color: #94A3B8;">Vagas:</span>
                                        <span style="color: #10B981; font-weight: 500; margin-left: 0.5rem;">${cls.availableSpots || 0} dispon√≠veis</span>
                                    </div>
                                    <div>
                                        <span style="color: #94A3B8;">In√≠cio:</span>
                                        <span style="color: #F59E0B; font-weight: 500; margin-left: 0.5rem;">${cls.startDate || 'N/A'}</span>
                                    </div>
                                </div>

                                <button onclick="enrollInClass('${cls.id}')" style="width: 100%; padding: 0.75rem 1rem; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer;">
                                    ‚ûï Inscrever-se
                                </button>
                            </div>
                        `).join('') : '<p style="color: #94A3B8; text-align: center;">Nenhuma turma dispon√≠vel</p>'}
                    </div>
                </div>
            </div>
        `;
    }

    function getErrorClassState() {
        return `
            <div class="error-state" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #F87171; padding: 1rem; border-radius: 8px; text-align: center;">
                <h5>‚ö†Ô∏è Erro ao carregar turmas</h5>
                <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    üîÑ Tentar Novamente
                </button>
            </div>
        `;
    }

    // --- Attendance Tab Functions ---
    async function loadAttendanceData(container) {
        if (!currentStudent) return;
        try {
            showLoading('Carregando frequ√™ncia...');
            const response = await fetch(`/api/students/${currentStudent.id}/attendance`);
            if (!response.ok) {
                if (response.status === 404) {
                    // No attendance data - show empty state
                    container.innerHTML = renderAttendanceData({});
                    return;
                } else {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
            }
            const result = await response.json();
            container.innerHTML = renderAttendanceData(result.data || {});
        } catch (error) {
            console.error('‚ùå Error loading attendance:', error);
            container.innerHTML = getErrorAttendanceState();
        } finally {
            hideLoading();
        }
    }

    function renderAttendanceData(attendance) {
        return `
            <div class="form-section">
                <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
                    üìä Controle de Frequ√™ncia
                </h4>

                <!-- Attendance Summary -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="color: #10B981; font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${attendance.totalPercentage || 0}%</div>
                        <div style="color: #94A3B8; font-size: 0.875rem;">Frequ√™ncia Geral</div>
                    </div>
                    <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="color: #3B82F6; font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${attendance.classesAttended || 0}</div>
                        <div style="color: #94A3B8; font-size: 0.875rem;">Aulas Assistidas</div>
                    </div>
                    <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="color: #EF4444; font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${attendance.absences || 0}</div>
                        <div style="color: #94A3B8; font-size: 0.875rem;">Faltas</div>
                    </div>
                    <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="color: #F59E0B; font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${attendance.lateArrivals || 0}</div>
                        <div style="color: #94A3B8; font-size: 0.875rem;">Atrasos</div>
                    </div>
                </div>

                <!-- Recent Attendance -->
                <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 12px; padding: 1.5rem;">
                    <h5 style="color: #8B5CF6; margin: 0 0 1.5rem 0; font-size: 1.1rem;">üïí Frequ√™ncia Recente</h5>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ${(attendance.recentClasses || []).map(cls => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(30, 41, 59, 0.5); border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span style="color: ${cls.status === 'present' ? '#10B981' : cls.status === 'late' ? '#F59E0B' : '#EF4444'}; font-size: 1.25rem;">
                                        ${cls.status === 'present' ? '‚úÖ' : cls.status === 'late' ? '‚è∞' : '‚ùå'}
                                    </span>
                                    <div>
                                        <div style="color: #F8FAFC; font-weight: 500;">${cls.course} - ${cls.class}</div>
                                        <div style="color: #94A3B8; font-size: 0.875rem;">${cls.date}</div>
                                    </div>
                                </div>
                                <div style="color: ${cls.status === 'present' ? '#10B981' : cls.status === 'late' ? '#F59E0B' : '#EF4444'}; font-weight: 600;">
                                    ${cls.status === 'present' ? 'PRESENTE' : cls.status === 'late' ? 'ATRASO' : 'FALTA'}
                                </div>
                            </div>
                        `).join('') || '<p style="color: #94A3B8; text-align: center;">Nenhum registro de frequ√™ncia recente</p>'}
                    </div>

                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button onclick="generateAttendanceReport()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #3B82F6, #8B5CF6); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            üìÑ Gerar Relat√≥rio
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function getErrorAttendanceState() {
        return `
            <div class="error-state" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #F87171; padding: 1rem; border-radius: 8px; text-align: center;">
                <h5>‚ö†Ô∏è Erro ao carregar frequ√™ncia</h5>
                <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    üîÑ Tentar Novamente
                </button>
            </div>
        `;
    }

    // --- Global Action Functions ---
    window.viewCourseDetails = function(courseId) {
        alert(`üìö Detalhes do Curso ${courseId}\n\nAqui voc√™ ver√°:\n‚Ä¢ M√≥dulos do curso\n‚Ä¢ Progresso detalhado\n‚Ä¢ Cronograma de aulas\n‚Ä¢ Materiais did√°ticos`);
    };

    window.viewCertificate = function(courseId) {
        alert(`üèÜ Certificado do Curso ${courseId}\n\nFuncionalidades:\n‚Ä¢ Visualizar certificado\n‚Ä¢ Download em PDF\n‚Ä¢ Hist√≥rico de certifica√ß√µes`);
    };

    window.changeClass = function(classId) {
        alert(`üîÑ Trocar Turma ${classId}\n\nEscolha uma nova turma:\n‚Ä¢ Mesmo curso, hor√°rios diferentes\n‚Ä¢ Verificar disponibilidade\n‚Ä¢ Manter hist√≥rico de frequ√™ncia`);
    };

    window.removeClass = function(classId) {
        if (confirm(`‚ö†Ô∏è Remover da Turma ${classId}\n\nTem certeza que deseja remover o aluno desta turma?\n\nO hist√≥rico de frequ√™ncia ser√° mantido.`)) {
            alert('Aluno removido da turma com sucesso!');
        }
    };

    window.enrollInClass = function(classId) {
        alert(`‚ûï Inscrever na Turma ${classId}\n\nProcesso de inscri√ß√£o:\n‚Ä¢ Verificar pr√©-requisitos\n‚Ä¢ Confirmar disponibilidade\n‚Ä¢ Definir data de in√≠cio`);
    };

    window.generateAttendanceReport = function() {
        alert('üìÑ Gerar Relat√≥rio de Frequ√™ncia\n\nOp√ß√µes de relat√≥rio:\n‚Ä¢ Per√≠odo personalizado\n‚Ä¢ Por curso/turma\n‚Ä¢ Formato PDF/Excel\n‚Ä¢ Envio por email');
    };

    // --- Financial Action Functions ---
    window.createNewSubscription = function() {
        alert('‚ûï Criar Nova Assinatura\n\nSelecione um plano na se√ß√£o "Planos Dispon√≠veis" para come√ßar.');
    };

    window.selectPlan = function(planId) {
        alert(`üìã Plano Selecionado: ${planId}\n\nAqui voc√™ poder√°:\n‚Ä¢ Definir data de in√≠cio\n‚Ä¢ Configurar forma de pagamento\n‚Ä¢ Adicionar observa√ß√µes especiais`);
    };

    window.editCurrentSubscription = function() {
        alert('üîß Editar Assinatura\n\nAqui voc√™ poder√°:\n‚Ä¢ Alterar valor personalizado\n‚Ä¢ Modificar data de vencimento\n‚Ä¢ Ajustar condi√ß√µes especiais');
    };

    window.changeSubscriptionPlan = function() {
        alert('üîÑ Trocar Plano\n\nEscolha um novo plano na se√ß√£o "Planos Dispon√≠veis" abaixo.\n\nA mudan√ßa ser√° aplicada no pr√≥ximo ciclo de cobran√ßa.');
    };

    window.cancelSubscription = function() {
        if (confirm('‚ö†Ô∏è Cancelar Assinatura\n\nTem certeza que deseja cancelar a assinatura deste aluno?\n\nEsta a√ß√£o pode ser revertida posteriormente.')) {
            alert('Assinatura cancelada com sucesso!\n\nO aluno manter√° acesso at√© o final do per√≠odo pago.');
        }
    };

    // --- Entry Point ---
    // The module loader in index.html will call this function
    window.initializeStudentEditorNewModule = initialize;

})();
