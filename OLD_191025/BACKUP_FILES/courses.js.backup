(function() {
    'use strict';
    
    console.log('üìö Courses Module - Starting...');
    
    // Module state
    let allCourses = [];
    let filteredCourses = [];
    let isLoading = false;
    
    // Export initialization function for manual loading (SPA compatibility)
    window.initializeCoursesModule = initializeCoursesModule;
    
    // Module initialization - Following CLAUDE.md guidelines
    async function initializeCoursesModule() {
        console.log('üîß Initializing Courses Module...');
        
        try {
            // Check if we're on the courses page - Following students.js pattern
            const coursesContainer = document.getElementById('coursesContainer');
            if (!coursesContainer) {
                console.log('‚ÑπÔ∏è Not on courses page, skipping courses module initialization');
                return;
            }
            
            // Validate that other required DOM elements exist
            const requiredElements = [
                'coursesGrid',
                'loadingState',
                'emptyState',
                'searchInput',
                'categoryFilter',
                'statusFilter',
                'totalCourses',
                'activeCourses',
                'inactiveCourses',
                'categoriesCount'
            ];
            
            let missingElements = [];
            for (const elementId of requiredElements) {
                if (!document.getElementById(elementId)) {
                    missingElements.push(elementId);
                }
            }
            
            if (missingElements.length > 0) {
                console.warn(`‚ö†Ô∏è Missing required elements: ${missingElements.join(', ')}`);
            }
            
            console.log('‚úÖ DOM validation passed - coursesContainer found');
            
            // Wait a bit more to ensure all DOM elements are properly rendered
            await new Promise(resolve => setTimeout(resolve, 100));
            
            await loadInitialData();
            setupEventListeners();
            
            console.log('‚úÖ Courses Module initialized successfully');
        } catch (error) {
            console.error('‚ùå Error initializing courses module:', error);
            showError('Erro ao inicializar m√≥dulo de cursos');
        }
    }
    
    // Load initial data from API - API-FIRST following CLAUDE.md
    async function loadInitialData() {
        if (isLoading) {
            console.log('‚è≥ Already loading, skipping...');
            return;
        }
        
        isLoading = true;
        console.log('üîÑ Loading initial courses data...');
        
        try {
            showLoadingState();
            
            // MANDATORY API-FIRST IMPLEMENTATION as per CLAUDE.md
            console.log('üì° Fetching from /api/courses...');
            const response = await fetch('/api/courses', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            
            console.log('üì° Response received:', {
                status: response.status,
                statusText: response.statusText,
                ok: response.ok
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('üì¶ API Result:', result);
            
            if (result.success && Array.isArray(result.data)) {
                allCourses = result.data;
                filteredCourses = [...allCourses];
                console.log('‚úÖ Courses loaded successfully:', allCourses.length, 'courses');
                
                updateStats();
                
                if (allCourses.length === 0) {
                    showEmptyState();
                } else {
                    renderCourses();
                    showCoursesContainer();
                }
            } else {
                throw new Error(result.error || 'Invalid API response format');
            }
            
        } catch (error) {
            console.error('‚ùå Error loading courses:', error);
            showError(`Erro ao carregar cursos: ${error.message}`);
        } finally {
            isLoading = false;
            hideLoadingState();
        }
    }
    
    // Update statistics display
    function updateStats() {
        const totalCoursesEl = document.getElementById('totalCourses');
        const activeCoursesEl = document.getElementById('activeCourses');
        const inactiveCoursesEl = document.getElementById('inactiveCourses');
        const categoriesCountEl = document.getElementById('categoriesCount');
        
        if (totalCoursesEl) totalCoursesEl.textContent = allCourses.length;
        
        const activeCourses = allCourses.filter(course => course.status === 'ACTIVE');
        if (activeCoursesEl) activeCoursesEl.textContent = activeCourses.length;
        
        const inactiveCourses = allCourses.filter(course => course.status === 'INACTIVE');
        if (inactiveCoursesEl) inactiveCoursesEl.textContent = inactiveCourses.length;
        
        const uniqueCategories = [...new Set(allCourses.map(course => course.category))];
        if (categoriesCountEl) categoriesCountEl.textContent = uniqueCategories.length;
    }
    
    // Setup event listeners - Following students.js pattern
    function setupEventListeners() {
        console.log('üîå Setting up event listeners...');
        
        // Search input
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', handleSearch);
            console.log('‚úÖ Search listener added');
        }
        
        // Filter selects
        const categoryFilter = document.getElementById('categoryFilter');
        const statusFilter = document.getElementById('statusFilter');
        
        if (categoryFilter) {
            categoryFilter.addEventListener('change', handleFilter);
            console.log('‚úÖ Category filter listener added');
        }
        
        if (statusFilter) {
            statusFilter.addEventListener('change', handleFilter);
            console.log('‚úÖ Status filter listener added');
        }
        
        // View control buttons
        const gridViewBtn = document.getElementById('gridViewBtn');
        const tableViewBtn = document.getElementById('tableViewBtn');
        
        if (gridViewBtn) {
            gridViewBtn.addEventListener('click', () => toggleView('grid'));
            console.log('‚úÖ Grid view listener added');
        }
        
        if (tableViewBtn) {
            tableViewBtn.addEventListener('click', () => toggleView('table'));
            console.log('‚úÖ Table view listener added');
        }
        
        // Clear filters button
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', clearFilters);
            console.log('‚úÖ Clear filters listener added');
        }
        
        console.log('‚úÖ Event listeners setup completed');
    }
    
    // Handle search
    function handleSearch(event) {
        const searchTerm = event.target.value.toLowerCase().trim();
        console.log('üîç Searching for:', searchTerm);
        applyFilters();
    }
    
    // Handle filter
    function handleFilter() {
        console.log('ÔøΩ Applying filters...');
        applyFilters();
    }
    
    // Apply all filters
    function applyFilters() {
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const statusFilter = document.getElementById('statusFilter');
        
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const categoryValue = categoryFilter ? categoryFilter.value : 'all';
        const statusValue = statusFilter ? statusFilter.value : 'all';
        
        filteredCourses = allCourses.filter(course => {
            // Search filter
            const matchesSearch = !searchTerm || 
                (course.name || '').toLowerCase().includes(searchTerm) ||
                (course.description || '').toLowerCase().includes(searchTerm) ||
                (course.code || '').toLowerCase().includes(searchTerm);
            
            // Category filter
            const matchesCategory = categoryValue === 'all' || course.level === categoryValue;
            
            // Status filter
            const matchesStatus = statusValue === 'all' || course.status === statusValue;
            
            return matchesSearch && matchesCategory && matchesStatus;
        });
        
        console.log('üìä Filtered results:', filteredCourses.length, 'courses');
        renderCourses();
    }
    
    // Render courses in the grid
    function renderCourses() {
        console.log('üé® Rendering courses:', filteredCourses?.length || 0);
        
        const container = document.getElementById('coursesGrid');
        if (!container) {
            console.error('‚ùå coursesGrid container not found');
            return;
        }
        
        // Clear existing content
        container.innerHTML = '';
        
        if (!filteredCourses || filteredCourses.length === 0) {
            showEmptyState();
            return;
        }
        
        // Generate HTML for courses
        const coursesHtml = filteredCourses.map(course => createCourseCardHTML(course)).join('');
        container.innerHTML = coursesHtml;
        
        console.log('‚úÖ Courses rendered successfully');
    }
    
    // Create course card HTML - Following UI standards from CLAUDE.md
    function createCourseCardHTML(course) {
        const status = course.status === 'ACTIVE' ? 'Ativo' : 'Inativo';
        const statusClass = course.status === 'ACTIVE' ? 'active' : 'inactive';
        const category = course.category || course.level || 'BEGINNER';
        const categoryLabel = getCategoryLabel(category);
        const enrollments = course._count?.enrollments || 0;
        const lessons = course._count?.lessons || course.duration || 0;
        
        return `
            <div class="course-card" data-course-id="${course.id}">
                <div class="course-header">
                    <h3 class="course-title">${escapeHtml(course.name || 'Curso sem nome')}</h3>
                    <span class="course-category">${categoryLabel}</span>
                </div>
                <p class="course-description">${escapeHtml(course.description || 'Sem descri√ß√£o dispon√≠vel')}</p>
                <div class="course-footer">
                    <span class="course-status ${statusClass}">${status}</span>
                    <div class="course-actions">
                        <button class="action-btn" onclick="viewCourse('${course.id}')" title="Visualizar">
                            üëÅÔ∏è
                        </button>
                        <button class="action-btn" onclick="editCourse('${course.id}')" title="Editar">
                            ‚úèÔ∏è
                        </button>
                        <button class="action-btn" onclick="deleteCourse('${course.id}')" title="Excluir">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // State management functions
    function showLoadingState() {
        const loadingState = document.getElementById('loadingState');
        const coursesContainer = document.getElementById('coursesContainer');
        const emptyState = document.getElementById('emptyState');
        
        if (loadingState) loadingState.style.display = 'flex';
        if (coursesContainer) coursesContainer.style.display = 'none';
        if (emptyState) emptyState.style.display = 'none';
        
        console.log('üîÑ Loading state shown');
    }
    
    function hideLoadingState() {
        const loadingState = document.getElementById('loadingState');
        if (loadingState) loadingState.style.display = 'none';
    }
    
    function showEmptyState() {
        const loadingState = document.getElementById('loadingState');
        const coursesContainer = document.getElementById('coursesContainer');
        const emptyState = document.getElementById('emptyState');
        
        if (loadingState) loadingState.style.display = 'none';
        if (coursesContainer) coursesContainer.style.display = 'none';
        if (emptyState) emptyState.style.display = 'flex';
        
        console.log('üì≠ Empty state shown');
    }
    
    function showCoursesContainer() {
        const loadingState = document.getElementById('loadingState');
        const coursesContainer = document.getElementById('coursesContainer');
        const emptyState = document.getElementById('emptyState');
        
        if (loadingState) loadingState.style.display = 'none';
        if (coursesContainer) coursesContainer.style.display = 'block';
        if (emptyState) emptyState.style.display = 'none';
        
        console.log('‚úÖ Courses container shown');
    }
    
    function showError(message) {
        const loadingState = document.getElementById('loadingState');
        const coursesContainer = document.getElementById('coursesContainer');
        const emptyState = document.getElementById('emptyState');
        
        if (loadingState) loadingState.style.display = 'none';
        if (coursesContainer) coursesContainer.style.display = 'none';
        if (emptyState) {
            emptyState.style.display = 'flex';
            emptyState.innerHTML = `
                <div class="empty-icon">‚ùå</div>
                <h3>Erro ao carregar cursos</h3>
                <p>${escapeHtml(message)}</p>
                <button class="btn btn-primary" onclick="window.location.reload()">
                    <span>üîÑ</span>
                    <span>Tentar novamente</span>
                </button>
            `;
        }
        
        console.log('‚ùå Error state shown:', message);
    }
    
    // Utility functions
    function getLevelLabel(level) {
        const labels = {
            'BEGINNER': 'Iniciante',
            'INTERMEDIATE': 'Intermedi√°rio',
            'ADVANCED': 'Avan√ßado',
            'EXPERT': 'Especialista',
            'MASTER': 'Mestre'
        };
        return labels[level] || level;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Global functions for HTML onclick events - Following Full-Screen UI principle
    window.viewCourse = function(courseId) {
        console.log('üëÅÔ∏è Viewing course:', courseId);
        // Following CLAUDE.md: One Action = One Full Screen
        window.location.href = `/views/course-editor.html?id=${courseId}&mode=view`;
    };
    
    window.editCourse = function(courseId) {
        console.log('‚úèÔ∏è Editing course:', courseId);
        // Following CLAUDE.md: One Action = One Full Screen
        window.location.href = `/views/course-editor.html?id=${courseId}`;
    };
    
    window.deleteCourse = async function(courseId) {
        console.log('üóëÔ∏è Delete course requested:', courseId);
        
        if (!confirm('Tem certeza que deseja excluir este curso?\\n\\nEsta a√ß√£o n√£o pode ser desfeita.')) {
            return;
        }
        
        try {
    // View toggle function
    function toggleView(viewType) {
        const gridView = document.getElementById('coursesGrid');
        const tableView = document.getElementById('coursesTable');
        const gridBtn = document.getElementById('gridViewBtn');
        const tableBtn = document.getElementById('tableViewBtn');
        
        if (viewType === 'grid') {
            if (gridView) gridView.style.display = 'grid';
            if (tableView) tableView.style.display = 'none';
            if (gridBtn) gridBtn.classList.add('active');
            if (tableBtn) tableBtn.classList.remove('active');
        } else if (viewType === 'table') {
            if (gridView) gridView.style.display = 'none';
            if (tableView) tableView.style.display = 'block';
            if (gridBtn) gridBtn.classList.remove('active');
            if (tableBtn) tableBtn.classList.add('active');
            renderTableView();
        }
    }
    
    // Clear filters function
    function clearFilters() {
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const statusFilter = document.getElementById('statusFilter');
        
        if (searchInput) searchInput.value = '';
        if (categoryFilter) categoryFilter.value = 'all';
        if (statusFilter) statusFilter.value = 'all';
        
        filteredCourses = [...allCourses];
        renderCourses();
    }
    
    // Render table view
    function renderTableView() {
        const tableBody = document.getElementById('coursesTableBody');
        if (!tableBody) return;
        
        if (filteredCourses.length === 0) {
            tableBody.innerHTML = '<div class="table-row"><div class="table-cell" style="grid-column: 1 / -1; text-align: center; color: var(--text-muted);">Nenhum curso encontrado</div></div>';
            return;
        }
        
        tableBody.innerHTML = filteredCourses.map(course => {
            const status = course.status === 'ACTIVE' ? 'Ativo' : 'Inativo';
            const statusClass = course.status === 'ACTIVE' ? 'active' : 'inactive';
            const category = getCategoryLabel(course.category || course.level || 'BEGINNER');
            
            return `
                <div class="table-row">
                    <div class="table-cell">${escapeHtml(course.name || 'Curso sem nome')}</div>
                    <div class="table-cell">${category}</div>
                    <div class="table-cell">
                        <span class="course-status ${statusClass}">${status}</span>
                    </div>
                    <div class="table-cell">
                        <div class="course-actions">
                            <button class="action-btn" onclick="viewCourse('${course.id}')" title="Visualizar">üëÅÔ∏è</button>
                            <button class="action-btn" onclick="editCourse('${course.id}')" title="Editar">‚úèÔ∏è</button>
                            <button class="action-btn" onclick="deleteCourse('${course.id}')" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Helper functions
    function getCategoryLabel(category) {
        const categoryMap = {
            'BEGINNER': 'Iniciante',
            'INTERMEDIATE': 'Intermedi√°rio',
            'ADVANCED': 'Avan√ßado',
            'EXPERT': 'Especialista',
            'MASTER': 'Mestre'
        };
        return categoryMap[category] || category;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showError(message) {
        console.error('‚ùå Error:', message);
        // You can implement a toast notification here
        alert(message);
    }
    
    // Global functions for course actions
    window.openNewCourseForm = function() {
        console.log('‚ûï Opening new course form...');
        // This could navigate to a course creation page or open a modal
        window.location.href = '/views/course-editor.html';
    };
    
    window.viewCourse = function(courseId) {
        console.log('üëÅÔ∏è Viewing course:', courseId);
        // Navigate to course details page
        window.location.href = `/views/course-details.html?id=${courseId}`;
    };
    
    window.editCourse = function(courseId) {
        console.log('‚úèÔ∏è Editing course:', courseId);
        // Navigate to course editor page
        window.location.href = `/views/course-editor.html?id=${courseId}`;
    };
    
    window.deleteCourse = async function(courseId) {
        console.log('üóëÔ∏è Deleting course:', courseId);
        
        if (!confirm('Tem certeza que deseja excluir este curso? Esta a√ß√£o n√£o pode ser desfeita.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/courses/${courseId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                console.log('‚úÖ Course deleted successfully');
                // Reload data to reflect changes
                await loadInitialData();
            } else {
                throw new Error(`Error deleting course: ${response.status}`);
            }
        } catch (error) {
            console.error('‚ùå Error deleting course:', error);
            alert('Erro ao excluir curso. Tente novamente.');
        }
    };
    
    // Refresh function
    window.refreshCourses = function() {
        console.log('üîÑ Refreshing courses...');
        loadInitialData();
    };
    
    // Initialize when DOM is ready - Following students.js pattern
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeCoursesModule);
    } else {
        initializeCoursesModule();
    }
    
    console.log('üìö Courses Module - Loaded');
    
})();
