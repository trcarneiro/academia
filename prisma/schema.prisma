generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "linux-musl"]
}

datasource db {
  provider  = "mysql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id                       String                    @id @default(uuid())
  name                     String
  slug                     String                    @unique
  description              String?
  logoUrl                  String?
  website                  String?
  phone                    String?
  email                    String?
  address                  String?
  city                     String?
  state                    String?
  country                  String                    @default("Brazil")
  zipCode                  String?
  subscriptionPlan         SubscriptionPlan          @default(BASIC)
  maxStudents              Int                       @default(100)
  maxStaff                 Int                       @default(10)
  isActive                 Boolean                   @default(true)
  primaryColor             String                    @default("#1f2937")
  secondaryColor           String                    @default("#3b82f6")
  customDomain             String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  agentTasks               AgentTask[]               @relation("OrgToAgentTask")
  achievements             Achievement[]
  activities               Activity[]
  activityTrackingSettings ActivityTrackingSettings?
  agendaItems              AgendaItem[]
  agentInsights            AgentInsight[]            @relation("OrgToInsight")
  agentInteractions        AgentInteraction[]        @relation("AgentInteractions")
  agentPermissions         AgentPermission[]         @relation("AgentPermissions")
  aiAgents                 AIAgent[]
  asaasCustomers           AsaasCustomer[]
  attendances              Attendance[]
  badges                   Badge[]
  billingPlans             BillingPlan[]
  broadcasts               Broadcast[]
  challenges               Challenge[]
  classes                  Class[]
  coursePrograms           CourseProgram[]
  courseTemplates          CourseTemplate[]
  courses                  Course[]
  creditRenewals           CreditRenewal[]           @relation("CreditRenewalOrganization")
  creditUsages             CreditUsage[]             @relation("CreditUsageOrganization")
  crmSettings              CrmSettings?
  discounts                Discount[]
  enrollmentLinks          EnrollmentLink[]
  financialResponsibles    FinancialResponsible[]
  financialSettings        FinancialSettings?
  googleAdsCampaigns       GoogleAdsCampaign[]
  googleAdsConfig          GoogleAdsConfig?
  horarioSuggestions       HorarioSugerido[]
  instructors              Instructor[]
  jobs                     Job[]
  landingPages             LandingPage[]
  leads                    Lead[]
  martialArts              MartialArt[]
  mats                     Mat[]
  organizationSettings     OrganizationSettings?
  payments                 Payment[]
  personalClasses          PersonalTrainingClass[]
  studentCredits           StudentCredit[]           @relation("StudentCreditsOrganization")
  subscriptions            StudentSubscription[]
  students                 Student[]
  techniqueLibraries       TechniqueLibrary[]
  turmas                   Turma[]
  units                    Unit[]
  users                    User[]

  @@map("organizations")
}

model OrganizationSettings {
  id                         String       @id @default(uuid())
  organizationId             String       @unique
  enableGamification         Boolean      @default(true)
  enableVideoAnalysis        Boolean      @default(false)
  enableAIRecommendations    Boolean      @default(true)
  enableMultipleArts         Boolean      @default(true)
  aiProvider                 AIProvider   @default(CLAUDE)
  openaiApiKey               String?
  anthropicApiKey            String?
  geminiApiKey               String?
  openRouterApiKey           String?
  timezone                   String       @default("America/Sao_Paulo")
  currency                   String       @default("BRL")
  language                   String       @default("pt-BR")
  allowQRCheckin             Boolean      @default(true)
  allowManualCheckin         Boolean      @default(true)
  allowFacialCheckin         Boolean      @default(false)
  checkinWindowStart         Int          @default(30)
  checkinWindowEnd           Int          @default(15)
  createdAt                  DateTime     @default(now())
  updatedAt                  DateTime     @default(now())
  allowInstructorOverride    Boolean      @default(true)
  autoMarkActivitiesComplete Boolean      @default(false)
  requireActivityNotes       Boolean      @default(false)
  organization               Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_settings")
}

model MartialArt {
  id             String               @id @default(uuid())
  organizationId String
  name           String
  description    String?
  imageUrl       String?
  hasGrading     Boolean              @default(true)
  gradingSystem  GradingSystem        @default(BELT)
  maxLevel       Int                  @default(10)
  isActive       Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now())
  achievements   Achievement[]
  courses        Course[]
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  progressions   StudentProgression[]
  techniques     Technique[]

  @@unique([organizationId, name])
  @@map("martial_arts")
}

model Course {
  id                    String                    @id @default(uuid())
  organizationId        String
  martialArtId          String?
  courseTemplateId      String?
  name                  String
  description           String?
  level                 CourseLevel
  duration              Int
  classesPerWeek        Int                       @default(2)
  totalClasses          Int
  minAge                Int                       @default(16)
  maxAge                Int?
  category              StudentCategory           @default(ADULT)
  orderIndex            Int                       @default(1)
  nextCourseId          String?                   @unique
  prerequisites         String                    @db.LongText
  objectives            String                    @db.LongText
  requirements          String                    @db.LongText
  imageUrl              String?
  isActive              Boolean                   @default(true)
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @default(now())
  isBaseCourse          Boolean                   @default(false)
  sequence              Int                       @default(1)
  assessmentDefinitions AssessmentDefinition[]
  attendanceRecords     AttendanceRecord[]
  primaryBillingPlans   BillingPlan[]             @relation("BillingPlanPrimaryCourse")
  classes               Class[]
  challenges            CourseChallenge[]
  enrollments           CourseEnrollment[]
  graduationLevels      CourseGraduationLevel[]
  courseRequirements    CourseRequirement[]
  techniques            CourseTechnique[]
  template              CourseTemplate?           @relation(fields: [courseTemplateId], references: [id])
  martialArt            MartialArt?               @relation(fields: [martialArtId], references: [id], onDelete: Cascade)
  nextCourse            Course?                   @relation("CourseProgression", fields: [nextCourseId], references: [id])
  previousCourse        Course?                   @relation("CourseProgression")
  organization          Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  enrollmentLinks       EnrollmentLink[]
  evaluationRecords     EvaluationRecord[]
  instructor_courses    InstructorCourse[]
  lessonPlans           LessonPlan[]
  personalSessions      PersonalTrainingSession[]
  planCourses           PlanCourse[]
  preEnrollments        PreEnrollment[]
  progressRecords       Progress[]
  studentCourses        StudentCourse[]
  degreeHistory         StudentDegreeHistory[]
  graduations           StudentGraduation[]
  progressTracking      StudentProgress[]
  teacherEvaluations    TeacherEvaluation[]
  techniqueDetails      TechniqueDetail[]
  turmasCourses         TurmaCourse[]
  turmas                Turma[]
  weeklyChallenges      WeeklyChallenge[]

  @@unique([organizationId, name])
  @@index([courseTemplateId], map: "courses_courseTemplateId_fkey")
  @@index([martialArtId], map: "courses_martialArtId_fkey")
  @@map("courses")
}

model CourseProgram {
  id             String       @id @default(uuid())
  organizationId String
  name           String
  description    String?
  level          CourseLevel
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  classes        Class[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "course_programs_organizationId_fkey")
  @@map("course_programs")
}

model CourseTemplate {
  id               String         @id @default(uuid())
  organizationId   String
  name             String
  description      String?
  category         CourseCategory
  duration         Int
  classesPerWeek   Int            @default(2)
  totalClasses     Int
  minAge           Int            @default(16)
  maxAge           Int?
  objectives       String         @db.LongText
  requirements     String         @db.LongText
  structure        String         @db.LongText
  ragSettings      String?        @db.LongText
  isSystemTemplate Boolean        @default(false)
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @default(now())
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  courses          Course[]

  @@unique([organizationId, name])
  @@map("course_templates")
}

model TechniqueLibrary {
  id                String            @id @default(uuid())
  organizationId    String
  name              String
  description       String?
  category          TechniqueCategory
  content           String            @db.LongText
  ragEmbeddings     String?           @db.LongText
  prerequisites     String            @db.LongText
  relatedTechniques String            @db.LongText
  difficulty        Int               @default(1)
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @default(now())
  organization      Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("technique_libraries")
}

model LessonPlan {
  id                String                    @id @default(uuid())
  courseId          String
  title             String
  description       String?
  lessonNumber      Int
  weekNumber        Int
  unit              String?
  level             Int                       @default(1)
  warmup            String                    @db.LongText
  techniques        String                    @db.LongText
  simulations       String                    @db.LongText
  cooldown          String                    @db.LongText
  mentalModule      String?                   @db.LongText
  tacticalModule    String?
  adaptations       String?                   @db.LongText
  duration          Int                       @default(60)
  difficulty        Int                       @default(1)
  objectives        String                    @db.LongText
  equipment         String                    @db.LongText
  activities        String                    @db.LongText
  videoUrl          String?
  thumbnailUrl      String?
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @default(now())
  archivedAt        DateTime?
  isActive          Boolean                   @default(true)
  previousVersionId String?
  version           Int                       @default(1)
  classes           Class[]
  activityItems     LessonPlanActivity[]
  techniqueLinks    LessonPlanTechniques[]
  course            Course                    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  previousVersion   LessonPlan?               @relation("LessonPlanVersions", fields: [previousVersionId], references: [id])
  nextVersions      LessonPlan[]              @relation("LessonPlanVersions")
  personalSessions  PersonalTrainingSession[]
  techniqueRecords  TechniqueRecord[]
  turmaLessons      TurmaLesson[]

  @@unique([courseId, lessonNumber, isActive])
  @@index([previousVersionId], map: "lesson_plans_previousVersionId_fkey")
  @@map("lesson_plans")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Technique {
  id                       String                      @id @default(uuid())
  martialArtId             String?
  name                     String
  description              String?
  difficulty               Int?
  prerequisites            String                      @db.LongText
  videoUrl                 String?
  imageUrl                 String?
  baseXP                   Int?
  masteryXP                Int?
  badgeIcon                String?
  createdAt                DateTime                    @default(now())
  updatedAt                DateTime                    @updatedAt
  slug                     String?                     @unique
  shortDescription         String?
  subcategory              String?
  modality                 String?
  complexity               String?
  durationMin              Int?
  durationMax              Int?
  groupSizeMin             Int?
  groupSizeMax             Int?
  ageRangeMin              Int?
  ageRangeMax              Int?
  objectives               String                      @db.LongText
  resources                String                      @db.LongText
  assessmentCriteria       String                      @db.LongText
  risksMitigation          String                      @db.LongText
  tags                     String                      @db.LongText
  references               String                      @db.LongText
  bnccCompetenciesText     String?                     @default("")
  category                 String?
  instructions             String                      @db.LongText
  stepByStep               String                      @db.LongText
  bnccCompetencies         String                      @db.LongText
  referencedByActivities   Activity[]                  @relation("ActivityTechniqueRef")
  courseTechniques         CourseTechnique[]
  educationalLinks         EducationalPlanTechniques[]
  lessonLinks              LessonPlanTechniques[]
  studentTechniqueProgress StudentTechniqueProgress[]
  requiredByEdges          TechniquePrerequisite[]     @relation("TechniquePrerequisitesPrerequisite")
  prerequisitesEdges       TechniquePrerequisite[]     @relation("TechniquePrerequisitesTechnique")
  techniqueProgress        TechniqueProgress[]
  techniqueRecords         TechniqueRecord[]
  martialArt               MartialArt?                 @relation(fields: [martialArtId], references: [id], onDelete: Cascade)

  @@index([martialArtId], map: "techniques_martialArtId_fkey")
  @@map("techniques")
}

model CourseTechnique {
  id           String    @id @default(uuid())
  courseId     String
  techniqueId  String
  orderIndex   Int
  weekNumber   Int?
  lessonNumber Int?
  isRequired   Boolean   @default(true)
  course       Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  technique    Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([courseId, techniqueId])
  @@unique([courseId, orderIndex])
  @@index([techniqueId], map: "course_techniques_techniqueId_fkey")
  @@map("course_techniques")
}

model User {
  id                   String                   @id @default(uuid())
  organizationId       String
  email                String?
  password             String
  role                 UserRole                 @default(STUDENT)
  firstName            String
  lastName             String
  avatarUrl            String?                  @db.LongText
  phone                String?
  cpf                  String?
  birthDate            DateTime?
  isActive             Boolean                  @default(true)
  emailVerified        Boolean                  @default(false)
  lastLoginAt          DateTime?
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @default(now())
  canApproveAgentTasks Boolean                  @default(false)
  canExecuteAgentTasks Boolean                  @default(false)
  canCreateAgents      Boolean                  @default(false)
  canDeleteAgents      Boolean                  @default(false)
  maxTaskPriority      String                   @default("MEDIUM")
  canApproveCategories String                   @db.LongText
  approvedTasks        AgentTask[]              @relation("ApprovedTasks")
  assignedTasks        AgentTask[]              @relation("AssignedTasks")
  createdTasks         AgentTask[]              @relation("CreatedTasks")
  executorTasks        AgentTask[]              @relation("ExecutorTasks")
  agendaItems          AgendaItem[]
  agentConversations   AgentConversation[]
  approvedPermissions  AgentPermission[]        @relation("ApprovedPermissions")
  authoredBroadcasts   Broadcast[]
  instructor           Instructor?
  reviewedApplications JobApplication[]         @relation("ApplicationReviewer")
  jobApplications      JobApplication[]
  createdJobs          Job[]                    @relation("JobCreator")
  leadActivities       LeadActivity[]           @relation("LeadActivities")
  leadNotes            LeadNote[]               @relation("LeadNotes")
  assignedLeads        Lead[]                   @relation("LeadAssignedTo")
  student              Student?
  taskExecutions       TaskExecution[]          @relation("TaskExecutions")
  attendanceChecks     TurmaAttendance[]        @relation("AttendanceChecker")
  turmas               Turma[]
  permissionOverrides  UserPermissionOverride[]
  organization         Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "users_organizationId_fkey")
  @@map("users")
}

model Student {
  id                            String                      @id @default(uuid())
  organizationId                String
  userId                        String                      @unique
  emergencyContact              String?
  medicalConditions             String?
  category                      StudentCategory             @default(ADULT)
  gender                        Gender?                     @default(MASCULINO)
  age                           Int?
  physicalCondition             PhysicalCondition?          @default(INICIANTE)
  specialNeeds                  String                      @db.LongText
  totalXP                       Int                         @default(0)
  globalLevel                   Int                         @default(1)
  currentStreak                 Int                         @default(0)
  longestStreak                 Int                         @default(0)
  lastCheckinDate               DateTime?
  preferredDays                 String                      @db.LongText
  preferredTimes                String                      @db.LongText
  notifications                 Boolean                     @default(true)
  enrollmentDate                DateTime                    @default(now())
  isActive                      Boolean                     @default(true)
  createdAt                     DateTime                    @default(now())
  updatedAt                     DateTime                    @default(now())
  financialResponsibleId        String?
  registrationNumber            String?                     @unique
  financialResponsibleStudentId String?
  consolidatedDiscountValue     Decimal?                    @default(0.000000000000000000000000000000)
  consolidatedDiscountType      String?                     @default("FIXED")
  passwordHash                  String?
  emailVerified                 Boolean                     @default(false)
  asaasCustomerId               String?                     @unique
  agentConversations            AgentConversation[]
  asaasCustomer                 AsaasCustomer?
  assessmentAttempts            AssessmentAttempt[]
  attendancePatterns            AttendancePattern?
  attendanceRecords             AttendanceRecord[]
  attendances                   Attendance[]
  badgeUnlocks                  BadgeUnlock[]
  biometricAttempts             BiometricAttempt[]
  biometricData                 BiometricData?
  challengeProgress             ChallengeProgress[]
  enrollments                   CourseEnrollment[]
  creditRenewals                CreditRenewal[]
  creditUsages                  CreditUsage[]
  evaluationRecords             EvaluationRecord[]
  evaluations                   Evaluation[]
  feedbackActivities            FeedbackActivity[]
  feedbackLessons               FeedbackLesson[]
  horarioSupports               HorarioSupporter[]          @relation("StudentHorarioSupporters")
  horarioSuggestions            HorarioSugerido[]
  jobApplications               JobApplication[]
  convertedFromLead             Lead?                       @relation("LeadToStudent")
  activityExecutions            LessonActivityExecution[]
  payments                      Payment[]
  personalClasses               PersonalTrainingClass[]
  personalPreferences           PersonalTrainingPreference?
  physicalTestAttempts          PhysicalTestAttempt[]
  pointsTransactions            PointsTransaction[]
  preEnrollments                PreEnrollment[]
  progressRecords               Progress[]
  achievements                  StudentAchievement[]
  studentCourses                StudentCourse[]
  studentCredits                StudentCredit[]
  degreeHistory                 StudentDegreeHistory[]
  graduations                   StudentGraduation[]
  portalNotifications           StudentNotification[]       @relation("StudentNotifications")
  progressTracking              StudentProgress[]
  progressions                  StudentProgression[]
  sessions                      StudentSession[]            @relation("StudentSessions")
  subscriptions                 StudentSubscription[]
  techniqueProgress             StudentTechniqueProgress[]
  financialResponsible          FinancialResponsible?       @relation(fields: [financialResponsibleId], references: [id])
  financialResponsibleStudent   Student?                    @relation("FinancialDependents", fields: [financialResponsibleStudentId], references: [id])
  financialDependents           Student[]                   @relation("FinancialDependents")
  organization                  Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                          User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  teacherEvaluations            TeacherEvaluation[]
  techniqueRecords              TechniqueRecord[]
  turmaAttendances              TurmaAttendance[]
  turmaInterests                TurmaInterest[]             @relation("StudentTurmaInterests")
  turmaStudents                 TurmaStudent[]

  @@index([financialResponsibleId], map: "students_financialResponsibleId_fkey")
  @@index([financialResponsibleStudentId], map: "students_financialResponsibleStudentId_fkey")
  @@index([organizationId], map: "students_organizationId_fkey")
  @@map("students")
}

model EducationalPlanTechniques {
  educationalPlanId String
  techniqueId       String
  order             Int       @default(0)
  notes             String?
  technique         Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@id([educationalPlanId, techniqueId])
  @@index([techniqueId], map: "educational_plan_techniques_techniqueId_fkey")
  @@map("educational_plan_techniques")
}

model LessonPlanTechniques {
  lessonPlanId        String
  techniqueId         String
  order               Int        @default(0)
  allocationMinutes   Int        @default(0)
  objectiveMapping    String     @db.LongText
  expectedRepetitions Int        @default(1)
  lessonPlan          LessonPlan @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
  technique           Technique  @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@id([lessonPlanId, techniqueId])
  @@index([techniqueId], map: "lesson_plan_techniques_techniqueId_fkey")
  @@map("lesson_plan_techniques")
}

model FinancialResponsible {
  id                 String                @id @default(uuid())
  organizationId     String
  name               String
  cpfCnpj            String
  email              String
  phone              String?
  birthDate          DateTime?
  address            String?
  addressNumber      String?
  complement         String?
  neighborhood       String?
  city               String?
  state              String?
  zipCode            String?
  relationshipType   String?
  asaasId            String?
  isActive           Boolean               @default(true)
  consolidateBilling Boolean               @default(true)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @default(now())
  asaasCustomer      AsaasCustomer?
  organization       Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payments           Payment[]
  subscriptions      StudentSubscription[]
  students           Student[]

  @@unique([organizationId, cpfCnpj])
  @@unique([organizationId, email])
  @@map("financial_responsibles")
}

model TechniqueRecord {
  id             String               @id @default(uuid())
  studentId      String
  techniqueId    String
  lessonPlanId   String?
  proficiency    TechniqueProficiency @default(LEARNING)
  practiceCount  Int                  @default(1)
  masteryScore   Int                  @default(0)
  firstPracticed DateTime             @default(now())
  lastPracticed  DateTime             @default(now())
  masteredAt     DateTime?
  videoUrl       String?
  aiAnalysis     String?              @db.LongText
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now())
  lessonPlan     LessonPlan?          @relation(fields: [lessonPlanId], references: [id])
  student        Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  technique      Technique            @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([studentId, techniqueId])
  @@index([lessonPlanId], map: "technique_records_lessonPlanId_fkey")
  @@index([techniqueId], map: "technique_records_techniqueId_fkey")
  @@map("technique_records")
}

model Unit {
  id               String                    @id @default(uuid())
  organizationId   String
  name             String
  description      String?
  address          String
  addressNumber    String?
  complement       String?
  neighborhood     String?
  city             String
  state            String
  zipCode          String
  phone            String?
  email            String?
  capacity         Int                       @default(100)
  totalMats        Int                       @default(1)
  responsibleName  String?
  isActive         Boolean                   @default(true)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @default(now())
  agendaItems      AgendaItem[]
  classes          Class[]
  jobs             Job[]
  mats             Mat[]
  personalSessions PersonalTrainingSession[]
  trainingAreas    TrainingArea[]
  turmas           Turma[]
  organization     Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("units")
}

model TrainingArea {
  id               String                    @id @default(uuid())
  unitId           String
  name             String
  description      String?
  capacity         Int                       @default(20)
  areaType         String
  dimensions       String?
  equipment        String                    @db.LongText
  flooring         String?
  isActive         Boolean                   @default(true)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @default(now())
  agendaItems      AgendaItem[]
  classes          Class[]                   @relation("ClassTrainingArea")
  personalSessions PersonalTrainingSession[] @relation("PersonalSessionTrainingArea")
  unit             Unit                      @relation(fields: [unitId], references: [id], onDelete: Cascade)
  turmas           Turma[]                   @relation("TurmaTrainingArea")

  @@unique([unitId, name])
  @@map("training_areas")
}

model Mat {
  id             String       @id @default(uuid())
  organizationId String
  unitId         String
  name           String
  description    String?
  capacity       Int          @default(20)
  dimensions     String?
  equipment      String       @db.LongText
  materialType   String?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  classes        Class[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  unit           Unit         @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([unitId, name])
  @@index([organizationId], map: "mats_organizationId_fkey")
  @@map("mats")
}

model Instructor {
  id                     String                    @id @default(uuid())
  organizationId         String
  userId                 String                    @unique
  specializations        String                    @db.LongText
  certifications         String                    @db.LongText
  bio                    String?
  martialArts            String                    @db.LongText
  maxStudentsPerClass    Int                       @default(20)
  experience             String?
  availability           String?                   @db.LongText
  hourlyRate             Decimal?                  @db.Decimal(10, 2)
  preferredUnits         String                    @db.LongText
  hireDate               DateTime                  @default(now())
  isActive               Boolean                   @default(true)
  createdAt              DateTime                  @default(now())
  updatedAt              DateTime                  @default(now())
  classes                Class[]
  evaluations            Evaluation[]
  instructor_courses     InstructorCourse[]
  organization           Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                   User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobApplications        JobApplication[]
  activityValidations    LessonActivityExecution[] @relation("ActivityValidation")
  personalClasses        PersonalTrainingClass[]
  qualitativeAssessments QualitativeAssessment[]
  teacherEvaluations     TeacherEvaluation[]

  @@index([organizationId], map: "instructors_organizationId_fkey")
  @@map("instructors")
}

model InstructorCourse {
  id            String     @id @default(uuid())
  instructor_id String
  course_id     String
  is_lead       Boolean?   @default(false)
  certified_at  DateTime?
  expires_at    DateTime?
  notes         String?
  created_at    DateTime?  @default(now())
  updated_at    DateTime?  @default(now())
  courses       Course     @relation(fields: [course_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_instructor_courses_course")
  instructors   Instructor @relation(fields: [instructor_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_instructor_courses_instructor")

  @@unique([instructor_id, course_id], map: "unique_instructor_course")
  @@index([course_id], map: "idx_instructor_courses_course")
  @@index([instructor_id], map: "idx_instructor_courses_instructor")
  @@map("instructor_courses")
}

model ClassSchedule {
  id          String   @id @default(uuid())
  dayOfWeek   Int
  startTime   DateTime
  endTime     DateTime
  maxStudents Int      @default(20)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  classes     Class[]

  @@map("class_schedules")
}

model Class {
  id                   String                @id @default(uuid())
  organizationId       String
  unitId               String?
  matId                String?
  scheduleId           String?
  instructorId         String
  courseId             String
  courseProgramId      String?
  lessonPlanId         String?
  date                 DateTime
  startTime            DateTime
  endTime              DateTime
  title                String?
  description          String?
  status               ClassStatus           @default(SCHEDULED)
  actualStudents       Int                   @default(0)
  maxStudents          Int                   @default(20)
  agenda               String?               @db.LongText
  notes                String?
  qrCode               String?               @unique
  qrCodeExpiry         DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @default(now())
  location             String?
  trainingAreaId       String?
  assessmentAttempts   AssessmentAttempt[]
  attendanceRecords    AttendanceRecord[]
  attendances          Attendance[]
  activities           ClassActivity[]
  course               Course                @relation(fields: [courseId], references: [id])
  courseProgram        CourseProgram?        @relation(fields: [courseProgramId], references: [id])
  instructor           Instructor            @relation(fields: [instructorId], references: [id])
  lessonPlan           LessonPlan?           @relation(fields: [lessonPlanId], references: [id])
  mat                  Mat?                  @relation(fields: [matId], references: [id])
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  schedule             ClassSchedule?        @relation(fields: [scheduleId], references: [id])
  trainingArea         TrainingArea?         @relation("ClassTrainingArea", fields: [trainingAreaId], references: [id])
  unit                 Unit?                 @relation(fields: [unitId], references: [id])
  feedbackLessons      FeedbackLesson[]
  physicalTestAttempts PhysicalTestAttempt[]
  studentCourses       StudentCourse[]
  teacherEvaluations   TeacherEvaluation[]

  @@index([courseId], map: "classes_courseId_fkey")
  @@index([courseProgramId], map: "classes_courseProgramId_fkey")
  @@index([instructorId], map: "classes_instructorId_fkey")
  @@index([lessonPlanId], map: "classes_lessonPlanId_fkey")
  @@index([matId], map: "classes_matId_fkey")
  @@index([organizationId], map: "classes_organizationId_fkey")
  @@index([scheduleId], map: "classes_scheduleId_fkey")
  @@index([trainingAreaId], map: "classes_trainingAreaId_fkey")
  @@index([unitId], map: "classes_unitId_fkey")
  @@map("classes")
}

model Attendance {
  id             String           @id @default(uuid())
  organizationId String
  studentId      String
  classId        String
  status         AttendanceStatus @default(PRESENT)
  checkInTime    DateTime?
  checkInMethod  CheckInMethod?
  location       String?
  notes          String?
  xpEarned       Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now())
  class          Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student        Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  creditUsages   CreditUsage[]

  @@unique([studentId, classId])
  @@index([classId], map: "attendances_classId_fkey")
  @@index([organizationId], map: "attendances_organizationId_fkey")
  @@map("attendances")
}

model CourseEnrollment {
  id                String              @id @default(uuid())
  studentId         String
  courseId          String
  enrolledAt        DateTime            @default(now())
  completedAt       DateTime?
  expectedEndDate   DateTime
  status            EnrollmentStatus    @default(ACTIVE)
  category          StudentCategory     @default(ADULT)
  gender            String
  currentLesson     Int                 @default(1)
  lessonsCompleted  Int                 @default(0)
  attendanceRate    Float               @default(0)
  currentXP         Int                 @default(0)
  currentLevel      Int                 @default(1)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @default(now())
  challengeProgress ChallengeProgress[]
  course            Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student           Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  evaluations       Evaluation[]
  techniqueProgress TechniqueProgress[]

  @@unique([studentId, courseId])
  @@index([courseId], map: "course_enrollments_courseId_fkey")
  @@map("course_enrollments")
}

model TechniqueProgress {
  id                  String               @id @default(uuid())
  enrollmentId        String
  techniqueId         String
  status              TechniqueProficiency @default(LEARNING)
  accuracy            Float?
  attempts            Int                  @default(0)
  practiceCount       Int                  @default(0)
  masteredAt          DateTime?
  videoUrl            String?
  aiAnalysis          String?              @db.LongText
  instructorValidated Boolean              @default(false)
  validatedBy         String?
  validatedAt         DateTime?
  instructorNotes     String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now())
  enrollment          CourseEnrollment     @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  technique           Technique            @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, techniqueId])
  @@index([techniqueId], map: "technique_progress_techniqueId_fkey")
  @@map("technique_progress")
}

model CourseChallenge {
  id                String              @id @default(uuid())
  courseId          String
  weekNumber        Int
  type              ChallengeType
  baseActivity      String
  baseMetric        Int
  baseTime          Int?
  description       String?
  xpReward          Int                 @default(15)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @default(now())
  challengeProgress ChallengeProgress[]
  course            Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, weekNumber])
  @@map("course_challenges")
}

model ChallengeProgress {
  id                  String           @id @default(uuid())
  studentId           String
  enrollmentId        String
  challengeId         String
  attempted           Boolean          @default(false)
  completed           Boolean          @default(false)
  actualMetric        Int?
  actualTime          Int?
  videoUrl            String?
  imageUrl            String?
  instructorValidated Boolean          @default(false)
  validatedBy         String?
  validatedAt         DateTime?
  instructorNotes     String?
  xpEarned            Int              @default(0)
  completedAt         DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @default(now())
  challenge           CourseChallenge  @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  enrollment          CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  student             Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, challengeId])
  @@index([challengeId], map: "challenge_progress_challengeId_fkey")
  @@index([studentId], map: "challenge_progress_studentId_fkey")
  @@map("challenge_progress")
}

model Evaluation {
  id                 String           @id @default(uuid())
  studentId          String
  instructorId       String
  enrollmentId       String
  type               EvaluationType
  lessonNumber       Int
  techniquesTested   String           @db.LongText
  physicalTest       String?          @db.LongText
  overallScore       Float
  passed             Boolean          @default(false)
  instructorNotes    String?
  videoUrl           String?
  recommendedActions String           @db.LongText
  evaluatedBy        String
  evaluatedAt        DateTime         @default(now())
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @default(now())
  enrollment         CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  instructor         Instructor       @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  student            Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([enrollmentId], map: "evaluations_enrollmentId_fkey")
  @@index([instructorId], map: "evaluations_instructorId_fkey")
  @@index([studentId], map: "evaluations_studentId_fkey")
  @@map("evaluations")
}

model StudentProgression {
  id                   String     @id @default(uuid())
  studentId            String
  martialArtId         String
  currentLevel         Int        @default(1)
  currentGrade         String     @default("White Belt")
  totalXP              Int        @default(0)
  techniquesLearned    Int        @default(0)
  techniquesTotal      Int        @default(0)
  classesAttended      Int        @default(0)
  evaluationsCompleted Int        @default(0)
  nextGrade            String?
  progressToNextGrade  Float      @default(0)
  estimatedTimeToNext  String?
  lastUpdated          DateTime   @default(now())
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @default(now())
  martialArt           MartialArt @relation(fields: [martialArtId], references: [id], onDelete: Cascade)
  student              Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, martialArtId])
  @@index([martialArtId], map: "student_progressions_martialArtId_fkey")
  @@map("student_progressions")
}

model Achievement {
  id                  String               @id @default(uuid())
  organizationId      String
  martialArtId        String?
  name                String
  description         String
  category            AchievementCategory
  criteria            String               @db.LongText
  xpReward            Int                  @default(0)
  badgeImageUrl       String?
  rarity              AchievementRarity    @default(COMMON)
  isHidden            Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now())
  martialArt          MartialArt?          @relation(fields: [martialArtId], references: [id])
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  studentAchievements StudentAchievement[]

  @@index([martialArtId], map: "achievements_martialArtId_fkey")
  @@index([organizationId], map: "achievements_organizationId_fkey")
  @@map("achievements")
}

model StudentAchievement {
  id            String      @id @default(uuid())
  studentId     String
  achievementId String
  unlockedAt    DateTime    @default(now())
  progress      Float       @default(100)
  createdAt     DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  student       Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, achievementId])
  @@index([achievementId], map: "student_achievements_achievementId_fkey")
  @@map("student_achievements")
}

model Challenge {
  id             String              @id @default(uuid())
  organizationId String
  title          String
  description    String
  type           ChallengeType
  difficulty     ChallengeDifficulty @default(EASY)
  startDate      DateTime
  endDate        DateTime
  isRecurring    Boolean             @default(false)
  recurringType  RecurringType?
  xpReward       Int                 @default(0)
  badgeReward    String?
  criteria       String              @db.LongText
  targetValue    Int                 @default(1)
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now())
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "challenges_organizationId_fkey")
  @@map("challenges")
}

model StudentCourse {
  id              String           @id @default(uuid())
  studentId       String
  courseId        String
  classId         String?
  paymentPlanId   String?
  startDate       DateTime         @default(now())
  expectedEndDate DateTime?
  completedDate   DateTime?
  status          EnrollmentStatus @default(ACTIVE)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @default(now())
  class           Class?           @relation(fields: [classId], references: [id], onDelete: Cascade)
  course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  paymentPlan     BillingPlan?     @relation("BillingPlanStudentCourses", fields: [paymentPlanId], references: [id])
  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@index([classId], map: "student_courses_classId_fkey")
  @@index([courseId], map: "student_courses_courseId_fkey")
  @@index([paymentPlanId], map: "student_courses_paymentPlanId_fkey")
  @@map("student_courses")
}

model AttendanceRecord {
  id           String   @id @default(uuid())
  studentId    String
  classId      String
  courseId     String
  lessonNumber Int
  date         DateTime
  present      Boolean  @default(false)
  arrived_late Boolean  @default(false)
  left_early   Boolean  @default(false)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())
  class        Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, lessonNumber])
  @@index([classId], map: "attendance_records_classId_fkey")
  @@index([courseId], map: "attendance_records_courseId_fkey")
  @@map("attendance_records")
}

model Progress {
  id                  String   @id @default(uuid())
  studentId           String
  courseId            String
  lessonNumber        Int
  techniquesLearned   String   @db.LongText
  challengesCompleted String   @db.LongText
  points              Int      @default(0)
  reflections         String?
  progressDate        DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @default(now())
  course              Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student             Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, lessonNumber])
  @@index([courseId], map: "progress_records_courseId_fkey")
  @@map("progress_records")
}

model TechniqueDetail {
  id            String            @id @default(uuid())
  courseId      String
  name          String
  description   String?
  category      TechniqueCategory
  lessonNumber  Int
  instructions  String            @db.LongText
  objectives    String            @db.LongText
  adaptations   String?           @db.LongText
  orderInLesson Int               @default(1)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now())
  course        Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, lessonNumber, orderInLesson])
  @@map("technique_details")
}

model WeeklyChallenge {
  id              String   @id @default(uuid())
  courseId        String
  weekNumber      Int
  name            String
  description     String
  baseRepetitions String   @db.LongText
  baseTime        Int?
  pointsReward    Int      @default(15)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now())
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, weekNumber])
  @@map("weekly_challenges")
}

model EvaluationRecord {
  id                  String           @id @default(uuid())
  studentId           String
  courseId            String
  lessonNumber        Int
  techniquesEvaluated String           @db.LongText
  physicalTest        String?
  physicalTestResult  String?
  simulationScenarios String           @db.LongText
  simulationResults   String           @db.LongText
  precision           Float?
  status              EvaluationStatus
  certificateIssued   Boolean          @default(false)
  certificateUrl      String?
  instructorNotes     String?
  evaluationDate      DateTime         @default(now())
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @default(now())
  course              Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student             Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, lessonNumber])
  @@index([courseId], map: "evaluation_records_courseId_fkey")
  @@map("evaluation_records")
}

model AttendancePattern {
  id                  String          @id @default(uuid())
  studentId           String          @unique
  totalClasses        Int             @default(0)
  attendedClasses     Int             @default(0)
  attendanceRate      Float           @default(0)
  consecutiveAbsences Int             @default(0)
  averageCheckInTime  String?
  preferredDays       String          @db.LongText
  preferredTimeSlots  String          @db.LongText
  recentTrend         AttendanceTrend @default(STABLE)
  trendConfidence     Float           @default(0)
  dropoutRisk         DropoutRisk     @default(LOW)
  riskFactors         String          @db.LongText
  recommendations     String          @db.LongText
  aiInsights          String?         @db.LongText
  lastAnalyzed        DateTime        @default(now())
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @default(now())
  student             Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("attendance_patterns")
}

model AsaasCustomer {
  id                     String                @id @default(uuid())
  organizationId         String
  studentId              String?               @unique
  financialResponsibleId String?               @unique
  asaasId                String                @unique
  name                   String
  cpfCnpj                String?
  email                  String?
  phone                  String?
  mobilePhone            String?
  postalCode             String?
  address                String?
  addressNumber          String?
  complement             String?
  province               String?
  city                   String?
  state                  String?
  externalReference      String?
  isActive               Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student                Student?              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payments               Payment[]
  subscriptions          StudentSubscription[]

  @@index([organizationId], map: "asaas_customers_organizationId_fkey")
  @@map("asaas_customers")
}

model BillingPlan {
  id                      String                @id @default(uuid())
  organizationId          String
  courseId                String?
  name                    String
  description             String?
  category                StudentCategory?
  price                   Decimal               @db.Decimal(10, 2)
  billingType             BillingType           @default(MONTHLY)
  classesPerWeek          Int?                  @default(2)
  maxClasses              Int?
  duration                Int?
  isUnlimitedAccess       Boolean               @default(false)
  hasPersonalTraining     Boolean               @default(false)
  hasNutrition            Boolean               @default(false)
  allowInstallments       Boolean               @default(false)
  maxInstallments         Int                   @default(1)
  installmentInterestRate Decimal?              @db.Decimal(5, 2)
  isRecurring             Boolean               @default(false)
  recurringInterval       Int?
  recurrencePeriod        RecurrencePeriod?
  accessAllModalities     Boolean               @default(false)
  allowFreeze             Boolean               @default(true)
  freezeMaxDays           Int                   @default(30)
  features                String?               @db.LongText
  paymentDiscounts        String?               @db.LongText
  isActive                Boolean               @default(true)
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @default(now())
  creditsValidity         Int?
  pricePerClass           Decimal?              @db.Decimal(10, 2)
  allowPartialCredit      Boolean?              @default(false)
  allowRefund             Boolean?              @default(false)
  allowTransfer           Boolean?              @default(false)
  autoRenewChargeMethod   String?
  autoRenewCredits        Boolean?              @default(false)
  bulkDiscountTiers       String?               @db.LongText
  creditQuantity          Int?
  creditRenewalMethod     CreditRenewalMethod?  @default(INCLUDED)
  creditRenewalTrigger    CreditRenewalTrigger? @default(MONTHLY)
  creditType              CreditType?
  creditValidityDays      Int?                  @default(90)
  maxAutoRenewals         Int?
  minCreditsPerClass      Int?                  @default(1)
  planType                PlanType?
  refundDaysBeforeExp     Int?                  @default(7)
  renewalIntervalDays     Int?
  transferFeePercent      Decimal?              @db.Decimal(5, 2)
  discounts               BillingPlanDiscount[]
  course                  Course?               @relation("BillingPlanPrimaryCourse", fields: [courseId], references: [id])
  organization            Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  enrollmentLinks         EnrollmentLink[]
  planCourses             PlanCourse[]          @relation("PlanCourseToPlan")
  preEnrollments          PreEnrollment[]
  studentCourses          StudentCourse[]       @relation("BillingPlanStudentCourses")
  studentCredits          StudentCredit[]       @relation("BillingPlanCredits")
  subscriptions           StudentSubscription[] @relation("BillingPlanSubscriptions")

  @@index([courseId], map: "billing_plans_courseId_fkey")
  @@index([organizationId], map: "billing_plans_organizationId_fkey")
  @@map("billing_plans")
}

model Discount {
  id             String                @id @default(uuid())
  organizationId String
  name           String
  description    String?
  type           DiscountType          @default(PERCENTAGE)
  value          Decimal               @db.Decimal(10, 2)
  triggerType    DiscountTrigger       @default(MANUAL)
  triggerValue   String?
  startDate      DateTime?
  endDate        DateTime?
  isActive       Boolean               @default(true)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  plans          BillingPlanDiscount[]
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "discounts_organizationId_fkey")
  @@map("discounts")
}

model BillingPlanDiscount {
  id         String      @id @default(uuid())
  planId     String
  discountId String
  createdAt  DateTime    @default(now())
  discount   Discount    @relation(fields: [discountId], references: [id], onDelete: Cascade)
  plan       BillingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, discountId])
  @@index([discountId], map: "billing_plan_discounts_discountId_fkey")
  @@map("billing_plan_discounts")
}

model StudentSubscription {
  id                     String                @id @default(uuid())
  organizationId         String
  studentId              String
  planId                 String
  asaasCustomerId        String?
  financialResponsibleId String?
  status                 SubscriptionStatus    @default(ACTIVE)
  startDate              DateTime              @default(now())
  endDate                DateTime?
  currentPrice           Decimal               @db.Decimal(10, 2)
  billingType            BillingType
  nextBillingDate        DateTime?
  asaasSubscriptionId    String?
  isActive               Boolean               @default(true)
  autoRenew              Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  payments               Payment[]
  StudentCredit          StudentCredit[]
  asaasCustomer          AsaasCustomer?        @relation(fields: [asaasCustomerId], references: [id])
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan                   BillingPlan           @relation("BillingPlanSubscriptions", fields: [planId], references: [id])
  student                Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([asaasCustomerId], map: "student_subscriptions_asaasCustomerId_fkey")
  @@index([financialResponsibleId], map: "student_subscriptions_financialResponsibleId_fkey")
  @@index([organizationId], map: "student_subscriptions_organizationId_fkey")
  @@index([planId], map: "student_subscriptions_planId_fkey")
  @@index([studentId], map: "student_subscriptions_studentId_fkey")
  @@map("student_subscriptions")
}

model Payment {
  id                     String                @id @default(uuid())
  organizationId         String
  studentId              String
  subscriptionId         String?
  asaasCustomerId        String?
  financialResponsibleId String?
  amount                 Decimal               @db.Decimal(10, 2)
  description            String
  dueDate                DateTime
  paidDate               DateTime?
  status                 PaymentStatus         @default(PENDING)
  paymentMethod          PaymentMethod?
  asaasPaymentId         String?               @unique
  asaasChargeId          String?               @unique
  asaasInvoiceUrl        String?
  asaasPixCode           String?
  asaasPixQrCode         String?
  asaasBoletoUrl         String?
  asaasBoletoCode        String?
  asaasChargeUrl         String?
  pixCode                String?
  webhookData            String?               @db.LongText
  notes                  String?
  isManual               Boolean               @default(false)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  asaasCustomer          AsaasCustomer?        @relation(fields: [asaasCustomerId], references: [id])
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student                Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subscription           StudentSubscription?  @relation(fields: [subscriptionId], references: [id])

  @@index([asaasCustomerId], map: "payments_asaasCustomerId_fkey")
  @@index([financialResponsibleId], map: "payments_financialResponsibleId_fkey")
  @@index([organizationId], map: "payments_organizationId_fkey")
  @@index([studentId], map: "payments_studentId_fkey")
  @@index([subscriptionId], map: "payments_subscriptionId_fkey")
  @@map("payments")
}

model FinancialSettings {
  id                 String       @id @default(uuid())
  organizationId     String       @unique
  asaasApiKey        String?
  asaasWebhookUrl    String?
  asaasWebhookToken  String?
  isSandbox          Boolean      @default(true)
  defaultBillingType BillingType  @default(MONTHLY)
  lateFeePercentage  Decimal      @default(2.00) @db.Decimal(5, 2)
  interestRate       Decimal      @default(1.00) @db.Decimal(5, 2)
  sendReminders      Boolean      @default(true)
  reminderDaysBefore Int          @default(3)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @default(now())
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("financial_settings")
}

model StudentCredit {
  id               String               @id @default(uuid())
  organizationId   String
  studentId        String
  planId           String
  subscriptionId   String?
  totalCredits     Int
  creditsUsed      Int                  @default(0)
  creditsAvailable Int
  creditType       CreditType
  purchasedAt      DateTime             @default(now())
  expiresAt        DateTime?
  status           String               @default("ACTIVE")
  notes            String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @default(now())
  autoRenew        Boolean              @default(false)
  nextRenewalDate  DateTime?
  previousCreditId String?
  renewalChargeId  String?
  renewalCount     Int                  @default(0)
  usages           CreditUsage[]        @relation("StudentCreditUsages")
  organization     Organization         @relation("StudentCreditsOrganization", fields: [organizationId], references: [id], onDelete: Cascade)
  plan             BillingPlan          @relation("BillingPlanCredits", fields: [planId], references: [id])
  previousCredit   StudentCredit?       @relation("CreditRenewal", fields: [previousCreditId], references: [id])
  renewedCredits   StudentCredit[]      @relation("CreditRenewal")
  student          Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subscription     StudentSubscription? @relation(fields: [subscriptionId], references: [id])

  @@index([studentId, status])
  @@index([expiresAt])
  @@index([organizationId])
  @@index([planId], map: "student_credits_planId_fkey")
  @@index([previousCreditId], map: "student_credits_previousCreditId_fkey")
  @@index([subscriptionId], map: "student_credits_subscriptionId_fkey")
  @@map("student_credits")
}

model CreditUsage {
  id             String        @id @default(uuid())
  organizationId String
  studentId      String
  creditId       String
  attendanceId   String?
  creditsUsed    Int
  usedAt         DateTime      @default(now())
  description    String?
  createdAt      DateTime      @default(now())
  attendance     Attendance?   @relation(fields: [attendanceId], references: [id])
  credit         StudentCredit @relation("StudentCreditUsages", fields: [creditId], references: [id], onDelete: Cascade)
  organization   Organization  @relation("CreditUsageOrganization", fields: [organizationId], references: [id], onDelete: Cascade)
  student        Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([creditId])
  @@index([attendanceId])
  @@index([usedAt])
  @@index([organizationId], map: "credit_usages_organizationId_fkey")
  @@map("credit_usages")
}

model CreditRenewal {
  id               String       @id @default(uuid())
  organizationId   String
  studentId        String
  originalCreditId String
  renewedCreditId  String
  renewalDate      DateTime     @default(now())
  renewalReason    String?
  chargedAmount    Decimal?     @db.Decimal(10, 2)
  chargeMethod     String?
  chargeId         String?
  notes            String?
  createdAt        DateTime     @default(now())
  organization     Organization @relation("CreditRenewalOrganization", fields: [organizationId], references: [id], onDelete: Cascade)
  student          Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, renewalDate])
  @@index([organizationId])
  @@map("credit_renewals")
}

model PlanCourse {
  planId    String
  courseId  String
  createdAt DateTime    @default(now())
  course    Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  plan      BillingPlan @relation("PlanCourseToPlan", fields: [planId], references: [id], onDelete: Cascade)

  @@id([planId, courseId])
  @@index([courseId], map: "plan_courses_courseId_fkey")
  @@map("plan_courses")
}

model TechniquePrerequisite {
  techniqueId             String
  prerequisiteTechniqueId String
  createdAt               DateTime  @default(now())
  prerequisite            Technique @relation("TechniquePrerequisitesPrerequisite", fields: [prerequisiteTechniqueId], references: [id], onDelete: Cascade)
  technique               Technique @relation("TechniquePrerequisitesTechnique", fields: [techniqueId], references: [id], onDelete: Cascade)

  @@id([techniqueId, prerequisiteTechniqueId])
  @@index([prerequisiteTechniqueId], map: "technique_prerequisite_prerequisiteTechniqueId_fkey")
  @@map("technique_prerequisite")
}

model MentalModule {
  id               String   @id @default(uuid())
  name             String   @unique
  objective        String
  recommendedPhase String?
  durationMin      Int?
  tags             String   @db.LongText
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now())

  @@map("mental_modules")
}

model AdaptationSnippet {
  id          String   @id @default(uuid())
  audienceTag String
  text        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@index([audienceTag])
  @@map("adaptation_snippets")
}

model RagChunk {
  id             String        @id @default(uuid())
  organizationId String?
  type           String
  sourceType     String?
  sourceId       String?
  version        Int           @default(1)
  lang           String        @default("pt-BR")
  tags           String        @db.LongText
  text           String
  hash           String        @unique
  embedding      Bytes?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now())
  embeddings     RagEmbedding?

  @@index([organizationId, type])
  @@index([type, version])
  @@map("rag_chunks")
}

model RagEmbedding {
  id           String   @id @default(uuid())
  chunkId      String   @unique
  provider     String
  modelVersion String
  dim          Int
  createdAt    DateTime @default(now())
  chunk        RagChunk @relation(fields: [chunkId], references: [id], onDelete: Cascade)

  @@map("rag_embeddings")
}

model Activity {
  id              String               @id @default(uuid())
  organizationId  String
  type            ActivityType
  title           String
  description     String?
  equipment       String               @db.LongText
  safety          String?
  adaptations     String               @db.LongText
  difficulty      Int?
  refTechniqueId  String?
  defaultParams   String?              @db.LongText
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @default(now())
  categoryId      String?
  category        ActivityCategory?    @relation(fields: [categoryId], references: [id])
  organization    Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  refTechnique    Technique?           @relation("ActivityTechniqueRef", fields: [refTechniqueId], references: [id], onDelete: Cascade)
  classItems      ClassActivity[]
  lessonPlanItems LessonPlanActivity[]

  @@index([categoryId], map: "activities_categoryId_fkey")
  @@index([organizationId], map: "activities_organizationId_fkey")
  @@index([refTechniqueId], map: "activities_refTechniqueId_fkey")
  @@map("activities")
}

model LessonPlanActivity {
  id                   String                    @id @default(uuid())
  lessonPlanId         String
  activityId           String
  segment              LessonSegment
  ord                  Int                       @default(1)
  params               String?                   @db.LongText
  objectives           String?
  safetyNotes          String?
  adaptations          String?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @default(now())
  intensityMultiplier  Float                     @default(1)
  minimumForGraduation Int?
  repetitionsPerClass  Int                       @default(1)
  executions           LessonActivityExecution[]
  activity             Activity                  @relation(fields: [activityId], references: [id], onDelete: Cascade)
  lessonPlan           LessonPlan                @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)

  @@unique([lessonPlanId, ord])
  @@index([activityId], map: "lesson_plan_activities_activityId_fkey")
  @@map("lesson_plan_activities")
}

model ClassActivity {
  id              String             @id @default(uuid())
  classId         String
  activityId      String
  segment         LessonSegment
  ord             Int                @default(1)
  paramsUsed      String?            @db.LongText
  completed       Boolean            @default(false)
  adaptationsUsed String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @default(now())
  activity        Activity           @relation(fields: [activityId], references: [id], onDelete: Cascade)
  class           Class              @relation(fields: [classId], references: [id], onDelete: Cascade)
  feedbacks       FeedbackActivity[]

  @@unique([classId, ord])
  @@index([activityId], map: "class_activities_activityId_fkey")
  @@map("class_activities")
}

model Rubric {
  id          String                 @id @default(uuid())
  name        String
  minScore    Int                    @default(0)
  maxScore    Int                    @default(100)
  assessments AssessmentDefinition[]
  criteria    RubricCriterion[]

  @@map("rubrics")
}

model RubricCriterion {
  id          String  @id @default(uuid())
  rubricId    String
  name        String
  description String?
  weight      Int     @default(1)
  rubric      Rubric  @relation(fields: [rubricId], references: [id], onDelete: Cascade)

  @@index([rubricId], map: "rubric_criteria_rubricId_fkey")
  @@map("rubric_criteria")
}

model AssessmentDefinition {
  id       String              @id @default(uuid())
  courseId String
  name     String
  type     AssessmentType
  when     String?
  rubricId String?
  attempts AssessmentAttempt[]
  course   Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  rubric   Rubric?             @relation(fields: [rubricId], references: [id], onDelete: Cascade)

  @@index([courseId], map: "assessment_definitions_courseId_fkey")
  @@index([rubricId], map: "assessment_definitions_rubricId_fkey")
  @@map("assessment_definitions")
}

model AssessmentAttempt {
  id           String               @id @default(uuid())
  assessmentId String
  studentId    String
  classId      String?
  evaluatorId  String?
  startedAt    DateTime?
  completedAt  DateTime?
  scoreTotal   Int?
  details      String?              @db.LongText
  assessment   AssessmentDefinition @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  class        Class?               @relation(fields: [classId], references: [id])
  student      Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([assessmentId], map: "assessment_attempts_assessmentId_fkey")
  @@index([classId], map: "assessment_attempts_classId_fkey")
  @@index([studentId], map: "assessment_attempts_studentId_fkey")
  @@map("assessment_attempts")
}

model PhysicalTestDefinition {
  id            String                @id @default(uuid())
  name          String
  metric        Metric
  targetValue   Float?
  passThreshold Float?
  attempts      PhysicalTestAttempt[]

  @@map("physical_test_definitions")
}

model PhysicalTestAttempt {
  id        String                 @id @default(uuid())
  testId    String
  studentId String
  classId   String?
  value     Float
  passed    Boolean?
  comment   String?
  class     Class?                 @relation(fields: [classId], references: [id])
  student   Student                @relation(fields: [studentId], references: [id], onDelete: Cascade)
  test      PhysicalTestDefinition @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([classId], map: "physical_test_attempts_classId_fkey")
  @@index([studentId], map: "physical_test_attempts_studentId_fkey")
  @@index([testId], map: "physical_test_attempts_testId_fkey")
  @@map("physical_test_attempts")
}

model FeedbackLesson {
  id        String   @id @default(uuid())
  classId   String
  studentId String
  rating    Int
  mood      String?
  comment   String?
  createdAt DateTime @default(now())
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@index([studentId], map: "feedback_lessons_studentId_fkey")
  @@map("feedback_lessons")
}

model FeedbackActivity {
  id                  String        @id @default(uuid())
  classActivityId     String
  studentId           String
  rating              Int
  perceivedDifficulty Int?
  comment             String?
  createdAt           DateTime      @default(now())
  classActivity       ClassActivity @relation(fields: [classActivityId], references: [id], onDelete: Cascade)
  student             Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classActivityId, studentId])
  @@index([studentId], map: "feedback_activities_studentId_fkey")
  @@map("feedback_activities")
}

model TeacherEvaluation {
  id           String     @id @default(uuid())
  classId      String?
  courseId     String?
  studentId    String
  instructorId String
  rating       Int
  criteria     String?    @db.LongText
  comment      String?
  createdAt    DateTime   @default(now())
  class        Class?     @relation(fields: [classId], references: [id])
  course       Course?    @relation(fields: [courseId], references: [id])
  instructor   Instructor @relation(fields: [instructorId], references: [id])
  student      Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([classId], map: "teacher_evaluations_classId_fkey")
  @@index([courseId], map: "teacher_evaluations_courseId_fkey")
  @@index([instructorId], map: "teacher_evaluations_instructorId_fkey")
  @@index([studentId], map: "teacher_evaluations_studentId_fkey")
  @@map("teacher_evaluations")
}

model Badge {
  id             String        @id @default(uuid())
  organizationId String
  name           String
  criteria       String?       @db.LongText
  iconUrl        String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now())
  unlocks        BadgeUnlock[]
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("badges")
}

model BadgeUnlock {
  id         String   @id @default(uuid())
  badgeId    String
  studentId  String
  unlockedAt DateTime @default(now())
  reason     String?
  badge      Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([badgeId, studentId])
  @@index([studentId], map: "badge_unlocks_studentId_fkey")
  @@map("badge_unlocks")
}

model PointsTransaction {
  id         String   @id @default(uuid())
  studentId  String
  amount     Int
  source     String
  refType    String?
  refId      String?
  occurredAt DateTime @default(now())
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId], map: "points_transactions_studentId_fkey")
  @@map("points_transactions")
}

model Turma {
  id                           String            @id @default(uuid())
  organizationId               String
  courseId                     String
  name                         String
  description                  String?
  classType                    ClassType         @default(COLLECTIVE)
  status                       TurmaStatus       @default(SCHEDULED)
  instructorId                 String
  maxStudents                  Int               @default(20)
  startDate                    DateTime
  endDate                      DateTime?
  schedule                     String            @db.LongText
  unitId                       String?
  room                         String?
  price                        Decimal?          @db.Decimal(10, 2)
  isActive                     Boolean           @default(true)
  inactiveReason               String?
  minimumStudents              Int               @default(5)
  activationDate               DateTime?
  createdAt                    DateTime          @default(now())
  updatedAt                    DateTime          @default(now())
  trainingAreaId               String?
  requireAttendanceForProgress Boolean           @default(false)
  createdFromSuggestion        HorarioSugerido[] @relation("CreatedFromSuggestion")
  attendances                  TurmaAttendance[]
  courses                      TurmaCourse[]
  interests                    TurmaInterest[]   @relation("TurmaInterests")
  lessons                      TurmaLesson[]
  students                     TurmaStudent[]
  course                       Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  instructor                   User              @relation(fields: [instructorId], references: [id])
  organization                 Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  trainingArea                 TrainingArea?     @relation("TurmaTrainingArea", fields: [trainingAreaId], references: [id])
  unit                         Unit?             @relation(fields: [unitId], references: [id])

  @@index([courseId], map: "turmas_courseId_fkey")
  @@index([instructorId], map: "turmas_instructorId_fkey")
  @@index([organizationId], map: "turmas_organizationId_fkey")
  @@index([trainingAreaId], map: "turmas_trainingAreaId_fkey")
  @@index([unitId], map: "turmas_unitId_fkey")
  @@map("turmas")
}

model TurmaInterest {
  id        String   @id @default(uuid())
  turmaId   String
  studentId String
  createdAt DateTime @default(now())
  notified  Boolean  @default(false)
  student   Student  @relation("StudentTurmaInterests", fields: [studentId], references: [id], onDelete: Cascade)
  turma     Turma    @relation("TurmaInterests", fields: [turmaId], references: [id], onDelete: Cascade)

  @@unique([turmaId, studentId])
  @@index([studentId], map: "turma_interests_studentId_fkey")
  @@map("turma_interests")
}

model HorarioSugerido {
  id             String             @id @default(uuid())
  studentId      String
  organizationId String
  dayOfWeek      Int
  startTime      String
  endTime        String
  courseType     String?
  level          String?
  preferredUnit  String?
  notes          String?
  status         String             @default("PENDING")
  votes          Int                @default(1)
  createdAt      DateTime           @default(now())
  reviewedAt     DateTime?
  reviewedBy     String?
  createdTurmaId String?
  supporters     HorarioSupporter[] @relation("HorarioSupporters")
  createdTurma   Turma?             @relation("CreatedFromSuggestion", fields: [createdTurmaId], references: [id])
  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student        Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([dayOfWeek, startTime])
  @@index([createdTurmaId], map: "horarios_sugeridos_createdTurmaId_fkey")
  @@index([studentId], map: "horarios_sugeridos_studentId_fkey")
  @@map("horarios_sugeridos")
}

model HorarioSupporter {
  id        String          @id @default(uuid())
  horarioId String
  studentId String
  createdAt DateTime        @default(now())
  horario   HorarioSugerido @relation("HorarioSupporters", fields: [horarioId], references: [id], onDelete: Cascade)
  student   Student         @relation("StudentHorarioSupporters", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([horarioId, studentId])
  @@index([studentId], map: "horario_supporters_studentId_fkey")
  @@map("horario_supporters")
}

model TurmaLesson {
  id                 String                    @id @default(uuid())
  turmaId            String
  lessonPlanId       String?
  lessonNumber       Int
  title              String
  scheduledDate      DateTime
  actualDate         DateTime?
  status             TurmaStatus               @default(SCHEDULED)
  duration           Int                       @default(60)
  notes              String?
  materials          String                    @db.LongText
  objectives         String                    @db.LongText
  techniques         String?                   @db.LongText
  isActive           Boolean                   @default(true)
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @default(now())
  activityExecutions LessonActivityExecution[]
  attendances        TurmaAttendance[]
  lessonPlan         LessonPlan?               @relation(fields: [lessonPlanId], references: [id])
  turma              Turma                     @relation(fields: [turmaId], references: [id], onDelete: Cascade)

  @@unique([turmaId, lessonNumber])
  @@index([lessonPlanId], map: "turma_lessons_lessonPlanId_fkey")
  @@map("turma_lessons")
}

model TurmaStudent {
  id            String            @id @default(uuid())
  turmaId       String
  studentId     String
  enrolledAt    DateTime          @default(now())
  status        String            @default("ACTIVE")
  paymentStatus String            @default("PENDING")
  notes         String?
  isActive      Boolean           @default(true)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now())
  attendances   TurmaAttendance[]
  student       Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  turma         Turma             @relation(fields: [turmaId], references: [id], onDelete: Cascade)

  @@unique([turmaId, studentId])
  @@index([studentId], map: "turma_students_studentId_fkey")
  @@map("turma_students")
}

model TurmaAttendance {
  id                 String                    @id @default(uuid())
  turmaId            String
  turmaLessonId      String
  turmaStudentId     String
  studentId          String
  present            Boolean                   @default(false)
  late               Boolean                   @default(false)
  justified          Boolean                   @default(false)
  notes              String?
  checkedAt          DateTime?
  checkedBy          String?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @default(now())
  activityExecutions LessonActivityExecution[]
  checker            User?                     @relation("AttendanceChecker", fields: [checkedBy], references: [id])
  student            Student                   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  turma              Turma                     @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  lesson             TurmaLesson               @relation(fields: [turmaLessonId], references: [id], onDelete: Cascade)
  turmaStudent       TurmaStudent              @relation(fields: [turmaStudentId], references: [id], onDelete: Cascade)

  @@unique([turmaLessonId, studentId])
  @@index([checkedBy], map: "turma_attendances_checkedBy_fkey")
  @@index([studentId], map: "turma_attendances_studentId_fkey")
  @@index([turmaId], map: "turma_attendances_turmaId_fkey")
  @@index([turmaStudentId], map: "turma_attendances_turmaStudentId_fkey")
  @@map("turma_attendances")
}

/// Configuraes de rastreamento de atividades por organizao
/// Define se a validao  automtica (no check-in) ou manual (pelo professor)
model ActivityTrackingSettings {
  id                          String       @id @default(uuid())
  organizationId              String       @unique
  autoCompleteOnCheckin       Boolean      @default(false)
  requireInstructorValidation Boolean      @default(true)
  enablePerformanceRating     Boolean      @default(true)
  enableVideos                Boolean      @default(false)
  defaultActivityDuration     Int          @default(15)
  createdAt                   DateTime     @default(now())
  updatedAt                   DateTime     @default(now())
  organization                Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("activity_tracking_settings")
}

model TurmaCourse {
  id        String   @id @default(cuid())
  turmaId   String
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  turma     Turma    @relation(fields: [turmaId], references: [id], onDelete: Cascade)

  @@unique([turmaId, courseId])
  @@index([courseId], map: "turma_courses_courseId_fkey")
  @@map("turma_courses")
}

model PersonalTrainingClass {
  id             String                    @id @default(uuid())
  organizationId String
  studentId      String
  instructorId   String
  title          String
  description    String?
  focusAreas     String                    @db.LongText
  trainingType   PersonalTrainingType      @default(INDIVIDUAL)
  intensity      String                    @default("Intermedirio")
  duration       Int                       @default(60)
  location       String?
  notes          String?
  status         PersonalClassStatus       @default(ACTIVE)
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @default(now())
  instructor     Instructor                @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  organization   Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student        Student                   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  sessions       PersonalTrainingSession[]

  @@index([instructorId], map: "personal_training_classes_instructorId_fkey")
  @@index([organizationId], map: "personal_training_classes_organizationId_fkey")
  @@index([studentId], map: "personal_training_classes_studentId_fkey")
  @@map("personal_training_classes")
}

model PersonalTrainingSession {
  id                   String                @id @default(uuid())
  personalClassId      String
  date                 DateTime
  startTime            DateTime
  endTime              DateTime
  actualDuration       Int?
  status               SessionStatus         @default(SCHEDULED)
  attendanceConfirmed  Boolean               @default(false)
  studentNotes         String?
  instructorNotes      String?
  rating               Int?
  feedback             String?
  location             String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @default(now())
  courseId             String?
  lessonContent        String?               @db.LongText
  lessonPlanId         String?
  nextLessonSuggestion String?
  progressNotes        String?
  trainingAreaId       String?
  unitId               String?
  course               Course?               @relation(fields: [courseId], references: [id])
  lessonPlan           LessonPlan?           @relation(fields: [lessonPlanId], references: [id])
  personalClass        PersonalTrainingClass @relation(fields: [personalClassId], references: [id], onDelete: Cascade)
  trainingArea         TrainingArea?         @relation("PersonalSessionTrainingArea", fields: [trainingAreaId], references: [id])
  unit                 Unit?                 @relation(fields: [unitId], references: [id])

  @@index([courseId], map: "personal_training_sessions_courseId_fkey")
  @@index([lessonPlanId], map: "personal_training_sessions_lessonPlanId_fkey")
  @@index([personalClassId], map: "personal_training_sessions_personalClassId_fkey")
  @@index([trainingAreaId], map: "personal_training_sessions_trainingAreaId_fkey")
  @@index([unitId], map: "personal_training_sessions_unitId_fkey")
  @@map("personal_training_sessions")
}

model PersonalTrainingPreference {
  id                   String   @id @default(uuid())
  studentId            String   @unique
  preferredDays        String   @db.LongText
  preferredTimes       String   @db.LongText
  preferredInstructors String   @db.LongText
  trainingFocus        String   @db.LongText
  intensity            String   @default("Intermedirio")
  sessionDuration      Int      @default(60)
  maxSessionsPerWeek   Int      @default(2)
  notes                String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  student              Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("personal_training_preferences")
}

model AgendaItem {
  id             String           @id @default(uuid())
  organizationId String
  type           AgendaItemType
  referenceId    String
  title          String
  description    String?
  startTime      DateTime
  endTime        DateTime
  instructorId   String
  unitId         String?
  trainingAreaId String?
  status         AgendaItemStatus @default(SCHEDULED)
  maxStudents    Int?
  actualStudents Int              @default(0)
  isRecurring    Boolean          @default(false)
  recurrenceRule String?
  color          String?
  notes          String?
  isVirtual      Boolean          @default(false)
  meetingUrl     String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now())
  instructor     User             @relation(fields: [instructorId], references: [id])
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  trainingArea   TrainingArea?    @relation(fields: [trainingAreaId], references: [id])
  unit           Unit?            @relation(fields: [unitId], references: [id])

  @@index([instructorId], map: "agenda_items_instructorId_fkey")
  @@index([organizationId], map: "agenda_items_organizationId_fkey")
  @@index([trainingAreaId], map: "agenda_items_trainingAreaId_fkey")
  @@index([unitId], map: "agenda_items_unitId_fkey")
  @@map("agenda_items")
}

model Lead {
  id                  String          @id @default(uuid())
  organizationId      String
  name                String
  email               String
  phone               String?
  cpf                 String?
  birthDate           DateTime?
  sourceCampaign      String?
  sourceAdGroup       String?
  sourceKeyword       String?
  gclid               String?         @unique
  landingPage         String?
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?
  utmContent          String?
  utmTerm             String?
  referrer            String?
  deviceType          String?
  browserInfo         String?
  stage               LeadStage       @default(NEW)
  status              LeadStatus      @default(ACTIVE)
  assignedToId        String?
  temperature         LeadTemperature @default(COLD)
  priority            Int             @default(0)
  courseInterest      String?
  billingPlanInterest String?
  modalityInterest    String?
  preferredSchedule   String?
  budget              Decimal?        @db.Decimal(10, 2)
  message             String?
  leadCreatedAt       DateTime        @default(now())
  firstContactAt      DateTime?
  qualifiedAt         DateTime?
  trialScheduledAt    DateTime?
  trialAttendedAt     DateTime?
  enrolledAt          DateTime?
  convertedStudentId  String?         @unique
  conversionUploaded  Boolean         @default(false)
  lostAt              DateTime?
  lostReason          String?
  timeToContact       Int?
  timeToQualify       Int?
  timeToTrial         Int?
  timeToEnrollment    Int?
  costPerClick        Decimal?        @db.Decimal(10, 2)
  costPerLead         Decimal?        @db.Decimal(10, 2)
  costPerAcquisition  Decimal?        @db.Decimal(10, 2)
  estimatedLTV        Decimal?        @db.Decimal(10, 2)
  actualRevenue       Decimal?        @db.Decimal(10, 2)
  tags                String          @db.LongText
  customFields        String?         @db.LongText
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @default(now())
  activities          LeadActivity[]
  notes               LeadNote[]
  assignedTo          User?           @relation("LeadAssignedTo", fields: [assignedToId], references: [id])
  convertedStudent    Student?        @relation("LeadToStudent", fields: [convertedStudentId], references: [id])
  organization        Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, stage, status])
  @@index([gclid])
  @@index([email])
  @@index([assignedToId])
  @@map("leads")
}

model LeadActivity {
  id           String           @id @default(uuid())
  leadId       String
  userId       String
  type         LeadActivityType
  title        String
  description  String?
  outcome      String?
  nextAction   String?
  scheduledFor DateTime?
  completedAt  DateTime?
  duration     Int?
  attachments  String?          @db.LongText
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now())
  lead         Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user         User             @relation("LeadActivities", fields: [userId], references: [id])

  @@index([leadId, createdAt])
  @@index([userId], map: "lead_activities_userId_fkey")
  @@map("lead_activities")
}

model LeadNote {
  id        String   @id @default(uuid())
  leadId    String
  userId    String
  content   String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User     @relation("LeadNotes", fields: [userId], references: [id])

  @@index([leadId, createdAt])
  @@index([userId], map: "lead_notes_userId_fkey")
  @@map("lead_notes")
}

model GoogleAdsCampaign {
  id                String             @id @default(uuid())
  organizationId    String
  campaignId        String             @unique
  campaignName      String
  campaignStatus    String
  campaignType      String?
  budget            Decimal?           @db.Decimal(10, 2)
  budgetType        String?
  impressions       Int                @default(0)
  clicks            Int                @default(0)
  cost              Decimal            @default(0.00) @db.Decimal(10, 2)
  conversions       Int                @default(0)
  conversionValue   Decimal            @default(0.00) @db.Decimal(10, 2)
  ctr               Decimal?           @db.Decimal(5, 2)
  cpc               Decimal?           @db.Decimal(10, 2)
  conversionRate    Decimal?           @db.Decimal(5, 2)
  costPerConversion Decimal?           @db.Decimal(10, 2)
  roi               Decimal?           @db.Decimal(10, 2)
  startDate         DateTime?
  endDate           DateTime?
  lastSyncAt        DateTime           @default(now())
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @default(now())
  adGroups          GoogleAdsAdGroup[]
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, campaignStatus])
  @@map("google_ads_campaigns")
}

model GoogleAdsAdGroup {
  id              String             @id @default(uuid())
  campaignId      String
  adGroupId       String             @unique
  adGroupName     String
  adGroupStatus   String
  impressions     Int                @default(0)
  clicks          Int                @default(0)
  cost            Decimal            @default(0.00) @db.Decimal(10, 2)
  conversions     Int                @default(0)
  conversionValue Decimal            @default(0.00) @db.Decimal(10, 2)
  lastSyncAt      DateTime           @default(now())
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @default(now())
  campaign        GoogleAdsCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  keywords        GoogleAdsKeyword[]

  @@index([campaignId])
  @@map("google_ads_ad_groups")
}

model GoogleAdsKeyword {
  id              String           @id @default(uuid())
  adGroupId       String
  keywordId       String           @unique
  keywordText     String
  matchType       String
  status          String
  impressions     Int              @default(0)
  clicks          Int              @default(0)
  cost            Decimal          @default(0.00) @db.Decimal(10, 2)
  conversions     Int              @default(0)
  conversionValue Decimal          @default(0.00) @db.Decimal(10, 2)
  qualityScore    Int?
  lastSyncAt      DateTime         @default(now())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @default(now())
  adGroup         GoogleAdsAdGroup @relation(fields: [adGroupId], references: [id], onDelete: Cascade)

  @@index([adGroupId])
  @@index([keywordText])
  @@map("google_ads_keywords")
}

model GoogleAdsConfig {
  id             String       @id @default(uuid())
  organizationId String       @unique
  customerId     String
  managerId      String?
  refreshToken   String
  isActive       Boolean      @default(true)
  lastSyncAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("google_ads_configs")
}

model CrmSettings {
  id                        String       @id @default(uuid())
  organizationId            String       @unique
  googleAdsCustomerId       String?
  googleAdsClientId         String?
  googleAdsClientSecret     String?
  googleAdsRefreshToken     String?
  googleAdsDeveloperToken   String?
  googleAdsConversionAction String?
  googleAdsConnected        Boolean      @default(false)
  googleAdsEnabled          Boolean      @default(false)
  conversionActionId        String?
  defaultLTV                Decimal?     @db.Decimal(10, 2)
  autoAssignLeads           Boolean      @default(false)
  defaultAssigneeId         String?
  notifyNewLead             Boolean      @default(true)
  notifyHotLead             Boolean      @default(true)
  notifyLostLead            Boolean      @default(false)
  autoFollowUpDays          Int          @default(3)
  autoArchiveDays           Int          @default(30)
  createdAt                 DateTime     @default(now())
  updatedAt                 DateTime     @default(now())
  organization              Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("crm_settings")
}

model ActivityCategory {
  id                   String     @id @default(uuid())
  name                 String     @unique
  description          String?
  color                String?
  icon                 String?
  order                Int        @default(0)
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @default(now())
  minimumForGraduation Int?       @default(50)
  activities           Activity[]

  @@map("activity_categories")
}

model LessonActivityExecution {
  id                String             @id @default(uuid())
  studentId         String
  activityId        String
  attendanceId      String
  turmaLessonId     String
  executedAt        DateTime           @default(now())
  completed         Boolean            @default(false)
  repetitionsCount  Int                @default(1)
  durationMinutes   Int?
  intensityApplied  Float              @default(1)
  performanceRating Int?
  instructorNotes   String?
  validatedBy       String?
  validatedAt       DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @default(now())
  activity          LessonPlanActivity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  attendance        TurmaAttendance    @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  student           Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  turmaLesson       TurmaLesson        @relation(fields: [turmaLessonId], references: [id], onDelete: Cascade)
  instructor        Instructor?        @relation("ActivityValidation", fields: [validatedBy], references: [id])

  @@unique([attendanceId, activityId])
  @@index([studentId, activityId])
  @@index([turmaLessonId])
  @@index([activityId], map: "lesson_activity_executions_activityId_fkey")
  @@index([validatedBy], map: "lesson_activity_executions_validatedBy_fkey")
  @@map("lesson_activity_executions")
}

model CourseGraduationLevel {
  id                         String   @id @default(uuid())
  courseId                   String
  currentBelt                String
  nextBelt                   String
  totalDegrees               Int      @default(4)
  degreePercentageIncrement  Float    @default(20)
  minimumAttendanceRate      Float    @default(80)
  minimumQualityRating       Float    @default(3)
  minimumRepetitionsTotal    Int      @default(500)
  minimumMonthsEnrolled      Int      @default(3)
  requiresInstructorApproval Boolean  @default(true)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  course                     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, currentBelt])
  @@map("course_graduation_levels")
}

model StudentDegreeHistory {
  id               String   @id @default(uuid())
  studentId        String
  courseId         String
  degree           Int
  degreePercentage Float
  belt             String
  completedLessons Int
  totalRepetitions Int
  averageQuality   Float?
  attendanceRate   Float
  achievedAt       DateTime @default(now())
  course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student          Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, courseId])
  @@index([courseId], map: "student_degree_history_courseId_fkey")
  @@map("student_degree_history")
}

model StudentGraduation {
  id                    String    @id @default(uuid())
  studentId             String
  courseId              String
  fromBelt              String
  toBelt                String
  approvedBy            String
  approvedAt            DateTime  @default(now())
  finalAttendanceRate   Float
  finalQualityRating    Float
  totalRepetitions      Int
  totalLessonsCompleted Int
  certificateGenerated  Boolean   @default(false)
  certificateUrl        String?
  ceremonyDate          DateTime?
  ceremonyNotes         String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @default(now())
  course                Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student               Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, toBelt])
  @@index([courseId], map: "student_graduations_courseId_fkey")
  @@map("student_graduations")
}

model AIAgent {
  id               String              @id @default(uuid())
  organizationId   String
  name             String
  description      String?
  specialization   AgentSpecialization
  model            String              @default("gemini-1.5-flash")
  systemPrompt     String
  ragSources       String              @db.LongText
  mcpTools         String              @db.LongText
  temperature      Float               @default(0.7)
  maxTokens        Int                 @default(2048)
  noCodeMode       Boolean             @default(true)
  isActive         Boolean             @default(true)
  autoSaveInsights Boolean             @default(true)
  isPublic         Boolean             @default(false)
  averageRating    Float?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @default(now())
  tasks            AgentTask[]         @relation("AgentToTask")
  conversations    AgentConversation[]
  insights         AgentInsight[]      @relation("AgentToInsight")
  interactions     AgentInteraction[]  @relation("AgentInteractions")
  permissions      AgentPermission[]   @relation("AgentPermissions")
  organization     Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, isActive])
  @@index([specialization])
  @@map("ai_agents")
}

model AgentConversation {
  id        String   @id @default(uuid())
  agentId   String
  userId    String?
  studentId String?
  messages  String   @db.LongText
  rating    Int?
  feedback  String?
  metadata  String?  @db.LongText
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  agent     AIAgent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  student   Student? @relation(fields: [studentId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@index([agentId])
  @@index([userId])
  @@index([studentId])
  @@index([createdAt])
  @@map("agent_conversations")
}

model AgentInteraction {
  id             String       @id @default(uuid())
  agentId        String
  organizationId String
  type           String
  message        String
  action         String?      @db.LongText
  metadata       String?      @db.LongText
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
  agent          AIAgent      @relation("AgentInteractions", fields: [agentId], references: [id], onDelete: Cascade)
  organization   Organization @relation("AgentInteractions", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([agentId])
  @@index([type])
  @@map("agent_interactions")
}

model AgentPermission {
  id              String       @id @default(uuid())
  agentId         String
  organizationId  String
  action          String
  details         String       @db.LongText
  status          String       @default("PENDING")
  approvedBy      String?
  approvedAt      DateTime?
  deniedReason    String?
  executedAt      DateTime?
  executionResult String?      @db.LongText
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  agent           AIAgent      @relation("AgentPermissions", fields: [agentId], references: [id], onDelete: Cascade)
  approver        User?        @relation("ApprovedPermissions", fields: [approvedBy], references: [id])
  organization    Organization @relation("AgentPermissions", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([agentId])
  @@index([status])
  @@index([createdAt])
  @@index([approvedBy], map: "agent_permissions_approvedBy_fkey")
  @@map("agent_permissions")
}

model StudentProgress {
  id                     String                  @id @default(uuid())
  studentId              String
  courseId               String
  lessonNumber           Int
  activityName           String
  completedReps          Int                     @default(0)
  targetReps             Int
  completionPercentage   Float                   @default(0)
  lastUpdated            DateTime                @default(now())
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  qualitativeAssessments QualitativeAssessment[]
  course                 Course                  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student                Student                 @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, lessonNumber, activityName])
  @@index([studentId, courseId])
  @@index([courseId, lessonNumber])
  @@map("student_progress")
}

model QualitativeAssessment {
  id                String          @id @default(uuid())
  studentProgressId String
  instructorId      String?
  rating            Int
  notes             String?
  assessmentDate    DateTime        @default(now())
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  instructor        Instructor?     @relation(fields: [instructorId], references: [id])
  studentProgress   StudentProgress @relation(fields: [studentProgressId], references: [id], onDelete: Cascade)

  @@index([studentProgressId])
  @@index([instructorId])
  @@map("qualitative_assessments")
}

model CourseRequirement {
  id            String   @id @default(uuid())
  courseId      String
  beltLevel     String
  category      String
  activityName  String
  minimumReps   Int
  minimumRating Float?
  isMandatory   Boolean  @default(true)
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, beltLevel, activityName])
  @@index([courseId, beltLevel])
  @@map("course_requirements")
}

model BiometricData {
  id               String   @id @default(uuid())
  studentId        String   @unique
  embedding        String   @db.LongText
  photoUrl         String
  photoBase64      String?  @db.LongText
  qualityScore     Int
  enrolledAt       DateTime @default(now())
  lastUpdatedAt    DateTime @updatedAt
  enrollmentMethod String
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  student          Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([isActive])
  @@map("biometric_data")
}

model BiometricAttempt {
  id                String    @id @default(uuid())
  organizationId    String
  studentId         String?
  detectedStudentId String?
  similarity        Float
  confidence        String
  method            String
  result            String
  errorMessage      String?
  ipAddress         String?
  userAgent         String?
  attemptedAt       DateTime  @default(now())
  processedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  student           Student?  @relation(fields: [studentId], references: [id])

  @@index([organizationId])
  @@index([studentId])
  @@index([detectedStudentId])
  @@index([attemptedAt])
  @@index([method])
  @@map("biometric_attempts")
}

model AgentTask {
  id               String          @id @default(uuid())
  organizationId   String
  agentId          String?
  createdByUserId  String?
  assignedToUserId String?
  title            String
  description      String
  category         String
  actionType       String
  targetEntity     String?
  actionPayload    String          @db.LongText
  reasoning        String?         @db.LongText
  requiresApproval Boolean         @default(true)
  autoExecute      Boolean         @default(false)
  automationLevel  String          @default("MANUAL")
  approvalStatus   String          @default("PENDING")
  status           String          @default("PENDING")
  priority         String          @default("MEDIUM")
  approvedBy       String?
  approvedAt       DateTime?
  rejectedReason   String?
  executorType     String?         @default("AGENT")
  executorId       String?
  scheduledFor     DateTime?
  recurrenceRule   String?
  maxRetries       Int             @default(3)
  retryCount       Int             @default(0)
  lastRetryAt      DateTime?
  nextRetryAt      DateTime?
  executedAt       DateTime?
  executionResult  String?         @db.LongText
  errorMessage     String?
  executionLog     String?         @db.LongText
  dueDate          DateTime?
  metadata         String?         @db.LongText
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  agent            AIAgent?        @relation("AgentToTask", fields: [agentId], references: [id])
  approver         User?           @relation("ApprovedTasks", fields: [approvedBy], references: [id])
  assignedTo       User?           @relation("AssignedTasks", fields: [assignedToUserId], references: [id])
  createdBy        User?           @relation("CreatedTasks", fields: [createdByUserId], references: [id])
  executor         User?           @relation("ExecutorTasks", fields: [executorId], references: [id])
  organization     Organization    @relation("OrgToAgentTask", fields: [organizationId], references: [id], onDelete: Cascade)
  executions       TaskExecution[] @relation("TaskExecutions")

  @@index([organizationId, approvalStatus])
  @@index([organizationId, status])
  @@index([agentId])
  @@index([createdByUserId])
  @@index([assignedToUserId])
  @@index([executorType, executorId])
  @@index([scheduledFor])
  @@index([approvalStatus])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([approvedBy], map: "AgentTask_approvedBy_fkey")
  @@index([executorId], map: "AgentTask_executorId_fkey")
}

model TaskExecution {
  id            String    @id @default(uuid())
  taskId        String
  attemptNumber Int       @default(1)
  executorType  String
  executorId    String?
  status        String
  startedAt     DateTime  @default(now())
  completedAt   DateTime?
  duration      Int?
  result        String?   @db.LongText
  errorMessage  String?
  errorStack    String?
  metadata      String?   @db.LongText
  executor      User?     @relation("TaskExecutions", fields: [executorId], references: [id])
  task          AgentTask @relation("TaskExecutions", fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([executorType, executorId])
  @@index([status])
  @@index([startedAt])
  @@index([executorId], map: "task_executions_executorId_fkey")
  @@map("task_executions")
}

model AgentInsight {
  id             String       @id @default(uuid())
  organizationId String
  agentId        String
  executionId    String?
  type           String
  category       String?
  title          String
  content        String
  priority       String       @default("MEDIUM")
  status         String       @default("NEW")
  isPinned       Boolean      @default(false)
  isRead         Boolean      @default(false)
  metadata       String?      @db.LongText
  relatedEntity  String?
  relatedId      String?
  actionTaken    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  agent          AIAgent      @relation("AgentToInsight", fields: [agentId], references: [id], onDelete: Cascade)
  organization   Organization @relation("OrgToInsight", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([agentId])
  @@index([type])
  @@index([category])
  @@index([priority])
  @@index([status])
  @@index([createdAt])
  @@map("agent_insights")
}

model LandingPage {
  id                    String            @id @default(uuid())
  organizationId        String
  name                  String
  slug                  String
  title                 String
  description           String?
  keywords              String            @db.LongText
  theme                 String?           @db.LongText
  faviconUrl            String?
  ogImageUrl            String?
  htmlContent           String?           @db.Text
  cssContent            String?           @db.Text
  jsContent             String?           @db.Text
  sections              String?           @db.LongText
  googleAnalyticsId     String?
  facebookPixelId       String?
  googleAdsConversionId String?
  whatsappNumber        String?
  status                LandingPageStatus @default(DRAFT)
  publishedAt           DateTime?
  lastGeneratedAt       DateTime?
  lastGeneratedBy       String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  forms                 LandingForm[]
  pageViews             LandingPageView[]
  organization          Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, slug])
  @@index([organizationId, status])
  @@index([status])
  @@map("landing_pages")
}

model LandingForm {
  id               String      @id @default(uuid())
  landingPageId    String
  name             String
  position         String      @default("hero")
  fields           String      @db.LongText
  submitButtonText String      @default("Quero Comear!")
  successMessage   String      @default("Obrigado! Entraremos em contato em breve.")
  autoCreateLead   Boolean     @default(true)
  leadSource       String      @default("LANDING_PAGE")
  leadTemperature  String      @default("HOT")
  assignToUserId   String?
  tags             String      @db.LongText
  submissions      Int         @default(0)
  conversions      Int         @default(0)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  landingPage      LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  @@index([landingPageId])
  @@map("landing_forms")
}

model LandingPageView {
  id            String      @id @default(uuid())
  landingPageId String
  sessionId     String
  userAgent     String?
  ipAddress     String?
  referrer      String?
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  utmContent    String?
  utmTerm       String?
  timeOnPage    Int?
  scrollDepth   Int?
  visitedAt     DateTime    @default(now())
  landingPage   LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  @@index([landingPageId, visitedAt])
  @@index([sessionId])
  @@map("landing_page_views")
}

/// Sesses de autenticao do Portal do Aluno
/// Suporta Magic Link (cdigo 6 dgitos via WhatsApp) e JWT
model StudentSession {
  id          String    @id @default(uuid())
  studentId   String
  token       String    @unique
  magicCode   String?
  codeExpires DateTime?
  userAgent   String?
  ipAddress   String?
  deviceType  String?
  expiresAt   DateTime
  isActive    Boolean   @default(true)
  revokedAt   DateTime?
  createdAt   DateTime  @default(now())
  lastUsedAt  DateTime  @default(now())
  student     Student   @relation("StudentSessions", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([token])
  @@index([magicCode])
  @@index([expiresAt])
  @@map("student_sessions")
}

/// Notificaes do Portal do Aluno
/// Tipos: PAYMENT, CLASS, ACHIEVEMENT, SYSTEM, REMINDER
model StudentNotification {
  id        String                  @id @default(uuid())
  studentId String
  type      StudentNotificationType
  title     String
  message   String
  link      String?
  icon      String?
  read      Boolean                 @default(false)
  readAt    DateTime?
  dismissed Boolean                 @default(false)
  priority  NotificationPriority    @default(NORMAL)
  metadata  String?                 @db.LongText
  expiresAt DateTime?
  createdAt DateTime                @default(now())
  student   Student                 @relation("StudentNotifications", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, read])
  @@index([studentId, type])
  @@index([createdAt])
  @@map("student_notifications")
}

model Permission {
  id              String                   @id @default(uuid())
  module          String
  action          String
  description     String?
  createdAt       DateTime                 @default(now())
  rolePermissions RolePermission[]
  userOverrides   UserPermissionOverride[]

  @@unique([module, action])
  @@map("permissions")
}

model RolePermission {
  id           String          @id @default(uuid())
  role         UserRole
  permissionId String
  scope        PermissionScope @default(ALL)
  createdAt    DateTime        @default(now())
  permission   Permission      @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([permissionId], map: "role_permissions_permissionId_fkey")
  @@map("role_permissions")
}

model UserPermissionOverride {
  id           String           @id @default(uuid())
  userId       String
  permissionId String
  granted      Boolean
  scope        PermissionScope?
  reason       String?
  createdAt    DateTime         @default(now())
  createdBy    String?
  permission   Permission       @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([permissionId], map: "user_permission_overrides_permissionId_fkey")
  @@map("user_permission_overrides")
}

model StudentTechniqueProgress {
  id          String    @id @default(uuid())
  studentId   String
  techniqueId String
  completed   Boolean   @default(false)
  rating      Int?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  technique   Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([studentId, techniqueId])
  @@index([techniqueId], map: "student_technique_progress_techniqueId_fkey")
  @@map("student_technique_progress")
}

model Job {
  id               String           @id @default(uuid())
  organizationId   String
  title            String
  description      String
  requirements     String?
  responsibilities String?
  benefits         String?
  type             JobType          @default(FULL_TIME)
  level            JobLevel         @default(MID)
  location         String?
  remoteOption     Boolean          @default(false)
  salary           String?
  unitId           String?
  department       String?
  vacancies        Int              @default(1)
  status           JobStatus        @default(DRAFT)
  publishedAt      DateTime?
  closedAt         DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  createdById      String?
  applications     JobApplication[]
  createdBy        User?            @relation("JobCreator", fields: [createdById], references: [id])
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  unit             Unit?            @relation(fields: [unitId], references: [id])

  @@index([createdById], map: "jobs_createdById_fkey")
  @@index([organizationId], map: "jobs_organizationId_fkey")
  @@index([unitId], map: "jobs_unitId_fkey")
  @@map("jobs")
}

model JobApplication {
  id            String            @id @default(uuid())
  jobId         String
  userId        String
  studentId     String?
  instructorId  String?
  coverLetter   String?
  resume        String?
  status        ApplicationStatus @default(PENDING)
  appliedAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  reviewedById  String?
  reviewedAt    DateTime?
  reviewNotes   String?
  interviewDate DateTime?
  instructor    Instructor?       @relation(fields: [instructorId], references: [id])
  job           Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  reviewedBy    User?             @relation("ApplicationReviewer", fields: [reviewedById], references: [id])
  student       Student?          @relation(fields: [studentId], references: [id])
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([jobId, userId])
  @@index([instructorId], map: "job_applications_instructorId_fkey")
  @@index([reviewedById], map: "job_applications_reviewedById_fkey")
  @@index([studentId], map: "job_applications_studentId_fkey")
  @@index([userId], map: "job_applications_userId_fkey")
  @@map("job_applications")
}

model DeployArtifact {
  id              String          @id @default(uuid())
  sourceVersion   String
  buildTimestamp  DateTime        @default(now())
  aliasesResolved Boolean         @default(true)
  checksum        String
  contents        String
  location        String
  sizeBytes       Int
  createdAt       DateTime        @default(now())
  sessions        DeploySession[]

  @@map("deploy_artifacts")
}

model DeploySession {
  id                String              @id @default(uuid())
  artifactId        String
  operator          String
  targetEnvironment String
  status            DeploySessionStatus @default(PENDING)
  notes             String?
  startedAt         DateTime            @default(now())
  completedAt       DateTime?
  healthCheck       HealthCheck?
  logs              DeployLog[]
  artifact          DeployArtifact      @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  @@index([artifactId], map: "deploy_sessions_artifactId_fkey")
  @@map("deploy_sessions")
}

model HealthCheck {
  id                     String            @id @default(uuid())
  sessionId              String            @unique
  endpoint               String
  startedAt              DateTime          @default(now())
  completedAt            DateTime          @default(now())
  httpStatus             Int
  latencyMs              Int
  stabilityWindowMinutes Int               @default(30)
  restartsObserved       Int               @default(0)
  result                 HealthCheckResult
  logExcerpt             String?
  session                DeploySession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("deploy_health_checks")
}

model DeployLog {
  id        String         @id @default(uuid())
  sessionId String
  timestamp DateTime       @default(now())
  level     DeployLogLevel @default(INFO)
  message   String
  data      String?        @db.LongText
  session   DeploySession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId], map: "deploy_logs_sessionId_fkey")
  @@map("deploy_logs")
}

model PreEnrollment {
  id                   String       @id @default(uuid())
  firstName            String
  lastName             String
  cpf                  String       @unique
  phone                String
  email                String       @unique
  birthDate            DateTime?
  photoUrl             String?      @db.Text
  planId               String?
  courseId             String?
  customPrice          Decimal?     @db.Decimal(10, 2)
  financialResponsible String?      @db.LongText
  source               String
  status               String       @default("PENDING")
  notes                String?      @db.Text
  convertedAt          DateTime?
  studentId            String?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  course               Course?      @relation(fields: [courseId], references: [id])
  plan                 BillingPlan? @relation(fields: [planId], references: [id])
  student              Student?     @relation(fields: [studentId], references: [id])

  @@index([courseId], map: "pre_enrollments_courseId_fkey")
  @@index([planId], map: "pre_enrollments_planId_fkey")
  @@index([studentId], map: "pre_enrollments_studentId_fkey")
  @@map("pre_enrollments")
}

model EnrollmentLink {
  id             String       @id @default(uuid())
  organizationId String
  token          String       @unique
  planId         String
  courseId       String?
  customPrice    Decimal?     @db.Decimal(10, 2)
  expiresAt      DateTime
  isActive       Boolean      @default(true)
  usageCount     Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  course         Course?      @relation(fields: [courseId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan           BillingPlan  @relation(fields: [planId], references: [id])

  @@index([courseId], map: "enrollment_links_courseId_fkey")
  @@index([organizationId], map: "enrollment_links_organizationId_fkey")
  @@index([planId], map: "enrollment_links_planId_fkey")
  @@map("enrollment_links")
}

model Broadcast {
  id             String          @id @default(uuid())
  organizationId String
  title          String
  message        String          @db.Text
  segment        String
  channels       String          @db.LongText
  scheduledAt    DateTime?
  sentAt         DateTime?
  status         BroadcastStatus @default(DRAFT)
  stats          String?         @db.LongText
  authorId       String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  author         User?           @relation(fields: [authorId], references: [id])
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([authorId], map: "broadcasts_authorId_fkey")
  @@index([organizationId], map: "broadcasts_organizationId_fkey")
  @@map("broadcasts")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum DiscountTrigger {
  MANUAL
  PAYMENT_METHOD
  COUPON
  CAMPAIGN
}

enum CourseCategory {
  MARTIAL_ARTS
  DANCE
  FITNESS
  LANGUAGE
  MUSIC
  OTHER
}

enum SubscriptionPlan {
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum AIProvider {
  CLAUDE
  GEMINI
  OPENAI
  OPENROUTER
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  INSTRUCTOR
  STUDENT
}

enum GradingSystem {
  BELT
  LEVEL
  STRIPE
  CUSTOM
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
  MASTER
}

enum StudentCategory {
  ADULT
  FEMALE
  SENIOR
  CHILD
  INICIANTE1
  INICIANTE2
  INICIANTE3
  HEROI1
  HEROI2
  HEROI3
  MASTER_1
  MASTER_2
  MASTER_3
  TEEN
  KIDS
  WOMEN
  MEN
  MIXED
  LAW_ENFORCEMENT
}

enum Gender {
  MASCULINO
  FEMININO
  OUTRO
}

enum PhysicalCondition {
  INICIANTE
  REGULAR
  AVANCADO
}

enum EvaluationStatus {
  AUTONOMIA
  EM_DESENVOLVIMENTO
  PRECISA_INTERVENCAO
}

enum TechniqueCategory {
  STRIKING
  GRAPPLING
  DEFENSE
  SUBMISSION
  WEAPON
  FITNESS
}

enum TechniqueProficiency {
  LEARNING
  PRACTICING
  COMPETENT
  PROFICIENT
  EXPERT
  MASTERED
}

enum ClassStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  EXCUSED
}

enum CheckInMethod {
  QR_CODE
  MANUAL
  FACIAL_RECOGNITION
  GEOLOCATION
  NFC
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
  SUSPENDED
  TRANSFERRED
}

enum EvaluationType {
  GRADING
  PROGRESS
  TECHNIQUE
  SPARRING
  FITNESS
  KNOWLEDGE
}

enum AchievementCategory {
  ATTENDANCE
  TECHNIQUE
  PROGRESSION
  SOCIAL
  CHALLENGE
  SPECIAL
}

enum AchievementRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum ChallengeType {
  ATTENDANCE
  TECHNIQUE
  STREAK
  SOCIAL
  FITNESS
  CUSTOM
}

enum ChallengeDifficulty {
  EASY
  MEDIUM
  HARD
  EXTREME
}

enum RecurringType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
}

enum BillingType {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  LIFETIME
  CREDIT_CARD_INSTALLMENT
  RECURRING
  CREDITS
}

enum RecurrencePeriod {
  WEEKLY
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  INACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PIX
  BANK_TRANSFER
  CASH
  PAYPAL
  STRIPE
}

enum PlanType {
  MONTHLY
  CREDIT_PACK
  ONE_TIME
  TRIAL
  HYBRID
  GIFT
  CORPORATE
  PARTNERSHIP
}

enum CreditType {
  CLASS
  HOUR
  PERSONAL_HOUR
  PACKAGE
}

enum CreditRenewalTrigger {
  MONTHLY
  ON_CONSUMPTION
  MANUAL
}

enum CreditRenewalMethod {
  INCLUDED
  SEPARATE
  SUBSCRIPTION
}

enum AttendanceTrend {
  IMPROVING
  DECLINING
  STABLE
  VOLATILE
}

enum DropoutRisk {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ActivityType {
  TECHNIQUE
  STRETCH
  DRILL
  EXERCISE
  GAME
  CHALLENGE
  ASSESSMENT
}

enum LessonSegment {
  WARMUP
  STRETCH
  TECHNIQUE
  DRILL
  SIMULATION
  COOLDOWN
}

enum AssessmentType {
  TECHNICAL
  PHYSICAL
  MIXED
}

enum Metric {
  REPS
  TIME
  DISTANCE
  LOAD
}

enum ClassType {
  COLLECTIVE
  PRIVATE
  SEMI_PRIVATE
}

enum TurmaStatus {
  SCHEDULED
  ACTIVE
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum PersonalTrainingType {
  INDIVIDUAL
  SEMI_PRIVATE
  SMALL_GROUP
}

enum PersonalClassStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum SessionStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

enum AgendaItemType {
  TURMA
  PERSONAL_SESSION
}

enum AgendaItemStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

enum LeadStage {
  NEW
  CONTACTED
  QUALIFIED
  TRIAL_SCHEDULED
  TRIAL_ATTENDED
  NEGOTIATION
  CONVERTED
  LOST
}

enum LeadStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum LeadTemperature {
  HOT
  WARM
  COLD
}

enum LeadActivityType {
  CALL
  EMAIL
  WHATSAPP
  SMS
  MEETING
  TRIAL_CLASS
  FOLLOW_UP
  NOTE
  STATUS_CHANGE
  DOCUMENT_SENT
  PAYMENT_RECEIVED
}

enum AgentSpecialization {
  pedagogical
  analytical
  support
  progression
  commercial
  curriculum
}

enum LandingPageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum StudentNotificationType {
  PAYMENT_DUE
  PAYMENT_OVERDUE
  PAYMENT_CONFIRMED
  CLASS_REMINDER
  CLASS_CANCELLED
  CLASS_RESCHEDULED
  ACHIEVEMENT_UNLOCKED
  LEVEL_UP
  BELT_PROMOTION
  SYSTEM
  MARKETING
  WELCOME
  REMINDER
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum PermissionScope {
  ALL
  OWN
  TEAM
  NONE
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERNSHIP
  VOLUNTEER
}

enum JobLevel {
  ENTRY
  JUNIOR
  MID
  SENIOR
  LEAD
  MANAGER
}

enum JobStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  REVIEWING
  INTERVIEW_SCHEDULED
  INTERVIEWED
  APPROVED
  REJECTED
  WITHDRAWN
  HIRED
}

enum DeploySessionStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  ROLLED_BACK
}

enum HealthCheckResult {
  PASS
  FAIL
}

enum DeployLogLevel {
  INFO
  WARN
  ERROR
}

enum BroadcastStatus {
  DRAFT
  SCHEDULED
  PROCESSING
  COMPLETED
  FAILED
}
