generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "linux-musl"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Organization {
  id                       String                    @id @default(uuid())
  name                     String
  slug                     String                    @unique
  description              String?
  logoUrl                  String?
  website                  String?
  phone                    String?
  email                    String?
  address                  String?
  city                     String?
  state                    String?
  country                  String                    @default("Brazil")
  zipCode                  String?
  subscriptionPlan         SubscriptionPlan          @default(BASIC)
  maxStudents              Int                       @default(100)
  maxStaff                 Int                       @default(10)
  isActive                 Boolean                   @default(true)
  primaryColor             String                    @default("#1f2937")
  secondaryColor           String                    @default("#3b82f6")
  customDomain             String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  achievements             Achievement[]
  activities               Activity[]
  asaasCustomers           AsaasCustomer[]
  attendances              Attendance[]
  badges                   Badge[]
  billingPlans             BillingPlan[]
  challenges               Challenge[]
  classes                  Class[]
  courseTemplates          CourseTemplate[]
  courses                  Course[]
  financialResponsibles    FinancialResponsible[]
  financialSettings        FinancialSettings?
  instructors              Instructor[]
  martialArts              MartialArt[]
  mats                     Mat[]
  organizationSettings     OrganizationSettings?
  payments                 Payment[]
  subscriptions            StudentSubscription[]
  students                 Student[]
  techniqueLibraries       TechniqueLibrary[]
  turmas                   Turma[]
  units                    Unit[]
  users                    User[]
  personalClasses          PersonalTrainingClass[]
  agendaItems              AgendaItem[]
  leads                    Lead[] // CRM
  googleAdsCampaigns       GoogleAdsCampaign[] // CRM
  crmSettings              CrmSettings? // CRM
  activityTrackingSettings ActivityTrackingSettings? // Activity Tracking
  aiAgents                 AIAgent[] // AI Agents
  studentCredits           StudentCredit[]           @relation("StudentCreditsOrganization")
  creditUsages             CreditUsage[]             @relation("CreditUsageOrganization")
  creditRenewals           CreditRenewal[]           @relation("CreditRenewalOrganization")

  @@map("organizations")
}

model OrganizationSettings {
  id                         String       @id @default(uuid())
  organizationId             String       @unique
  enableGamification         Boolean      @default(true)
  enableVideoAnalysis        Boolean      @default(false)
  enableAIRecommendations    Boolean      @default(true)
  enableMultipleArts         Boolean      @default(true)
  aiProvider                 AIProvider   @default(CLAUDE)
  openaiApiKey               String?
  anthropicApiKey            String?
  geminiApiKey               String?
  openRouterApiKey           String?
  timezone                   String       @default("America/Sao_Paulo")
  currency                   String       @default("BRL")
  language                   String       @default("pt-BR")
  allowQRCheckin             Boolean      @default(true)
  allowManualCheckin         Boolean      @default(true)
  allowFacialCheckin         Boolean      @default(false)
  checkinWindowStart         Int          @default(30)
  checkinWindowEnd           Int          @default(15)
  // Activity Tracking Settings
  autoMarkActivitiesComplete Boolean      @default(false) // Auto-complete activities on check-in
  allowInstructorOverride    Boolean      @default(true) // Professor can edit activity executions
  requireActivityNotes       Boolean      @default(false) // Force notes on activity completion
  createdAt                  DateTime     @default(now())
  updatedAt                  DateTime     @default(now())
  organization               Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_settings")
}

model MartialArt {
  id             String               @id @default(uuid())
  organizationId String
  name           String
  description    String?
  imageUrl       String?
  hasGrading     Boolean              @default(true)
  gradingSystem  GradingSystem        @default(BELT)
  maxLevel       Int                  @default(10)
  isActive       Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now())
  achievements   Achievement[]
  courses        Course[]
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  progressions   StudentProgression[]
  techniques     Technique[]

  @@unique([organizationId, name])
  @@map("martial_arts")
}

model Course {
  id                    String                    @id @default(uuid())
  organizationId        String
  martialArtId          String?
  courseTemplateId      String?
  name                  String
  description           String?
  level                 CourseLevel
  duration              Int
  classesPerWeek        Int                       @default(2)
  totalClasses          Int
  minAge                Int                       @default(16)
  maxAge                Int?
  category              StudentCategory           @default(ADULT)
  orderIndex            Int                       @default(1)
  sequence              Int                       @default(1)
  isBaseCourse          Boolean                   @default(false)
  nextCourseId          String?                   @unique
  prerequisites         String[]
  objectives            String[]
  requirements          String[]
  imageUrl              String?
  isActive              Boolean                   @default(true)
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @default(now())
  assessmentDefinitions AssessmentDefinition[]
  attendanceRecords     AttendanceRecord[]
  primaryBillingPlans   BillingPlan[]             @relation("BillingPlanPrimaryCourse")
  classes               Class[]
  challenges            CourseChallenge[]
  enrollments           CourseEnrollment[]
  techniques            CourseTechnique[]
  template              CourseTemplate?           @relation(fields: [courseTemplateId], references: [id])
  martialArt            MartialArt?               @relation(fields: [martialArtId], references: [id], onDelete: Cascade)
  nextCourse            Course?                   @relation("CourseProgression", fields: [nextCourseId], references: [id])
  previousCourse        Course?                   @relation("CourseProgression")
  organization          Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  evaluationRecords     EvaluationRecord[]
  lessonPlans           LessonPlan[]
  planCourses           PlanCourse[]
  progressRecords       Progress[]
  studentCourses        StudentCourse[]
  teacherEvaluations    TeacherEvaluation[]
  techniqueDetails      TechniqueDetail[]
  turmasCourses         TurmaCourse[]
  turmas                Turma[]
  weeklyChallenges      WeeklyChallenge[]
  personalSessions      PersonalTrainingSession[]
  graduationLevels      CourseGraduationLevel[]
  degreeHistory         StudentDegreeHistory[]
  graduations           StudentGraduation[]
  progressTracking      StudentProgress[] // Graduation tracking
  courseRequirements    CourseRequirement[] // Graduation tracking

  @@unique([organizationId, name])
  @@map("courses")
}

model CourseTemplate {
  id               String         @id @default(uuid())
  organizationId   String
  name             String
  description      String?
  category         CourseCategory
  duration         Int
  classesPerWeek   Int            @default(2)
  totalClasses     Int
  minAge           Int            @default(16)
  maxAge           Int?
  objectives       String[]
  requirements     String[]
  structure        Json
  ragSettings      Json?
  isSystemTemplate Boolean        @default(false)
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @default(now())
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  courses          Course[]

  @@unique([organizationId, name])
  @@map("course_templates")
}

model TechniqueLibrary {
  id                String            @id @default(uuid())
  organizationId    String
  name              String
  description       String?
  category          TechniqueCategory
  content           Json
  ragEmbeddings     Json?
  prerequisites     String[]
  relatedTechniques String[]
  difficulty        Int               @default(1)
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @default(now())
  organization      Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("technique_libraries")
}

model LessonPlan {
  id                String                    @id @default(uuid())
  courseId          String
  title             String
  description       String?
  lessonNumber      Int
  weekNumber        Int
  unit              String?
  level             Int                       @default(1)
  warmup            Json
  techniques        Json
  simulations       Json
  cooldown          Json
  mentalModule      Json?
  tacticalModule    String?
  adaptations       Json?
  duration          Int                       @default(60)
  difficulty        Int                       @default(1)
  objectives        String[]
  equipment         String[]
  activities        String[]
  videoUrl          String?
  thumbnailUrl      String?
  version           Int                       @default(1)
  isActive          Boolean                   @default(true)
  previousVersionId String?
  archivedAt        DateTime?
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @default(now())
  classes           Class[]
  activityItems     LessonPlanActivity[]
  techniqueLinks    LessonPlanTechniques[]
  course            Course                    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  techniqueRecords  TechniqueRecord[]
  turmaLessons      TurmaLesson[]
  previousVersion   LessonPlan?               @relation("LessonPlanVersions", fields: [previousVersionId], references: [id])
  nextVersions      LessonPlan[]              @relation("LessonPlanVersions")
  personalSessions  PersonalTrainingSession[]

  @@unique([courseId, lessonNumber, isActive])
  @@map("lesson_plans")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Technique {
  id                     String                      @id @default(uuid())
  martialArtId           String?
  name                   String
  description            String?
  difficulty             Int?
  prerequisites          String[]
  videoUrl               String?
  imageUrl               String?
  baseXP                 Int?
  masteryXP              Int?
  badgeIcon              String?
  createdAt              DateTime                    @default(now())
  updatedAt              DateTime                    @updatedAt
  slug                   String?                     @unique
  shortDescription       String?
  subcategory            String?
  modality               String?
  complexity             String?
  durationMin            Int?
  durationMax            Int?
  groupSizeMin           Int?
  groupSizeMax           Int?
  ageRangeMin            Int?
  ageRangeMax            Int?
  objectives             String[]
  resources              String[]
  assessmentCriteria     String[]
  risksMitigation        String[]
  tags                   String[]
  references             String[]
  bnccCompetenciesText   String?                     @default("")
  category               String?
  instructions           Json[]
  stepByStep             Json[]
  bnccCompetencies       Json[]
  referencedByActivities Activity[]                  @relation("ActivityTechniqueRef")
  courseTechniques       CourseTechnique[]
  educationalLinks       EducationalPlanTechniques[]
  lessonLinks            LessonPlanTechniques[]
  requiredByEdges        TechniquePrerequisite[]     @relation("TechniquePrerequisitesPrerequisite")
  prerequisitesEdges     TechniquePrerequisite[]     @relation("TechniquePrerequisitesTechnique")
  techniqueProgress      TechniqueProgress[]
  techniqueRecords       TechniqueRecord[]
  martialArt             MartialArt?                 @relation(fields: [martialArtId], references: [id], onDelete: Cascade)

  @@map("techniques")
}

model CourseTechnique {
  id           String    @id @default(uuid())
  courseId     String
  techniqueId  String
  orderIndex   Int
  weekNumber   Int?
  lessonNumber Int?
  isRequired   Boolean   @default(true)
  course       Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  technique    Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([courseId, techniqueId])
  @@unique([courseId, orderIndex])
  @@map("course_techniques")
}

model User {
  id                 String              @id @default(uuid())
  organizationId     String
  email              String?
  password           String
  role               UserRole            @default(STUDENT)
  firstName          String
  lastName           String
  avatarUrl          String?
  phone              String?
  cpf                String?
  birthDate          DateTime?
  isActive           Boolean             @default(true)
  emailVerified      Boolean             @default(false)
  lastLoginAt        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @default(now())
  instructor         Instructor?
  student            Student?
  attendanceChecks   TurmaAttendance[]   @relation("AttendanceChecker")
  turmas             Turma[]
  agendaItems        AgendaItem[]
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedLeads      Lead[]              @relation("LeadAssignedTo") // CRM
  leadActivities     LeadActivity[]      @relation("LeadActivities") // CRM
  leadNotes          LeadNote[]          @relation("LeadNotes") // CRM
  agentConversations AgentConversation[] // AI Agents

  @@map("users")
}

model Student {
  id                     String                      @id @default(uuid())
  organizationId         String
  userId                 String                      @unique
  emergencyContact       String?
  medicalConditions      String?
  category               StudentCategory             @default(ADULT)
  gender                 Gender?                     @default(MASCULINO)
  age                    Int?
  physicalCondition      PhysicalCondition?          @default(INICIANTE)
  specialNeeds           SpecialNeed[]
  totalXP                Int                         @default(0)
  globalLevel            Int                         @default(1)
  currentStreak          Int                         @default(0)
  longestStreak          Int                         @default(0)
  lastCheckinDate        DateTime?
  preferredDays          String[]
  preferredTimes         String[]
  notifications          Boolean                     @default(true)
  enrollmentDate         DateTime                    @default(now())
  isActive               Boolean                     @default(true)
  createdAt              DateTime                    @default(now())
  updatedAt              DateTime                    @default(now())
  financialResponsibleId String?
  financialResponsibleStudentId String?              // Aluno que é responsável financeiro
  registrationNumber     String?                     @unique
  asaasCustomer          AsaasCustomer?
  assessmentAttempts     AssessmentAttempt[]
  attendancePatterns     AttendancePattern?
  attendanceRecords      AttendanceRecord[]
  attendances            Attendance[]
  badgeUnlocks           BadgeUnlock[]
  challengeProgress      ChallengeProgress[]
  enrollments            CourseEnrollment[]
  evaluationRecords      EvaluationRecord[]
  evaluations            Evaluation[]
  feedbackActivities     FeedbackActivity[]
  feedbackLessons        FeedbackLesson[]
  payments               Payment[]
  physicalTestAttempts   PhysicalTestAttempt[]
  pointsTransactions     PointsTransaction[]
  progressRecords        Progress[]
  achievements           StudentAchievement[]
  studentCourses         StudentCourse[]
  progressions           StudentProgression[]
  subscriptions          StudentSubscription[]
  financialResponsible   FinancialResponsible?       @relation(fields: [financialResponsibleId], references: [id])
  financialResponsibleStudent Student?               @relation("FinancialDependents", fields: [financialResponsibleStudentId], references: [id])
  financialDependents    Student[]                   @relation("FinancialDependents") // Alunos dependentes financeiramente
  organization           Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                   User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  teacherEvaluations     TeacherEvaluation[]
  techniqueRecords       TechniqueRecord[]
  turmaAttendances       TurmaAttendance[]
  turmaStudents          TurmaStudent[]
  personalClasses        PersonalTrainingClass[]
  personalPreferences    PersonalTrainingPreference?
  convertedFromLead      Lead?                       @relation("LeadToStudent") // CRM
  activityExecutions     LessonActivityExecution[]
  degreeHistory          StudentDegreeHistory[]
  graduations            StudentGraduation[]
  agentConversations     AgentConversation[] // AI Agents
  progressTracking       StudentProgress[] // Graduation tracking
  studentCredits         StudentCredit[]
  creditUsages           CreditUsage[]
  creditRenewals         CreditRenewal[]
  biometricData          BiometricData?
  biometricAttempts      BiometricAttempt[]

  @@map("students")
}

model EducationalPlanTechniques {
  educationalPlanId String
  techniqueId       String
  order             Int       @default(0)
  notes             String?
  technique         Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@id([educationalPlanId, techniqueId])
  @@map("educational_plan_techniques")
}

model LessonPlanTechniques {
  lessonPlanId      String
  techniqueId       String
  order             Int        @default(0)
  allocationMinutes Int        @default(0)
  objectiveMapping  String[]
  lessonPlan        LessonPlan @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
  technique         Technique  @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@id([lessonPlanId, techniqueId])
  @@map("lesson_plan_techniques")
}

model FinancialResponsible {
  id               String                @id @default(uuid())
  organizationId   String
  name             String
  cpfCnpj          String
  email            String
  phone            String?
  birthDate        DateTime?
  address          String?
  addressNumber    String?
  complement       String?
  neighborhood     String?
  city             String?
  state            String?
  zipCode          String?
  relationshipType String?
  asaasId          String?
  isActive         Boolean               @default(true)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @default(now())
  asaasCustomer    AsaasCustomer?
  organization     Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payments         Payment[]
  subscriptions    StudentSubscription[]
  students         Student[]

  @@unique([organizationId, cpfCnpj])
  @@unique([organizationId, email])
  @@map("financial_responsibles")
}

model TechniqueRecord {
  id             String               @id @default(uuid())
  studentId      String
  techniqueId    String
  lessonPlanId   String?
  proficiency    TechniqueProficiency @default(LEARNING)
  practiceCount  Int                  @default(1)
  masteryScore   Int                  @default(0)
  firstPracticed DateTime             @default(now())
  lastPracticed  DateTime             @default(now())
  masteredAt     DateTime?
  videoUrl       String?
  aiAnalysis     Json?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now())
  lessonPlan     LessonPlan?          @relation(fields: [lessonPlanId], references: [id])
  student        Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  technique      Technique            @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([studentId, techniqueId])
  @@map("technique_records")
}

model Unit {
  id               String                    @id @default(uuid())
  organizationId   String
  name             String
  description      String?
  address          String
  addressNumber    String?
  complement       String?
  neighborhood     String?
  city             String
  state            String
  zipCode          String
  phone            String?
  email            String?
  capacity         Int                       @default(100)
  totalMats        Int                       @default(1)
  responsibleName  String?
  isActive         Boolean                   @default(true)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @default(now())
  classes          Class[]
  mats             Mat[]
  trainingAreas    TrainingArea[]
  turmas           Turma[]
  personalSessions PersonalTrainingSession[]
  agendaItems      AgendaItem[]
  organization     Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("units")
}

model TrainingArea {
  id               String                    @id @default(uuid())
  unitId           String
  name             String
  description      String?
  capacity         Int                       @default(20)
  areaType         String
  dimensions       String?
  equipment        String[]
  flooring         String?
  isActive         Boolean                   @default(true)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @default(now())
  classes          Class[]                   @relation("ClassTrainingArea")
  unit             Unit                      @relation(fields: [unitId], references: [id], onDelete: Cascade)
  turmas           Turma[]                   @relation("TurmaTrainingArea")
  personalSessions PersonalTrainingSession[] @relation("PersonalSessionTrainingArea")
  agendaItems      AgendaItem[]

  @@unique([unitId, name])
  @@map("training_areas")
}

model Mat {
  id             String       @id @default(uuid())
  organizationId String
  unitId         String
  name           String
  description    String?
  capacity       Int          @default(20)
  dimensions     String?
  equipment      String[]
  materialType   String?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  classes        Class[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  unit           Unit         @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([unitId, name])
  @@map("mats")
}

model Instructor {
  id                     String                    @id @default(uuid())
  organizationId         String
  userId                 String                    @unique
  specializations        String[]
  certifications         String[]
  bio                    String?
  martialArts            String[]
  maxStudentsPerClass    Int                       @default(20)
  experience             String?
  availability           Json?
  hourlyRate             Decimal?                  @db.Decimal(10, 2)
  preferredUnits         String[]
  hireDate               DateTime                  @default(now())
  isActive               Boolean                   @default(true)
  createdAt              DateTime                  @default(now())
  updatedAt              DateTime                  @default(now())
  classes                Class[]
  evaluations            Evaluation[]
  organization           Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                   User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  teacherEvaluations     TeacherEvaluation[]
  personalClasses        PersonalTrainingClass[]
  activityValidations    LessonActivityExecution[] @relation("ActivityValidation")
  qualitativeAssessments QualitativeAssessment[] // Graduation tracking

  @@map("instructors")
}

model ClassSchedule {
  id          String   @id @default(uuid())
  dayOfWeek   Int
  startTime   DateTime
  endTime     DateTime
  maxStudents Int      @default(20)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  classes     Class[]

  @@map("class_schedules")
}

model Class {
  id                   String                @id @default(uuid())
  organizationId       String
  unitId               String?
  matId                String?
  scheduleId           String?
  instructorId         String
  courseId             String
  lessonPlanId         String?
  date                 DateTime
  startTime            DateTime
  endTime              DateTime
  title                String?
  description          String?
  status               ClassStatus           @default(SCHEDULED)
  actualStudents       Int                   @default(0)
  maxStudents          Int                   @default(20)
  agenda               Json?
  notes                String?
  qrCode               String?               @unique
  qrCodeExpiry         DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @default(now())
  location             String?
  trainingAreaId       String?
  assessmentAttempts   AssessmentAttempt[]
  attendanceRecords    AttendanceRecord[]
  attendances          Attendance[]
  activities           ClassActivity[]
  course               Course                @relation(fields: [courseId], references: [id])
  instructor           Instructor            @relation(fields: [instructorId], references: [id])
  lessonPlan           LessonPlan?           @relation(fields: [lessonPlanId], references: [id])
  mat                  Mat?                  @relation(fields: [matId], references: [id])
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  schedule             ClassSchedule?        @relation(fields: [scheduleId], references: [id])
  trainingArea         TrainingArea?         @relation("ClassTrainingArea", fields: [trainingAreaId], references: [id])
  unit                 Unit?                 @relation(fields: [unitId], references: [id])
  feedbackLessons      FeedbackLesson[]
  physicalTestAttempts PhysicalTestAttempt[]
  studentCourses       StudentCourse[]
  teacherEvaluations   TeacherEvaluation[]

  @@map("classes")
}

model Attendance {
  id             String           @id @default(uuid())
  organizationId String
  studentId      String
  classId        String
  status         AttendanceStatus @default(PRESENT)
  checkInTime    DateTime?
  checkInMethod  CheckInMethod?
  location       String?
  notes          String?
  xpEarned       Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now())
  class          Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student        Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  creditUsages   CreditUsage[]

  @@unique([studentId, classId])
  @@map("attendances")
}

model CourseEnrollment {
  id                String              @id @default(uuid())
  studentId         String
  courseId          String
  enrolledAt        DateTime            @default(now())
  completedAt       DateTime?
  expectedEndDate   DateTime
  status            EnrollmentStatus    @default(ACTIVE)
  category          StudentCategory     @default(ADULT)
  gender            String
  currentLesson     Int                 @default(1)
  lessonsCompleted  Int                 @default(0)
  attendanceRate    Float               @default(0)
  currentXP         Int                 @default(0)
  currentLevel      Int                 @default(1)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @default(now())
  challengeProgress ChallengeProgress[]
  course            Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student           Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  evaluations       Evaluation[]
  techniqueProgress TechniqueProgress[]

  @@unique([studentId, courseId])
  @@map("course_enrollments")
}

model TechniqueProgress {
  id                  String               @id @default(uuid())
  enrollmentId        String
  techniqueId         String
  status              TechniqueProficiency @default(LEARNING)
  accuracy            Float?
  attempts            Int                  @default(0)
  practiceCount       Int                  @default(0)
  masteredAt          DateTime?
  videoUrl            String?
  aiAnalysis          Json?
  instructorValidated Boolean              @default(false)
  validatedBy         String?
  validatedAt         DateTime?
  instructorNotes     String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now())
  enrollment          CourseEnrollment     @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  technique           Technique            @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, techniqueId])
  @@map("technique_progress")
}

model CourseChallenge {
  id                String              @id @default(uuid())
  courseId          String
  weekNumber        Int
  type              ChallengeType
  baseActivity      String
  baseMetric        Int
  baseTime          Int?
  description       String?
  xpReward          Int                 @default(15)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @default(now())
  challengeProgress ChallengeProgress[]
  course            Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, weekNumber])
  @@map("course_challenges")
}

model ChallengeProgress {
  id                  String           @id @default(uuid())
  studentId           String
  enrollmentId        String
  challengeId         String
  attempted           Boolean          @default(false)
  completed           Boolean          @default(false)
  actualMetric        Int?
  actualTime          Int?
  videoUrl            String?
  imageUrl            String?
  instructorValidated Boolean          @default(false)
  validatedBy         String?
  validatedAt         DateTime?
  instructorNotes     String?
  xpEarned            Int              @default(0)
  completedAt         DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @default(now())
  challenge           CourseChallenge  @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  enrollment          CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  student             Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, challengeId])
  @@map("challenge_progress")
}

model Evaluation {
  id                 String           @id @default(uuid())
  studentId          String
  instructorId       String
  enrollmentId       String
  type               EvaluationType
  lessonNumber       Int
  techniqueseTested  Json
  physicalTest       Json?
  overallScore       Float
  passed             Boolean          @default(false)
  instructorNotes    String?
  videoUrl           String?
  recommendedActions String[]
  evaluatedBy        String
  evaluatedAt        DateTime         @default(now())
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @default(now())
  enrollment         CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  instructor         Instructor       @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  student            Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("evaluations")
}

model StudentProgression {
  id                   String     @id @default(uuid())
  studentId            String
  martialArtId         String
  currentLevel         Int        @default(1)
  currentGrade         String     @default("White Belt")
  totalXP              Int        @default(0)
  techniquesLearned    Int        @default(0)
  techniquesTotal      Int        @default(0)
  classesAttended      Int        @default(0)
  evaluationsCompleted Int        @default(0)
  nextGrade            String?
  progressToNextGrade  Float      @default(0)
  estimatedTimeToNext  String?
  lastUpdated          DateTime   @default(now())
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @default(now())
  martialArt           MartialArt @relation(fields: [martialArtId], references: [id], onDelete: Cascade)
  student              Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, martialArtId])
  @@map("student_progressions")
}

model Achievement {
  id                  String               @id @default(uuid())
  organizationId      String
  martialArtId        String?
  name                String
  description         String
  category            AchievementCategory
  criteria            Json
  xpReward            Int                  @default(0)
  badgeImageUrl       String?
  rarity              AchievementRarity    @default(COMMON)
  isHidden            Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now())
  martialArt          MartialArt?          @relation(fields: [martialArtId], references: [id])
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  studentAchievements StudentAchievement[]

  @@map("achievements")
}

model StudentAchievement {
  id            String      @id @default(uuid())
  studentId     String
  achievementId String
  unlockedAt    DateTime    @default(now())
  progress      Float       @default(100)
  createdAt     DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  student       Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, achievementId])
  @@map("student_achievements")
}

model Challenge {
  id             String              @id @default(uuid())
  organizationId String
  title          String
  description    String
  type           ChallengeType
  difficulty     ChallengeDifficulty @default(EASY)
  startDate      DateTime
  endDate        DateTime
  isRecurring    Boolean             @default(false)
  recurringType  RecurringType?
  xpReward       Int                 @default(0)
  badgeReward    String?
  criteria       Json
  targetValue    Int                 @default(1)
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now())
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("challenges")
}

model StudentCourse {
  id              String           @id @default(uuid())
  studentId       String
  courseId        String
  classId         String?
  paymentPlanId   String?
  startDate       DateTime         @default(now())
  expectedEndDate DateTime?
  completedDate   DateTime?
  status          EnrollmentStatus @default(ACTIVE)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @default(now())
  class           Class?           @relation(fields: [classId], references: [id], onDelete: Cascade)
  course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  paymentPlan     BillingPlan?     @relation("BillingPlanStudentCourses", fields: [paymentPlanId], references: [id])
  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@map("student_courses")
}

model AttendanceRecord {
  id           String   @id @default(uuid())
  studentId    String
  classId      String
  courseId     String
  lessonNumber Int
  date         DateTime
  present      Boolean  @default(false)
  arrived_late Boolean  @default(false)
  left_early   Boolean  @default(false)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())
  class        Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, lessonNumber])
  @@map("attendance_records")
}

model Progress {
  id                  String   @id @default(uuid())
  studentId           String
  courseId            String
  lessonNumber        Int
  techniquesLearned   String[]
  challengesCompleted String[]
  points              Int      @default(0)
  reflections         String?
  progressDate        DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @default(now())
  course              Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student             Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, lessonNumber])
  @@map("progress_records")
}

model TechniqueDetail {
  id            String            @id @default(uuid())
  courseId      String
  name          String
  description   String?
  category      TechniqueCategory
  lessonNumber  Int
  instructions  String[]
  objectives    String[]
  adaptations   Json?
  orderInLesson Int               @default(1)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now())
  course        Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, lessonNumber, orderInLesson])
  @@map("technique_details")
}

model WeeklyChallenge {
  id              String   @id @default(uuid())
  courseId        String
  weekNumber      Int
  name            String
  description     String
  baseRepetitions Json
  baseTime        Int?
  pointsReward    Int      @default(15)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now())
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, weekNumber])
  @@map("weekly_challenges")
}

model EvaluationRecord {
  id                  String           @id @default(uuid())
  studentId           String
  courseId            String
  lessonNumber        Int
  techniquesEvaluated String[]
  physicalTest        String?
  physicalTestResult  String?
  simulationScenarios String[]
  simulationResults   String[]
  precision           Float?
  status              EvaluationStatus
  certificateIssued   Boolean          @default(false)
  certificateUrl      String?
  instructorNotes     String?
  evaluationDate      DateTime         @default(now())
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @default(now())
  course              Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student             Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, lessonNumber])
  @@map("evaluation_records")
}

model AttendancePattern {
  id                  String          @id @default(uuid())
  studentId           String          @unique
  totalClasses        Int             @default(0)
  attendedClasses     Int             @default(0)
  attendanceRate      Float           @default(0)
  consecutiveAbsences Int             @default(0)
  averageCheckInTime  String?
  preferredDays       String[]
  preferredTimeSlots  String[]
  recentTrend         AttendanceTrend @default(STABLE)
  trendConfidence     Float           @default(0)
  dropoutRisk         DropoutRisk     @default(LOW)
  riskFactors         String[]
  recommendations     String[]
  aiInsights          Json?
  lastAnalyzed        DateTime        @default(now())
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @default(now())
  student             Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("attendance_patterns")
}

model AsaasCustomer {
  id                     String                @id @default(uuid())
  organizationId         String
  studentId              String?               @unique
  financialResponsibleId String?               @unique
  asaasId                String                @unique
  name                   String
  cpfCnpj                String?
  email                  String?
  phone                  String?
  mobilePhone            String?
  postalCode             String?
  address                String?
  addressNumber          String?
  complement             String?
  province               String?
  city                   String?
  state                  String?
  externalReference      String?
  isActive               Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student                Student?              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payments               Payment[]
  subscriptions          StudentSubscription[]

  @@map("asaas_customers")
}

model BillingPlan {
  id                      String                @id @default(uuid())
  organizationId          String
  courseId                String?
  name                    String
  description             String?
  category                StudentCategory?
  price                   Decimal               @db.Decimal(10, 2)
  billingType             BillingType           @default(MONTHLY)
  classesPerWeek          Int?                  @default(2)
  maxClasses              Int?
  duration                Int?
  isUnlimitedAccess       Boolean               @default(false)
  hasPersonalTraining     Boolean               @default(false)
  hasNutrition            Boolean               @default(false)
  allowInstallments       Boolean               @default(false)
  maxInstallments         Int                   @default(1)
  installmentInterestRate Decimal?              @db.Decimal(5, 2)
  isRecurring             Boolean               @default(false)
  recurringInterval       Int?
  accessAllModalities     Boolean               @default(false)
  allowFreeze             Boolean               @default(true)
  freezeMaxDays           Int                   @default(30)
  features                Json?
  isActive                Boolean               @default(true)
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @default(now())
  creditsValidity         Int?
  pricePerClass           Decimal?              @db.Decimal(10, 2)
  // Campos para sistema de créditos
  planType                PlanType? // Tipo de plano (MONTHLY, CREDIT_PACK, etc)
  creditQuantity          Int? // Número de créditos no plano
  creditType              CreditType? // Tipo de crédito (CLASS, HOUR, PERSONAL_HOUR)
  creditValidityDays      Int?                  @default(90) // Dias até expiração dos créditos
  minCreditsPerClass      Int?                  @default(1) // Mínimo de créditos por aula
  allowPartialCredit      Boolean?              @default(false) // Permite usar créditos parciais
  allowTransfer           Boolean?              @default(false) // Permite transferência de créditos
  transferFeePercent      Decimal?              @db.Decimal(5, 2) // Taxa de transferência (%)
  allowRefund             Boolean?              @default(false) // Permite reembolso
  refundDaysBeforeExp     Int?                  @default(7) // Dias antes de expiração para reembolsar
  bulkDiscountTiers       Json? // Descontos progressivos por quantidade {qty: 10, discount: 5}, {qty: 20, discount: 10}
  // Renovação de créditos
  autoRenewCredits        Boolean?              @default(false) // Renovar automaticamente após expiração?
  renewalIntervalDays     Int? // A cada quantos dias renovar? (ex: 30 = mensal, 90 = trimestral)
  maxAutoRenewals         Int? // Máximo de renovações automáticas (null = ilimitado)
  creditRenewalTrigger    CreditRenewalTrigger? @default(MONTHLY) // Quando renovar? MONTHLY, ON_CONSUMPTION, MANUAL
  creditRenewalMethod     CreditRenewalMethod?  @default(INCLUDED) // Como cobrar? INCLUDED, SEPARATE, SUBSCRIPTION
  autoRenewChargeMethod   String? // Legacy: Como cobrar: "SUBSCRIPTION" (usar plano atual), "SEPARATE" (cobrança adicional)
  course                  Course?               @relation("BillingPlanPrimaryCourse", fields: [courseId], references: [id])
  organization            Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planCourses             PlanCourse[]          @relation("PlanCourseToPlan")
  studentCourses          StudentCourse[]       @relation("BillingPlanStudentCourses")
  subscriptions           StudentSubscription[] @relation("BillingPlanSubscriptions")
  studentCredits          StudentCredit[]       @relation("BillingPlanCredits")

  @@map("billing_plans")
}

model StudentSubscription {
  id                     String                @id @default(uuid())
  organizationId         String
  studentId              String
  planId                 String
  asaasCustomerId        String?
  financialResponsibleId String?
  status                 SubscriptionStatus    @default(ACTIVE)
  startDate              DateTime              @default(now())
  endDate                DateTime?
  currentPrice           Decimal               @db.Decimal(10, 2)
  billingType            BillingType
  nextBillingDate        DateTime?
  asaasSubscriptionId    String?
  isActive               Boolean               @default(true)
  autoRenew              Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  payments               Payment[]
  asaasCustomer          AsaasCustomer?        @relation(fields: [asaasCustomerId], references: [id])
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan                   BillingPlan           @relation("BillingPlanSubscriptions", fields: [planId], references: [id])
  student                Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  StudentCredit          StudentCredit[]

  @@map("student_subscriptions")
}

model Payment {
  id                     String                @id @default(uuid())
  organizationId         String
  studentId              String
  subscriptionId         String?
  asaasCustomerId        String?
  financialResponsibleId String?
  amount                 Decimal               @db.Decimal(10, 2)
  description            String
  dueDate                DateTime
  paidDate               DateTime?
  status                 PaymentStatus         @default(PENDING)
  paymentMethod          PaymentMethod?
  asaasPaymentId         String?               @unique
  asaasChargeUrl         String?
  pixCode                String?
  webhookData            Json?
  notes                  String?
  isManual               Boolean               @default(false)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  asaasCustomer          AsaasCustomer?        @relation(fields: [asaasCustomerId], references: [id])
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student                Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subscription           StudentSubscription?  @relation(fields: [subscriptionId], references: [id])

  @@map("payments")
}

model FinancialSettings {
  id                 String       @id @default(uuid())
  organizationId     String       @unique
  asaasApiKey        String?
  asaasWebhookUrl    String?
  asaasWebhookToken  String?
  isSandbox          Boolean      @default(true)
  defaultBillingType BillingType  @default(MONTHLY)
  lateFeePercentage  Decimal      @default(2.0) @db.Decimal(5, 2)
  interestRate       Decimal      @default(1.0) @db.Decimal(5, 2)
  sendReminders      Boolean      @default(true)
  reminderDaysBefore Int          @default(3)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @default(now())
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("financial_settings")
}

// Rastreamento de créditos do aluno
model StudentCredit {
  id               String     @id @default(uuid())
  organizationId   String
  studentId        String
  planId           String
  subscriptionId   String? // Referência opcional para rastrear qual subscription originou esses créditos
  totalCredits     Int // Créditos iniciais adquiridos
  creditsUsed      Int        @default(0) // Créditos utilizados
  creditsAvailable Int // Créditos disponíveis = totalCredits - creditsUsed
  creditType       CreditType // Tipo de crédito (CLASS, HOUR, etc)
  purchasedAt      DateTime   @default(now())
  expiresAt        DateTime? // Null = nunca expira
  status           String     @default("ACTIVE") // ACTIVE, EXPIRED, TRANSFERRED, REFUNDED
  notes            String?    @db.Text
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @default(now())
  // Campos de renovação automática
  autoRenew        Boolean    @default(false) // Este lote de créditos tem renovação automática?
  renewalCount     Int        @default(0) // Quantas vezes este lote foi renovado?
  nextRenewalDate  DateTime? // Quando será a próxima renovação?
  previousCreditId String? // ID do lote anterior (se foi renovado de outro)
  renewalChargeId  String? // ID da cobrança relacionada à renovação

  student        Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  plan           BillingPlan          @relation("BillingPlanCredits", fields: [planId], references: [id])
  organization   Organization         @relation("StudentCreditsOrganization", fields: [organizationId], references: [id], onDelete: Cascade)
  subscription   StudentSubscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  usages         CreditUsage[]        @relation("StudentCreditUsages")
  previousCredit StudentCredit?       @relation("CreditRenewal", fields: [previousCreditId], references: [id], onDelete: SetNull)
  renewedCredits StudentCredit[]      @relation("CreditRenewal")

  @@index([studentId, status])
  @@index([expiresAt])
  @@index([organizationId])
  @@map("student_credits")
}

// Log de consumo de créditos
model CreditUsage {
  id             String   @id @default(uuid())
  organizationId String
  studentId      String
  creditId       String
  attendanceId   String? // Referência à frequência quando crédito foi usado
  creditsUsed    Int // Quantidade de créditos consumida
  usedAt         DateTime @default(now())
  description    String? // Ex: "Aula do dia 2025-01-15"
  createdAt      DateTime @default(now())

  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  credit       StudentCredit @relation("StudentCreditUsages", fields: [creditId], references: [id], onDelete: Cascade)
  attendance   Attendance?   @relation(fields: [attendanceId], references: [id], onDelete: SetNull)
  organization Organization  @relation("CreditUsageOrganization", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([creditId])
  @@index([attendanceId])
  @@index([usedAt])
  @@map("credit_usages")
}

// Histórico de renovação automática de créditos
model CreditRenewal {
  id               String   @id @default(uuid())
  organizationId   String
  studentId        String
  originalCreditId String
  renewedCreditId  String
  renewalDate      DateTime @default(now())
  renewalReason    String? // "AUTO_RENEWAL", "MANUAL_RENEWAL", "PROMOTION"
  chargedAmount    Decimal? @db.Decimal(10, 2) // Valor cobrado pela renovação (null = sem cobrança)
  chargeMethod     String? // "SUBSCRIPTION", "ADDITIONAL_CHARGE", "CREDIT_CARD"
  chargeId         String? // Referência ao Payment ou cobrança Asaas
  notes            String?  @db.Text
  createdAt        DateTime @default(now())

  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  organization Organization @relation("CreditRenewalOrganization", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([studentId, renewalDate])
  @@index([organizationId])
  @@map("credit_renewals")
}

model PlanCourse {
  planId    String
  courseId  String
  createdAt DateTime    @default(now())
  course    Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  plan      BillingPlan @relation("PlanCourseToPlan", fields: [planId], references: [id], onDelete: Cascade)

  @@id([planId, courseId])
  @@map("plan_courses")
}

model TechniquePrerequisite {
  techniqueId             String
  prerequisiteTechniqueId String
  createdAt               DateTime  @default(now())
  prerequisite            Technique @relation("TechniquePrerequisitesPrerequisite", fields: [prerequisiteTechniqueId], references: [id], onDelete: Cascade)
  technique               Technique @relation("TechniquePrerequisitesTechnique", fields: [techniqueId], references: [id], onDelete: Cascade)

  @@id([techniqueId, prerequisiteTechniqueId])
  @@map("technique_prerequisite")
}

model MentalModule {
  id               String   @id @default(uuid())
  name             String   @unique
  objective        String
  recommendedPhase String?
  durationMin      Int?
  tags             String[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now())

  @@map("mental_modules")
}

model AdaptationSnippet {
  id          String   @id @default(uuid())
  audienceTag String
  text        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@index([audienceTag])
  @@map("adaptation_snippets")
}

model RagChunk {
  id             String        @id @default(uuid())
  organizationId String?
  type           String
  sourceType     String?
  sourceId       String?
  version        Int           @default(1)
  lang           String        @default("pt-BR")
  tags           String[]
  text           String
  hash           String        @unique
  embedding      Bytes?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now())
  embeddings     RagEmbedding?

  @@index([organizationId, type])
  @@index([type, version])
  @@map("rag_chunks")
}

model RagEmbedding {
  id           String   @id @default(uuid())
  chunkId      String   @unique
  provider     String
  modelVersion String
  dim          Int
  createdAt    DateTime @default(now())
  chunk        RagChunk @relation(fields: [chunkId], references: [id], onDelete: Cascade)

  @@map("rag_embeddings")
}

model Activity {
  id              String               @id @default(uuid())
  organizationId  String
  type            ActivityType
  title           String
  description     String?
  equipment       String[]             @default([])
  safety          String?
  adaptations     String[]             @default([])
  difficulty      Int?
  refTechniqueId  String?
  defaultParams   Json?
  categoryId      String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @default(now())
  organization    Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  refTechnique    Technique?           @relation("ActivityTechniqueRef", fields: [refTechniqueId], references: [id], onDelete: Cascade)
  category        ActivityCategory?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  classItems      ClassActivity[]
  lessonPlanItems LessonPlanActivity[]

  @@map("activities")
}

model LessonPlanActivity {
  id                   String                    @id @default(uuid())
  lessonPlanId         String
  activityId           String
  segment              LessonSegment
  ord                  Int                       @default(1)
  params               Json?
  objectives           String?
  safetyNotes          String?
  adaptations          String?
  repetitionsPerClass  Int                       @default(1)
  intensityMultiplier  Float                     @default(1.0)
  minimumForGraduation Int?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @default(now())
  activity             Activity                  @relation(fields: [activityId], references: [id], onDelete: Cascade)
  lessonPlan           LessonPlan                @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
  executions           LessonActivityExecution[]

  @@unique([lessonPlanId, ord])
  @@map("lesson_plan_activities")
}

model ClassActivity {
  id              String             @id @default(uuid())
  classId         String
  activityId      String
  segment         LessonSegment
  ord             Int                @default(1)
  paramsUsed      Json?
  completed       Boolean            @default(false)
  adaptationsUsed String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @default(now())
  activity        Activity           @relation(fields: [activityId], references: [id], onDelete: Cascade)
  class           Class              @relation(fields: [classId], references: [id], onDelete: Cascade)
  feedbacks       FeedbackActivity[]

  @@unique([classId, ord])
  @@map("class_activities")
}

model Rubric {
  id          String                 @id @default(uuid())
  name        String
  minScore    Int                    @default(0)
  maxScore    Int                    @default(100)
  assessments AssessmentDefinition[]
  criteria    RubricCriterion[]

  @@map("rubrics")
}

model RubricCriterion {
  id          String  @id @default(uuid())
  rubricId    String
  name        String
  description String?
  weight      Int     @default(1)
  rubric      Rubric  @relation(fields: [rubricId], references: [id], onDelete: Cascade)

  @@map("rubric_criteria")
}

model AssessmentDefinition {
  id       String              @id @default(uuid())
  courseId String
  name     String
  type     AssessmentType
  when     String?
  rubricId String?
  attempts AssessmentAttempt[]
  course   Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  rubric   Rubric?             @relation(fields: [rubricId], references: [id], onDelete: Cascade)

  @@map("assessment_definitions")
}

model AssessmentAttempt {
  id           String               @id @default(uuid())
  assessmentId String
  studentId    String
  classId      String?
  evaluatorId  String?
  startedAt    DateTime?
  completedAt  DateTime?
  scoreTotal   Int?
  details      Json?
  assessment   AssessmentDefinition @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  class        Class?               @relation(fields: [classId], references: [id])
  student      Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("assessment_attempts")
}

model PhysicalTestDefinition {
  id            String                @id @default(uuid())
  name          String
  metric        Metric
  targetValue   Float?
  passThreshold Float?
  attempts      PhysicalTestAttempt[]

  @@map("physical_test_definitions")
}

model PhysicalTestAttempt {
  id        String                 @id @default(uuid())
  testId    String
  studentId String
  classId   String?
  value     Float
  passed    Boolean?
  comment   String?
  class     Class?                 @relation(fields: [classId], references: [id])
  student   Student                @relation(fields: [studentId], references: [id], onDelete: Cascade)
  test      PhysicalTestDefinition @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@map("physical_test_attempts")
}

model FeedbackLesson {
  id        String   @id @default(uuid())
  classId   String
  studentId String
  rating    Int
  mood      String?
  comment   String?
  createdAt DateTime @default(now())
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@map("feedback_lessons")
}

model FeedbackActivity {
  id                  String        @id @default(uuid())
  classActivityId     String
  studentId           String
  rating              Int
  perceivedDifficulty Int?
  comment             String?
  createdAt           DateTime      @default(now())
  classActivity       ClassActivity @relation(fields: [classActivityId], references: [id], onDelete: Cascade)
  student             Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classActivityId, studentId])
  @@map("feedback_activities")
}

model TeacherEvaluation {
  id           String     @id @default(uuid())
  classId      String?
  courseId     String?
  studentId    String
  instructorId String
  rating       Int
  criteria     Json?
  comment      String?
  createdAt    DateTime   @default(now())
  class        Class?     @relation(fields: [classId], references: [id])
  course       Course?    @relation(fields: [courseId], references: [id])
  instructor   Instructor @relation(fields: [instructorId], references: [id])
  student      Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("teacher_evaluations")
}

model Badge {
  id             String        @id @default(uuid())
  organizationId String
  name           String
  criteria       Json?
  iconUrl        String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now())
  unlocks        BadgeUnlock[]
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("badges")
}

model BadgeUnlock {
  id         String   @id @default(uuid())
  badgeId    String
  studentId  String
  unlockedAt DateTime @default(now())
  reason     String?
  badge      Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([badgeId, studentId])
  @@map("badge_unlocks")
}

model PointsTransaction {
  id         String   @id @default(uuid())
  studentId  String
  amount     Int
  source     String
  refType    String?
  refId      String?
  occurredAt DateTime @default(now())
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("points_transactions")
}

model Turma {
  id                           String            @id @default(uuid())
  organizationId               String
  courseId                     String
  name                         String
  description                  String?
  classType                    ClassType         @default(COLLECTIVE)
  status                       TurmaStatus       @default(SCHEDULED)
  instructorId                 String
  maxStudents                  Int               @default(20)
  startDate                    DateTime
  endDate                      DateTime?
  schedule                     Json
  unitId                       String?
  room                         String?
  price                        Decimal?          @db.Decimal(10, 2)
  // When true, personal/semi-private turmas require attendance to advance lesson status
  requireAttendanceForProgress Boolean           @default(false)
  isActive                     Boolean           @default(true)
  createdAt                    DateTime          @default(now())
  updatedAt                    DateTime          @default(now())
  trainingAreaId               String?
  attendances                  TurmaAttendance[]
  courses                      TurmaCourse[]
  lessons                      TurmaLesson[]
  students                     TurmaStudent[]
  course                       Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  instructor                   User              @relation(fields: [instructorId], references: [id])
  organization                 Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  trainingArea                 TrainingArea?     @relation("TurmaTrainingArea", fields: [trainingAreaId], references: [id])
  unit                         Unit?             @relation(fields: [unitId], references: [id])

  @@map("turmas")
}

model TurmaLesson {
  id                 String                    @id @default(uuid())
  turmaId            String
  lessonPlanId       String?
  lessonNumber       Int
  title              String
  scheduledDate      DateTime
  actualDate         DateTime?
  status             TurmaStatus               @default(SCHEDULED)
  duration           Int                       @default(60)
  notes              String?
  materials          String[]                  @default([])
  objectives         String[]                  @default([])
  techniques         Json?
  isActive           Boolean                   @default(true)
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @default(now())
  attendances        TurmaAttendance[]
  lessonPlan         LessonPlan?               @relation(fields: [lessonPlanId], references: [id])
  turma              Turma                     @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  activityExecutions LessonActivityExecution[]

  @@unique([turmaId, lessonNumber])
  @@map("turma_lessons")
}

model TurmaStudent {
  id            String            @id @default(uuid())
  turmaId       String
  studentId     String
  enrolledAt    DateTime          @default(now())
  status        String            @default("ACTIVE")
  paymentStatus String            @default("PENDING")
  notes         String?
  isActive      Boolean           @default(true)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now())
  attendances   TurmaAttendance[]
  student       Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  turma         Turma             @relation(fields: [turmaId], references: [id], onDelete: Cascade)

  @@unique([turmaId, studentId])
  @@map("turma_students")
}

model TurmaAttendance {
  id                 String                    @id @default(uuid())
  turmaId            String
  turmaLessonId      String
  turmaStudentId     String
  studentId          String
  present            Boolean                   @default(false)
  late               Boolean                   @default(false)
  justified          Boolean                   @default(false)
  notes              String?
  checkedAt          DateTime?
  checkedBy          String?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @default(now())
  checker            User?                     @relation("AttendanceChecker", fields: [checkedBy], references: [id])
  student            Student                   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  turma              Turma                     @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  lesson             TurmaLesson               @relation(fields: [turmaLessonId], references: [id], onDelete: Cascade)
  turmaStudent       TurmaStudent              @relation(fields: [turmaStudentId], references: [id], onDelete: Cascade)
  activityExecutions LessonActivityExecution[]

  @@unique([turmaLessonId, studentId])
  @@map("turma_attendances")
}

/// Configurações de rastreamento de atividades por organização
/// Define se a validação é automática (no check-in) ou manual (pelo professor)
model ActivityTrackingSettings {
  id                          String   @id @default(uuid())
  organizationId              String   @unique
  autoCompleteOnCheckin       Boolean  @default(false) // Marcar todas as atividades automaticamente no check-in
  requireInstructorValidation Boolean  @default(true) // Exigir validação manual do professor
  enablePerformanceRating     Boolean  @default(true) // Permitir avaliação de performance (1-5 estrelas)
  enableVideos                Boolean  @default(false) // Suporte a vídeos demonstrativos
  defaultActivityDuration     Int      @default(15) // Duração padrão por atividade (minutos)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("activity_tracking_settings")
}

model TurmaCourse {
  id        String   @id @default(cuid())
  turmaId   String
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  turma     Turma    @relation(fields: [turmaId], references: [id], onDelete: Cascade)

  @@unique([turmaId, courseId])
  @@map("turma_courses")
}

enum CourseCategory {
  MARTIAL_ARTS
  DANCE
  FITNESS
  LANGUAGE
  MUSIC
  OTHER
}

enum SubscriptionPlan {
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum AIProvider {
  CLAUDE
  GEMINI
  OPENAI
  OPENROUTER
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  INSTRUCTOR
  STUDENT
}

enum GradingSystem {
  BELT
  LEVEL
  STRIPE
  CUSTOM
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
  MASTER
}

enum StudentCategory {
  ADULT
  TEEN
  KIDS
  SENIOR
  WOMEN
  MEN
  MIXED
  LAW_ENFORCEMENT
  FEMALE
  CHILD
  INICIANTE1
  INICIANTE2
  INICIANTE3
  HEROI1
  HEROI2
  HEROI3
  MASTER_1
  MASTER_2
  MASTER_3
}

enum Gender {
  MASCULINO
  FEMININO
  OUTRO
}

enum PhysicalCondition {
  INICIANTE
  REGULAR
  AVANCADO
}

enum SpecialNeed {
  TEA
  TDAH
  MOBILIDADE_REDUZIDA
  AUDITIVA
  VISUAL
}

enum EvaluationStatus {
  AUTONOMIA
  EM_DESENVOLVIMENTO
  PRECISA_INTERVENCAO
}

enum TechniqueCategory {
  STRIKING
  GRAPPLING
  DEFENSE
  SUBMISSION
  WEAPON
  FITNESS
}

enum TechniqueProficiency {
  LEARNING
  PRACTICING
  COMPETENT
  PROFICIENT
  EXPERT
  MASTERED
}

enum ClassStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  EXCUSED
}

enum CheckInMethod {
  QR_CODE
  MANUAL
  FACIAL_RECOGNITION
  GEOLOCATION
  NFC
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
  SUSPENDED
  TRANSFERRED
}

enum EvaluationType {
  GRADING
  PROGRESS
  TECHNIQUE
  SPARRING
  FITNESS
  KNOWLEDGE
}

enum EvaluationCategory {
  TECHNICAL
  PHYSICAL
  MENTAL
  BEHAVIORAL
}

enum AchievementCategory {
  ATTENDANCE
  TECHNIQUE
  PROGRESSION
  SOCIAL
  CHALLENGE
  SPECIAL
}

enum AchievementRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum ChallengeType {
  ATTENDANCE
  TECHNIQUE
  STREAK
  SOCIAL
  FITNESS
  CUSTOM
}

enum ChallengeDifficulty {
  EASY
  MEDIUM
  HARD
  EXTREME
}

enum RecurringType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
}

enum CertificateType {
  COMPLETION
  ACHIEVEMENT
  PARTICIPATION
  GRADING
}

enum BillingType {
  MONTHLY
  QUARTERLY
  YEARLY
  LIFETIME
  CREDIT_CARD_INSTALLMENT
  RECURRING
  CREDITS
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PIX
  BANK_TRANSFER
  CASH
  PAYPAL
  STRIPE
}

// Tipos de planos para créditos
enum PlanType {
  MONTHLY // Plano mensal com aulas ilimitadas
  CREDIT_PACK // Pacote de créditos (aulas avulsas)
  ONE_TIME // Pagamento único (ex: trial)
  TRIAL // Trial/experimental
  HYBRID // Combinação de aulas + créditos
  GIFT // Cartão presente
  CORPORATE // Plano corporativo renovável
  PARTNERSHIP // Plano parceria/convênio
}

// Tipos de créditos disponíveis
enum CreditType {
  CLASS // Crédito por aula
  HOUR // Crédito por hora
  PERSONAL_HOUR // Crédito para aula particular
  PACKAGE // Pacote pré-definido
}

// Gatilho para renovação de créditos
enum CreditRenewalTrigger {
  MONTHLY // Renova automaticamente a cada mês (mesmo dia do mês)
  ON_CONSUMPTION // Renova apenas quando créditos são consumidos (vão para zero)
  MANUAL // Renovação manual apenas (instrutor renova quando necessário)
}

// Método de cobrança para renovação
enum CreditRenewalMethod {
  INCLUDED // Incluso na assinatura (sem cobrança adicional)
  SEPARATE // Cobrança separada (cada renovação é um pagamento à parte)
  SUBSCRIPTION // Usa a assinatura existente (se houver)
}

enum AttendanceTrend {
  IMPROVING
  DECLINING
  STABLE
  VOLATILE
}

enum DropoutRisk {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ActivityType {
  TECHNIQUE
  STRETCH
  DRILL
  EXERCISE
  GAME
  CHALLENGE
  ASSESSMENT
}

enum LessonSegment {
  WARMUP
  STRETCH
  TECHNIQUE
  DRILL
  SIMULATION
  COOLDOWN
}

enum AssessmentType {
  TECHNICAL
  PHYSICAL
  MIXED
}

enum Metric {
  REPS
  TIME
  DISTANCE
  LOAD
}

enum ClassType {
  COLLECTIVE
  PRIVATE
  SEMI_PRIVATE
}

enum TurmaStatus {
  SCHEDULED
  ACTIVE
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum WeekDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model PersonalTrainingClass {
  id             String               @id @default(uuid())
  organizationId String
  studentId      String
  instructorId   String
  title          String
  description    String?
  focusAreas     String[]
  trainingType   PersonalTrainingType @default(INDIVIDUAL)
  intensity      String               @default("Intermediário")
  duration       Int                  @default(60) // minutes
  location       String?
  notes          String?
  status         PersonalClassStatus  @default(ACTIVE)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  // Relations
  organization Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student      Student                   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  instructor   Instructor                @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  sessions     PersonalTrainingSession[]

  @@map("personal_training_classes")
}

model PersonalTrainingSession {
  id                   String        @id @default(uuid())
  personalClassId      String
  courseId             String? // Course being taught
  lessonPlanId         String? // Specific lesson plan
  date                 DateTime
  startTime            DateTime
  endTime              DateTime
  actualDuration       Int? // actual minutes attended
  status               SessionStatus @default(SCHEDULED)
  attendanceConfirmed  Boolean       @default(false)
  studentNotes         String?
  instructorNotes      String?
  rating               Int? // 1-5 rating from student
  feedback             String?
  location             String?
  trainingAreaId       String? // Training area used
  unitId               String? // Unit/location
  lessonContent        Json? // What was taught
  progressNotes        String? // Student progress in course
  nextLessonSuggestion String? // Instructor's suggestion for next session
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  // Relations
  personalClass PersonalTrainingClass @relation(fields: [personalClassId], references: [id], onDelete: Cascade)
  course        Course?               @relation(fields: [courseId], references: [id])
  lessonPlan    LessonPlan?           @relation(fields: [lessonPlanId], references: [id])
  trainingArea  TrainingArea?         @relation("PersonalSessionTrainingArea", fields: [trainingAreaId], references: [id])
  unit          Unit?                 @relation(fields: [unitId], references: [id])

  @@map("personal_training_sessions")
}

model PersonalTrainingPreference {
  id                   String   @id @default(uuid())
  studentId            String   @unique
  preferredDays        String[] // e.g., ["MONDAY", "WEDNESDAY", "FRIDAY"]
  preferredTimes       String[] // e.g., ["08:00", "10:00", "14:00"]
  preferredInstructors String[] // instructor IDs
  trainingFocus        String[] // e.g., ["Técnicas de escape", "Condicionamento"]
  intensity            String   @default("Intermediário")
  sessionDuration      Int      @default(60)
  maxSessionsPerWeek   Int      @default(2)
  notes                String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("personal_training_preferences")
}

enum PersonalTrainingType {
  INDIVIDUAL
  SEMI_PRIVATE // 2 people
  SMALL_GROUP // 3-4 people
}

enum PersonalClassStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum SessionStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

// Hybrid Agenda System - Supports both Turmas and Personal Training
model AgendaItem {
  id             String           @id @default(uuid())
  organizationId String
  type           AgendaItemType // TURMA or PERSONAL_SESSION
  referenceId    String // turmaId or personalSessionId
  title          String
  description    String?
  startTime      DateTime
  endTime        DateTime
  instructorId   String
  unitId         String?
  trainingAreaId String?
  status         AgendaItemStatus @default(SCHEDULED)
  maxStudents    Int? // null for personal sessions
  actualStudents Int              @default(0)
  isRecurring    Boolean          @default(false)
  recurrenceRule String? // cron-like or JSON rule
  color          String? // for calendar display
  notes          String?
  isVirtual      Boolean          @default(false)
  meetingUrl     String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  instructor   User          @relation(fields: [instructorId], references: [id])
  unit         Unit?         @relation(fields: [unitId], references: [id])
  trainingArea TrainingArea? @relation(fields: [trainingAreaId], references: [id])

  @@map("agenda_items")
}

enum AgendaItemType {
  TURMA
  PERSONAL_SESSION
}

enum AgendaItemStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

// ============================================================================
// CRM MODULE - Lead Management & Google Ads Integration
// ============================================================================

model Lead {
  id             String @id @default(uuid())
  organizationId String

  // Dados pessoais
  name      String
  email     String
  phone     String?
  cpf       String?
  birthDate DateTime?

  // Origem (Google Ads / Marketing)
  sourceCampaign String? // Nome da campanha do Google Ads
  sourceAdGroup  String? // Grupo de anúncios
  sourceKeyword  String? // Palavra-chave que gerou o clique
  gclid          String? @unique // Google Click ID (rastreamento)
  landingPage    String? // Página onde converteu
  utmSource      String? // utm_source
  utmMedium      String? // utm_medium
  utmCampaign    String? // utm_campaign
  utmContent     String? // utm_content
  utmTerm        String? // utm_term
  referrer       String? // Referrer HTTP
  deviceType     String? // desktop, mobile, tablet
  browserInfo    String? // User agent

  // Pipeline
  stage        LeadStage       @default(NEW)
  status       LeadStatus      @default(ACTIVE)
  assignedToId String? // Vendedor/Instrutor responsável
  temperature  LeadTemperature @default(COLD) // Quente, Morno, Frio
  priority     Int             @default(0) // 0-5 (5 = urgente)

  // Interesse
  courseInterest      String? // Curso de interesse
  billingPlanInterest String? // Plano de interesse
  modalityInterest    String? // Modalidade (Krav Maga, MMA, etc)
  preferredSchedule   String? // Horário preferido
  budget              Decimal? @db.Decimal(10, 2)
  message             String? // Mensagem do formulário

  // Conversão
  leadCreatedAt      DateTime  @default(now())
  firstContactAt     DateTime? // Primeira ligação/contato
  qualifiedAt        DateTime? // Quando foi qualificado
  trialScheduledAt   DateTime? // Aula experimental agendada
  trialAttendedAt    DateTime? // Aula experimental realizada
  enrolledAt         DateTime? // Quando virou aluno
  convertedStudentId String?   @unique // ID do Student criado
  conversionUploaded Boolean   @default(false) // Se conversão foi enviada ao Google Ads
  lostAt             DateTime? // Quando foi perdido
  lostReason         String? // Motivo da perda

  // Métricas de Tempo (calculadas)
  timeToContact    Int? // Minutos até primeiro contato
  timeToQualify    Int? // Minutos até qualificação
  timeToTrial      Int? // Minutos até agendar experimental
  timeToEnrollment Int? // Minutos até matrícula

  // Financeiro (Google Ads)
  costPerClick       Decimal? @db.Decimal(10, 2)
  costPerLead        Decimal? @db.Decimal(10, 2)
  costPerAcquisition Decimal? @db.Decimal(10, 2)
  estimatedLTV       Decimal? @db.Decimal(10, 2) // Lifetime Value estimado
  actualRevenue      Decimal? @db.Decimal(10, 2) // Receita real gerada

  // Metadados
  tags         String[] // Tags para filtros
  customFields Json? // Campos personalizados
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacionamentos
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedTo       User?          @relation("LeadAssignedTo", fields: [assignedToId], references: [id])
  convertedStudent Student?       @relation("LeadToStudent", fields: [convertedStudentId], references: [id])
  activities       LeadActivity[]
  notes            LeadNote[]

  @@index([organizationId, stage, status])
  @@index([gclid])
  @@index([email])
  @@index([assignedToId])
  @@map("leads")
}

enum LeadStage {
  NEW // Lead novo (formulário preenchido)
  CONTACTED // Primeiro contato feito
  QUALIFIED // Lead qualificado (tem interesse real)
  TRIAL_SCHEDULED // Aula experimental agendada
  TRIAL_ATTENDED // Compareceu na aula
  NEGOTIATION // Em negociação (preço, planos)
  CONVERTED // Virou aluno
  LOST // Lead perdido
}

enum LeadStatus {
  ACTIVE // Lead ativo no pipeline
  INACTIVE // Temporariamente inativo
  ARCHIVED // Arquivado (não será mais contatado)
}

enum LeadTemperature {
  HOT // Muito interessado, pronto para comprar
  WARM // Interessado, precisa de nutrição
  COLD // Pouco interesse ou não respondeu
}

model LeadActivity {
  id           String           @id @default(uuid())
  leadId       String
  userId       String // Quem fez a atividade
  type         LeadActivityType
  title        String
  description  String?
  outcome      String? // Resultado da atividade
  nextAction   String? // Próxima ação recomendada
  scheduledFor DateTime? // Para atividades futuras
  completedAt  DateTime? // Quando foi concluída
  duration     Int? // Duração em minutos
  attachments  Json? // URLs de anexos
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user User @relation("LeadActivities", fields: [userId], references: [id])

  @@index([leadId, createdAt])
  @@map("lead_activities")
}

enum LeadActivityType {
  CALL // Ligação telefônica
  EMAIL // Email enviado/recebido
  WHATSAPP // Mensagem WhatsApp
  SMS // SMS enviado
  MEETING // Reunião presencial
  TRIAL_CLASS // Aula experimental
  FOLLOW_UP // Follow-up geral
  NOTE // Anotação simples
  STATUS_CHANGE // Mudança de status/etapa
  DOCUMENT_SENT // Documento/contrato enviado
  PAYMENT_RECEIVED // Pagamento recebido
}

model LeadNote {
  id        String   @id @default(uuid())
  leadId    String
  userId    String // Quem criou a nota
  content   String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user User @relation("LeadNotes", fields: [userId], references: [id])

  @@index([leadId, createdAt])
  @@map("lead_notes")
}

model GoogleAdsCampaign {
  id             String @id @default(uuid())
  organizationId String

  // Dados da campanha (sincronizados via API)
  campaignId     String   @unique // ID do Google Ads
  campaignName   String
  campaignStatus String // ENABLED, PAUSED, REMOVED
  campaignType   String? // SEARCH, DISPLAY, VIDEO, etc
  budget         Decimal? @db.Decimal(10, 2)
  budgetType     String? // DAILY, MONTHLY

  // Métricas (atualizadas periodicamente)
  impressions     Int     @default(0)
  clicks          Int     @default(0)
  cost            Decimal @default(0) @db.Decimal(10, 2)
  conversions     Int     @default(0)
  conversionValue Decimal @default(0) @db.Decimal(10, 2)

  // Métricas calculadas
  ctr               Decimal? @db.Decimal(5, 2) // Click-Through Rate
  cpc               Decimal? @db.Decimal(10, 2) // Cost Per Click
  conversionRate    Decimal? @db.Decimal(5, 2)
  costPerConversion Decimal? @db.Decimal(10, 2)
  roi               Decimal? @db.Decimal(10, 2) // ROI %

  // Datas
  startDate  DateTime?
  endDate    DateTime?
  lastSyncAt DateTime  @default(now())
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  adGroups     GoogleAdsAdGroup[]

  @@index([organizationId, campaignStatus])
  @@map("google_ads_campaigns")
}

model GoogleAdsAdGroup {
  id         String @id @default(uuid())
  campaignId String

  // Dados do grupo de anúncios
  adGroupId     String @unique // ID do Google Ads
  adGroupName   String
  adGroupStatus String // ENABLED, PAUSED, REMOVED

  // Métricas
  impressions     Int     @default(0)
  clicks          Int     @default(0)
  cost            Decimal @default(0) @db.Decimal(10, 2)
  conversions     Int     @default(0)
  conversionValue Decimal @default(0) @db.Decimal(10, 2)

  lastSyncAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campaign GoogleAdsCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  keywords GoogleAdsKeyword[]

  @@index([campaignId])
  @@map("google_ads_ad_groups")
}

model GoogleAdsKeyword {
  id        String @id @default(uuid())
  adGroupId String

  // Dados da palavra-chave
  keywordId   String @unique // ID do Google Ads
  keywordText String
  matchType   String // EXACT, PHRASE, BROAD
  status      String // ENABLED, PAUSED, REMOVED

  // Métricas
  impressions     Int     @default(0)
  clicks          Int     @default(0)
  cost            Decimal @default(0) @db.Decimal(10, 2)
  conversions     Int     @default(0)
  conversionValue Decimal @default(0) @db.Decimal(10, 2)

  // Qualidade
  qualityScore Int? // 1-10

  lastSyncAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  adGroup GoogleAdsAdGroup @relation(fields: [adGroupId], references: [id], onDelete: Cascade)

  @@index([adGroupId])
  @@index([keywordText])
  @@map("google_ads_keywords")
}

model CrmSettings {
  id             String @id @default(uuid())
  organizationId String @unique

  // Configurações do Google Ads (OAuth2)
  googleAdsCustomerId       String? // Customer ID do Google Ads
  googleAdsClientId         String? // OAuth2 Client ID
  googleAdsClientSecret     String? // OAuth2 Client Secret
  googleAdsRefreshToken     String? // OAuth Refresh Token
  googleAdsDeveloperToken   String? // Developer Token
  googleAdsConversionAction String? // Conversion Action Resource Name
  googleAdsConnected        Boolean @default(false)
  googleAdsEnabled          Boolean @default(false)

  // Configurações de conversão
  conversionActionId String? // ID da ação de conversão
  defaultLTV         Decimal? @db.Decimal(10, 2) // LTV padrão por aluno

  // Configurações de pipeline
  autoAssignLeads   Boolean @default(false)
  defaultAssigneeId String? // Vendedor padrão

  // Notificações
  notifyNewLead  Boolean @default(true)
  notifyHotLead  Boolean @default(true)
  notifyLostLead Boolean @default(false)

  // Automações
  autoFollowUpDays Int @default(3) // Dias para follow-up automático
  autoArchiveDays  Int @default(30) // Dias para arquivar leads inativos

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("crm_settings")
}

// ========================================
// ACTIVITY TRACKING & GRADUATION SYSTEM
// ========================================

model ActivityCategory {
  id                   String     @id @default(uuid())
  name                 String     @unique
  description          String?
  color                String?
  icon                 String?
  order                Int        @default(0)
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  activities           Activity[]
  minimumForGraduation Int?       @default(50)

  @@map("activity_categories")
}

model LessonActivityExecution {
  id                String             @id @default(uuid())
  studentId         String
  activityId        String
  attendanceId      String
  turmaLessonId     String
  executedAt        DateTime           @default(now())
  repetitionsCount  Int                @default(1)
  durationMinutes   Int?
  intensityApplied  Float              @default(1.0)
  performanceRating Int?
  instructorNotes   String?            @db.Text
  validatedBy       String?
  validatedAt       DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  student           Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  activity          LessonPlanActivity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  attendance        TurmaAttendance    @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  turmaLesson       TurmaLesson        @relation(fields: [turmaLessonId], references: [id], onDelete: Cascade)
  instructor        Instructor?        @relation("ActivityValidation", fields: [validatedBy], references: [id])

  @@unique([attendanceId, activityId])
  @@index([studentId, activityId])
  @@index([turmaLessonId])
  @@map("lesson_activity_executions")
}

model CourseGraduationLevel {
  id                         String   @id @default(uuid())
  courseId                   String
  currentBelt                String
  nextBelt                   String
  totalDegrees               Int      @default(4)
  degreePercentageIncrement  Float    @default(20)
  minimumAttendanceRate      Float    @default(80)
  minimumQualityRating       Float    @default(3.0)
  minimumRepetitionsTotal    Int      @default(500)
  minimumMonthsEnrolled      Int      @default(3)
  requiresInstructorApproval Boolean  @default(true)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  course                     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, currentBelt])
  @@map("course_graduation_levels")
}

model StudentDegreeHistory {
  id               String   @id @default(uuid())
  studentId        String
  courseId         String
  degree           Int
  degreePercentage Float
  belt             String
  completedLessons Int
  totalRepetitions Int
  averageQuality   Float?
  attendanceRate   Float
  achievedAt       DateTime @default(now())
  student          Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([studentId, courseId])
  @@map("student_degree_history")
}

model StudentGraduation {
  id                    String    @id @default(uuid())
  studentId             String
  courseId              String
  fromBelt              String
  toBelt                String
  approvedBy            String
  approvedAt            DateTime  @default(now())
  finalAttendanceRate   Float
  finalQualityRating    Float
  totalRepetitions      Int
  totalLessonsCompleted Int
  certificateGenerated  Boolean   @default(false)
  certificateUrl        String?
  ceremonyDate          DateTime?
  ceremonyNotes         String?   @db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  student               Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course                Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, toBelt])
  @@map("student_graduations")
}

// ==========================================
// AI AGENTS MODELS
// ==========================================

enum AgentSpecialization {
  pedagogical // 🎓 Assistente pedagógico
  analytical // 📊 Análise de desempenho
  support // 💬 Suporte ao aluno
  progression // 🎯 Coach de progressão
  commercial // 💰 Vendas e conversão
  curriculum // 📚 Educador físico especialista em artes marciais
}

model AIAgent {
  id             String              @id @default(uuid())
  organizationId String
  name           String
  description    String?
  specialization AgentSpecialization
  model          String              @default("gemini-1.5-flash") // gemini-1.5-flash or gemini-1.5-pro
  systemPrompt   String              @db.Text
  ragSources     String[] // ["courses", "techniques", "faqs", "evaluations"]
  mcpTools       String[] // ["getStudentData", "getCourseData", "executeQuery"]
  temperature    Float               @default(0.7)
  maxTokens      Int                 @default(2048)
  noCodeMode     Boolean             @default(true) // Always enforce no-code
  isActive       Boolean             @default(true)
  isPublic       Boolean             @default(false)
  averageRating  Float?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversations  AgentConversation[]

  @@index([organizationId, isActive])
  @@index([specialization])
  @@map("ai_agents")
}

model AgentConversation {
  id        String   @id @default(uuid())
  agentId   String
  userId    String?
  studentId String?
  messages  Json // Array of {role, content, timestamp, mcpToolsUsed?, ragSourcesUsed?}
  rating    Int? // 1-5 stars
  feedback  String?  @db.Text
  metadata  Json? // Context, session info, etc
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  agent     AIAgent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  student   Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)

  @@index([agentId])
  @@index([userId])
  @@index([studentId])
  @@index([createdAt])
  @@map("agent_conversations")
}

// ==========================================
// GRADUATION TRACKING MODELS
// ==========================================

// Progresso quantitativo de atividades do aluno
model StudentProgress {
  id                     String                  @id @default(uuid())
  studentId              String
  courseId               String
  lessonNumber           Int
  activityName           String
  completedReps          Int                     @default(0) // Repetições completadas
  targetReps             Int // Repetições planejadas
  completionPercentage   Float                   @default(0) // 0-100
  lastUpdated            DateTime                @default(now())
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  student                Student                 @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course                 Course                  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  qualitativeAssessments QualitativeAssessment[]

  @@unique([studentId, courseId, lessonNumber, activityName])
  @@index([studentId, courseId])
  @@index([courseId, lessonNumber])
  @@map("student_progress")
}

// Avaliações qualitativas (notas do instrutor)
model QualitativeAssessment {
  id                String          @id @default(uuid())
  studentProgressId String
  instructorId      String?
  rating            Int // 1-5 estrelas
  notes             String?         @db.Text
  assessmentDate    DateTime        @default(now())
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  studentProgress   StudentProgress @relation(fields: [studentProgressId], references: [id], onDelete: Cascade)
  instructor        Instructor?     @relation(fields: [instructorId], references: [id], onDelete: SetNull)

  @@index([studentProgressId])
  @@index([instructorId])
  @@map("qualitative_assessments")
}

// Requisitos para graduação por curso e faixa
model CourseRequirement {
  id            String   @id @default(uuid())
  courseId      String
  beltLevel     String // "BRANCA", "AMARELA", etc
  category      String // "POSTURAS", "SOCOS", "CHUTES", etc
  activityName  String
  minimumReps   Int // Repetições mínimas para graduação
  minimumRating Float? // Rating médio mínimo (opcional)
  isMandatory   Boolean  @default(true)
  description   String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, beltLevel, activityName])
  @@index([courseId, beltLevel])
  @@map("course_requirements")
}

// Biometric Data - Face Recognition
model BiometricData {
  id              String   @id @default(uuid())
  studentId       String   @unique
  embedding       Float[] // 128-dimensional face descriptor vector
  photoUrl        String // URL to stored face photo
  photoBase64     String? // Optional: inline base64 for quick access
  qualityScore    Int // 0-100 quality score from face detection
  enrolledAt      DateTime @default(now())
  lastUpdatedAt   DateTime @updatedAt
  enrollmentMethod String // "AUTO", "MANUAL"
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([isActive])
  @@map("biometric_data")
}

// Biometric Attempt Log - Security Audit Trail
model BiometricAttempt {
  id               String   @id @default(uuid())
  organizationId   String
  studentId        String?
  detectedStudentId String? // If matched via biometric
  similarity       Float // Euclidean distance or similarity score (0-1)
  confidence       String // "EXCELLENT", "GOOD", "FAIR", "POOR", "FAILED"
  method           String // "FACE_DETECTION", "MANUAL_SEARCH", "QR_CODE"
  result           String // "SUCCESS", "NO_MATCH", "POOR_QUALITY", "ERROR"
  errorMessage     String?
  ipAddress        String?
  userAgent        String?
  attemptedAt      DateTime @default(now())
  processedAt      DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  student          Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([studentId])
  @@index([detectedStudentId])
  @@index([attemptedAt])
  @@index([method])
  @@map("biometric_attempts")
}
