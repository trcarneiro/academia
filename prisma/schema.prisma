generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "linux-musl"]
}

datasource db {
  provider  = "mysql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id                       String                    @id @default(uuid())
  name                     String
  slug                     String                    @unique
  description              String?
  logoUrl                  String?
  website                  String?
  phone                    String?
  email                    String?
  address                  String?
  city                     String?
  state                    String?
  country                  String                    @default("Brazil")
  zipCode                  String?
  subscriptionPlan         SubscriptionPlan          @default(BASIC)
  maxStudents              Int                       @default(100)
  maxStaff                 Int                       @default(10)
  isActive                 Boolean                   @default(true)
  primaryColor             String                    @default("#1f2937")
  secondaryColor           String                    @default("#3b82f6")
  customDomain             String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  achievements             Achievement[]
  activities               Activity[]
  activityTrackingSettings ActivityTrackingSettings?
  agendaItems              AgendaItem[]
  agentInteractions        AgentInteraction[]        @relation("AgentInteractions")
  agentPermissions         AgentPermission[]         @relation("AgentPermissions")
  aiAgents                 AIAgent[]
  asaasCustomers           AsaasCustomer[]
  attendances              Attendance[]
  badges                   Badge[]
  billingPlans             BillingPlan[]
  challenges               Challenge[]
  classes                  Class[]
  courseTemplates          CourseTemplate[]
  courses                  Course[]
  coursePrograms           CourseProgram[]
  googleAdsConfig          GoogleAdsConfig?
  creditRenewals           CreditRenewal[]           @relation("CreditRenewalOrganization")
  creditUsages             CreditUsage[]             @relation("CreditUsageOrganization")
  crmSettings              CrmSettings?
  financialResponsibles    FinancialResponsible[]
  financialSettings        FinancialSettings?
  googleAdsCampaigns       GoogleAdsCampaign[]
  instructors              Instructor[]
  leads                    Lead[]
  martialArts              MartialArt[]
  mats                     Mat[]
  organizationSettings     OrganizationSettings?
  payments                 Payment[]
  personalClasses          PersonalTrainingClass[]
  studentCredits           StudentCredit[]           @relation("StudentCreditsOrganization")
  subscriptions            StudentSubscription[]
  students                 Student[]
  techniqueLibraries       TechniqueLibrary[]
  turmas                   Turma[]
  horarioSuggestions       HorarioSugerido[]
  units                    Unit[]
  users                    User[]

  agentTasks               AgentTask[]               @relation("OrgToAgentTask")
  agentInsights            AgentInsight[]            @relation("OrgToInsight")
  landingPages             LandingPage[]
  jobs                     Job[]
  discounts                Discount[]
  enrollmentLinks          EnrollmentLink[]

  @@map("organizations")
}

model OrganizationSettings {
  id                         String       @id @default(uuid())
  organizationId             String       @unique
  enableGamification         Boolean      @default(true)
  enableVideoAnalysis        Boolean      @default(false)
  enableAIRecommendations    Boolean      @default(true)
  enableMultipleArts         Boolean      @default(true)
  aiProvider                 AIProvider   @default(CLAUDE)
  openaiApiKey               String?
  anthropicApiKey            String?
  geminiApiKey               String?
  openRouterApiKey           String?
  timezone                   String       @default("America/Sao_Paulo")
  currency                   String       @default("BRL")
  language                   String       @default("pt-BR")
  allowQRCheckin             Boolean      @default(true)
  allowManualCheckin         Boolean      @default(true)
  allowFacialCheckin         Boolean      @default(false)
  checkinWindowStart         Int          @default(30)
  checkinWindowEnd           Int          @default(15)
  createdAt                  DateTime     @default(now())
  updatedAt                  DateTime     @default(now())
  allowInstructorOverride    Boolean      @default(true)
  autoMarkActivitiesComplete Boolean      @default(false)
  requireActivityNotes       Boolean      @default(false)
  organization               Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_settings")
}

model MartialArt {
  id             String               @id @default(uuid())
  organizationId String
  name           String
  description    String?
  imageUrl       String?
  hasGrading     Boolean              @default(true)
  gradingSystem  GradingSystem        @default(BELT)
  maxLevel       Int                  @default(10)
  isActive       Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now())
  achievements   Achievement[]
  courses        Course[]
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  progressions   StudentProgression[]
  techniques     Technique[]

  @@unique([organizationId, name])
  @@map("martial_arts")
}

model Course {
  id                    String                    @id @default(uuid())
  organizationId        String
  martialArtId          String?
  courseTemplateId      String?
  name                  String
  description           String?
  level                 CourseLevel
  duration              Int
  classesPerWeek        Int                       @default(2)
  totalClasses          Int
  minAge                Int                       @default(16)
  maxAge                Int?
  category              StudentCategory           @default(ADULT)
  orderIndex            Int                       @default(1)
  nextCourseId          String?                   @unique
  prerequisites         Json
  objectives            Json
  requirements          Json
  imageUrl              String?
  isActive              Boolean                   @default(true)
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @default(now())
  isBaseCourse          Boolean                   @default(false)
  sequence              Int                       @default(1)
  assessmentDefinitions AssessmentDefinition[]
  attendanceRecords     AttendanceRecord[]
  primaryBillingPlans   BillingPlan[]             @relation("BillingPlanPrimaryCourse")
  classes               Class[]
  challenges            CourseChallenge[]
  enrollments           CourseEnrollment[]
  graduationLevels      CourseGraduationLevel[]
  courseRequirements    CourseRequirement[]
  techniques            CourseTechnique[]
  template              CourseTemplate?           @relation(fields: [courseTemplateId], references: [id])
  martialArt            MartialArt?               @relation(fields: [martialArtId], references: [id], onDelete: Cascade)
  nextCourse            Course?                   @relation("CourseProgression", fields: [nextCourseId], references: [id])
  previousCourse        Course?                   @relation("CourseProgression")
  organization          Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  evaluationRecords     EvaluationRecord[]
  instructor_courses    InstructorCourse[]
  lessonPlans           LessonPlan[]
  personalSessions      PersonalTrainingSession[]
  planCourses           PlanCourse[]
  progressRecords       Progress[]
  studentCourses        StudentCourse[]
  degreeHistory         StudentDegreeHistory[]
  graduations           StudentGraduation[]
  progressTracking      StudentProgress[]
  teacherEvaluations    TeacherEvaluation[]
  techniqueDetails      TechniqueDetail[]
  turmasCourses         TurmaCourse[]
  turmas                Turma[]
  weeklyChallenges      WeeklyChallenge[]
  preEnrollments        PreEnrollment[]
  enrollmentLinks       EnrollmentLink[]

  @@unique([organizationId, name])
  @@map("courses")
}

model CourseProgram {
  id             String       @id @default(uuid())
  organizationId String
  name           String
  description    String?
  level          CourseLevel
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  classes        Class[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("course_programs")
}

model CourseTemplate {
  id               String         @id @default(uuid())
  organizationId   String
  name             String
  description      String?
  category         CourseCategory
  duration         Int
  classesPerWeek   Int            @default(2)
  totalClasses     Int
  minAge           Int            @default(16)
  maxAge           Int?
  objectives       Json
  requirements     Json
  structure        Json
  ragSettings      Json?
  isSystemTemplate Boolean        @default(false)
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @default(now())
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  courses          Course[]

  @@unique([organizationId, name])
  @@map("course_templates")
}

model TechniqueLibrary {
  id                String            @id @default(uuid())
  organizationId    String
  name              String
  description       String?
  category          TechniqueCategory
  content           Json
  ragEmbeddings     Json?
  prerequisites     Json
  relatedTechniques Json
  difficulty        Int               @default(1)
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @default(now())
  organization      Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("technique_libraries")
}

model LessonPlan {
  id                String                    @id @default(uuid())
  courseId          String
  title             String
  description       String?
  lessonNumber      Int
  weekNumber        Int
  unit              String?
  level             Int                       @default(1)
  warmup            Json
  techniques        Json
  simulations       Json
  cooldown          Json
  mentalModule      Json?
  tacticalModule    String?
  adaptations       Json?
  duration          Int                       @default(60)
  difficulty        Int                       @default(1)
  objectives        Json
  equipment         Json
  activities        Json
  activityItems     LessonPlanActivity[]
  videoUrl          String?
  thumbnailUrl      String?
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @default(now())
  archivedAt        DateTime?
  isActive          Boolean                   @default(true)
  previousVersionId String?
  version           Int                       @default(1)
  classes           Class[]
  techniqueLinks    LessonPlanTechniques[]
  course            Course                    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  previousVersion   LessonPlan?               @relation("LessonPlanVersions", fields: [previousVersionId], references: [id])
  nextVersions      LessonPlan[]              @relation("LessonPlanVersions")
  personalSessions  PersonalTrainingSession[]
  techniqueRecords  TechniqueRecord[]
  turmaLessons      TurmaLesson[]

  @@unique([courseId, lessonNumber, isActive])
  @@map("lesson_plans")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Technique {
  id                     String                      @id @default(uuid())
  martialArtId           String?
  name                   String
  description            String?
  difficulty             Int?
  prerequisites          Json
  videoUrl               String?
  imageUrl               String?
  baseXP                 Int?
  masteryXP              Int?
  badgeIcon              String?
  createdAt              DateTime                    @default(now())
  updatedAt              DateTime                    @updatedAt
  slug                   String?                     @unique
  shortDescription       String?
  subcategory            String?
  modality               String?
  complexity             String?
  durationMin            Int?
  durationMax            Int?
  groupSizeMin           Int?
  groupSizeMax           Int?
  ageRangeMin            Int?
  ageRangeMax            Int?
  objectives             Json
  resources              Json
  assessmentCriteria     Json
  risksMitigation        Json
  tags                   Json
  references             Json
  bnccCompetenciesText   String?                     @default("")
  category               String?
  instructions           Json
  stepByStep             Json
  bnccCompetencies       Json
  referencedByActivities Activity[]                  @relation("ActivityTechniqueRef")
  courseTechniques       CourseTechnique[]
  educationalLinks       EducationalPlanTechniques[]
  lessonLinks            LessonPlanTechniques[]
  requiredByEdges        TechniquePrerequisite[]     @relation("TechniquePrerequisitesPrerequisite")
  prerequisitesEdges     TechniquePrerequisite[]     @relation("TechniquePrerequisitesTechnique")
  techniqueProgress      TechniqueProgress[]
  studentTechniqueProgress StudentTechniqueProgress[]
  techniqueRecords       TechniqueRecord[]
  martialArt             MartialArt?                 @relation(fields: [martialArtId], references: [id], onDelete: Cascade)

  @@map("techniques")
}

model CourseTechnique {
  id           String    @id @default(uuid())
  courseId     String
  techniqueId  String
  orderIndex   Int
  weekNumber   Int?
  lessonNumber Int?
  isRequired   Boolean   @default(true)
  course       Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  technique    Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([courseId, techniqueId])
  @@unique([courseId, orderIndex])
  @@map("course_techniques")
}

model User {
  id                   String              @id @default(uuid())
  organizationId       String
  email                String?
  password             String
  role                 UserRole            @default(STUDENT)
  firstName            String
  lastName             String
  avatarUrl            String?             @db.LongText
  phone                String?
  cpf                  String?
  birthDate            DateTime?
  isActive             Boolean             @default(true)
  emailVerified        Boolean             @default(false)
  lastLoginAt          DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @default(now())
  canApproveAgentTasks Boolean             @default(false)
  canExecuteAgentTasks Boolean             @default(false)
  canCreateAgents      Boolean             @default(false)
  canDeleteAgents      Boolean             @default(false)
  maxTaskPriority      String              @default("MEDIUM")
  canApproveCategories Json @default("[]")
  agendaItems          AgendaItem[]
  agentConversations   AgentConversation[]
  approvedPermissions  AgentPermission[]   @relation("ApprovedPermissions")
  instructor           Instructor?
  leadActivities       LeadActivity[]      @relation("LeadActivities")
  leadNotes            LeadNote[]          @relation("LeadNotes")
  assignedLeads        Lead[]              @relation("LeadAssignedTo")
  student              Student?
  attendanceChecks     TurmaAttendance[]   @relation("AttendanceChecker")
  turmas               Turma[]
  organization         Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Agent System Relations
  createdTasks         AgentTask[]         @relation("CreatedTasks")
  assignedTasks        AgentTask[]         @relation("AssignedTasks")
  approvedTasks        AgentTask[]         @relation("ApprovedTasks")
  executorTasks        AgentTask[]         @relation("ExecutorTasks")
  taskExecutions       TaskExecution[]     @relation("TaskExecutions")
  
  // Permission System Relations
  permissionOverrides  UserPermissionOverride[]
  createdJobs          Job[]               @relation("JobCreator")
  jobApplications      JobApplication[]
  reviewedApplications JobApplication[]    @relation("ApplicationReviewer")

  @@map("users")
}

model Student {
  id                            String                      @id @default(uuid())
  organizationId                String
  userId                        String                      @unique
  user                          User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  emergencyContact              String?
  medicalConditions             String?
  category                      StudentCategory             @default(ADULT)
  gender                        Gender?                     @default(MASCULINO)
  age                           Int?
  physicalCondition             PhysicalCondition?          @default(INICIANTE)
  specialNeeds                  Json
  totalXP                       Int                         @default(0)
  globalLevel                   Int                         @default(1)
  currentStreak                 Int                         @default(0)
  longestStreak                 Int                         @default(0)
  lastCheckinDate               DateTime?
  preferredDays                 Json
  preferredTimes                Json
  notifications                 Boolean                     @default(true)
  enrollmentDate                DateTime                    @default(now())
  isActive                      Boolean                     @default(true)
  createdAt                     DateTime                    @default(now())
  updatedAt                     DateTime                    @default(now())
  financialResponsibleId        String?
  registrationNumber            String?                     @unique
  financialResponsibleStudentId String?
  
  // Consolidated Billing Fields
  consolidatedDiscountValue     Decimal?                    @default(0)
  consolidatedDiscountType      String?                     @default("FIXED") // FIXED, PERCENTAGE

  agentConversations            AgentConversation[]
  asaasCustomer                 AsaasCustomer?
  // Portal Auth & Asaas
  passwordHash                  String?
  emailVerified                 Boolean                     @default(false)
  asaasCustomerId               String?                     @unique
  techniqueProgress             StudentTechniqueProgress[]
  assessmentAttempts            AssessmentAttempt[]
  attendancePatterns            AttendancePattern?
  attendanceRecords             AttendanceRecord[]
  attendances                   Attendance[]
  badgeUnlocks                  BadgeUnlock[]
  biometricAttempts             BiometricAttempt[]
  biometricData                 BiometricData?
  challengeProgress             ChallengeProgress[]
  enrollments                   CourseEnrollment[]
  creditRenewals                CreditRenewal[]
  creditUsages                  CreditUsage[]
  evaluationRecords             EvaluationRecord[]
  evaluations                   Evaluation[]
  feedbackActivities            FeedbackActivity[]
  feedbackLessons               FeedbackLesson[]
  convertedFromLead             Lead?                       @relation("LeadToStudent")
  activityExecutions            LessonActivityExecution[]
  payments                      Payment[]
  personalClasses               PersonalTrainingClass[]
  personalPreferences           PersonalTrainingPreference?
  physicalTestAttempts          PhysicalTestAttempt[]
  pointsTransactions            PointsTransaction[]
  progressRecords               Progress[]
  achievements                  StudentAchievement[]
  studentCourses                StudentCourse[]
  studentCredits                StudentCredit[]
  degreeHistory                 StudentDegreeHistory[]
  graduations                   StudentGraduation[]
  progressTracking              StudentProgress[]
  progressions                  StudentProgression[]
  subscriptions                 StudentSubscription[]
  turmaInterests                TurmaInterest[]           @relation("StudentTurmaInterests")
  horarioSuggestions            HorarioSugerido[]
  horarioSupports               HorarioSupporter[]        @relation("StudentHorarioSupporters")
  sessions                      StudentSession[]          @relation("StudentSessions")
  portalNotifications           StudentNotification[]     @relation("StudentNotifications")
  financialResponsible          FinancialResponsible?       @relation(fields: [financialResponsibleId], references: [id])
  financialResponsibleStudent   Student?                    @relation("FinancialDependents", fields: [financialResponsibleStudentId], references: [id])
  financialDependents           Student[]                   @relation("FinancialDependents")
  organization                  Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teacherEvaluations            TeacherEvaluation[]
  techniqueRecords              TechniqueRecord[]
  turmaAttendances              TurmaAttendance[]
  turmaStudents                 TurmaStudent[]
  jobApplications               JobApplication[]
  preEnrollments                PreEnrollment[]

  @@map("students")
}

model EducationalPlanTechniques {
  educationalPlanId String
  techniqueId       String
  order             Int       @default(0)
  notes             String?
  technique         Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@id([educationalPlanId, techniqueId])
  @@map("educational_plan_techniques")
}

model LessonPlanTechniques {
  lessonPlanId        String
  techniqueId         String
  order               Int        @default(0)
  allocationMinutes   Int        @default(0)
  objectiveMapping    Json
  expectedRepetitions Int        @default(1)
  lessonPlan          LessonPlan @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
  technique           Technique  @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@id([lessonPlanId, techniqueId])
  @@map("lesson_plan_techniques")
}

model FinancialResponsible {
  id               String                @id @default(uuid())
  organizationId   String
  name             String
  cpfCnpj          String
  email            String
  phone            String?
  birthDate        DateTime?
  address          String?
  addressNumber    String?
  complement       String?
  neighborhood     String?
  city             String?
  state            String?
  zipCode          String?
  relationshipType String?
  asaasId          String?
  isActive         Boolean               @default(true)
  consolidateBilling Boolean             @default(true)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @default(now())
  asaasCustomer    AsaasCustomer?
  organization     Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payments         Payment[]
  subscriptions    StudentSubscription[]
  students         Student[]

  @@unique([organizationId, cpfCnpj])
  @@unique([organizationId, email])
  @@map("financial_responsibles")
}

model TechniqueRecord {
  id             String               @id @default(uuid())
  studentId      String
  techniqueId    String
  lessonPlanId   String?
  proficiency    TechniqueProficiency @default(LEARNING)
  practiceCount  Int                  @default(1)
  masteryScore   Int                  @default(0)
  firstPracticed DateTime             @default(now())
  lastPracticed  DateTime             @default(now())
  masteredAt     DateTime?
  videoUrl       String?
  aiAnalysis     Json?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now())
  lessonPlan     LessonPlan?          @relation(fields: [lessonPlanId], references: [id])
  student        Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  technique      Technique            @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([studentId, techniqueId])
  @@map("technique_records")
}

model Unit {
  id               String                    @id @default(uuid())
  organizationId   String
  name             String
  description      String?
  address          String
  addressNumber    String?
  complement       String?
  neighborhood     String?
  city             String
  state            String
  zipCode          String
  phone            String?
  email            String?
  capacity         Int                       @default(100)
  totalMats        Int                       @default(1)
  responsibleName  String?
  isActive         Boolean                   @default(true)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @default(now())
  agendaItems      AgendaItem[]
  classes          Class[]
  mats             Mat[]
  personalSessions PersonalTrainingSession[]
  trainingAreas    TrainingArea[]
  turmas           Turma[]
  jobs             Job[]
  organization     Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("units")
}

model TrainingArea {
  id               String                    @id @default(uuid())
  unitId           String
  name             String
  description      String?
  capacity         Int                       @default(20)
  areaType         String
  dimensions       String?
  equipment        Json
  flooring         String?
  isActive         Boolean                   @default(true)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @default(now())
  agendaItems      AgendaItem[]
  classes          Class[]                   @relation("ClassTrainingArea")
  personalSessions PersonalTrainingSession[] @relation("PersonalSessionTrainingArea")
  unit             Unit                      @relation(fields: [unitId], references: [id], onDelete: Cascade)
  turmas           Turma[]                   @relation("TurmaTrainingArea")

  @@unique([unitId, name])
  @@map("training_areas")
}

model Mat {
  id             String       @id @default(uuid())
  organizationId String
  unitId         String
  name           String
  description    String?
  capacity       Int          @default(20)
  dimensions     String?
  equipment      Json
  materialType   String?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  classes        Class[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  unit           Unit         @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([unitId, name])
  @@map("mats")
}

model Instructor {
  id                     String                    @id @default(uuid())
  organizationId         String
  userId                 String                    @unique
  user                   User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  specializations        Json
  certifications         Json
  bio                    String?
  martialArts            Json
  maxStudentsPerClass    Int                       @default(20)
  experience             String?
  availability           Json?
  hourlyRate             Decimal?                  @db.Decimal(10, 2)
  preferredUnits         Json
  hireDate               DateTime                  @default(now())
  isActive               Boolean                   @default(true)
  createdAt              DateTime                  @default(now())
  updatedAt              DateTime                  @default(now())
  classes                Class[]
  evaluations            Evaluation[]
  instructor_courses     InstructorCourse[]
  organization           Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  activityValidations    LessonActivityExecution[] @relation("ActivityValidation")
  personalClasses        PersonalTrainingClass[]
  qualitativeAssessments QualitativeAssessment[]
  teacherEvaluations     TeacherEvaluation[]
  jobApplications        JobApplication[]

  @@map("instructors")
}

model InstructorCourse {
  id            String     @id @default(uuid())
  instructor_id String
  course_id     String
  is_lead       Boolean?   @default(false)
  certified_at  DateTime?  
  expires_at    DateTime?  
  notes         String?
  created_at    DateTime?  @default(now()) 
  updated_at    DateTime?  @default(now()) 
  courses       Course     @relation(fields: [course_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_instructor_courses_course")
  instructors   Instructor @relation(fields: [instructor_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_instructor_courses_instructor")

  @@unique([instructor_id, course_id], map: "unique_instructor_course")
  @@index([course_id], map: "idx_instructor_courses_course")
  @@index([instructor_id], map: "idx_instructor_courses_instructor")
  @@map("instructor_courses")
}

model ClassSchedule {
  id          String   @id @default(uuid())
  dayOfWeek   Int
  startTime   DateTime
  endTime     DateTime
  maxStudents Int      @default(20)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  classes     Class[]

  @@map("class_schedules")
}

model Class {
  id                   String                @id @default(uuid())
  organizationId       String
  unitId               String?
  matId                String?
  scheduleId           String?
  instructorId         String
  courseId             String
  courseProgramId      String?
  lessonPlanId         String?
  date                 DateTime
  startTime            DateTime
  endTime              DateTime
  title                String?
  description          String?
  status               ClassStatus           @default(SCHEDULED)
  actualStudents       Int                   @default(0)
  maxStudents          Int                   @default(20)
  agenda               Json?
  notes                String?
  qrCode               String?               @unique
  qrCodeExpiry         DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @default(now())
  location             String?
  trainingAreaId       String?
  assessmentAttempts   AssessmentAttempt[]
  attendanceRecords    AttendanceRecord[]
  attendances          Attendance[]
  activities           ClassActivity[]
  course               Course                @relation(fields: [courseId], references: [id])
  courseProgram        CourseProgram?        @relation(fields: [courseProgramId], references: [id])
  instructor           Instructor            @relation(fields: [instructorId], references: [id])
  lessonPlan           LessonPlan?           @relation(fields: [lessonPlanId], references: [id])
  mat                  Mat?                  @relation(fields: [matId], references: [id])
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  schedule             ClassSchedule?        @relation(fields: [scheduleId], references: [id])
  trainingArea         TrainingArea?         @relation("ClassTrainingArea", fields: [trainingAreaId], references: [id])
  unit                 Unit?                 @relation(fields: [unitId], references: [id])
  feedbackLessons      FeedbackLesson[]
  physicalTestAttempts PhysicalTestAttempt[]
  studentCourses       StudentCourse[]
  teacherEvaluations   TeacherEvaluation[]

  @@map("classes")
}

model Attendance {
  id             String           @id @default(uuid())
  organizationId String
  studentId      String
  classId        String
  status         AttendanceStatus @default(PRESENT)
  checkInTime    DateTime?
  checkInMethod  CheckInMethod?
  location       String?
  notes          String?
  xpEarned       Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now())
  class          Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student        Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  creditUsages   CreditUsage[]

  @@unique([studentId, classId])
  @@map("attendances")
}

model CourseEnrollment {
  id                String              @id @default(uuid())
  studentId         String
  courseId          String
  enrolledAt        DateTime            @default(now())
  completedAt       DateTime?
  expectedEndDate   DateTime
  status            EnrollmentStatus    @default(ACTIVE)
  category          StudentCategory     @default(ADULT)
  gender            String
  currentLesson     Int                 @default(1)
  lessonsCompleted  Int                 @default(0)
  attendanceRate    Float               @default(0)
  currentXP         Int                 @default(0)
  currentLevel      Int                 @default(1)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @default(now())
  challengeProgress ChallengeProgress[]
  course            Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student           Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  evaluations       Evaluation[]
  techniqueProgress TechniqueProgress[]

  @@unique([studentId, courseId])
  @@map("course_enrollments")
}

model TechniqueProgress {
  id                  String               @id @default(uuid())
  enrollmentId        String
  techniqueId         String
  status              TechniqueProficiency @default(LEARNING)
  accuracy            Float?
  attempts            Int                  @default(0)
  practiceCount       Int                  @default(0)
  masteredAt          DateTime?
  videoUrl            String?
  aiAnalysis          Json?
  instructorValidated Boolean              @default(false)
  validatedBy         String?
  validatedAt         DateTime?
  instructorNotes     String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now())
  enrollment          CourseEnrollment     @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  technique           Technique            @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, techniqueId])
  @@map("technique_progress")
}

model CourseChallenge {
  id                String              @id @default(uuid())
  courseId          String
  weekNumber        Int
  type              ChallengeType
  baseActivity      String
  baseMetric        Int
  baseTime          Int?
  description       String?
  xpReward          Int                 @default(15)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @default(now())
  challengeProgress ChallengeProgress[]
  course            Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, weekNumber])
  @@map("course_challenges")
}

model ChallengeProgress {
  id                  String           @id @default(uuid())
  studentId           String
  enrollmentId        String
  challengeId         String
  attempted           Boolean          @default(false)
  completed           Boolean          @default(false)
  actualMetric        Int?
  actualTime          Int?
  videoUrl            String?
  imageUrl            String?
  instructorValidated Boolean          @default(false)
  validatedBy         String?
  validatedAt         DateTime?
  instructorNotes     String?
  xpEarned            Int              @default(0)
  completedAt         DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @default(now())
  challenge           CourseChallenge  @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  enrollment          CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  student             Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, challengeId])
  @@map("challenge_progress")
}

model Evaluation {
  id                 String           @id @default(uuid())
  studentId          String
  instructorId       String
  enrollmentId       String
  type               EvaluationType
  lessonNumber       Int
  techniquesTested   Json
  physicalTest       Json?
  overallScore       Float
  passed             Boolean          @default(false)
  instructorNotes    String?
  videoUrl           String?
  recommendedActions Json
  evaluatedBy        String
  evaluatedAt         DateTime         @default(now())
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @default(now())
  enrollment         CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  instructor         Instructor       @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  student            Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("evaluations")
}

model StudentProgression {
  id                   String     @id @default(uuid())
  studentId            String
  martialArtId         String
  currentLevel         Int        @default(1)
  currentGrade         String     @default("White Belt")
  totalXP              Int        @default(0)
  techniquesLearned    Int        @default(0)
  techniquesTotal      Int        @default(0)
  classesAttended      Int        @default(0)
  evaluationsCompleted Int        @default(0)
  nextGrade            String?
  progressToNextGrade  Float      @default(0)
  estimatedTimeToNext  String?
  lastUpdated          DateTime   @default(now())
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @default(now())
  martialArt           MartialArt @relation(fields: [martialArtId], references: [id], onDelete: Cascade)
  student              Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, martialArtId])
  @@map("student_progressions")
}

model Achievement {
  id                  String               @id @default(uuid())
  organizationId      String
  martialArtId        String?
  name                String
  description         String
  category            AchievementCategory
  criteria            Json
  xpReward            Int                  @default(0)
  badgeImageUrl       String?
  rarity              AchievementRarity    @default(COMMON)
  isHidden            Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now())
  martialArt          MartialArt?          @relation(fields: [martialArtId], references: [id])
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  studentAchievements StudentAchievement[]

  @@map("achievements")
}

model StudentAchievement {
  id            String      @id @default(uuid())
  studentId     String
  achievementId String
  unlockedAt    DateTime    @default(now())
  progress      Float       @default(100)
  createdAt     DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  student       Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, achievementId])
  @@map("student_achievements")
}

model Challenge {
  id             String              @id @default(uuid())
  organizationId String
  title          String
  description    String
  type           ChallengeType
  difficulty     ChallengeDifficulty @default(EASY)
  startDate      DateTime
  endDate        DateTime
  isRecurring    Boolean             @default(false)
  recurringType  RecurringType?
  xpReward       Int                 @default(0)
  badgeReward    String?
  criteria       Json
  targetValue    Int                 @default(1)
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now())
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("challenges")
}

model StudentCourse {
  id              String           @id @default(uuid())
  studentId       String
  courseId        String
  classId         String?
  paymentPlanId   String?
  startDate       DateTime         @default(now())
  expectedEndDate DateTime?
  completedDate   DateTime?
  status          EnrollmentStatus @default(ACTIVE)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @default(now())
  class           Class?           @relation(fields: [classId], references: [id], onDelete: Cascade)
  course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  paymentPlan     BillingPlan?     @relation("BillingPlanStudentCourses", fields: [paymentPlanId], references: [id])
  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@map("student_courses")
}

model AttendanceRecord {
  id           String   @id @default(uuid())
  studentId    String
  classId      String
  courseId     String
  lessonNumber Int
  date         DateTime
  present      Boolean  @default(false)
  arrived_late Boolean  @default(false)
  left_early   Boolean  @default(false)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())
  class        Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, lessonNumber])
  @@map("attendance_records")
}

model Progress {
  id                  String   @id @default(uuid())
  studentId           String
  courseId            String
  lessonNumber        Int
  techniquesLearned   Json
  challengesCompleted Json
  points              Int      @default(0)
  reflections         String?
  progressDate        DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @default(now())
  course              Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student             Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, lessonNumber])
  @@map("progress_records")
}

model TechniqueDetail {
  id            String            @id @default(uuid())
  courseId      String
  name          String
  description   String?
  category      TechniqueCategory
  lessonNumber  Int
  instructions  Json
  objectives    Json
  adaptations   Json?
  orderInLesson Int               @default(1)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now())
  course        Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, lessonNumber, orderInLesson])
  @@map("technique_details")
}

model WeeklyChallenge {
  id              String   @id @default(uuid())
  courseId        String
  weekNumber      Int
  name            String
  description     String
  baseRepetitions Json
  baseTime        Int?
  pointsReward    Int      @default(15)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now())
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, weekNumber])
  @@map("weekly_challenges")
}

model EvaluationRecord {
  id                  String           @id @default(uuid())
  studentId           String
  courseId            String
  lessonNumber        Int
  techniquesEvaluated Json
  physicalTest        String?
  physicalTestResult  String?
  simulationScenarios Json
  simulationResults   Json
  precision           Float?
  status              EvaluationStatus
  certificateIssued   Boolean          @default(false)
  certificateUrl      String?
  instructorNotes     String?
  evaluationDate      DateTime         @default(now())
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @default(now())
  course              Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student             Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, lessonNumber])
  @@map("evaluation_records")
}

model AttendancePattern {
  id                  String          @id @default(uuid())
  studentId           String          @unique
  totalClasses        Int             @default(0)
  attendedClasses     Int             @default(0)
  attendanceRate      Float           @default(0)
  consecutiveAbsences Int             @default(0)
  averageCheckInTime  String?
  preferredDays       Json
  preferredTimeSlots  Json
  recentTrend         AttendanceTrend @default(STABLE)
  trendConfidence     Float           @default(0)
  dropoutRisk         DropoutRisk     @default(LOW)
  riskFactors         Json
  recommendations     Json
  aiInsights          Json?
  lastAnalyzed        DateTime        @default(now())
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @default(now())
  student             Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("attendance_patterns")
}

model AsaasCustomer {
  id                     String                @id @default(uuid())
  organizationId         String
  studentId              String?               @unique
  financialResponsibleId String?               @unique
  asaasId                String                @unique
  name                   String
  cpfCnpj                String?
  email                  String?
  phone                  String?
  mobilePhone            String?
  postalCode             String?
  address                String?
  addressNumber          String?
  complement             String?
  province               String?
  city                   String?
  state                  String?
  externalReference      String?
  isActive               Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student                Student?              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payments               Payment[]
  subscriptions          StudentSubscription[]

  @@map("asaas_customers")
}

model BillingPlan {
  id                      String                @id @default(uuid())
  organizationId          String
  courseId                String?
  name                    String
  description             String?
  category                StudentCategory?
  price                   Decimal               @db.Decimal(10, 2)
  billingType             BillingType           @default(MONTHLY)
  classesPerWeek          Int?                  @default(2)
  maxClasses              Int?
  duration                Int?
  isUnlimitedAccess       Boolean               @default(false)
  hasPersonalTraining     Boolean               @default(false)
  hasNutrition            Boolean               @default(false)
  allowInstallments       Boolean               @default(false)
  maxInstallments         Int                   @default(1)
  installmentInterestRate Decimal?              @db.Decimal(5, 2)
  isRecurring             Boolean               @default(false)
  recurringInterval       Int?
  recurrencePeriod        RecurrencePeriod?
  accessAllModalities     Boolean               @default(false)
  allowFreeze             Boolean               @default(true)
  freezeMaxDays           Int                   @default(30)
  features                Json?
  paymentDiscounts        Json?                 // Configurao de descontos por mtodo de pagamento
  isActive                Boolean               @default(true)
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @default(now())
  creditsValidity         Int?
  pricePerClass           Decimal?              @db.Decimal(10, 2)
  allowPartialCredit      Boolean?              @default(false)
  allowRefund             Boolean?              @default(false)
  allowTransfer           Boolean?              @default(false)
  autoRenewChargeMethod   String?
  autoRenewCredits        Boolean?              @default(false)
  bulkDiscountTiers       Json?
  creditQuantity          Int?
  creditRenewalMethod     CreditRenewalMethod?  @default(INCLUDED)
  creditRenewalTrigger    CreditRenewalTrigger? @default(MONTHLY)
  creditType              CreditType?
  creditValidityDays      Int?                  @default(90)
  maxAutoRenewals         Int?
  minCreditsPerClass      Int?                  @default(1)
  planType                PlanType?
  refundDaysBeforeExp     Int?                  @default(7)
  renewalIntervalDays     Int?
  transferFeePercent      Decimal?              @db.Decimal(5, 2)
  course                  Course?               @relation("BillingPlanPrimaryCourse", fields: [courseId], references: [id])
  organization            Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planCourses             PlanCourse[]          @relation("PlanCourseToPlan")
  studentCourses          StudentCourse[]       @relation("BillingPlanStudentCourses")
  studentCredits          StudentCredit[]       @relation("BillingPlanCredits")
  subscriptions           StudentSubscription[] @relation("BillingPlanSubscriptions")
  discounts               BillingPlanDiscount[]
  preEnrollments          PreEnrollment[]
  enrollmentLinks         EnrollmentLink[]

  @@map("billing_plans")
}

model Discount {
  id              String          @id @default(uuid())
  organizationId  String
  name            String
  description     String?
  type            DiscountType    @default(PERCENTAGE)
  value           Decimal         @db.Decimal(10, 2)
  triggerType     DiscountTrigger @default(MANUAL)
  triggerValue    String?         // e.g. "PIX", "BLACKFRIDAY2025"
  startDate       DateTime?
  endDate         DateTime?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plans           BillingPlanDiscount[]

  @@map("discounts")
}

model BillingPlanDiscount {
  id              String      @id @default(uuid())
  planId          String
  discountId      String
  createdAt       DateTime    @default(now())

  plan            BillingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  discount        Discount    @relation(fields: [discountId], references: [id], onDelete: Cascade)

  @@unique([planId, discountId])
  @@map("billing_plan_discounts")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum DiscountTrigger {
  MANUAL
  PAYMENT_METHOD
  COUPON
  CAMPAIGN
}

model StudentSubscription {
  id                     String                @id @default(uuid())
  organizationId         String
  studentId              String
  planId                 String
  asaasCustomerId        String?
  financialResponsibleId String?
  status                 SubscriptionStatus    @default(ACTIVE)
  startDate              DateTime              @default(now())
  endDate                DateTime?
  currentPrice           Decimal               @db.Decimal(10, 2)
  billingType            BillingType
  nextBillingDate        DateTime?
  asaasSubscriptionId    String?
  isActive               Boolean               @default(true)
  autoRenew              Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  payments               Payment[]
  StudentCredit          StudentCredit[]
  asaasCustomer          AsaasCustomer?        @relation(fields: [asaasCustomerId], references: [id])
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan                   BillingPlan           @relation("BillingPlanSubscriptions", fields: [planId], references: [id])
  student                Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("student_subscriptions")
}

model Payment {
  id                     String                @id @default(uuid())
  organizationId         String
  studentId              String
  subscriptionId         String?
  asaasCustomerId        String?
  financialResponsibleId String?
  amount                 Decimal               @db.Decimal(10, 2)
  description            String
  dueDate                DateTime
  paidDate               DateTime?
  status                 PaymentStatus         @default(PENDING)
  paymentMethod          PaymentMethod?
  asaasPaymentId         String?               @unique
  asaasChargeId          String?               @unique
  asaasInvoiceUrl        String?
  asaasPixCode           String?
  asaasPixQrCode         String?
  asaasBoletoUrl         String?
  asaasBoletoCode        String?
  asaasChargeUrl         String?
  pixCode                String?
  webhookData            Json?
  notes                  String?
  isManual               Boolean               @default(false)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  asaasCustomer          AsaasCustomer?        @relation(fields: [asaasCustomerId], references: [id])
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student                Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subscription           StudentSubscription?  @relation(fields: [subscriptionId], references: [id])

  @@map("payments")
}

model FinancialSettings {
  id                 String       @id @default(uuid())
  organizationId     String       @unique
  asaasApiKey        String?
  asaasWebhookUrl    String?
  asaasWebhookToken  String?
  isSandbox          Boolean      @default(true)
  defaultBillingType BillingType  @default(MONTHLY)
  lateFeePercentage  Decimal      @default(2.0) @db.Decimal(5, 2)
  interestRate       Decimal      @default(1.0) @db.Decimal(5, 2)
  sendReminders      Boolean      @default(true)
  reminderDaysBefore Int          @default(3)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @default(now())
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("financial_settings")
}

model StudentCredit {
  id               String               @id @default(uuid())
  organizationId   String
  studentId        String
  planId           String
  subscriptionId   String?
  totalCredits     Int
  creditsUsed      Int                  @default(0)
  creditsAvailable Int
  creditType       CreditType
  purchasedAt      DateTime             @default(now())
  expiresAt        DateTime?
  status           String               @default("ACTIVE")
  notes            String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @default(now())
  autoRenew        Boolean              @default(false)
  nextRenewalDate  DateTime?
  previousCreditId String?
  renewalChargeId  String?
  renewalCount     Int                  @default(0)
  usages           CreditUsage[]        @relation("StudentCreditUsages")
  organization     Organization         @relation("StudentCreditsOrganization", fields: [organizationId], references: [id], onDelete: Cascade)
  plan             BillingPlan          @relation("BillingPlanCredits", fields: [planId], references: [id])
  previousCredit   StudentCredit?       @relation("CreditRenewal", fields: [previousCreditId], references: [id])
  renewedCredits   StudentCredit[]      @relation("CreditRenewal")
  student          Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subscription     StudentSubscription? @relation(fields: [subscriptionId], references: [id])

  @@index([studentId, status])
  @@index([expiresAt])
  @@index([organizationId])
  @@map("student_credits")
}

model CreditUsage {
  id             String        @id @default(uuid())
  organizationId String
  studentId      String
  creditId       String
  attendanceId   String?
  creditsUsed    Int
  usedAt         DateTime      @default(now())
  description    String?
  createdAt      DateTime      @default(now())
  attendance     Attendance?   @relation(fields: [attendanceId], references: [id])
  credit         StudentCredit @relation("StudentCreditUsages", fields: [creditId], references: [id], onDelete: Cascade)
  organization   Organization  @relation("CreditUsageOrganization", fields: [organizationId], references: [id], onDelete: Cascade)
  student        Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([creditId])
  @@index([attendanceId])
  @@index([usedAt])
  @@map("credit_usages")
}

model CreditRenewal {
  id               String       @id @default(uuid())
  organizationId   String
  studentId        String
  originalCreditId String
  renewedCreditId  String
  renewalDate      DateTime     @default(now())
  renewalReason    String?
  chargedAmount    Decimal?     @db.Decimal(10, 2)
  chargeMethod     String?
  chargeId         String?
  notes            String?
  createdAt        DateTime     @default(now())
  organization     Organization @relation("CreditRenewalOrganization", fields: [organizationId], references: [id], onDelete: Cascade)
  student          Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, renewalDate])
  @@index([organizationId])
  @@map("credit_renewals")
}

model PlanCourse {
  planId    String
  courseId  String
  createdAt DateTime    @default(now())
  course    Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  plan      BillingPlan @relation("PlanCourseToPlan", fields: [planId], references: [id], onDelete: Cascade)

  @@id([planId, courseId])
  @@map("plan_courses")
}

model TechniquePrerequisite {
  techniqueId             String
  prerequisiteTechniqueId String
  createdAt               DateTime  @default(now())
  prerequisite            Technique @relation("TechniquePrerequisitesPrerequisite", fields: [prerequisiteTechniqueId], references: [id], onDelete: Cascade)
  technique               Technique @relation("TechniquePrerequisitesTechnique", fields: [techniqueId], references: [id], onDelete: Cascade)

  @@id([techniqueId, prerequisiteTechniqueId])
  @@map("technique_prerequisite")
}

model MentalModule {
  id               String   @id @default(uuid())
  name             String   @unique
  objective        String
  recommendedPhase String?
  durationMin      Int?
  tags             Json
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now())

  @@map("mental_modules")
}

model AdaptationSnippet {
  id          String   @id @default(uuid())
  audienceTag String
  text        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@index([audienceTag])
  @@map("adaptation_snippets")
}

model RagChunk {
  id             String        @id @default(uuid())
  organizationId String?
  type           String
  sourceType     String?
  sourceId       String?
  version        Int           @default(1)
  lang           String        @default("pt-BR")
  tags           Json
  text           String
  hash           String        @unique
  embedding      Bytes?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now())
  embeddings     RagEmbedding?

  @@index([organizationId, type])
  @@index([type, version])
  @@map("rag_chunks")
}

model RagEmbedding {
  id           String   @id @default(uuid())
  chunkId      String   @unique
  provider     String
  modelVersion String
  dim          Int
  createdAt    DateTime @default(now())
  chunk        RagChunk @relation(fields: [chunkId], references: [id], onDelete: Cascade)

  @@map("rag_embeddings")
}

model Activity {
  id              String               @id @default(uuid())
  organizationId  String
  type            ActivityType
  title           String
  description     String?
  equipment       Json @default("[]")
  safety          String?
  adaptations     Json @default("[]")
  difficulty      Int?
  refTechniqueId  String?
  defaultParams   Json?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @default(now())
  categoryId      String?
  category        ActivityCategory?    @relation(fields: [categoryId], references: [id])
  organization    Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  refTechnique    Technique?           @relation("ActivityTechniqueRef", fields: [refTechniqueId], references: [id], onDelete: Cascade)
  classItems      ClassActivity[]
  lessonPlanItems LessonPlanActivity[]

  @@map("activities")
}

model LessonPlanActivity {
  id                   String                    @id @default(uuid())
  lessonPlanId         String
  activityId           String
  segment              LessonSegment
  ord                  Int                       @default(1)
  params               Json?
  objectives           String?
  safetyNotes          String?
  adaptations          String?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @default(now())
  intensityMultiplier  Float                     @default(1.0)
  minimumForGraduation Int?
  repetitionsPerClass  Int                       @default(1)
  executions           LessonActivityExecution[]
  activity             Activity                  @relation(fields: [activityId], references: [id], onDelete: Cascade)
  lessonPlan           LessonPlan                @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)

  @@unique([lessonPlanId, ord])
  @@map("lesson_plan_activities")
}

model ClassActivity {
  id              String             @id @default(uuid())
  classId         String
  activityId      String
  segment         LessonSegment
  ord             Int                @default(1)
  paramsUsed      Json?
  completed       Boolean            @default(false)
  adaptationsUsed String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @default(now())
  activity        Activity           @relation(fields: [activityId], references: [id], onDelete: Cascade)
  class           Class              @relation(fields: [classId], references: [id], onDelete: Cascade)
  feedbacks       FeedbackActivity[]

  @@unique([classId, ord])
  @@map("class_activities")
}

model Rubric {
  id          String                 @id @default(uuid())
  name        String
  minScore    Int                    @default(0)
  maxScore    Int                    @default(100)
  assessments AssessmentDefinition[]
  criteria    RubricCriterion[]

  @@map("rubrics")
}

model RubricCriterion {
  id          String  @id @default(uuid())
  rubricId    String
  name        String
  description String?
  weight      Int     @default(1)
  rubric      Rubric  @relation(fields: [rubricId], references: [id], onDelete: Cascade)

  @@map("rubric_criteria")
}

model AssessmentDefinition {
  id       String              @id @default(uuid())
  courseId String
  name     String
  type     AssessmentType
  when     String?
  rubricId String?
  attempts AssessmentAttempt[]
  course   Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  rubric   Rubric?             @relation(fields: [rubricId], references: [id], onDelete: Cascade)

  @@map("assessment_definitions")
}

model AssessmentAttempt {
  id           String               @id @default(uuid())
  assessmentId String
  studentId    String
  classId      String?
  evaluatorId  String?
  startedAt    DateTime?
  completedAt  DateTime?
  scoreTotal   Int?
  details      Json?
  assessment   AssessmentDefinition @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  class        Class?               @relation(fields: [classId], references: [id])
  student      Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("assessment_attempts")
}

model PhysicalTestDefinition {
  id            String                @id @default(uuid())
  name          String
  metric        Metric
  targetValue   Float?
  passThreshold Float?
  attempts      PhysicalTestAttempt[]

  @@map("physical_test_definitions")
}

model PhysicalTestAttempt {
  id        String                 @id @default(uuid())
  testId    String
  studentId String
  classId   String?
  value     Float
  passed    Boolean?
  comment   String?
  class     Class?                 @relation(fields: [classId], references: [id])
  student   Student                @relation(fields: [studentId], references: [id], onDelete: Cascade)
  test      PhysicalTestDefinition @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@map("physical_test_attempts")
}

model FeedbackLesson {
  id        String   @id @default(uuid())
  classId   String
  studentId String
  rating    Int
  mood      String?
  comment   String?
  createdAt DateTime @default(now())
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@map("feedback_lessons")
}

model FeedbackActivity {
  id                  String        @id @default(uuid())
  classActivityId     String
  studentId           String
  rating              Int
  perceivedDifficulty Int?
  comment             String?
  createdAt           DateTime      @default(now())
  classActivity       ClassActivity @relation(fields: [classActivityId], references: [id], onDelete: Cascade)
  student             Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classActivityId, studentId])
  @@map("feedback_activities")
}

model TeacherEvaluation {
  id           String     @id @default(uuid())
  classId      String?
  courseId     String?
  studentId    String
  instructorId String
  rating       Int
  criteria     Json?
  comment      String?
  createdAt    DateTime   @default(now())
  class        Class?     @relation(fields: [classId], references: [id])
  course       Course?    @relation(fields: [courseId], references: [id])
  instructor   Instructor @relation(fields: [instructorId], references: [id])
  student      Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("teacher_evaluations")
}

model Badge {
  id             String        @id @default(uuid())
  organizationId String
  name           String
  criteria       Json?
  iconUrl        String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now())
  unlocks        BadgeUnlock[]
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("badges")
}

model BadgeUnlock {
  id         String   @id @default(uuid())
  badgeId    String
  studentId  String
  unlockedAt DateTime @default(now())
  reason     String?
  badge      Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([badgeId, studentId])
  @@map("badge_unlocks")
}

model PointsTransaction {
  id         String   @id @default(uuid())
  studentId  String
  amount     Int
  source     String
  refType    String?
  refId      String?
  occurredAt DateTime @default(now())
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("points_transactions")
}

model Turma {
  id                           String            @id @default(uuid())
  organizationId               String
  courseId                     String
  name                         String
  description                  String?
  classType                    ClassType         @default(COLLECTIVE)
  status                       TurmaStatus       @default(SCHEDULED)
  instructorId                 String
  maxStudents                  Int               @default(20)
  startDate                    DateTime
  endDate                      DateTime?
  schedule                     Json
  unitId                       String?
  room                         String?
  price                        Decimal?          @db.Decimal(10, 2)
  isActive                     Boolean           @default(true)
  inactiveReason               String?
  minimumStudents              Int               @default(5)
  activationDate               DateTime?
  createdAt                    DateTime          @default(now())
  updatedAt                    DateTime          @default(now())
  trainingAreaId               String?
  requireAttendanceForProgress Boolean           @default(false)
  attendances                  TurmaAttendance[]
  courses                      TurmaCourse[]
  lessons                      TurmaLesson[]
  students                     TurmaStudent[]
  interests                    TurmaInterest[]   @relation("TurmaInterests")
  createdFromSuggestion        HorarioSugerido[] @relation("CreatedFromSuggestion")
  course                       Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  instructor                   User              @relation(fields: [instructorId], references: [id])
  organization                 Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  trainingArea                 TrainingArea?     @relation("TurmaTrainingArea", fields: [trainingAreaId], references: [id])
  unit                         Unit?             @relation(fields: [unitId], references: [id])

  @@map("turmas")
}

model TurmaInterest {
  id        String   @id @default(uuid())
  turmaId   String
  studentId String
  createdAt DateTime @default(now())
  notified  Boolean  @default(false)

  turma   Turma   @relation("TurmaInterests", fields: [turmaId], references: [id], onDelete: Cascade)
  student Student @relation("StudentTurmaInterests", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([turmaId, studentId])
  @@map("turma_interests")
}

model HorarioSugerido {
  id              String          @id @default(uuid())
  studentId       String
  organizationId  String
  
  // Dados da sugesto
  dayOfWeek       Int             // 0-6 (domingo a sbado)
  startTime       String          // "19:00"
  endTime         String          // "20:30"
  courseType      String?         // "DEFESA_PESSOAL", "COMBATE", etc.
  level           String?         // "INICIANTE", "INTERMEDIARIO", "AVANCADO"
  preferredUnit   String?         // ID da unidade preferida
  notes           String?         // Observaes do aluno
  
  // Controle
  status          String          @default("PENDING") // PENDING, APPROVED, REJECTED, FULFILLED
  votes           Int             @default(1)         // Outros alunos podem "votar"
  createdAt       DateTime        @default(now())
  reviewedAt      DateTime?
  reviewedBy      String?         // ID do admin que revisou
  createdTurmaId  String?         // ID da turma criada (se aprovada)
  
  // Relaes
  student         Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  supporters      HorarioSupporter[] @relation("HorarioSupporters")
  createdTurma    Turma?          @relation("CreatedFromSuggestion", fields: [createdTurmaId], references: [id])
  
  @@index([organizationId, status])
  @@index([dayOfWeek, startTime])
  @@map("horarios_sugeridos")
}

model HorarioSupporter {
  id              String          @id @default(uuid())
  horarioId       String
  studentId       String
  createdAt       DateTime        @default(now())
  
  horario         HorarioSugerido @relation("HorarioSupporters", fields: [horarioId], references: [id], onDelete: Cascade)
  student         Student         @relation("StudentHorarioSupporters", fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([horarioId, studentId])
  @@map("horario_supporters")
}

model TurmaLesson {
  id                 String                    @id @default(uuid())
  turmaId            String
  lessonPlanId       String?
  lessonNumber       Int
  title              String
  scheduledDate      DateTime
  actualDate         DateTime?
  status             TurmaStatus               @default(SCHEDULED)
  duration           Int                       @default(60)
  notes              String?
  materials          Json @default("[]")
  objectives         Json @default("[]")
  techniques         Json?
  isActive           Boolean                   @default(true)
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @default(now())
  activityExecutions LessonActivityExecution[]
  attendances        TurmaAttendance[]
  lessonPlan         LessonPlan?               @relation(fields: [lessonPlanId], references: [id])
  turma              Turma                     @relation(fields: [turmaId], references: [id], onDelete: Cascade)

  @@unique([turmaId, lessonNumber])
  @@map("turma_lessons")
}

model TurmaStudent {
  id            String            @id @default(uuid())
  turmaId       String
  studentId     String
  enrolledAt    DateTime          @default(now())
  status        String            @default("ACTIVE")
  paymentStatus String            @default("PENDING")
  notes         String?
  isActive      Boolean           @default(true)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now())
  attendances   TurmaAttendance[]
  student       Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  turma         Turma             @relation(fields: [turmaId], references: [id], onDelete: Cascade)

  @@unique([turmaId, studentId])
  @@map("turma_students")
}

model TurmaAttendance {
  id                 String                    @id @default(uuid())
  turmaId            String
  turmaLessonId      String
  turmaStudentId     String
  studentId          String
  present            Boolean                   @default(false)
  late               Boolean                   @default(false)
  justified          Boolean                   @default(false)
  notes              String?
  checkedAt          DateTime?
  checkedBy          String?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @default(now())
  activityExecutions LessonActivityExecution[]
  checker            User?                     @relation("AttendanceChecker", fields: [checkedBy], references: [id])
  student            Student                   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  turma              Turma                     @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  lesson             TurmaLesson               @relation(fields: [turmaLessonId], references: [id], onDelete: Cascade)
  turmaStudent       TurmaStudent              @relation(fields: [turmaStudentId], references: [id], onDelete: Cascade)

  @@unique([turmaLessonId, studentId])
  @@map("turma_attendances")
}

/// Configuraes de rastreamento de atividades por organizao
/// Define se a validao  automtica (no check-in) ou manual (pelo professor)
model ActivityTrackingSettings {
  id                          String       @id @default(uuid())
  organizationId              String       @unique
  autoCompleteOnCheckin       Boolean      @default(false)
  requireInstructorValidation Boolean      @default(true)
  enablePerformanceRating     Boolean      @default(true)
  enableVideos                Boolean      @default(false)
  defaultActivityDuration     Int          @default(15)
  createdAt                   DateTime     @default(now())
  updatedAt                   DateTime     @default(now())
  organization                Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("activity_tracking_settings")
}

model TurmaCourse {
  id        String   @id @default(cuid())
  turmaId   String
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  turma     Turma    @relation(fields: [turmaId], references: [id], onDelete: Cascade)

  @@unique([turmaId, courseId])
  @@map("turma_courses")
}

model PersonalTrainingClass {
  id             String                    @id @default(uuid())
  organizationId String
  studentId      String
  instructorId   String
  title          String
  description    String?
  focusAreas     Json
  trainingType   PersonalTrainingType      @default(INDIVIDUAL)
  intensity      String                    @default("Intermedirio")
  duration       Int                       @default(60)
  location       String?
  notes          String?
  status         PersonalClassStatus       @default(ACTIVE)
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @default(now())
  instructor     Instructor                @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  organization   Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student        Student                   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  sessions       PersonalTrainingSession[]

  @@map("personal_training_classes")
}

model PersonalTrainingSession {
  id                   String                @id @default(uuid())
  personalClassId      String
  date                 DateTime
  startTime            DateTime
  endTime              DateTime
  actualDuration       Int?
  status               SessionStatus         @default(SCHEDULED)
  attendanceConfirmed  Boolean               @default(false)
  studentNotes         String?
  instructorNotes      String?
  rating               Int?
  feedback             String?
  location             String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @default(now())
  courseId             String?
  lessonContent        Json?
  lessonPlanId         String?
  nextLessonSuggestion String?
  progressNotes        String?
  trainingAreaId       String?
  unitId               String?
  course               Course?               @relation(fields: [courseId], references: [id])
  lessonPlan           LessonPlan?           @relation(fields: [lessonPlanId], references: [id])
  personalClass        PersonalTrainingClass @relation(fields: [personalClassId], references: [id], onDelete: Cascade)
  trainingArea         TrainingArea?         @relation("PersonalSessionTrainingArea", fields: [trainingAreaId], references: [id])
  unit                 Unit?                 @relation(fields: [unitId], references: [id])

  @@map("personal_training_sessions")
}

model PersonalTrainingPreference {
  id                   String   @id @default(uuid())
  studentId            String   @unique
  preferredDays        Json
  preferredTimes       Json
  preferredInstructors Json
  trainingFocus        Json
  intensity            String   @default("Intermedirio")
  sessionDuration      Int      @default(60)
  maxSessionsPerWeek   Int      @default(2)
  notes                String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  student              Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("personal_training_preferences")
}

model AgendaItem {
  id             String           @id @default(uuid())
  organizationId String
  type           AgendaItemType
  referenceId    String
  title          String
  description    String?
  startTime      DateTime
  endTime        DateTime
  instructorId   String
  unitId         String?
  trainingAreaId String?
  status         AgendaItemStatus @default(SCHEDULED)
  maxStudents    Int?
  actualStudents Int              @default(0)
  isRecurring    Boolean          @default(false)
  recurrenceRule String?
  color          String?
  notes          String?
  isVirtual      Boolean          @default(false)
  meetingUrl     String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now())
  instructor     User             @relation(fields: [instructorId], references: [id])
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  trainingArea   TrainingArea?    @relation(fields: [trainingAreaId], references: [id])
  unit           Unit?            @relation(fields: [unitId], references: [id])

  @@map("agenda_items")
}

model Lead {
  id                  String          @id @default(uuid())
  organizationId      String
  name                String
  email               String
  phone               String?
  cpf                 String?
  birthDate           DateTime?
  sourceCampaign      String?
  sourceAdGroup       String?
  sourceKeyword       String?
  gclid               String?         @unique
  landingPage         String?
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?
  utmContent          String?
  utmTerm             String?
  referrer            String?
  deviceType          String?
  browserInfo         String?
  stage               LeadStage       @default(NEW)
  status              LeadStatus      @default(ACTIVE)
  assignedToId        String?
  temperature         LeadTemperature @default(COLD)
  priority            Int             @default(0)
  courseInterest      String?
  billingPlanInterest String?
  modalityInterest    String?
  preferredSchedule   String?
  budget              Decimal?        @db.Decimal(10, 2)
  message             String?
  leadCreatedAt       DateTime        @default(now())
  firstContactAt      DateTime?
  qualifiedAt         DateTime?
  trialScheduledAt    DateTime?
  trialAttendedAt     DateTime?
  enrolledAt          DateTime?
  convertedStudentId  String?         @unique
  conversionUploaded  Boolean         @default(false)
  lostAt              DateTime?
  lostReason          String?
  timeToContact       Int?
  timeToQualify       Int?
  timeToTrial         Int?
  timeToEnrollment    Int?
  costPerClick        Decimal?        @db.Decimal(10, 2)
  costPerLead         Decimal?        @db.Decimal(10, 2)
  costPerAcquisition  Decimal?        @db.Decimal(10, 2)
  estimatedLTV        Decimal?        @db.Decimal(10, 2)
  actualRevenue       Decimal?        @db.Decimal(10, 2)
  tags                Json
  customFields        Json?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @default(now())
  activities          LeadActivity[]
  notes               LeadNote[]
  assignedTo          User?           @relation("LeadAssignedTo", fields: [assignedToId], references: [id])
  convertedStudent    Student?        @relation("LeadToStudent", fields: [convertedStudentId], references: [id])
  organization        Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, stage, status])
  @@index([gclid])
  @@index([email])
  @@index([assignedToId])
  @@map("leads")
}

model LeadActivity {
  id           String           @id @default(uuid())
  leadId       String
  userId       String
  type         LeadActivityType
  title        String
  description  String?
  outcome      String?
  nextAction   String?
  scheduledFor DateTime?
  completedAt  DateTime?
  duration     Int?
  attachments  Json?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now())
  lead         Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user         User             @relation("LeadActivities", fields: [userId], references: [id])

  @@index([leadId, createdAt])
  @@map("lead_activities")
}

model LeadNote {
  id        String   @id @default(uuid())
  leadId    String
  userId    String
  content   String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User     @relation("LeadNotes", fields: [userId], references: [id])

  @@index([leadId, createdAt])
  @@map("lead_notes")
}

model GoogleAdsCampaign {
  id                String             @id @default(uuid())
  organizationId    String
  campaignId        String             @unique
  campaignName      String
  campaignStatus    String
  campaignType      String?
  budget            Decimal?           @db.Decimal(10, 2)
  budgetType        String?
  impressions       Int                @default(0)
  clicks            Int                @default(0)
  cost              Decimal            @default(0) @db.Decimal(10, 2)
  conversions       Int                @default(0)
  conversionValue   Decimal            @default(0) @db.Decimal(10, 2)
  ctr               Decimal?           @db.Decimal(5, 2)
  cpc               Decimal?           @db.Decimal(10, 2)
  conversionRate    Decimal?           @db.Decimal(5, 2)
  costPerConversion Decimal?           @db.Decimal(10, 2)
  roi               Decimal?           @db.Decimal(10, 2)
  startDate         DateTime?
  endDate           DateTime?
  lastSyncAt        DateTime           @default(now())
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @default(now())
  adGroups          GoogleAdsAdGroup[]
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, campaignStatus])
  @@map("google_ads_campaigns")
}

model GoogleAdsAdGroup {
  id              String             @id @default(uuid())
  campaignId      String
  adGroupId       String             @unique
  adGroupName     String
  adGroupStatus   String
  impressions     Int                @default(0)
  clicks          Int                @default(0)
  cost            Decimal            @default(0) @db.Decimal(10, 2)
  conversions     Int                @default(0)
  conversionValue Decimal            @default(0) @db.Decimal(10, 2)
  lastSyncAt      DateTime           @default(now())
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @default(now())
  campaign        GoogleAdsCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  keywords        GoogleAdsKeyword[]

  @@index([campaignId])
  @@map("google_ads_ad_groups")
}

model GoogleAdsKeyword {
  id              String           @id @default(uuid())
  adGroupId       String
  keywordId       String           @unique
  keywordText     String
  matchType       String
  status          String
  impressions     Int              @default(0)
  clicks          Int              @default(0)
  cost            Decimal          @default(0) @db.Decimal(10, 2)
  conversions     Int              @default(0)
  conversionValue Decimal          @default(0) @db.Decimal(10, 2)
  qualityScore    Int?
  lastSyncAt      DateTime         @default(now())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @default(now())
  adGroup         GoogleAdsAdGroup @relation(fields: [adGroupId], references: [id], onDelete: Cascade)

  @@index([adGroupId])
  @@index([keywordText])
  @@map("google_ads_keywords")
}

model GoogleAdsConfig {
  id             String       @id @default(uuid())
  organizationId String       @unique
  customerId     String
  managerId      String?
  refreshToken   String
  isActive       Boolean      @default(true)
  lastSyncAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("google_ads_configs")
}

model CrmSettings {
  id                        String       @id @default(uuid())
  organizationId            String       @unique
  googleAdsCustomerId       String?
  googleAdsClientId         String?
  googleAdsClientSecret     String?
  googleAdsRefreshToken     String?
  googleAdsDeveloperToken   String?
  googleAdsConversionAction String?
  googleAdsConnected        Boolean      @default(false)
  googleAdsEnabled          Boolean      @default(false)
  conversionActionId        String?
  defaultLTV                Decimal?     @db.Decimal(10, 2)
  autoAssignLeads           Boolean      @default(false)
  defaultAssigneeId         String?
  notifyNewLead             Boolean      @default(true)
  notifyHotLead             Boolean      @default(true)
  notifyLostLead            Boolean      @default(false)
  autoFollowUpDays          Int          @default(3)
  autoArchiveDays           Int          @default(30)
  createdAt                 DateTime     @default(now())
  updatedAt                 DateTime     @default(now())
  organization              Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("crm_settings")
}

model ActivityCategory {
  id                   String     @id @default(uuid())
  name                 String     @unique
  description          String?
  color                String?
  icon                 String?
  order                Int        @default(0)
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @default(now())
  minimumForGraduation Int?       @default(50)
  activities           Activity[]

  @@map("activity_categories")
}

model LessonActivityExecution {
  id                String             @id @default(uuid())
  studentId         String
  activityId        String
  attendanceId      String
  turmaLessonId     String
  executedAt        DateTime           @default(now())
  completed         Boolean            @default(false)
  repetitionsCount  Int                @default(1)
  durationMinutes   Int?
  intensityApplied  Float              @default(1.0)
  performanceRating Int?
  instructorNotes   String?
  validatedBy       String?
  validatedAt       DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @default(now())
  activity          LessonPlanActivity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  attendance        TurmaAttendance    @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  student           Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  turmaLesson       TurmaLesson        @relation(fields: [turmaLessonId], references: [id], onDelete: Cascade)
  instructor        Instructor?        @relation("ActivityValidation", fields: [validatedBy], references: [id])

  @@unique([attendanceId, activityId])
  @@index([studentId, activityId])
  @@index([turmaLessonId])
  @@map("lesson_activity_executions")
}

model CourseGraduationLevel {
  id                         String   @id @default(uuid())
  courseId                   String
  currentBelt                String
  nextBelt                   String
  totalDegrees               Int      @default(4)
  degreePercentageIncrement  Float    @default(20)
  minimumAttendanceRate      Float    @default(80)
  minimumQualityRating       Float    @default(3.0)
  minimumRepetitionsTotal    Int      @default(500)
  minimumMonthsEnrolled      Int      @default(3)
  requiresInstructorApproval Boolean  @default(true)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  course                     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, currentBelt])
  @@map("course_graduation_levels")
}

model StudentDegreeHistory {
  id               String   @id @default(uuid())
  studentId        String
  courseId         String
  degree           Int
  degreePercentage Float
  belt             String
  completedLessons Int
  totalRepetitions Int
  averageQuality   Float?
  attendanceRate   Float
  achievedAt       DateTime @default(now())
  course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student          Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, courseId])
  @@map("student_degree_history")
}

model StudentGraduation {
  id                    String    @id @default(uuid())
  studentId             String
  courseId              String
  fromBelt              String
  toBelt                String
  approvedBy            String
  approvedAt            DateTime  @default(now())
  finalAttendanceRate   Float
  finalQualityRating    Float
  totalRepetitions      Int
  totalLessonsCompleted Int
  certificateGenerated  Boolean   @default(false)
  certificateUrl        String?
  ceremonyDate          DateTime?
  ceremonyNotes         String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @default(now())
  course                Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student               Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, toBelt])
  @@map("student_graduations")
}

model AIAgent {
  id             String              @id @default(uuid())
  organizationId String
  name           String
  description    String?
  specialization AgentSpecialization
  model          String              @default("gemini-1.5-flash")
  systemPrompt   String
  ragSources     Json
  mcpTools       Json
  temperature    Float               @default(0.7)
  maxTokens      Int                 @default(2048)
  noCodeMode     Boolean             @default(true)
  isActive       Boolean             @default(true)
  autoSaveInsights Boolean           @default(true)
  isPublic       Boolean             @default(false)
  averageRating  Float?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now())
  conversations  AgentConversation[]
  interactions   AgentInteraction[]  @relation("AgentInteractions")
  permissions    AgentPermission[]   @relation("AgentPermissions")
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  tasks                AgentTask[]         @relation("AgentToTask")
  insights             AgentInsight[]      @relation("AgentToInsight")

  @@index([organizationId, isActive])
  @@index([specialization])
  @@map("ai_agents")
}

model AgentConversation {
  id        String   @id @default(uuid())
  agentId   String
  userId    String?
  studentId String?
  messages  Json
  rating    Int?
  feedback  String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  agent     AIAgent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  student   Student? @relation(fields: [studentId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@index([agentId])
  @@index([userId])
  @@index([studentId])
  @@index([createdAt])
  @@map("agent_conversations")
}

model AgentInteraction {
  id             String       @id @default(uuid())
  agentId        String
  organizationId String
  type           String
  message        String
  action         Json?
  metadata       Json?
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
  agent          AIAgent      @relation("AgentInteractions", fields: [agentId], references: [id], onDelete: Cascade)
  organization   Organization @relation("AgentInteractions", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([agentId])
  @@index([type])
  @@map("agent_interactions")
}

model AgentPermission {
  id              String       @id @default(uuid())
  agentId         String
  organizationId  String
  action          String
  details         Json
  status          String       @default("PENDING")
  approvedBy      String?
  approvedAt      DateTime?
  deniedReason    String?
  executedAt      DateTime?
  executionResult Json?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  agent           AIAgent      @relation("AgentPermissions", fields: [agentId], references: [id], onDelete: Cascade)
  approver        User?        @relation("ApprovedPermissions", fields: [approvedBy], references: [id])
  organization    Organization @relation("AgentPermissions", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([agentId])
  @@index([status])
  @@index([createdAt])
  @@map("agent_permissions")
}

model StudentProgress {
  id                     String                  @id @default(uuid())
  studentId              String
  courseId               String
  lessonNumber           Int
  activityName           String
  completedReps          Int                     @default(0)
  targetReps             Int
  completionPercentage   Float                   @default(0)
  lastUpdated            DateTime                @default(now())
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  qualitativeAssessments QualitativeAssessment[]
  course                 Course                  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student                Student                 @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, lessonNumber, activityName])
  @@index([studentId, courseId])
  @@index([courseId, lessonNumber])
  @@map("student_progress")
}

model QualitativeAssessment {
  id                String          @id @default(uuid())
  studentProgressId String
  instructorId      String?
  rating            Int
  notes             String?
  assessmentDate    DateTime        @default(now())
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  instructor        Instructor?     @relation(fields: [instructorId], references: [id])
  studentProgress   StudentProgress @relation(fields: [studentProgressId], references: [id], onDelete: Cascade)

  @@index([studentProgressId])
  @@index([instructorId])
  @@map("qualitative_assessments")
}

model CourseRequirement {
  id            String   @id @default(uuid())
  courseId      String
  beltLevel     String
  category      String
  activityName  String
  minimumReps   Int
  minimumRating Float?
  isMandatory   Boolean  @default(true)
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, beltLevel, activityName])
  @@index([courseId, beltLevel])
  @@map("course_requirements")
}

model BiometricData {
  id               String   @id @default(uuid())
  studentId        String   @unique
  embedding        Json
  photoUrl         String
  photoBase64      String?  @db.LongText
  qualityScore     Int
  enrolledAt       DateTime @default(now())
  lastUpdatedAt    DateTime @updatedAt
  enrollmentMethod String
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  student          Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([isActive])
  @@map("biometric_data")
}

model BiometricAttempt {
  id                String    @id @default(uuid())
  organizationId    String
  studentId         String?
  detectedStudentId String?
  similarity        Float
  confidence        String
  method            String
  result            String
  errorMessage      String?
  ipAddress         String?
  userAgent         String?
  attemptedAt       DateTime  @default(now())
  processedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  student           Student?  @relation(fields: [studentId], references: [id])

  @@index([organizationId])
  @@index([studentId])
  @@index([detectedStudentId])
  @@index([attemptedAt])
  @@index([method])
  @@map("biometric_attempts")
}

enum CourseCategory {
  MARTIAL_ARTS
  DANCE
  FITNESS
  LANGUAGE
  MUSIC
  OTHER
}

enum SubscriptionPlan {
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum AIProvider {
  CLAUDE
  GEMINI
  OPENAI
  OPENROUTER
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  INSTRUCTOR
  STUDENT
}

enum GradingSystem {
  BELT
  LEVEL
  STRIPE
  CUSTOM
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
  MASTER
}

enum StudentCategory {
  ADULT
  FEMALE
  SENIOR
  CHILD
  INICIANTE1
  INICIANTE2
  INICIANTE3
  HEROI1
  HEROI2
  HEROI3
  MASTER_1
  MASTER_2
  MASTER_3
  TEEN
  KIDS
  WOMEN
  MEN
  MIXED
  LAW_ENFORCEMENT
}

enum Gender {
  MASCULINO
  FEMININO
  OUTRO
}

enum PhysicalCondition {
  INICIANTE
  REGULAR
  AVANCADO
}

enum SpecialNeed {
  TEA
  TDAH
  MOBILIDADE_REDUZIDA
  AUDITIVA
  VISUAL
}

enum EvaluationStatus {
  AUTONOMIA
  EM_DESENVOLVIMENTO
  PRECISA_INTERVENCAO
}

enum TechniqueCategory {
  STRIKING
  GRAPPLING
  DEFENSE
  SUBMISSION
  WEAPON
  FITNESS
}

enum TechniqueProficiency {
  LEARNING
  PRACTICING
  COMPETENT
  PROFICIENT
  EXPERT
  MASTERED
}

enum ClassStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  EXCUSED
}

enum CheckInMethod {
  QR_CODE
  MANUAL
  FACIAL_RECOGNITION
  GEOLOCATION
  NFC
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
  SUSPENDED
  TRANSFERRED
}

enum EvaluationType {
  GRADING
  PROGRESS
  TECHNIQUE
  SPARRING
  FITNESS
  KNOWLEDGE
}

enum EvaluationCategory {
  TECHNICAL
  PHYSICAL
  MENTAL
  BEHAVIORAL
}

enum AchievementCategory {
  ATTENDANCE
  TECHNIQUE
  PROGRESSION
  SOCIAL
  CHALLENGE
  SPECIAL
}

enum AchievementRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum ChallengeType {
  ATTENDANCE
  TECHNIQUE
  STREAK
  SOCIAL
  FITNESS
  CUSTOM
}

enum ChallengeDifficulty {
  EASY
  MEDIUM
  HARD
  EXTREME
}

enum RecurringType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
}

enum CertificateType {
  COMPLETION
  ACHIEVEMENT
  PARTICIPATION
  GRADING
}

enum BillingType {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  LIFETIME
  CREDIT_CARD_INSTALLMENT
  RECURRING
  CREDITS
}

enum RecurrencePeriod {
  WEEKLY
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  INACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PIX
  BANK_TRANSFER
  CASH
  PAYPAL
  STRIPE
}

enum PlanType {
  MONTHLY
  CREDIT_PACK
  ONE_TIME
  TRIAL
  HYBRID
  GIFT
  CORPORATE
  PARTNERSHIP
}

enum CreditType {
  CLASS
  HOUR
  PERSONAL_HOUR
  PACKAGE
}

enum CreditRenewalTrigger {
  MONTHLY
  ON_CONSUMPTION
  MANUAL
}

enum CreditRenewalMethod {
  INCLUDED
  SEPARATE
  SUBSCRIPTION
}

enum AttendanceTrend {
  IMPROVING
  DECLINING
  STABLE
  VOLATILE
}

enum DropoutRisk {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ActivityType {
  TECHNIQUE
  STRETCH
  DRILL
  EXERCISE
  GAME
  CHALLENGE
  ASSESSMENT
}

enum LessonSegment {
  WARMUP
  STRETCH
  TECHNIQUE
  DRILL
  SIMULATION
  COOLDOWN
}

enum AssessmentType {
  TECHNICAL
  PHYSICAL
  MIXED
}

enum Metric {
  REPS
  TIME
  DISTANCE
  LOAD
}

enum ClassType {
  COLLECTIVE
  PRIVATE
  SEMI_PRIVATE
}

enum TurmaStatus {
  SCHEDULED
  ACTIVE
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum WeekDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum PersonalTrainingType {
  INDIVIDUAL
  SEMI_PRIVATE
  SMALL_GROUP
}

enum PersonalClassStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum SessionStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

enum AgendaItemType {
  TURMA
  PERSONAL_SESSION
}

enum AgendaItemStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

enum LeadStage {
  NEW
  CONTACTED
  QUALIFIED
  TRIAL_SCHEDULED
  TRIAL_ATTENDED
  NEGOTIATION
  CONVERTED
  LOST
}

enum LeadStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum LeadTemperature {
  HOT
  WARM
  COLD
}

enum LeadActivityType {
  CALL
  EMAIL
  WHATSAPP
  SMS
  MEETING
  TRIAL_CLASS
  FOLLOW_UP
  NOTE
  STATUS_CHANGE
  DOCUMENT_SENT
  PAYMENT_RECEIVED
}

enum AgentSpecialization {
  pedagogical
  analytical
  support
  progression
  commercial
  curriculum
}

model AgentTask {
  id                String    @id @default(uuid())
  organizationId    String
  agentId           String?
  createdByUserId   String?
  assignedToUserId  String?
  
  // Task Definition
  title             String
  description       String
  category          String // DATABASE_CHANGE, WHATSAPP_MESSAGE, EMAIL, SMS, MARKETING, BILLING, ENROLLMENT
  actionType        String // UPDATE_RECORD, SEND_MESSAGE, CREATE_RECORD, DELETE_RECORD
  targetEntity      String? // Student, Course, Payment, etc
  actionPayload     Json // Data needed to execute the action
  reasoning         Json? // { insights: [], expectedImpact: string, risks: [], dataSupport: {} }
  
  // Approval Workflow
  requiresApproval  Boolean   @default(true)
  autoExecute       Boolean   @default(false)
  automationLevel   String    @default("MANUAL") // MANUAL, SEMI_AUTO, AUTO_LOW_RISK, FULL_AUTO
  approvalStatus    String    @default("PENDING") // PENDING, APPROVED, REJECTED, EXECUTED, FAILED
  status            String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED, FAILED
  priority          String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  approvedBy        String?
  approvedAt        DateTime?
  rejectedReason    String?
  
  //  EXECUTION & ORCHESTRATION
  executorType      String?   @default("AGENT") // AGENT (IA executa), USER (humano executa), SYSTEM (auto)
  executorId        String? // ID do agente IA ou usurio que vai executar
  scheduledFor      DateTime? // Data/hora agendada para execuo futura
  recurrenceRule    String? // Regra cron (ex: "0 9 * * 1" = toda segunda s 9h)
  maxRetries        Int       @default(3) // Mximo de tentativas em caso de falha
  retryCount        Int       @default(0) // Tentativas j realizadas
  lastRetryAt       DateTime? // Data da ltima tentativa
  nextRetryAt       DateTime? // Prxima tentativa agendada
  
  // Execution Results
  executedAt        DateTime?
  executionResult   Json? // Result after execution
  errorMessage      String?
  executionLog      Json? // Array de logs de execuo: [{ timestamp, action, result, error }]
  
  // Metadata
  dueDate           DateTime?
  metadata          Json? // Additional context
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  agent             AIAgent?  @relation("AgentToTask", fields: [agentId], references: [id], onDelete: SetNull)
  organization      Organization @relation("OrgToAgentTask", fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy         User?     @relation("CreatedTasks", fields: [createdByUserId], references: [id], onDelete: SetNull)
  assignedTo        User?     @relation("AssignedTasks", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  approver          User?     @relation("ApprovedTasks", fields: [approvedBy], references: [id], onDelete: SetNull)
  executor          User?     @relation("ExecutorTasks", fields: [executorId], references: [id], onDelete: SetNull)
  executions        TaskExecution[] @relation("TaskExecutions")

  @@index([organizationId, approvalStatus])
  @@index([organizationId, status])
  @@index([agentId])
  @@index([createdByUserId])
  @@index([assignedToUserId])
  @@index([executorType, executorId])
  @@index([scheduledFor])
  @@index([approvalStatus])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

model TaskExecution {
  id              String    @id @default(uuid())
  taskId          String
  attemptNumber   Int       @default(1)
  executorType    String // AGENT, USER, SYSTEM
  executorId      String?
  status          String // STARTED, COMPLETED, FAILED, TIMEOUT
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  duration        Int? // Durao em milissegundos
  result          Json? // Resultado da execuo
  errorMessage    String?
  errorStack      String?
  metadata        Json? // Logs adicionais
  
  task            AgentTask @relation("TaskExecutions", fields: [taskId], references: [id], onDelete: Cascade)
  executor        User?     @relation("TaskExecutions", fields: [executorId], references: [id], onDelete: SetNull)
  
  @@index([taskId])
  @@index([executorType, executorId])
  @@index([status])
  @@index([startedAt])
  @@map("task_executions")
}

model AgentInsight {
  id             String       @id @default(uuid())
  organizationId String
  agentId        String
  executionId    String? // ID da execuo que gerou o insight
  type           String // INSIGHT, NOTIFICATION, RECOMMENDATION
  category       String? // GROWTH, ENGAGEMENT, FINANCIAL, OPERATIONAL, RISK
  title          String
  content        String
  priority       String       @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  status         String       @default("NEW") // NEW, PINNED, ARCHIVED, DISMISSED
  isPinned       Boolean      @default(false)
  isRead         Boolean      @default(false)
  metadata       Json? // Additional context, metrics, etc
  relatedEntity  String? // Student, Course, Payment, etc
  relatedId      String? // ID of related entity
  actionTaken    String? // What action was taken (if any)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  agent          AIAgent      @relation("AgentToInsight", fields: [agentId], references: [id], onDelete: Cascade)
  organization   Organization @relation("OrgToInsight", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([agentId])
  @@index([type])
  @@index([category])
  @@index([priority])
  @@index([status])
  @@index([createdAt])
  @@map("agent_insights")
}

// ============================================================================
// LANDING PAGE BUILDER - Marketing Module
// ============================================================================

model LandingPage {
  id              String   @id @default(uuid())
  organizationId  String
  
  // Identificao
  name            String              // "Site SmartDefence Principal"
  slug            String              // "smartdefence" (nico por org)
  
  // SEO
  title           String              // <title> tag
  description     String?             // Meta description
  keywords        Json @default("[]")
  
  // Configuraes visuais
  theme           Json?               // { primaryColor, secondaryColor, font, logo }
  faviconUrl      String?
  ogImageUrl      String?             // Open Graph image
  
  // Contedo - Gerado pelo Agente de Marketing
  htmlContent     String?             @db.Text  // HTML completo da pgina
  cssContent      String?             @db.Text  // CSS customizado
  jsContent       String?             @db.Text  // JS customizado (analytics)
  
  // Estrutura de sees (para regenerao)
  sections        Json?               // Array de sees configuradas
  
  // Integraes
  googleAnalyticsId   String?
  facebookPixelId     String?
  googleAdsConversionId String?
  whatsappNumber      String?
  
  // Status
  status          LandingPageStatus   @default(DRAFT)
  publishedAt     DateTime?
  lastGeneratedAt DateTime?           // ltima vez que IA gerou contedo
  lastGeneratedBy String?             // ID do agente que gerou
  
  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relations
  organization    Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  forms           LandingForm[]
  pageViews       LandingPageView[]
  
  @@unique([organizationId, slug])
  @@index([organizationId, status])
  @@index([status])
  @@map("landing_pages")
}

enum LandingPageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model LandingForm {
  id              String   @id @default(uuid())
  landingPageId   String
  
  // Identificao
  name            String              // "Formulrio Principal"
  position        String              @default("hero") // hero, footer, popup
  
  // Configurao
  fields          Json                // Array de campos: [{name, type, required, placeholder}]
  submitButtonText String            @default("Quero Comear!")
  successMessage  String             @default("Obrigado! Entraremos em contato em breve.")
  
  // Integrao com CRM
  autoCreateLead  Boolean            @default(true)
  leadSource      String             @default("LANDING_PAGE")
  leadTemperature String             @default("HOT") // COLD, WARM, HOT
  assignToUserId  String?            // Auto-assign a vendedor
  tags            Json @default("[]")
  
  // Stats
  submissions     Int                @default(0)
  conversions     Int                @default(0)
  
  // Timestamps
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  // Relations
  landingPage     LandingPage        @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  
  @@index([landingPageId])
  @@map("landing_forms")
}

model LandingPageView {
  id              String   @id @default(uuid())
  landingPageId   String
  
  // Dados da visita
  sessionId       String
  userAgent       String?
  ipAddress       String?
  referrer        String?
  
  // UTM Tracking
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmContent      String?
  utmTerm         String?
  
  // Comportamento
  timeOnPage      Int?                // Segundos
  scrollDepth     Int?                // Porcentagem
  
  // Timestamps
  visitedAt       DateTime            @default(now())
  
  // Relations
  landingPage     LandingPage         @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  
  @@index([landingPageId, visitedAt])
  @@index([sessionId])
  @@map("landing_page_views")
}

// ============================================================================
// PORTAL DO ALUNO - Student Self-Service Module
// ============================================================================

/// Sesses de autenticao do Portal do Aluno
/// Suporta Magic Link (cdigo 6 dgitos via WhatsApp) e JWT
model StudentSession {
  id          String    @id @default(uuid())
  studentId   String
  
  // Tokens
  token       String    @unique          // JWT token
  magicCode   String?                    // Cdigo 6 dgitos para Magic Link
  codeExpires DateTime?                  // Expirao do cdigo (5 min)
  
  // Device info
  userAgent   String?
  ipAddress   String?
  deviceType  String?                    // mobile, desktop, tablet
  
  // Status
  expiresAt   DateTime                   // Expirao do JWT (7 dias)
  isActive    Boolean   @default(true)
  revokedAt   DateTime?
  
  // Timestamps
  createdAt   DateTime  @default(now())
  lastUsedAt  DateTime  @default(now())
  
  // Relations
  student     Student   @relation("StudentSessions", fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([studentId])
  @@index([token])
  @@index([magicCode])
  @@index([expiresAt])
  @@map("student_sessions")
}

/// Notificaes do Portal do Aluno
/// Tipos: PAYMENT, CLASS, ACHIEVEMENT, SYSTEM, REMINDER
model StudentNotification {
  id          String    @id @default(uuid())
  studentId   String
  
  // Contedo
  type        StudentNotificationType
  title       String
  message     String
  link        String?                    // Deep link para ao
  icon        String?                    // cone customizado
  
  // Status
  read        Boolean   @default(false)
  readAt      DateTime?
  dismissed   Boolean   @default(false)
  
  // Prioridade
  priority    NotificationPriority @default(NORMAL)
  
  // Metadados
  metadata    Json?                      // Dados adicionais (paymentId, classId, etc)
  expiresAt   DateTime?                  // Notificaes temporrias
  
  // Timestamps
  createdAt   DateTime  @default(now())
  
  // Relations
  student     Student   @relation("StudentNotifications", fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([studentId, read])
  @@index([studentId, type])
  @@index([createdAt])
  @@map("student_notifications")
}

enum StudentNotificationType {
  PAYMENT_DUE           // Pagamento prximo do vencimento
  PAYMENT_OVERDUE       // Pagamento vencido
  PAYMENT_CONFIRMED     // Pagamento confirmado
  CLASS_REMINDER        // Lembrete de aula
  CLASS_CANCELLED       // Aula cancelada
  CLASS_RESCHEDULED     // Aula reagendada
  ACHIEVEMENT_UNLOCKED  // Conquista desbloqueada
  LEVEL_UP              // Subiu de nvel
  BELT_PROMOTION        // Promovido de faixa
  SYSTEM                // Mensagem do sistema
  WELCOME               // Boas-vindas
  REMINDER              // Lembrete genrico
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ============================================
// PERMISSIONS SYSTEM
// ============================================

model Permission {
  id          String   @id @default(uuid())
  module      String   // 'students', 'turmas', 'courses', etc.
  action      String   // 'list', 'view', 'create', 'edit', 'delete'
  description String?
  createdAt   DateTime @default(now())
  
  rolePermissions      RolePermission[]
  userOverrides        UserPermissionOverride[]
  
  @@unique([module, action])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  role         UserRole
  permissionId String
  scope        PermissionScope @default(ALL) // all, own, team, none
  createdAt    DateTime   @default(now())
  
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([role, permissionId])
  @@map("role_permissions")
}

model UserPermissionOverride {
  id           String     @id @default(uuid())
  userId       String
  permissionId String
  granted      Boolean    // true = permite, false = nega
  scope        PermissionScope? // null = usa scope default do role
  reason       String?    // motivo da exceo
  createdAt    DateTime   @default(now())
  createdBy    String?    // quem criou a exceo
  
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([userId, permissionId])
  @@map("user_permission_overrides")
}

enum PermissionScope {
  ALL    // Acesso a todos os dados
  OWN    // Apenas prprios dados
  TEAM   // Dados do time/turmas relacionadas
  NONE   // Sem acesso
}


model StudentTechniqueProgress {
  id          String    @id @default(uuid())
  studentId   String
  techniqueId String
  
  completed   Boolean   @default(false)
  rating      Int?      // 1-5 auto-avaliao
  completedAt DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  technique   Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)
  
  @@unique([studentId, techniqueId])
  @@map("student_technique_progress")
}


model Job {
  id               String           @id @default(uuid())
  organizationId   String
  title            String
  description      String
  requirements     String?
  responsibilities String?
  benefits         String?
  type             JobType          @default(FULL_TIME)
  level            JobLevel         @default(MID)
  location         String?
  remoteOption     Boolean          @default(false)
  salary           String?
  unitId           String?
  department       String?
  vacancies        Int              @default(1)
  status           JobStatus        @default(DRAFT)
  publishedAt      DateTime?
  closedAt         DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  createdById      String?

  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  unit             Unit?            @relation(fields: [unitId], references: [id])
  createdBy        User?            @relation("JobCreator", fields: [createdById], references: [id])
  applications     JobApplication[]

  @@map("jobs")
}

model JobApplication {
  id            String            @id @default(uuid())
  jobId         String
  userId        String
  studentId     String?
  instructorId  String?
  coverLetter   String?
  resume        String?
  status        ApplicationStatus @default(PENDING)
  appliedAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  reviewedById  String?
  reviewedAt    DateTime?
  reviewNotes   String?
  interviewDate DateTime?

  job           Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  student       Student?          @relation(fields: [studentId], references: [id])
  instructor    Instructor?       @relation(fields: [instructorId], references: [id])
  reviewedBy    User?             @relation("ApplicationReviewer", fields: [reviewedById], references: [id])

  @@unique([jobId, userId])
  @@map("job_applications")
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERNSHIP
  VOLUNTEER
}

enum JobLevel {
  ENTRY
  JUNIOR
  MID
  SENIOR
  LEAD
  MANAGER
}

enum JobStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  REVIEWING
  INTERVIEW_SCHEDULED
  INTERVIEWED
  APPROVED
  REJECTED
  WITHDRAWN
  HIRED
}

// ============================================
// DEPLOY OPERATIONS
// ============================================

model DeployArtifact {
  id             String   @id @default(uuid())
  sourceVersion  String
  buildTimestamp DateTime @default(now())
  aliasesResolved Boolean @default(true)
  checksum       String
  contents       String
  location       String
  sizeBytes      Int
  createdAt      DateTime @default(now())

  sessions       DeploySession[]

  @@map("deploy_artifacts")
}

model DeploySession {
  id                String               @id @default(uuid())
  artifactId        String
  operator          String
  targetEnvironment String
  status            DeploySessionStatus  @default(PENDING)
  notes             String?
  startedAt         DateTime             @default(now())
  completedAt       DateTime?

  artifact          DeployArtifact       @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  healthCheck       HealthCheck?
  logs              DeployLog[]

  @@map("deploy_sessions")
}

model HealthCheck {
  id                     String             @id @default(uuid())
  sessionId              String             @unique
  endpoint               String
  startedAt              DateTime           @default(now())
  completedAt            DateTime           @default(now())
  httpStatus             Int
  latencyMs              Int
  stabilityWindowMinutes Int                @default(30)
  restartsObserved       Int                @default(0)
  result                 HealthCheckResult
  logExcerpt             String?

  session                DeploySession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("deploy_health_checks")
}

model DeployLog {
  id        String          @id @default(uuid())
  sessionId String
  timestamp DateTime        @default(now())
  level     DeployLogLevel  @default(INFO)
  message   String
  data      Json?

  session   DeploySession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("deploy_logs")
}

enum DeploySessionStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  ROLLED_BACK
}

enum HealthCheckResult {
  PASS
  FAIL
}

enum DeployLogLevel {
  INFO
  WARN
  ERROR
}


// Pr-matrculas (Self-service)
model PreEnrollment {
  id                    String    @id @default(uuid())
  firstName             String
  lastName              String
  cpf                   String
  phone                 String
  email                 String
  birthDate             DateTime?
  photoUrl              String?   @db.Text
  planId                String?
  courseId              String?
  customPrice           Decimal?  @db.Decimal(10, 2)
  financialResponsible  Json?
  source                String    // 'public_link', 'website', 'landing_page'
  status                String    @default("PENDING") // PENDING, CONVERTED, REJECTED
  notes                 String?   @db.Text
  convertedAt           DateTime?
  studentId             String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  plan                  BillingPlan? @relation(fields: [planId], references: [id])
  course                Course?      @relation(fields: [courseId], references: [id])
  student               Student?     @relation(fields: [studentId], references: [id])
  
  @@unique([email])
  @@unique([cpf])
  @@map("pre_enrollments")
}

// Links de matrcula gerados
model EnrollmentLink {
  id              String    @id @default(uuid())
  organizationId  String
  token           String    @unique
  planId          String
  courseId        String?
  customPrice     Decimal?  @db.Decimal(10, 2)
  expiresAt       DateTime
  isActive        Boolean   @default(true)
  usageCount      Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan            BillingPlan  @relation(fields: [planId], references: [id])
  course          Course?      @relation(fields: [courseId], references: [id])
  
  @@map("enrollment_links")
}

