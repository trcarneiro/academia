generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "linux-musl"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Organization {
  id                    String                 @id @default(uuid())
  name                  String
  slug                  String                 @unique
  description           String?
  logoUrl               String?
  website               String?
  phone                 String?
  email                 String?
  address               String?
  city                  String?
  state                 String?
  country               String                 @default("Brazil")
  zipCode               String?
  subscriptionPlan      SubscriptionPlan       @default(BASIC)
  maxStudents           Int                    @default(100)
  maxStaff              Int                    @default(10)
  isActive              Boolean                @default(true)
  primaryColor          String                 @default("#1f2937")
  secondaryColor        String                 @default("#3b82f6")
  customDomain          String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  achievements          Achievement[]
  asaasCustomers        AsaasCustomer[]
  attendances           Attendance[]
  billingPlans          BillingPlan[]
  challenges            Challenge[]
  classes               Class[]
  courses               Course[]
  financialResponsibles FinancialResponsible[]
  financialSettings     FinancialSettings?
  instructors           Instructor[]
  martialArts           MartialArt[]
  mats                  Mat[]
  organizationSettings  OrganizationSettings?
  payments              Payment[]
  subscriptions         StudentSubscription[]
  students              Student[]
  units                 Unit[]
  users                 User[]
  courseTemplates       CourseTemplate[]
  techniqueLibraries    TechniqueLibrary[]
  // Back-relations for new models
  activities            Activity[]
  badges                Badge[]

  @@map("organizations")
}

model OrganizationSettings {
  id                      String       @id @default(uuid())
  organizationId          String       @unique
  enableGamification      Boolean      @default(true)
  enableVideoAnalysis     Boolean      @default(false)
  enableAIRecommendations Boolean      @default(true)
  enableMultipleArts      Boolean      @default(true)
  aiProvider              AIProvider   @default(CLAUDE)
  openaiApiKey            String?
  anthropicApiKey         String?
  geminiApiKey            String?
  openRouterApiKey        String?
  timezone                String       @default("America/Sao_Paulo")
  currency                String       @default("BRL")
  language                String       @default("pt-BR")
  allowQRCheckin          Boolean      @default(true)
  allowManualCheckin      Boolean      @default(true)
  allowFacialCheckin      Boolean      @default(false)
  checkinWindowStart      Int          @default(30)
  checkinWindowEnd        Int          @default(15)
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @default(now())
  organization            Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_settings")
}

model MartialArt {
  id             String               @id @default(uuid())
  organizationId String
  name           String
  description    String?
  imageUrl       String?
  hasGrading     Boolean              @default(true)
  gradingSystem  GradingSystem        @default(BELT)
  maxLevel       Int                  @default(10)
  isActive       Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now())
  achievements   Achievement[]
  courses        Course[]
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  progressions   StudentProgression[]
  techniques     Technique[]

  @@unique([organizationId, name])
  @@map("martial_arts")
}

model Course {
  id                String             @id @default(uuid())
  organizationId    String
  martialArtId      String?
  courseTemplateId  String?
  name              String
  description       String?
  level             CourseLevel
  duration          Int
  classesPerWeek    Int                @default(2)
  totalClasses      Int
  minAge            Int                @default(16)
  maxAge            Int?
  category          StudentCategory    @default(ADULT)
  orderIndex        Int                @default(1)
  nextCourseId      String?            @unique
  prerequisites     String[]
  objectives        String[]
  requirements      String[]
  imageUrl          String?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @default(now())
  attendanceRecords AttendanceRecord[]
  classes           Class[]
  challenges        CourseChallenge[]
  enrollments       CourseEnrollment[]
  techniques        CourseTechnique[]
  martialArt        MartialArt?        @relation(fields: [martialArtId], references: [id], onDelete: Cascade)
  planCourses       PlanCourse[]
  nextCourse        Course?            @relation("CourseProgression", fields: [nextCourseId], references: [id])
  previousCourse    Course?            @relation("CourseProgression")
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  evaluationRecords EvaluationRecord[]
  lessonPlans       LessonPlan[]
  progressRecords   Progress[]
  studentCourses    StudentCourse[]
  techniqueDetails  TechniqueDetail[]
  weeklyChallenges  WeeklyChallenge[]
  template          CourseTemplate?    @relation(fields: [courseTemplateId], references: [id])
  // Opposite for BillingPlanPrimaryCourse
  primaryBillingPlans BillingPlan[]    @relation("BillingPlanPrimaryCourse")
  // Back-relations for assessments and evaluations
  assessmentDefinitions AssessmentDefinition[]
  teacherEvaluations    TeacherEvaluation[]

  @@unique([organizationId, name])
  @@map("courses")
}

model CourseTemplate {
  id               String         @id @default(uuid())
  organizationId   String
  name             String
  description      String?
  category         CourseCategory
  duration         Int
  classesPerWeek   Int            @default(2)
  totalClasses     Int
  minAge           Int            @default(16)
  maxAge           Int?
  objectives       String[]
  requirements     String[]
  structure        Json // Estrutura modular do curso
  ragSettings      Json? // Configurações específicas do RAG
  isSystemTemplate Boolean        @default(false)
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @default(now())
  courses          Course[]
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("course_templates")
}

model TechniqueLibrary {
  id                String            @id @default(uuid())
  organizationId    String
  name              String
  description       String?
  category          TechniqueCategory
  content           Json // Conteúdo estruturado (vídeos, instruções)
  ragEmbeddings     Json? // Embeddings do RAG para busca semântica
  prerequisites     String[]
  relatedTechniques String[]
  difficulty        Int               @default(1)
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @default(now())
  organization      Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("technique_libraries")
}

enum CourseCategory {
  MARTIAL_ARTS
  DANCE
  FITNESS
  LANGUAGE
  MUSIC
  OTHER
}

model LessonPlan {
  id               String                 @id @default(uuid())
  courseId         String
  title            String
  description      String?
  lessonNumber     Int
  weekNumber       Int
  unit             String?
  level            Int                    @default(1)
  warmup           Json
  techniques       Json
  simulations      Json
  cooldown         Json
  mentalModule     Json?
  tacticalModule   String?
  adaptations      Json?
  duration         Int                    @default(60)
  difficulty       Int                    @default(1)
  objectives       String[]
  equipment        String[]
  activities       String[]
  videoUrl         String?
  thumbnailUrl     String?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @default(now())
  classes          Class[]
  course           Course                 @relation(fields: [courseId], references: [id], onDelete: Cascade)
  techniqueRecords TechniqueRecord[]
  // opposite side for LessonPlanTechniques
  techniqueLinks   LessonPlanTechniques[]
  // Back-relations for LessonPlanActivity items
  activityItems    LessonPlanActivity[]

  @@unique([courseId, lessonNumber])
  @@map("lesson_plans")
}

// --- Techniques Module (Banco de Técnicas - API-first) ---
model Technique {
  id                   String   @id @default(uuid())
  martialArtId         String?
  // Identidade e SEO
  name                 String
  // Reintroduced legacy / extended fields (kept optional to avoid destructive diffs)
  slug                 String?  @unique
  shortDescription     String?
  category             String?
  subcategory          String?
  modality             String?
  complexity           String? // originally string-based taxonomy
  difficulty           Int? // numeric difficulty scale
  description          String?
  durationMin          Int?
  durationMax          Int?
  groupSizeMin         Int?
  groupSizeMax         Int?
  ageRangeMin          Int?
  ageRangeMax          Int?
  // Conteúdo e recursos
  objectives           String[]
  resources            String[]
  stepByStep           Json[]
  assessmentCriteria   String[]
  risksMitigation      String[]
  // BNCC e competências
  bnccCompetencies     Json[]
  bnccCompetenciesText String?  @default("")
  // skills             String[]
  tags                 String[]
  references           String[]
  prerequisites        String[] // raw list of technique IDs (still have pivot for normalized graph)
  imageUrl             String?
  videoUrl             String?
  instructions         Json[] // generic structured instructions blocks
  masteryXP            Int?
  baseXP               Int?
  badgeIcon            String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relações opcionais
  martialArt         MartialArt?                 @relation(fields: [martialArtId], references: [id], onDelete: Cascade)
  // Opposite sides for existing relations
  courseTechniques   CourseTechnique[]
  techniqueProgress  TechniqueProgress[]
  techniqueRecords   TechniqueRecord[]
  educationalLinks   EducationalPlanTechniques[]
  lessonLinks        LessonPlanTechniques[]
  // Normalized prerequisite graph relations
  prerequisitesEdges TechniquePrerequisite[]     @relation("TechniquePrerequisitesTechnique")
  requiredByEdges    TechniquePrerequisite[]     @relation("TechniquePrerequisitesPrerequisite")
  // Back-relations for Activity references
  referencedByActivities Activity[] @relation("ActivityTechniqueRef")

  @@map("techniques")
}

model CourseTechnique {
  id           String    @id @default(uuid())
  courseId     String
  techniqueId  String
  orderIndex   Int
  weekNumber   Int?
  lessonNumber Int?
  isRequired   Boolean   @default(true)
  course       Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  technique    Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([courseId, techniqueId])
  @@unique([courseId, orderIndex])
  @@map("course_techniques")
}

model User {
  id             String       @id @default(uuid())
  organizationId String
  email          String
  password       String
  role           UserRole     @default(STUDENT)
  firstName      String
  lastName       String
  avatarUrl      String?
  phone          String?
  cpf            String?
  birthDate      DateTime?
  isActive       Boolean      @default(true)
  emailVerified  Boolean      @default(false)
  lastLoginAt    DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  instructor     Instructor?
  student        Student?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@map("users")
}

model Student {
  id                     String                @id @default(uuid())
  organizationId         String
  userId                 String                @unique
  emergencyContact       String?
  medicalConditions      String?
  category               StudentCategory       @default(ADULT)
  gender                 Gender?               @default(MASCULINO)
  age                    Int?
  physicalCondition      PhysicalCondition?    @default(INICIANTE)
  specialNeeds           SpecialNeed[]
  totalXP                Int                   @default(0)
  globalLevel            Int                   @default(1)
  currentStreak          Int                   @default(0)
  longestStreak          Int                   @default(0)
  lastCheckinDate        DateTime?
  preferredDays          String[]
  preferredTimes         String[]
  notifications          Boolean               @default(true)
  enrollmentDate         DateTime              @default(now())
  isActive               Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  financialResponsibleId String?
  asaasCustomer          AsaasCustomer?
  attendancePatterns     AttendancePattern?
  attendanceRecords      AttendanceRecord[]
  attendances            Attendance[]
  challengeProgress      ChallengeProgress[]
  enrollments            CourseEnrollment[]
  evaluationRecords      EvaluationRecord[]
  evaluations            Evaluation[]
  payments               Payment[]
  progressRecords        Progress[]
  achievements           StudentAchievement[]
  studentCourses         StudentCourse[]
  progressions           StudentProgression[]
  subscriptions          StudentSubscription[]
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                   User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  techniqueRecords       TechniqueRecord[]
  // Back-relations for new entities
  assessmentAttempts     AssessmentAttempt[]
  physicalTestAttempts   PhysicalTestAttempt[]
  feedbackLessons        FeedbackLesson[]
  feedbackActivities     FeedbackActivity[]
  teacherEvaluations     TeacherEvaluation[]
  badgeUnlocks           BadgeUnlock[]
  pointsTransactions     PointsTransaction[]

  @@map("students")
}

model EducationalPlanTechniques {
  educationalPlanId String
  techniqueId       String
  order             Int       @default(0)
  notes             String?
  // Relations (assumindo existência de EducationalPlan em outro arquivo/esquema)
  technique         Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@id([educationalPlanId, techniqueId])
  @@map("educational_plan_techniques")
}

model LessonPlanTechniques {
  lessonPlanId      String
  techniqueId       String
  order             Int        @default(0)
  allocationMinutes Int        @default(0)
  objectiveMapping  String[] // mapeamento de objetivos vinculados à técnica
  // Relations
  lessonPlan        LessonPlan @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
  technique         Technique  @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@id([lessonPlanId, techniqueId])
  @@map("lesson_plan_techniques")
}

model FinancialResponsible {
  id               String                @id @default(uuid())
  organizationId   String
  name             String
  cpfCnpj          String
  email            String
  phone            String?
  birthDate        DateTime?
  address          String?
  addressNumber    String?
  complement       String?
  neighborhood     String?
  city             String?
  state            String?
  zipCode          String?
  relationshipType String?
  asaasId          String?
  isActive         Boolean               @default(true)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @default(now())
  asaasCustomer    AsaasCustomer?
  organization     Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payments         Payment[]
  subscriptions    StudentSubscription[]
  students         Student[]

  @@unique([organizationId, cpfCnpj])
  @@unique([organizationId, email])
  @@map("financial_responsibles")
}

model TechniqueRecord {
  id             String               @id @default(uuid())
  studentId      String
  techniqueId    String
  lessonPlanId   String?
  proficiency    TechniqueProficiency @default(LEARNING)
  practiceCount  Int                  @default(1)
  masteryScore   Int                  @default(0)
  firstPracticed DateTime             @default(now())
  lastPracticed  DateTime             @default(now())
  masteredAt     DateTime?
  videoUrl       String?
  aiAnalysis     Json?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now())
  lessonPlan     LessonPlan?          @relation(fields: [lessonPlanId], references: [id])
  student        Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  technique      Technique            @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([studentId, techniqueId])
  @@map("technique_records")
}

model Unit {
  id              String       @id @default(uuid())
  organizationId  String
  name            String
  description     String?
  address         String
  addressNumber   String?
  complement      String?
  neighborhood    String?
  city            String
  state           String
  zipCode         String
  phone           String?
  email           String?
  capacity        Int          @default(100)
  totalMats       Int          @default(1)
  responsibleName String?
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @default(now())
  classes         Class[]
  mats            Mat[]
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("units")
}

model Mat {
  id             String       @id @default(uuid())
  organizationId String
  unitId         String
  name           String
  description    String?
  capacity       Int          @default(20)
  dimensions     String? // "8x8m" ou similar
  equipment      String[] // ["Tatame", "Saco de pancada", "Espelhos"]
  materialType   String? // "EVA", "Tatame tradicional", etc
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  classes        Class[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  unit           Unit         @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([unitId, name])
  @@map("mats")
}

model Instructor {
  id                  String       @id @default(uuid())
  organizationId      String
  userId              String       @unique
  specializations     String[]
  certifications      String[]
  bio                 String?
  martialArts         String[]
  maxStudentsPerClass Int          @default(20)
  experience          String? // "5 anos", "Faixa Preta 2º Dan"
  availability        Json? // Horários disponíveis por dia da semana
  hourlyRate          Decimal?     @db.Decimal(10, 2) // Taxa por hora
  preferredUnits      String[] // IDs das unidades preferenciais
  hireDate            DateTime     @default(now())
  isActive            Boolean      @default(true)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @default(now())
  classes             Class[]
  evaluations         Evaluation[]
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Back-relations for teacher evaluations
  teacherEvaluations  TeacherEvaluation[]

  @@map("instructors")
}

model ClassSchedule {
  id          String   @id @default(uuid())
  dayOfWeek   Int
  startTime   DateTime
  endTime     DateTime
  maxStudents Int      @default(20)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  classes     Class[]

  @@map("class_schedules")
}

model Class {
  id                String             @id @default(uuid())
  organizationId    String
  unitId            String?
  matId             String?
  scheduleId        String?
  instructorId      String
  courseId          String
  lessonPlanId      String?
  date              DateTime
  startTime         DateTime
  endTime           DateTime
  title             String?
  description       String?
  status            ClassStatus        @default(SCHEDULED)
  actualStudents    Int                @default(0)
  maxStudents       Int                @default(20)
  agenda            Json? // Agenda detalhada da aula
  notes             String? // Observações do instrutor
  qrCode            String?            @unique
  qrCodeExpiry      DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @default(now())
  attendanceRecords AttendanceRecord[]
  attendances       Attendance[]
  course            Course             @relation(fields: [courseId], references: [id])
  instructor        Instructor         @relation(fields: [instructorId], references: [id])
  lessonPlan        LessonPlan?        @relation(fields: [lessonPlanId], references: [id])
  mat               Mat?               @relation(fields: [matId], references: [id])
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  schedule          ClassSchedule?     @relation(fields: [scheduleId], references: [id])
  studentCourses    StudentCourse[]
  unit              Unit?              @relation(fields: [unitId], references: [id])
  // Back-relations for new entities
  activities        ClassActivity[]
  assessmentAttempts AssessmentAttempt[]
  physicalTestAttempts PhysicalTestAttempt[]
  feedbackLessons   FeedbackLesson[]
  teacherEvaluations TeacherEvaluation[]

  @@map("classes")
}

model Attendance {
  id             String           @id @default(uuid())
  organizationId String
  studentId      String
  classId        String
  status         AttendanceStatus @default(PRESENT)
  checkInTime    DateTime?
  checkInMethod  CheckInMethod?
  location       String?
  notes          String?
  xpEarned       Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now())
  class          Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student        Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId])
  @@map("attendances")
}

model CourseEnrollment {
  id                String              @id @default(uuid())
  studentId         String
  courseId          String
  enrolledAt        DateTime            @default(now())
  completedAt       DateTime?
  expectedEndDate   DateTime
  status            EnrollmentStatus    @default(ACTIVE)
  category          StudentCategory     @default(ADULT)
  gender            String
  currentLesson     Int                 @default(1)
  lessonsCompleted  Int                 @default(0)
  attendanceRate    Float               @default(0)
  currentXP         Int                 @default(0)
  currentLevel      Int                 @default(1)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @default(now())
  challengeProgress ChallengeProgress[]
  course            Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student           Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  evaluations       Evaluation[]
  techniqueProgress TechniqueProgress[]

  @@unique([studentId, courseId])
  @@map("course_enrollments")
}

model TechniqueProgress {
  id                  String               @id @default(uuid())
  enrollmentId        String
  techniqueId         String
  status              TechniqueProficiency @default(LEARNING)
  accuracy            Float?
  attempts            Int                  @default(0)
  practiceCount       Int                  @default(0)
  masteredAt          DateTime?
  videoUrl            String?
  aiAnalysis          Json?
  instructorValidated Boolean              @default(false)
  validatedBy         String?
  validatedAt         DateTime?
  instructorNotes     String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now())
  enrollment          CourseEnrollment     @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  technique           Technique            @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, techniqueId])
  @@map("technique_progress")
}

model CourseChallenge {
  id                String              @id @default(uuid())
  courseId          String
  weekNumber        Int
  type              ChallengeType
  baseActivity      String
  baseMetric        Int
  baseTime          Int?
  description       String?
  xpReward          Int                 @default(15)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @default(now())
  challengeProgress ChallengeProgress[]
  course            Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, weekNumber])
  @@map("course_challenges")
}

model ChallengeProgress {
  id                  String           @id @default(uuid())
  studentId           String
  enrollmentId        String
  challengeId         String
  attempted           Boolean          @default(false)
  completed           Boolean          @default(false)
  actualMetric        Int?
  actualTime          Int?
  videoUrl            String?
  imageUrl            String?
  instructorValidated Boolean          @default(false)
  validatedBy         String?
  validatedAt         DateTime?
  instructorNotes     String?
  xpEarned            Int              @default(0)
  completedAt         DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @default(now())
  challenge           CourseChallenge  @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  enrollment          CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  student             Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, challengeId])
  @@map("challenge_progress")
}

model Evaluation {
  id                 String           @id @default(uuid())
  studentId          String
  instructorId       String
  enrollmentId       String
  type               EvaluationType
  lessonNumber       Int
  techniqueseTested  Json
  physicalTest       Json?
  overallScore       Float
  passed             Boolean          @default(false)
  instructorNotes    String?
  videoUrl           String?
  recommendedActions String[]
  evaluatedBy        String
  evaluatedAt        DateTime         @default(now())
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @default(now())
  enrollment         CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  instructor         Instructor       @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  student            Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("evaluations")
}

model StudentProgression {
  id                   String     @id @default(uuid())
  studentId            String
  martialArtId         String
  currentLevel         Int        @default(1)
  currentGrade         String     @default("White Belt")
  totalXP              Int        @default(0)
  techniquesLearned    Int        @default(0)
  techniquesTotal      Int        @default(0)
  classesAttended      Int        @default(0)
  evaluationsCompleted Int        @default(0)
  nextGrade            String?
  progressToNextGrade  Float      @default(0)
  estimatedTimeToNext  String?
  lastUpdated          DateTime   @default(now())
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @default(now())
  martialArt           MartialArt @relation(fields: [martialArtId], references: [id], onDelete: Cascade)
  student              Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, martialArtId])
  @@map("student_progressions")
}

model Achievement {
  id                  String               @id @default(uuid())
  organizationId      String
  martialArtId        String?
  name                String
  description         String
  category            AchievementCategory
  criteria            Json
  xpReward            Int                  @default(0)
  badgeImageUrl       String?
  rarity              AchievementRarity    @default(COMMON)
  isHidden            Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now())
  martialArt          MartialArt?          @relation(fields: [martialArtId], references: [id])
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  studentAchievements StudentAchievement[]

  @@map("achievements")
}

model StudentAchievement {
  id            String      @id @default(uuid())
  studentId     String
  achievementId String
  unlockedAt    DateTime    @default(now())
  progress      Float       @default(100)
  createdAt     DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  student       Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, achievementId])
  @@map("student_achievements")
}

model Challenge {
  id             String              @id @default(uuid())
  organizationId String
  title          String
  description    String
  type           ChallengeType
  difficulty     ChallengeDifficulty @default(EASY)
  startDate      DateTime
  endDate        DateTime
  isRecurring    Boolean             @default(false)
  recurringType  RecurringType?
  xpReward       Int                 @default(0)
  badgeReward    String?
  criteria       Json
  targetValue    Int                 @default(1)
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now())
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("challenges")
}

model StudentCourse {
  id              String           @id @default(uuid())
  studentId       String
  courseId        String
  classId         String
  paymentPlanId   String?
  startDate       DateTime         @default(now())
  expectedEndDate DateTime?
  completedDate   DateTime?
  status          EnrollmentStatus @default(ACTIVE)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @default(now())
  class           Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  paymentPlan     BillingPlan?     @relation("BillingPlanStudentCourses", fields: [paymentPlanId], references: [id])
  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, classId])
  @@map("student_courses")
}

model AttendanceRecord {
  id           String   @id @default(uuid())
  studentId    String
  classId      String
  courseId     String
  lessonNumber Int
  date         DateTime
  present      Boolean  @default(false)
  arrived_late Boolean  @default(false)
  left_early   Boolean  @default(false)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())
  class        Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, lessonNumber])
  @@map("attendance_records")
}

model Progress {
  id                  String   @id @default(uuid())
  studentId           String
  courseId            String
  lessonNumber        Int
  techniquesLearned   String[]
  challengesCompleted String[]
  points              Int      @default(0)
  reflections         String?
  progressDate        DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @default(now())
  course              Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student             Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, lessonNumber])
  @@map("progress_records")
}

model TechniqueDetail {
  id            String            @id @default(uuid())
  courseId      String
  name          String
  description   String?
  category      TechniqueCategory
  lessonNumber  Int
  instructions  String[]
  objectives    String[]
  adaptations   Json?
  orderInLesson Int               @default(1)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now())
  course        Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, lessonNumber, orderInLesson])
  @@map("technique_details")
}

model WeeklyChallenge {
  id              String   @id @default(uuid())
  courseId        String
  weekNumber      Int
  name            String
  description     String
  baseRepetitions Json
  baseTime        Int?
  pointsReward    Int      @default(15)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now())
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, weekNumber])
  @@map("weekly_challenges")
}

model EvaluationRecord {
  id                  String           @id @default(uuid())
  studentId           String
  courseId            String
  lessonNumber        Int
  techniquesEvaluated String[]
  physicalTest        String?
  physicalTestResult  String?
  simulationScenarios String[]
  simulationResults   String[]
  precision           Float?
  status              EvaluationStatus
  certificateIssued   Boolean          @default(false)
  certificateUrl      String?
  instructorNotes     String?
  evaluationDate      DateTime         @default(now())
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @default(now())
  course              Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student             Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, lessonNumber])
  @@map("evaluation_records")
}

model AttendancePattern {
  id                  String          @id @default(uuid())
  studentId           String          @unique
  totalClasses        Int             @default(0)
  attendedClasses     Int             @default(0)
  attendanceRate      Float           @default(0)
  consecutiveAbsences Int             @default(0)
  averageCheckInTime  String?
  preferredDays       String[]
  preferredTimeSlots  String[]
  recentTrend         AttendanceTrend @default(STABLE)
  trendConfidence     Float           @default(0)
  dropoutRisk         DropoutRisk     @default(LOW)
  riskFactors         String[]
  recommendations     String[]
  aiInsights          Json?
  lastAnalyzed        DateTime        @default(now())
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @default(now())
  student             Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("attendance_patterns")
}

model AsaasCustomer {
  id                     String                @id @default(uuid())
  organizationId         String
  studentId              String?               @unique
  financialResponsibleId String?               @unique
  asaasId                String                @unique
  name                   String
  cpfCnpj                String
  email                  String?
  phone                  String?
  mobilePhone            String?
  postalCode             String?
  address                String?
  addressNumber          String?
  complement             String?
  province               String?
  city                   String?
  state                  String?
  externalReference      String?
  isActive               Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student                Student?              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payments               Payment[]
  subscriptions          StudentSubscription[]

  @@map("asaas_customers")
}

model BillingPlan {
  id                      String                @id @default(uuid())
  organizationId          String
  courseId                String?
  name                    String
  description             String?
  category                StudentCategory?
  price                   Decimal               @db.Decimal(10, 2)
  billingType             BillingType           @default(MONTHLY)
  classesPerWeek          Int                   @default(2)
  maxClasses              Int?
  duration                Int? // Duração em meses
  isUnlimitedAccess       Boolean               @default(false) // Plano ilimitado
  hasPersonalTraining     Boolean               @default(false)
  hasNutrition            Boolean               @default(false)
  // Parcelamento no cartão
  allowInstallments       Boolean               @default(false)
  maxInstallments         Int                   @default(1) // Máximo 8x
  installmentInterestRate Decimal?              @db.Decimal(5, 2) // Taxa de juros (futuro)
  // Recorrência automática
  isRecurring             Boolean               @default(false)
  recurringInterval       Int? // Intervalo em dias
  // Recursos extras
  accessAllModalities     Boolean               @default(false) // Acesso a todas modalidades
  allowFreeze             Boolean               @default(true) // Permite congelar plano
  freezeMaxDays           Int                   @default(30) // Máximo de dias congelado
  // Metadata
  features                Json? // Recursos extras em JSON
  isActive                Boolean               @default(true)
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @default(now())
  // Name the primary course relation to avoid clashing with other relations
  course                  Course?               @relation("BillingPlanPrimaryCourse", fields: [courseId], references: [id])
  organization            Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  // Explicit back-relations with names to avoid ambiguity
  studentCourses          StudentCourse[]       @relation("BillingPlanStudentCourses")
  subscriptions          StudentSubscription[]  @relation("BillingPlanSubscriptions")
  // Pivot using explicit join model
  planCourses             PlanCourse[]          @relation("PlanCourseToPlan")

  @@map("billing_plans")
}

model StudentSubscription {
  id                     String                @id @default(uuid())
  organizationId         String
  studentId              String
  planId                 String
  asaasCustomerId        String?
  financialResponsibleId String?
  status                 SubscriptionStatus    @default(ACTIVE)
  startDate              DateTime              @default(now())
  endDate                DateTime?
  currentPrice           Decimal               @db.Decimal(10, 2)
  billingType            BillingType
  nextBillingDate        DateTime?
  asaasSubscriptionId    String?
  isActive               Boolean               @default(true)
  autoRenew              Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  payments               Payment[]
  asaasCustomer          AsaasCustomer?        @relation(fields: [asaasCustomerId], references: [id])
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan                   BillingPlan           @relation("BillingPlanSubscriptions", fields: [planId], references: [id])
  student                Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("student_subscriptions")
}

model Payment {
  id                     String                @id @default(uuid())
  organizationId         String
  studentId              String
  subscriptionId         String?
  asaasCustomerId        String?
  financialResponsibleId String?
  amount                 Decimal               @db.Decimal(10, 2)
  description            String
  dueDate                DateTime
  paidDate               DateTime?
  status                 PaymentStatus         @default(PENDING)
  paymentMethod          PaymentMethod?
  asaasPaymentId         String?               @unique
  asaasChargeUrl         String?
  pixCode                String?
  webhookData            Json?
  notes                  String?
  isManual               Boolean               @default(false)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now())
  asaasCustomer          AsaasCustomer?        @relation(fields: [asaasCustomerId], references: [id])
  financialResponsible   FinancialResponsible? @relation(fields: [financialResponsibleId], references: [id])
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student                Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subscription           StudentSubscription?  @relation(fields: [subscriptionId], references: [id])

  @@map("payments")
}

model FinancialSettings {
  id                 String       @id @default(uuid())
  organizationId     String       @unique
  asaasApiKey        String?
  asaasWebhookUrl    String?
  asaasWebhookToken  String?
  isSandbox          Boolean      @default(true)
  defaultBillingType BillingType  @default(MONTHLY)
  lateFeePercentage  Decimal      @default(2.0) @db.Decimal(5, 2)
  interestRate       Decimal      @default(1.0) @db.Decimal(5, 2)
  sendReminders      Boolean      @default(true)
  reminderDaysBefore Int          @default(3)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @default(now())
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("financial_settings")
}

enum SubscriptionPlan {
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum AIProvider {
  CLAUDE
  GEMINI
  OPENAI
  OPENROUTER
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  INSTRUCTOR
  STUDENT
}

enum GradingSystem {
  BELT
  LEVEL
  STRIPE
  CUSTOM
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
  MASTER
}

enum StudentCategory {
  ADULT // Adulto padrão
  FEMALE // Feminino
  SENIOR // Idoso/Senior
  CHILD // Infantil/Criança
  INICIANTE1
  INICIANTE2
  INICIANTE3
  HEROI1
  HEROI2
  HEROI3
  MASTER_1
  MASTER_2
  MASTER_3
}

enum Gender {
  MASCULINO
  FEMININO
  OUTRO
}

enum PhysicalCondition {
  INICIANTE
  REGULAR
  AVANCADO
}

enum SpecialNeed {
  TEA
  TDAH
  MOBILIDADE_REDUZIDA
  AUDITIVA
  VISUAL
}

enum EvaluationStatus {
  AUTONOMIA
  EM_DESENVOLVIMENTO
  PRECISA_INTERVENCAO
}

enum TechniqueCategory {
  STRIKING
  GRAPPLING
  DEFENSE
  SUBMISSION
  WEAPON
  FITNESS
}

enum TechniqueProficiency {
  LEARNING
  PRACTICING
  COMPETENT
  PROFICIENT
  EXPERT
  MASTERED
}

enum ClassStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  EXCUSED
}

enum CheckInMethod {
  QR_CODE
  MANUAL
  FACIAL_RECOGNITION
  GEOLOCATION
  NFC
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
  SUSPENDED
  TRANSFERRED
}

enum EvaluationType {
  GRADING
  PROGRESS
  TECHNIQUE
  SPARRING
  FITNESS
  KNOWLEDGE
}

enum EvaluationCategory {
  TECHNICAL
  PHYSICAL
  MENTAL
  BEHAVIORAL
}

enum AchievementCategory {
  ATTENDANCE
  TECHNIQUE
  PROGRESSION
  SOCIAL
  CHALLENGE
  SPECIAL
}

enum AchievementRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum ChallengeType {
  ATTENDANCE
  TECHNIQUE
  STREAK
  SOCIAL
  FITNESS
  CUSTOM
}

enum ChallengeDifficulty {
  EASY
  MEDIUM
  HARD
  EXTREME
}

enum RecurringType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
}

enum CertificateType {
  COMPLETION
  ACHIEVEMENT
  PARTICIPATION
  GRADING
}

enum BillingType {
  MONTHLY
  QUARTERLY
  YEARLY
  LIFETIME
  CREDIT_CARD_INSTALLMENT // Cartão parcelado até 8x
  RECURRING // Assinatura recorrente automática
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PIX
  BANK_TRANSFER
  CASH
  PAYPAL
  STRIPE
}

enum AttendanceTrend {
  IMPROVING
  DECLINING
  STABLE
  VOLATILE
}

enum DropoutRisk {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model PlanCourse {
  planId    String
  courseId  String
  createdAt DateTime    @default(now())
  plan      BillingPlan @relation("PlanCourseToPlan", fields: [planId], references: [id], onDelete: Cascade)
  course    Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@id([planId, courseId])
  @@map("plan_courses")
}

// ================= RAG SCHEMA (F1-01) =================
// Pivot de pré-requisitos entre técnicas (knowledge graph leve)
model TechniquePrerequisite {
  techniqueId             String
  prerequisiteTechniqueId String
  createdAt               DateTime  @default(now())
  technique               Technique @relation("TechniquePrerequisitesTechnique", fields: [techniqueId], references: [id], onDelete: Cascade)
  prerequisite            Technique @relation("TechniquePrerequisitesPrerequisite", fields: [prerequisiteTechniqueId], references: [id], onDelete: Cascade)

  @@id([techniqueId, prerequisiteTechniqueId])
  @@map("technique_prerequisite")
}

// Módulos mentais / cognitivos utilizados em planejamento de aula
model MentalModule {
  id               String   @id @default(uuid())
  name             String
  objective        String
  recommendedPhase String?
  durationMin      Int?
  tags             String[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now())

  @@unique([name])
  @@map("mental_modules")
}

// Snippets de adaptação para públicos específicos (inclusão / necessidades especiais)
model AdaptationSnippet {
  id          String   @id @default(uuid())
  audienceTag String // TEA, TDAH, mobility, etc
  text        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@index([audienceTag])
  @@map("adaptation_snippets")
}

// Chunk textual indexável – mantém texto + metadados estruturais
model RagChunk {
  id             String         @id @default(uuid())
  organizationId String?
  type           String // technique|mental_module|challenge|guideline|policy|engagement_signal
  sourceType     String? // tabela ou origem (ex: TECHNIQUE, POLICY_DOC)
  sourceId       String? // id fonte
  version        Int            @default(1)
  lang           String         @default("pt-BR")
  tags           String[]
  text           String
  hash           String         @unique // hash para idempotência / reindex
  // Opcional: armazenar embedding direto (fallback caso não use tabela separada)
  embedding      Bytes? // se usar tabela RagEmbedding preferir deixar null
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now())
  embeddings     RagEmbedding[]

  @@index([organizationId, type])
  @@index([type, version])
  @@map("rag_chunks")
}

// Metadados + vetor (pgvector). Usa Unsupported("vector") enquanto Prisma não tem tipo nativo.
model RagEmbedding {
  id           String                 @id @default(uuid())
  chunkId      String                 @unique
  provider     String // openai|anthropic|local
  modelVersion String // ex: text-embedding-3-large
  dim          Int
  vector       Unsupported("vector")? // requer extensão pgvector
  createdAt    DateTime               @default(now())
  chunk        RagChunk               @relation(fields: [chunkId], references: [id], onDelete: Cascade)

  @@map("rag_embeddings")
}

// === Generic Activity Catalog and Associations ===

enum ActivityType {
  TECHNIQUE
  STRETCH
  DRILL
  EXERCISE
  GAME
  CHALLENGE
  ASSESSMENT
}

enum LessonSegment {
  WARMUP
  STRETCH
  TECHNIQUE
  DRILL
  SIMULATION
  COOLDOWN
}

model Activity {
  id              String        @id @default(uuid())
  organizationId  String
  type            ActivityType
  title           String
  description     String?
  equipment       String[]      @default([])
  safety          String?
  adaptations     String[]      @default([])
  difficulty      Int?
  refTechniqueId  String?
  defaultParams   Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @default(now())
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  refTechnique    Technique?    @relation("ActivityTechniqueRef", fields: [refTechniqueId], references: [id], onDelete: Cascade)

  // Mappings
  lessonPlanItems  LessonPlanActivity[]
  classItems       ClassActivity[]

  @@map("activities")
}

model LessonPlanActivity {
  id            String        @id @default(uuid())
  lessonPlanId  String
  activityId    String
  segment       LessonSegment
  ord           Int           @default(1)
  params        Json?
  objectives    String?
  safetyNotes   String?
  adaptations   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @default(now())
  lessonPlan    LessonPlan    @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
  activity      Activity      @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@unique([lessonPlanId, ord])
  @@map("lesson_plan_activities")
}

model ClassActivity {
  id              String        @id @default(uuid())
  classId         String
  activityId      String
  segment         LessonSegment
  ord             Int           @default(1)
  paramsUsed      Json?
  completed       Boolean       @default(false)
  adaptationsUsed String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @default(now())
  class           Class         @relation(fields: [classId], references: [id], onDelete: Cascade)
  activity        Activity      @relation(fields: [activityId], references: [id], onDelete: Cascade)
  // Back-relations for feedback
  feedbacks       FeedbackActivity[]

  @@unique([classId, ord])
  @@map("class_activities")
}

// === Assessments and Rubrics ===

enum AssessmentType {
  TECHNICAL
  PHYSICAL
  MIXED
}

enum Metric {
  REPS
  TIME
  DISTANCE
  LOAD
}

model Rubric {
  id        String            @id @default(uuid())
  name      String
  minScore  Int               @default(0)
  maxScore  Int               @default(100)
  criteria  RubricCriterion[]
  // Back-relations
  assessments AssessmentDefinition[]

  @@map("rubrics")
}

model RubricCriterion {
  id          String   @id @default(uuid())
  rubricId    String
  name        String
  description String?
  weight      Int      @default(1)
  rubric      Rubric   @relation(fields: [rubricId], references: [id], onDelete: Cascade)

  @@map("rubric_criteria")
}

model AssessmentDefinition {
  id          String          @id @default(uuid())
  courseId    String
  name        String
  type        AssessmentType
  when        String?
  rubricId    String?
  course      Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  rubric      Rubric?         @relation(fields: [rubricId], references: [id], onDelete: Cascade)
  attempts    AssessmentAttempt[]

  @@map("assessment_definitions")
}

model AssessmentAttempt {
  id            String               @id @default(uuid())
  assessmentId  String
  studentId     String
  classId       String?
  evaluatorId   String?
  startedAt     DateTime?
  completedAt   DateTime?
  scoreTotal    Int?
  details       Json?
  assessment    AssessmentDefinition  @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  class         Class?                @relation(fields: [classId], references: [id])
  student       Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("assessment_attempts")
}

model PhysicalTestDefinition {
  id            String  @id @default(uuid())
  name          String
  metric        Metric
  targetValue   Float?
  passThreshold Float?

  attempts      PhysicalTestAttempt[]

  @@map("physical_test_definitions")
}

model PhysicalTestAttempt {
  id        String                 @id @default(uuid())
  testId    String
  studentId String
  classId   String?
  value     Float
  passed    Boolean?
  comment   String?
  test      PhysicalTestDefinition @relation(fields: [testId], references: [id], onDelete: Cascade)
  class     Class?                 @relation(fields: [classId], references: [id])
  student   Student                @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("physical_test_attempts")
}

// === Feedback, Satisfaction and Teacher Evaluation ===

model FeedbackLesson {
  id         String   @id @default(uuid())
  classId    String
  studentId  String
  rating     Int      // 1..5
  mood       String?
  comment    String?
  createdAt  DateTime @default(now())
  class      Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@map("feedback_lessons")
}

model FeedbackActivity {
  id             String         @id @default(uuid())
  classActivityId String
  studentId      String
  rating         Int
  perceivedDifficulty Int?
  comment        String?
  createdAt      DateTime       @default(now())
  classActivity  ClassActivity  @relation(fields: [classActivityId], references: [id], onDelete: Cascade)
  student        Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classActivityId, studentId])
  @@map("feedback_activities")
}

model TeacherEvaluation {
  id           String   @id @default(uuid())
  classId      String?
  courseId     String?
  studentId    String
  instructorId String
  rating       Int
  criteria     Json?
  comment      String?
  createdAt    DateTime @default(now())
  class        Class?   @relation(fields: [classId], references: [id])
  course       Course?  @relation(fields: [courseId], references: [id])
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  instructor   Instructor @relation(fields: [instructorId], references: [id])

  @@map("teacher_evaluations")
}

// === Gamification (Badges & Points) ===

model Badge {
  id         String        @id @default(uuid())
  organizationId String
  name       String
  criteria   Json?
  iconUrl    String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @default(now())
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  unlocks    BadgeUnlock[]

  @@unique([organizationId, name])
  @@map("badges")
}

model BadgeUnlock {
  id         String   @id @default(uuid())
  badgeId    String
  studentId  String
  unlockedAt DateTime @default(now())
  reason     String?
  badge      Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([badgeId, studentId])
  @@map("badge_unlocks")
}

model PointsTransaction {
  id         String   @id @default(uuid())
  studentId  String
  amount     Int
  source     String   // CHALLENGE, ATTENDANCE, ASSESSMENT, BADGE
  refType    String?
  refId      String?
  occurredAt DateTime @default(now())
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("points_transactions")
}
