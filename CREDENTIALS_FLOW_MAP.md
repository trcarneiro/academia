# ğŸ“ MAPA DE FLUXO: ONDE BUSCAM CREDENCIAIS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚                   PERGUNTA: De onde busca credenciais?                   â”‚
â”‚                                                                          â”‚
â”‚                     RESPOSTA: Banco > .env > Hardcode                    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ºï¸ MAPA VISUAL - BUSCA SEQUENCIAL

```
START: User clica "Conectar Google Ads"
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND (crm/index.js ~1400)          â”‚
â”‚ connectGoogleAds()                     â”‚
â”‚ â†’ GET /api/google-ads/auth/url         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND ROUTE (googleAds.ts:35)        â”‚
â”‚ fastify.get('/auth/url')               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  organizationId   â”‚
         â”‚  = "452c0b35..." â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  BUSCA NO BANCO #1   â”‚
        â”‚ (Linha 38)           â”‚
        â”‚                      â”‚
        â”‚ prisma.crmSettings   â”‚
        â”‚   .findUnique({      â”‚
        â”‚     where: {         â”‚
        â”‚       organizationId â”‚
        â”‚     }                â”‚
        â”‚   })                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             â”‚
    â–¼                             â–¼
ENCONTROU                    NÃƒO ENCONTROU
   â”‚                              â”‚
   â–¼                              â–¼
settings = {                ERROR
  googleAdsClientId,       return {
  googleAdsClientSecret,     success: false,
  ...                        message: 'not configured'
}                          }

   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VALIDA CREDENCIAIS                   â”‚
â”‚ if (!settings?.googleAdsClientId)    â”‚
â”‚    return error;                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ BUSCA NO .env #1    â”‚
         â”‚ (Linha 43)          â”‚
         â”‚                     â”‚
         â”‚ process.env         â”‚
         â”‚   .GOOGLE_ADS_      â”‚
         â”‚   REDIRECT_URI      â”‚
         â”‚   || fallback       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             â”‚
    â–¼                             â–¼
ENCONTROU                    NÃƒO ENCONTROU
   â”‚                              â”‚
   â–¼                              â–¼
redirectUri =              redirectUri =
process.env.GOOGLE_ADS_    'http://localhost:3000
REDIRECT_URI                /api/google-ads/auth
                            /callback'

   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CRIA SERVICE                         â”‚
â”‚ new GoogleAdsService(organizationId) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INICIALIZA OAUTH2                    â”‚
â”‚ service.initializeOAuth2(            â”‚
â”‚   settings.googleAdsClientId,      â—„â”€â”€â† USA DO BANCO
â”‚   settings.googleAdsClientSecret,  â—„â”€â”€â† USA DO BANCO
â”‚   redirectUri                      â—„â”€â”€â† USA DO .env/HARDCODE
â”‚ )                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GERA AUTH URL                        â”‚
â”‚ oauth2Client.generateAuthUrl({       â”‚
â”‚   access_type: 'offline',            â”‚
â”‚   scope: [...],                      â”‚
â”‚   prompt: 'consent'                  â”‚
â”‚ })                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RETORNA PARA FRONTEND                â”‚
â”‚ {                                    â”‚
â”‚   success: true,                     â”‚
â”‚   data: { authUrl: '...' }           â”‚
â”‚ }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND REDIRECIONA                 â”‚
â”‚ window.location.href = authUrl       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ GOOGLE.COM  â”‚
         â”‚ (User Login)â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚
      (User autoriza)
                â”‚
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ GOOGLE CALLBACK     â”‚
    â”‚ /auth/callback?     â”‚
    â”‚ code=4/0Ax8qg...   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND CALLBACK HANDLER               â”‚
â”‚ (googleAds.ts:61)                      â”‚
â”‚ fastify.get('/auth/callback')          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  BUSCA NO BANCO #2   â”‚
        â”‚ (Linha 91)           â”‚
        â”‚                      â”‚
        â”‚ prisma.crmSettings   â”‚
        â”‚   .findUnique({      â”‚
        â”‚     where: {         â”‚
        â”‚       organizationId â”‚
        â”‚     }                â”‚
        â”‚   })                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
          MESMA VALIDAÃ‡ÃƒO
          (usa settings do banco)
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TROCA CODE POR TOKENS                  â”‚
â”‚ service.getTokensFromCode(code)        â”‚
â”‚ â†’ oauth2Client.getToken(code)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        GOOGLE RETORNA
        {
          access_token: "...",
          refresh_token: "...",  â—„â”€â”€ NOVO
          expires_in: 3599
        }
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SALVA NO BANCO #1                      â”‚
â”‚ service.saveTokens(                    â”‚
â”‚   refreshToken,                        â”‚
â”‚   settings.googleAdsClientId,          â”‚
â”‚   settings.googleAdsClientSecret,      â”‚
â”‚   settings.googleAdsDeveloperToken,    â”‚
â”‚   settings.googleAdsCustomerId         â”‚
â”‚ )                                      â”‚
â”‚                                        â”‚
â”‚ â†’ crmSettings.upsert({                 â”‚
â”‚     googleAdsRefreshToken: token, â—„â”€ SALVA AQUI
â”‚     ...                                â”‚
â”‚   })                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          REDIRECIONA USER
          return reply.redirect('/');
                     â”‚
                     â–¼
            USER VOLTA AO SITE
            (OAuth completo)

---

AGORA: User clica "Sincronizar Agora"
                     â”‚
                     â–¼
         POST /api/crm/google-ads/sync
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYNC HANDLER (crm.ts ~700)             â”‚
â”‚ fastify.post('/google-ads/sync')       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CRIA SERVICE                           â”‚
â”‚ new GoogleAdsService(organizationId)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CHAMA loadConfig()                     â”‚
â”‚ service.loadConfig()                   â”‚
â”‚ (googleAdsService.ts:142)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BUSCA NO BANCO #3                      â”‚
â”‚ prisma.crmSettings.findUnique({        â”‚
â”‚   where: { organizationId }            â”‚
â”‚ })                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         this.config = {
           clientId: settings...,       â—„â”€â”€ PEGA DO BANCO
           clientSecret: settings...,   â—„â”€â”€ PEGA DO BANCO
           developerToken: settings..., â—„â”€â”€ PEGA DO BANCO
           refreshToken: settings...,   â—„â”€â”€ PEGA DO BANCO
           customerId: settings...      â—„â”€â”€ PEGA DO BANCO
         }
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INICIALIZA CLIENT                      â”‚
â”‚ service.initializeClient()             â”‚
â”‚ (googleAdsService.ts:168)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
    new GoogleAdsApi({
      client_id: this.config.clientId,
      client_secret: this.config.clientSecret,
      developer_token: this.config.developerToken,
    })
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SINCRONIZA CAMPANHAS                   â”‚
â”‚ service.syncCampaigns()                â”‚
â”‚ customer.query("SELECT ...")           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         BUSCA EM GOOGLE ADS
         (nÃ£o no banco)
                     â”‚
                     â–¼
         RETORNA CAMPANHAS
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SALVA NO BANCO #2                      â”‚
â”‚ prisma.googleAdsCampaign.upsert({...}) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         RETORNA RESULTADO
         {
           campaignsSynced: 12,
           ...
         }
                     â”‚
                     â–¼
         END: Dashboard mostra dados âœ…
```

---

## ğŸ¯ RESUMO VISUAL

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   BUSCA SEQUENCIAL       â”‚
                    â”‚   (ordem de prioridade)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                        â”‚
                    â–¼                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ BANCO DE DADOS  â”‚     â”‚  .env/.code  â”‚
            â”‚ (CrmSettings)   â”‚     â”‚  (fallback)  â”‚
            â”‚                 â”‚     â”‚              â”‚
            â”‚ âœ… PrimÃ¡rio     â”‚     â”‚ âš ï¸ SecundÃ¡rio â”‚
            â”‚ 95% uso         â”‚     â”‚ 5% uso       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             â”‚
    â–¼                             â–¼
  BUSCA                        SE VAZIO
  settings                     usa .env
  â”‚                                â”‚
  â”œâ”€ clientId                      â””â”€ REDIRECT_URI
  â”œâ”€ clientSecret                     (fallback)
  â”œâ”€ developerToken                   â”‚
  â”œâ”€ customerId                       â”‚
  â”œâ”€ refreshToken                     â””â”€ hardcoded
  â””â”€ connected                           URL

```

---

## ğŸ”— CADEIA DE DEPEDÃŠNCIAS

```
User Action
    â”‚
    â”œâ”€â†’ Frontend: crm/index.js
    â”‚           â””â”€â†’ connectGoogleAds()
    â”‚               â”‚
    â”‚               â””â”€â†’ GET /api/google-ads/auth/url
    â”‚                   â”‚
    â”‚                   â”œâ”€â†’ src/routes/googleAds.ts
    â”‚                   â”‚   â””â”€â†’ Line 38: prisma.crmSettings.findUnique() â† BANCO #1
    â”‚                   â”‚
    â”‚                   â”œâ”€â†’ src/services/googleAdsService.ts
    â”‚                   â”‚   â”œâ”€â†’ initializeOAuth2()
    â”‚                   â”‚   â”‚   â””â”€â†’ new oauth2Client()
    â”‚                   â”‚   â”‚
    â”‚                   â”‚   â””â”€â†’ getAuthorizationUrl()
    â”‚                   â”‚       â””â”€â†’ generateAuthUrl()
    â”‚                   â”‚
    â”‚                   â””â”€â†’ Return authUrl
    â”‚
    â””â”€â†’ User OAuth Login
        â”‚
        â””â”€â†’ GET /api/google-ads/auth/callback
            â”‚
            â”œâ”€â†’ src/routes/googleAds.ts
            â”‚   â””â”€â†’ Line 91: prisma.crmSettings.findUnique() â† BANCO #2
            â”‚
            â”œâ”€â†’ src/services/googleAdsService.ts
            â”‚   â”œâ”€â†’ initializeOAuth2()
            â”‚   â”‚   â””â”€â†’ getTokensFromCode()
            â”‚   â”‚       â””â”€â†’ oauth2Client.getToken()
            â”‚   â”‚
            â”‚   â””â”€â†’ saveTokens()
            â”‚       â””â”€â†’ crmSettings.upsert() â† BANCO #3 (save)
            â”‚
            â””â”€â†’ Return redirect

Sync Action
    â”‚
    â””â”€â†’ POST /api/crm/google-ads/sync
        â”‚
        â”œâ”€â†’ src/routes/crm.ts
        â”‚
        â”œâ”€â†’ new GoogleAdsService()
        â”‚
        â”œâ”€â†’ service.loadConfig()
        â”‚   â””â”€â†’ prisma.crmSettings.findUnique() â† BANCO #4
        â”‚       â””â”€â†’ Carrega config em memÃ³ria
        â”‚
        â”œâ”€â†’ service.initializeClient()
        â”‚   â””â”€â†’ new GoogleAdsApi()
        â”‚
        â”œâ”€â†’ service.syncCampaigns()
        â”‚   â””â”€â†’ customer.query() â†’ Google Ads API
        â”‚
        â””â”€â†’ prisma.googleAdsCampaign.upsert() â† BANCO #5
            â””â”€â†’ Salva campanhas
```

---

## ğŸ“Š ESTATÃSTICAS

```
Total Buscas no Banco: 5
â”œâ”€ AUTH/URL endpoint: 1
â”œâ”€ AUTH/CALLBACK endpoint: 1  
â”œâ”€ SAVETOKEN (implÃ­cita): 1
â”œâ”€ SYNC endpoint: 1 (loadConfig)
â””â”€ SYNC (implÃ­cita): 1 (upsert)

Credenciais Buscadas: 5
â”œâ”€ googleAdsClientId: Buscada em T+50, T+180, T+300
â”œâ”€ googleAdsClientSecret: Buscada em T+60, T+190, T+310
â”œâ”€ googleAdsDeveloperToken: Buscada em T+?, T+?, T+320
â”œâ”€ googleAdsCustomerId: Buscada em T+?, T+?, T+330
â””â”€ googleAdsRefreshToken: Criada em T+200, buscada em T+?, T+340

OperaÃ§Ãµes por UsuÃ¡rio:
â”œâ”€ Conectar: 2 buscas (auth/url + auth/callback)
â”œâ”€ Sincronizar: 1 busca (loadConfig)
â””â”€ Total: 3 buscas por ciclo completo
```

---

**Status**: âœ… Fluxo 100% documentado  
**Data**: 16/10/2025  
**PrÃ³ximo**: Adicionar credenciais no CRM Settings
