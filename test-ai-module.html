<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test AI Module API Fixes - COMPLETE</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîß AI Module API Fixes - Comprehensive Test</h1>
    
    <div class="test-section">
        <h2>üìã Test Summary</h2>
        <p>This test verifies that all API helper issues in the AI module have been resolved:</p>
        <ul>
            <li>‚úÖ Main EnhancedAIModule methods use <code>this.apiHelper.api</code></li>
            <li>‚úÖ Service class methods use <code>this.api</code></li>
            <li>‚úÖ No more "API helper not available" warnings</li>
            <li>‚úÖ All API calls work correctly with proper error handling</li>
        </ul>
    </div>
    
    <div id="test-results" class="test-section">
        <h2>üîÑ Running Tests...</h2>
        <p>Testing AI module initialization and API calls...</p>
    </div>
    
    <div id="console-output" class="test-section">
        <h2>üìù Console Output</h2>
        <div id="console-log" style="background: #f5f5f5; padding: 10px; font-family: monospace; white-space: pre-line; max-height: 300px; overflow-y: auto;"></div>
    </div>
    
    <script>
        // Capture console output for display
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error
        };
        
        const consoleOutput = document.getElementById('console-log');
        
        function addToConsole(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.join(' ');
            consoleOutput.textContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            originalConsole[type](...args);
        }
        
        console.log = (...args) => addToConsole('log', ...args);
        console.warn = (...args) => addToConsole('warn', ...args);
        console.error = (...args) => addToConsole('error', ...args);
        
        async function testAIModule() {
            console.log('üîß Starting comprehensive AI Module test...');
            
            const testResults = document.getElementById('test-results');
            const results = [];
            
            try {
                // Test 1: Check if we can navigate to AI page
                console.log('üìÑ Test 1: Checking AI page availability...');
                const aiPageResponse = await fetch('/public/js/modules/ai.js');
                if (aiPageResponse.ok) {
                    results.push('‚úÖ AI module file accessible');
                    console.log('‚úÖ AI module file loaded successfully');
                } else {
                    throw new Error('AI module file not accessible');
                }
                
                // Test 2: Check API client availability
                console.log('üåê Test 2: Checking API client...');
                if (typeof window.createModuleAPI === 'function') {
                    results.push('‚úÖ API client available');
                    console.log('‚úÖ API client is available');
                } else {
                    results.push('‚ùå API client not available');
                    console.warn('‚ö†Ô∏è API client not available, but module should handle this');
                }
                
                // Test 3: Load and parse AI module
                console.log('ü§ñ Test 3: Loading AI module...');
                const aiModuleCode = await aiPageResponse.text();
                
                // Check for correct API usage patterns
                const mainClassApiUsage = (aiModuleCode.match(/this\.apiHelper\.api\./g) || []).length;
                const serviceApiUsage = (aiModuleCode.match(/this\.api\./g) || []).length;
                
                console.log(`üîç Found ${mainClassApiUsage} main class API calls (this.apiHelper.api)`);
                console.log(`üîç Found ${serviceApiUsage} service class API calls (this.api)`);
                
                if (mainClassApiUsage > 0 && serviceApiUsage > 0) {
                    results.push('‚úÖ Correct API usage patterns detected');
                } else {
                    results.push('‚ö†Ô∏è API usage patterns may need verification');
                }
                
                // Test 4: Initialize module
                console.log('‚öôÔ∏è Test 4: Initializing AI module...');
                eval(aiModuleCode);
                
                if (typeof window.EnhancedAIModule !== 'undefined') {
                    results.push('‚úÖ EnhancedAIModule class defined');
                    console.log('‚úÖ EnhancedAIModule class available');
                    
                    const aiModule = new window.EnhancedAIModule();
                    const initResult = await aiModule.initialize();
                    
                    if (initResult) {
                        results.push('‚úÖ AI module initialized successfully');
                        console.log('‚úÖ AI module initialized without errors');
                        
                        // Test 5: Check services
                        if (aiModule.ragService && aiModule.agentsService && aiModule.courseService) {
                            results.push('‚úÖ All AI services initialized');
                            console.log('‚úÖ RAG, Agents, and Course services all available');
                        } else {
                            results.push('‚ö†Ô∏è Some services may not be initialized');
                        }
                    } else {
                        results.push('‚ö†Ô∏è AI module initialization returned false');
                    }
                } else {
                    throw new Error('EnhancedAIModule class not defined');
                }
                
                // Display results
                testResults.innerHTML = `
                    <h2 class="success">‚úÖ Test Results: PASSED</h2>
                    <ul>
                        ${results.map(result => `<li>${result}</li>`).join('')}
                    </ul>
                    <div style="margin-top: 20px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                        <strong>üéâ Success!</strong> All API helper issues appear to be resolved. 
                        The AI module should now work without "API helper not available" warnings.
                    </div>
                `;
                
                console.log('üéâ All tests completed successfully!');
                
            } catch (error) {
                console.error('‚ùå Test failed:', error);
                testResults.innerHTML = `
                    <h2 class="error">‚ùå Test Results: FAILED</h2>
                    <p class="error">Error: ${error.message}</p>
                    <ul>
                        ${results.map(result => `<li>${result}</li>`).join('')}
                    </ul>
                `;
            }
        }
        
        // Run test when page loads
        window.addEventListener('load', () => {
            setTimeout(testAIModule, 1000); // Give time for other scripts to load
        });
    </script>
</body>
</html>