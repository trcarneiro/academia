<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ¥‹ Krav Maga Academy - Dashboard</title>
    
    <!-- ðŸ”Œ CARREGADOR DE MÃ“DULOS ISOLADOS - Inline para evitar cache issues -->
    <script>
        // Inline module loader to avoid 404 cache issues
        window.ModuleLoader = {
            loadedModules: new Map(),
            isModuleLoaded: function(moduleName) {
                return this.loadedModules.has(moduleName);
            },
            getLoadedModules: function() {
                return Array.from(this.loadedModules.keys());
            }
        };
        console.log('âœ… Module loader initialized inline');
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #0A0E1A;
            color: #E2E8F0;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* UX-Enhanced Dashboard Layout */
        .dashboard-container {
            display: grid;
            grid-template-areas: 
                "header header header"
                "sidebar main widgets"
                "sidebar main widgets";
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 80px 1fr auto;
            min-height: 100vh;
            gap: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .dashboard-container.collapsed {
            grid-template-columns: 80px 1fr 320px;
        }
        
        .dashboard-container.mobile {
            grid-template-areas: 
                "header"
                "main"
                "widgets";
            grid-template-columns: 1fr;
            grid-template-rows: 80px 1fr auto;
        }
        
        /* UX-Enhanced Header */
        .dashboard-header {
            grid-area: header;
            background: linear-gradient(135deg, #1E293B 0%, #334155 100%);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            backdrop-filter: blur(20px);
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: #3B82F6;
        }
        
        .header-ai-status {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .quick-action-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3B82F6;
            color: #3B82F6;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .quick-action-btn:hover {
            background: #3B82F6;
            color: white;
            transform: translateY(-1px);
        }
        
        /* UX-Enhanced Sidebar */
        .dashboard-sidebar {
            grid-area: sidebar;
            background: linear-gradient(180deg, #1E293B 0%, #0F172A 100%);
            border-right: 1px solid rgba(148, 163, 184, 0.1);
            padding: 1.5rem 0;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .sidebar-section {
            margin-bottom: 2rem;
        }
        
        .sidebar-title {
            color: #94A3B8;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0 1.5rem;
            margin-bottom: 1rem;
        }
        
        .logo {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
        }
        
        .logo h1 {
            color: #3B82F6;
            font-size: 1.5rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* UX-Enhanced Navigation */
        .nav-menu {
            list-style: none;
            padding: 0;
        }
        
        .nav-item {
            margin-bottom: 0.25rem;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            color: #94A3B8;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-weight: 500;
            position: relative;
            border-radius: 0 25px 25px 0;
            margin-right: 1rem;
        }
        
        .nav-link:before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: transparent;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
            transform: translateX(8px);
        }
        
        .nav-link:hover:before {
            background: #3B82F6;
        }
        
        .nav-link.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1));
            color: #3B82F6;
            transform: translateX(8px);
        }
        
        .nav-link.active:before {
            background: #3B82F6;
        }
        
        .nav-link.active .nav-icon {
            color: #3B82F6;
        }
        
        /* AI Agent Integration Indicators */
        .nav-link[data-ai-enabled="true"]:after {
            content: 'ðŸ¤–';
            font-size: 0.75rem;
            opacity: 0.7;
            margin-left: auto;
        }
        
        .nav-icon {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        /* UX-Enhanced Main Content Area */
        .dashboard-main {
            grid-area: main;
            background: #0F172A;
            padding: 2rem;
            overflow-y: auto;
            position: relative;
        }
        
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .main-title {
            font-size: 2rem;
            font-weight: 700;
            color: #F8FAFC;
            margin: 0;
        }
        
        .main-subtitle {
            color: #94A3B8;
            margin-top: 0.5rem;
            font-size: 1rem;
        }
        
        .ai-insights-banner {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 2rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .ai-insights-icon {
            font-size: 1.5rem;
        }
        
        .ai-insights-content h4 {
            margin: 0 0 0.25rem 0;
            font-weight: 600;
        }
        
        .ai-insights-content p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.875rem;
        }
        
        /* UX-Enhanced Widgets Sidebar */
        .dashboard-widgets {
            grid-area: widgets;
            background: linear-gradient(180deg, #0F172A 0%, #1E293B 100%);
            border-left: 1px solid rgba(148, 163, 184, 0.1);
            padding: 2rem 1.5rem;
            overflow-y: auto;
        }
        
        .widget {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .widget:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .widget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .widget-title {
            font-size: 1rem;
            font-weight: 600;
            color: #F8FAFC;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .widget-action {
            background: none;
            border: none;
            color: #94A3B8;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .widget-action:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
        }
        
        /* Smart Badges */
        .badge {
            background: #EF4444;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: auto;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .badge.success {
            background: linear-gradient(135deg, #10B981, #059669);
        }
        
        .badge.warning {
            background: linear-gradient(135deg, #F59E0B, #D97706);
        }
        
        .badge.info {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
        }
        
        .badge.ai-powered {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* AI-Enhanced Cards and Components */
        .smart-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.6));
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .smart-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .smart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #3B82F6, #8B5CF6, #10B981);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .smart-card:hover::before {
            opacity: 1;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.6));
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #3B82F6;
            margin-bottom: 0.5rem;
            line-height: 1;
        }
        
        .metric-label {
            color: #94A3B8;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .metric-trend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .metric-trend.positive {
            color: #10B981;
        }
        
        .metric-trend.negative {
            color: #EF4444;
        }
        
        /* AI Agent Status Widget */
        .ai-agent-widget {
            background: linear-gradient(145deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .ai-agent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .ai-agent-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: #8B5CF6;
        }
        
        .ai-agent-status {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .ai-agent-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .ai-agent-item {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 8px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ai-agent-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .ai-agent-name {
            font-weight: 500;
            color: #F8FAFC;
            font-size: 0.875rem;
        }
        
        .ai-agent-type {
            color: #94A3B8;
            font-size: 0.75rem;
        }
        
        .ai-agent-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10B981;
            animation: pulse 2s infinite;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 280px 1fr;
                grid-template-areas: 
                    "header header"
                    "sidebar main";
            }
            
            .dashboard-widgets {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-areas: 
                    "header"
                    "main";
            }
            
            .dashboard-sidebar {
                position: fixed;
                left: -280px;
                top: 80px;
                bottom: 0;
                width: 280px;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            
            .dashboard-sidebar.open {
                left: 0;
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-main {
                padding: 1rem;
            }
        }
        
        .upload-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: rgba(55, 65, 81, 0.5);
            color: #CBD5E1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .upload-tab:hover {
            background: rgba(59, 130, 246, 0.2);
            color: #F8FAFC;
        }
        
        .upload-tab.active {
            background: #3B82F6;
            color: white;
        }
        
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #F8FAFC;
            margin-bottom: 0.5rem;
        }
        
        .page-header p {
            color: #CBD5E1;
            font-size: 1rem;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #3B82F6, #10B981);
        }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 35px 60px -12px rgba(0, 0, 0, 0.35);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #F8FAFC;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #CBD5E1;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .data-table {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .table-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #F8FAFC;
        }
        
        .students-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .students-table th,
        .students-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .students-table th {
            background: rgba(59, 130, 246, 0.1);
            color: #F8FAFC;
            font-weight: 600;
        }
        
        .students-table td {
            color: #CBD5E1;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
        }
        
        .status-inactive {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #CBD5E1;
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #CBD5E1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }
        
        .table-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #F8FAFC;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #CBD5E1;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            color: #F8FAFC;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #F8FAFC;
            font-size: 1rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3B82F6;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #F8FAFC;
            font-size: 1rem;
        }
        
        .form-select:focus {
            outline: none;
            border-color: #3B82F6;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Student Modal Styles */
        .large-modal {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-section h3 {
            margin: 0 0 1rem 0;
            color: #F8FAFC;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            margin-bottom: 0.5rem;
            color: #CBD5E1;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #F8FAFC;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3B82F6;
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-group input[readonly] {
            background: rgba(255, 255, 255, 0.02);
            color: #94A3B8;
            cursor: not-allowed;
        }
        
        .form-group select[multiple] {
            min-height: 100px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Course Selection Styles */
        .courses-selection-container {
            margin-top: 1rem;
        }
        
        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .selection-stats {
            display: flex;
            gap: 1rem;
        }
        
        .stat-badge {
            background: rgba(59, 130, 246, 0.1);
            color: #60A5FA;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .selection-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid rgba(148, 163, 184, 0.3);
            color: #94A3B8;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .btn-outline:hover {
            background: rgba(148, 163, 184, 0.1);
            border-color: rgba(148, 163, 184, 0.5);
        }
        
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .course-card {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .course-card:hover {
            background: rgba(15, 23, 42, 0.7);
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        
        .course-card.selected {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3B82F6;
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);
        }
        
        .course-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .course-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #3B82F6;
            cursor: pointer;
        }
        
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #94A3B8;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(148, 163, 184, 0.2);
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
        }
        
        /* Simple Student Table for Check-in */
        .students-table-container {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1rem;
            overflow-x: auto;
        }
        
        .students-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .students-table th,
        .students-table td {
            padding: 1rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            white-space: nowrap;
        }
        
        .students-table th {
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .students-table td {
            color: #E2E8F0;
        }
        
        /* Enhanced Plan Management Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes glow {
            0%, 100% { 
                box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); 
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.6), 0 0 30px rgba(59, 130, 246, 0.4); 
                transform: scale(1.02);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Plan Card Hover Effects */
        .plan-card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .plan-card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        /* Enhanced Button Styles */
        .btn-primary-gradient {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            transition: all 0.2s ease;
        }
        
        .btn-primary-gradient:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-success-gradient {
            background: linear-gradient(135deg, #10B981, #059669);
            transition: all 0.2s ease;
        }
        
        .btn-success-gradient:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        
        /* Loading States */
        .loading-shimmer {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.1) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* Plan Selection Visual Feedback */
        .plan-selected {
            border-color: #10B981 !important;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        /* Responsive Grid Enhancements */
        .plans-grid-responsive {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1rem 0;
        }
        
        @media (max-width: 768px) {
            .plans-grid-responsive {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        .students-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .student-matricula {
            font-family: 'Courier New', monospace;
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .student-cpf {
            font-family: 'Courier New', monospace;
            color: #94A3B8;
            font-size: 0.85rem;
        }
        
        .student-name-cell {
            max-width: 200px;
        }
        
        .student-name {
            font-weight: 600;
            color: #F8FAFC;
            margin-bottom: 0.25rem;
        }
        
        .student-email {
            color: #94A3B8;
            font-size: 0.8rem;
        }
        
        .action-btn {
            background: none;
            border: 1px solid;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-right: 0.5rem;
        }
        
        .action-btn.checkin {
            color: #10B981;
            border-color: #10B981;
        }
        
        .action-btn.checkin:hover {
            background: #10B981;
            color: white;
        }
        
        .action-btn.view {
            color: #3B82F6;
            border-color: #3B82F6;
        }
        
        .action-btn.view:hover {
            background: #3B82F6;
            color: white;
        }
        
        .action-btn.edit {
            color: #F59E0B;
            border-color: #F59E0B;
        }
        
        .action-btn.edit:hover {
            background: #F59E0B;
            color: white;
        }
        
        .responsible-cell {
            min-width: 150px;
        }
        
        .responsible-name {
            font-weight: 600;
            color: #E2E8F0;
            font-size: 0.875rem;
        }
        
        .responsible-type {
            font-size: 0.75rem;
            color: #94A3B8;
            margin-top: 0.25rem;
        }
        
        /* Financial Module Styles */
        .financial-tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 1rem;
        }
        
        .financial-tab {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #CBD5E1;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .financial-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #E2E8F0;
        }
        
        .financial-tab.active {
            background: linear-gradient(135deg, #3B82F6, #10B981);
            color: white;
            border-color: transparent;
        }
        
        .financial-tab-content {
            display: none;
        }
        
        .financial-tab-content.active {
            display: block;
        }
        
        .settings-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid rgba(51, 65, 85, 0.8);
        }
        
        .settings-section h3 {
            color: #E2E8F0;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        /* Form checkbox styles */
        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            color: #E2E8F0;
            font-size: 0.875rem;
        }
        
        .form-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3B82F6;
            cursor: pointer;
        }
        
        .checkmark {
            /* Custom checkbox styling if needed */
        }
        
        /* Modern Students Grid */
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        /* Simple Search Bar */
        .simple-search {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 300px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: #F8FAFC;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s ease;
        }
        
        .search-input:focus {
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .search-input::placeholder {
            color: #94A3B8;
        }
        
        .view-toggle {
            display: flex;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 8px;
            padding: 0.25rem;
            gap: 0.25rem;
        }
        
        .view-toggle button {
            background: none;
            border: none;
            color: #94A3B8;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        
        .view-toggle button.active {
            background: #3B82F6;
            color: white;
        }
        
        .student-card {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .student-card:hover {
            transform: translateY(-4px);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.2);
        }

        .student-card:hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3B82F6, #10B981);
            border-radius: 16px 16px 0 0;
        }

        .student-card:active {
            transform: translateY(-2px) scale(0.98);
            border-color: rgba(16, 185, 129, 0.8);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        }

        .student-card:hover .click-hint {
            opacity: 1;
        }

        /* Table row styling */
        .student-table-row {
            transition: all 0.3s ease;
        }

        .student-table-row:hover {
            background: rgba(59, 130, 246, 0.05) !important;
            border-left: 3px solid #3B82F6;
            transform: translateX(2px);
        }

        .student-table-row:hover .table-click-hint {
            opacity: 1;
        }

        .student-table-row:active {
            background: rgba(16, 185, 129, 0.1) !important;
            border-left: 3px solid #10B981;
        }
        
        /* Prevent actions cell from triggering row events */
        .actions-cell {
            pointer-events: auto;
        }
        
        .actions-cell button {
            pointer-events: auto;
        }
        
        .student-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6, #10B981);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            margin-right: 1rem;
        }
        
        .student-info {
            flex: 1;
        }
        
        .student-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #F8FAFC;
            margin-bottom: 0.25rem;
        }
        
        .student-matricula {
            font-size: 0.875rem;
            color: #3B82F6;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .student-email {
            font-size: 0.875rem;
            color: #CBD5E1;
            margin-bottom: 0.5rem;
        }
        
        .student-status {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
        .student-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .student-stat {
            text-align: center;
        }
        
        .student-stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #10B981;
            display: block;
        }
        
        .student-stat-label {
            font-size: 0.75rem;
            color: #94A3B8;
            margin-top: 0.25rem;
        }
        
        .student-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-student {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-student-primary {
            background: linear-gradient(135deg, #3B82F6, #10B981);
            color: white;
        }
        
        .btn-student-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-student-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #CBD5E1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-student-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .loading-state, .empty-state {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; }
            .main-content { padding: 1rem; }
            .stats-grid { grid-template-columns: 1fr; }
            
            .large-modal {
                max-width: 95vw;
                margin: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .modal-footer {
                flex-direction: column-reverse;
            }
            
            .students-grid {
                grid-template-columns: 1fr;
            }
            
            .student-stats {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
        
        /* ========================================
           COURSES SELECTION STYLES
           ======================================== */
        
        .courses-selection-container {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .course-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }
        
        .course-card.selected {
            border-color: #3B82F6 !important;
            background: rgba(59, 130, 246, 0.1) !important;
            transform: scale(1.02) !important;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        }
        
        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .selection-stats {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .stat-badge {
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .selection-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid #3B82F6;
            color: #3B82F6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-outline:hover {
            background: #3B82F6;
            color: white;
        }
        
        /* ========================================
           STUDENT TABLE EVENT HANDLING STYLES
           ======================================== */
        
        /* Ensure action buttons are always clickable */
        .actions-cell {
            pointer-events: auto !important;
            position: relative;
            z-index: 10;
        }
        
        .actions-cell .action-btn {
            pointer-events: auto !important;
            cursor: pointer !important;
            z-index: 15;
            position: relative;
        }
        
        /* Student table row styling */
        .student-table-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .student-table-row:hover {
            background-color: rgba(59, 130, 246, 0.05) !important;
        }
        
        .student-table-row.row-selected {
            background-color: rgba(16, 185, 129, 0.1) !important;
        }
        
        /* Action button styling */
        .action-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3B82F6;
            color: #3B82F6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 0 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            pointer-events: auto;
        }
        
        .action-btn:hover {
            background: #3B82F6;
            color: white;
            transform: translateY(-1px);
        }
        
        .action-btn.checkin {
            border-color: #10B981;
            color: #10B981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .action-btn.checkin:hover {
            background: #10B981;
            color: white;
        }
        
        .action-btn.edit {
            border-color: #F59E0B;
            color: #F59E0B;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .action-btn.edit:hover {
            background: #F59E0B;
            color: white;
        }
        
        /* Prevent text selection on table rows */
        .student-table-row {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Ensure proper event propagation */
        .student-table-row * {
            pointer-events: auto;
        }
        
        .table-click-hint {
            pointer-events: none !important;
        }
        
        /* Plan Modal Tabs CSS */
        .plan-tabs {
            display: flex;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px 12px 0 0;
            padding: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .plan-tab {
            flex: 1;
            background: transparent;
            border: none;
            color: #94A3B8;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            position: relative;
        }
        
        .plan-tab:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #E2E8F0;
        }
        
        .plan-tab.active {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .plan-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .plan-tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .tab-header h3 {
            color: #3B82F6;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }
        
        .tab-header p {
            color: #94A3B8;
            margin: 0;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-hint {
            color: #94A3B8;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: block;
        }
        
        .tab-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .tab-navigation .btn {
            min-width: 200px;
        }
        
        /* Courses Selection Styles */
        .courses-selection-container {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .selection-stats {
            display: flex;
            gap: 1rem;
        }
        
        .stat-badge {
            background: rgba(59, 130, 246, 0.2);
            color: #3B82F6;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .selection-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid #3B82F6;
            color: #3B82F6;
        }
        
        .btn-outline:hover {
            background: #3B82F6;
            color: white;
        }
        
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .course-card {
            background: rgba(51, 65, 85, 0.6);
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .course-card:hover {
            border-color: #3B82F6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .course-card.selected {
            border-color: #10B981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .course-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .course-checkbox {
            width: 20px;
            height: 20px;
            margin: 0;
        }
        
        .extras-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #E2E8F0;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.2s ease;
        }
        
        .checkbox-label:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .checkbox-label input[type="checkbox"] {
            margin: 0;
        }
        
        /* Preview Styles */
        .preview-container {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .preview-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.1));
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
        }
        
        .preview-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .preview-header h4 {
            color: #3B82F6;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .preview-price {
            font-size: 2rem;
            font-weight: bold;
            color: #10B981;
        }
        
        .preview-body p {
            color: #CBD5E1;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .preview-details {
            display: grid;
            gap: 0.75rem;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .detail-label {
            color: #94A3B8;
            font-weight: 500;
        }
        
        .detail-value {
            color: #E2E8F0;
            font-weight: 600;
        }
        
        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .loading-state {
            text-align: center;
            color: #94A3B8;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(148, 163, 184, 0.2);
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Enhanced Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <div class="header-title">
                    <span>ðŸ¥‹</span>
                    Krav Academy
                </div>
                <div class="header-ai-status">
                    <span>ðŸ¤–</span>
                    5 Agentes Ativos
                </div>
            </div>
            <div class="header-actions">
                <button class="quick-action-btn" onclick="toggleSidebar()">
                    â˜° Menu
                </button>
            </div>
        </header>

        <!-- Enhanced Sidebar -->
        <aside class="dashboard-sidebar" id="dashboardSidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">GestÃ£o Principal</div>
                <nav>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <button class="nav-link active" data-page="dashboard" data-ai-enabled="true">
                                <span class="nav-icon">ðŸ“Š</span>
                                Dashboard IA
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="students" data-ai-enabled="true">
                                <span class="nav-icon">ðŸ‘¥</span>
                                Alunos
                                <span class="badge info" id="students-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="courses" data-ai-enabled="true">
                                <span class="nav-icon">ðŸ“š</span>
                                Cursos
                                <span class="badge info" style="font-size: 0.6rem;">MÃ‰TODO</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="classes" data-ai-enabled="true">
                                <span class="nav-icon">ðŸ«</span>
                                Turmas
                                <span class="badge success" id="classes-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="quick-checkin">
                                <span class="nav-icon">âš¡</span>
                                Check-in RÃ¡pido
                                <span class="badge warning">NOVO</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="attendance">
                                <span class="nav-icon">ðŸ“‹</span>
                                FrequÃªncia
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="evaluations" data-ai-enabled="true">
                                <span class="nav-icon">ðŸ“</span>
                                AvaliaÃ§Ãµes
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="progress">
                                <span class="nav-icon">ðŸ“ˆ</span>
                                Progresso
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="financial" data-ai-enabled="false">
                                <span class="nav-icon">ðŸ’°</span>
                                GestÃ£o Financeira
                                <span class="badge info" id="financial-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="financial-responsibles" data-ai-enabled="false">
                                <span class="nav-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</span>
                                ResponsÃ¡veis
                                <span class="badge info" id="responsibles-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="payment-plans" data-ai-enabled="false">
                                <span class="nav-icon">ðŸ“„</span>
                                Planos da Academia
                                <span class="badge info" id="plans-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="subscriptions" data-ai-enabled="true">
                                <span class="nav-icon">ðŸ’³</span>
                                Assinaturas
                                <span class="badge info" id="subscriptions-count">0</span>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Infraestrutura</div>
                <nav>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <button class="nav-link" data-page="units" data-ai-enabled="false">
                                <span class="nav-icon">ðŸ¢</span>
                                Unidades
                                <span class="badge info" id="units-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="mats" data-ai-enabled="false">
                                <span class="nav-icon">ðŸ¥‹</span>
                                Tatames
                                <span class="badge info" id="mats-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="instructors" data-ai-enabled="false">
                                <span class="nav-icon">ðŸ‘¨â€ðŸ«</span>
                                Professores
                                <span class="badge info" id="instructors-count">0</span>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Agentes IA</div>
                <nav>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <button class="nav-link" data-page="course-creator" data-ai-enabled="true">
                                <span class="nav-icon">ðŸŽ“</span>
                                Course Creator
                                <span class="badge ai-powered">AI</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="lesson-planner" data-ai-enabled="true">
                                <span class="nav-icon">ðŸ“‹</span>
                                Lesson Planner
                                <span class="badge ai-powered">AI</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="technique-auditor" data-ai-enabled="true">
                                <span class="nav-icon">ðŸ”</span>
                                Tech Auditor
                                <span class="badge ai-powered">AI</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="knowledge-base" data-ai-enabled="true">
                                <span class="nav-icon">ðŸ§ </span>
                                Base RAG
                                <span class="badge success">RAG</span>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Ferramentas</div>
                <nav>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <button class="nav-link" data-page="student-portal">
                                <span class="nav-icon">ðŸŽ¯</span>
                                Portal do Aluno
                                <span class="badge warning">NOVO</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="public-checkin">
                                <span class="nav-icon">ðŸ“Ÿ</span>
                                Check-in Kiosk
                                <span class="badge warning">KIOSK</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-page="settings">
                                <span class="nav-icon">âš™ï¸</span>
                                ConfiguraÃ§Ãµes
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>

        <!-- Enhanced Main Content -->
        <main class="dashboard-main" id="dashboardMain">
            <!-- Dynamic Main Header -->
            <div class="main-header">
                <div>
                    <h1 class="main-title" id="mainTitle">Dashboard</h1>
                    <p class="main-subtitle" id="mainSubtitle">Sistema de gestÃ£o da academia</p>
                </div>
            </div>

            <!-- Content Sections Container -->
            <div id="contentContainer">
                <!-- Dashboard -->
                <div id="dashboard" class="content-section active">
                    <!-- Enhanced Metrics Grid -->
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="total-students">4</div>
                            <div class="metric-label">Total de Alunos</div>
                            <div class="metric-trend positive">
                                <span>â†—</span> +2 este mÃªs
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="active-students">4</div>
                            <div class="metric-label">Alunos Ativos</div>
                            <div class="metric-trend positive">
                                <span>â†—</span> 100% taxa
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="attendance-rate">85%</div>
                            <div class="metric-label">Taxa de FrequÃªncia</div>
                            <div class="metric-trend positive">
                                <span>â†—</span> +5% vs mÃªs anterior
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="current-lesson">15/48</div>
                            <div class="metric-label">Progresso do Curso</div>
                            <div class="metric-trend positive">
                                <span>â†—</span> 31% completo
                            </div>
                        </div>
                    </div>
                    
                    <!-- Activity Cards -->
                    <div class="smart-card">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>ðŸ“Š</span> Atividades Recentes
                        </h3>
                        <div style="color: #CBD5E1; line-height: 1.6;">
                            <p style="margin: 0.5rem 0;">ðŸŽ¯ <strong>Aula 15 - Defesas BÃ¡sicas</strong> (Hoje)</p>
                            <p style="margin: 0.5rem 0;">ðŸ“ <strong>AvaliaÃ§Ã£o Maria Silva</strong> - 85.5% (Ontem)</p>
                            <p style="margin: 0.5rem 0;">ðŸ‘¤ <strong>Novo aluno: Carlos Rodrigues</strong> (2 dias atrÃ¡s)</p>
                            <p style="margin: 0.5rem 0;">ðŸ¥‹ <strong>TÃ©cnica dominada: Ana Oliveira</strong> - 5 tÃ©cnicas (3 dias atrÃ¡s)</p>
                        </div>
                    </div>
                </div>
        
        <!-- Students -->
        <div id="students" class="content-section">
            <div class="page-header">
                <h1>ðŸ‘¥ GestÃ£o de Alunos</h1>
                <p>Cadastro e acompanhamento completo dos alunos</p>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">Total de Alunos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeStudents">0</div>
                    <div class="stat-label">Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgAttendance">0%</div>
                    <div class="stat-label">FrequÃªncia MÃ©dia</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="newThisMonth">0</div>
                    <div class="stat-label">Novos Este MÃªs</div>
                </div>
            </div>

            <!-- Simple Search Bar -->
            <div class="simple-search">
                <input type="text" 
                       id="studentSearch" 
                       class="search-input"
                       placeholder="ðŸ” Buscar por nome, CPF, matrÃ­cula ou email..." 
                       onkeyup="filterStudentsSimple()"
                       autocomplete="off">
                
                <div class="view-toggle">
                    <button id="tableViewBtn" class="active" onclick="switchView('table')">
                        ðŸ“‹ Tabela
                    </button>
                    <button id="gridViewBtn" onclick="switchView('grid')">
                        ðŸŽ¯ Cards
                    </button>
                </div>
                
                <button class="btn btn-primary" onclick="openAddStudentModal()">
                    <span>âž•</span>
                    Novo Aluno
                </button>
            </div>
            
            <!-- Students Views Container -->
            <div id="studentsContainer">
                <!-- Table View for Easy Check-in -->
                <div id="studentsTableView" class="students-table-container">
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>MatrÃ­cula</th>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Categoria</th>
                                <th>ResponsÃ¡vel Financeiro</th>
                                <th>Status</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Grid View (Cards) -->
                <div id="studentsGrid" class="students-grid" style="display: none;">
                    <!-- Students cards will be loaded here -->
                </div>
                <div id="studentsLoadingState" class="loading-state">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“‹</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando alunos...</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                    </div>
                </div>
                <div id="studentsEmptyState" class="empty-state" style="display: none;">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸŽ¯</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhum aluno encontrado</div>
                        <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece adicionando o primeiro aluno Ã  academia</div>
                        <button class="btn btn-primary" onclick="openAddStudentModal()">
                            <span>âž•</span>
                            Adicionar Primeiro Aluno
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Details Modal -->
        <div id="studentDetailsModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
            <div class="modal-content" style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); margin: 2% auto; padding: 0; border-radius: 16px; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; border: 1px solid #334155;">
                <!-- Modal Header -->
                <div style="background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); padding: 1.5rem 2rem; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0; color: white; font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>ðŸ‘¤</span>
                            <span id="modalStudentName">Detalhes do Aluno</span>
                        </h2>
                        <p style="margin: 0.5rem 0 0 0; color: rgba(255,255,255,0.8); font-size: 0.875rem;" id="modalStudentId">ID: -</p>
                    </div>
                    <button onclick="closeStudentModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem; border-radius: 8px; cursor: pointer; font-size: 1.5rem; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        âœ•
                    </button>
                </div>

                <!-- Student Info Summary -->
                <div style="padding: 1.5rem 2rem; background: rgba(59, 130, 246, 0.05); border-bottom: 1px solid #334155;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div style="text-align: center;">
                            <div style="color: #3B82F6; font-size: 1.25rem; font-weight: bold;" id="modalStudentStatus">Ativo</div>
                            <div style="color: #94A3B8; font-size: 0.875rem;">Status</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #10B981; font-size: 1.25rem; font-weight: bold;" id="modalStudentCategory">ADULTO</div>
                            <div style="color: #94A3B8; font-size: 0.875rem;">Categoria</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #F59E0B; font-size: 1.25rem; font-weight: bold;" id="modalStudentClasses">2</div>
                            <div style="color: #94A3B8; font-size: 0.875rem;">Turmas</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #8B5CF6; font-size: 1.25rem; font-weight: bold;" id="modalStudentAttendance">85%</div>
                            <div style="color: #94A3B8; font-size: 0.875rem;">FrequÃªncia</div>
                        </div>
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <div style="padding: 0 2rem; background: #1E293B; border-bottom: 1px solid #334155;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="student-tab-btn active" onclick="switchStudentTab('financial')" data-tab="financial" style="padding: 1rem 1.5rem; background: transparent; border: none; color: #3B82F6; border-bottom: 2px solid #3B82F6; font-weight: 600; cursor: pointer;">
                            ðŸ“‹ Planos
                        </button>
                        <button class="student-tab-btn" onclick="switchStudentTab('courses')" data-tab="courses" style="padding: 1rem 1.5rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 600; cursor: pointer;">
                            ðŸ’³ Assinatura
                        </button>
                        <button class="student-tab-btn" onclick="switchStudentTab('classes')" data-tab="classes" style="padding: 1rem 1.5rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 600; cursor: pointer;">
                            ðŸ« Turmas
                        </button>
                        <button class="student-tab-btn" onclick="switchStudentTab('progress')" data-tab="progress" style="padding: 1rem 1.5rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 600; cursor: pointer;">
                            ðŸ“ˆ Progresso
                        </button>
                        <button class="student-tab-btn" onclick="switchStudentTab('attendance')" data-tab="attendance" style="padding: 1rem 1.5rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 600; cursor: pointer;">
                            ðŸ“Š FrequÃªncia
                        </button>
                        <button class="student-tab-btn" onclick="switchStudentTab('history')" data-tab="history" style="padding: 1rem 1.5rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 600; cursor: pointer;">
                            ðŸ“œ HistÃ³rico
                        </button>
                        <button class="student-tab-btn" onclick="switchStudentTab('basic')" data-tab="basic" style="padding: 1rem 1.5rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 600; cursor: pointer;">
                            ðŸ“‹ Dashboard IA
                        </button>
                    </div>
                </div>

                <!-- Tab Contents -->
                <div style="padding: 2rem;">
                    <!-- Basic Data Tab -->
                    <div id="student-tab-basic" class="student-tab-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <!-- Personal Information -->
                            <div style="background: rgba(59, 130, 246, 0.05); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <h3 style="color: #3B82F6; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>ðŸ‘¤</span> InformaÃ§Ãµes Pessoais
                                </h3>
                                <div style="display: grid; gap: 0.75rem; color: #CBD5E1;">
                                    <div><strong>Nome Completo:</strong> <span id="modalFullName">-</span></div>
                                    <div><strong>CPF:</strong> <span id="modalCpf">-</span></div>
                                    <div><strong>Data de Nascimento:</strong> <span id="modalBirthDate">-</span></div>
                                    <div><strong>Idade:</strong> <span id="modalAge">-</span></div>
                                    <div><strong>GÃªnero:</strong> <span id="modalGender">-</span></div>
                                    <div><strong>Email:</strong> <span id="modalEmail">-</span></div>
                                    <div><strong>Telefone:</strong> <span id="modalPhone">-</span></div>
                                </div>
                            </div>

                            <!-- Address Information -->
                            <div style="background: rgba(139, 92, 246, 0.05); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                                <h3 style="color: #8B5CF6; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>ðŸ“</span> EndereÃ§o
                                </h3>
                                <div style="display: grid; gap: 0.75rem; color: #CBD5E1;">
                                    <div><strong>CEP:</strong> <span id="modalPostalCode">-</span></div>
                                    <div><strong>EndereÃ§o:</strong> <span id="modalAddress">-</span></div>
                                    <div><strong>NÃºmero:</strong> <span id="modalAddressNumber">-</span></div>
                                    <div><strong>Bairro:</strong> <span id="modalNeighborhood">-</span></div>
                                    <div><strong>Cidade:</strong> <span id="modalCity">-</span></div>
                                    <div><strong>Estado:</strong> <span id="modalState">-</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div style="margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <!-- Academic Information -->
                            <div style="background: rgba(16, 185, 129, 0.05); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                                <h3 style="color: #10B981; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>ðŸŽ“</span> InformaÃ§Ãµes AcadÃªmicas
                                </h3>
                                <div style="display: grid; gap: 0.75rem; color: #CBD5E1;">
                                    <div><strong>MatrÃ­cula:</strong> <span id="modalRegistration">-</span></div>
                                    <div><strong>Data de MatrÃ­cula:</strong> <span id="modalEnrollmentDate">-</span></div>
                                    <div><strong>Categoria:</strong> <span id="modalStudentCategoryDetails">-</span></div>
                                    <div><strong>Status:</strong> <span id="modalStatusDetails">-</span></div>
                                    <div><strong>Necessidades Especiais:</strong> <span id="modalSpecialNeeds">Nenhuma</span></div>
                                </div>
                            </div>

                            <!-- Emergency Contact -->
                            <div style="background: rgba(239, 68, 68, 0.05); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(239, 68, 68, 0.2);">
                                <h3 style="color: #EF4444; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>ðŸš¨</span> Contato de EmergÃªncia
                                </h3>
                                <div style="display: grid; gap: 0.75rem; color: #CBD5E1;">
                                    <div><strong>Nome:</strong> <span id="modalEmergencyName">-</span></div>
                                    <div><strong>Telefone:</strong> <span id="modalEmergencyPhone">-</span></div>
                                    <div><strong>Relacionamento:</strong> <span id="modalEmergencyRelation">-</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other tabs content will be loaded dynamically -->
                    <div id="student-tab-courses" class="student-tab-content" style="display: none;">
                        <div id="student-courses-content">
                            <div style="text-align: center; padding: 3rem; color: #6B7280;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“š</div>
                                <p>Carregando informaÃ§Ãµes de cursos...</p>
                            </div>
                        </div>
                    </div>

                    <div id="student-tab-classes" class="student-tab-content" style="display: none;">
                        <div id="student-classes-content">
                            <div style="text-align: center; padding: 3rem; color: #6B7280;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ«</div>
                                <p>Carregando informaÃ§Ãµes de turmas...</p>
                            </div>
                        </div>
                    </div>

                    <div id="student-tab-progress" class="student-tab-content" style="display: none;">
                        <div style="text-align: center; padding: 3rem; color: #6B7280;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“ˆ</div>
                            <p>Carregando progresso do aluno...</p>
                        </div>
                    </div>

                    <div id="student-tab-financial" class="student-tab-content" style="display: none;">
                        <div style="text-align: center; padding: 3rem; color: #6B7280;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ’°</div>
                            <p>Carregando informaÃ§Ãµes financeiras...</p>
                        </div>
                    </div>

                    <div id="student-tab-attendance" class="student-tab-content" style="display: none;">
                        <div style="text-align: center; padding: 3rem; color: #6B7280;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“Š</div>
                            <p>Carregando histÃ³rico de frequÃªncia...</p>
                        </div>
                    </div>

                    <div id="student-tab-history" class="student-tab-content" style="display: none;">
                        <div style="text-align: center; padding: 3rem; color: #6B7280;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“œ</div>
                            <p>Carregando histÃ³rico do aluno...</p>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div style="padding: 1.5rem 2rem; background: #1E293B; border-radius: 0 0 16px 16px; border-top: 1px solid #334155; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="editStudentInfo()" style="padding: 0.75rem 1.5rem;">
                            <span>âœï¸</span> Editar
                        </button>
                        <button class="btn btn-success" onclick="addStudentToClass()" style="padding: 0.75rem 1.5rem;">
                            <span>âž•</span> Adicionar Ã  Turma
                        </button>
                    </div>
                    <button class="btn btn-primary" onclick="closeStudentModal()" style="padding: 0.75rem 1.5rem;">
                        <span>âœ…</span> Fechar
                    </button>
                </div>
            </div>
        </div>

        <!-- Student Edit Page (Dedicated) -->
        <div id="student-edit-page" class="content-section" style="display: none;">
            <!-- Page Header -->
            <div style="background: linear-gradient(135deg, #1E293B 0%, #334155 100%); border-radius: 16px; padding: 1.5rem 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button onclick="backToStudentsList()" style="background: rgba(148, 163, 184, 0.1); border: 1px solid #94A3B8; color: #94A3B8; padding: 0.5rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; font-size: 1.2rem;">
                            â†
                        </button>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3B82F6, #1D4ED8); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                                ðŸ‘¤
                            </div>
                            <div>
                                <h2 style="color: #F8FAFC; margin: 0; font-size: 1.5rem;" id="editPageStudentName">Editando Aluno</h2>
                                <div style="color: #94A3B8; font-size: 0.875rem; margin-top: 0.25rem;">
                                    <span id="editPageStudentId">ID: -</span> â€¢ 
                                    <span id="editPageStudentCategory">Categoria: -</span> â€¢ 
                                    <span style="color: #10B981;">âœ… Dados sincronizados</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="cancelStudentEdit()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid #EF4444; color: #EF4444; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            âŒ Cancelar
                        </button>
                        <button onclick="saveStudentPage()" style="background: linear-gradient(135deg, #10B981, #059669); border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ðŸ’¾ Salvar AlteraÃ§Ãµes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Page Tabs -->
            <div style="background: #1E293B; border-radius: 12px; margin-bottom: 2rem; border: 1px solid #334155;">
                <div style="display: flex; padding: 0.5rem; flex-wrap: wrap; gap: 0.5rem;">
                    <button class="page-tab-btn active" onclick="switchPageTab('edit')" data-page-tab="edit" 
                            style="flex: 1; min-width: 140px; padding: 0.875rem; background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.875rem;">
                        âœï¸ Editar Dados
                    </button>
                    <button class="page-tab-btn" onclick="switchPageTab('plans')" data-page-tab="plans" 
                            style="flex: 1; min-width: 140px; padding: 0.875rem; background: transparent; color: #94A3B8; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; font-size: 0.875rem;">
                        ðŸ“‹ Planos
                    </button>
                    <button class="page-tab-btn" onclick="switchPageTab('courses')" data-page-tab="courses" 
                            style="flex: 1; min-width: 140px; padding: 0.875rem; background: transparent; color: #94A3B8; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; font-size: 0.875rem;">
                        ðŸ’³ Assinatura
                    </button>
                    <button class="page-tab-btn" onclick="switchPageTab('classes')" data-page-tab="classes" 
                            style="flex: 1; min-width: 140px; padding: 0.875rem; background: transparent; color: #94A3B8; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; font-size: 0.875rem;">
                        ðŸ• Turmas
                    </button>
                    <button class="page-tab-btn" onclick="switchPageTab('progress')" data-page-tab="progress" 
                            style="flex: 1; min-width: 140px; padding: 0.875rem; background: transparent; color: #94A3B8; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; font-size: 0.875rem;">
                        ðŸ“Š Progresso
                    </button>
                    <button class="page-tab-btn" onclick="switchPageTab('ai-dashboard')" data-page-tab="ai-dashboard" 
                            style="flex: 1; min-width: 140px; padding: 0.875rem; background: transparent; color: #94A3B8; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; font-size: 0.875rem;">
                        ðŸ¤– Dashboard IA
                    </button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem;">
                <!-- Sidebar -->
                <div id="editPageSidebar" style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; height: fit-content; position: sticky; top: 2rem;">
                    <!-- Quick Stats -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: #F8FAFC; margin: 0 0 1rem 0; font-size: 1rem;">ðŸ“Š EstatÃ­sticas</h4>
                        <div style="display: grid; gap: 1rem;">
                            <div style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid rgba(139, 92, 246, 0.3);">
                                <div style="color: #8B5CF6; font-size: 1.25rem; font-weight: bold;" id="sidebarXP">1,250</div>
                                <div style="color: #CBD5E1; font-size: 0.75rem;">XP Total</div>
                            </div>
                            <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid rgba(16, 185, 129, 0.3);">
                                <div style="color: #10B981; font-size: 1.25rem; font-weight: bold;" id="sidebarLevel">Nv. 5</div>
                                <div style="color: #CBD5E1; font-size: 0.75rem;">GraduaÃ§Ã£o</div>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid rgba(245, 158, 11, 0.3);">
                                <div style="color: #F59E0B; font-size: 1.25rem; font-weight: bold;" id="sidebarStreak">7 dias</div>
                                <div style="color: #CBD5E1; font-size: 0.75rem;">SequÃªncia</div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Status -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: #F8FAFC; margin: 0 0 1rem 0; font-size: 1rem;">ðŸ’° Financeiro</h4>
                        <div id="sidebarFinancialStatus" style="background: rgba(245, 158, 11, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(245, 158, 11, 0.3);">
                            <div style="color: #F59E0B; font-weight: bold; margin-bottom: 0.5rem;">â³ Carregando...</div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">Verificando status</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div>
                        <h4 style="color: #F8FAFC; margin: 0 0 1rem 0; font-size: 1rem;">âš¡ AÃ§Ãµes RÃ¡pidas</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            <button onclick="quickCheckinFromEdit()" style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10B981; color: #10B981; padding: 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem; width: 100%;">
                                âœ… Check-in RÃ¡pido
                            </button>
                            <button onclick="viewStudentProgress()" style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8B5CF6; color: #8B5CF6; padding: 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem; width: 100%;">
                                ðŸ“ˆ Ver Progresso
                            </button>
                            <button onclick="managePayments()" style="background: rgba(245, 158, 11, 0.1); border: 1px solid #F59E0B; color: #F59E0B; padding: 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem; width: 100%;">
                                ðŸ’³ Pagamentos
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div id="editPageContent" style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 2rem; border: 1px solid #334155; min-height: 600px;">
                    <!-- Edit Tab Content -->
                    <div id="page-tab-edit" class="page-tab-content">
                        <div style="margin-bottom: 2rem;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                                <h3 style="color: #F8FAFC; margin: 0;">âœï¸ FormulÃ¡rio de EdiÃ§Ã£o</h3>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <div style="background: #1E293B; border-radius: 6px; height: 6px; width: 200px; overflow: hidden;">
                                        <div id="pageFormProgress" style="background: linear-gradient(90deg, #3B82F6, #10B981); height: 100%; width: 65%; transition: width 0.3s ease;"></div>
                                    </div>
                                    <span style="color: #94A3B8; font-size: 0.875rem;">65% completo</span>
                                </div>
                            </div>
                        </div>

                        <!-- Form sections will be loaded here -->
                        <div id="pageFormContainer">
                            <p style="color: #94A3B8; text-align: center; padding: 3rem;">Carregando formulÃ¡rio...</p>
                        </div>
                    </div>

                    <!-- Novas abas organizadas -->
                    <!-- Dashboard IA Tab -->
                    <div id="page-tab-ai-dashboard" class="page-tab-content" style="display: none;">
                        <h3 style="color: #F8FAFC; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            ðŸ¤– Dashboard IA - Insights Inteligentes
                            <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                                IA ATIVA
                            </div>
                        </h3>
                        <div id="aiDashboardContent">
                            <p style="color: #94A3B8; text-align: center; padding: 2rem;">ðŸ§  Carregando anÃ¡lise IA do aluno...</p>
                        </div>
                    </div>

                    <!-- Planos Tab -->
                    <div id="page-tab-plans" class="page-tab-content" style="display: none;">
                        <h3 style="color: #F8FAFC; margin: 0 0 1.5rem 0;">ðŸ’³ Planos de Pagamento</h3>
                        <div id="plansContent">
                            <p style="color: #94A3B8; text-align: center; padding: 2rem;">Carregando planos...</p>
                        </div>
                    </div>

                    <!-- Classes Tab -->
                    <div id="page-tab-classes" class="page-tab-content" style="display: none;">
                        <h3 style="color: #F8FAFC; margin: 0 0 1.5rem 0;">ðŸ• Turmas e HorÃ¡rios</h3>
                        <div id="classesContent">
                            <p style="color: #94A3B8; text-align: center; padding: 2rem;">Carregando turmas...</p>
                        </div>
                    </div>

                    <!-- Courses Tab -->
                    <div id="page-tab-courses" class="page-tab-content" style="display: none;">
                        <h3 style="color: #F8FAFC; margin: 0 0 1.5rem 0;">ðŸ’³ Assinatura e Plano Contratado</h3>
                        <div id="coursesContent">
                            <p style="color: #94A3B8; text-align: center; padding: 2rem;">Carregando dados da assinatura...</p>
                        </div>
                    </div>

                    <!-- Progress Tab -->
                    <div id="page-tab-progress" class="page-tab-content" style="display: none;">
                        <h3 style="color: #F8FAFC; margin: 0 0 1.5rem 0;">ðŸ“Š Progresso Detalhado</h3>
                        <div id="progressContent">
                            <p style="color: #94A3B8; text-align: center; padding: 2rem;">Carregando dados de progresso...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Check-in Section -->
        <div id="quick-checkin" class="content-section">
            <!-- Simple Metrics -->
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="total-students-checkin">4</div>
                    <div class="metric-label">Total de Alunos</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="active-students-checkin">4</div>
                    <div class="metric-label">Alunos Ativos</div>
                </div>
            </div>

            <!-- Super Simple Search -->
            <div class="simple-search">
                <input type="text" 
                       id="checkinSearch" 
                       class="search-input"
                       placeholder="ðŸ” Digite matrÃ­cula, nome ou CPF para check-in rÃ¡pido..." 
                       onkeyup="searchForCheckin()"
                       onkeypress="handleCheckinEnter(event)"
                       autocomplete="off"
                       autofocus>
                
                <button class="btn btn-primary" onclick="clearCheckinSearch()">
                    ðŸ§¹ Limpar
                </button>
            </div>

            <!-- Quick Check-in Table -->
            <div class="students-table-container">
                <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="color: #F8FAFC; margin: 0;">âš¡ Check-in RÃ¡pido</h3>
                    <div style="color: #94A3B8; font-size: 0.875rem;">
                        <span id="checkinResultsCount">0</span> resultado(s)
                    </div>
                </div>
                
                <table class="students-table">
                    <thead>
                        <tr>
                            <th>MatrÃ­cula</th>
                            <th>Nome</th>
                            <th>CPF</th>
                            <th>AÃ§Ã£o</th>
                        </tr>
                    </thead>
                    <tbody id="checkinTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #94A3B8; padding: 2rem;">
                                Digite acima para buscar alunos e fazer check-in
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Student Edit/View Modal -->
        <div id="studentModal" class="modal">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h2 id="studentModalTitle">Detalhes do Aluno</h2>
                    <span class="close" onclick="closeStudentModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="studentForm">
                        <input type="hidden" id="studentId" name="studentId">
                        <input type="hidden" id="userId" name="userId">
                        
                        <!-- InformaÃ§Ãµes Pessoais -->
                        <div class="form-section">
                            <h3>ðŸ“‹ InformaÃ§Ãµes Pessoais</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="firstName">Nome *</label>
                                    <input type="text" id="firstName" name="firstName" required>
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Sobrenome *</label>
                                    <input type="text" id="lastName" name="lastName" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="email">Email *</label>
                                    <input type="email" id="email" name="email" required>
                                </div>
                                <div class="form-group">
                                    <label for="phone">Telefone</label>
                                    <input type="tel" id="phone" name="phone">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="cpf">CPF</label>
                                    <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00">
                                </div>
                                <div class="form-group">
                                    <label for="birthDate">Data de Nascimento</label>
                                    <input type="date" id="birthDate" name="birthDate">
                                </div>
                            </div>
                        </div>

                        <!-- InformaÃ§Ãµes da Academia -->
                        <div class="form-section">
                            <h3>ðŸ¥‹ InformaÃ§Ãµes da Academia</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="category">Categoria *</label>
                                    <select id="category" name="category" required>
                                        <option value="ADULT">Adulto</option>
                                        <option value="INICIANTE1">Iniciante 1</option>
                                        <option value="INICIANTE2">Iniciante 2</option>
                                        <option value="MASTER1">Master 1</option>
                                        <option value="MASTER2">Master 2</option>
                                        <option value="MASTER3">Master 3</option>
                                        <option value="HEROI1">HerÃ³i 1</option>
                                        <option value="HEROI2">HerÃ³i 2</option>
                                        <option value="HEROI3">HerÃ³i 3</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="gender">GÃªnero *</label>
                                    <select id="gender" name="gender" required>
                                        <option value="MASCULINO">Masculino</option>
                                        <option value="FEMININO">Feminino</option>
                                        <option value="OUTRO">Outro</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="physicalCondition">CondiÃ§Ã£o FÃ­sica</label>
                                    <select id="physicalCondition" name="physicalCondition">
                                        <option value="INICIANTE">Iniciante</option>
                                        <option value="BASICO">BÃ¡sico</option>
                                        <option value="INTERMEDIARIO">IntermediÃ¡rio</option>
                                        <option value="AVANCADO">AvanÃ§ado</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="enrollmentDate">Data de MatrÃ­cula</label>
                                    <input type="date" id="enrollmentDate" name="enrollmentDate">
                                </div>
                            </div>
                        </div>

                        <!-- InformaÃ§Ãµes MÃ©dicas -->
                        <div class="form-section">
                            <h3>ðŸ¥ InformaÃ§Ãµes MÃ©dicas</h3>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="medicalConditions">CondiÃ§Ãµes MÃ©dicas</label>
                                    <textarea id="medicalConditions" name="medicalConditions" rows="3" 
                                              placeholder="Alergias, medicamentos, limitaÃ§Ãµes fÃ­sicas, etc."></textarea>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="emergencyContact">Contato de EmergÃªncia</label>
                                    <input type="text" id="emergencyContact" name="emergencyContact" 
                                           placeholder="Nome e telefone">
                                </div>
                                <div class="form-group">
                                    <label for="specialNeeds">Necessidades Especiais</label>
                                    <select id="specialNeeds" name="specialNeeds" multiple>
                                        <option value="TEA">TEA (Autismo)</option>
                                        <option value="TDAH">TDAH</option>
                                        <option value="MobilidadeReduzida">Mobilidade Reduzida</option>
                                        <option value="DeficienciaVisual">DeficiÃªncia Visual</option>
                                        <option value="DeficienciaAuditiva">DeficiÃªncia Auditiva</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Status e Progresso -->
                        <div class="form-section" id="progressSection">
                            <h3>ðŸ“Š Status e Progresso</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="totalXP">XP Total</label>
                                    <input type="number" id="totalXP" name="totalXP" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="globalLevel">NÃ­vel Global</label>
                                    <input type="number" id="globalLevel" name="globalLevel" readonly>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="currentStreak">SequÃªncia Atual</label>
                                    <input type="number" id="currentStreak" name="currentStreak" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="lastCheckinDate">Ãšltima PresenÃ§a</label>
                                    <input type="datetime-local" id="lastCheckinDate" name="lastCheckinDate" readonly>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeStudentModal()">
                        Cancelar
                    </button>
                    <button type="button" id="saveStudentBtn" class="btn btn-primary" onclick="saveStudent()">
                        ðŸ’¾ Salvar AlteraÃ§Ãµes
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Courses -->
        <div id="courses" class="content-section">
            <!-- Modern Page Header -->
            <div class="page-header" style="background: linear-gradient(135deg, #1E293B 0%, #334155 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #3B82F6, #8B5CF6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ðŸ“š GestÃ£o de Cursos</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #94A3B8; font-size: 1.1rem;">Cadastro, ediÃ§Ã£o e gestÃ£o de cursos acadÃªmicos</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="openCourseModal()" style="background: linear-gradient(135deg, #059669, #10B981); border: none; padding: 0.75rem 1.5rem;">
                            <span>âž•</span> Novo Curso
                        </button>
                        <button class="btn btn-secondary" onclick="openRAGCourseCreator()" style="padding: 0.75rem 1.5rem;">
                            <span>ðŸ¤–</span> Criar com IA
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #3B82F6;" id="totalCoursesCount">1</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Cursos Ativos</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #8B5CF6;" id="totalLessonsCount">48</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Planos de Aula</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #10B981;" id="totalTechniquesCount">42</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">TÃ©cnicas</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #F59E0B;" id="courseProgressCount">31%</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Progresso</div>
                    </div>
                </div>
            </div>

            <!-- Course List Table -->
            <div class="data-table" style="margin-bottom: 2rem;">
                <div class="table-header">
                    <div class="table-title">ðŸ“š Lista de Cursos</div>
                    <div class="table-actions">
                        <input type="text" id="courseSearch" placeholder="Buscar cursos..." style="background: #1E293B; border: 1px solid #374151; color: #F8FAFC; padding: 0.5rem 1rem; border-radius: 8px; min-width: 250px; margin-right: 1rem;" oninput="filterCourses()">
                        <button class="btn btn-secondary" onclick="refreshCourses()" style="margin-right: 0.5rem;">
                            <span>ðŸ”„</span> Atualizar
                        </button>
                        <button class="btn btn-success" onclick="exportCourses()" style="background: linear-gradient(135deg, #059669, #10B981);">
                            <span>ðŸ“Š</span> Exportar
                        </button>
                    </div>
                </div>
                <div class="table-container" style="overflow-x: auto;">
                    <table class="data-table-content">
                        <thead>
                            <tr>
                                <th>Nome do Curso</th>
                                <th>Categoria</th>
                                <th>NÃ­vel</th>
                                <th>Total de Aulas</th>
                                <th>Alunos</th>
                                <th>Status</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="courses-table-body">
                            <!-- Course rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Course Detail Modal -->
            <div id="courseDetailModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; overflow-y: auto;">
                <div class="modal-content" style="background: #0F172A; width: 95%; max-width: 1200px; margin: 20px auto; border-radius: 16px; position: relative; border: 1px solid #374151;">
                    <!-- Modal Header -->
                    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid #374151; background: linear-gradient(135deg, #1E293B, #334155); border-radius: 16px 16px 0 0;">
                        <h2 style="margin: 0; color: #F8FAFC; font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span id="courseDetailIcon">ðŸ“š</span> <span id="courseDetailTitle">Detalhes do Curso</span>
                        </h2>
                        <button onclick="closeCourseDetail()" class="close-btn" style="background: none; border: none; color: #94A3B8; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.2s;">
                            âœ•
                        </button>
                    </div>
                    
                    <!-- Modal Tabs -->
                    <div class="modal-tabs" style="display: flex; background: #1E293B; border-bottom: 1px solid #374151; padding: 0.5rem 2rem;">
                        <button class="modal-tab-btn active" onclick="switchCourseDetailTab('overview')" data-tab="overview" style="padding: 0.75rem 1rem; background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; border: none; border-radius: 8px; font-weight: 600; margin-right: 0.5rem; transition: all 0.3s;">
                            ðŸ“Š VisÃ£o Geral
                        </button>
                        <button class="modal-tab-btn" onclick="switchCourseDetailTab('plans')" data-tab="plans" style="padding: 0.75rem 1rem; background: transparent; color: #CBD5E1; border: none; border-radius: 8px; font-weight: 600; margin-right: 0.5rem; transition: all 0.3s;">
                            ðŸ’³ Planos Associados
                        </button>
                        <button class="modal-tab-btn" onclick="switchCourseDetailTab('classes')" data-tab="classes" style="padding: 0.75rem 1rem; background: transparent; color: #CBD5E1; border: none; border-radius: 8px; font-weight: 600; margin-right: 0.5rem; transition: all 0.3s;">
                            ðŸ« Turmas
                        </button>
                        <button class="modal-tab-btn" onclick="switchCourseDetailTab('lessons')" data-tab="lessons" style="padding: 0.75rem 1rem; background: transparent; color: #CBD5E1; border: none; border-radius: 8px; font-weight: 600; margin-right: 0.5rem; transition: all 0.3s;">
                            ðŸ“‹ Planos de Aula
                        </button>
                        <button class="modal-tab-btn" onclick="switchCourseDetailTab('techniques')" data-tab="techniques" style="padding: 0.75rem 1rem; background: transparent; color: #CBD5E1; border: none; border-radius: 8px; font-weight: 600; margin-right: 0.5rem; transition: all 0.3s;">
                            ðŸ¥Š TÃ©cnicas
                        </button>
                        <button class="modal-tab-btn" onclick="switchCourseDetailTab('students')" data-tab="students" style="padding: 0.75rem 1rem; background: transparent; color: #CBD5E1; border: none; border-radius: 8px; font-weight: 600; transition: all 0.3s;">
                            ðŸ‘¥ Alunos
                        </button>
                    </div>
                    
                    <!-- Modal Content -->
                    <div class="modal-body" style="padding: 2rem; min-height: 400px; max-height: 60vh; overflow-y: auto;">
                        <div id="courseDetailContent">
                            <!-- Course detail content will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Modal Footer -->
                    <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1.5rem 2rem; border-top: 1px solid #374151; background: #1E293B; border-radius: 0 0 16px 16px;">
                        <button onclick="closeCourseDetail()" class="btn btn-secondary">
                            Fechar
                        </button>
                        <button onclick="editCourse()" class="btn btn-primary">
                            âœï¸ Editar Curso
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Classes (Turmas) -->
        <div id="classes" class="content-section">
            <!-- Modern Page Header -->
            <div class="page-header" style="background: linear-gradient(135deg, #059669 0%, #10B981 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #FFFFFF, #F0FDF4); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ðŸ« GestÃ£o de Turmas</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #D1FAE5; font-size: 1.1rem;">Arte marcial com mÃºltiplos cursos/faixas em execuÃ§Ã£o simultÃ¢nea</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="createNewClass()" style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); border: none; padding: 0.75rem 1.5rem;">
                            <span>âž•</span> Nova Turma
                        </button>
                        <button class="btn btn-secondary" onclick="viewClassSchedule()" style="padding: 0.75rem 1.5rem;">
                            <span>ðŸ“…</span> Cronograma
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="totalClassesCount">2</div>
                        <div style="font-size: 0.875rem; color: #D1FAE5;">Turmas Ativas</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="totalEnrolledStudents">6</div>
                        <div style="font-size: 0.875rem; color: #D1FAE5;">Alunos Total</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="activeBelts">3</div>
                        <div style="font-size: 0.875rem; color: #D1FAE5;">Cursos Ativos</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="attendanceRate">85%</div>
                        <div style="font-size: 0.875rem; color: #D1FAE5;">Taxa PresenÃ§a</div>
                    </div>
                </div>
            </div>

            <!-- Classes List -->
            <div class="data-table" style="margin-bottom: 2rem;">
                <div class="table-header">
                    <div class="table-title">ðŸ« Turmas em Andamento</div>
                    <div class="table-actions">
                        <select id="classStatusFilter" onchange="filterClasses()" style="background: #1E293B; border: 1px solid #374151; color: #F8FAFC; padding: 0.5rem; border-radius: 8px; margin-right: 1rem;">
                            <option value="all">Todas as Turmas</option>
                            <option value="active">Ativas</option>
                            <option value="finished">Finalizadas</option>
                            <option value="paused">Pausadas</option>
                        </select>
                        <button class="btn btn-primary" onclick="createNewClass()">
                            <span>âž•</span> Nova Turma
                        </button>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #1E293B; border-bottom: 1px solid #374151;">
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Turma</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Arte Marcial</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">HorÃ¡rio</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Cursos Ativos</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Total Alunos</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Status</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="classesTableBody">
                            <tr style="border-bottom: 1px solid #374151;">
                                <td style="padding: 1rem; color: #F8FAFC; font-weight: 600;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="background: #059669; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">T1</span>
                                        Turma 1
                                    </div>
                                </td>
                                <td style="padding: 1rem; color: #CBD5E1;">Krav Maga</td>
                                <td style="padding: 1rem; color: #CBD5E1;">
                                    <div>Ter/Qui - 18:00h</div>
                                    <div style="font-size: 0.75rem; color: #94A3B8;">InÃ­cio: 01/06/2025</div>
                                </td>
                                <td style="padding: 1rem; color: #CBD5E1;">
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                        <span style="background: #FFFFFF; color: #000; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">ðŸ¥‹ Branca</span>
                                        <span style="background: #FDE047; color: #000; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">ðŸ¥‹ Amarela</span>
                                    </div>
                                </td>
                                <td style="padding: 1rem; color: #CBD5E1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="background: #3B82F6; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">4/20</span>
                                        alunos
                                    </div>
                                </td>
                                <td style="padding: 1rem;">
                                    <span style="background: #059669; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">ðŸŸ¢ Ativa</span>
                                </td>
                                <td style="padding: 1rem;">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button onclick="viewClassDetails(1)" class="btn btn-small btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">ðŸ‘ï¸ Ver</button>
                                        <button onclick="manageClassSchedule(1)" class="btn btn-small btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">ðŸ“… Agenda</button>
                                    </div>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid #374151;">
                                <td style="padding: 1rem; color: #F8FAFC; font-weight: 600;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="background: #8B5CF6; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">T2</span>
                                        Turma 2
                                    </div>
                                </td>
                                <td style="padding: 1rem; color: #CBD5E1;">Krav Maga</td>
                                <td style="padding: 1rem; color: #CBD5E1;">
                                    <div>Seg/Qua - 19:00h</div>
                                    <div style="font-size: 0.75rem; color: #94A3B8;">InÃ­cio: 01/06/2025</div>
                                </td>
                                <td style="padding: 1rem; color: #CBD5E1;">
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                        <span style="background: #FFFFFF; color: #000; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">ðŸ¥‹ Branca</span>
                                    </div>
                                </td>
                                <td style="padding: 1rem; color: #CBD5E1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="background: #3B82F6; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">2/20</span>
                                        alunos
                                    </div>
                                </td>
                                <td style="padding: 1rem;">
                                    <span style="background: #059669; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">ðŸŸ¢ Ativa</span>
                                </td>
                                <td style="padding: 1rem;">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button onclick="viewClassDetails(2)" class="btn btn-small btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">ðŸ‘ï¸ Ver</button>
                                        <button onclick="manageClassSchedule(2)" class="btn btn-small btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">ðŸ“… Agenda</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Today's Schedule -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">ðŸ“… Aulas de Hoje</div>
                        <div class="table-actions">
                            <span style="color: #CBD5E1; font-size: 0.875rem;">03/07/2025</span>
                        </div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #3B82F6;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="color: #F8FAFC; font-weight: 600;">Turma 1 - Krav Maga</div>
                                    <span style="background: #3B82F6; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">18:00</span>
                                </div>
                                <div style="color: #CBD5E1; font-size: 0.875rem; margin-bottom: 0.75rem;">
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        <div style="background: rgba(255, 255, 255, 0.1); padding: 0.5rem; border-radius: 6px; flex: 1; min-width: 120px;">
                                            <div style="color: #FFFFFF; font-weight: 600; font-size: 0.75rem;">ðŸ¤ Faixa Branca</div>
                                            <div style="color: #D1FAE5; font-size: 0.7rem;">Aula 16: Defesas vs Estrangulamento</div>
                                        </div>
                                        <div style="background: rgba(253, 224, 71, 0.2); padding: 0.5rem; border-radius: 6px; flex: 1; min-width: 120px;">
                                            <div style="color: #FDE047; font-weight: 600; font-size: 0.75rem;">ðŸ’› Faixa Amarela</div>
                                            <div style="color: #D1FAE5; font-size: 0.7rem;">Aula 8: CombinaÃ§Ãµes de Golpes</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="color: #94A3B8; font-size: 0.75rem;">4 alunos confirmados (2 Branca + 2 Amarela)</div>
                            </div>
                            <div style="text-align: center; color: #6B7280; padding: 2rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸ“…</div>
                                <p>Apenas 1 aula agendada para hoje</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">ðŸ“Š EstatÃ­sticas Semanais</div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.25rem; color: #10B981; margin-bottom: 0.5rem;">87%</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">FrequÃªncia Turma 1</div>
                            </div>
                            <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.25rem; color: #8B5CF6; margin-bottom: 0.5rem;">83%</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">FrequÃªncia Turma 2</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #F8FAFC; margin-bottom: 0.5rem; font-size: 0.875rem;">PrÃ³ximas AvaliaÃ§Ãµes por Faixa</h4>
                            <div style="color: #CBD5E1; font-size: 0.875rem; line-height: 1.6;">
                                <div>â€¢ Faixa Branca: MÃ³dulo 2 (Semana 20)</div>
                                <div>â€¢ Faixa Amarela: MÃ³dulo 1 (Semana 10)</div>
                                <div>â€¢ Faixa Laranja: MÃ³dulo 3 (Semana 30)</div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: #F8FAFC; margin-bottom: 0.5rem; font-size: 0.875rem;">Foco Semanal por Faixa</h4>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">
                                <div style="background: rgba(255, 255, 255, 0.1); padding: 0.5rem; border-radius: 4px; margin-bottom: 0.25rem;">ðŸ¤ Branca: Defesas vs Estrangulamento</div>
                                <div style="background: rgba(253, 224, 71, 0.1); padding: 0.5rem; border-radius: 4px; margin-bottom: 0.25rem;">ðŸ’› Amarela: CombinaÃ§Ãµes de Golpes</div>
                                <div style="background: rgba(251, 146, 60, 0.1); padding: 0.5rem; border-radius: 4px;">ðŸ§¡ Laranja: Defesas vs Armas</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Class Management Modals -->
        <!-- Create/Edit Class Modal -->
        <div id="classModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
            <div class="modal-content" style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); margin: 2% auto; padding: 0; border-radius: 16px; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; border: 1px solid #334155;">
                <!-- Modal Header -->
                <div style="background: linear-gradient(135deg, #059669 0%, #10B981 100%); padding: 1.5rem 2rem; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0; color: white; font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>ðŸ«</span>
                            <span id="classModalTitle">Nova Turma</span>
                        </h2>
                        <p style="margin: 0.5rem 0 0 0; color: rgba(255,255,255,0.8); font-size: 0.875rem;">Configure horÃ¡rios, arte marcial e cursos inclusos</p>
                    </div>
                    <button onclick="closeClassModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem; border-radius: 8px; cursor: pointer; font-size: 1.5rem; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        âœ•
                    </button>
                </div>

                <!-- Class Form -->
                <form id="classForm" style="padding: 2rem;">
                    <input type="hidden" id="classId">
                    
                    <!-- Basic Information -->
                    <div class="form-section" style="margin-bottom: 2rem;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>ðŸ“‹</span> InformaÃ§Ãµes BÃ¡sicas
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group">
                                <label for="className" style="display: block; margin-bottom: 0.5rem; color: #CBD5E1; font-weight: 600;">Nome da Turma *</label>
                                <input type="text" id="className" required style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC;" placeholder="Ex: Turma 3">
                            </div>
                            <div class="form-group">
                                <label for="classMartialArt" style="display: block; margin-bottom: 0.5rem; color: #CBD5E1; font-weight: 600;">Arte Marcial *</label>
                                <select id="classMartialArt" required style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC;">
                                    <option value="">Selecione a arte marcial</option>
                                    <option value="KRAV_MAGA">ðŸ¥Š Krav Maga</option>
                                    <option value="JIU_JITSU">ðŸ¥‹ Jiu-Jitsu</option>
                                    <option value="BOXING">ðŸ‘Š Boxe</option>
                                    <option value="MUAY_THAI">ðŸ¦µ Muay Thai</option>
                                    <option value="KARATE">ðŸ¥‹ KaratÃª</option>
                                    <option value="TAEKWONDO">ðŸ¦µ Taekwondo</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="classCapacity" style="display: block; margin-bottom: 0.5rem; color: #CBD5E1; font-weight: 600;">Capacidade MÃ¡xima</label>
                                <input type="number" id="classCapacity" value="20" min="5" max="50" style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC;">
                            </div>
                            <div class="form-group">
                                <label for="classInstructor" style="display: block; margin-bottom: 0.5rem; color: #CBD5E1; font-weight: 600;">Instrutor Principal</label>
                                <input type="text" id="classInstructor" style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC;" placeholder="Nome do instrutor">
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Configuration -->
                    <div class="form-section" style="margin-bottom: 2rem;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>â°</span> ConfiguraÃ§Ã£o de HorÃ¡rios
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #3B82F6;">
                                <h4 style="color: #3B82F6; margin: 0 0 0.5rem 0; font-size: 0.875rem;">Dias da Semana</h4>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" id="classMon" style="margin: 0;">
                                        Segunda
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" id="classTue" style="margin: 0;">
                                        TerÃ§a
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" id="classWed" style="margin: 0;">
                                        Quarta
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" id="classThu" style="margin: 0;">
                                        Quinta
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" id="classFri" style="margin: 0;">
                                        Sexta
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" id="classSat" style="margin: 0;">
                                        SÃ¡bado
                                    </label>
                                </div>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #F59E0B;">
                                <h4 style="color: #F59E0B; margin: 0 0 0.5rem 0; font-size: 0.875rem;">HorÃ¡rio</h4>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <label style="color: #CBD5E1; font-size: 0.875rem;">InÃ­cio:</label>
                                    <input type="time" id="classStartTime" value="18:00" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 6px; color: #F8FAFC;">
                                    <label style="color: #CBD5E1; font-size: 0.875rem;">Fim:</label>
                                    <input type="time" id="classEndTime" value="19:00" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 6px; color: #F8FAFC;">
                                </div>
                            </div>
                            <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #8B5CF6;">
                                <h4 style="color: #8B5CF6; margin: 0 0 0.5rem 0; font-size: 0.875rem;">Data de InÃ­cio</h4>
                                <input type="date" id="classStartDate" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 6px; color: #F8FAFC; margin-bottom: 0.5rem;">
                                <label style="color: #CBD5E1; font-size: 0.875rem;">DuraÃ§Ã£o (semanas):</label>
                                <input type="number" id="classDuration" value="24" min="4" max="52" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 6px; color: #F8FAFC;">
                            </div>
                        </div>
                    </div>

                    <!-- Courses and Belts Included -->
                    <div class="form-section" style="margin-bottom: 2rem;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>ðŸ¥‹</span> Cursos/Faixas Inclusos na Turma
                        </h3>
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #10B981; margin-bottom: 1rem;">
                            <h4 style="color: #10B981; margin: 0 0 0.5rem 0;">ðŸ’¡ Conceito de Turma Multi-Faixa</h4>
                            <p style="color: #D1FAE5; font-size: 0.875rem; margin: 0; line-height: 1.5;">
                                Uma turma pode ter alunos de diferentes faixas treinando simultaneamente. Cada faixa segue seu prÃ³prio cronograma de tÃ©cnicas, mas compartilha o mesmo horÃ¡rio e instrutor.
                            </p>
                        </div>
                        <div id="includedCoursesContainer" style="display: grid; gap: 1rem;">
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #3B82F6;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; margin-bottom: 0.5rem;">
                                    <input type="checkbox" id="includeBranca" checked>
                                    <span style="font-weight: 600;">ðŸ¤ Faixa Branca - Defesa Pessoal 1</span>
                                </label>
                                <div style="color: #94A3B8; font-size: 0.875rem; margin-left: 1.5rem;">
                                    48 aulas â€¢ TÃ©cnicas bÃ¡sicas de autodefesa â€¢ DuraÃ§Ã£o: 24 semanas
                                </div>
                            </div>
                            <div style="background: rgba(253, 224, 71, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #FDE047;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; margin-bottom: 0.5rem;">
                                    <input type="checkbox" id="includeAmarela">
                                    <span style="font-weight: 600;">ðŸ’› Faixa Amarela - CombinaÃ§Ãµes</span>
                                </label>
                                <div style="color: #94A3B8; font-size: 0.875rem; margin-left: 1.5rem;">
                                    36 aulas â€¢ CombinaÃ§Ãµes de golpes â€¢ DuraÃ§Ã£o: 18 semanas
                                </div>
                            </div>
                            <div style="background: rgba(251, 146, 60, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #FB923C;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; margin-bottom: 0.5rem;">
                                    <input type="checkbox" id="includeLaranja">
                                    <span style="font-weight: 600;">ðŸ§¡ Faixa Laranja - Defesas AvanÃ§adas</span>
                                </label>
                                <div style="color: #94A3B8; font-size: 0.875rem; margin-left: 1.5rem;">
                                    40 aulas â€¢ Defesas contra armas â€¢ DuraÃ§Ã£o: 20 semanas
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #374151;">
                        <button type="button" onclick="deleteClass()" id="deleteClassBtn" style="background: #DC2626; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; display: none;">
                            <span>ðŸ—‘ï¸</span> Deletar Turma
                        </button>
                        <div style="display: flex; gap: 1rem;">
                            <button type="button" onclick="closeClassModal()" style="background: #6B7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                                Cancelar
                            </button>
                            <button type="submit" style="background: linear-gradient(135deg, #059669, #10B981); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                                <span>ðŸ’¾</span> Salvar Turma
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Plan with Classes Modal -->
        <div id="planClassesModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);">
            <div class="modal-content" style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); margin: 2% auto; padding: 0; border-radius: 16px; width: 95%; max-width: 700px; max-height: 90vh; overflow-y: auto; border: 1px solid #334155;">
                <!-- Modal Header -->
                <div style="background: linear-gradient(135deg, #7C3AED 0%, #8B5CF6 100%); padding: 1.5rem 2rem; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0; color: white; font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>ðŸ’Ž</span>
                            <span>Plano Premium com Turmas Inclusas</span>
                        </h2>
                        <p style="margin: 0.5rem 0 0 0; color: rgba(255,255,255,0.8); font-size: 0.875rem;">Configure quais turmas sÃ£o incluÃ­das automaticamente no plano</p>
                    </div>
                    <button onclick="closePlanClassesModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem; border-radius: 8px; cursor: pointer; font-size: 1.5rem; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        âœ•
                    </button>
                </div>

                <!-- Plan Configuration -->
                <div style="padding: 2rem;">
                    <form id="planClassesForm">
                        <input type="hidden" id="planId">
                        
                        <!-- Plan Basic Info -->
                        <div style="background: rgba(139, 92, 246, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid #8B5CF6; margin-bottom: 2rem;">
                            <h3 style="color: #8B5CF6; margin: 0 0 1rem 0;">ðŸ“‹ InformaÃ§Ãµes do Plano</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: #CBD5E1; font-weight: 600;">Nome do Plano *</label>
                                    <input type="text" id="planName" required style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC;" placeholder="Ex: Premium Multi-Turmas">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: #CBD5E1; font-weight: 600;">PreÃ§o Mensal *</label>
                                    <input type="number" id="planPrice" required step="0.01" style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC;" placeholder="R$ 200,00">
                                </div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: #CBD5E1; font-weight: 600;">DescriÃ§Ã£o</label>
                                <textarea id="planDescription" rows="3" style="width: 100%; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC; resize: vertical;" placeholder="Acesso ilimitado a mÃºltiplas turmas e faixas..."></textarea>
                            </div>
                        </div>

                        <!-- Included Classes Selection -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #F8FAFC; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span>ðŸ«</span> Turmas IncluÃ­das no Plano
                            </h3>
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #10B981; margin-bottom: 1rem;">
                                <h4 style="color: #10B981; margin: 0 0 0.5rem 0;">ðŸ’¡ Auto-AtribuiÃ§Ã£o de Turmas</h4>
                                <p style="color: #D1FAE5; font-size: 0.875rem; margin: 0; line-height: 1.5;">
                                    Quando um aluno receber este plano, serÃ¡ automaticamente inscrito nas turmas selecionadas abaixo. Turmas adicionais poderÃ£o ser incluÃ­das manualmente depois.
                                </p>
                            </div>
                            
                            <div id="availableClassesForPlan" style="display: grid; gap: 1rem;">
                                <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #3B82F6;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; margin-bottom: 0.5rem;">
                                        <input type="checkbox" id="planIncludeClass1" value="class1">
                                        <span style="font-weight: 600;">ðŸ« Turma 1 - Krav Maga (Ter/Qui 18h)</span>
                                    </label>
                                    <div style="color: #94A3B8; font-size: 0.875rem; margin-left: 1.5rem;">
                                        Faixas: Branca, Amarela â€¢ 4 alunos ativos â€¢ Capacidade: 20
                                    </div>
                                </div>
                                <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #8B5CF6;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; margin-bottom: 0.5rem;">
                                        <input type="checkbox" id="planIncludeClass2" value="class2">
                                        <span style="font-weight: 600;">ðŸ« Turma 2 - Krav Maga (Seg/Qua 19h)</span>
                                    </label>
                                    <div style="color: #94A3B8; font-size: 0.875rem; margin-left: 1.5rem;">
                                        Faixas: Branca, Laranja â€¢ 2 alunos ativos â€¢ Capacidade: 20
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #374151;">
                            <div style="display: flex; gap: 1rem;">
                                <button type="button" onclick="closePlanClassesModal()" style="background: #6B7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                                    Cancelar
                                </button>
                                <button type="submit" style="background: linear-gradient(135deg, #7C3AED, #8B5CF6); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                                    <span>ðŸ’Ž</span> Criar Plano Premium
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Evaluations -->
        <div id="evaluations" class="content-section">
            <div class="page-header">
                <h1>Sistema de AvaliaÃ§Ãµes</h1>
                <p>AvaliaÃ§Ãµes e desempenho dos alunos</p>
            </div>
            
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">AvaliaÃ§Ãµes Registradas</div>
                </div>
                <div style="color: #CBD5E1;">
                    <p><strong>Maria Silva</strong></p>
                    <p>â€¢ Aula 10: 85.5% de precisÃ£o</p>
                    <p>â€¢ Status: AUTONOMIA</p>
                    <p>â€¢ TÃ©cnicas avaliadas: 8</p>
                    <br>
                    <p><em>Outras avaliaÃ§Ãµes serÃ£o exibidas aqui conforme forem registradas.</em></p>
                </div>
            </div>
        </div>
        
        <!-- Progress -->
        <div id="progress" class="content-section">
            <div class="page-header">
                <h1>Progresso dos Alunos</h1>
                <p>Acompanhamento de evoluÃ§Ã£o individual</p>
            </div>
            
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">Progresso Individual</div>
                </div>
                <div style="color: #CBD5E1;">
                    <p><strong>Ana Oliveira</strong></p>
                    <p>â€¢ TÃ©cnicas dominadas: 5</p>
                    <p>â€¢ Pontos acumulados: 65</p>
                    <p>â€¢ Desafios completados: 2</p>
                    <br>
                    <p><em>Outros progressos serÃ£o exibidos conforme registrados.</em></p>
                </div>
            </div>
        </div>
        
        <!-- Financial Module -->
        <div id="financial" class="content-section">
            <div class="page-header">
                <h1>ðŸ’° GestÃ£o Financeira</h1>
                <p>Controle de recebimentos, gastos, fluxo de caixa e relatÃ³rios financeiros</p>
            </div>

            <!-- Financial Overview Cards -->
            <div class="metric-grid" style="margin-bottom: 2rem;">
                <div class="metric-card">
                    <div class="metric-value" id="total-revenue">R$ 0</div>
                    <div class="metric-label">Receita Total</div>
                    <div class="metric-trend positive">
                        <span>â†—</span> +0% este mÃªs
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="active-subscriptions">0</div>
                    <div class="metric-label">Assinaturas Ativas</div>
                    <div class="metric-trend positive">
                        <span>â†—</span> 100% pagamento
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="pending-payments">0</div>
                    <div class="metric-label">Pendentes</div>
                    <div class="metric-trend neutral">
                        <span>â†’</span> 0 em atraso
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="total-plans">0</div>
                    <div class="metric-label">Planos Ativos</div>
                    <div class="metric-trend positive">
                        <span>â†—</span> DisponÃ­veis
                    </div>
                </div>
            </div>

            <!-- Financial Tabs -->
            <div class="financial-tabs" style="margin-bottom: 2rem;">
                <button class="financial-tab active" onclick="switchFinancialTab('revenues')">
                    ðŸ’° Recebimentos
                </button>
                <button class="financial-tab" onclick="switchFinancialTab('expenses')">
                    ðŸ’¸ Gastos
                </button>
                <button class="financial-tab" onclick="switchFinancialTab('payments')">
                    ðŸ’³ Pagamentos
                </button>
                <button class="financial-tab" onclick="switchFinancialTab('settings')">
                    âš™ï¸ ConfiguraÃ§Ãµes
                </button>
            </div>

            <!-- Revenues Management -->
            <div id="financial-revenues" class="financial-tab-content active">
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">ðŸ’° Controle de Recebimentos</div>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="openAddRevenueModal()">
                                <span>âž•</span>
                                Novo Recebimento
                            </button>
                        </div>
                    </div>
                    
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>DescriÃ§Ã£o</th>
                                <th>Categoria</th>
                                <th>Aluno/Cliente</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="revenuesTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                                    ðŸ’° MÃ³dulo de Recebimentos em desenvolvimento
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Expenses Management -->
            <div id="financial-expenses" class="financial-tab-content" style="display: none;">
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">ðŸ’¸ Controle de Gastos</div>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="openAddExpenseModal()">
                                <span>âž•</span>
                                Novo Gasto
                            </button>
                        </div>
                    </div>
                    
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>DescriÃ§Ã£o</th>
                                <th>Valor</th>
                                <th>PrÃ³ximo Vencimento</th>
                                <th>Status</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                                    Nenhum gasto registrado
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payments Management -->
            <div id="financial-payments" class="financial-tab-content" style="display: none;">
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">ðŸ’³ Controle de Pagamentos</div>
                    </div>
                    
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Aluno</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>MÃ©todo</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                                    Carregando pagamentos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Financial Settings -->
            <div id="financial-settings" class="financial-tab-content" style="display: none;">
                <div class="settings-section">
                    <h3>âš™ï¸ ConfiguraÃ§Ãµes Financeiras</h3>
                    
                    <div class="form-group">
                        <label>IntegraÃ§Ã£o de Pagamento</label>
                        <select class="form-input">
                            <option value="asaas">Asaas</option>
                            <option value="stripe">Stripe</option>
                            <option value="pagseguro">PagSeguro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Dias para Vencimento</label>
                        <input type="number" class="form-input" value="5" min="1" max="30">
                    </div>
                    
                    <div class="form-group">
                        <label>Multa por Atraso (%)</label>
                        <input type="number" class="form-input" value="2" min="0" max="10" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label>Juros por Dia (%)</label>
                        <input type="number" class="form-input" value="0.033" min="0" max="1" step="0.001">
                    </div>
                    
                    <button class="btn btn-primary">Salvar ConfiguraÃ§Ãµes</button>
                </div>
            </div>
        </div>
        
        <!-- Challenges -->
        <div id="challenges" class="content-section">
            <div class="page-header">
                <h1>Desafios Semanais</h1>
                <p>Sistema de desafios e gamificaÃ§Ã£o</p>
            </div>
            
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">Desafios DisponÃ­veis</div>
                </div>
                <div style="color: #CBD5E1;">
                    <p>â€¢ 24 desafios catalogados</p>
                    <p>â€¢ Adaptados por categoria e gÃªnero</p>
                    <p>â€¢ Sistema de pontos integrado</p>
                    <br>
                    <p><em>Interface de desafios em desenvolvimento.</em></p>
                </div>
            </div>
        </div>
        
        <!-- Knowledge Base -->
        <div id="knowledge-base" class="content-section">
            <div class="page-header">
                <h1>ðŸ§  Base de Conhecimento</h1>
                <p>MemÃ³ria central dos agentes IA - Upload de documentos, textos, links e vÃ­deos</p>
            </div>
            
            <div style="display: grid; gap: 1.5rem;">
                <!-- Knowledge Base Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #8B5CF6;">
                        <div style="color: #8B5CF6; font-weight: bold; margin-bottom: 0.5rem;">ðŸ“š Documentos</div>
                        <div style="color: #F8FAFC; font-size: 1.5rem; font-weight: bold;" id="knowledgeStatsDocuments">0</div>
                    </div>
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #10B981;">
                        <div style="color: #10B981; font-weight: bold; margin-bottom: 0.5rem;">ðŸ•°ï¸ Chunks RAG</div>
                        <div style="color: #F8FAFC; font-size: 1.5rem; font-weight: bold;" id="knowledgeStatsChunks">0</div>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #3B82F6;">
                        <div style="color: #3B82F6; font-weight: bold; margin-bottom: 0.5rem;">â±ï¸ Ãšltima IndexaÃ§Ã£o</div>
                        <div style="color: #F8FAFC; font-size: 0.875rem;" id="knowledgeStatsLastUpdate">Nunca</div>
                    </div>
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #F59E0B;">
                        <div style="color: #F59E0B; font-weight: bold; margin-bottom: 0.5rem;">âš™ï¸ Status RAG</div>
                        <div style="color: #F8FAFC; font-size: 0.875rem;" id="knowledgeStatsStatus">Vazio</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openKnowledgeUploader()">
                        <span>âž•</span> Adicionar ConteÃºdo
                    </button>
                    <button class="btn btn-success" onclick="reindexKnowledgeBase()">
                        <span>âš¡</span> Reindexar Base
                    </button>
                    <button class="btn btn-info" onclick="testRAGSystem()">
                        <span>ðŸ—ºï¸</span> Testar RAG
                    </button>
                    <button class="btn btn-secondary" onclick="searchKnowledgeBase()">
                        <span>ðŸ”</span> Buscar
                    </button>
                </div>
                
                <!-- Knowledge Base Content -->
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">ConteÃºdo da Base de Conhecimento</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="text" id="knowledgeSearchInput" placeholder="Buscar na base..." style="padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #1F2937; color: #F8FAFC; width: 200px;" onkeyup="if(event.key==='Enter') searchKnowledgeBase()">
                            <button class="btn btn-sm btn-primary" onclick="searchKnowledgeBase()">ðŸ”</button>
                        </div>
                    </div>
                    <div id="knowledgeContentDisplay" style="min-height: 300px;">
                        <div style="text-align: center; color: #9CA3AF; padding: 3rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“š</div>
                            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Base de Conhecimento Vazia</div>
                            <div style="font-size: 0.9rem;">Adicione documentos, textos, links ou vÃ­deos para comeÃ§ar</div>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-primary" onclick="openKnowledgeUploader()">
                                    âž• Adicionar Primeiro ConteÃºdo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Financial Responsibles -->
        <div id="financial-responsibles" class="content-section">
            <div class="page-header">
                <h1>ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ ResponsÃ¡veis Financeiros</h1>
                <p>GestÃ£o de responsÃ¡veis financeiros dos alunos</p>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-value" id="totalResponsibles">0</div>
                    <div class="stat-label">Total de ResponsÃ¡veis</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeResponsibles">0</div>
                    <div class="stat-label">Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="studentsWithResponsibles">0</div>
                    <div class="stat-label">Alunos com ResponsÃ¡vel</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgStudentsPerResponsible">0</div>
                    <div class="stat-label">MÃ©dia p/ ResponsÃ¡vel</div>
                </div>
            </div>

            <!-- Search and Actions -->
            <div class="simple-search">
                <input type="text" 
                       id="responsibleSearch" 
                       class="search-input"
                       placeholder="ðŸ” Buscar por nome, CPF, email..." 
                       onkeyup="filterResponsibles()"
                       autocomplete="off">
                
                <button class="btn btn-primary" onclick="openAddResponsibleModal()">
                    <span>âž•</span>
                    Novo ResponsÃ¡vel
                </button>
            </div>
            
            <!-- Responsibles Table -->
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">Lista de ResponsÃ¡veis Financeiros</div>
                </div>
                <div class="responsibles-table-container">
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF/CNPJ</th>
                                <th>Email</th>
                                <th>Telefone</th>
                                <th>RelaÃ§Ã£o</th>
                                <th>Alunos</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="responsiblesTableBody">
                            <!-- Responsibles will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="responsiblesLoadingState" class="loading-state">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando responsÃ¡veis...</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                    </div>
                </div>
                <div id="responsiblesEmptyState" class="empty-state" style="display: none;">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhum responsÃ¡vel encontrado</div>
                        <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece adicionando o primeiro responsÃ¡vel financeiro</div>
                        <button class="btn btn-primary" onclick="openAddResponsibleModal()">
                            <span>âž•</span>
                            Adicionar Primeiro ResponsÃ¡vel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Plans -->
        <!-- Payment Plans Management -->
        <div id="payment-plans" class="content-section">
            <!-- Modern Page Header -->
            <div class="page-header" style="background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #FFFFFF, #F3E8FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ðŸ“„ Planos da Academia</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #F3E8FF; font-size: 1.1rem;">Gerencie os planos de curso oferecidos pela academia - valores, categorias e condiÃ§Ãµes</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="openAddPlanModal()" style="background: linear-gradient(135deg, #059669, #10B981); border: none; padding: 0.75rem 1.5rem;">
                            <span>âž•</span> Novo Plano
                        </button>
                        <button class="btn btn-secondary" onclick="loadPaymentPlansList()" style="padding: 0.75rem 1.5rem;">
                            <span>ðŸ”„</span> Atualizar
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="totalPlansCount">0</div>
                        <div style="font-size: 0.875rem; color: #F3E8FF;">Total Planos</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="activePlansCount">0</div>
                        <div style="font-size: 0.875rem; color: #F3E8FF;">Ativos</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="avgPlanPrice">R$ 0</div>
                        <div style="font-size: 0.875rem; color: #F3E8FF;">Valor MÃ©dio</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="monthlyPlansCount">0</div>
                        <div style="font-size: 0.875rem; color: #F3E8FF;">Mensais</div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="data-controls" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
                <div style="flex: 1; position: relative;">
                    <input type="text" id="planSearchInput" placeholder="ðŸ” Buscar planos..." 
                           style="width: 100%; padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 12px; color: #F8FAFC; font-size: 0.875rem;"
                           onkeyup="filterPlans()">
                </div>
                <select id="categoryFilterSelect" onchange="filterPlans()" 
                        style="padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC; font-size: 0.875rem;">
                    <option value="">Todas Categorias</option>
                    <option value="ADULT">Adulto</option>
                    <option value="CHILD">Infantil</option>
                    <option value="SENIOR">Senior</option>
                    <option value="FEMALE">Feminino</option>
                </select>
                <select id="billingTypeFilter" onchange="filterPlans()" 
                        style="padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC; font-size: 0.875rem;">
                    <option value="">Todos Tipos</option>
                    <option value="MONTHLY">Mensal</option>
                    <option value="QUARTERLY">Trimestral</option>
                    <option value="YEARLY">Anual</option>
                    <option value="CREDIT_CARD_INSTALLMENT">CartÃ£o Parcelado</option>
                </select>
                <button class="btn btn-primary" onclick="openAddPlanPage()" style="background: linear-gradient(135deg, #8B5CF6, #EC4899); padding: 0.75rem 1.5rem;">
                    <span>âž•</span> Novo Plano
                </button>
            </div>

            <!-- Plans Table -->
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">ðŸ“„ Planos de Curso da Academia</div>
                    <div class="table-actions">
                        <span style="color: #CBD5E1; font-size: 0.875rem;" id="plansCountText">Carregando...</span>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #1E293B; border-bottom: 1px solid #374151;">
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Plano</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Curso</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Categoria</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Valor</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Tipo</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Aulas/Semana</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Status</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="plansTableBody">
                            <!-- Plans will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Loading State -->
            <div id="plansLoadingState" class="loading-state">
                <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“„</div>
                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando planos...</div>
                    <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="plansEmptyState" class="empty-state" style="display: none;">
                <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“„</div>
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhum plano encontrado</div>
                    <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece criando o primeiro plano de pagamento</div>
                    <button class="btn btn-primary" onclick="openAddPlanPage()">
                        <span>âž•</span> Criar Primeiro Plano
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Plan Edit Page -->
        <div id="plan-edit" class="content-section" style="display: none;">
            <div class="page-header" style="background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #FFFFFF, #F3E8FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">âœï¸ Editar Plano</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #F3E8FF; font-size: 1.1rem;" id="planEditSubtitle">Edite as informaÃ§Ãµes do plano selecionado</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="backToPlans()" style="padding: 0.75rem 1.5rem;">
                            <span>â†</span> Voltar
                        </button>
                        <button class="btn btn-primary" onclick="savePlanChanges()" style="background: linear-gradient(135deg, #059669, #10B981); border: none; padding: 0.75rem 1.5rem;">
                            <span>ðŸ’¾</span> Salvar
                        </button>
                        <button class="btn btn-secondary" onclick="testSavePlanDebug()" style="background: #6B7280; border: none; padding: 0.75rem 1.5rem; margin-left: 0.5rem;">
                            <span>ðŸ§ª</span> Teste Debug
                        </button>
                    </div>
                </div>
            </div>

            <!-- Plan Edit Form with Tabs -->
            <div class="form-container" style="background: rgba(15, 23, 42, 0.6); border-radius: 16px; padding: 2rem; border: 1px solid rgba(51, 65, 85, 0.8);">
                
                <!-- Tab Navigation -->
                <div class="plan-tabs" style="margin-bottom: 2rem;">
                    <button type="button" class="plan-tab active" onclick="switchPlanEditTab('basic')" data-tab="basic">
                        ðŸ“‹ InformaÃ§Ãµes BÃ¡sicas
                    </button>
                    <button type="button" class="plan-tab" onclick="switchPlanEditTab('courses')" data-tab="courses">
                        ðŸŽ“ Cursos Associados
                    </button>
                    <button type="button" class="plan-tab" onclick="switchPlanEditTab('advanced')" data-tab="advanced">
                        âš™ï¸ ConfiguraÃ§Ãµes
                    </button>
                    <button type="button" class="plan-tab" onclick="switchPlanEditTab('preview')" data-tab="preview">
                        ðŸ‘ï¸ Preview
                    </button>
                </div>

                <form id="planEditForm">
                    <!-- Tab 1: Basic Information -->
                    <div id="planEditTab-basic" class="plan-tab-content active">
                        <div class="tab-header" style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #3B82F6; margin-bottom: 0.5rem; font-size: 1.5rem;">ðŸ“‹ InformaÃ§Ãµes BÃ¡sicas do Plano</h3>
                            <p style="color: #94A3B8; margin: 0;">Configure os dados fundamentais do seu plano de pagamento</p>
                        </div>
                        
                        <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                            <div class="form-group">
                                <label class="form-label">Nome do Plano *</label>
                                <input type="text" class="form-input" id="editPlanName" placeholder="Ex: Plano Premium Krav Maga" required>
                                <small class="form-hint">ðŸ”„ SerÃ¡ gerado automaticamente baseado nos cursos selecionados</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Categoria *</label>
                                <select class="form-select" id="editPlanCategory" required onchange="updatePlanEditPreview()">
                                    <option value="">Selecione uma categoria...</option>
                                    <option value="ADULT">ðŸ‘¨ Adulto</option>
                                    <option value="FEMALE">ðŸ‘© Feminino</option>
                                    <option value="SENIOR">ðŸ‘´ Senior/Idoso</option>
                                    <option value="CHILD">ðŸ§’ Infantil/CrianÃ§a</option>
                                    <option value="INICIANTE1">ðŸ¥‰ Iniciante 1</option>
                                    <option value="INICIANTE2">ðŸ¥‰ Iniciante 2</option>
                                    <option value="INICIANTE3">ðŸ¥‰ Iniciante 3</option>
                                    <option value="HEROI1">ðŸ¥ˆ HerÃ³i 1</option>
                                    <option value="HEROI2">ðŸ¥ˆ HerÃ³i 2</option>
                                    <option value="HEROI3">ðŸ¥ˆ HerÃ³i 3</option>
                                    <option value="MASTER_1">ðŸ¥‡ Master 1</option>
                                    <option value="MASTER_2">ðŸ¥‡ Master 2</option>
                                    <option value="MASTER_3">ðŸ¥‡ Master 3</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Valor do Plano *</label>
                                <input type="number" class="form-input" id="editPlanPrice" step="0.01" placeholder="R$ 0,00" required>
                                <small class="form-hint">ðŸ’° Insira o valor do plano conforme sua estratÃ©gia de preÃ§os</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tipo de CobranÃ§a *</label>
                                <select class="form-select" id="editPlanBillingType" required onchange="updatePlanEditPreview()">
                                    <option value="MONTHLY">ðŸ’³ Mensal</option>
                                    <option value="WEEKLY">ðŸ“… Semanal</option>
                                    <option value="QUARTERLY">ðŸ“Š Trimestral</option>
                                    <option value="YEARLY">ðŸ—“ï¸ Anual</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">DescriÃ§Ã£o do Plano</label>
                            <textarea class="form-input" id="editPlanDescription" rows="3" placeholder="DescriÃ§Ã£o detalhada dos benefÃ­cios e caracterÃ­sticas do plano..."></textarea>
                        </div>
                        
                        <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <div></div>
                            <button type="button" class="btn btn-primary" onclick="switchPlanEditTab('courses')" style="min-width: 200px;">
                                PrÃ³ximo: Cursos Associados â†’
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab 2: Associated Courses -->
                    <div id="planEditTab-courses" class="plan-tab-content">
                        <div class="tab-header" style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #3B82F6; margin-bottom: 0.5rem; font-size: 1.5rem;">ðŸŽ“ Cursos Associados ao Plano</h3>
                            <p style="color: #94A3B8; margin: 0;">Selecione todos os cursos que estarÃ£o inclusos neste plano</p>
                            <div class="validation-alert" id="coursesValidationAlert" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid #EF4444; color: #EF4444; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                âš ï¸ <strong>AtenÃ§Ã£o:</strong> Ã‰ obrigatÃ³rio selecionar pelo menos um curso para o plano.
                            </div>
                            <div class="success-alert" id="coursesSuccessAlert" style="display: none; background: rgba(16, 185, 129, 0.1); border: 1px solid #10B981; color: #10B981; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                âœ… <strong>Perfeito!</strong> Cursos selecionados para o plano.
                            </div>
                        </div>
                        
                        <div class="courses-selection-container">
                            <div class="selection-header">
                                <div class="selection-stats">
                                    <span class="stat-badge" id="editCoursesSelectedCount">0 cursos selecionados</span>
                                    <span class="stat-badge" id="editCoursesTotalCount">0 cursos disponÃ­veis</span>
                                </div>
                                <div class="selection-actions">
                                    <button type="button" class="btn btn-sm btn-outline" onclick="selectAllEditCourses()">Selecionar Todos</button>
                                    <button type="button" class="btn btn-sm btn-outline" onclick="clearAllEditCourses()">Limpar SeleÃ§Ã£o</button>
                                </div>
                            </div>
                            
                            <div class="courses-grid" id="editCoursesGrid">
                                <!-- Courses will be loaded here dynamically -->
                                <div class="loading-state">
                                    <div class="spinner"></div>
                                    <p>Carregando cursos disponÃ­veis...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <button type="button" class="btn btn-secondary" onclick="switchPlanEditTab('basic')" style="min-width: 200px;">
                                â† Voltar: InformaÃ§Ãµes BÃ¡sicas
                            </button>
                            <button type="button" class="btn btn-primary" onclick="switchPlanEditTab('advanced')" style="min-width: 200px;">
                                PrÃ³ximo: ConfiguraÃ§Ãµes â†’
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab 3: Advanced Configuration -->
                    <div id="planEditTab-advanced" class="plan-tab-content">
                        <div class="tab-header" style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #3B82F6; margin-bottom: 0.5rem; font-size: 1.5rem;">âš™ï¸ ConfiguraÃ§Ãµes AvanÃ§adas</h3>
                            <p style="color: #94A3B8; margin: 0;">Configure recursos especiais e limitaÃ§Ãµes do plano</p>
                        </div>
                        
                        <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                            <div class="form-group">
                                <label class="form-label">Aulas por Semana</label>
                                <select class="form-select" id="editPlanClassesPerWeek" onchange="syncWeeklyClassesField()">
                                    <option value="1">1 aula por semana</option>
                                    <option value="2" selected>2 aulas por semana</option>
                                    <option value="3">3 aulas por semana</option>
                                    <option value="4">4 aulas por semana</option>
                                    <option value="5">5 aulas por semana</option>
                                    <option value="unlimited">â™¾ï¸ Ilimitado</option>
                                </select>
                                <!-- Hidden field for JS compatibility -->
                                <input type="hidden" id="editPlanWeeklyClasses" value="2">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">MÃ¡ximo de Aulas por MÃªs</label>
                                <input type="number" class="form-input" id="editPlanMaxClasses" min="1" max="50" placeholder="Ex: 8 aulas">
                                <small class="form-hint">Deixe em branco para ilimitado</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">DuraÃ§Ã£o do Plano (meses)</label>
                                <input type="number" class="form-input" id="editPlanDuration" min="1" max="36" placeholder="Ex: 12 meses" value="12">
                                <small class="form-hint">DuraÃ§Ã£o em meses do plano</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">PerÃ­odo de CarÃªncia (dias)</label>
                                <input type="number" class="form-input" id="editPlanGracePeriod" min="0" max="30" placeholder="Ex: 5 dias" value="5">
                                <small class="form-hint">Dias de carÃªncia para cancelamento</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Limite de Alunos</label>
                                <input type="number" class="form-input" id="editPlanStudentLimit" min="1" placeholder="Ex: 50 alunos">
                                <small class="form-hint">Deixe em branco para ilimitado</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Recursos Extras</label>
                            <div class="extras-grid">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanPersonalTraining"> 
                                    ðŸ’ª Personal Training
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanNutrition"> 
                                    ðŸ¥— Plano Nutricional
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanAllModalities"> 
                                    ðŸ¥‹ Todas Modalidades
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFreezeOption"> 
                                    â„ï¸ Permite Congelar
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFeatureAccess" checked> 
                                    ðŸ”‘ Acesso Total
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFeatureEquipment"> 
                                    ðŸ‹ï¸ Equipamentos
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFeaturePersonal"> 
                                    ðŸ’ª Personal Training
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFeatureNutrition"> 
                                    ðŸ¥— Nutricional
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFeatureEvents" checked> 
                                    ðŸŽ‰ Eventos
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFeatureMaterial" checked> 
                                    ðŸ“š Material DidÃ¡tico
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ConfiguraÃ§Ãµes do Plano</label>
                            <div class="extras-grid">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanIsActive" checked> 
                                    âœ… Plano Ativo
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanAllowUpgrade" checked> 
                                    ðŸ“ˆ Permite Upgrade
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanAutoRenewal"> 
                                    ðŸ”„ RenovaÃ§Ã£o AutomÃ¡tica
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ObservaÃ§Ãµes</label>
                            <textarea class="form-input" id="editPlanNotes" rows="3" placeholder="ObservaÃ§Ãµes adicionais sobre o plano..."></textarea>
                        </div>
                        
                        <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <button type="button" class="btn btn-secondary" onclick="switchPlanEditTab('courses')" style="min-width: 200px;">
                                â† Voltar: Cursos Associados
                            </button>
                            <button type="button" class="btn btn-primary" onclick="switchPlanEditTab('preview')" style="min-width: 200px;">
                                PrÃ³ximo: Preview â†’
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab 4: Preview -->
                    <div id="planEditTab-preview" class="plan-tab-content">
                        <div class="tab-header" style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #3B82F6; margin-bottom: 0.5rem; font-size: 1.5rem;">ðŸ‘ï¸ Preview do Plano</h3>
                            <p style="color: #94A3B8; margin: 0;">Visualize como o plano ficarÃ¡ antes de salvar</p>
                        </div>
                        
                        <div id="editPlanPreview" class="preview-container">
                            <div class="preview-card">
                                <div class="preview-header">
                                    <h4 id="editPreviewPlanName">Nome do Plano</h4>
                                    <div class="preview-price" id="editPreviewPlanPrice">R$ 0,00</div>
                                </div>
                                <div class="preview-body">
                                    <p id="editPreviewPlanDescription">DescriÃ§Ã£o do plano</p>
                                    <div class="preview-details">
                                        <div class="detail-item">
                                            <span class="detail-label">Categoria:</span>
                                            <span class="detail-value" id="editPreviewCategory">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Tipo de CobranÃ§a:</span>
                                            <span class="detail-value" id="editPreviewBillingType">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Cursos Inclusos:</span>
                                            <span class="detail-value" id="editPreviewCourses">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Aulas por Semana:</span>
                                            <span class="detail-value" id="editPreviewClassesPerWeek">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <button type="button" class="btn btn-secondary" onclick="switchPlanEditTab('advanced')" style="min-width: 200px;">
                                â† Voltar: ConfiguraÃ§Ãµes
                            </button>
                            <button type="button" class="btn btn-primary btn-large" onclick="savePlanChanges()" style="min-width: 200px;">
                                ðŸ’¾ Salvar Plano
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="testSavePlanDebug()" style="min-width: 150px; margin-left: 1rem;">
                                ðŸ§ª Teste Debug
                            </button>
                        </div>
                    </div>
                    
                    <!-- Hidden legacy field for compatibility -->
                    <select id="editPlanCourse" multiple style="display: none;"></select>
                </form>
            </div>
        </div>
        
        <!-- Subscriptions Management -->
        <div id="subscriptions" class="content-section">
            <!-- Modern Page Header -->
            <div class="page-header" style="background: linear-gradient(135deg, #059669 0%, #10B981 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #FFFFFF, #D1FAE5); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ðŸ’³ GestÃ£o de Assinaturas</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #D1FAE5; font-size: 1.1rem;">Gerencie assinaturas ativas dos alunos, planos contratados e status de pagamento</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="openAddSubscriptionModal()" style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); border: none; padding: 0.75rem 1.5rem;">
                            <span>âž•</span> Nova Assinatura
                        </button>
                        <button class="btn btn-secondary" onclick="loadSubscriptionsList()" style="padding: 0.75rem 1.5rem;">
                            <span>ðŸ”„</span> Atualizar
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="totalSubscriptionsCount">0</div>
                        <div style="font-size: 0.875rem; color: #D1FAE5;">Total Assinaturas</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="activeSubscriptionsCount">0</div>
                        <div style="font-size: 0.875rem; color: #D1FAE5;">Ativas</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="pendingSubscriptionsCount">0</div>
                        <div style="font-size: 0.875rem; color: #D1FAE5;">Pendentes</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="totalSubscriptionRevenue">R$ 0</div>
                        <div style="font-size: 0.875rem; color: #D1FAE5;">Receita Total</div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="data-controls" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
                <div style="flex: 1; position: relative;">
                    <input type="text" id="subscriptionSearchInput" placeholder="ðŸ” Buscar por aluno, e-mail ou plano..." 
                           style="width: 100%; padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 12px; color: #F8FAFC; font-size: 0.875rem;"
                           onkeyup="filterSubscriptions()">
                </div>
                <select id="subscriptionStatusFilter" onchange="filterSubscriptions()" 
                        style="padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC; font-size: 0.875rem;">
                    <option value="">Todos Status</option>
                    <option value="ACTIVE">Ativa</option>
                    <option value="PENDING">Pendente</option>
                    <option value="SUSPENDED">Suspensa</option>
                    <option value="CANCELLED">Cancelada</option>
                    <option value="EXPIRED">Expirada</option>
                </select>
                <select id="subscriptionPlanFilter" onchange="filterSubscriptions()" 
                        style="padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC; font-size: 0.875rem;">
                    <option value="">Todos Planos</option>
                </select>
            </div>

            <!-- Data Table -->
            <div class="table-container">
                <table class="data-table-content">
                    <thead>
                        <tr>
                            <th>Aluno</th>
                            <th>Plano</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>InÃ­cio</th>
                            <th>PrÃ³ximo Pagamento</th>
                            <th>MÃ©todo</th>
                            <th>AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="subscriptionsTableBody">
                        <!-- Subscriptions will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Loading States -->
            <div id="subscriptionsLoadingState" class="loading-state">
                <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ’³</div>
                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando assinaturas...</div>
                    <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                </div>
            </div>
            <div id="subscriptionsEmptyState" class="empty-state" style="display: none;">
                <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ’³</div>
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhuma assinatura encontrada</div>
                    <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece criando a primeira assinatura</div>
                    <button class="btn btn-primary" onclick="openAddSubscriptionModal()">
                        <span>âž•</span>
                        Criar Primeira Assinatura
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Subscription Modal -->
        <div id="subscriptionModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="subscriptionModalTitle">âž• Nova Assinatura</h2>
                    <button class="btn-close" onclick="closeSubscriptionModal()">&times;</button>
                </div>
                <form id="subscriptionForm">
                    <div class="modal-body">
                        <!-- Student Selection -->
                        <div class="form-group">
                            <label class="form-label">ðŸ‘¤ Aluno *</label>
                            <select id="subscriptionStudent" class="form-control" required>
                                <option value="">Selecione um aluno</option>
                            </select>
                        </div>

                        <!-- Plan Selection -->
                        <div class="form-group">
                            <label class="form-label">ðŸ“„ Plano *</label>
                            <select id="subscriptionPlan" class="form-control" required onchange="updateSubscriptionPlanDetails()">
                                <option value="">Selecione um plano</option>
                            </select>
                        </div>

                        <!-- Plan Details Display -->
                        <div id="subscriptionPlanDetails" style="display: none; background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <h4 style="color: #3B82F6; margin-bottom: 0.5rem;">ðŸ“‹ Detalhes do Plano</h4>
                            <div id="planDetailsContent"></div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Start Date -->
                            <div class="form-group">
                                <label class="form-label">ðŸ“… Data de InÃ­cio *</label>
                                <input type="date" id="subscriptionStartDate" class="form-control" required>
                            </div>

                            <!-- Payment Method -->
                            <div class="form-group">
                                <label class="form-label">ðŸ’³ MÃ©todo de Pagamento *</label>
                                <select id="subscriptionPaymentMethod" class="form-control" required>
                                    <option value="">Selecione</option>
                                    <option value="CREDIT_CARD">CartÃ£o de CrÃ©dito</option>
                                    <option value="DEBIT_CARD">CartÃ£o de DÃ©bito</option>
                                    <option value="PIX">PIX</option>
                                    <option value="BANK_SLIP">Boleto BancÃ¡rio</option>
                                    <option value="CASH">Dinheiro</option>
                                    <option value="BANK_TRANSFER">TransferÃªncia</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Payment Day -->
                            <div class="form-group">
                                <label class="form-label">ðŸ“† Dia do Pagamento</label>
                                <select id="subscriptionPaymentDay" class="form-control">
                                    <option value="">Auto (data de inÃ­cio)</option>
                                    <option value="1">1</option>
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                </select>
                            </div>

                            <!-- Status -->
                            <div class="form-group">
                                <label class="form-label">ðŸ“Š Status *</label>
                                <select id="subscriptionStatus" class="form-control" required>
                                    <option value="ACTIVE">Ativa</option>
                                    <option value="PENDING">Pendente</option>
                                    <option value="SUSPENDED">Suspensa</option>
                                    <option value="CANCELLED">Cancelada</option>
                                </select>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="form-group">
                            <label class="form-label">ðŸ“ ObservaÃ§Ãµes</label>
                            <textarea id="subscriptionNotes" class="form-control" rows="3" placeholder="ObservaÃ§Ãµes sobre a assinatura..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeSubscriptionModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">ðŸ’¾ Salvar Assinatura</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Units Management -->
        <div id="units" class="content-section">
            <div class="page-header" style="background: linear-gradient(135deg, #1E293B 0%, #334155 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #3B82F6, #8B5CF6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ðŸ¢ GestÃ£o de Unidades</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #94A3B8; font-size: 1.1rem;">Administre locais, endereÃ§os e capacidades das unidades da academia</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="openAddUnitModal()" style="background: linear-gradient(135deg, #059669, #10B981); border: none; padding: 0.75rem 1.5rem;">
                            <span>âž•</span> Nova Unidade
                        </button>
                        <button class="btn btn-secondary" onclick="loadUnits()" style="padding: 0.75rem 1.5rem;">
                            <span>ðŸ”„</span> Atualizar
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #3B82F6;" id="totalUnitsCount">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Unidades</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #8B5CF6;" id="totalMatsCount">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Tatames</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #10B981;" id="totalCapacityCount">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Capacidade Total</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #F59E0B;" id="activeClassesCount">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Turmas Ativas</div>
                    </div>
                </div>
            </div>

            <!-- Units Table -->
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">ðŸ“‹ Lista de Unidades</div>
                    <div class="table-actions">
                        <input type="text" placeholder="ðŸ” Buscar unidade..." 
                               style="background: #1E293B; border: 1px solid #374151; color: #F8FAFC; padding: 0.5rem 1rem; border-radius: 8px; margin-right: 1rem;" 
                               id="unitsSearchInput" onkeyup="searchUnits()">
                        <button class="btn btn-secondary" onclick="exportUnitsReport()">
                            ðŸ“Š RelatÃ³rio
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table-content">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>EndereÃ§o</th>
                                <th>Tatames</th>
                                <th>Capacidade</th>
                                <th>Turmas</th>
                                <th>ResponsÃ¡vel</th>
                                <th>Status</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="unitsTableBody">
                            <!-- Units will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="unitsLoadingState" class="loading-state">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ¢</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando unidades...</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                    </div>
                </div>
                <div id="unitsEmptyState" class="empty-state" style="display: none;">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ¢</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhuma unidade encontrada</div>
                        <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece cadastrando a primeira unidade da academia</div>
                        <button class="btn btn-primary" onclick="openAddUnitModal()">
                            <span>âž•</span>
                            Criar Primeira Unidade
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mats Management -->
        <div id="mats" class="content-section">
            <div class="page-header" style="background: linear-gradient(135deg, #1E293B 0%, #334155 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #8B5CF6, #EC4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ðŸ¥‹ GestÃ£o de Tatames</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #94A3B8; font-size: 1.1rem;">Administre espaÃ§os de treinamento, equipamentos e capacidades</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="openAddMatModal()" style="background: linear-gradient(135deg, #7C3AED, #8B5CF6); border: none; padding: 0.75rem 1.5rem;">
                            <span>âž•</span> Novo Tatame
                        </button>
                        <button class="btn btn-secondary" onclick="loadMats()" style="padding: 0.75rem 1.5rem;">
                            <span>ðŸ”„</span> Atualizar
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #8B5CF6;" id="matsCount">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Total Tatames</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #10B981;" id="matsCapacity">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Capacidade Total</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #3B82F6;" id="matsInUse">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Em Uso</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #F59E0B;" id="matsAvailable">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">DisponÃ­veis</div>
                    </div>
                </div>
            </div>

            <!-- Filter by Unit -->
            <div style="background: #1E293B; border-radius: 12px; padding: 1rem; margin-bottom: 2rem; border: 1px solid #334155;">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <label style="color: #CBD5E1; font-weight: 600;">Filtrar por Unidade:</label>
                    <select id="unitFilter" onchange="filterMatsByUnit()" style="background: #0F172A; border: 1px solid #374151; color: #F8FAFC; padding: 0.5rem 1rem; border-radius: 8px; min-width: 200px;">
                        <option value="">Todas as Unidades</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                    <button class="btn btn-secondary" onclick="clearMatFilters()" style="padding: 0.5rem 1rem;">
                        <span>ðŸ§¹</span> Limpar Filtros
                    </button>
                </div>
            </div>

            <!-- Mats Table -->
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">ðŸ“‹ Lista de Tatames</div>
                    <div class="table-actions">
                        <input type="text" placeholder="ðŸ” Buscar tatame..." 
                               style="background: #1E293B; border: 1px solid #374151; color: #F8FAFC; padding: 0.5rem 1rem; border-radius: 8px; margin-right: 1rem;" 
                               id="matsSearchInput" onkeyup="searchMats()">
                        <button class="btn btn-secondary" onclick="exportMatsReport()">
                            ðŸ“Š RelatÃ³rio
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table-content">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Unidade</th>
                                <th>Capacidade</th>
                                <th>DimensÃµes</th>
                                <th>Equipamentos</th>
                                <th>Turmas</th>
                                <th>Status</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="matsTableBody">
                            <!-- Mats will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="matsLoadingState" class="loading-state">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ¥‹</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando tatames...</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                    </div>
                </div>
                <div id="matsEmptyState" class="empty-state" style="display: none;">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ¥‹</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhum tatame encontrado</div>
                        <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece cadastrando o primeiro tatame</div>
                        <button class="btn btn-primary" onclick="openAddMatModal()">
                            <span>âž•</span>
                            Criar Primeiro Tatame
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Instructors Management -->
        <div id="instructors" class="content-section">
            <div class="page-header" style="background: linear-gradient(135deg, #1E293B 0%, #334155 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #F59E0B, #EF4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ðŸ‘¨â€ðŸ« GestÃ£o de Professores</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #94A3B8; font-size: 1.1rem;">Administre instrutores, especializaÃ§Ãµes e horÃ¡rios disponÃ­veis</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="openAddInstructorModal()" style="background: linear-gradient(135deg, #F59E0B, #EF4444); border: none; padding: 0.75rem 1.5rem;">
                            <span>âž•</span> Novo Professor
                        </button>
                        <button class="btn btn-secondary" onclick="loadInstructors()" style="padding: 0.75rem 1.5rem;">
                            <span>ðŸ”„</span> Atualizar
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #F59E0B;" id="instructorsCount">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Professores</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #10B981;" id="instructorsActive">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Ativos</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #3B82F6;" id="instructorsWithClasses">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Com Turmas</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #8B5CF6;" id="avgExperience">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Anos ExperiÃªncia</div>
                    </div>
                </div>
            </div>

            <!-- Instructors Table -->
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">ðŸ“‹ Lista de Professores</div>
                    <div class="table-actions">
                        <input type="text" placeholder="ðŸ” Buscar professor..." 
                               style="background: #1E293B; border: 1px solid #374151; color: #F8FAFC; padding: 0.5rem 1rem; border-radius: 8px; margin-right: 1rem;" 
                               id="instructorsSearchInput" onkeyup="searchInstructors()">
                        <button class="btn btn-secondary" onclick="exportInstructorsReport()">
                            ðŸ“Š RelatÃ³rio
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table-content">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>EspecializaÃ§Ãµes</th>
                                <th>Artes Marciais</th>
                                <th>ExperiÃªncia</th>
                                <th>Turmas</th>
                                <th>Valor/Hora</th>
                                <th>Status</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="instructorsTableBody">
                            <!-- Instructors will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="instructorsLoadingState" class="loading-state">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ‘¨â€ðŸ«</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando professores...</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                    </div>
                </div>
                <div id="instructorsEmptyState" class="empty-state" style="display: none;">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ‘¨â€ðŸ«</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhum professor encontrado</div>
                        <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece cadastrando o primeiro professor</div>
                        <button class="btn btn-primary" onclick="openAddInstructorModal()">
                            <span>âž•</span>
                            Cadastrar Primeiro Professor
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings -->
        <div id="settings" class="content-section">
            <div class="page-header">
                <h1>ConfiguraÃ§Ãµes</h1>
                <p>ConfiguraÃ§Ãµes gerais do sistema</p>
            </div>
            
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">Status do Sistema</div>
                </div>
                <div style="color: #CBD5E1;">
                    <p>â€¢ Banco de dados: âœ… Conectado</p>
                    <p>â€¢ APIs: âœ… 27 endpoints funcionais</p>
                    <p>â€¢ Frontend: âœ… Interface responsiva</p>
                    <p>â€¢ Dados: âœ… 4 alunos, 42 tÃ©cnicas, 48 aulas</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Debug Button for Testing Modal -->
    <div style="position: fixed; top: 10px; right: 10px; z-index: 9999;">
        <button onclick="openAddStudentModal()" style="background: #10B981; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">
            ðŸ§ª TESTE MODAL
        </button>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Adicionar Novo Aluno</h2>
                <button class="close-btn" onclick="closeModal('addStudentModal')">&times;</button>
            </div>
            <form id="addStudentForm">
                <div class="form-group">
                    <label class="form-label">Nome Completo</label>
                    <input type="text" class="form-input" id="studentName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="studentEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Telefone</label>
                    <input type="tel" class="form-input" id="studentPhone" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Data de Nascimento</label>
                    <input type="date" class="form-input" id="studentBirthDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">GÃªnero</label>
                    <select class="form-select" id="studentGender" required>
                        <option value="">Selecione...</option>
                        <option value="MASCULINO">Masculino</option>
                        <option value="FEMININO">Feminino</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Categoria</label>
                    <select class="form-select" id="studentCategory" required onchange="updateStudentPlanPreview()">
                        <option value="">Selecione...</option>
                        <option value="ADULT">Adulto</option>
                        <option value="INICIANTE1">Iniciante 1</option>
                        <option value="INICIANTE2">Iniciante 2</option>
                        <option value="INTERMEDIARIO1">IntermediÃ¡rio 1</option>
                        <option value="INTERMEDIARIO2">IntermediÃ¡rio 2</option>
                        <option value="AVANCADO1">AvanÃ§ado 1</option>
                        <option value="AVANCADO2">AvanÃ§ado 2</option>
                        <option value="MASTER">Master</option>
                        <option value="INSTRUCTOR">Instrutor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Turma</label>
                    <select class="form-select" id="studentClass" required>
                        <option value="">Selecione uma turma...</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Plano de Pagamento</label>
                    <select class="form-select" id="studentBillingPlan" onchange="onPlanChange()">
                        <option value="">Selecione um plano (opcional)</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                    <small style="color: #94A3B8; margin-top: 0.5rem; display: block;">
                        Selecione um plano de pagamento ou deixe em branco para seleÃ§Ã£o automÃ¡tica
                    </small>
                </div>

                <!-- Container para seleÃ§Ã£o de turmas baseada no plano -->
                <div id="classesSelectionContainer" style="display: none;" class="form-group">
                    <label class="form-label">ðŸŽ¯ Turmas</label>
                    <!-- ConteÃºdo serÃ¡ preenchido dinamicamente -->
                </div>

                <!-- Container para seleÃ§Ã£o de cursos baseada no plano -->
                <div id="coursesSelectionContainer" style="display: none;" class="form-group">
                    <label class="form-label">ðŸ“š Cursos</label>
                    <!-- ConteÃºdo serÃ¡ preenchido dinamicamente -->
                </div>

                <!-- Container para exibiÃ§Ã£o do custo total -->
                <div id="totalCostDisplay" style="display: none;" class="form-group">
                    <!-- ConteÃºdo serÃ¡ preenchido dinamicamente -->
                </div>
                <div class="form-group">
                    <label class="form-label">Curso</label>
                    <select class="form-select" id="studentCourse" onchange="updateStudentPlanPreview()">
                        <option value="">Selecione um curso (opcional)</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ResponsÃ¡vel Financeiro</label>
                    <select class="form-select" id="studentFinancialResponsible">
                        <option value="">Selecione um responsÃ¡vel (opcional)</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                    <small style="color: #94A3B8; margin-top: 0.5rem; display: block;">
                        Selecione um responsÃ¡vel financeiro existente ou deixe em branco se o prÃ³prio aluno Ã© responsÃ¡vel
                    </small>
                </div>
                
                <!-- Intelligent Plan Preview -->
                <div id="studentPlanPreview" class="form-section" style="display: none;">
                    <h3>ðŸ’° Plano AutomÃ¡tico</h3>
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #10B981;">
                        <div style="color: #10B981; font-weight: bold; margin-bottom: 0.5rem;" id="previewStudentPlanName">Nome do Plano</div>
                        <div style="color: #F8FAFC; font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;" id="previewStudentPlanPrice">R$ 0,00</div>
                        <div style="color: #CBD5E1; font-size: 0.9rem;" id="previewStudentPlanDescription">DescriÃ§Ã£o do plano</div>
                        <div style="color: #94A3B8; font-size: 0.8rem; margin-top: 0.5rem;">
                            âœ… MatrÃ­cula automÃ¡tica no curso e plano serÃ¡ criada
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addStudentModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar Aluno</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Student Modal - Complete Version -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2 id="editStudentModalTitle">Editar Aluno</h2>
                <span class="close" onclick="closeEditStudentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Student Summary Card -->
                <div style="padding: 1.5rem 2rem; background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                ðŸ‘¤
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 1.25rem;" id="editStudentSummaryName">Nome do Aluno</h3>
                                <div style="display: flex; gap: 1rem; margin-top: 0.25rem; font-size: 0.875rem; opacity: 0.9;">
                                    <span id="editStudentSummaryId">ID: -</span>
                                    <span id="editStudentSummaryCategory">Categoria: -</span>
                                    <span id="editStudentSummaryStatus">Status: Ativo</span>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem;">
                                ðŸ’¾ Modificado hÃ¡ <span id="editStudentLastModified">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Tabs Navigation -->
                <div style="padding: 0 2rem; background: #1E293B; border-bottom: 1px solid #334155;">
                    <div style="display: flex; gap: 0;">
                        <!-- Primary Tab (Edit) -->
                        <button class="edit-tab-btn active primary" onclick="switchEditTab('edit')" data-tab="edit" 
                                style="padding: 1rem 2rem; background: linear-gradient(135deg, #3B82F6, #1D4ED8); border: none; color: white; border-radius: 8px 8px 0 0; font-weight: 700; cursor: pointer; position: relative; z-index: 2; margin-right: 1rem;">
                            âœï¸ Editar Dados
                        </button>
                        <!-- Secondary Tabs (View) -->
                        <div style="display: flex; gap: 0.25rem; align-items: end;">
                            <button class="edit-tab-btn secondary" onclick="switchEditTab('overview')" data-tab="overview" 
                                    style="padding: 0.75rem 1.25rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                                ðŸ“‹ VisÃ£o Geral
                            </button>
                            <button class="edit-tab-btn secondary" onclick="switchEditTab('academic')" data-tab="academic" 
                                    style="padding: 0.75rem 1.25rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                                ðŸŽ“ AcadÃªmico
                            </button>
                            <button class="edit-tab-btn secondary" onclick="switchEditTab('financial')" data-tab="financial" 
                                    style="padding: 0.75rem 1.25rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                                ðŸ’° Financeiro
                            </button>
                            <button class="edit-tab-btn secondary" onclick="switchEditTab('progress')" data-tab="progress" 
                                    style="padding: 0.75rem 1.25rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                                ðŸ“ˆ Progresso
                            </button>
                            <button class="edit-tab-btn secondary" onclick="switchEditTab('activity')" data-tab="activity" 
                                    style="padding: 0.75rem 1.25rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                                ðŸ“Š Atividades
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab Contents -->
                <div style="padding: 2rem;">
                    <!-- Edit Tab -->
                    <div id="edit-tab-edit" class="edit-tab-content">
                        <!-- Progress Indicator -->
                        <div style="background: #0F172A; padding: 1rem 2rem; margin: -2rem -2rem 2rem -2rem; border-bottom: 1px solid #334155;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <h3 style="color: #F8FAFC; margin: 0; font-size: 1.1rem;">ðŸ“ Editando Perfil</h3>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <div style="width: 8px; height: 8px; background: #10B981; border-radius: 50%;"></div>
                                        <span style="color: #10B981; font-size: 0.875rem;">Dados salvos automaticamente</span>
                                    </div>
                                    <button type="button" onclick="autoFillDemo()" style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8B5CF6; color: #8B5CF6; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                                        ðŸŽ¯ Preencher Demo
                                    </button>
                                </div>
                            </div>
                            <div style="background: #1E293B; border-radius: 6px; height: 4px; overflow: hidden;">
                                <div id="editFormProgress" style="background: linear-gradient(90deg, #3B82F6, #10B981); height: 100%; width: 20%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>

                        <form id="editStudentForm" onchange="updateFormProgress()">
                            <input type="hidden" id="editStudentId" name="editStudentId">
                            <input type="hidden" id="editUserId" name="editUserId">
                            
                            <!-- Step 1: InformaÃ§Ãµes Pessoais -->
                            <div class="form-section" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05)); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #3B82F6, #1D4ED8); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.875rem;">1</div>
                                    <h3 style="color: #F8FAFC; margin: 0; font-size: 1.1rem;">ðŸ‘¤ Dados Pessoais</h3>
                                    <div style="flex: 1; height: 1px; background: linear-gradient(90deg, #3B82F6, transparent);"></div>
                                </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editFirstName">Nome *</label>
                                <input type="text" id="editFirstName" name="editFirstName" required>
                            </div>
                            <div class="form-group">
                                <label for="editLastName">Sobrenome *</label>
                                <input type="text" id="editLastName" name="editLastName" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editEmail">Email *</label>
                                <input type="email" id="editEmail" name="editEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="editPhone">Telefone</label>
                                <input type="tel" id="editPhone" name="editPhone">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCpf">CPF</label>
                                <input type="text" id="editCpf" name="editCpf" placeholder="000.000.000-00">
                            </div>
                            <div class="form-group">
                                <label for="editBirthDate">Data de Nascimento</label>
                                <input type="date" id="editBirthDate" name="editBirthDate">
                            </div>
                        </div>
                    </div>

                            </div>

                            <!-- Step 2: InformaÃ§Ãµes da Academia -->
                            <div class="form-section" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(139, 92, 246, 0.05)); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #10B981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.875rem;">2</div>
                                    <h3 style="color: #F8FAFC; margin: 0; font-size: 1.1rem;">ðŸ¥‹ Academia</h3>
                                    <div style="flex: 1; height: 1px; background: linear-gradient(90deg, #10B981, transparent);"></div>
                                </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCategory">Categoria *</label>
                                <select id="editCategory" name="editCategory" required>
                                    <option value="ADULT">Adulto</option>
                                    <option value="INICIANTE1">Iniciante 1</option>
                                    <option value="INICIANTE2">Iniciante 2</option>
                                    <option value="MASTER1">Master 1</option>
                                    <option value="MASTER2">Master 2</option>
                                    <option value="MASTER3">Master 3</option>
                                    <option value="HEROI1">HerÃ³i 1</option>
                                    <option value="HEROI2">HerÃ³i 2</option>
                                    <option value="HEROI3">HerÃ³i 3</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editGender">GÃªnero *</label>
                                <select id="editGender" name="editGender" required>
                                    <option value="MASCULINO">Masculino</option>
                                    <option value="FEMININO">Feminino</option>
                                    <option value="OUTRO">Outro</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editPhysicalCondition">CondiÃ§Ã£o FÃ­sica</label>
                                <select id="editPhysicalCondition" name="editPhysicalCondition">
                                    <option value="INICIANTE">Iniciante</option>
                                    <option value="BASICO">BÃ¡sico</option>
                                    <option value="INTERMEDIARIO">IntermediÃ¡rio</option>
                                    <option value="AVANCADO">AvanÃ§ado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editEnrollmentDate">Data de MatrÃ­cula</label>
                                <input type="date" id="editEnrollmentDate" name="editEnrollmentDate">
                            </div>
                        </div>
                    </div>

                            </div>

                            <!-- Step 3: InformaÃ§Ãµes MÃ©dicas -->
                            <div class="form-section" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(245, 158, 11, 0.05)); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(239, 68, 68, 0.2);">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #EF4444, #DC2626); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.875rem;">3</div>
                                    <h3 style="color: #F8FAFC; margin: 0; font-size: 1.1rem;">ðŸ¥ SaÃºde & EmergÃªncia</h3>
                                    <div style="flex: 1; height: 1px; background: linear-gradient(90deg, #EF4444, transparent);"></div>
                                </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="editMedicalConditions">CondiÃ§Ãµes MÃ©dicas</label>
                                <textarea id="editMedicalConditions" name="editMedicalConditions" rows="3" 
                                          placeholder="Alergias, medicamentos, limitaÃ§Ãµes fÃ­sicas, etc."></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editEmergencyContact">Contato de EmergÃªncia</label>
                                <input type="text" id="editEmergencyContact" name="editEmergencyContact" 
                                       placeholder="Nome e telefone">
                            </div>
                            <div class="form-group">
                                <label for="editSpecialNeeds">Necessidades Especiais</label>
                                <select id="editSpecialNeeds" name="editSpecialNeeds" multiple>
                                    <option value="TEA">TEA (Autismo)</option>
                                    <option value="TDAH">TDAH</option>
                                    <option value="MobilidadeReduzida">Mobilidade Reduzida</option>
                                    <option value="DeficienciaVisual">DeficiÃªncia Visual</option>
                                    <option value="DeficienciaAuditiva">DeficiÃªncia Auditiva</option>
                                </select>
                            </div>
                        </div>
                    </div>

                            </div>

                            <!-- Step 4: Status e Progresso (Read-only) -->
                            <div class="form-section" id="editProgressSection" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(99, 102, 241, 0.05)); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #8B5CF6, #7C3AED); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.875rem;">4</div>
                                    <h3 style="color: #F8FAFC; margin: 0; font-size: 1.1rem;">ðŸ“Š EstatÃ­sticas (Somente Leitura)</h3>
                                    <div style="flex: 1; height: 1px; background: linear-gradient(90deg, #8B5CF6, transparent);"></div>
                                </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTotalXP">XP Total</label>
                                <input type="number" id="editTotalXP" name="editTotalXP" readonly>
                            </div>
                            <div class="form-group">
                                <label for="editGlobalLevel">NÃ­vel Global</label>
                                <input type="number" id="editGlobalLevel" name="editGlobalLevel" readonly>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCurrentStreak">SequÃªncia Atual</label>
                                <input type="number" id="editCurrentStreak" name="editCurrentStreak" readonly>
                            </div>
                            <div class="form-group">
                                <label for="editLastCheckinDate">Ãšltima PresenÃ§a</label>
                                <input type="datetime-local" id="editLastCheckinDate" name="editLastCheckinDate" readonly>
                            </div>
                        </div>
                        </form>
                    </div>

                        </form>
                    </div>

                    <!-- Overview Tab -->
                    <div id="edit-tab-overview" class="edit-tab-content" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <!-- Personal Summary -->
                            <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <h4 style="color: #3B82F6; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>ðŸ‘¤</span> InformaÃ§Ãµes Pessoais
                                </h4>
                                <div style="display: grid; gap: 0.75rem; color: #CBD5E1;">
                                    <div><strong>Nome:</strong> <span id="overviewFullName">-</span></div>
                                    <div><strong>Email:</strong> <span id="overviewEmail">-</span></div>
                                    <div><strong>Telefone:</strong> <span id="overviewPhone">-</span></div>
                                    <div><strong>CPF:</strong> <span id="overviewCpf">-</span></div>
                                </div>
                            </div>

                            <!-- Academy Summary -->
                            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(139, 92, 246, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                                <h4 style="color: #10B981; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>ðŸ¥‹</span> Status Academia
                                </h4>
                                <div style="display: grid; gap: 0.75rem; color: #CBD5E1;">
                                    <div><strong>Categoria:</strong> <span id="overviewCategory">-</span></div>
                                    <div><strong>Status:</strong> <span id="overviewStatus">-</span></div>
                                    <div><strong>MatrÃ­cula:</strong> <span id="overviewEnrollment">-</span></div>
                                    <div><strong>CondiÃ§Ã£o FÃ­sica:</strong> <span id="overviewPhysical">-</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Academic Tab -->
                    <div id="edit-tab-academic" class="edit-tab-content" style="display: none;">
                        <div style="text-align: center; padding: 3rem; color: #6B7280;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸŽ“</div>
                            <p>Carregando informaÃ§Ãµes acadÃªmicas...</p>
                        </div>
                    </div>

                    <div id="edit-tab-classes" class="edit-tab-content" style="display: none;">
                        <div style="text-align: center; padding: 3rem; color: #6B7280;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ«</div>
                            <p>Carregando informaÃ§Ãµes de turmas...</p>
                        </div>
                    </div>

                    <!-- Progress Tab -->
                    <div id="edit-tab-progress" class="edit-tab-content" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                            <!-- XP Stats -->
                            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(139, 92, 246, 0.3); text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">â­</div>
                                <div style="color: #8B5CF6; font-size: 1.5rem; font-weight: bold;" id="progressXP">1,250</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">XP Total</div>
                            </div>
                            <!-- Level -->
                            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(16, 185, 129, 0.3); text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ†</div>
                                <div style="color: #10B981; font-size: 1.5rem; font-weight: bold;" id="progressLevel">NÃ­vel 5</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">GraduaÃ§Ã£o</div>
                            </div>
                            <!-- Streak -->
                            <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(245, 158, 11, 0.3); text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ”¥</div>
                                <div style="color: #F59E0B; font-size: 1.5rem; font-weight: bold;" id="progressStreak">7 dias</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">SequÃªncia</div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Tab -->
                    <div id="edit-tab-financial" class="edit-tab-content" style="display: none;">
                        <!-- Current Plan Section -->
                        <div style="margin-bottom: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 style="color: #F8FAFC; margin: 0; font-size: 1.25rem;">ðŸ“‹ Plano Atual</h3>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-secondary btn-sm" onclick="loadStudentFinancialTab()" style="padding: 0.5rem 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; font-size: 0.875rem;">
                                        ðŸ”„ Atualizar
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="openEditStudentPlan()" style="padding: 0.5rem 1rem;">
                                        âœï¸ Editar Plano
                                    </button>
                                </div>
                            </div>
                            
                            <div id="currentPlanContainer" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(29, 78, 216, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <div class="loading-state">
                                    <div style="text-align: center; color: #94A3B8;">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸ“„</div>
                                        <p>Carregando informaÃ§Ãµes do plano...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <!-- Payment Status -->
                            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                                <h4 style="color: #10B981; margin: 0 0 1rem 0;">ðŸ’³ Status Pagamento</h4>
                                <div id="paymentStatusContainer" style="color: #CBD5E1;">
                                    <div class="loading-state">
                                        <div style="text-align: center; color: #94A3B8;">
                                            <p>Carregando status...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payment History -->
                            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(124, 58, 237, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                                <h4 style="color: #8B5CF6; margin: 0 0 1rem 0;">ðŸ“Š HistÃ³rico de Pagamentos</h4>
                                <div id="paymentHistoryContainer" style="color: #CBD5E1; font-size: 0.875rem;">
                                    <div class="loading-state">
                                        <div style="text-align: center; color: #94A3B8;">
                                            <p>Carregando histÃ³rico...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Available Plans for Upgrade -->
                        <div style="margin-top: 2rem;">
                            <h3 style="color: #F8FAFC; margin: 0 0 1rem 0; font-size: 1.25rem;">ðŸš€ Planos DisponÃ­veis para Upgrade</h3>
                            <div id="availablePlansContainer" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(217, 119, 6, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                                <div class="loading-state">
                                    <div style="text-align: center; color: #94A3B8;">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">â¬†ï¸</div>
                                        <p>Carregando planos disponÃ­veis...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Tab -->
                    <div id="edit-tab-activity" class="edit-tab-content" style="display: none;">
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(29, 78, 216, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">ðŸ“Š FrequÃªncia Recente</h4>
                            <div style="color: #CBD5E1;">
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #374151;">
                                    <span>02/07/2025 - Aula 15</span>
                                    <span style="color: #10B981;">âœ… Presente</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #374151;">
                                    <span>27/06/2025 - Aula 14</span>
                                    <span style="color: #10B981;">âœ… Presente</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #374151;">
                                    <span>25/06/2025 - Aula 13</span>
                                    <span style="color: #EF4444;">âŒ Ausente</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditStudentModal()">
                    Cancelar
                </button>
                <button type="button" id="saveEditStudentBtn" class="btn btn-primary" onclick="saveEditStudent()">
                    ðŸ’¾ Salvar AlteraÃ§Ãµes
                </button>
            </div>
        </div>
    </div>

    <!-- Add Financial Responsible Modal -->
    <div id="addResponsibleModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2 class="modal-title">Novo ResponsÃ¡vel Financeiro</h2>
                <button class="close-btn" onclick="closeModal('addResponsibleModal')">&times;</button>
            </div>
            <form id="addResponsibleForm">
                <div class="form-section">
                    <h3>Dados Pessoais</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-input" id="responsibleName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CPF/CNPJ *</label>
                            <input type="text" class="form-input" id="responsibleCpfCnpj" required placeholder="000.000.000-00">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-input" id="responsibleEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefone</label>
                            <input type="tel" class="form-input" id="responsiblePhone" placeholder="(11) 99999-9999">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-input" id="responsibleBirthDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de RelaÃ§Ã£o</label>
                            <select class="form-select" id="responsibleRelationType">
                                <option value="">Selecione...</option>
                                <option value="PARENT">Pai/MÃ£e</option>
                                <option value="GUARDIAN">ResponsÃ¡vel Legal</option>
                                <option value="SPOUSE">CÃ´njuge</option>
                                <option value="RELATIVE">Familiar</option>
                                <option value="OTHER">Outro</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>EndereÃ§o</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">EndereÃ§o</label>
                            <input type="text" class="form-input" id="responsibleAddress" placeholder="Rua, Avenida, etc.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">NÃºmero</label>
                            <input type="text" class="form-input" id="responsibleAddressNumber" placeholder="123">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Complemento</label>
                            <input type="text" class="form-input" id="responsibleComplement" placeholder="Apto, Bloco, etc.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bairro</label>
                            <input type="text" class="form-input" id="responsibleNeighborhood">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-input" id="responsibleCity">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="responsibleState">
                                <option value="">Selecione...</option>
                                <option value="SP">SÃ£o Paulo</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="ES">EspÃ­rito Santo</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="PR">ParanÃ¡</option>
                                <option value="RS">Rio Grande do Sul</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-input" id="responsibleZipCode" placeholder="00000-000">
                        </div>
                        <div class="form-group"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addResponsibleModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar ResponsÃ¡vel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Financial Responsible Modal -->
    <div id="editResponsibleModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2 class="modal-title">Editar ResponsÃ¡vel Financeiro</h2>
                <button class="close-btn" onclick="closeModal('editResponsibleModal')">&times;</button>
            </div>
            <form id="editResponsibleForm">
                <input type="hidden" id="editResponsibleId">
                <div class="form-section">
                    <h3>Dados Pessoais</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-input" id="editResponsibleName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CPF/CNPJ *</label>
                            <input type="text" class="form-input" id="editResponsibleCpfCnpj" required readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-input" id="editResponsibleEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefone</label>
                            <input type="tel" class="form-input" id="editResponsiblePhone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-input" id="editResponsibleBirthDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de RelaÃ§Ã£o</label>
                            <select class="form-select" id="editResponsibleRelationType">
                                <option value="">Selecione...</option>
                                <option value="PARENT">Pai/MÃ£e</option>
                                <option value="GUARDIAN">ResponsÃ¡vel Legal</option>
                                <option value="SPOUSE">CÃ´njuge</option>
                                <option value="RELATIVE">Familiar</option>
                                <option value="OTHER">Outro</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editResponsibleModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar AlteraÃ§Ãµes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modern Plan Creation Modal with Tabs -->
    <div id="addPlanModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">âœ¨ Criar Novo Plano de Pagamento</h2>
                <button class="close-btn" onclick="closeModal('addPlanModal')">&times;</button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="plan-tabs">
                <button type="button" class="plan-tab active" onclick="switchPlanTab('basic')" data-tab="basic">
                    ðŸ“‹ InformaÃ§Ãµes BÃ¡sicas
                </button>
                <button type="button" class="plan-tab" onclick="switchPlanTab('courses')" data-tab="courses">
                    ðŸŽ“ Cursos Associados
                </button>
                <button type="button" class="plan-tab" onclick="switchPlanTab('advanced')" data-tab="advanced">
                    âš™ï¸ ConfiguraÃ§Ãµes
                </button>
                <button type="button" class="plan-tab" onclick="switchPlanTab('preview')" data-tab="preview">
                    ðŸ‘ï¸ Preview
                </button>
            </div>
            
            <form id="addPlanForm">
                <!-- Tab 1: Basic Information -->
                <div id="planTab-basic" class="plan-tab-content active">
                    <div class="tab-header">
                        <h3>ðŸ“‹ InformaÃ§Ãµes BÃ¡sicas do Plano</h3>
                        <p>Configure os dados fundamentais do seu plano de pagamento</p>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Nome do Plano *</label>
                            <input type="text" class="form-input" id="planName" placeholder="Ex: Plano Premium Krav Maga" required>
                            <small class="form-hint">ðŸ”„ SerÃ¡ gerado automaticamente baseado nos cursos selecionados</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Categoria *</label>
                            <select class="form-select" id="planCategory" required onchange="updatePlanPreview()">
                                <option value="">Selecione uma categoria...</option>
                                <option value="ADULT">ðŸ‘¨ Adulto</option>
                                <option value="FEMALE">ðŸ‘© Feminino</option>
                                <option value="SENIOR">ðŸ‘´ Senior/Idoso</option>
                                <option value="CHILD">ðŸ§’ Infantil/CrianÃ§a</option>
                                <option value="INICIANTE1">ðŸ¥‰ Iniciante 1</option>
                                <option value="INICIANTE2">ðŸ¥‰ Iniciante 2</option>
                                <option value="INICIANTE3">ðŸ¥‰ Iniciante 3</option>
                                <option value="HEROI1">ðŸ¥ˆ HerÃ³i 1</option>
                                <option value="HEROI2">ðŸ¥ˆ HerÃ³i 2</option>
                                <option value="HEROI3">ðŸ¥ˆ HerÃ³i 3</option>
                                <option value="MASTER_1">ðŸ¥‡ Master 1</option>
                                <option value="MASTER_2">ðŸ¥‡ Master 2</option>
                                <option value="MASTER_3">ðŸ¥‡ Master 3</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Valor do Plano *</label>
                            <input type="number" class="form-input" id="planCustomPrice" step="0.01" placeholder="R$ 0,00" required>
                            <small class="form-hint">ðŸ’° Insira o valor do plano conforme sua estratÃ©gia de preÃ§os</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tipo de CobranÃ§a *</label>
                            <select class="form-select" id="planBillingType" required onchange="updatePlanPreview()">
                                <option value="MONTHLY">ðŸ’³ Mensal</option>
                                <option value="WEEKLY">ðŸ“… Semanal</option>
                                <option value="QUARTERLY">ðŸ“Š Trimestral</option>
                                <option value="YEARLY">ðŸ—“ï¸ Anual</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label">DescriÃ§Ã£o do Plano</label>
                        <textarea class="form-input" id="planDescription" rows="3" placeholder="DescriÃ§Ã£o detalhada dos benefÃ­cios e caracterÃ­sticas do plano..."></textarea>
                    </div>
                    
                    <div class="tab-navigation">
                        <button type="button" class="btn btn-primary" onclick="switchPlanTab('courses')">
                            PrÃ³ximo: Cursos Associados â†’
                        </button>
                    </div>
                </div>
                
                <!-- Tab 2: Associated Courses -->
                <div id="planTab-courses" class="plan-tab-content">
                    <div class="tab-header">
                        <h3>ðŸŽ“ Cursos Associados ao Plano</h3>
                        <p>Selecione todos os cursos que estarÃ£o inclusos neste plano</p>
                    </div>
                    
                    <div class="courses-selection-container">
                        <div class="selection-header">
                            <div class="selection-stats">
                                <span class="stat-badge" id="coursesSelectedCount">0 cursos selecionados</span>
                                <span class="stat-badge" id="coursesTotalCount">0 cursos disponÃ­veis</span>
                            </div>
                            <div class="selection-actions">
                                <button type="button" class="btn btn-sm btn-outline" onclick="selectAllCourses()">Selecionar Todos</button>
                                <button type="button" class="btn btn-sm btn-outline" onclick="clearAllCourses()">Limpar SeleÃ§Ã£o</button>
                            </div>
                        </div>
                        
                        <div class="courses-grid" id="coursesGrid">
                            <!-- Courses will be loaded here dynamically -->
                            <div class="loading-state">
                                <div class="spinner"></div>
                                <p>Carregando cursos disponÃ­veis...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-navigation">
                        <button type="button" class="btn btn-secondary" onclick="switchPlanTab('basic')">
                            â† Voltar: InformaÃ§Ãµes BÃ¡sicas
                        </button>
                        <button type="button" class="btn btn-primary" onclick="switchPlanTab('advanced')">
                            PrÃ³ximo: ConfiguraÃ§Ãµes â†’
                        </button>
                    </div>
                </div>
                
                <!-- Tab 3: Advanced Configuration -->
                <div id="planTab-advanced" class="plan-tab-content">
                    <div class="tab-header">
                        <h3>âš™ï¸ ConfiguraÃ§Ãµes AvanÃ§adas</h3>
                        <p>Configure recursos especiais e limitaÃ§Ãµes do plano</p>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Aulas por Semana</label>
                            <select class="form-select" id="planClassesPerWeek">
                                <option value="1">1 aula por semana</option>
                                <option value="2" selected>2 aulas por semana</option>
                                <option value="3">3 aulas por semana</option>
                                <option value="4">4 aulas por semana</option>
                                <option value="5">5 aulas por semana</option>
                                <option value="unlimited">â™¾ï¸ Ilimitado</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">MÃ¡ximo de Aulas por MÃªs</label>
                            <input type="number" class="form-input" id="planMaxClasses" min="1" max="50" placeholder="Ex: 8 aulas">
                            <small class="form-hint">Deixe em branco para ilimitado</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Recursos Extras</label>
                        <div class="extras-grid">
                            <label class="checkbox-label">
                                <input type="checkbox" id="planPersonalTraining"> 
                                ðŸ’ª Personal Training
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="planNutrition"> 
                                ðŸ¥— Plano Nutricional
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="planAllModalities"> 
                                ðŸ¥‹ Todas Modalidades
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="planFreezeOption"> 
                                â„ï¸ Permite Congelar
                            </label>
                        </div>
                    </div>
                    
                    <div class="tab-navigation">
                        <button type="button" class="btn btn-secondary" onclick="switchPlanTab('courses')">
                            â† Voltar: Cursos Associados
                        </button>
                        <button type="button" class="btn btn-primary" onclick="switchPlanTab('preview')">
                            PrÃ³ximo: Preview â†’
                        </button>
                    </div>
                </div>
                
                <!-- Tab 4: Preview -->
                <div id="planTab-preview" class="plan-tab-content">
                    <div class="tab-header">
                        <h3>ðŸ‘ï¸ Preview do Plano</h3>
                        <p>Visualize como o plano ficarÃ¡ antes de criar</p>
                    </div>
                    
                    <div id="planPreview" class="preview-container">
                        <div class="preview-card">
                            <div class="preview-header">
                                <h4 id="previewPlanName">Nome do Plano</h4>
                                <div class="preview-price" id="previewPlanPrice">R$ 0,00</div>
                            </div>
                            <div class="preview-body">
                                <p id="previewPlanDescription">DescriÃ§Ã£o do plano</p>
                                <div class="preview-details">
                                    <div class="detail-item">
                                        <span class="detail-label">Categoria:</span>
                                        <span class="detail-value" id="previewCategory">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Tipo de CobranÃ§a:</span>
                                        <span class="detail-value" id="previewBillingType">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Cursos Inclusos:</span>
                                        <span class="detail-value" id="previewCourses">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Aulas por Semana:</span>
                                        <span class="detail-value" id="previewClassesPerWeek">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-navigation">
                        <button type="button" class="btn btn-secondary" onclick="switchPlanTab('advanced')">
                            â† Voltar: ConfiguraÃ§Ãµes
                        </button>
                        <button type="submit" class="btn btn-primary btn-large">
                            âœ¨ Criar Plano
                        </button>
                    </div>
                </div>
                
                <!-- Hidden legacy field for compatibility -->
                <select id="planCourse" multiple style="display: none;"></select>
            </form>
        </div>
    </div>
            </form>
        </div>
    </div>

    <!-- Add Course Modal -->
    <div id="addCourseModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Novo Curso</h2>
                <button class="close-btn" onclick="closeModal('addCourseModal')">&times;</button>
            </div>
            <form id="addCourseForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Nome do Curso</label>
                        <input type="text" class="form-input" id="courseName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select class="form-select" id="courseCategory" required>
                            <option value="ADULT">Adulto</option>
                            <option value="INICIANTE1">Iniciante 1</option>
                            <option value="INICIANTE2">Iniciante 2</option>
                            <option value="INICIANTE3">Iniciante 3</option>
                            <option value="HEROI1">HerÃ³i 1</option>
                            <option value="HEROI2">HerÃ³i 2</option>
                            <option value="HEROI3">HerÃ³i 3</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">DescriÃ§Ã£o</label>
                    <textarea class="form-input" id="courseDescription" rows="3"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">NÃ­vel</label>
                        <select class="form-select" id="courseLevel" required>
                            <option value="BEGINNER">Iniciante</option>
                            <option value="INTERMEDIATE">IntermediÃ¡rio</option>
                            <option value="ADVANCED">AvanÃ§ado</option>
                            <option value="EXPERT">Especialista</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total de Aulas</label>
                        <input type="number" class="form-input" id="courseTotalClasses" min="1" max="100" value="48" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Aulas por Semana</label>
                        <input type="number" class="form-input" id="courseClassesPerWeek" min="1" max="7" value="2" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">DuraÃ§Ã£o (semanas)</label>
                        <input type="number" class="form-input" id="courseDuration" min="1" max="52" value="24" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Idade MÃ­nima</label>
                        <input type="number" class="form-input" id="courseMinAge" min="5" max="100" value="16" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Idade MÃ¡xima</label>
                        <input type="number" class="form-input" id="courseMaxAge" min="5" max="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Objetivos do Curso (um por linha)</label>
                    <textarea class="form-input" id="courseObjectives" rows="4" 
                        placeholder="Ex: Desenvolver tÃ©cnicas bÃ¡sicas de defesa pessoal&#10;Melhorar condicionamento fÃ­sico&#10;Aumentar autoconfianÃ§a"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Requisitos (um por linha)</label>
                    <textarea class="form-input" id="courseRequirements" rows="3" 
                        placeholder="Ex: Atestado mÃ©dico&#10;Termo de responsabilidade&#10;Uniforme adequado"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCourseModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Curso</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Course Modal -->
    <div id="editCourseModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Editar Curso</h2>
                <button class="close-btn" onclick="closeModal('editCourseModal')">&times;</button>
            </div>
            <form id="editCourseForm">
                <input type="hidden" id="editCourseId">
                <!-- Same fields as add course, but with edit prefix -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Nome do Curso</label>
                        <input type="text" class="form-input" id="editCourseName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select class="form-select" id="editCourseCategory" required>
                            <option value="ADULT">Adulto</option>
                            <option value="INICIANTE1">Iniciante 1</option>
                            <option value="INICIANTE2">Iniciante 2</option>
                            <option value="INICIANTE3">Iniciante 3</option>
                            <option value="HEROI1">HerÃ³i 1</option>
                            <option value="HEROI2">HerÃ³i 2</option>
                            <option value="HEROI3">HerÃ³i 3</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">DescriÃ§Ã£o</label>
                    <textarea class="form-input" id="editCourseDescription" rows="3"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">NÃ­vel</label>
                        <select class="form-select" id="editCourseLevel" required>
                            <option value="BEGINNER">Iniciante</option>
                            <option value="INTERMEDIATE">IntermediÃ¡rio</option>
                            <option value="ADVANCED">AvanÃ§ado</option>
                            <option value="EXPERT">Especialista</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total de Aulas</label>
                        <input type="number" class="form-input" id="editCourseTotalClasses" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Aulas por Semana</label>
                        <input type="number" class="form-input" id="editCourseClassesPerWeek" min="1" max="7" required>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editCourseModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar AlteraÃ§Ãµes</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Add Subscription Modal -->
    <div id="addSubscriptionModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Nova Assinatura</h2>
                <button class="close-btn" onclick="closeModal('addSubscriptionModal')">&times;</button>
            </div>
            <form id="addSubscriptionForm">
                <div class="form-group">
                    <label class="form-label">Aluno</label>
                    <select class="form-select" id="subscriptionStudent" required>
                        <option value="">Selecione um aluno...</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Plano</label>
                    <select class="form-select" id="subscriptionPlan" required>
                        <option value="">Selecione um plano...</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Data de InÃ­cio</label>
                        <input type="date" class="form-input" id="subscriptionStartDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">PreÃ§o Personalizado (opcional)</label>
                        <input type="number" class="form-input" id="subscriptionCustomPrice" placeholder="Deixe vazio para usar preÃ§o do plano" step="0.01" min="0">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addSubscriptionModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Assinatura</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lesson Plan Modal -->
    <div id="lessonPlanModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Plano de Aula</h2>
                <button class="close-btn" onclick="closeModal('lessonPlanModal')">&times;</button>
            </div>
            <form id="lessonPlanForm">
                <input type="hidden" id="lessonCourseId">
                <input type="hidden" id="lessonNumber">
                
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">TÃ­tulo da Aula</label>
                        <input type="text" class="form-input" id="lessonTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">DuraÃ§Ã£o (min)</label>
                        <input type="number" class="form-input" id="lessonDuration" min="30" max="180" value="60" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dificuldade</label>
                        <select class="form-select" id="lessonDifficulty" required>
                            <option value="BEGINNER">Iniciante</option>
                            <option value="INTERMEDIATE">IntermediÃ¡rio</option>
                            <option value="ADVANCED">AvanÃ§ado</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Objetivos da Aula</label>
                    <textarea class="form-input" id="lessonObjectives" rows="2" 
                        placeholder="Ex: Aprender tÃ©cnica de soco direto, Praticar defesa contra estrangulamento"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Aquecimento (10-15 min)</label>
                    <textarea class="form-input" id="lessonWarmUp" rows="3" 
                        placeholder="Ex: Corrida leve, alongamento dinÃ¢mico, exercÃ­cios articulares"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ConteÃºdo Principal (30-40 min)</label>
                    <textarea class="form-input" id="lessonMainContent" rows="4" 
                        placeholder="Ex: DemonstraÃ§Ã£o da tÃ©cnica, prÃ¡tica em pares, aplicaÃ§Ã£o em situaÃ§Ãµes simuladas"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Desaquecimento (5-10 min)</label>
                    <textarea class="form-input" id="lessonCoolDown" rows="2" 
                        placeholder="Ex: Alongamento estÃ¡tico, respiraÃ§Ã£o, relaxamento"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Equipamentos NecessÃ¡rios</label>
                    <input type="text" class="form-input" id="lessonEquipment" 
                        placeholder="Ex: Paos, luvas, colchonetes (separar por vÃ­rgula)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">AdaptaÃ§Ãµes para Necessidades Especiais</label>
                    <textarea class="form-input" id="lessonAdaptations" rows="2" 
                        placeholder="Ex: ExercÃ­cios modificados para pessoas com mobilidade reduzida"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ObservaÃ§Ãµes e Notas</label>
                    <textarea class="form-input" id="lessonNotes" rows="2" 
                        placeholder="Ex: Enfatizar seguranÃ§a, atenÃ§Ã£o especial ao alinhamento corporal"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('lessonPlanModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Plano</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lesson Feedback Modal -->
    <div id="lessonFeedbackModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Feedback PÃ³s-Aula</h2>
                <button class="close-btn" onclick="closeModal('lessonFeedbackModal')">&times;</button>
            </div>
            <form id="lessonFeedbackForm">
                <input type="hidden" id="feedbackCourseId">
                <input type="hidden" id="feedbackLessonNumber">
                
                <div class="form-group">
                    <label class="form-label">Como foi a aula? (Geral)</label>
                    <textarea class="form-input" id="feedbackGeneral" rows="3" 
                        placeholder="Ex: Aula correu bem, alunos participativos, tÃ©cnica foi bem assimilada"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Dificuldades Observadas</label>
                    <textarea class="form-input" id="feedbackDifficulties" rows="3" 
                        placeholder="Ex: Alguns alunos tiveram dificuldade com o movimento de quadril"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Melhorias para PrÃ³xima Aula</label>
                    <textarea class="form-input" id="feedbackImprovements" rows="3" 
                        placeholder="Ex: Revisar tÃ©cnica bÃ¡sica, dar mais tempo para prÃ¡tica individual"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Alunos Presentes</label>
                    <input type="number" class="form-input" id="feedbackStudentsPresent" min="0">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('lessonFeedbackModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Feedback</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { showToast } from './js/ui.js';
        window.showToast = showToast;
    </script>
    <script>
        // ... existing code ...
        // Functions will be assigned to window later when they are defined
    </script>
    <script type="module">
        import { 
            loadAttendance, 
            renderAttendance, 
            checkIn 
        } from './js/attendance.js';

        // Attach to window for inline event handlers
        window.loadAttendance = loadAttendance;
        window.renderAttendance = renderAttendance;
        window.checkIn = checkIn;
    </script>
    <script type="module" src="./js/main.js"></script>
    <script type="module">
        import { 
            loadSettings, 
            renderSettings, 
            saveSettings 
        } from './js/settings.js';

        // Attach to window for inline event handlers
        window.loadSettings = loadSettings;
        window.renderSettings = renderSettings;
        window.saveSettings = saveSettings;
    </script>
    <script>
        // ==========================================
        // GLOBAL VARIABLES
        // ==========================================
        
        // Knowledge Base System
        let knowledgeBase = [];
        let ragChunks = [];
        let uploadedDocuments = [];
        
        // Make variables globally accessible
        window.ragChunks = ragChunks;
        let currentUploadTab = 'documents';
        
        // ==========================================
        // KNOWLEDGE BASE PERSISTENCE FUNCTIONS
        // ==========================================
        
        // Save knowledge base to localStorage
        function saveKnowledgeBaseToStorage() {
            try {
                localStorage.setItem('academiaKnowledgeBase', JSON.stringify(knowledgeBase));
                localStorage.setItem('academiaRAGChunks', JSON.stringify(ragChunks));
                console.log('ðŸ’¾ Base de conhecimento salva no localStorage');
            } catch (error) {
                console.error('âŒ Erro ao salvar base de conhecimento:', error);
            }
        }
        
        // Load knowledge base from localStorage
        function loadKnowledgeBaseFromStorage() {
            try {
                const storedKnowledgeBase = localStorage.getItem('academiaKnowledgeBase');
                const storedRAGChunks = localStorage.getItem('academiaRAGChunks');
                
                if (storedKnowledgeBase) {
                    knowledgeBase = JSON.parse(storedKnowledgeBase);
                    console.log('ðŸ“š Base de conhecimento carregada do localStorage:', knowledgeBase.length, 'itens');
                }
                
                if (storedRAGChunks) {
                    ragChunks = JSON.parse(storedRAGChunks);
                    console.log('ðŸ§  Chunks RAG carregados do localStorage:', ragChunks.length, 'chunks');
                } else if (knowledgeBase.length > 0) {
                    // Regenerate chunks if knowledge base exists but chunks don't
                    generateRAGChunks();
                }
                
                return knowledgeBase.length > 0;
            } catch (error) {
                console.error('âŒ Erro ao carregar base de conhecimento:', error);
                return false;
            }
        }
        
        // Clear knowledge base from localStorage
        function clearKnowledgeBaseStorage() {
            try {
                localStorage.removeItem('academiaKnowledgeBase');
                localStorage.removeItem('academiaRAGChunks');
                knowledgeBase = [];
                ragChunks = [];
                console.log('ðŸ—‘ï¸ Base de conhecimento limpa do localStorage');
            } catch (error) {
                console.error('âŒ Erro ao limpar base de conhecimento:', error);
            }
        }
        
        // Define essential functions immediately
        window.openKnowledgeUploader = function() {
            console.log('ðŸ“š Abrindo base de conhecimento...');
            try {
                openDocumentUploader();
            } catch (error) {
                console.error('âŒ Erro ao abrir document uploader:', error);
                alert('Erro ao abrir o modal de upload. Verifique o console.');
            }
        };
        
        window.testRAGSystem = function() {
            console.log('ðŸ—ºï¸ Abrindo teste RAG...');
            document.getElementById('ragTestModal').classList.add('active');
        };
        
        window.reindexKnowledgeBase = function() {
            console.log('âš¡ Reindexando base...');
            try {
                if (typeof generateRAGChunks === 'function') {
                    generateRAGChunks();
                }
                if (typeof updateKnowledgeBaseStats === 'function') {
                    updateKnowledgeBaseStats();
                }
                if (typeof showToast === 'function') {
                    showToast('Base reindexada!', 'success');
                }
            } catch (error) {
                console.error('âŒ Erro ao reindexar:', error);
            }
        };
        
        window.searchKnowledgeBase = function() {
            console.log('ðŸ” Buscando...');
            try {
                const query = document.getElementById('knowledgeSearchInput')?.value.trim();
                if (query && typeof searchKnowledgeContentInMain === 'function') {
                    searchKnowledgeContentInMain(query);
                } else if (typeof displayKnowledgeContentInMain === 'function') {
                    displayKnowledgeContentInMain();
                }
            } catch (error) {
                console.error('âŒ Erro na busca:', error);
            }
        };
        
        // Global variables for student editing
        let currentEditingStudentId = null;
        let currentEditingStudent = null;

        // Dedicated student edit page function (uses full page) - MOVED TO TOP
        async function openStudentEditPage(studentId) {
            try {
                console.log('ðŸ”„ Abrindo pÃ¡gina de ediÃ§Ã£o do aluno:', studentId);
                console.log('ðŸ” Debug: studentId recebido:', studentId, typeof studentId);
                
                if (!studentId) {
                    throw new Error('ID do estudante nÃ£o fornecido');
                }
                
                currentEditingStudentId = studentId;

                // Find student in existing data first
                let student = null;
                console.log('ðŸ” Debug: Verificando allStudents:', typeof window.allStudents, window.allStudents ? window.allStudents.length : 'undefined');
                
                if (typeof window.allStudents !== 'undefined' && window.allStudents) {
                    student = window.allStudents.find(s => s.id === studentId);
                    console.log('ðŸ” Debug: Estudante encontrado em allStudents:', !!student);
                }
                
                if (!student) {
                    console.log('ðŸ” Debug: Buscando estudante via API...');
                    // Fallback: fetch from API
                    const response = await fetch(`/api/students`);
                    const data = await response.json();
                    
                    console.log('ðŸ” Debug: Resposta da API:', data.success, data.data ? data.data.length : 'sem dados');
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Erro ao carregar dados do estudante');
                    }
                    
                    student = data.data.find(s => s.id === studentId);
                    console.log('ðŸ” Debug: Estudante encontrado na API:', !!student);
                }

                if (!student) {
                    throw new Error('Estudante nÃ£o encontrado com ID: ' + studentId);
                }

                console.log('âœ… Debug: Estudante carregado:', student.user?.firstName, student.user?.lastName);
                currentEditingStudent = student;
                
                // Check if elements exist before manipulating them
                const studentsSection = document.getElementById('students');
                const editPageSection = document.getElementById('student-edit-page');
                
                console.log('ðŸ” Debug: Elementos DOM encontrados:', !!studentsSection, !!editPageSection);
                
                if (!studentsSection || !editPageSection) {
                    throw new Error('Elementos da pÃ¡gina nÃ£o encontrados');
                }
                
                // Hide students list and show edit page
                studentsSection.style.display = 'none';
                editPageSection.style.display = 'block';
                
                console.log('âœ… Debug: Tela de ediÃ§Ã£o exibida');
                
                // Update page header with student info
                try {
                    updateEditPageHeader(student);
                    console.log('âœ… Debug: Header atualizado');
                } catch (headerError) {
                    console.error('âŒ Erro no header:', headerError);
                }
                
                // Load the edit form
                try {
                    loadEditPageForm(student);
                    console.log('âœ… Debug: FormulÃ¡rio carregado');
                } catch (formError) {
                    console.error('âŒ Erro no formulÃ¡rio:', formError);
                }
                
                // Update sidebar with student stats
                try {
                    updateEditPageSidebar(student);
                    console.log('âœ… Debug: Sidebar atualizado');
                } catch (sidebarError) {
                    console.error('âŒ Erro no sidebar:', sidebarError);
                }
                
                // Set active tab to edit
                try {
                    switchPageTab('edit');
                    console.log('âœ… Debug: Tab ativado');
                } catch (tabError) {
                    console.error('âŒ Erro no tab:', tabError);
                }
                
                console.log('âœ… PÃ¡gina de ediÃ§Ã£o carregada com sucesso');
                
            } catch (error) {
                console.error('âŒ Erro ao abrir pÃ¡gina de ediÃ§Ã£o:', error);
                alert(`Erro ao abrir ediÃ§Ã£o: ${error.message}`); // Usando alert para garantir que vemos o erro
            }
        }

        // Update edit page header with student information
        function updateEditPageHeader(student) {
            const user = student.user || {};
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'Aluno sem nome';
            const studentId = student.id;
            const category = student.category || 'N/A';
            
            document.getElementById('editPageStudentName').textContent = fullName;
            document.getElementById('editPageStudentId').textContent = `ID: ${studentId}`;
            document.getElementById('editPageStudentCategory').textContent = `Categoria: ${category}`;
        }

        // Load form in the edit page
        function loadEditPageForm(student) {
            const formContainer = document.getElementById('pageFormContainer');
            
            // Create form HTML with all student fields
            formContainer.innerHTML = `
                <form id="editPageStudentForm" style="display: grid; gap: 2rem;">
                    <!-- Personal Information Section -->
                    <div style="background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                        <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            ðŸ‘¤ InformaÃ§Ãµes Pessoais
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="pageFirstName" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Nome</label>
                                <input type="text" id="pageFirstName" value="${student.user?.firstName || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;" required>
                            </div>
                            <div class="form-group">
                                <label for="pageLastName" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Sobrenome</label>
                                <input type="text" id="pageLastName" value="${student.user?.lastName || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;" required>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label for="pageEmail" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Email</label>
                                <input type="email" id="pageEmail" value="${student.user?.email || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;" required>
                            </div>
                            <div class="form-group">
                                <label for="pagePhone" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Telefone</label>
                                <input type="tel" id="pagePhone" value="${student.user?.phone || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;">
                            </div>
                        </div>
                    </div>

                    <!-- Academic Information Section -->
                    <div style="background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                        <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            ðŸ¥‹ InformaÃ§Ãµes AcadÃªmicas
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="pageCategory" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Categoria</label>
                                <select id="pageCategory" style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;">
                                    <option value="ADULT" ${student.category === 'ADULT' ? 'selected' : ''}>Adulto</option>
                                    <option value="CHILD" ${student.category === 'CHILD' ? 'selected' : ''}>CrianÃ§a</option>
                                    <option value="INICIANTE1" ${student.category === 'INICIANTE1' ? 'selected' : ''}>Iniciante 1</option>
                                    <option value="INICIANTE2" ${student.category === 'INICIANTE2' ? 'selected' : ''}>Iniciante 2</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pageGender" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">GÃªnero</label>
                                <select id="pageGender" style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;">
                                    <option value="MASCULINO" ${student.gender === 'MASCULINO' ? 'selected' : ''}>Masculino</option>
                                    <option value="FEMININO" ${student.gender === 'FEMININO' ? 'selected' : ''}>Feminino</option>
                                    <option value="OUTRO" ${student.gender === 'OUTRO' ? 'selected' : ''}>Outro</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <label for="pagePhysicalCondition" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">CondiÃ§Ã£o FÃ­sica</label>
                            <select id="pagePhysicalCondition" style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;">
                                <option value="INICIANTE" ${student.physicalCondition === 'INICIANTE' ? 'selected' : ''}>Iniciante</option>
                                <option value="INTERMEDIARIO" ${student.physicalCondition === 'INTERMEDIARIO' ? 'selected' : ''}>IntermediÃ¡rio</option>
                                <option value="AVANCADO" ${student.physicalCondition === 'AVANCADO' ? 'selected' : ''}>AvanÃ§ado</option>
                            </select>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div style="background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                        <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            ðŸ“‹ InformaÃ§Ãµes Adicionais
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div class="form-group">
                                <label for="pageEmergencyContact" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Contato de EmergÃªncia</label>
                                <input type="text" id="pageEmergencyContact" value="${student.emergencyContact || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;">
                            </div>
                            <div class="form-group">
                                <label for="pageMedicalConditions" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">CondiÃ§Ãµes MÃ©dicas</label>
                                <textarea id="pageMedicalConditions" rows="3" 
                                          style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC; resize: vertical;">${student.medicalConditions || ''}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields -->
                    <input type="hidden" id="pageStudentId" value="${student.id}">
                    <input type="hidden" id="pageUserId" value="${student.userId}">
                </form>
            `;

            // Add real-time form validation
            const inputs = formContainer.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', updatePageFormProgress);
            });

            updatePageFormProgress();
            
            // Pre-load financial tab content to ensure plan information is available
            setTimeout(() => {
                console.log('ðŸ”„ Pre-loading financial tab...');
                loadStudentFinancialTab();
            }, 1000);
        }

        // Update sidebar with student stats
        function updateEditPageSidebar(student) {
            document.getElementById('sidebarXP').textContent = student.totalXP || '0';
            document.getElementById('sidebarLevel').textContent = `Nv. ${student.globalLevel || '1'}`;
            document.getElementById('sidebarStreak').textContent = `${student.currentStreak || '0'} dias`;
        }

        // Switch between page tabs
        function switchPageTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.page-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.page-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = '#94A3B8';
            });

            // Show selected tab content
            const selectedTab = document.getElementById(`page-tab-${tabName}`);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }

            // Add active class to selected tab button
            const selectedBtn = document.querySelector(`[data-page-tab="${tabName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
                selectedBtn.style.background = 'linear-gradient(135deg, #3B82F6, #1D4ED8)';
                selectedBtn.style.color = 'white';
            }

            // Load specific tab content
            loadPageTabContent(tabName);
        }

        // Load content for specific tab
        function loadPageTabContent(tabName) {
            // Use centralized functions from students.js module
            switch (tabName) {
                case 'ai-dashboard':
                    if (window.loadAIDashboardContent) {
                        window.loadAIDashboardContent();
                    }
                    break;
                case 'plans':
                    if (window.loadPlansTabContent) {
                        window.loadPlansTabContent();
                    }
                    break;
                case 'classes':
                    console.log('ðŸŽ¯ Carregando aba de turmas...');
                    if (window.loadStudentClassesTab) {
                        window.loadStudentClassesTab();
                    }
                    break;
                case 'courses':
                    console.log('ðŸ’³ Carregando aba de assinatura...');
                    if (window.loadStudentSubscriptionTab) {
                        window.loadStudentSubscriptionTab();
                    }
                    break;
                case 'progress':
                    if (window.loadProgressTabContent) {
                        window.loadProgressTabContent();
                    }
                    break;
                default:
                    // Edit tab is already loaded
                    break;
            }
        }

        // Update form progress
        function updatePageFormProgress() {
            const form = document.getElementById('editPageStudentForm');
            if (!form) return;

            const inputs = form.querySelectorAll('input[required], select[required]');
            let completed = 0;
            
            inputs.forEach(input => {
                if (input.value && input.value.trim() !== '') {
                    completed++;
                }
            });
            
            const progress = Math.round((completed / inputs.length) * 100);
            const progressBar = document.getElementById('pageFormProgress');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
        }

        // Tab content loading functions - placeholder implementations
        function loadAIDashboardContent() {
            const content = document.getElementById('page-tab-ai-dashboard');
            if (content) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94A3B8;">
                        ðŸ¤– Dashboard IA em desenvolvimento
                    </div>
                `;
            }
        }

        async function loadPlansTabContent() {
            const content = document.getElementById('page-tab-plans');
            if (!content) return;
            
            // Get student ID from centralized state management
            const studentId = window.getCurrentEditingStudentId ? window.getCurrentEditingStudentId() : currentEditingStudentId;
            console.log('ðŸŽ¯ Loading plans tab for student:', studentId);
            
            if (!studentId) {
                content.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #EF4444;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">âŒ</div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">ID do aluno nÃ£o encontrado</div>
                        <div style="font-size: 0.875rem; color: #94A3B8;">
                            Selecione um aluno para visualizar os planos disponÃ­veis
                        </div>
                    </div>
                `;
                return;
            }
            
            // Update local reference
            currentEditingStudentId = studentId;
            
            // ðŸ”’ USAR MÃ“DULO ISOLADO SE DISPONÃVEL (Desabilitado temporariamente)
            if (false && window.ModuleLoader && window.ModuleLoader.isModuleLoaded('PlansManager')) {
                try {
                    console.log('ðŸ”Œ Usando mÃ³dulo PlansManager isolado');
                    
                    // Criar container para o mÃ³dulo
                    content.innerHTML = '<div id="isolatedPlansContainer"></div>';
                    
                    // Inicializar e carregar dados
                    const plansManager = window.PlansManager.init(studentId);
                    await plansManager.loadPlansData();
                    
                    // Renderizar interface isolada
                    const success = plansManager.renderPlansInterface('isolatedPlansContainer');
                    
                    if (success) {
                        console.log('âœ… Interface de planos carregada via mÃ³dulo isolado');
                        if (window.showToast) {
                            window.showToast('ðŸ“¦ Usando interface modular protegida', 'info');
                        }
                        return; // Sai da funÃ§Ã£o, usa mÃ³dulo isolado
                    }
                } catch (error) {
                    console.warn('âš ï¸ MÃ³dulo isolado falhou, usando fallback:', error);
                }
            }
            
            // ðŸ”„ FALLBACK PARA SISTEMA ORIGINAL
            // Show loading state
            content.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; padding: 3rem; color: #94A3B8;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ”„</div>
                        <div>Carregando planos e assinaturas...</div>
                    </div>
                </div>
            `;
            
            // Double-check student ID (should already be validated above)
            if (!studentId) {
                console.error('âŒ Student ID missing after validation');
                return;
            }

            try {
                // Load available billing plans first - try multiple routes
                console.log('ðŸ“¡ Fetching billing plans...');
                let plansData = null;
                let availablePlans = [];
                
                // Try financial route first, then fallback to billing-plans, then mock data
                try {
                    console.log('ðŸ” Tentando rota financeira...');
                    const financialResponse = await fetch('/api/billing-plans');
                    if (financialResponse.ok) {
                        plansData = await financialResponse.json();
                        console.log('ðŸ“Š Financial plans response:', plansData.success ? `${plansData.data.length} planos` : 'sem dados');
                        // Filtrar apenas planos ativos
                        availablePlans = plansData.success ? 
                            plansData.data.filter(plan => plan.isActive === true) : [];
                        console.log('âœ… Planos ativos encontrados:', availablePlans.length);
                    } else {
                        throw new Error(`Financial route returned ${financialResponse.status}`);
                    }
                } catch (error) {
                    console.log('âš ï¸ Rota financeira falhou:', error.message, '- tentando billing-plans...');
                    try {
                        const billingResponse = await fetch('/api/billing-plans');
                        if (billingResponse.ok) {
                            plansData = await billingResponse.json();
                            console.log('ðŸ“Š Billing plans response:', plansData.success ? `${plansData.data.length} planos` : 'sem dados');
                            // Filtrar apenas planos ativos
                            availablePlans = plansData.success ? 
                                plansData.data.filter(plan => plan.isActive === true) : [];
                            console.log('âœ… Planos ativos encontrados:', availablePlans.length);
                        } else {
                            throw new Error(`Billing route returned ${billingResponse.status}`);
                        }
                    } catch (billingError) {
                        console.log('âš ï¸ Ambas as rotas falharam:', billingError.message, '- usando dados mock...');
                        // Use comprehensive mock data as fallback
                        console.log('ðŸ“ Carregando 10 planos de demonstraÃ§Ã£o...');
                        
                        // Show info toast about mock data
                        if (typeof showToast === 'function') {
                            showToast('ðŸ“ Usando dados de demonstraÃ§Ã£o para planos', 'info');
                        }
                        availablePlans = [
                            {
                                id: 'plan-1',
                                name: 'Plano BÃ¡sico Adulto',
                                description: 'Ideal para iniciantes - 2 aulas por semana com tÃ©cnicas fundamentais',
                                category: 'ADULT',
                                price: '150.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 2,
                                maxClasses: 8,
                                hasPersonalTraining: false,
                                hasNutrition: false,
                                allowFreeze: true,
                                isActive: true,
                                features: ['Aulas em grupo', 'Material didÃ¡tico', 'Suporte tÃ©cnico']
                            },
                            {
                                id: 'plan-2',
                                name: 'Plano Premium Adulto',
                                description: 'Acesso ilimitado com benefÃ­cios extras e personal training',
                                category: 'ADULT',
                                price: '280.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 0,
                                maxClasses: null,
                                hasPersonalTraining: true,
                                hasNutrition: true,
                                allowFreeze: true,
                                isActive: true,
                                features: ['Aulas ilimitadas', 'Personal training', 'Consultoria nutricional', 'Acesso VIP']
                            },
                            {
                                id: 'plan-3',
                                name: 'Plano Infantil',
                                description: 'Krav Maga Kids - 2 aulas por semana com foco lÃºdico e educativo',
                                category: 'CHILD',
                                price: '120.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 2,
                                maxClasses: 8,
                                hasPersonalTraining: false,
                                hasNutrition: false,
                                allowFreeze: true,
                                isActive: true,
                                features: ['MÃ©todo lÃºdico', 'Acompanhamento parental', 'Certificado de progresso']
                            },
                            {
                                id: 'plan-4',
                                name: 'Plano Feminino Especializado',
                                description: 'Turmas exclusivamente femininas com foco em defesa pessoal',
                                category: 'FEMALE',
                                price: '170.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 3,
                                maxClasses: 12,
                                hasPersonalTraining: false,
                                hasNutrition: false,
                                allowFreeze: true,
                                isActive: true,
                                features: ['HorÃ¡rios exclusivos', 'Instrutora especializada', 'Workshops de autodefesa']
                            },
                            {
                                id: 'plan-5',
                                name: 'Plano Senior Adaptado',
                                description: 'Treinamento adaptado para terceira idade com foco em mobilidade',
                                category: 'SENIOR',
                                price: '130.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 2,
                                maxClasses: 8,
                                hasPersonalTraining: false,
                                hasNutrition: true,
                                allowFreeze: true,
                                isActive: true,
                                features: ['Baixo impacto', 'Acompanhamento mÃ©dico', 'ExercÃ­cios adaptados']
                            },
                            {
                                id: 'plan-6',
                                name: 'Plano Anual Premium',
                                description: 'Desconto especial para pagamento anual - 12 meses de acesso completo',
                                category: 'ADULT',
                                price: '1800.00',
                                billingType: 'YEARLY',
                                classesPerWeek: 0,
                                maxClasses: null,
                                hasPersonalTraining: true,
                                hasNutrition: true,
                                allowFreeze: true,
                                isActive: true,
                                features: ['Desconto de 20%', 'Acesso ilimitado', 'Personal training', 'Consultoria completa']
                            },
                            {
                                id: 'plan-7',
                                name: 'Plano Trimestral Intensivo',
                                description: '3 meses de treinamento intensivo com resultados acelerados',
                                category: 'ADULT',
                                price: '450.00',
                                billingType: 'QUARTERLY',
                                classesPerWeek: 4,
                                maxClasses: 48,
                                hasPersonalTraining: false,
                                hasNutrition: true,
                                allowFreeze: false,
                                isActive: true,
                                features: ['4x por semana', 'Plano nutricional', 'AvaliaÃ§Ã£o mensal']
                            },
                            {
                                id: 'plan-8',
                                name: 'Plano Familiar',
                                description: 'Desconto especial para famÃ­lias - atÃ© 4 membros',
                                category: 'ADULT',
                                price: '400.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 3,
                                maxClasses: 48,
                                hasPersonalTraining: false,
                                hasNutrition: false,
                                allowFreeze: true,
                                isActive: true,
                                features: ['AtÃ© 4 pessoas', 'HorÃ¡rios flexÃ­veis', 'Desconto familiar']
                            },
                            {
                                id: 'plan-9',
                                name: 'Plano VIP Master',
                                description: 'ExperiÃªncia completa com todos os benefÃ­cios e exclusividades',
                                category: 'ADULT',
                                price: '500.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 0,
                                maxClasses: null,
                                hasPersonalTraining: true,
                                hasNutrition: true,
                                allowFreeze: true,
                                isActive: true,
                                features: ['Acesso VIP', 'Personal 2x/semana', 'Nutricionista', 'Prioridade mÃ¡xima']
                            },
                            {
                                id: 'plan-10',
                                name: 'Plano Corporativo',
                                description: 'Para empresas - treinamento de equipes com desconto especial',
                                category: 'ADULT',
                                price: '800.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 5,
                                maxClasses: null,
                                hasPersonalTraining: false,
                                hasNutrition: false,
                                allowFreeze: true,
                                isActive: true,
                                features: ['AtÃ© 10 pessoas', 'HorÃ¡rio corporativo', 'RelatÃ³rios de progresso']
                            }
                        ];
                    }
                }
                
                // Try to load student subscription data (may not exist)
                let currentPlan = null;
                let hasActiveSubscription = false;
                let isSimulatedSubscription = false;
                
                try {
                    console.log('ðŸ” Verificando assinatura do aluno...');
                    const subscriptionResponse = await fetch(`/api/students/${studentId}/subscription`);
                    
                    if (subscriptionResponse.ok) {
                        const subscriptionData = await subscriptionResponse.json();
                        if (subscriptionData.success && subscriptionData.data) {
                            currentPlan = subscriptionData.data.plan;
                            hasActiveSubscription = true;
                            console.log('âœ… Assinatura ativa encontrada:', currentPlan.name);
                        } else {
                            console.log('â„¹ï¸ Aluno sem plano ativo (resposta vazia)');
                        }
                    } else if (subscriptionResponse.status === 404) {
                        console.log('â„¹ï¸ Aluno sem plano ativo (404 - normal para novos alunos)');
                    } else {
                        console.log('âš ï¸ Erro ao buscar assinatura:', subscriptionResponse.status);
                    }
                } catch (subscriptionError) {
                    console.log('â„¹ï¸ Nenhuma assinatura encontrada para o aluno (isso Ã© normal para novos alunos)');
                }
                
                // Check for simulated subscriptions if no real subscription found
                if (!hasActiveSubscription) {
                    const simulatedAssignments = JSON.parse(localStorage.getItem('simulatedPlanAssignments') || '[]');
                    const studentAssignment = simulatedAssignments.find(a => a.studentId === studentId && a.isActive);
                    
                    if (studentAssignment) {
                        // Find the plan details from available plans
                        const simulatedPlan = availablePlans.find(p => p.id === studentAssignment.planId);
                        if (simulatedPlan) {
                            currentPlan = {
                                ...simulatedPlan,
                                subscriptionId: studentAssignment.id,
                                createdAt: studentAssignment.createdAt,
                                isTemporary: studentAssignment.isTemporary || false,
                                syncAttempts: studentAssignment.syncAttempts || 0
                            };
                            hasActiveSubscription = true;
                            isSimulatedSubscription = true;
                            
                            if (studentAssignment.isTemporary) {
                                console.log('ðŸ“ Assinatura temporÃ¡ria encontrada (aguardando sincronizaÃ§Ã£o):', currentPlan.name);
                            } else {
                                console.log('ðŸ“ Assinatura simulada encontrada:', currentPlan.name);
                            }
                        }
                    }
                }
                
                content.innerHTML = `
                    <div style="display: grid; gap: 2rem; max-width: 1000px; margin: 0 auto;">
                        
                        <!-- Header with Quick Actions -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="color: #F8FAFC; margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.5rem;">ðŸ“‹</span>
                                GestÃ£o de Planos
                                ${!plansData || !plansData.success ? 
                                    '<span style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">DEMO</span>' 
                                    : ''
                                }
                            </h3>
                            <div style="display: flex; gap: 0.75rem;">
                                ${!hasActiveSubscription ? `
                                    <button onclick="showQuickPlanSelector()" 
                                            style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                        ðŸš€ Assinar Plano Agora
                                    </button>
                                ` : `
                                    <button onclick="showPlanChangeOptions()" 
                                            style="background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                        ðŸ”„ Trocar Plano
                                    </button>
                                    <button onclick="showPlanCancellation()" 
                                            style="background: rgba(239, 68, 68, 0.1); color: #EF4444; border: 1px solid #EF4444; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                        ðŸ›‘ Gerenciar Plano
                                    </button>
                                `}
                                <button onclick="showPlanManagementPolicies()" 
                                        style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; border: 1px solid #3B82F6; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                    ðŸ“‹ PolÃ­ticas
                                </button>
                            </div>
                        </div>

                        <!-- Current Plan Status -->
                        <div style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.8)); border-radius: 16px; padding: 2rem; border: 1px solid ${hasActiveSubscription ? '#10B981' : '#EF4444'}; position: relative; overflow: hidden;">
                            ${hasActiveSubscription ? `
                                <!-- Active Plan Display -->
                                <div style="position: absolute; top: 1rem; right: 1rem;">
                                    <span style="background: linear-gradient(135deg, ${currentPlan?.isTemporary ? '#F59E0B, #D97706' : '#10B981, #059669'}); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600; box-shadow: 0 2px 8px rgba(${currentPlan?.isTemporary ? '245, 158, 11' : '16, 185, 129'}, 0.3);">
                                        ${currentPlan?.isTemporary ? 'â³ SINCRONIZANDO' : (isSimulatedSubscription ? 'ðŸ“ DEMO' : 'âœ… ATIVO')}
                                    </span>
                                </div>
                                ${currentPlan?.isTemporary ? `
                                    <div style="position: absolute; top: 4rem; right: 1rem;">
                                        <span style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(245, 158, 11, 0.3);">
                                            Tentativa ${currentPlan?.syncAttempts || 0}/288
                                        </span>
                                    </div>
                                ` : ''}
                                <div style="margin-bottom: 1.5rem;">
                                    <h4 style="color: #10B981; margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700;">
                                        ${currentPlan?.name || 'Plano sem nome'}
                                    </h4>
                                    <p style="color: #94A3B8; margin: 0; font-size: 1rem;">
                                        ${currentPlan?.description || 'Sem descriÃ§Ã£o disponÃ­vel'}
                                        ${currentPlan?.isTemporary ? ' <strong style="color: #F59E0B;">(Aguardando sincronizaÃ§Ã£o com servidor)</strong>' : ''}
                                    </p>
                                    </p>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: center;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 12px; padding: 1rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                                            <div style="color: #10B981; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">ðŸ’³ VALOR MENSAL</div>
                                            <div style="color: #F8FAFC; font-size: 1.5rem; font-weight: bold;">R$ ${(parseFloat(currentPlan?.price) || 0).toFixed(2)}</div>
                                        </div>
                                        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 12px; padding: 1rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                            <div style="color: #3B82F6; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">ðŸŽ¯ CATEGORIA</div>
                                            <div style="color: #F8FAFC; font-size: 1.125rem; font-weight: 600;">${currentPlan?.category || currentPlan?.targetCategory || 'N/A'}</div>
                                        </div>
                                        <div style="background: rgba(245, 158, 11, 0.1); border-radius: 12px; padding: 1rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                                            <div style="color: #F59E0B; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">ðŸ“… AULAS/SEMANA</div>
                                            <div style="color: #F8FAFC; font-size: 1.125rem; font-weight: 600;">${currentPlan?.classesPerWeek || 'Ilimitado'}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="text-align: center;">
                                        <button onclick="showPlanDetails('${currentPlan?.id}')" 
                                                style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; margin-bottom: 0.5rem; width: 100%;">
                                            ðŸ“„ Ver Detalhes
                                        </button>
                                        <br>
                                        <button onclick="showPlanChangeOptions()" 
                                                style="background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; width: 100%;">
                                            ðŸ”„ Trocar Plano
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <!-- No Plan State -->
                                <div style="text-align: center; padding: 2rem;">
                                    <div style="font-size: 4rem; margin-bottom: 1rem;">âš ï¸</div>
                                    <h4 style="color: #EF4444; margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 700;">
                                        Nenhum Plano Ativo
                                    </h4>
                                    <p style="color: #94A3B8; margin: 0 0 1rem 0; font-size: 1.125rem;">
                                        Este aluno nÃ£o possui um plano de pagamento ativo.
                                    </p>
                                    <p style="color: #F59E0B; margin: 0 0 2rem 0; font-size: 1rem; font-weight: 600;">
                                        âš¡ Para liberar o acesso Ã s aulas, Ã© necessÃ¡rio assinar um plano.
                                    </p>
                                    <div style="display: flex; gap: 1rem; justify-content: center; align-items: center;">
                                        <button onclick="showQuickPlanSelector()" 
                                                style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.125rem; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);">
                                            ðŸš€ Assinar Plano Agora
                                        </button>
                                        <div style="color: #64748B; font-size: 0.875rem; text-align: left;">
                                            <div>âœ… ${availablePlans.length} planos ativos disponÃ­veis</div>
                                            <div>ðŸ’° A partir de R$ ${Math.min(...availablePlans.map(p => parseFloat(p.price)))}</div>
                                        </div>
                                    </div>
                                </div>
                            `}
                        </div>

                        <!-- Complete Plans Showcase (visible when no plan) -->
                        ${!hasActiveSubscription ? `
                            <div id="quickPlanSelector" style="background: rgba(15, 23, 42, 0.5); border-radius: 16px; padding: 2rem; border: 1px solid #334155;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">                            <h4 style="color: #F8FAFC; margin: 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                                âš¡ Escolha seu Plano Ideal
                                <span style="background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">âœ… APENAS ATIVOS</span>
                                <span style="background: #EF4444; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">URGENTE</span>
                            </h4>
                                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                                        <span style="color: #94A3B8; font-size: 0.875rem;">${availablePlans.length} planos disponÃ­veis</span>
                                        <select id="planTypeFilter" onchange="filterPlansByType()" style="background: #1E293B; border: 1px solid #475569; color: #F8FAFC; padding: 0.5rem; border-radius: 6px; font-size: 0.875rem;">
                                            <option value="">Todos os tipos</option>
                                            <option value="MONTHLY">Mensais</option>
                                            <option value="QUARTERLY">Trimestrais</option>
                                            <option value="YEARLY">Anuais</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Plans organized by category -->
                                <div style="display: grid; gap: 2rem;">
                                    
                                    <!-- Popular Plans Section -->
                                    <div>
                                        <h5 style="color: #10B981; margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                            ðŸ”¥ Mais Populares
                                        </h5>
                                        <div class="plans-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">
                                            ${availablePlans.filter(plan => ['plan-2', 'plan-1', 'plan-9'].includes(plan.id)).map(plan => `
                                                <div class="plan-card-enhanced" data-category="${plan.category}" data-billing="${plan.billingType}" 
                                                     style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9)); 
                                                            border: 2px solid #10B981; border-radius: 16px; padding: 1.5rem; cursor: pointer; 
                                                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden;" 
                                                     onclick="selectPlanQuickly('${plan.id}')" 
                                                     onmouseover="this.style.borderColor='#059669'; this.style.transform='translateY(-6px)'; this.style.boxShadow='0 20px 40px rgba(16, 185, 129, 0.3)'" 
                                                     onmouseout="this.style.borderColor='#10B981'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            
                                                    <!-- Popular badge -->
                                                    <div style="position: absolute; top: -1px; right: -1px; background: linear-gradient(135deg, #F59E0B, #D97706); 
                                                                color: white; padding: 0.5rem 1rem; border-radius: 0 16px 0 16px; font-size: 0.75rem; font-weight: 600;">
                                                        ${plan.id === 'plan-2' ? 'ðŸ‘‘ PREMIUM' : plan.id === 'plan-9' ? 'ðŸ’Ž VIP' : 'ðŸ”¥ POPULAR'}
                                                    </div>
                                                    
                                                    <div style="margin-bottom: 1.5rem;">
                                                        <h5 style="color: #F8FAFC; margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 700;">
                                                            ${plan.name}
                                                        </h5>
                                                        <p style="color: #94A3B8; margin: 0 0 1rem 0; font-size: 0.875rem; line-height: 1.4;">
                                                            ${plan.description}
                                                        </p>
                                                    </div>
                                                    
                                                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 1.5rem; align-items: center; margin-bottom: 1.5rem;">
                                                        <div style="display: grid; gap: 0.75rem;">
                                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                                <span style="color: #94A3B8; font-size: 0.875rem;">ðŸ“Š Categoria:</span>
                                                                <span style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                                                    ${plan.category}
                                                                </span>
                                                            </div>
                                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                                <span style="color: #94A3B8; font-size: 0.875rem;">ðŸ“… Aulas/semana:</span>
                                                                <span style="color: #F8FAFC; font-weight: 600; font-size: 0.875rem;">
                                                                    ${plan.classesPerWeek === 0 ? 'Ilimitado' : plan.classesPerWeek + 'x'}
                                                                </span>
                                                            </div>
                                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                                <span style="color: #94A3B8; font-size: 0.875rem;">ðŸ’³ CobranÃ§a:</span>
                                                                <span style="color: #F8FAFC; font-weight: 600; font-size: 0.875rem;">
                                                                    ${plan.billingType === 'MONTHLY' ? 'Mensal' : 
                                                                      plan.billingType === 'QUARTERLY' ? 'Trimestral' : 
                                                                      plan.billingType === 'YEARLY' ? 'Anual' : plan.billingType}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div style="text-align: center;">
                                                            <div style="color: #10B981; font-size: 2rem; font-weight: bold; margin-bottom: 0.25rem;">
                                                                R$ ${(parseFloat(plan.price)).toFixed(0)}
                                                            </div>
                                                            <div style="color: #94A3B8; font-size: 0.75rem;">
                                                                /${plan.billingType === 'MONTHLY' ? 'mÃªs' : 
                                                                  plan.billingType === 'QUARTERLY' ? 'trim' : 
                                                                  plan.billingType === 'YEARLY' ? 'ano' : 'perÃ­odo'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Features -->
                                                    ${plan.features && plan.features.length > 0 ? `
                                                        <div style="margin-bottom: 1.5rem;">
                                                            <div style="color: #F8FAFC; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">âœ¨ Incluso:</div>
                                                            <div style="display: grid; gap: 0.5rem;">
                                                                ${plan.features.slice(0, 3).map(feature => `
                                                                    <div style="color: #94A3B8; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                                                                        <span style="color: #10B981;">âœ“</span> ${feature}
                                                                    </div>
                                                                `).join('')}
                                                                ${plan.features.length > 3 ? `
                                                                    <div style="color: #3B82F6; font-size: 0.875rem; font-weight: 600;">
                                                                        +${plan.features.length - 3} benefÃ­cios adicionais
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    <!-- Special badges -->
                                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                                                        ${plan.hasPersonalTraining ? '<span style="background: rgba(16, 185, 129, 0.2); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">ðŸƒâ€â™‚ï¸ Personal</span>' : ''}
                                                        ${plan.hasNutrition ? '<span style="background: rgba(245, 158, 11, 0.2); color: #F59E0B; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">ðŸ¥— NutriÃ§Ã£o</span>' : ''}
                                                        ${plan.allowFreeze ? '<span style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">â„ï¸ Congelamento</span>' : ''}
                                                    </div>
                                                    
                                                    <button style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; 
                                                                   padding: 1rem; border-radius: 12px; width: 100%; font-weight: 700; font-size: 1rem;
                                                                   cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);"
                                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.4)'"
                                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                                                        ðŸš€ Assinar Agora
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <!-- All Other Plans Section -->
                                    <div>
                                        <h5 style="color: #3B82F6; margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                            ðŸ“‹ Todos os Planos (${availablePlans.length})
                                        </h5>
                                        <div class="all-plans-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                                            ${availablePlans.map(plan => `
                                                <div class="plan-card-compact" data-category="${plan.category}" data-billing="${plan.billingType}" 
                                                     style="background: rgba(30, 41, 59, 0.6); border: 1px solid #475569; border-radius: 12px; 
                                                            padding: 1.25rem; cursor: pointer; transition: all 0.3s;" 
                                                     onclick="selectPlanQuickly('${plan.id}')" 
                                                     onmouseover="this.style.borderColor='#3B82F6'; this.style.transform='translateY(-2px)'" 
                                                     onmouseout="this.style.borderColor='#475569'; this.style.transform='translateY(0)'">
                                                    
                                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                                        <div style="flex: 1;">
                                                            <h6 style="color: #F8FAFC; margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 600;">
                                                                ${plan.name}
                                                            </h6>
                                                            <div style="color: #94A3B8; font-size: 0.875rem; line-height: 1.3; margin-bottom: 0.75rem;">
                                                                ${plan.description.substring(0, 80)}${plan.description.length > 80 ? '...' : ''}
                                                            </div>
                                                        </div>
                                                        <div style="text-align: right; margin-left: 1rem;">
                                                            <div style="color: #10B981; font-size: 1.25rem; font-weight: bold;">
                                                                R$ ${(parseFloat(plan.price)).toFixed(0)}
                                                            </div>
                                                            <div style="color: #94A3B8; font-size: 0.75rem;">
                                                                /${plan.billingType === 'MONTHLY' ? 'mÃªs' : 
                                                                  plan.billingType === 'QUARTERLY' ? 'trim' : 
                                                                  plan.billingType === 'YEARLY' ? 'ano' : 'perÃ­odo'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem; font-size: 0.875rem;">
                                                        <div style="display: flex; justify-content: space-between;">
                                                            <span style="color: #94A3B8;">Categoria:</span>
                                                            <span style="color: #F8FAFC; font-weight: 600;">${plan.category}</span>
                                                        </div>
                                                        <div style="display: flex; justify-content: space-between;">
                                                            <span style="color: #94A3B8;">Aulas:</span>
                                                            <span style="color: #F8FAFC; font-weight: 600;">
                                                                ${plan.classesPerWeek === 0 ? 'Ilimitado' : plan.classesPerWeek + 'x/sem'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Compact badges -->
                                                    <div style="display: flex; gap: 0.25rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                                        ${plan.hasPersonalTraining ? '<span style="background: rgba(16, 185, 129, 0.2); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem;">Personal</span>' : ''}
                                                        ${plan.hasNutrition ? '<span style="background: rgba(245, 158, 11, 0.2); color: #F59E0B; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem;">NutriÃ§Ã£o</span>' : ''}
                                                        ${plan.allowFreeze ? '<span style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem;">Congelamento</span>' : ''}
                                                    </div>
                                                    
                                                    <button style="background: #3B82F6; color: white; border: none; padding: 0.75rem; 
                                                                   border-radius: 8px; width: 100%; font-weight: 600; font-size: 0.875rem;
                                                                   cursor: pointer; transition: all 0.2s;" 
                                                            onmouseover="this.style.background='#2563EB'"
                                                            onmouseout="this.style.background='#3B82F6'">
                                                        Selecionar Plano
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- All Plans Section (collapsible) -->
                        <div id="allPlansSection" style="background: rgba(15, 23, 42, 0.5); border-radius: 16px; padding: 2rem; border: 1px solid #334155; ${!hasActiveSubscription ? 'display: none;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">                            <h4 style="color: #F8FAFC; margin: 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                                ðŸ“‹ Todos os Planos DisponÃ­veis
                                <span style="background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">âœ… APENAS ATIVOS</span>
                            </h4>
                                <div style="display: flex; gap: 0.75rem;">
                                    <select id="planCategoryFilter" onchange="filterPlansByCategory()" style="background: #1E293B; border: 1px solid #475569; color: #F8FAFC; padding: 0.5rem; border-radius: 6px;">
                                        <option value="">Todas as categorias</option>
                                        <option value="ADULT">Adulto</option>
                                        <option value="CHILD">Infantil</option>
                                        <option value="SENIOR">Senior</option>
                                        <option value="FEMALE">Feminino</option>
                                    </select>
                                    <select id="planBillingTypeFilter" onchange="filterPlansByType()" style="background: #1E293B; border: 1px solid #475569; color: #F8FAFC; padding: 0.5rem; border-radius: 6px;">
                                        <option value="">Todos os tipos</option>
                                        <option value="MONTHLY">Mensal</option>
                                        <option value="QUARTERLY">Trimestral</option>
                                        <option value="YEARLY">Anual</option>
                                        <option value="CREDIT_CARD_INSTALLMENT">Parcelado</option>
                                        <option value="RECURRING">Recorrente</option>
                                    </select>
                                    <button onclick="toggleAllPlansView()" 
                                            style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                                        ${hasActiveSubscription ? 'ðŸ“Š Expandir' : 'ðŸ“ Recolher'}
                                    </button>
                                </div>
                            </div>
                            
                            <div id="plansGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">
                                ${availablePlans.map(plan => `
                                    <div class="plan-card" data-category="${plan.category || ''}" data-billing="${plan.billingType || plan.billingCycle || ''}"
                                         style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.8)); 
                                                border: 2px solid ${currentPlan && currentPlan.id === plan.id ? '#10B981' : '#475569'}; 
                                                border-radius: 12px; padding: 1.5rem; transition: all 0.3s; position: relative;">
                                        
                                        ${currentPlan && currentPlan.id === plan.id ? `
                                            <div style="position: absolute; top: -1px; right: -1px; background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 0.5rem 1rem; border-radius: 0 12px 0 12px; font-size: 0.75rem; font-weight: 600;">
                                                âœ… PLANO ATUAL
                                            </div>
                                        ` : ''}
                                        
                                        <div style="margin-bottom: 1.5rem;">
                                            <h5 style="color: #F8FAFC; margin: 0 0 0.5rem 0; font-size: 1.125rem; font-weight: 600;">
                                                ${plan.name || 'Plano sem nome'}
                                            </h5>
                                            <p style="color: #94A3B8; margin: 0; font-size: 0.875rem; line-height: 1.4;">
                                                ${plan.description || 'Sem descriÃ§Ã£o disponÃ­vel'}
                                            </p>
                                        </div>
                                        
                                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center; margin-bottom: 1.5rem;">
                                            <div style="display: grid; gap: 0.75rem;">
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #94A3B8; font-size: 0.875rem;">Categoria:</span>
                                                    <span style="color: #F8FAFC; font-weight: 600; font-size: 0.875rem;">${plan.category || 'N/A'}</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #94A3B8; font-size: 0.875rem;">Aulas/semana:</span>
                                                    <span style="color: #F8FAFC; font-weight: 600; font-size: 0.875rem;">${plan.classesPerWeek || 'Ilimitado'}</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #94A3B8; font-size: 0.875rem;">DuraÃ§Ã£o:</span>
                                                    <span style="color: #F8FAFC; font-weight: 600; font-size: 0.875rem;">${
                                                        (plan.billingType || plan.billingCycle) === 'MONTHLY' ? 'Mensal' : 
                                                        (plan.billingType || plan.billingCycle) === 'QUARTERLY' ? 'Trimestral' : 
                                                        (plan.billingType || plan.billingCycle) === 'YEARLY' ? 'Anual' : 
                                                        (plan.billingType || plan.billingCycle) === 'CREDIT_CARD_INSTALLMENT' ? 'Parcelado' :
                                                        (plan.billingType || plan.billingCycle) === 'RECURRING' ? 'Recorrente' : 'N/A'
                                                    }</span>
                                                </div>
                                            </div>
                                            
                                            <div style="text-align: right;">
                                                <div style="color: #10B981; font-size: 1.5rem; font-weight: bold; margin-bottom: 0.25rem;">
                                                    R$ ${(parseFloat(plan.price) || 0).toFixed(2)}
                                                </div>
                                                <div style="color: #94A3B8; font-size: 0.75rem;">por mÃªs</div>
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 0.75rem;">
                                            ${!(currentPlan && currentPlan.id === plan.id) ? `
                                                <button onclick="switchToPlan('${plan.id}')" 
                                                        style="background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; border: none; padding: 0.75rem; border-radius: 8px; flex: 1; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                                    ${hasActiveSubscription ? 'ðŸ”„ Trocar para Este' : 'ðŸš€ Assinar Plano'}
                                                </button>
                                            ` : `
                                                <button style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10B981; color: #10B981; padding: 0.75rem; border-radius: 8px; flex: 1; font-weight: 600; cursor: not-allowed;">
                                                    âœ… Plano Ativo
                                                </button>
                                            `}
                                            <button onclick="showPlanDetails('${plan.id}')" 
                                                    style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 0.75rem; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                                ðŸ“„
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${availablePlans.length === 0 ? `
                                <div style="text-align: center; padding: 3rem; color: #94A3B8;">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“‹</div>
                                    <div style="font-size: 1.125rem; font-weight: 600;">Nenhum plano disponÃ­vel</div>
                                    <div style="font-size: 0.875rem; margin-top: 0.5rem;">Entre em contato com a administraÃ§Ã£o para mais informaÃ§Ãµes</div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Payment History Section -->
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 16px; padding: 2rem; border: 1px solid #334155;">
                            <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                                ðŸ’° HistÃ³rico de Pagamentos
                                <span style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">EM BREVE</span>
                            </h4>
                            <div style="background: rgba(30, 41, 59, 0.5); border-radius: 12px; padding: 2rem; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“Š</div>
                                <div style="color: #94A3B8; font-size: 1rem;">
                                    HistÃ³rico de pagamentos em desenvolvimento
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Erro ao carregar dados dos planos:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #EF4444;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div>
                        <div style="font-weight: 600;">Erro ao carregar dados dos planos</div>
                        <div style="font-size: 0.875rem; margin-top: 0.5rem; color: #94A3B8;">${error.message}</div>
                        <button onclick="loadPlansTabContent()" style="background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1rem; cursor: pointer;">
                            ðŸ”„ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // Edit Responsible function
        async function editResponsible() {
            const form = document.getElementById('editResponsibleForm');
            const formData = new FormData(form);
            
            const responsibleId = document.getElementById('editResponsibleId').value;
            const responsibleData = {
                name: document.getElementById('editResponsibleName').value.trim(),
                email: document.getElementById('editResponsibleEmail').value.trim(),
                phone: document.getElementById('editResponsiblePhone').value.trim(),
                birthDate: document.getElementById('editResponsibleBirthDate').value || null,
                relationshipType: document.getElementById('editResponsibleRelationType').value || null
            };

            // Validation
            if (!responsibleData.name || !responsibleData.email) {
                showToast('Por favor, preencha todos os campos obrigatÃ³rios', 'error');
                return;
            }

            try {
                showToast('â³ Atualizando responsÃ¡vel...', 'info');
                
                const response = await fetch(`/api/financial-responsibles/${responsibleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(responsibleData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('âœ… ResponsÃ¡vel atualizado com sucesso!', 'success');
                    closeModal('editResponsibleModal');
                    loadFinancialResponsiblesList(); // Refresh the list
                } else {
                    throw new Error(data.message || data.error || 'Erro ao atualizar responsÃ¡vel');
                }
            } catch (error) {
                console.error('Erro ao editar responsÃ¡vel:', error);
                showToast(`Erro ao atualizar responsÃ¡vel: ${error.message}`, 'error');
            }
        }

        // Add form submission handler for edit responsible form
        document.addEventListener('DOMContentLoaded', function() {
            const editResponsibleForm = document.getElementById('editResponsibleForm');
            if (editResponsibleForm) {
                editResponsibleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    editResponsible();
                });
            }
        });

        
        // ==========================================
        // UX FUNCTIONS FOR ENHANCED PLAN MANAGEMENT
        // ==========================================
        
        // Quick plan selector for users without plans
        function showQuickPlanSelector() {
            const selector = document.getElementById('quickPlanSelector');
            if (selector) {
                selector.scrollIntoView({ behavior: 'smooth', block: 'center' });
                selector.style.animation = 'pulse 1s ease-in-out';
            }
        }
        
        // Select plan quickly (one-click subscription)
        async function selectPlanQuickly(planId) {
            if (!currentEditingStudentId) {
                showToast('Erro: ID do aluno nÃ£o encontrado', 'error');
                return;
            }
            
            try {
                const confirmation = confirm('ðŸš€ Deseja atribuir este plano ao aluno?');
                if (!confirmation) return;
                
                // Use the improved assignment function
                await assignPlanToStudent(planId);
                
            } catch (error) {
                console.error('Erro ao atribuir plano rapidamente:', error);
                showToast('âŒ Erro ao atribuir plano: ' + error.message, 'error');
            }
        }
        
        // Show plan change options for users with active plans
        function showPlanChangeOptions() {
            const allPlansSection = document.getElementById('allPlansSection');
            if (allPlansSection) {
                allPlansSection.style.display = 'block';
                allPlansSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Highlight available plans
                const planCards = allPlansSection.querySelectorAll('.plan-card');
                planCards.forEach(card => {
                    if (!card.querySelector('[style*="PLANO ATUAL"]')) {
                        card.style.animation = 'glow 2s ease-in-out';
                        setTimeout(() => {
                            card.style.animation = '';
                        }, 2000);
                    }
                });
            }
            
            showToast('ðŸ’¡ Selecione um novo plano abaixo para trocar', 'info');
        }
        
        // Show plan management options (deactivate vs delete)
        async function showPlanCancellation() {
            const studentId = window.getCurrentEditingStudentId ? window.getCurrentEditingStudentId() : currentEditingStudentId;
            if (!studentId) {
                showToast('Erro: ID do aluno nÃ£o encontrado', 'error');
                return;
            }

            try {
                // Verificar se o plano jÃ¡ foi usado (tem histÃ³rico de pagamentos ou aulas)
                const hasUsageHistory = await checkPlanUsageHistory(studentId);
                
                if (hasUsageHistory) {
                    // Plano foi usado - sÃ³ pode ser desativado
                    const confirmation = confirm(`âš ï¸ DESATIVAR PLANO

Este plano possui histÃ³rico de uso (pagamentos ou aulas registradas).
Por polÃ­ticas de auditoria, ele nÃ£o pode ser excluÃ­do, apenas desativado.

âš ï¸ ATENÃ‡ÃƒO:
â€¢ O aluno perderÃ¡ acesso Ã s aulas futuras
â€¢ O histÃ³rico serÃ¡ mantido para auditoria
â€¢ A assinatura serÃ¡ desativada (nÃ£o cancelada)
â€¢ Ã‰ possÃ­vel reativar posteriormente se necessÃ¡rio

Confirma a DESATIVAÃ‡ÃƒO do plano?`);
                    
                    if (confirmation) {
                        await deactivateStudentPlan();
                    }
                } else {
                    // Plano nunca foi usado - pode ser excluÃ­do ou desativado
                    const action = confirm(`ðŸ—‘ï¸ GERENCIAR PLANO

Este plano nunca foi utilizado (sem pagamentos ou aulas registradas).

Escolha uma aÃ§Ã£o:
â€¢ OK = EXCLUIR PERMANENTEMENTE (remove todos os dados)
â€¢ Cancelar = DESATIVAR APENAS (mantÃ©m dados para auditoria)

âš ï¸ EXCLUSÃƒO Ã© irreversÃ­vel!
Deseja EXCLUIR permanentemente?`);
                    
                    if (action) {
                        await deleteStudentPlan();
                    } else {
                        const deactivateConfirm = confirm(`ðŸ“ DESATIVAR PLANO

O plano serÃ¡ desativado mas mantido no sistema.

Confirma a DESATIVAÃ‡ÃƒO?`);
                        
                        if (deactivateConfirm) {
                            await deactivateStudentPlan();
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar histÃ³rico do plano:', error);
                showToast('âŒ Erro ao verificar histÃ³rico do plano: ' + error.message, 'error');
            }
        }

        // Check if plan has usage history
        async function checkPlanUsageHistory(studentId) {
            try {
                // Verificar pagamentos
                const paymentsResponse = await fetch(`/api/students/${studentId}/payments`);
                const paymentsData = paymentsResponse.ok ? await paymentsResponse.json() : { data: [] };
                const hasPayments = paymentsData.data && paymentsData.data.length > 0;

                // Verificar aulas/presenÃ§as
                const attendanceResponse = await fetch(`/api/students/${studentId}/attendance`);
                const attendanceData = attendanceResponse.ok ? await attendanceResponse.json() : { data: [] };
                const hasAttendance = attendanceData.data && attendanceData.data.length > 0;

                // Verificar se tem assinatura ativa hÃ¡ mais de 7 dias
                const subscriptionResponse = await fetch(`/api/students/${studentId}/subscription`);
                const subscriptionData = subscriptionResponse.ok ? await subscriptionResponse.json() : null;
                let hasActiveSubscription = false;
                
                if (subscriptionData && subscriptionData.data) {
                    const createdDate = new Date(subscriptionData.data.createdAt);
                    const now = new Date();
                    const daysSinceCreation = (now - createdDate) / (1000 * 60 * 60 * 24);
                    hasActiveSubscription = daysSinceCreation > 7; // Plano ativo hÃ¡ mais de 7 dias
                }

                console.log('ðŸ” HistÃ³rico de uso do plano:', {
                    hasPayments,
                    hasAttendance,
                    hasActiveSubscription,
                    totalUsage: hasPayments || hasAttendance || hasActiveSubscription
                });

                return hasPayments || hasAttendance || hasActiveSubscription;
            } catch (error) {
                console.error('Erro ao verificar histÃ³rico:', error);
                // Em caso de erro, assumir que tem histÃ³rico (mais seguro)
                return true;
            }
        }

        // Deactivate student plan (soft delete)
        async function deactivateStudentPlan() {
            const studentId = window.getCurrentEditingStudentId ? window.getCurrentEditingStudentId() : currentEditingStudentId;
            try {
                showToast('â³ Desativando plano...', 'info');
                
                // Log da aÃ§Ã£o para auditoria
                console.log('ðŸ”’ AUDITORIA: Iniciando desativaÃ§Ã£o de plano', {
                    studentId: studentId,
                    timestamp: new Date().toISOString(),
                    action: 'DEACTIVATE_PLAN',
                    reason: 'Plano com histÃ³rico - preservando dados'
                });
                
                const response = await fetch(`/api/students/${studentId}/subscription/deactivate`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: 'Desativado pelo administrador',
                        deactivatedAt: new Date().toISOString(),
                        keepHistory: true,
                        auditLog: {
                            action: 'DEACTIVATE_PLAN',
                            performedBy: 'admin', // TODO: pegar user logado
                            timestamp: new Date().toISOString(),
                            preserveData: true
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('âœ… AUDITORIA: Plano desativado com sucesso', { 
                        studentId: studentId,
                        preservedData: true 
                    });
                    showToast('âœ… Plano desativado com sucesso! Dados preservados para auditoria.', 'success');
                    
                    // Reload the plans tab to reflect changes
                    setTimeout(() => {
                        loadPlansTabContent();
                    }, 1000);
                } else {
                    throw new Error(data.message || 'Erro ao desativar plano');
                }
            } catch (error) {
                console.error('âŒ AUDITORIA: Erro ao desativar plano', {
                    studentId: currentEditingStudentId,
                    error: error.message
                });
                showToast('âŒ Erro ao desativar plano: ' + error.message, 'error');
            }
        }

        // Delete student plan permanently (hard delete)
        async function deleteStudentPlan() {
            try {
                showToast('â³ Excluindo plano permanentemente...', 'info');
                
                // Log da aÃ§Ã£o para auditoria
                console.log('ðŸ—‘ï¸ AUDITORIA: Iniciando exclusÃ£o permanente de plano', {
                    studentId: currentEditingStudentId,
                    timestamp: new Date().toISOString(),
                    action: 'DELETE_PLAN',
                    reason: 'Plano sem histÃ³rico de uso'
                });
                
                const response = await fetch(`/api/students/${currentEditingStudentId}/subscription`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: 'ExclusÃ£o permanente - plano nÃ£o utilizado',
                        confirmedDeletion: true,
                        auditLog: {
                            action: 'DELETE_PLAN',
                            performedBy: 'admin', // TODO: pegar user logado
                            timestamp: new Date().toISOString(),
                            permanent: true,
                            dataRemoved: true
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('ðŸ—‘ï¸ AUDITORIA: Plano excluÃ­do permanentemente', { 
                        studentId: currentEditingStudentId,
                        dataRemoved: true 
                    });
                    showToast('âœ… Plano excluÃ­do permanentemente! Dados removidos do sistema.', 'success');
                    
                    // Reload the plans tab to reflect changes
                    setTimeout(() => {
                        loadPlansTabContent();
                    }, 1000);
                } else {
                    throw new Error(data.message || 'Erro ao excluir plano');
                }
            } catch (error) {
                console.error('âŒ AUDITORIA: Erro ao excluir plano', {
                    studentId: currentEditingStudentId,
                    error: error.message
                });
                showToast('âŒ Erro ao excluir plano: ' + error.message, 'error');
            }
        }
        
        // Show all plans (expand the collapsed section)
        function showAllPlans() {
            const allPlansSection = document.getElementById('allPlansSection');
            if (allPlansSection) {
                allPlansSection.style.display = 'block';
                allPlansSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Toggle all plans view
        function toggleAllPlansView() {
            const allPlansSection = document.getElementById('allPlansSection');
            const button = event.target;
            
            if (allPlansSection.style.display === 'none') {
                allPlansSection.style.display = 'block';
                button.textContent = 'ðŸ“ Recolher';
                allPlansSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                allPlansSection.style.display = 'none';
                button.textContent = 'ðŸ“Š Expandir';
            }
        }
        
        // Filter plans by category
        function filterPlansByCategory() {
            const filter = document.getElementById('planCategoryFilter').value;
            const planCards = document.querySelectorAll('.plan-card');
            
            planCards.forEach(card => {
                const category = card.getAttribute('data-category');
                if (!filter || category === filter) {
                    card.style.display = 'block';
                    card.style.animation = 'fadeIn 0.3s ease-in-out';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show message if no plans match filter
            const visibleCards = Array.from(planCards).filter(card => card.style.display !== 'none');
            const plansGrid = document.getElementById('plansGrid');
            
            if (visibleCards.length === 0) {
                if (!document.getElementById('noPlansMessage')) {
                    const message = document.createElement('div');
                    message.id = 'noPlansMessage';
                    message.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 2rem; color: #94A3B8;';
                    message.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ”</div>
                        <div>Nenhum plano encontrado para a categoria selecionada</div>
                    `;
                    plansGrid.appendChild(message);
                }
            } else {
                const existingMessage = document.getElementById('noPlansMessage');
                if (existingMessage) {
                    existingMessage.remove();
                }
            }
        }
        
        // Filter plans by billing type (added for comprehensive filtering)
        function filterPlansByType() {
            const filter = document.getElementById('planBillingTypeFilter')?.value;
            if (!filter) return;
            
            const planCards = document.querySelectorAll('.plan-card, .plan-card-compact');
            
            planCards.forEach(card => {
                const billingType = card.getAttribute('data-billing');
                if (!filter || billingType === filter || filter === 'ALL') {
                    card.style.display = 'block';
                    card.style.animation = 'fadeIn 0.3s ease-in-out';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Update count of visible plans
            const visibleCards = Array.from(planCards).filter(card => card.style.display !== 'none');
            console.log(`Filtered plans by type ${filter}: ${visibleCards.length} visible`);
            
            // Show message if no plans match filter
            const plansGrid = document.getElementById('plansGrid');
            if (plansGrid) {
                if (visibleCards.length === 0) {
                    if (!document.getElementById('noPlansMessage')) {
                        const message = document.createElement('div');
                        message.id = 'noPlansMessage';
                        message.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 2rem; color: #94A3B8;';
                        message.innerHTML = `
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ’³</div>
                            <div>Nenhum plano encontrado para o tipo de cobranÃ§a selecionado</div>
                        `;
                        plansGrid.appendChild(message);
                    }
                } else {
                    const existingMessage = document.getElementById('noPlansMessage');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                }
            }
            
            showToast(`ðŸ’¡ Filtro aplicado: ${visibleCards.length} planos encontrados`, 'info');
        }
        
        // Show plan details (modal or expanded view)
        function showPlanDetails(planId) {
            // For now, show a detailed alert - can be enhanced to a modal later
            showToast('ðŸ’¡ Funcionalidade de detalhes do plano em desenvolvimento', 'info');
            console.log('Showing details for plan:', planId);
        }

        // Show plan management policies
        function showPlanManagementPolicies() {
            const modal = document.createElement('div');
            modal.id = 'planPoliciesModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1E293B, #0F172A); border-radius: 16px; 
                            padding: 2rem; max-width: 600px; width: 100%; border: 1px solid #334155; 
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h3 style="color: #F8FAFC; margin: 0; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
                            ðŸ“‹ PolÃ­ticas de GestÃ£o de Planos
                        </h3>
                        <button onclick="closePlanPoliciesModal()" 
                                style="background: transparent; border: none; color: #94A3B8; cursor: pointer; font-size: 1.5rem; padding: 0.5rem;">
                            âœ•
                        </button>
                    </div>
                    
                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Planos Ativos -->
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <h4 style="color: #10B981; margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                âœ… ExibiÃ§Ã£o de Planos
                            </h4>
                            <ul style="color: #F8FAFC; margin: 0; padding-left: 1.5rem; line-height: 1.6;">
                                <li>Apenas planos <strong>ATIVOS</strong> sÃ£o exibidos no cadastro</li>
                                <li>Planos inativos ficam ocultos mas mantidos no sistema</li>
                                <li>Administradores podem reativar planos se necessÃ¡rio</li>
                            </ul>
                        </div>
                        
                        <!-- ExclusÃ£o vs DesativaÃ§Ã£o -->
                        <div style="background: rgba(239, 68, 68, 0.1); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(239, 68, 68, 0.2);">
                            <h4 style="color: #EF4444; margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                ðŸ—‘ï¸ RemoÃ§Ã£o de Planos
                            </h4>
                            <div style="display: grid; gap: 1rem;">
                                <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem;">
                                    <h5 style="color: #10B981; margin: 0 0 0.5rem 0; font-weight: 600;">âœ… EXCLUSÃƒO PERMANENTE</h5>
                                    <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">
                                        Permitida apenas para planos <strong>nunca utilizados</strong>:<br>
                                        â€¢ Sem pagamentos registrados<br>
                                        â€¢ Sem aulas frequentadas<br>
                                        â€¢ Assinatura ativa hÃ¡ menos de 7 dias
                                    </p>
                                </div>
                                <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem;">
                                    <h5 style="color: #F59E0B; margin: 0 0 0.5rem 0; font-weight: 600;">ðŸ“ DESATIVAÃ‡ÃƒO APENAS</h5>
                                    <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">
                                        ObrigatÃ³ria para planos <strong>com histÃ³rico</strong>:<br>
                                        â€¢ Preserva dados para auditoria<br>
                                        â€¢ MantÃ©m histÃ³rico de pagamentos<br>
                                        â€¢ Permite reativaÃ§Ã£o futura
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Auditoria -->
                        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <h4 style="color: #3B82F6; margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                ðŸ” Conformidade e Auditoria
                            </h4>
                            <ul style="color: #F8FAFC; margin: 0; padding-left: 1.5rem; line-height: 1.6;">
                                <li>HistÃ³rico de uso determina tipo de remoÃ§Ã£o</li>
                                <li>Dados financeiros sÃ£o sempre preservados</li>
                                <li>Sistema previne perda acidental de dados</li>
                                <li>Todas as aÃ§Ãµes sÃ£o registradas em log</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; text-align: center;">
                        <button onclick="closePlanPoliciesModal()" 
                                style="background: #3B82F6; color: white; border: none; padding: 1rem 2rem; 
                                       border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            Entendi
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePlanPoliciesModal();
                }
            });
        }
        
        // Close plan policies modal
        function closePlanPoliciesModal() {
            const modal = document.getElementById('planPoliciesModal');
            if (modal) {
                modal.remove();
            }
        }

        function loadClassesTabContent() {
            const content = document.getElementById('page-tab-classes');
            if (content) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94A3B8;">
                        ðŸ¥‹ Turmas e horÃ¡rios em desenvolvimento
                    </div>
                `;
            }
        }

        function loadCoursesTabContent() {
            const content = document.getElementById('page-tab-courses');
            if (content) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94A3B8;">
                        ðŸ“š Cursos e progresso em desenvolvimento
                    </div>
                `;
            }
        }

        function loadProgressTabContent() {
            const content = document.getElementById('page-tab-progress');
            if (content) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94A3B8;">
                        ðŸ“ˆ Progresso e conquistas em desenvolvimento
                    </div>
                `;
            }
        }

        // Functions for plan management
        async function createNewSubscription() {
            if (!currentEditingStudentId) {
                alert('Erro: ID do aluno nÃ£o encontrado');
                return;
            }
            
            // Simple implementation - could be expanded to show plan selection modal
            const planId = prompt('Digite o ID do plano para criar nova assinatura:');
            if (!planId) return;
            
            try {
                const response = await fetch('/api/financial/subscriptions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        studentId: currentEditingStudentId,
                        planId: planId,
                        status: 'ACTIVE',
                        isActive: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Assinatura criada com sucesso!');
                    // Reload the plans tab to show updated data
                    loadPlansTabContent();
                } else {
                    alert(`Erro ao criar assinatura: ${result.message}`);
                }
            } catch (error) {
                console.error('Erro ao criar assinatura:', error);
                alert(`Erro ao criar assinatura: ${error.message}`);
            }
        }
        
        async function switchToPlan(planId) {
            if (!currentEditingStudentId) {
                showToast('âŒ Erro: ID do aluno nÃ£o encontrado', 'error');
                return;
            }
            
            console.log('ðŸ”„ Switching to plan:', planId, 'for student:', currentEditingStudentId);
            
            // Use the improved assignment function which handles all fallbacks
            await assignPlanToStudent(planId);
        }

        // Navigation system with enhanced debugging
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Dashboard carregado com sucesso!');
            
            // Setup navigation
            const navButtons = document.querySelectorAll('.nav-link');
            console.log('ðŸ” Found navigation buttons:', navButtons.length);
            
            navButtons.forEach(button => {
                const page = button.getAttribute('data-page');
                console.log('ðŸ“„ Setting up navigation for:', page);
                
                button.addEventListener('click', function() {
                    const targetPage = this.getAttribute('data-page');
                    console.log('ðŸ”˜ Navigation clicked:', targetPage);
                    
                    // Special handling for payment-plans
                    if (targetPage === 'payment-plans') {
                        console.log('ðŸ’³ Navigating to payment plans specifically');
                        
                        // Force hide plan-edit section
                        const planEditSection = document.getElementById('plan-edit');
                        if (planEditSection) {
                            planEditSection.classList.remove('active');
                            planEditSection.style.display = 'none';
                        }
                        
                        // Clear any global state
                        currentPlanId = null;
                    }
                    
                    showSection(targetPage);
                    
                    // Load the appropriate data for the section
                    switch (targetPage) {
                        case 'dashboard':
                            loadData();
                            break;
                        case 'students':
                            if (window.loadAndRenderStudents) {
                                window.loadAndRenderStudents();
                            }
                            break;
                        case 'courses':
                            if (window.loadAndRenderCourses) {
                                window.loadAndRenderCourses();
                            }
                            break;
                        case 'classes':
                            if (window.loadAndRenderClasses) {
                                window.loadAndRenderClasses();
                            }
                            break;
                        case 'financial':
                        case 'payment-plans':
                            if (window.loadAndRenderPlans) {
                                window.loadAndRenderPlans();
                            }
                            break;
                        default:
                            console.log(`No specific data loader for section: ${targetPage}`);
                    }
                });
            });
            
            // Load initial data
            loadData();
            
            // Define plan edit function globally
            window.openPlanEditPage = async function(planId) {
                console.log('ðŸ”„ Opening plan edit page for:', planId);
                currentPlanId = planId;
                window.currentPlanId = planId;
                
                // Find the plan data
                const plan = allPlans.find(p => p.id == planId || p.id === planId);
                if (!plan) {
                    console.error('âŒ Plan not found for edit page:', planId);
                    showNotification('Plano nÃ£o encontrado', 'error');
                    return;
                }
                
                // Hide all sections and show plan edit
                document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                });
                document.getElementById('plan-edit').style.display = 'block';
                
                // Update page subtitle with plan name
                document.getElementById('planEditSubtitle').textContent = `Editando: ${plan.name}`;
                
                // Set form dataset attributes
                const form = document.getElementById('planEditForm');
                if (form) {
                    form.dataset.mode = 'edit';
                    form.dataset.editingPlanId = planId;
                    console.log('âœ… Form data attributes set:', form.dataset);
                }
                
                // Populate form fields
                try {
                    await populatePlanEditForm(plan);
                } catch (error) {
                    console.error('âŒ Error populating form:', error);
                    showNotification('Erro ao carregar dados do plano', 'error');
                }
                
                showNotification(`Editando plano: ${plan.name}`, 'info');
            };
            
            // Make switchPlanEditTab globally accessible
            window.switchPlanEditTab = function(tabName) {
                // Remove active class from all tabs and content
                document.querySelectorAll('.plan-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.plan-tab-content').forEach(content => content.classList.remove('active'));
                
                // Add active class to selected tab and content
                const selectedTab = document.querySelector(`.plan-tab[data-tab="${tabName}"]`);
                const selectedContent = document.getElementById(`planEditTab-${tabName}`);
                
                if (selectedTab && selectedContent) {
                    selectedTab.classList.add('active');
                    selectedContent.classList.add('active');
                }
                
                // Load content for specific tabs
                if (tabName === 'courses') {
                    // Only reload if not already loaded
                    const coursesGrid = document.getElementById('editCoursesGrid');
                    if (!coursesGrid || !coursesGrid.innerHTML.includes('planCourses')) {
                        console.log('ðŸ”„ Tab courses - Loading for first time');
                        const currentSelection = getCurrentlySelectedCourseIds();
                        loadCoursesForPlanEdit(currentSelection);
                    } else {
                        console.log('âœ… Tab courses - Already loaded, skipping reload');
                    }
                } else if (tabName === 'preview') {
                    updatePlanPreview();
                }
            };
            
            // Add missing functions
            window.updatePlanEditPreview = function() {
                console.log('ðŸ”„ Updating plan edit preview...');
                // Implementation for preview update
            };
            
            
            
            // Define populatePlanEditForm in the main DOMContentLoaded handler
            window.populatePlanEditForm = async function(plan) {
                console.log('ðŸ“ Populating comprehensive form with plan data:', plan);
                
                try {
                    // Helper function to safely set element value
                    const safeSetValue = (elementId, value) => {
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.value = value || '';
                            console.log(`âœ… Set ${elementId} = ${value}`);
                        } else {
                            console.warn(`âš ï¸ Element not found: ${elementId}`);
                        }
                    };

                    // Helper function to safely set checkbox
                    const safeSetCheckbox = (elementId, checked) => {
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.checked = checked;
                            console.log(`âœ… Set checkbox ${elementId} = ${checked}`);
                        } else {
                            console.warn(`âš ï¸ Checkbox not found: ${elementId}`);
                        }
                    };

                    // Basic information
                    safeSetValue('editPlanName', plan.name);
                    safeSetValue('editPlanDescription', plan.description);
                    safeSetValue('editPlanCategory', plan.category);
                    safeSetValue('editPlanPrice', plan.price);
                    safeSetValue('editPlanBillingType', plan.billingType || 'MONTHLY');
                    safeSetValue('editPlanWeeklyClasses', plan.classesPerWeek || 2);

                    // Set checkbox features
                    safeSetCheckbox('editPlanFeaturePersonal', plan.hasPersonalTraining || false);
                    safeSetCheckbox('editPlanFeatureNutrition', plan.hasNutrition || false);

                    // Load courses and pre-select them
                    console.log('ðŸŽ“ Loading courses for plan edit...');
                    console.log('ðŸ” [DEBUG] Full plan data received:', plan);
                    console.log('ðŸ” [DEBUG] Plan features:', plan.features);
                    console.log('ðŸ” [DEBUG] Plan courseId:', plan.courseId);
                    
                    try {
                        // Prepare courses to pre-select
                        let coursesToSelect = [];
                        
                        // Check features.courseIds first (this is where multiple courses are saved)
                        if (plan.features && plan.features.courseIds && Array.isArray(plan.features.courseIds)) {
                            coursesToSelect = [...plan.features.courseIds];
                            console.log('âœ… Found courses in features.courseIds:', coursesToSelect);
                        } else {
                            console.warn('âš ï¸ No features.courseIds found or not an array');
                        }
                        
                        // Also check single courseId for backwards compatibility
                        if (plan.courseId && !coursesToSelect.includes(plan.courseId)) {
                            coursesToSelect.push(plan.courseId);
                            console.log('âœ… Added courseId to selection:', plan.courseId);
                        } else if (!plan.courseId) {
                            console.warn('âš ï¸ No single courseId found');
                        }
                        
                        console.log('ðŸŽ“ Final courses to select:', coursesToSelect);
                        
                        // Load courses with pre-selection
                        await loadCoursesForPlanEdit(coursesToSelect);
                        
                    } catch (error) {
                        console.error('âŒ Error loading courses:', error);
                    }

                    console.log('âœ… Form populated successfully');
                } catch (error) {
                    console.error('âŒ Error populating form:', error);
                    showNotification('Erro ao carregar dados do plano', 'error');
                }
            };
        });
        
        function showSection(pageName) {
            console.log('ðŸ“„ Navegando para:', pageName);
            
            // Hide all sections with explicit display none
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
                console.log('ðŸ”’ Hidden section:', section.id);
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.nav-link').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show target section with explicit display block
            const targetSection = document.getElementById(pageName);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
                console.log('âœ… SeÃ§Ã£o ativa:', pageName);
                console.log('âœ… Display style:', targetSection.style.display);
                console.log('âœ… Has active class:', targetSection.classList.contains('active'));
            } else {
                console.error('âŒ SeÃ§Ã£o nÃ£o encontrada:', pageName);
                console.log('ðŸ” Available sections:', Array.from(document.querySelectorAll('.content-section')).map(s => s.id));
            }
            
            // Activate current button
            const activeButton = document.querySelector(`[data-page="${pageName}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                console.log('âœ… Navigation button activated:', activeButton.textContent.trim());
            } else {
                console.error('âŒ Navigation button not found for:', pageName);
            }

            // Load data for specific sections
            console.log('ðŸ” Checking page data loading for:', pageName);
            if (pageName === 'course-management') {
                loadCourses();
            } else if (pageName === 'attendance') {
                loadAttendanceList();
            } else if (pageName === 'students') {
                loadStudents();
            } else if (pageName === 'student-portal') {
                // Reset student portal to login screen
                document.getElementById('studentLoginSection').style.display = 'block';
                document.getElementById('studentDashboard').style.display = 'none';
                currentStudent = null;
            } else if (pageName === 'public-checkin') {
                loadPublicCheckin();
            } else if (pageName === 'payment-plans') {
                console.log('ðŸ“„ Loading payment plans page...');
                
                // Force hide plan-edit section
                const planEditSection = document.getElementById('plan-edit');
                if (planEditSection) {
                    planEditSection.classList.remove('active');
                    planEditSection.style.display = 'none';
                    console.log('ðŸ”’ Force hidden plan-edit section');
                }
                
                // Clear any plan editing state
                currentPlanId = null;
                
                // Load the payment plans list
                loadPaymentPlansList();
            } else if (pageName === 'financial-responsibles') {
                console.log('ðŸ‘¥ Loading financial responsibles page...');
                loadFinancialResponsiblesList();
            }
        }
        
        function loadData() {
            console.log('ðŸ“Š Carregando dados...');
            
            // Students count will be updated by real API data
            
            // Try to load real data from API
            fetch('/api/students')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.length > 0) {
                        const total = data.data.length;
                        const active = data.data.filter(s => s.user && s.user.isActive).length;
                        
                        document.getElementById('total-students').textContent = total;
                        document.getElementById('active-students').textContent = active;
                        document.getElementById('students-count').textContent = total;
                        
                        console.log('âœ… Dados dos alunos atualizados:', total, 'total,', active, 'ativos');
                    }
                })
                .catch(error => {
                    console.log('âš ï¸ Usando dados padrÃ£o - API nÃ£o disponÃ­vel');
                });
        }
        
        // Test functions
        window.testNavigation = function(page) {
            showSection(page || 'students');
        };
        
        console.log('ðŸŽ¯ Sistema pronto! Teste: testNavigation("students")');
        
        // Apply showSection enhancement for knowledge base (check if function exists)
        if (typeof enhanceShowSection === 'function') {
            enhanceShowSection();
        }
        
        // Payment plans loading function
        async function loadPaymentPlansList() {
            console.log('ðŸ”„ Loading payment plans list...');
            try {
                const loadingElement = document.getElementById('plansLoadingState');
                const emptyElement = document.getElementById('plansEmptyState');
                
                if (loadingElement) loadingElement.style.display = 'block';
                if (emptyElement) emptyElement.style.display = 'none';
                
                console.log('ðŸ“¡ Fetching billing plans from API...');
                const response = await fetch('/api/billing-plans');
                const result = await response.json();
                
                console.log('ðŸ“Š API Response:', result);
                
                if (result.success) {
                    allPlans = result.data || [];
                    console.log('ðŸ“‹ Plans loaded:', allPlans.length, 'plans');
                    
                    updatePaymentPlansTable(allPlans);
                    updatePlansStats(allPlans);
                    
                    if (allPlans.length === 0) {
                        if (loadingElement) loadingElement.style.display = 'none';
                        if (emptyElement) emptyElement.style.display = 'block';
                        console.log('âš ï¸ No plans found - showing empty state');
                    } else {
                        if (loadingElement) loadingElement.style.display = 'none';
                        console.log('âœ… Plans table updated successfully');
                    }
                } else {
                    throw new Error(result.message || 'Failed to load plans');
                }
            } catch (error) {
                console.error('Erro ao carregar planos:', error);
                
                // Initialize allPlans as empty array to prevent undefined errors
                allPlans = [];
                updatePaymentPlansTable(allPlans);
                updatePlansStats(allPlans);
                
                const loadingElement = document.getElementById('plansLoadingState');
                if (loadingElement) {
                    loadingElement.innerHTML = `
                        <div style="text-align: center; color: #EF4444; padding: 3rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">âš ï¸</div>
                            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Erro ao carregar planos</div>
                            <div style="font-size: 0.9rem; opacity: 0.7;">${error.message}</div>
                        </div>
                    `;
                }
            }
        }
        
        // Global variables for payment plans
        let allPlans = [];
        let allCourses = [];
        
        // Update payment plans table
        function updatePaymentPlansTable(plans) {
            console.log('ðŸ”„ Updating payment plans table with', plans?.length, 'plans');
            const tbody = document.getElementById('plansTableBody');
            
            if (!tbody) {
                console.error('âŒ plansTableBody element not found in DOM');
                return;
            }
            
            if (!plans || !Array.isArray(plans)) {
                console.warn('âš ï¸ Plans data is undefined or not an array:', plans);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94A3B8; padding: 2rem;">Nenhum plano encontrado</td></tr>';
                return;
            }
            
            console.log('ðŸ“‹ Processing', plans.length, 'plans for table');
            
            tbody.innerHTML = plans.map(plan => {
                const courseName = (allCourses && Array.isArray(allCourses)) 
                    ? allCourses.find(c => c.id === plan.courseId)?.name || 'Geral'
                    : 'Geral';
                
                return `
                <tr ondblclick="openPlanEditPage('${plan.id}')" style="cursor: pointer;">
                    <td>
                        <div class="student-name">${plan.name || 'Plano sem nome'}</div>
                        <div style="font-size: 0.8rem; color: #94A3B8;">${plan.description || ''}</div>
                    </td>
                    <td>
                        <span class="student-email">${courseName}</span>
                    </td>
                    <td>
                        <span class="badge ${plan.category === 'ADULT' ? 'success' : 'info'}">
                            ${plan.category || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <span class="metric-value" style="color: #10B981; font-weight: bold;">
                            R$ ${(parseFloat(plan.price) || 0).toFixed(2)}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${plan.billingType === 'MONTHLY' ? 'info' : 'warning'}">
                            ${plan.billingType === 'MONTHLY' ? 'Mensal' : plan.billingType || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <span class="badge info">${plan.activeSubscriptions || 0}</span>
                    </td>
                    <td>
                        <span class="badge ${plan.isActive ? 'success' : 'danger'}">
                            ${plan.isActive ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editPlan('${plan.id}')" title="Editar">
                                âœï¸
                            </button>
                            <button class="action-btn delete" onclick="deletePlan('${plan.id}')" title="Excluir">
                                ðŸ—‘ï¸
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
            
            console.log('âœ… Table HTML updated. Rows in tbody:', tbody.children.length);
        }
        
        // Update plans stats
        function updatePlansStats(plans) {
            if (!plans || !Array.isArray(plans)) return;
            
            const totalPlans = plans.length;
            const activePlans = plans.filter(p => p.isActive).length;
            const averagePrice = plans.length > 0 ? 
                plans.reduce((sum, plan) => sum + (parseFloat(plan.price) || 0), 0) / plans.length : 0;
            const monthlyPlans = plans.filter(p => p.billingType === 'MONTHLY').length;
            
            // Update stat cards if they exist
            const totalElement = document.getElementById('total-plans-stat');
            const activeElement = document.getElementById('active-plans-stat');
            const avgPriceElement = document.getElementById('avg-price-stat');
            const monthlyElement = document.getElementById('monthly-plans-stat');
            
            if (totalElement) totalElement.textContent = totalPlans;
            if (activeElement) activeElement.textContent = activePlans;
            if (avgPriceElement) avgPriceElement.textContent = `R$ ${averagePrice.toFixed(2)}`;
            if (monthlyElement) monthlyElement.textContent = monthlyPlans;
            
            // Update plans count badge
            const plansCountElement = document.getElementById('plans-count');
            if (plansCountElement) plansCountElement.textContent = totalPlans;
        }
        
        // Modal functions
        // Global variable to store financial responsibles
        let financialResponsibles = [];

        // Load financial responsibles
        async function loadFinancialResponsibles() {
            try {
                const response = await fetch('/api/financial-responsibles');
                const data = await response.json();
                
                if (data.success) {
                    financialResponsibles = data.data;
                    updateFinancialResponsiblesOptions();
                } else {
                    console.error('Erro ao carregar responsÃ¡veis financeiros:', data.message);
                }
            } catch (error) {
                console.error('Erro ao carregar responsÃ¡veis financeiros:', error);
            }
        }

        // Update both select elements with financial responsibles
        function updateFinancialResponsiblesOptions() {
            const addSelect = document.getElementById('studentFinancialResponsible');
            const editSelect = document.getElementById('editStudentFinancialResponsible');
            
            const optionsHTML = '<option value="">Selecione um responsÃ¡vel (opcional)</option>' +
                financialResponsibles.map(responsible => 
                    `<option value="${responsible.id}">${responsible.name} - ${responsible.relationshipType || 'NÃ£o informado'}</option>`
                ).join('');
            
            if (addSelect) addSelect.innerHTML = optionsHTML;
            if (editSelect) editSelect.innerHTML = optionsHTML;
        }

        // Load billing plans dynamically
        async function loadBillingPlans() {
            try {
                console.log('ðŸ“‹ Carregando planos de pagamento...');
                const response = await fetch('/api/billing-plans');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log('ðŸ“‹ Planos de pagamento carregados:', data.data.length);
                    // Store plans for later use in plan preview
                    window.billingPlans = data.data;
                    updateBillingPlansOptions();
                } else {
                    console.log('ðŸ“‹ Nenhum plano de pagamento encontrado ou erro na API');
                    window.billingPlans = [];
                    updateBillingPlansOptions();
                }
            } catch (error) {
                console.error('âŒ Erro ao carregar planos de pagamento:', error.message);
                window.billingPlans = [];
                updateBillingPlansOptions();
                // Don't throw - just log and continue
            }
        }

        // Update billing plans select options
        function updateBillingPlansOptions() {
            const billingPlanSelect = document.getElementById('studentBillingPlan');
            
            if (!billingPlanSelect) return;
            
            let optionsHTML = '<option value="">Selecione um plano (opcional)</option>';
            
            if (window.billingPlans && window.billingPlans.length > 0) {
                optionsHTML += window.billingPlans.map(plan => {
                    const courseName = plan.course?.name || 'Curso nÃ£o especificado';
                    const price = plan.price ? `R$ ${plan.price.toFixed(2)}` : 'PreÃ§o nÃ£o definido';
                    const category = plan.category || 'Categoria geral';
                    
                    return `<option value="${plan.id}">${plan.name} - ${price} (${category}) - ${courseName}</option>`;
                }).join('');
            }
            
            billingPlanSelect.innerHTML = optionsHTML;
        }

        function openAddStudentModal() {
            console.log('ðŸ”„ Iniciando abertura do modal...');
            
            try {
                // ALWAYS open modal first - this is the critical part
                const modal = document.getElementById('addStudentModal');
                console.log('ðŸ” Modal encontrado:', modal ? 'SIM' : 'NÃƒO');
                
                if (modal) {
                    console.log('ðŸ“ Classes atuais do modal:', modal.className);
                    modal.classList.add('active');
                    console.log('âœ… Classe "active" adicionada');
                    console.log('ðŸ“ Classes apÃ³s adiÃ§Ã£o:', modal.className);
                    
                    // Load data after modal is open - don't block modal opening
                    console.log('ðŸ“Š Iniciando carregamento de dados...');
                    loadDataForStudentModal();
                } else {
                    console.error('âŒ Modal addStudentModal nÃ£o encontrado no DOM');
                    alert('Erro: Modal nÃ£o encontrado no DOM');
                    return;
                }
            } catch (error) {
                console.error('âŒ Erro crÃ­tico ao abrir modal:', error);
                alert('Erro crÃ­tico: ' + error.message);
            }
        }
        
        // Separate function to load data without blocking modal
        async function loadDataForStudentModal() {
            console.log('ðŸ“Š Carregando dados do formulÃ¡rio...');
            
            // Load billing plans first (planos reais)
            loadBillingPlans().catch(error => {
                console.error('âŒ Erro ao carregar planos:', error);
            });
            
            // Load courses second (cursos reais)  
            loadCoursesForModal().catch(error => {
                console.error('âŒ Erro ao carregar cursos:', error);
            });
            
            // Load classes third (turmas reais)
            loadClassesForModal().catch(error => {
                console.error('âŒ Erro ao carregar turmas:', error);
            });
            
            // Load responsibles last
            loadFinancialResponsibles().catch(error => {
                console.error('âŒ Erro ao carregar responsÃ¡veis:', error);
            });
            
            console.log('âœ… Carregamento de dados iniciado');
        }

        // Load classes dynamically for the modal
        async function loadClassesForModal() {
            try {
                const response = await fetch('/api/classes');
                const data = await response.json();
                
                const classSelect = document.getElementById('studentClass');
                if (data.success && data.data && data.data.length > 0) {
                    let optionsHTML = '<option value="">Selecione uma turma...</option>';
                    data.data.forEach(classItem => {
                        const instructor = classItem.instructor ? 
                            `${classItem.instructor.user.firstName} ${classItem.instructor.user.lastName}` : 
                            'Professor nÃ£o definido';
                        const schedule = classItem.schedule || 
                            (classItem.startTime ? `${classItem.startTime}` : 'HorÃ¡rio nÃ£o definido');
                        const capacity = classItem.mat?.capacity || classItem.maxStudents || 'N/A';
                        const currentStudents = classItem._count?.studentCourses || 0;
                        
                        optionsHTML += `<option value="${classItem.id}">${classItem.name} - ${schedule} (${instructor}) - ${currentStudents}/${capacity} alunos</option>`;
                    });
                    classSelect.innerHTML = optionsHTML;
                } else {
                    classSelect.innerHTML = '<option value="">Nenhuma turma disponÃ­vel</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar turmas:', error);
                const classSelect = document.getElementById('studentClass');
                classSelect.innerHTML = '<option value="">Erro ao carregar turmas</option>';
            }
        }

        // Load courses dynamically for the modal
        async function loadCoursesForModal() {
            try {
                const response = await fetch('/api/courses');
                const data = await response.json();
                
                const courseSelect = document.getElementById('studentCourse');
                if (data.success && data.data && data.data.length > 0) {
                    let optionsHTML = '<option value="">Selecione um curso (opcional)</option>';
                    data.data.forEach(course => {
                        const martialArt = course.martialArt?.name || 'Arte marcial nÃ£o definida';
                        const classCount = course._count?.classes || 0;
                        const studentCount = course._count?.studentCourses || 0;
                        const planCount = course.billingPlans?.length || 0;
                        
                        optionsHTML += `<option value="${course.id}">${course.name} (${martialArt}) - ${classCount} turmas, ${studentCount} alunos, ${planCount} planos</option>`;
                    });
                    courseSelect.innerHTML = optionsHTML;
                } else {
                    courseSelect.innerHTML = '<option value="">Nenhum curso disponÃ­vel</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar cursos:', error);
                const courseSelect = document.getElementById('studentCourse');
                courseSelect.innerHTML = '<option value="">Erro ao carregar cursos</option>';
            }
        }
        
        // Function called by edit button in table
        async function openEditStudentModal(studentId) {
            // Redirect to dedicated page instead of modal
            console.log('ðŸ”„ Redirecionando openEditStudentModal para tela completa:', studentId);
            await openStudentEditPage(studentId);
        }

        function closeEditStudentModal() {
            document.getElementById('editStudentModal').classList.remove('active');
            // Clear form
            document.getElementById('editStudentForm').reset();
        }

        async function saveEditStudent() {
            const studentId = currentEditingStudentId;
            
            console.log('ðŸ” Debug saveEditStudent - currentEditingStudentId:', studentId);
            
            if (!studentId) {
                console.error('âŒ Student ID not found');
                showToast('âŒ Erro: ID do aluno nÃ£o encontrado', 'error');
                return;
            }
            
            const formData = {
                firstName: document.getElementById('editFirstName').value,
                lastName: document.getElementById('editLastName').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                cpf: document.getElementById('editCpf').value,
                birthDate: document.getElementById('editBirthDate').value,
                category: document.getElementById('editCategory').value,
                gender: document.getElementById('editGender').value,
                physicalCondition: document.getElementById('editPhysicalCondition').value,
                enrollmentDate: document.getElementById('editEnrollmentDate').value,
                medicalConditions: document.getElementById('editMedicalConditions').value,
                emergencyContact: document.getElementById('editEmergencyContact').value,
                specialNeeds: Array.from(document.getElementById('editSpecialNeeds').selectedOptions).map(option => option.value)
            };
            
            try {
                const response = await fetch(`/api/students/${studentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Aluno atualizado com sucesso!', 'success');
                    closeEditStudentModal();
                    loadData(); // Reload students data
                } else {
                    throw new Error(result.message || 'Erro ao atualizar aluno');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao atualizar aluno: ' + error.message, 'error');
            }
        }

        function editStudent(studentId) {
            // Redirect to dedicated page instead of modal
            console.log('ðŸ”„ Redirecionando editStudent para tela completa:', studentId);
            openStudentEditPage(studentId);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            // Limpar dados do sistema de vinculaÃ§Ã£o automÃ¡tica quando fechar modal de adicionar aluno
            if (modalId === 'addStudentModal') {
                selectedClasses = [];
                selectedCourses = [];
                currentPlanData = null;
                
                // Esconder containers
                document.getElementById('classesSelectionContainer').style.display = 'none';
                document.getElementById('coursesSelectionContainer').style.display = 'none';
                document.getElementById('totalCostDisplay').style.display = 'none';
                
                // Resetar select de plano
                document.getElementById('studentBillingPlan').value = '';
                
                console.log('ðŸ§¹ Dados de vinculaÃ§Ã£o automÃ¡tica limpos');
            }
        }
        
        // Form submissions
        document.getElementById('addStudentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                firstName: document.getElementById('studentName').value.split(' ')[0],
                lastName: document.getElementById('studentName').value.split(' ').slice(1).join(' '),
                email: document.getElementById('studentEmail').value,
                phone: document.getElementById('studentPhone').value,
                birthDate: document.getElementById('studentBirthDate').value,
                gender: document.getElementById('studentGender').value,
                category: document.getElementById('studentCategory').value,
                billingPlanId: document.getElementById('studentBillingPlan').value || null, // Billing plan selection
                courseId: document.getElementById('studentCourse').value || null, // For intelligent enrollment
                classId: document.getElementById('studentClass').value,
                financialResponsibleId: document.getElementById('studentFinancialResponsible').value || null,
                // Sistema de vinculaÃ§Ã£o automÃ¡tica - turmas e cursos baseados no plano
                selectedClasses: selectedClasses || [], // Turmas selecionadas (incluÃ­das + avulsas)
                selectedCourses: selectedCourses || [], // Cursos selecionados (incluÃ­dos + avulsos)
                planBasedSelection: currentPlanData ? {
                    planId: document.getElementById('studentBillingPlan').value,
                    includedClasses: currentPlanData.availableClasses.map(cls => cls.id),
                    includedCourses: currentPlanData.availableCourses.map(course => course.id),
                    additionalClasses: selectedClasses.filter(id => 
                        !currentPlanData.availableClasses.some(cls => cls.id === id)
                    ),
                    additionalCourses: selectedCourses.filter(id => 
                        !currentPlanData.availableCourses.some(course => course.id === id)
                    )
                } : null
            };
            
            console.log('ðŸŽ¯ Adicionando aluno com vinculaÃ§Ã£o automÃ¡tica:', formData);
            
            // In a real app, make API call here
            fetch('/api/students', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = 'Aluno adicionado com sucesso!';
                    
                    // Incluir informaÃ§Ãµes sobre turmas e cursos selecionados
                    if (formData.selectedClasses.length > 0 || formData.selectedCourses.length > 0) {
                        message += `\n\nðŸŽ¯ VinculaÃ§Ã£o AutomÃ¡tica:`;
                        
                        if (formData.selectedClasses.length > 0) {
                            message += `\nâ€¢ ${formData.selectedClasses.length} turma(s) vinculada(s)`;
                        }
                        
                        if (formData.selectedCourses.length > 0) {
                            message += `\nâ€¢ ${formData.selectedCourses.length} curso(s) vinculado(s)`;
                        }
                        
                        if (formData.planBasedSelection) {
                            const { additionalClasses, additionalCourses } = formData.planBasedSelection;
                            if (additionalClasses.length > 0 || additionalCourses.length > 0) {
                                message += `\nâ€¢ ${additionalClasses.length + additionalCourses.length} item(ns) avulso(s) adicionado(s)`;
                            }
                        }
                    }
                    
                    // Check if intelligent enrollment was used
                    if (data.data && data.data.automaticEnrollment && data.data.automaticEnrollment.courseId) {
                        if (data.data.automaticEnrollment.subscriptionCreated) {
                            message += '\n\nâœ… MatrÃ­cula Inteligente:\nâ€¢ Curso selecionado automaticamente\nâ€¢ Plano de pagamento criado\nâ€¢ Assinatura ativada';
                        } else {
                            message += '\n\nâš ï¸ MatrÃ­cula Inteligente:\nâ€¢ Curso selecionado\nâ€¢ Plano criado (verificar assinatura)';
                        }
                    }
                    
                    showToast(message.replace(/\n/g, ' '), 'success');
                    closeModal('addStudentModal');
                    
                    // Limpar seleÃ§Ãµes apÃ³s sucesso
                    selectedClasses = [];
                    selectedCourses = [];
                    currentPlanData = null;
                    
                    // Reload students data
                    if (typeof loadStudents === 'function') {
                        loadStudents();
                    }
                } else {
                    showToast('Erro ao adicionar aluno: ' + (data.message || 'Erro desconhecido'), 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            });
        });
        
        document.getElementById('editStudentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const studentId = currentEditingStudentId;
            
            if (!studentId) {
                console.error('âŒ Student ID not found in form submission');
                showToast('âŒ Erro: ID do aluno nÃ£o encontrado', 'error');
                return;
            }
            
            const formData = {
                name: document.getElementById('editStudentName').value,
                email: document.getElementById('editStudentEmail').value,
                phone: document.getElementById('editStudentPhone').value,
                birthDate: document.getElementById('editStudentBirthDate').value,
                gender: document.getElementById('editStudentGender').value,
                category: document.getElementById('editStudentCategory').value,
                classId: document.getElementById('editStudentClass').value,
                financialResponsibleId: document.getElementById('editStudentFinancialResponsible').value || null
            };
            
            console.log('Editando aluno ID:', studentId, formData);
            
            // In a real app, make API call here
            fetch(`/api/students/${studentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Aluno atualizado com sucesso!');
                    closeModal('editStudentModal');
                    // Reload students data
                    loadData();
                } else {
                    alert('Erro ao atualizar aluno: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            });
        });
        
        // ========================================
        // COURSE MANAGEMENT FUNCTIONS
        // ========================================
        
        // Load courses data when navigating to course management
        function loadCourses() {
            console.log('ðŸ“š Carregando cursos...');
            
            fetch('/api/courses')
                .then(response => response.json())
                .then(data => {
                    if (data.success && Array.isArray(data.data)) {
                        updateCoursesTable(data.data);
                    } else {
                        // Show empty state
                        updateCoursesTable([]);
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar cursos:', error);
                    // Show empty state on error
                    updateCoursesTable([]);
                });
        }
        
        function updateCoursesTable(courses) {
            const tbody = document.getElementById('courses-table-body');
            
            if (courses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                            Nenhum curso cadastrado. Clique em "Novo Curso" para comeÃ§ar.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = courses.map(course => `
                <tr class="course-row" data-course-id="${course.id}" ondblclick="openCourseDetail('${course.id}')" style="cursor: pointer; transition: background-color 0.2s;">
                    <td>${course.name}</td>
                    <td>${course.category || 'NÃ£o informado'}</td>
                    <td>${course.level || 'BÃ¡sico'}</td>
                    <td>${course.totalClasses || 48}</td>
                    <td>${course.stats?.totalEnrollments || 0}</td>
                    <td>
                        <span class="status-badge ${course.isActive ? 'status-active' : 'status-inactive'}">
                            ${course.isActive ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); editCourse('${course.id}')">
                                âœï¸ Editar
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); deleteCourse('${course.id}')">
                                ðŸ—‘ï¸ Excluir
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Add hover effect to course rows
            document.querySelectorAll('.course-row').forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
        }
        
        // Course detail modal functions
        let currentCourseId = null;
        
        function openCourseDetail(courseId) {
            currentCourseId = courseId;
            document.getElementById('courseDetailModal').style.display = 'block';
            
            // Load course data
            fetch(`/api/courses/${courseId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayCourseDetail(data.data);
                    } else {
                        console.error('Erro ao carregar curso:', data.error);
                        showToast('Erro ao carregar dados do curso', 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar curso:', error);
                    showToast('Erro ao carregar dados do curso', 'error');
                });
        }
        
        function closeCourseDetail() {
            document.getElementById('courseDetailModal').style.display = 'none';
            currentCourseId = null;
        }
        
        function displayCourseDetail(course) {
            // Update modal title
            document.getElementById('courseDetailTitle').textContent = course.name || 'Detalhes do Curso';
            
            // Show overview tab by default
            switchCourseDetailTab('overview');
            loadCourseOverview(course);
        }
        
        function switchCourseDetailTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.modal-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = '#CBD5E1';
            });
            
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.background = 'linear-gradient(135deg, #3B82F6, #1D4ED8)';
                activeTab.style.color = 'white';
            }
            
            // Load tab content
            const contentDiv = document.getElementById('courseDetailContent');
            switch(tabName) {
                case 'overview':
                    loadCourseOverview(null);
                    break;
                case 'plans':
                    loadCoursePlans();
                    break;
                case 'classes':
                    loadCourseClasses();
                    break;
                case 'lessons':
                    loadCourseLessons();
                    break;
                case 'techniques':
                    loadCourseTechniques();
                    break;
                case 'students':
                    loadCourseStudents();
                    break;
                default:
                    contentDiv.innerHTML = '<p>ConteÃºdo nÃ£o encontrado</p>';
            }
        }
        
        function loadCourseOverview(course) {
            const contentDiv = document.getElementById('courseDetailContent');
            contentDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                    <div>
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ“š InformaÃ§Ãµes do Curso</h3>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                            <p><strong>Nome:</strong> ${course?.name || 'Krav Maga Faixa Branca - Defesa Pessoal 1'}</p>
                            <p><strong>Categoria:</strong> ${course?.category || 'Adulto'}</p>
                            <p><strong>NÃ­vel:</strong> ${course?.level || 'BÃ¡sico'}</p>
                            <p><strong>Total de Aulas:</strong> ${course?.totalClasses || 48}</p>
                            <p><strong>Status:</strong> ${course?.isActive ? 'Ativo' : 'Inativo'}</p>
                        </div>
                        
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ“Š EstatÃ­sticas</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; color: #10B981; margin-bottom: 0.5rem;">${course?.stats?.totalEnrollments || 0}</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">Alunos Matriculados</div>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; color: #F59E0B; margin-bottom: 0.5rem;">${course?.stats?.totalClasses || 2}</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">Turmas Ativas</div>
                            </div>
                            <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; color: #8B5CF6; margin-bottom: 0.5rem;">${course?.stats?.avgAttendance || 85}%</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">FrequÃªncia MÃ©dia</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">âš¡ AÃ§Ãµes RÃ¡pidas</h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <button class="btn btn-primary" onclick="editCourse(currentCourseId)" style="width: 100%; justify-content: flex-start;">
                                <span>âœï¸</span> Editar Curso
                            </button>
                            <button class="btn btn-secondary" onclick="duplicateCourse(currentCourseId)" style="width: 100%; justify-content: flex-start;">
                                <span>ðŸ“‹</span> Duplicar Curso
                            </button>
                            <button class="btn btn-success" onclick="exportCourse(currentCourseId)" style="width: 100%; justify-content: flex-start;">
                                <span>ðŸ“¤</span> Exportar Dados
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadCoursePlans() {
            const contentDiv = document.getElementById('courseDetailContent');
            contentDiv.innerHTML = `
                <div>
                    <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ’³ Planos de Pagamento Associados</h3>
                    <div id="coursePlansContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
                            <h4 style="color: #3B82F6; margin-bottom: 1rem;">Plano Mensal - Adulto</h4>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Valor:</strong> R$ 180,00</p>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Categoria:</strong> ADULT</p>
                            <p style="color: #CBD5E1; margin-bottom: 1rem;"><strong>Alunos:</strong> 4 matriculados</p>
                            <button class="btn btn-secondary btn-small" onclick="editPlan('plan-1')">
                                âœï¸ Editar Plano
                            </button>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <h4 style="color: #10B981; margin-bottom: 1rem;">Plano Mensal - Iniciante</h4>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Valor:</strong> R$ 120,00</p>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Categoria:</strong> INICIANTE1</p>
                            <p style="color: #CBD5E1; margin-bottom: 1rem;"><strong>Alunos:</strong> 2 matriculados</p>
                            <button class="btn btn-secondary btn-small" onclick="editPlan('plan-2')">
                                âœï¸ Editar Plano
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="createNewPlan(currentCourseId)">
                            <span>âž•</span> Criar Novo Plano
                        </button>
                    </div>
                </div>
            `;
        }
        
        function loadCourseClasses() {
            const contentDiv = document.getElementById('courseDetailContent');
            contentDiv.innerHTML = `
                <div>
                    <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ« Turmas do Curso</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(139, 92, 246, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.3);">
                            <h4 style="color: #8B5CF6; margin-bottom: 1rem;">Turma 1 - TerÃ§as e Quintas</h4>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>HorÃ¡rio:</strong> 18:00 - 19:00</p>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Capacidade:</strong> 8/20 alunos</p>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Instrutor:</strong> JoÃ£o Silva</p>
                            <p style="color: #CBD5E1; margin-bottom: 1rem;"><strong>Status:</strong> <span style="color: #10B981;">Ativa</span></p>
                            <button class="btn btn-secondary btn-small" onclick="viewClassDetails('class-1')">
                                ðŸ‘ï¸ Ver Detalhes
                            </button>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <h4 style="color: #10B981; margin-bottom: 1rem;">Turma 2 - Segundas e Quartas</h4>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>HorÃ¡rio:</strong> 19:00 - 20:00</p>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Capacidade:</strong> 5/20 alunos</p>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Instrutor:</strong> Maria Santos</p>
                            <p style="color: #CBD5E1; margin-bottom: 1rem;"><strong>Status:</strong> <span style="color: #10B981;">Ativa</span></p>
                            <button class="btn btn-secondary btn-small" onclick="viewClassDetails('class-2')">
                                ðŸ‘ï¸ Ver Detalhes
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="createNewClass(currentCourseId)">
                            <span>âž•</span> Criar Nova Turma
                        </button>
                    </div>
                </div>
            `;
        }
        
        function loadCourseLessons() {
            const contentDiv = document.getElementById('courseDetailContent');
            contentDiv.innerHTML = `
                <div>
                    <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ“‹ Planos de Aula</h3>
                    <div style="background: rgba(59, 130, 246, 0.05); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <p style="color: #CBD5E1; margin-bottom: 1rem;">Total: 48 aulas organizadas em 5 unidades pedagÃ³gicas</p>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; text-align: center;">
                            <div style="background: #10B981; padding: 0.5rem; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                                 onclick="showLessonsByUnit('fundamentos')" 
                                 onmouseover="this.style.borderColor='#059669'; this.style.transform='scale(1.05)';" 
                                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)';">
                                <div>ðŸ“š Fundamentos</div>
                                <div style="font-size: 0.75rem;">Aulas 1-10</div>
                            </div>
                            <div style="background: #3B82F6; padding: 0.5rem; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                                 onclick="showLessonsByUnit('golpes')" 
                                 onmouseover="this.style.borderColor='#1D4ED8'; this.style.transform='scale(1.05)';" 
                                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)';">
                                <div>ðŸ‘Š Golpes BÃ¡sicos</div>
                                <div style="font-size: 0.75rem;">Aulas 11-20</div>
                            </div>
                            <div style="background: #8B5CF6; padding: 0.5rem; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                                 onclick="showLessonsByUnit('defesas')" 
                                 onmouseover="this.style.borderColor='#7C3AED'; this.style.transform='scale(1.05)';" 
                                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)';">
                                <div>ðŸ›¡ï¸ Defesas BÃ¡sicas</div>
                                <div style="font-size: 0.75rem;">Aulas 21-30</div>
                            </div>
                            <div style="background: #F59E0B; padding: 0.5rem; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                                 onclick="showLessonsByUnit('avancadas')" 
                                 onmouseover="this.style.borderColor='#D97706'; this.style.transform='scale(1.05)';" 
                                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)';">
                                <div>âš”ï¸ Defesas AvanÃ§adas</div>
                                <div style="font-size: 0.75rem;">Aulas 31-40</div>
                            </div>
                            <div style="background: #EF4444; padding: 0.5rem; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                                 onclick="showLessonsByUnit('integracao')" 
                                 onmouseover="this.style.borderColor='#DC2626'; this.style.transform='scale(1.05)';" 
                                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)';">
                                <div>ðŸ”„ IntegraÃ§Ã£o</div>
                                <div style="font-size: 0.75rem;">Aulas 41-48</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEW: Enhanced Unit Navigation Bar -->
                    <div style="background: rgba(15, 23, 42, 0.8); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #334155;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                            <h4 style="color: #F8FAFC; margin: 0; font-size: 1rem; font-weight: 600;">ðŸŽ¯ NavegaÃ§Ã£o por Unidade</h4>
                            <div style="flex: 1; height: 1px; background: linear-gradient(90deg, #3B82F6, transparent);"></div>
                            <span id="current-unit-name" style="color: #10B981; font-weight: 600; font-size: 0.875rem;">Todas as Unidades</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;">
                            <button class="btn" onclick="showAllLessons()" 
                                    style="background: linear-gradient(135deg, #6B7280, #4B5563); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" 
                                    onmouseover="this.style.background='linear-gradient(135deg, #4B5563, #374151)'; this.style.transform='translateY(-2px)';" 
                                    onmouseout="this.style.background='linear-gradient(135deg, #6B7280, #4B5563)'; this.style.transform='translateY(0)';">
                                ðŸ“‹ Todas as Aulas
                            </button>
                            <button class="btn" onclick="showLessonsByUnit('fundamentos')" 
                                    style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" 
                                    onmouseover="this.style.background='linear-gradient(135deg, #059669, #047857)'; this.style.transform='translateY(-2px)';" 
                                    onmouseout="this.style.background='linear-gradient(135deg, #10B981, #059669)'; this.style.transform='translateY(0)';">
                                ðŸ“š Fundamentos
                            </button>
                            <button class="btn" onclick="showLessonsByUnit('golpes')" 
                                    style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" 
                                    onmouseover="this.style.background='linear-gradient(135deg, #1D4ED8, #1E40AF)'; this.style.transform='translateY(-2px)';" 
                                    onmouseout="this.style.background='linear-gradient(135deg, #3B82F6, #1D4ED8)'; this.style.transform='translateY(0)';">
                                ðŸ‘Š Golpes BÃ¡sicos
                            </button>
                            <button class="btn" onclick="showLessonsByUnit('defesas')" 
                                    style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" 
                                    onmouseover="this.style.background='linear-gradient(135deg, #7C3AED, #6D28D9)'; this.style.transform='translateY(-2px)';" 
                                    onmouseout="this.style.background='linear-gradient(135deg, #8B5CF6, #7C3AED)'; this.style.transform='translateY(0)';">
                                ðŸ›¡ï¸ Defesas BÃ¡sicas
                            </button>
                            <button class="btn" onclick="showLessonsByUnit('avancadas')" 
                                    style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" 
                                    onmouseover="this.style.background='linear-gradient(135deg, #D97706, #B45309)'; this.style.transform='translateY(-2px)';" 
                                    onmouseout="this.style.background='linear-gradient(135deg, #F59E0B, #D97706)'; this.style.transform='translateY(0)';">
                                âš”ï¸ Defesas AvanÃ§adas
                            </button>
                            <button class="btn" onclick="showLessonsByUnit('integracao')" 
                                    style="background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" 
                                    onmouseover="this.style.background='linear-gradient(135deg, #DC2626, #B91C1C)'; this.style.transform='translateY(-2px)';" 
                                    onmouseout="this.style.background='linear-gradient(135deg, #EF4444, #DC2626)'; this.style.transform='translateY(0)';">
                                ðŸ”„ IntegraÃ§Ã£o
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lesson Plans Table Container -->
                    <div id="lesson-plans-container" style="background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; border: 1px solid #334155;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="color: #F8FAFC; margin: 0; font-size: 1.125rem; font-weight: 600;">ðŸ“‹ Planos de Aula</h4>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="color: #10B981; font-size: 0.875rem; font-weight: 500;">âœ… Sistema habilitado</span>
                                <button class="btn btn-primary" onclick="manageLessonPlans(currentCourseId)" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    <span>âš™ï¸</span> Gerenciar
                                </button>
                                <button class="btn btn-secondary" onclick="exportLessonPlans(currentCourseId)" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    <span>ðŸ“¤</span> Exportar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Lesson Plans Table -->
                        <div style="background: rgba(30, 41, 59, 0.5); border-radius: 8px; overflow: hidden; border: 1px solid #475569;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: rgba(59, 130, 246, 0.1); border-bottom: 1px solid #475569;">
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Aula</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Semana</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">TÃ­tulo</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Unidade</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">TÃ©cnicas</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">DuraÃ§Ã£o</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.875rem;">NÃ­vel</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Status</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.875rem;">AÃ§Ãµes</th>
                                    </tr>
                                </thead>
                                <tbody id="lesson-plans-table-body">
                                    <tr>
                                        <td colspan="9" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸŽ¯</div>
                                            Clique em uma unidade acima para ver os planos de aula
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <div style="display: flex; gap: 1rem; align-items: center; justify-content: center;">
                            <button class="btn btn-primary" onclick="manageLessonPlans(currentCourseId)">
                                <span>âš™ï¸</span> Gerenciar Planos de Aula
                            </button>
                            <button class="btn btn-secondary" onclick="exportLessonPlans(currentCourseId)">
                                <span>ðŸ“¤</span> Exportar Planos
                            </button>
                            <button class="btn btn-secondary" onclick="showLessonPlanManager()">
                                <span>ðŸ”§</span> Modo AvanÃ§ado
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadCourseTechniques() {
            const contentDiv = document.getElementById('courseDetailContent');
            contentDiv.innerHTML = `
                <div>
                    <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ¥Š TÃ©cnicas do Curso</h3>
                    <div style="background: rgba(139, 92, 246, 0.05); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <p style="color: #CBD5E1; margin-bottom: 1rem;">Total: 42 tÃ©cnicas catalogadas</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #10B981; margin-bottom: 0.5rem;">Fundamentos</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">Posturas, movimentaÃ§Ã£o bÃ¡sica, distÃ¢ncia</p>
                            </div>
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #3B82F6; margin-bottom: 0.5rem;">Golpes BÃ¡sicos</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">Socos, chutes, joelhadas</p>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #F59E0B; margin-bottom: 0.5rem;">Defesas</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">Bloqueios, esquivas, contra-ataques</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="manageTechniques(currentCourseId)">
                            <span>âš™ï¸</span> Gerenciar TÃ©cnicas
                        </button>
                        <button class="btn btn-secondary" onclick="viewTechniquesLibrary(currentCourseId)">
                            <span>ðŸ“š</span> Biblioteca de TÃ©cnicas
                        </button>
                    </div>
                </div>
            `;
        }
        
        function loadCourseStudents() {
            const contentDiv = document.getElementById('courseDetailContent');
            contentDiv.innerHTML = `
                <div>
                    <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ‘¥ Alunos Matriculados</h3>
                    <div style="background: rgba(59, 130, 246, 0.05); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <p style="color: #CBD5E1; margin-bottom: 1rem;">Total: 4 alunos matriculados</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #10B981; margin-bottom: 0.5rem;">Maria Silva</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">MatrÃ­cula: KMA0001 â€¢ Turma 1 â€¢ 85% frequÃªncia</p>
                            </div>
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #3B82F6; margin-bottom: 0.5rem;">Pedro Costa</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">MatrÃ­cula: KMA0002 â€¢ Turma 2 â€¢ 90% frequÃªncia</p>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #F59E0B; margin-bottom: 0.5rem;">Ana Oliveira</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">MatrÃ­cula: KMA0003 â€¢ Turma 1 â€¢ 75% frequÃªncia</p>
                            </div>
                            <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #8B5CF6; margin-bottom: 0.5rem;">Carlos Rodrigues</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">MatrÃ­cula: KMA0004 â€¢ Turma 2 â€¢ 80% frequÃªncia</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="enrollNewStudent(currentCourseId)">
                            <span>âž•</span> Matricular Aluno
                        </button>
                        <button class="btn btn-secondary" onclick="viewStudentProgress(currentCourseId)">
                            <span>ðŸ“Š</span> Ver Progresso
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Helper functions for course management
        function editCourse(courseId) {
            console.log('Editando curso:', courseId);
            // TODO: Implement course editing
            showToast('FunÃ§Ã£o de ediÃ§Ã£o em desenvolvimento', 'info');
        }
        
        function deleteCourse(courseId) {
            if (confirm('Tem certeza que deseja excluir este curso?')) {
                console.log('Excluindo curso:', courseId);
                // TODO: Implement course deletion
                showToast('FunÃ§Ã£o de exclusÃ£o em desenvolvimento', 'info');
            }
        }
        
        function filterCourses() {
            const searchTerm = document.getElementById('courseSearch').value.toLowerCase();
            const rows = document.querySelectorAll('.course-row');
            
            rows.forEach(row => {
                const courseName = row.querySelector('td:first-child').textContent.toLowerCase();
                const courseCategory = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const courseLevel = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                
                if (courseName.includes(searchTerm) || courseCategory.includes(searchTerm) || courseLevel.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function refreshCourses() {
            loadCourses();
            showToast('Lista de cursos atualizada', 'success');
        }
        
        function exportCourses() {
            console.log('Exportando cursos');
            // TODO: Implement export functionality
            showToast('FunÃ§Ã£o de exportaÃ§Ã£o em desenvolvimento', 'info');
        }
        
        function openCourseModal() {
            console.log('Abrindo modal de novo curso');
            // TODO: Implement course creation modal
            showToast('Modal de criaÃ§Ã£o em desenvolvimento', 'info');
        }
        
        // Course modal functions
        function openAddCourseModal() {
            document.getElementById('addCourseModal').classList.add('active');
        }
        
        function editCourse(courseId) {
            // Load course data and open edit modal
            fetch(`/api/courses/${courseId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const course = data.data;
                        document.getElementById('editCourseId').value = course.id;
                        document.getElementById('editCourseName').value = course.name;
                        document.getElementById('editCourseDescription').value = course.description || '';
                        document.getElementById('editCourseCategory').value = course.category;
                        document.getElementById('editCourseLevel').value = course.level;
                        document.getElementById('editCourseTotalClasses').value = course.totalClasses;
                        document.getElementById('editCourseClassesPerWeek').value = course.classesPerWeek;
                        
                        document.getElementById('editCourseModal').classList.add('active');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao carregar dados do curso');
                });
        }
        
        // Lesson plans functions
        function showLessonPlans(courseId, courseName) {
            document.getElementById('current-course-name').textContent = courseName;
            document.getElementById('lesson-plans-section').style.display = 'block';
            
            // Load lesson plans
            fetch(`/api/courses-management/${courseId}/lesson-plans`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateLessonPlansTable(data.data, courseId);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
        }
        
        function hideLessonPlans() {
            document.getElementById('lesson-plans-section').style.display = 'none';
        }
        
        function updateLessonPlansTable(lessonPlans, courseId) {
            const tbody = document.getElementById('lesson-plans-table-body');
            
            if (lessonPlans.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                            Nenhum plano de aula criado. 
                            <button class="btn btn-primary btn-small" onclick="openLessonPlanModal('${courseId}', 1)">
                                Criar Primeira Aula
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = lessonPlans.map(plan => `
                <tr>
                    <td>${plan.lessonNumber}</td>
                    <td>${plan.title}</td>
                    <td>${plan.duration} min</td>
                    <td>${plan.difficulty}</td>
                    <td>
                        <button class="btn btn-secondary btn-small" onclick="openFeedbackModal('${courseId}', ${plan.lessonNumber})">
                            ðŸ’¬ Feedback
                        </button>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-small" onclick="openLessonPlanModal('${courseId}', ${plan.lessonNumber})">
                                âœï¸ Editar
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function openLessonPlanModal(courseId, lessonNumber) {
            document.getElementById('lessonCourseId').value = courseId;
            document.getElementById('lessonNumber').value = lessonNumber;
            
            // If editing existing lesson plan, load data
            if (lessonNumber > 1) {
                // Load existing lesson plan data (simplified for demo)
                document.getElementById('lessonTitle').value = `Aula ${lessonNumber}`;
            } else {
                // Clear form for new lesson
                document.getElementById('lessonPlanForm').reset();
                document.getElementById('lessonCourseId').value = courseId;
                document.getElementById('lessonNumber').value = lessonNumber;
            }
            
            document.getElementById('lessonPlanModal').classList.add('active');
        }
        
        function openFeedbackModal(courseId, lessonNumber) {
            document.getElementById('feedbackCourseId').value = courseId;
            document.getElementById('feedbackLessonNumber').value = lessonNumber;
            document.getElementById('lessonFeedbackModal').classList.add('active');
        }
        
        // Form submissions
        document.getElementById('addCourseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('courseName').value,
                description: document.getElementById('courseDescription').value,
                category: document.getElementById('courseCategory').value,
                level: document.getElementById('courseLevel').value,
                totalClasses: document.getElementById('courseTotalClasses').value,
                classesPerWeek: document.getElementById('courseClassesPerWeek').value,
                duration: document.getElementById('courseDuration').value,
                minAge: document.getElementById('courseMinAge').value,
                maxAge: document.getElementById('courseMaxAge').value,
                objectives: document.getElementById('courseObjectives').value.split('\\n').filter(obj => obj.trim()),
                requirements: document.getElementById('courseRequirements').value.split('\\n').filter(req => req.trim())
            };
            
            fetch('/api/courses-management', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Curso criado com sucesso!');
                    closeModal('addCourseModal');
                    loadCourses();
                } else {
                    alert('Erro ao criar curso: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            });
        });
        
        document.getElementById('editCourseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const courseId = document.getElementById('editCourseId').value;
            const formData = {
                name: document.getElementById('editCourseName').value,
                description: document.getElementById('editCourseDescription').value,
                category: document.getElementById('editCourseCategory').value,
                level: document.getElementById('editCourseLevel').value,
                totalClasses: document.getElementById('editCourseTotalClasses').value,
                classesPerWeek: document.getElementById('editCourseClassesPerWeek').value
            };
            
            fetch(`/api/courses-management/${courseId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Curso atualizado com sucesso!');
                    closeModal('editCourseModal');
                    loadCourses();
                } else {
                    alert('Erro ao atualizar curso: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            });
        });
        
        document.getElementById('lessonPlanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const courseId = document.getElementById('lessonCourseId').value;
            const formData = {
                lessonNumber: document.getElementById('lessonNumber').value,
                title: document.getElementById('lessonTitle').value,
                objectives: document.getElementById('lessonObjectives').value.split('\\n').filter(obj => obj.trim()),
                warmUp: document.getElementById('lessonWarmUp').value,
                mainContent: document.getElementById('lessonMainContent').value,
                coolDown: document.getElementById('lessonCoolDown').value,
                equipment: document.getElementById('lessonEquipment').value.split(',').map(eq => eq.trim()).filter(eq => eq),
                duration: document.getElementById('lessonDuration').value,
                difficulty: document.getElementById('lessonDifficulty').value,
                adaptations: document.getElementById('lessonAdaptations').value,
                notes: document.getElementById('lessonNotes').value
            };
            
            fetch(`/api/courses-management/${courseId}/lesson-plans`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Plano de aula salvo com sucesso!');
                    closeModal('lessonPlanModal');
                    // Reload lesson plans
                    showLessonPlans(courseId, document.getElementById('current-course-name').textContent);
                } else {
                    alert('Erro ao salvar plano: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            });
        });
        
        document.getElementById('lessonFeedbackForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                courseId: document.getElementById('feedbackCourseId').value,
                lessonNumber: document.getElementById('feedbackLessonNumber').value,
                feedback: document.getElementById('feedbackGeneral').value,
                studentsPresent: document.getElementById('feedbackStudentsPresent').value,
                improvements: document.getElementById('feedbackImprovements').value,
                nextClassAdjustments: document.getElementById('feedbackImprovements').value
            };
            
            fetch('/api/lesson-feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Feedback registrado com sucesso!');
                    closeModal('lessonFeedbackModal');
                } else {
                    alert('Erro ao registrar feedback: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            });
        });
        
        // ==========================================
        // STUDENTS MANAGEMENT FUNCTIONS
        // ==========================================
        
        // ==========================================
        // SISTEMA DE ASSOCIAÃ‡Ã•ES HIERÃRQUICAS
        // ==========================================
        
        async function loadStudentWithAssociations(studentId) {
            console.log('ðŸ”„ Carregando aluno com associaÃ§Ãµes:', studentId);
            
            try {
                // Buscar dados do aluno, matrÃ­culas e assinaturas em paralelo
                const [studentResponse, enrollmentsResponse, subscriptionsResponse] = await Promise.all([
                    fetch(`/api/students/${studentId}`),
                    fetch(`/api/students/${studentId}/enrollments`),
                    fetch(`/api/students/${studentId}/subscriptions`)
                ]);
                
                const studentData = await studentResponse.json();
                const enrollmentsData = await enrollmentsResponse.json();
                const subscriptionsData = await subscriptionsResponse.json();
                
                if (!studentData.success) {
                    throw new Error(studentData.message || 'Erro ao carregar dados do aluno');
                }
                
                // Buscar dados complementares
                const [classesResponse, coursesResponse, plansResponse] = await Promise.all([
                    fetch('/api/classes'),
                    fetch('/api/courses'),
                    fetch('/api/billing-plans')
                ]);
                
                const classesData = await classesResponse.json();
                const coursesData = await coursesResponse.json();
                const plansData = await plansResponse.json();
                
                // Processar associaÃ§Ãµes
                const associations = processStudentAssociations(
                    studentData.data,
                    enrollmentsData.success ? enrollmentsData.data : [],
                    subscriptionsData.success ? subscriptionsData.data : [],
                    classesData.success ? classesData.data : [],
                    coursesData.success ? coursesData.data : [],
                    plansData.success ? plansData.data : []
                );
                
                console.log('âœ… AssociaÃ§Ãµes processadas:', associations);
                
                return {
                    student: studentData.data,
                    associations: associations
                };
                
            } catch (error) {
                console.error('âŒ Erro ao carregar aluno com associaÃ§Ãµes:', error);
                return null;
            }
        }
        
        function processStudentAssociations(student, enrollments, subscriptions, allClasses, allCourses, allPlans) {
            console.log('ðŸ”„ Processando associaÃ§Ãµes do aluno...');
            
            const associations = {
                plans: [],
                courses: [],
                classes: [],
                hierarchy: []
            };
            
            // Processar assinaturas de planos
            subscriptions.forEach(subscription => {
                if (subscription.plan || subscription.billingPlan) {
                    const plan = subscription.plan || subscription.billingPlan;
                    associations.plans.push({
                        subscription: subscription,
                        plan: plan
                    });
                }
            });
            
            // Processar matrÃ­culas
            enrollments.forEach(enrollment => {
                if (enrollment.course) {
                    associations.courses.push({
                        enrollment: enrollment,
                        course: enrollment.course
                    });
                }
                
                if (enrollment.class) {
                    associations.classes.push({
                        enrollment: enrollment,
                        class: enrollment.class
                    });
                }
            });
            
            // Criar hierarquia
            associations.plans.forEach(planAssoc => {
                const planHierarchy = {
                    plan: planAssoc.plan,
                    subscription: planAssoc.subscription,
                    courses: [],
                    directClasses: []
                };
                
                // Encontrar cursos relacionados ao plano
                associations.courses.forEach(courseAssoc => {
                    const course = courseAssoc.course;
                    if (course.category === planAssoc.plan.category || 
                        course.level === planAssoc.plan.level ||
                        course.planId === planAssoc.plan.id ||
                        course.id === planAssoc.plan.courseId) {
                        
                        const courseInPlan = {
                            course: course,
                            enrollment: courseAssoc.enrollment,
                            classes: []
                        };
                        
                        // Encontrar turmas do curso
                        associations.classes.forEach(classAssoc => {
                            if (classAssoc.class.courseId === course.id) {
                                courseInPlan.classes.push({
                                    class: classAssoc.class,
                                    enrollment: classAssoc.enrollment
                                });
                            }
                        });
                        
                        planHierarchy.courses.push(courseInPlan);
                    }
                });
                
                // Verificar se o plano tem um courseId direto que ainda nÃ£o foi adicionado
                if (planAssoc.plan.courseId && allCourses && allCourses.length > 0) {
                    const planCourse = allCourses.find(course => course.id === planAssoc.plan.courseId);
                    if (planCourse) {
                        // Verificar se o curso jÃ¡ foi adicionado
                        const courseAlreadyAdded = planHierarchy.courses.some(courseInPlan => 
                            courseInPlan.course.id === planCourse.id
                        );
                        
                        if (!courseAlreadyAdded) {
                            console.log('ðŸŽ“ Adicionando curso direto do plano:', planCourse.name);
                            const courseInPlan = {
                                course: planCourse,
                                enrollment: null, // Sem matrÃ­cula ainda
                                classes: []
                            };
                            
                            // Encontrar turmas do curso
                            associations.classes.forEach(classAssoc => {
                                if (classAssoc.class.courseId === planCourse.id) {
                                    courseInPlan.classes.push({
                                        class: classAssoc.class,
                                        enrollment: classAssoc.enrollment
                                    });
                                }
                            });
                            
                            planHierarchy.courses.push(courseInPlan);
                        }
                    }
                }
                
                // Encontrar turmas diretas do plano (sem curso)
                associations.classes.forEach(classAssoc => {
                    const isInCourse = planHierarchy.courses.some(courseInPlan => 
                        courseInPlan.classes.some(c => c.class.id === classAssoc.class.id)
                    );
                    
                    if (!isInCourse && (
                        classAssoc.class.category === planAssoc.plan.category || 
                        classAssoc.class.level === planAssoc.plan.level ||
                        classAssoc.class.planId === planAssoc.plan.id
                    )) {
                        planHierarchy.directClasses.push({
                            class: classAssoc.class,
                            enrollment: classAssoc.enrollment
                        });
                    }
                });
                
                associations.hierarchy.push(planHierarchy);
            });
            
            // Se nÃ£o hÃ¡ planos, criar uma estrutura bÃ¡sica
            if (associations.hierarchy.length === 0 && (associations.courses.length > 0 || associations.classes.length > 0)) {
                associations.hierarchy.push({
                    plan: { name: 'Sem Plano Definido', category: 'Geral' },
                    subscription: null,
                    courses: associations.courses.map(courseAssoc => ({
                        course: courseAssoc.course,
                        enrollment: courseAssoc.enrollment,
                        classes: associations.classes.filter(classAssoc => 
                            classAssoc.class.courseId === courseAssoc.course.id
                        )
                    })),
                    directClasses: associations.classes.filter(classAssoc => 
                        !associations.courses.some(courseAssoc => 
                            courseAssoc.course.id === classAssoc.class.courseId
                        )
                    )
                });
            }
            
            console.log('âœ… AssociaÃ§Ãµes processadas:', associations);
            return associations;
        }
        
        function renderStudentClassesWithHierarchy(associations) {
            console.log('ðŸŽ¨ Renderizando turmas com hierarquia...');
            
            const classesTab = document.getElementById('student-classes-content');
            if (!classesTab) {
                console.error('âŒ Elemento student-classes-content nÃ£o encontrado');
                return;
            }
            
            if (!associations || associations.hierarchy.length === 0) {
                classesTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“‹</div>
                        <p>Nenhuma turma encontrada para este aluno</p>
                        <button onclick="loadStudentClassesTab()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ðŸ”„ Recarregar
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 1.5rem; padding: 1rem;">';
            
            associations.hierarchy.forEach((planHierarchy, planIndex) => {
                const plan = planHierarchy.plan;
                const subscription = planHierarchy.subscription;
                
                // Contar total de turmas neste plano
                const totalClasses = planHierarchy.courses.reduce((total, course) => 
                    total + course.classes.length, 0
                ) + planHierarchy.directClasses.length;
                
                html += `
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05)); border: 1px solid #10B981; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(16, 185, 129, 0.3);">
                            <div>
                                <h4 style="color: #10B981; margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                                    ðŸ’Ž ${plan.name}
                                </h4>
                                <p style="color: #94A3B8; margin: 0.25rem 0; font-size: 0.9rem;">
                                    ${plan.price ? `R$ ${parseFloat(plan.price).toFixed(2)}/mÃªs` : 'PreÃ§o nÃ£o definido'} â€¢ 
                                    ${plan.category || 'Categoria nÃ£o definida'} â€¢ 
                                    ${subscription ? subscription.status : 'Status nÃ£o definido'}
                                </p>
                            </div>
                            <div style="text-align: right; color: #10B981; font-size: 0.8rem;">
                                <div>${planHierarchy.courses.length} curso(s)</div>
                                <div>${totalClasses} turma(s)</div>
                            </div>
                        </div>
                `;
                
                // Renderizar cursos e suas turmas
                planHierarchy.courses.forEach(courseInPlan => {
                    const course = courseInPlan.course;
                    html += `
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; border-radius: 8px; padding: 1rem; margin: 0.5rem 0;">
                            <h5 style="color: #3B82F6; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                ðŸ“š ${course.name}
                            </h5>
                            <p style="color: #E5E7EB; margin: 0 0 1rem 0; font-size: 0.9rem;">${course.description || ''}</p>
                    `;
                    
                    // Renderizar turmas do curso
                    courseInPlan.classes.forEach(classInCourse => {
                        const classData = classInCourse.class;
                        html += `
                            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid #475569; border-radius: 6px; padding: 0.75rem; margin: 0.25rem 0; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #E5E7EB; font-weight: 500;">ðŸ• ${classData.name}</div>
                                    <div style="color: #9CA3AF; font-size: 0.8rem; margin-top: 0.25rem;">
                                        ðŸ“… ${classData.schedule || 'HorÃ¡rio flexÃ­vel'}
                                        ${classData.capacity ? ` â€¢ ðŸ‘¥ ${classData.capacity} vagas` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="quickCheckinToClass('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #10B981; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        âœ… Check-in
                                    </button>
                                    <button onclick="viewClassDetails('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        ðŸ‘ï¸ Detalhes
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                });
                
                // Renderizar turmas diretas do plano
                if (planHierarchy.directClasses.length > 0) {
                    html += `
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #F59E0B; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                            <h5 style="color: #F59E0B; margin: 0 0 0.75rem 0;">ðŸŽ¯ Turmas Diretas do Plano</h5>
                    `;
                    
                    planHierarchy.directClasses.forEach(directClass => {
                        const classData = directClass.class;
                        html += `
                            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid #475569; border-radius: 6px; padding: 0.75rem; margin: 0.25rem 0; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #E5E7EB; font-weight: 500;">ðŸ• ${classData.name}</div>
                                    <div style="color: #9CA3AF; font-size: 0.8rem; margin-top: 0.25rem;">
                                        ðŸ“… ${classData.schedule || 'HorÃ¡rio flexÃ­vel'}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="quickCheckinToClass('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #10B981; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        âœ… Check-in
                                    </button>
                                    <button onclick="viewClassDetails('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        ðŸ‘ï¸ Detalhes
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
                
                html += `</div>`;
            });
            
            html += '</div>';
            classesTab.innerHTML = html;
        }
        
        function renderStudentCoursesWithHierarchy_OLD(associations) {
            console.log('ðŸŽ¨ [OLD] Renderizando cursos com hierarquia...');
            console.log('ðŸ” [OLD] Debug associations recebidas:', associations);
            
            const coursesTab = document.getElementById('student-courses-content');
            if (!coursesTab) {
                console.error('âŒ [OLD] Elemento student-courses-content nÃ£o encontrado');
                return;
            }
            
            if (!associations || associations.hierarchy.length === 0) {
                coursesTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“š</div>
                        <p>Nenhum curso encontrado para este aluno</p>
                        <button onclick="loadStudentCoursesTab()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ðŸ”„ Recarregar
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 1.5rem; padding: 1rem;">';
            
            associations.hierarchy.forEach((planHierarchy, planIndex) => {
                const plan = planHierarchy.plan;
                const subscription = planHierarchy.subscription;
                
                if (planHierarchy.courses.length === 0) return;
                
                html += `
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.05)); border: 1px solid #3B82F6; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(59, 130, 246, 0.3);">
                            <div>
                                <h4 style="color: #3B82F6; margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                                    ðŸ’Ž ${plan.name}
                                </h4>
                                <p style="color: #94A3B8; margin: 0.25rem 0; font-size: 0.9rem;">
                                    ${plan.price ? `R$ ${parseFloat(plan.price).toFixed(2)}/mÃªs` : 'PreÃ§o nÃ£o definido'} â€¢ 
                                    ${plan.category || 'Categoria nÃ£o definida'}
                                </p>
                            </div>
                            <div style="text-align: right; color: #3B82F6; font-size: 0.8rem;">
                                <div>${planHierarchy.courses.length} curso(s)</div>
                            </div>
                        </div>
                `;
                
                // Renderizar cursos
                planHierarchy.courses.forEach(courseInPlan => {
                    const course = courseInPlan.course;
                    const enrollment = courseInPlan.enrollment;
                    
                    html += `
                        <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid #475569; border-radius: 8px; padding: 1rem; margin: 0.5rem 0; display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <h5 style="color: #E5E7EB; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    ðŸ“š ${course.name}
                                </h5>
                                <p style="color: #9CA3AF; margin: 0 0 0.5rem 0; font-size: 0.85rem;">${course.description || ''}</p>
                                <div style="color: #94A3B8; font-size: 0.75rem;">
                                    Status: ${enrollment.status} â€¢ 
                                    MatrÃ­cula: ${new Date(enrollment.enrollmentDate).toLocaleDateString('pt-BR')} â€¢
                                    ${courseInPlan.classes.length} turma(s)
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-left: 1rem;">
                                <button onclick="viewCourseProgress('${course.id}')" style="padding: 0.25rem 0.5rem; background: #10B981; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; white-space: nowrap;">
                                    ðŸ“Š Progresso
                                </button>
                                <button onclick="viewCourseDetails('${course.id}')" style="padding: 0.25rem 0.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; white-space: nowrap;">
                                    ðŸ‘ï¸ Detalhes
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            html += '</div>';
            coursesTab.innerHTML = html;
        }
        
        // FunÃ§Ãµes auxiliares para os botÃµes de aÃ§Ã£o
        function quickCheckinToClass(classId) {
            console.log('âš¡ Check-in rÃ¡pido para turma:', classId);
            alert('ðŸš§ Funcionalidade em desenvolvimento\n\nâœ… Check-in para turma: ' + classId);
        }
        
        function viewClassDetails(classId) {
            console.log('ðŸ‘ï¸ Visualizar detalhes da turma:', classId);
            alert('ðŸš§ Funcionalidade em desenvolvimento\n\nðŸ‘ï¸ Detalhes da turma: ' + classId);
        }
        
        function viewCourseProgress(courseId) {
            console.log('ðŸ“Š Visualizar progresso do curso:', courseId);
            alert('ðŸš§ Funcionalidade em desenvolvimento\n\nðŸ“Š Progresso do curso: ' + courseId);
        }
        
        function viewCourseDetails(courseId) {
            console.log('ðŸ‘ï¸ Visualizar detalhes do curso:', courseId);
            alert('ðŸš§ Funcionalidade em desenvolvimento\n\nðŸ‘ï¸ Detalhes do curso: ' + courseId);
        }

        // ==========================================
        
        // Global students data storage
        let allStudents = [];
        let filteredStudents = [];
        let currentView = 'table'; // 'table' or 'grid'
        
        // Make allStudents globally accessible
        window.allStudents = allStudents;

        // Generate simple matricula
        function generateMatricula(studentId, index) {
            // Simple format: just the index number (1, 2, 3, etc.)
            return index ? index.toString() : '1';
        }

        // Enhanced student loading with matricula generation
        async function loadStudents() {
            console.log('ðŸ‘¥ Carregando estudantes...');
            
            // Show loading state (safe version)
            try {
                showStudentsLoadingState();
            } catch (e) {
                console.log('âš ï¸ showStudentsLoadingState failed:', e);
            }
            
            try {
                const response = await fetch('/api/students');
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log(`âœ… ${data.data.length} estudantes carregados`);
                    
                    // Use students data directly (API already provides matricula)
                    allStudents = data.data;
                    window.allStudents = allStudents; // Keep window reference updated
                    filteredStudents = [...allStudents];
                    updateStudentsStats();
                    
                    // Use the improved complete loading function from students.js
                    if (window.loadAndRenderStudents) {
                        console.log('ðŸš€ Using complete loadAndRenderStudents from students.js');
                        window.loadAndRenderStudents();
                    } else if (window.renderStudentsTable && window.renderStudentsGrid) {
                        console.log('ðŸŽ¨ Using improved rendering functions from students.js');
                        window.renderStudentsTable(allStudents);
                        window.renderStudentsGrid(allStudents);
                    } else {
                        console.log('âš ï¸ Falling back to legacy updateStudentsDisplay');
                        updateStudentsDisplay();
                    }
                    
                    // Event delegation is now handled within updateStudentsDisplay
                } else {
                    console.error('âŒ Erro ao carregar estudantes:', data.message || 'Resposta sem dados');
                    console.error('âŒ Resposta completa:', data);
                    allStudents = [];
                    window.allStudents = allStudents; // Keep window reference updated
                    filteredStudents = [];
                    showStudentsEmptyState();
                }
            } catch (error) {
                console.error('âŒ Erro de conexÃ£o ao carregar estudantes:', error);
                allStudents = [];
                window.allStudents = allStudents; // Keep window reference updated
                filteredStudents = [];
                showStudentsEmptyState();
            }
            
            // Event delegation is handled within updateStudentsDisplay when needed
        }

        // Switch between table and grid view
        function switchView(viewType) {
            currentView = viewType;
            
            // Update button states
            document.getElementById('tableViewBtn').classList.toggle('active', viewType === 'table');
            document.getElementById('gridViewBtn').classList.toggle('active', viewType === 'grid');
            
            // Show/hide views
            document.getElementById('studentsTableView').style.display = viewType === 'table' ? 'block' : 'none';
            document.getElementById('studentsGrid').style.display = viewType === 'grid' ? 'grid' : 'none';
            
            // Update display
            updateStudentsDisplay();
        }

        // Enhanced search that works with CPF, name, matricula and email
        function filterStudentsSimple() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredStudents = [...allStudents];
            } else {
                filteredStudents = allStudents.filter(student => {
                    const user = student.user || {};
                    const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                    const email = (user.email || '').toLowerCase();
                    const cpf = (user.cpf || '').replace(/\D/g, ''); // Remove non-digits
                    const matricula = (student.matricula || '').toLowerCase();
                    const searchCpf = searchTerm.replace(/\D/g, ''); // Remove non-digits from search
                    
                    return (
                        fullName.includes(searchTerm) ||
                        email.includes(searchTerm) ||
                        matricula.includes(searchTerm) ||
                        (searchCpf && cpf.includes(searchCpf))
                    );
                });
            }
            
            updateStudentsDisplay();
        }

        // Update students display based on current view
        function updateStudentsDisplay() {
            if (currentView === 'table') {
                updateStudentsTable();
                // Setup event delegation only if needed (check done inside function)
                setupStudentTableEventDelegation();
            } else {
                updateStudentsGrid();
            }
        }

        // ========================================
        // STUDENT TABLE EVENT DELEGATION SYSTEM
        // ========================================
        
        // Set up permanent event delegation for student table
        function setupStudentTableEventDelegation() {
            const tableBody = document.getElementById('studentsTableBody');
            if (!tableBody) {
                console.warn('ðŸš¨ Student table body not found for event delegation setup');
                return;
            }
            
            // Check if already set up to avoid duplicates
            if (tableBody.hasAttribute('data-delegation-setup')) {
                return; // Already set up, skip
            }
            
            // Remove existing listeners to prevent duplicates
            tableBody.removeEventListener('click', handleStudentTableClick);
            tableBody.removeEventListener('dblclick', handleStudentTableDoubleClick);
            
            // Add event listeners with delegation
            tableBody.addEventListener('click', handleStudentTableClick);
            tableBody.addEventListener('dblclick', handleStudentTableDoubleClick);
            
            // Mark as set up
            tableBody.setAttribute('data-delegation-setup', 'true');
            
            console.log('âœ… Student table event delegation setup complete');
        }
        
        // Handle all clicks in student table
        function handleStudentTableClick(event) {
            const target = event.target;
            const studentRow = target.closest('tr.student-table-row');
            
            if (!studentRow) return;
            
            // Handle action buttons
            if (target.dataset.action === 'checkin') {
                event.stopPropagation();
                quickCheckinFixed(target.dataset.studentId);
                return;
            }
            
            if (target.dataset.action === 'edit') {
                event.stopPropagation();
                openStudentEditPage(target.dataset.studentId);
                return;
            }
            
            // Handle row click (but not on action buttons)
            if (!target.closest('.actions-cell')) {
                // Single click on row - could add selection here if needed
                studentRow.classList.add('row-selected');
                setTimeout(() => {
                    studentRow.classList.remove('row-selected');
                }, 200);
            }
        }
        
        // Handle double-clicks in student table
        function handleStudentTableDoubleClick(event) {
            const target = event.target;
            const studentRow = target.closest('tr.student-table-row');
            
            if (!studentRow) return;
            
            // Don't trigger on action buttons
            if (target.closest('.actions-cell')) return;
            
            event.preventDefault();
            event.stopPropagation();
            
            const studentId = studentRow.dataset.studentId;
            if (studentId) {
                console.log('ðŸ–±ï¸ Double-click detected for student:', studentId);
                openStudentEditPage(studentId);
            }
        }
        
        // Fixed quick check-in function (prevents conflicts)
        function quickCheckinFixed(studentId) {
            if (!studentId) {
                console.error('âŒ Student ID not provided for check-in');
                return;
            }
            
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                alert('âŒ Aluno nÃ£o encontrado!');
                return;
            }
            
            const user = student.user || {};
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
            const matricula = student.matricula || generateMatricula(student.id, 1);
            
            // Show confirmation
            const confirmed = confirm(`âœ… Confirmar check-in para:\n\nðŸ“‹ MatrÃ­cula: ${matricula}\nðŸ‘¤ Nome: ${fullName}\n\nProsseguir?`);
            
            if (confirmed) {
                console.log('âœ… Quick check-in confirmed for:', fullName);
                alert(`âœ… Check-in realizado com sucesso!\n\nðŸ‘¤ ${fullName}\nðŸ“‹ ${matricula}\nâ° ${new Date().toLocaleTimeString()}`);
                
                // Here you would implement the actual check-in API call
                // For now, just show success feedback
            }
        }

        // Update table view with event delegation
        function updateStudentsTable() {
            const tableBody = document.getElementById('studentsTableBody');
            const tableView = document.getElementById('studentsTableView');
            const loadingState = document.getElementById('studentsLoadingState');
            const emptyState = document.getElementById('studentsEmptyState');
            
            if (filteredStudents.length === 0) {
                tableView.style.display = 'none';
                loadingState.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            loadingState.style.display = 'none';
            emptyState.style.display = 'none';
            tableView.style.display = 'block';
            
            tableBody.innerHTML = filteredStudents.map(student => {
                const user = student.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                const email = user.email || 'N/A';
                const cpf = user.cpf || 'N/A';
                const formattedCpf = cpf !== 'N/A' ? formatCPF(cpf) : 'N/A';
                const category = student.category || 'ADULT';
                const status = student.isActive ? 'Ativo' : 'Inativo';
                const statusClass = student.isActive ? 'success' : 'inactive';
                const matricula = student.matricula || generateMatricula(student.id, 1);
                const financialResponsible = student.financialResponsible;
                const responsibleDisplay = financialResponsible 
                    ? `<div class="responsible-name">${financialResponsible.name}</div><div class="responsible-type">${financialResponsible.relationshipType || 'NÃ£o informado'}</div>`
                    : '<span style="color: #94A3B8;">PrÃ³prio aluno</span>';
                
                return `
                    <tr class="student-table-row" data-student-id="${student.id}" style="cursor: pointer; position: relative;">
                        <td>
                            <span class="student-matricula">${matricula}</span>
                        </td>
                        <td class="student-name-cell">
                            <div class="student-name">${fullName}</div>
                            <div class="student-email">${email}</div>
                        </td>
                        <td>
                            <span class="student-cpf">${formattedCpf}</span>
                        </td>
                        <td>${category}</td>
                        <td class="responsible-cell">
                            ${responsibleDisplay}
                        </td>
                        <td>
                            <span class="badge ${statusClass}">${status}</span>
                        </td>
                        <td class="actions-cell">
                            <button class="action-btn checkin" data-action="checkin" data-student-id="${student.id}" title="Check-in RÃ¡pido">
                                âœ… Check-in
                            </button>
                            <button class="action-btn edit" data-action="edit" data-student-id="${student.id}" title="Editar Aluno">
                                âœï¸ Editar
                            </button>
                            <div class="table-click-hint" style="position: absolute; bottom: 4px; right: 4px; font-size: 0.65rem; color: #10B981; opacity: 0; transition: opacity 0.3s ease; background: rgba(16, 185, 129, 0.1); padding: 0.2rem 0.4rem; border-radius: 4px; border: 1px solid rgba(16, 185, 129, 0.3); pointer-events: none; white-space: nowrap;">
                                ðŸ“ Editar aluno
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Setup event delegation after updating table
            setTimeout(() => {
                setupStudentTableEventDelegation();
            }, 50);
        }

        // Format CPF for display
        function formatCPF(cpf) {
            if (!cpf || cpf === 'N/A') return 'N/A';
            
            // Remove all non-digits
            const cleanCpf = cpf.replace(/\D/g, '');
            
            // Format as XXX.XXX.XXX-XX
            if (cleanCpf.length === 11) {
                return cleanCpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }
            
            return cpf; // Return original if not 11 digits
        }

        // Quick check-in function - COMMENTED OUT TO PREVENT CONFLICTS
        // Use quickCheckinFixed instead
        function quickCheckin_DEPRECATED(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                alert('Aluno nÃ£o encontrado!');
                return;
            }
            
            const user = student.user || {};
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
            const matricula = student.matricula || generateMatricula(student.id, 1);
            
            // Show confirmation
            const confirmed = confirm(`Confirmar check-in para:\n\nMatrÃ­cula: ${matricula}\nNome: ${fullName}\n\nProsseguir?`);
            
            if (confirmed) {
                // Here you would call the check-in API
                console.log('ðŸŽ¯ Check-in confirmado para:', fullName, `(${matricula})`);
                
                // Show success feedback
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ… Feito!';
                btn.style.background = '#10B981';
                btn.style.color = 'white';
                btn.disabled = true;
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    btn.style.color = '#10B981';
                    btn.disabled = false;
                }, 2000);
                
                // You can add actual API call here:
                // performCheckin(studentId);
            }
        }

        // Legacy function for grid view compatibility
        function filterStudents() {
            filterStudentsSimple();
        }

        // ==========================================
        // QUICK CHECK-IN FUNCTIONS
        // ==========================================

        let checkinResults = [];

        // Search for check-in with smart matching
        function searchForCheckin() {
            const searchTerm = document.getElementById('checkinSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                checkinResults = [];
                updateCheckinTable();
                return;
            }

            // Minimum 2 characters to search
            if (searchTerm.length < 2) {
                checkinResults = [];
                updateCheckinTable();
                return;
            }

            checkinResults = allStudents.filter(student => {
                const user = student.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                const email = (user.email || '').toLowerCase();
                const cpf = (user.cpf || '').replace(/\D/g, '');
                const matricula = (student.matricula || '').toLowerCase();
                const searchCpf = searchTerm.replace(/\D/g, '');
                
                return (
                    fullName.includes(searchTerm) ||
                    email.includes(searchTerm) ||
                    matricula.includes(searchTerm) ||
                    (searchCpf && cpf.includes(searchCpf))
                );
            }).slice(0, 10); // Limit to 10 results for performance

            updateCheckinTable();
        }

        // Handle Enter key for instant check-in
        function handleCheckinEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                
                // If only one result, do instant check-in
                if (checkinResults.length === 1) {
                    quickCheckin(checkinResults[0].id);
                    clearCheckinSearch();
                }
            }
        }

        // Clear check-in search
        function clearCheckinSearch() {
            document.getElementById('checkinSearch').value = '';
            checkinResults = [];
            updateCheckinTable();
            document.getElementById('checkinSearch').focus();
        }

        // Update check-in table
        function updateCheckinTable() {
            const tableBody = document.getElementById('checkinTableBody');
            const resultsCount = document.getElementById('checkinResultsCount');
            
            resultsCount.textContent = checkinResults.length;

            if (checkinResults.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #94A3B8; padding: 2rem;">
                            ${document.getElementById('checkinSearch').value.trim() ? 'Nenhum aluno encontrado' : 'Digite acima para buscar alunos e fazer check-in'}
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = checkinResults.map(student => {
                const user = student.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                const cpf = user.cpf || 'N/A';
                const formattedCpf = cpf !== 'N/A' ? formatCPF(cpf) : 'N/A';
                const matricula = student.matricula || generateMatricula(student.id, 1);
                
                return `
                    <tr style="background: ${checkinResults.length === 1 ? 'rgba(59, 130, 246, 0.1)' : 'transparent'};">
                        <td>
                            <span class="student-matricula">${matricula}</span>
                        </td>
                        <td class="student-name-cell">
                            <div class="student-name">${fullName}</div>
                        </td>
                        <td>
                            <span class="student-cpf">${formattedCpf}</span>
                        </td>
                        <td>
                            <button class="action-btn checkin" 
                                    onclick="quickCheckin('${student.id}')" 
                                    title="Check-in RÃ¡pido"
                                    style="font-weight: 600;">
                                âš¡ CHECK-IN
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // DUPLICATE FUNCTION - This should be removed and use quickCheckinFixed instead
        // Simple quick check-in
        function quickCheckin(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                alert('âŒ Aluno nÃ£o encontrado!');
                return;
            }
            
            const user = student.user || {};
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
            const matricula = student.matricula || generateMatricula(student.id, 1);
            
            // Simple confirmation
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            const confirmed = confirm(`Confirmar check-in?\n\n${fullName} (${matricula})\n${timeString}`);
            
            if (confirmed) {
                console.log('âœ… Check-in confirmado:', fullName, matricula, timeString);
                
                // Simple visual feedback
                const btn = event.target;
                btn.innerHTML = 'âœ… Feito!';
                btn.style.background = '#10B981';
                btn.style.color = 'white';
                btn.disabled = true;
                
                // Auto-clear search after check-in
                setTimeout(() => {
                    clearCheckinSearch();
                    showToast(`âœ… Check-in: ${fullName} (${matricula})`, 'success');
                }, 1000);
                
                // Here you would call the actual check-in API:
                // performActualCheckin(studentId, now);
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                max-width: 400px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                ${type === 'success' ? 'background: linear-gradient(135deg, #10B981, #059669);' : ''}
                ${type === 'error' ? 'background: linear-gradient(135deg, #EF4444, #DC2626);' : ''}
                ${type === 'info' ? 'background: linear-gradient(135deg, #3B82F6, #2563EB);' : ''}
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }
        
        function showStudentsLoadingState() {
            document.getElementById('studentsLoadingState').style.display = 'block';
            document.getElementById('studentsGrid').style.display = 'none';
            document.getElementById('studentsEmptyState').style.display = 'none';
        }
        
        function showStudentsEmptyState() {
            document.getElementById('studentsLoadingState').style.display = 'none';
            document.getElementById('studentsGrid').style.display = 'none';
            document.getElementById('studentsEmptyState').style.display = 'block';
        }
        
        function updateStudentsStats() {
            const total = allStudents.length;
            const active = allStudents.filter(s => s.isActive).length;
            const avgAttendance = allStudents.length > 0 
                ? Math.round(allStudents.reduce((sum, s) => sum + (s.attendanceRate || 0), 0) / allStudents.length)
                : 0;
            const thisMonth = allStudents.filter(s => {
                const enrollDate = new Date(s.enrollmentDate);
                const now = new Date();
                return enrollDate.getMonth() === now.getMonth() && enrollDate.getFullYear() === now.getFullYear();
            }).length;
            
            document.getElementById('totalStudents').textContent = total;
            document.getElementById('activeStudents').textContent = active;
            document.getElementById('avgAttendance').textContent = `${avgAttendance}%`;
            document.getElementById('newThisMonth').textContent = thisMonth;
        }
        
        function updateStudentsGrid() {
            const grid = document.getElementById('studentsGrid');
            const loadingState = document.getElementById('studentsLoadingState');
            const emptyState = document.getElementById('studentsEmptyState');
            
            if (filteredStudents.length === 0) {
                grid.style.display = 'none';
                loadingState.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            loadingState.style.display = 'none';
            emptyState.style.display = 'none';
            grid.style.display = 'grid';
            
            grid.innerHTML = filteredStudents.map(student => {
                const user = student.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                const email = user.email || 'N/A';
                const phone = user.phone || 'N/A';
                const category = student.category || 'ADULT';
                const status = student.isActive ? 'Ativo' : 'Inativo';
                const statusClass = student.isActive ? 'status-active' : 'status-inactive';
                const matricula = student.matricula || `KMA${String(student.id).padStart(4, '0')}`;
                const attendanceRate = student.attendanceRate || 0;
                const avatar = fullName ? fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';
                
                return `
                    <div class="student-card" onclick="openStudentEditPage('${student.id}')" style="cursor: pointer;">
                        <div class="student-status">
                            <span class="status-badge ${statusClass}">${status}</span>
                        </div>
                        
                        <div class="student-card-header">
                            <div style="display: flex; align-items: center;">
                                <div class="student-avatar">${avatar}</div>
                                <div class="student-info">
                                    <div class="student-name">${fullName}</div>
                                    <div class="student-matricula">ðŸ“‹ ${matricula}</div>
                                    <div class="student-email">ðŸ“§ ${email}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="student-stats">
                            <div class="student-stat">
                                <span class="student-stat-value">${attendanceRate}%</span>
                                <div class="student-stat-label">FrequÃªncia</div>
                            </div>
                            <div class="student-stat">
                                <span class="student-stat-value">${category}</span>
                                <div class="student-stat-label">Categoria</div>
                            </div>
                            <div class="student-stat">
                                <span class="student-stat-value">${phone !== 'N/A' ? 'ðŸ“±' : 'âŒ'}</span>
                                <div class="student-stat-label">Contato</div>
                            </div>
                        </div>
                        
                        <div class="student-actions" onclick="event.stopPropagation()">
                            <button class="btn-student btn-student-primary" onclick="openStudentEditPage('${student.id}')">
                                âœï¸ Editar Dados
                            </button>
                        </div>
                        
                        <!-- Hint de clique direto -->
                        <div class="click-hint" style="position: absolute; bottom: 8px; right: 12px; font-size: 0.7rem; color: #10B981; opacity: 0; transition: opacity 0.3s ease; background: rgba(16, 185, 129, 0.1); padding: 0.25rem 0.5rem; border-radius: 6px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            ðŸ“ Editar aluno
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredStudents = allStudents.filter(student => {
                const user = student.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                const email = (user.email || '').toLowerCase();
                const matricula = (student.matricula || `KMA${String(student.id).padStart(4, '0')}`).toLowerCase();
                
                // Search filter
                const matchesSearch = !searchTerm || 
                    fullName.includes(searchTerm) || 
                    email.includes(searchTerm) || 
                    matricula.includes(searchTerm);
                
                // Category filter
                const matchesCategory = !categoryFilter || student.category === categoryFilter;
                
                // Status filter
                const matchesStatus = !statusFilter || String(student.isActive) === statusFilter;
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
            
            updateStudentsGrid();
        }
        
        // Modern unified view/edit functions
        async function openStudentDetails(studentId) {
            console.log('ðŸ‘ï¸ Redirecionando detalhes para ediÃ§Ã£o:', studentId);
            openStudentEditPage(studentId);
        }
        
        async function openStudentEdit(studentId) {
            console.log('âœï¸ Editando estudante:', studentId);
            openStudentEditPage(studentId);
        }
        
        async function viewStudent(studentId) {
            openStudentEditPage(studentId);
        }
        
        async function editStudent(studentId) {
            openStudentEditPage(studentId);
        }
        
        async function openStudentModal(studentId, mode = 'edit') {
            try {
                // Fetch student data
                const response = await fetch(`/api/students`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Erro ao carregar dados do estudante');
                }
                
                // Find the specific student
                const student = data.data.find(s => s.id === studentId);
                if (!student) {
                    throw new Error('Estudante nÃ£o encontrado');
                }
                
                // Set modal title and mode
                const isViewMode = mode === 'view';
                document.getElementById('studentModalTitle').textContent = 
                    isViewMode ? 'Visualizar Aluno' : 'Editar Aluno';
                
                // Show/hide save button
                const saveBtn = document.getElementById('saveStudentBtn');
                saveBtn.style.display = isViewMode ? 'none' : 'block';
                
                // Populate form with student data
                populateStudentForm(student, isViewMode);
                
                // Show modal
                document.getElementById('studentModal').classList.add('active');
                
            } catch (error) {
                console.error('âŒ Erro ao abrir modal do estudante:', error);
                alert(`Erro: ${error.message}`);
            }
        }
        
        function populateStudentForm(student, readonly = false) {
            const user = student.user || {};
            
            // Set form values
            document.getElementById('studentId').value = student.id || '';
            document.getElementById('userId').value = student.userId || '';
            document.getElementById('firstName').value = user.firstName || '';
            document.getElementById('lastName').value = user.lastName || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('cpf').value = user.cpf || '';
            document.getElementById('category').value = student.category || 'ADULT';
            document.getElementById('gender').value = student.gender || 'MASCULINO';
            document.getElementById('physicalCondition').value = student.physicalCondition || 'INICIANTE';
            document.getElementById('medicalConditions').value = student.medicalConditions || '';
            document.getElementById('emergencyContact').value = student.emergencyContact || '';
            document.getElementById('totalXP').value = student.totalXP || 0;
            document.getElementById('globalLevel').value = student.globalLevel || 1;
            document.getElementById('currentStreak').value = student.currentStreak || 0;
            
            // Format dates
            if (student.enrollmentDate) {
                const enrollDate = new Date(student.enrollmentDate).toISOString().split('T')[0];
                document.getElementById('enrollmentDate').value = enrollDate;
            }
            
            if (student.lastCheckinDate) {
                const checkinDate = new Date(student.lastCheckinDate).toISOString().slice(0, 16);
                document.getElementById('lastCheckinDate').value = checkinDate;
            }
            
            // Handle special needs (array)
            const specialNeedsSelect = document.getElementById('specialNeeds');
            if (student.specialNeeds && Array.isArray(student.specialNeeds)) {
                Array.from(specialNeedsSelect.options).forEach(option => {
                    option.selected = student.specialNeeds.includes(option.value);
                });
            }
            
            // Set readonly mode if viewing
            if (readonly) {
                const inputs = document.querySelectorAll('#studentForm input, #studentForm select, #studentForm textarea');
                inputs.forEach(input => {
                    if (!input.hasAttribute('readonly')) {
                        input.setAttribute('readonly', true);
                        input.style.background = 'rgba(255, 255, 255, 0.02)';
                        input.style.color = '#94A3B8';
                        input.style.cursor = 'not-allowed';
                    }
                });
            } else {
                // Remove readonly from editable fields
                const inputs = document.querySelectorAll('#studentForm input:not([name="totalXP"]):not([name="globalLevel"]):not([name="currentStreak"]):not([name="lastCheckinDate"]), #studentForm select:not([multiple]), #studentForm textarea');
                inputs.forEach(input => {
                    input.removeAttribute('readonly');
                    input.style.background = 'rgba(255, 255, 255, 0.05)';
                    input.style.color = '#F8FAFC';
                    input.style.cursor = 'text';
                });
            }
        }
        
        function closeStudentModal() {
            document.getElementById('studentModal').classList.remove('active');
            // Clear form
            document.getElementById('studentForm').reset();
        }
        
        async function saveStudent() {
            const saveBtn = document.getElementById('saveStudentBtn');
            const originalText = saveBtn.innerHTML;
            
            try {
                // Show loading state
                saveBtn.innerHTML = 'â³ Salvando...';
                saveBtn.disabled = true;
                
                const studentId = document.getElementById('studentId').value;
                const userId = document.getElementById('userId').value;
                
                if (!studentId || !userId) {
                    throw new Error('ID do estudante nÃ£o encontrado');
                }
                
                // Collect form data with enhanced validation
                const formData = {
                    // User data (supported by API)
                    firstName: document.getElementById('firstName').value.trim(),
                    lastName: document.getElementById('lastName').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    
                    // Student data (supported by API)
                    category: document.getElementById('category').value,
                    gender: document.getElementById('gender').value,
                    physicalCondition: document.getElementById('physicalCondition').value,
                    emergencyContact: document.getElementById('emergencyContact').value.trim(),
                    medicalConditions: document.getElementById('medicalConditions').value.trim(),
                    isActive: true
                };
                
                // Enhanced validation
                if (!formData.firstName || !formData.lastName || !formData.email) {
                    throw new Error('Nome, sobrenome e email sÃ£o obrigatÃ³rios');
                }
                
                if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
                    throw new Error('Email deve ter um formato vÃ¡lido');
                }
                
                console.log('ðŸ“¤ Enviando dados do estudante:', formData);
                
                // Update student via API
                const response = await fetch(`/api/students/${studentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || `Erro ${response.status}: ${response.statusText}`);
                }
                
                if (!result.success) {
                    throw new Error(result.message || 'Erro ao atualizar dados');
                }
                
                console.log('âœ… Estudante atualizado com sucesso:', result);
                
                // Show success feedback
                saveBtn.innerHTML = 'âœ… Salvo!';
                saveBtn.style.background = '#10B981';
                
                // Close modal and reload students
                setTimeout(() => {
                    closeStudentModal();
                    loadStudents();
                    showNotification('Dados do aluno atualizados com sucesso! ðŸŽ‰', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('âŒ Erro ao salvar estudante:', error);
                
                // Show error feedback
                saveBtn.innerHTML = 'âŒ Erro';
                saveBtn.style.background = '#EF4444';
                
                showNotification(`Erro ao salvar: ${error.message}`, 'error');
                
                // Restore button after error
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }, 2000);
            }
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                ${type === 'success' ? 'background: #10B981;' : ''}
                ${type === 'error' ? 'background: #EF4444;' : ''}
                ${type === 'info' ? 'background: #3B82F6;' : ''}
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Function consolidation: All section loading is now handled in the main showSection function above

        // Students data will be loaded when navigating to the students section

        // ==========================================
        // ATTENDANCE CAPTURE FUNCTIONALITY
        // ==========================================

        // Global variables for attendance
        const currentClassId = '2e47c8b1-5d4c-4a9b-8f3e-1b2c3d4e5f60'; // Turma 1
        const currentLessonNumber = 15;
        let selectedStudentId = null;

        // Load attendance list with interactive checkboxes
        async function loadAttendanceList() {
            try {
                document.getElementById('attendanceList').innerHTML = `
                    <div class="loading-message" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                        <span style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;">ðŸ“‹</span>
                        Carregando lista de presenÃ§a...
                    </div>
                `;

                const studentsResponse = await fetch(`/api/students`);
                const studentsResult = await studentsResponse.json();

                const attendanceResponse = await fetch(`/api/classes/${currentClassId}/lessons/${currentLessonNumber}/attendance`);
                const attendanceResult = await attendanceResponse.json();

                if (studentsResult.success && attendanceResult.success) {
                    displayAttendanceList(studentsResult.data, attendanceResult.data);
                    updateAttendanceStats(studentsResult.data, attendanceResult.data);
                } else {
                    throw new Error('Failed to load attendance data');
                }
            } catch (error) {
                console.error('Erro ao carregar lista de presenÃ§a:', error);
                document.getElementById('attendanceList').innerHTML = `
                    <div style="text-align: center; color: #EF4444; padding: 2rem;">
                        <span style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;">âš ï¸</span>
                        Erro ao carregar lista de presenÃ§a
                    </div>
                `;
            }
        }

        // Display attendance list with interactive cards
        function displayAttendanceList(students, attendanceRecords) {
            const attendanceMap = {};
            attendanceRecords.forEach(record => {
                attendanceMap[record.studentId] = record;
            });

            const html = `
                <div class="attendance-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    ${students.map(enrollment => {
                        const student = enrollment?.student;
                        if (!student || !student.id) {
                            console.warn('Invalid student data in enrollment:', enrollment);
                            return '';
                        }
                        const attendance = attendanceMap[student.id];
                        const isPresent = attendance ? attendance.present : false;
                        const isLate = attendance ? attendance.arrived_late : false;
                        const leftEarly = attendance ? attendance.left_early : false;
                        
                        // Safe access to user data
                        const user = student.user || {};
                        const firstName = user.firstName || 'N';
                        const lastName = user.lastName || 'A';
                        const email = user.email || 'sem-email@exemplo.com';
                        const initials = firstName.charAt(0) + lastName.charAt(0);
                        
                        return `
                            <div class="attendance-card" style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #3B82F6, #10B981); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                        ${initials}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: white;">${firstName} ${lastName}</div>
                                        <div style="font-size: 0.875rem; color: #CBD5E1;">${email}</div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" ${isPresent ? 'checked' : ''} 
                                               onchange="toggleAttendance('${student.id}', 'present', this.checked)"
                                               style="width: 18px; height: 18px;">
                                        <span style="color: white;">Presente</span>
                                        ${isPresent ? '<span style="color: #10B981; margin-left: auto;">âœ…</span>' : ''}
                                    </label>

                                    ${isPresent ? `
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-left: 1rem;">
                                            <input type="checkbox" ${isLate ? 'checked' : ''} 
                                                   onchange="toggleAttendance('${student.id}', 'arrived_late', this.checked)"
                                                   style="width: 16px; height: 16px;">
                                            <span style="color: #CBD5E1; font-size: 0.875rem;">Chegou atrasado</span>
                                        </label>
                                        
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-left: 1rem;">
                                            <input type="checkbox" ${leftEarly ? 'checked' : ''} 
                                                   onchange="toggleAttendance('${student.id}', 'left_early', this.checked)"
                                                   style="width: 16px; height: 16px;">
                                            <span style="color: #CBD5E1; font-size: 0.875rem;">Saiu mais cedo</span>
                                        </label>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.getElementById('attendanceList').innerHTML = html;
        }

        // Toggle individual attendance
        async function toggleAttendance(studentId, field, value) {
            try {
                const attendanceData = {
                    studentId: studentId,
                    classId: currentClassId,
                    courseId: '750273f9-7508-4fbf-affb-8efe189f2875', // Krav Maga course ID
                    lessonNumber: currentLessonNumber,
                    date: new Date().toISOString()
                };

                if (field === 'present') {
                    attendanceData.present = value;
                    attendanceData.arrived_late = false;
                    attendanceData.left_early = false;
                } else {
                    // Get current attendance status first
                    const currentAttendance = await fetch(`/api/classes/${currentClassId}/lessons/${currentLessonNumber}/attendance`);
                    const currentResult = await currentAttendance.json();
                    const studentAttendance = currentResult.data.find(a => a.studentId === studentId);
                    
                    attendanceData.present = studentAttendance ? studentAttendance.present : true;
                    attendanceData[field] = value;
                }

                const response = await fetch('/api/attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(attendanceData)
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('âœ… PresenÃ§a atualizada:', result.data);
                    showToast('PresenÃ§a atualizada com sucesso!');
                    // Reload attendance list after short delay
                    setTimeout(loadAttendanceList, 500);
                } else {
                    throw new Error(result.message || 'Failed to update attendance');
                }
            } catch (error) {
                console.error('Erro ao atualizar presenÃ§a:', error);
                showToast('Erro ao atualizar presenÃ§a', 'error');
            }
        }

        // Mark all students present
        async function markAllPresent() {
            try {
                const studentsResponse = await fetch(`/api/students`);
                const studentsResult = await studentsResponse.json();

                if (!studentsResult.success) {
                    throw new Error('Failed to load students');
                }

                const studentsData = studentsResult.data.map(enrollment => ({
                    studentId: enrollment.student.id,
                    present: true,
                    arrived_late: false,
                    left_early: false
                }));

                const response = await fetch(`/api/classes/${currentClassId}/lessons/${currentLessonNumber}/attendance/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        students: studentsData,
                        courseId: '750273f9-7508-4fbf-affb-8efe189f2875',
                        date: new Date().toISOString()
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('âœ… Todos os alunos marcados como presentes');
                    showToast('Todos os alunos marcados como presentes!');
                    loadAttendanceList();
                } else {
                    throw new Error(result.message || 'Failed to mark all present');
                }
            } catch (error) {
                console.error('Erro ao marcar todos presentes:', error);
                showToast('Erro ao marcar todos presentes', 'error');
            }
        }

        // Update attendance statistics
        function updateAttendanceStats(students, attendanceRecords) {
            const totalStudents = students.length;
            const presentStudents = attendanceRecords.filter(record => record.present).length;
            const absentStudents = totalStudents - presentStudents;
            const attendanceRate = totalStudents > 0 ? Math.round((presentStudents / totalStudents) * 100) : 0;

            document.getElementById('attendanceRate').textContent = attendanceRate + '%';
            document.getElementById('presentCount').textContent = presentStudents;
            document.getElementById('absentCount').textContent = absentStudents;
        }

        // ==========================================
        // QR CODE FUNCTIONALITY
        // ==========================================

        function showQRScanner() {
            const qrCamera = document.getElementById('qrCamera');
            const qrSection = document.getElementById('qrSection');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                qrCamera.style.display = 'block';
                qrCamera.innerHTML = `
                    <div style="background: rgba(0,0,0,0.8); padding: 1rem; border-radius: 8px;">
                        <video id="qrVideo" width="300" height="200" style="border-radius: 8px;"></video>
                        <div style="margin-top: 1rem;">
                            <button onclick="stopQRScanner()" style="background: #EF4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                                Parar Scanner
                            </button>
                        </div>
                        <div id="qrResult" style="margin-top: 1rem; color: #10B981;"></div>
                    </div>
                `;
                
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        const video = document.getElementById('qrVideo');
                        video.srcObject = stream;
                        video.play();
                        showToast('Scanner QR ativado! Aponte para o cÃ³digo QR');
                    })
                    .catch(err => {
                        showToast('Erro ao acessar cÃ¢mera: ' + err.message, 'error');
                    });
            } else {
                showToast('CÃ¢mera nÃ£o disponÃ­vel neste dispositivo', 'error');
            }
        }

        function stopQRScanner() {
            const video = document.getElementById('qrVideo');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('qrCamera').style.display = 'none';
            showToast('Scanner QR desativado');
        }

        function generateClassQR() {
            const qrDisplay = document.getElementById('qrDisplay');
            qrDisplay.style.display = 'block';
            qrDisplay.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; display: inline-block;">
                    <div style="width: 200px; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc; color: #666;">
                        QR Code<br>Aula ${currentLessonNumber}
                    </div>
                    <div style="text-align: center; margin-top: 1rem; color: #333; font-weight: bold;">
                        Aula ${currentLessonNumber} - Turma 1<br>
                        <small>Escaneie para marcar presenÃ§a</small>
                    </div>
                </div>
            `;
            showToast('QR Code da aula gerado!');
        }

        // ==========================================
        // GPS LOCATION FUNCTIONALITY
        // ==========================================

        function captureByLocation() {
            const locationResult = document.getElementById('locationResult');
            
            if (navigator.geolocation) {
                locationResult.innerHTML = '<p style="color: #F59E0B;">ðŸ“ Obtendo localizaÃ§Ã£o...</p>';
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Coordenadas fictÃ­cias da academia (exemplo)
                        const academyLat = -23.5505;
                        const academyLng = -46.6333;
                        
                        const distance = calculateDistance(lat, lng, academyLat, academyLng);
                        
                        if (distance < 0.1) { // Dentro de 100m
                            locationResult.innerHTML = `
                                <p style="color: #10B981;">âœ… LocalizaÃ§Ã£o confirmada!</p>
                                <p style="color: #CBD5E1;">VocÃª estÃ¡ na academia (${distance.toFixed(3)}km)</p>
                                <button onclick="markPresentByLocation()" style="background: #10B981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-top: 0.5rem;">
                                    Marcar PresenÃ§a
                                </button>
                            `;
                        } else {
                            locationResult.innerHTML = `
                                <p style="color: #EF4444;">âŒ LocalizaÃ§Ã£o invÃ¡lida</p>
                                <p style="color: #CBD5E1;">VocÃª estÃ¡ a ${distance.toFixed(2)}km da academia</p>
                            `;
                        }
                    },
                    error => {
                        locationResult.innerHTML = `<p style="color: #EF4444;">âŒ Erro ao obter localizaÃ§Ã£o: ${error.message}</p>`;
                    }
                );
            } else {
                locationResult.innerHTML = '<p style="color: #EF4444;">âŒ GeolocalizaÃ§Ã£o nÃ£o suportada</p>';
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function markPresentByLocation() {
            // Implementar marcaÃ§Ã£o por localizaÃ§Ã£o
            showToast('Funcionalidade em desenvolvimento');
        }

        // ==========================================
        // SEARCH FUNCTIONALITY
        // ==========================================

        // Using the global allStudents variable declared above

        async function loadAllStudents() {
            try {
                const response = await fetch(`/api/students`);
                const result = await response.json();
                if (result.success) {
                    allStudents = result.data;
                }
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
            }
        }

        function searchStudentByName(query) {
            if (!query.trim()) {
                document.getElementById('searchResults').innerHTML = '<p>Digite para buscar alunos por nome</p>';
                selectedStudentId = null;
                return;
            }

            const filtered = allStudents.filter(enrollment => {
                const student = enrollment?.student;
                if (!student || !student.user) return false;
                const user = student.user;
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                return fullName.includes(query.toLowerCase());
            });

            displaySearchResults(filtered);
        }

        function searchStudentByID(query) {
            if (!query.trim()) {
                document.getElementById('searchResults').innerHTML = '<p>Digite para buscar por matrÃ­cula</p>';
                selectedStudentId = null;
                return;
            }

            const filtered = allStudents.filter(enrollment => {
                const student = enrollment?.student;
                if (!student) return false;
                const user = student.user || {};
                return student.id?.includes(query) || 
                       (user.email || '').includes(query);
            });

            displaySearchResults(filtered);
        }

        function displaySearchResults(students) {
            if (students.length === 0) {
                document.getElementById('searchResults').innerHTML = '<p style="color: #EF4444;">Nenhum aluno encontrado</p>';
                selectedStudentId = null;
                return;
            }

            const html = students.map(enrollment => {
                const student = enrollment?.student;
                if (!student || !student.id) return '';
                
                const user = student.user || {};
                const firstName = user.firstName || 'N';
                const lastName = user.lastName || 'A';
                const email = user.email || 'sem-email@exemplo.com';
                
                return `
                    <div onclick="selectStudent('${student.id}')" 
                         style="padding: 0.5rem; margin: 0.25rem 0; background: rgba(59, 130, 246, 0.1); border-radius: 4px; cursor: pointer; border: 1px solid rgba(59, 130, 246, 0.3);"
                         onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'"
                         onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'">
                        <strong>${firstName} ${lastName}</strong><br>
                        <small style="color: #CBD5E1;">${email} | ID: ${student.id.slice(0, 8)}...</small>
                    </div>
                `;
            }).join('');

            document.getElementById('searchResults').innerHTML = html;
        }

        function selectStudent(studentId) {
            selectedStudentId = studentId;
            const student = allStudents.find(e => e.student.id === studentId);
            if (student) {
                const user = student.student.user || {};
                const firstName = user.firstName || 'N';
                const lastName = user.lastName || 'A';
                document.getElementById('searchResults').innerHTML = `
                    <p style="color: #10B981;">âœ… Selecionado: ${firstName} ${lastName}</p>
                `;
            }
        }

        function markSelectedPresent() {
            if (!selectedStudentId) {
                showToast('Selecione um aluno primeiro', 'error');
                return;
            }
            toggleAttendance(selectedStudentId, 'present', true);
        }

        // Enhanced toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast') || createToast();
            const icon = type === 'error' ? 'âŒ' : 'âœ…';
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>${icon}</span>
                    <span>${message}</span>
                </div>
            `;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        function createToast() {
            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.className = 'toast';
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: rgba(16, 185, 129, 0.9); color: white; padding: 1rem;
                border-radius: 8px; display: none; max-width: 300px;
            `;
            document.body.appendChild(toast);
            return toast;
        }

        // Initialize attendance when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadAllStudents();
        });

        // ==========================================
        // STUDENT PORTAL FUNCTIONALITY
        // ==========================================

        let currentStudent = null;

        // Student login function
        async function studentLogin() {
            const name = document.getElementById('studentName').value.trim();
            const matricula = document.getElementById('studentMatricula').value.trim();

            if (!name || !matricula) {
                showToast('Por favor, preencha nome e matrÃ­cula', 'error');
                return;
            }

            try {
                // Search for student by name and email/ID
                const response = await fetch(`/api/students`);
                const result = await response.json();

                if (result.success) {
                    const student = result.data.find(enrollment => {
                        const s = enrollment?.student;
                        if (!s || !s.user) return false;
                        const user = s.user;
                        const fullName = `${user.firstName || 'N'} ${user.lastName || 'A'}`.toLowerCase();
                        return fullName.includes(name.toLowerCase()) && 
                               ((user.email || '').includes(matricula) || s.id.includes(matricula));
                    });

                    if (student) {
                        currentStudent = student.student;
                        showStudentDashboard();
                        showToast(`Bem-vindo, ${currentStudent.user.firstName}!`);
                    } else {
                        showToast('Aluno nÃ£o encontrado. Verifique nome e matrÃ­cula', 'error');
                    }
                }
            } catch (error) {
                console.error('Erro no login:', error);
                showToast('Erro ao fazer login', 'error');
            }
        }

        // Show student dashboard after login
        function showStudentDashboard() {
            document.getElementById('studentLoginSection').style.display = 'none';
            document.getElementById('studentDashboard').style.display = 'block';
            
            // Update welcome message
            document.getElementById('studentWelcome').textContent = 
                `ðŸ‘‹ Bem-vindo, ${currentStudent.user.firstName} ${currentStudent.user.lastName}!`;

            // Load student data
            loadStudentData();
        }

        // Student logout
        function studentLogout() {
            currentStudent = null;
            document.getElementById('studentLoginSection').style.display = 'block';
            document.getElementById('studentDashboard').style.display = 'none';
            document.getElementById('studentName').value = '';
            document.getElementById('studentMatricula').value = '';
            showToast('Logout realizado com sucesso');
        }

        // Load student specific data
        async function loadStudentData() {
            try {
                // Load attendance data
                const attendanceResponse = await fetch(`/api/classes/${currentClassId}/lessons/${currentLessonNumber}/attendance`);
                const attendanceResult = await attendanceResponse.json();
                
                if (attendanceResult.success) {
                    const studentAttendance = attendanceResult.data.find(a => a.studentId === currentStudent.id);
                    updateStudentStats(studentAttendance);
                    loadStudentAttendanceHistory();
                }

                // Load progress data
                loadStudentProgress();
                loadStudentChallenges();

            } catch (error) {
                console.error('Erro ao carregar dados do aluno:', error);
            }
        }

        // Update student statistics
        function updateStudentStats(todayAttendance) {
            // No hardcoded data - will be populated by real API calls

            // Update attendance status for today
            if (todayAttendance && todayAttendance.present) {
                document.getElementById('studentManualResult').innerHTML = 
                    '<span style="color: #10B981;">âœ… PresenÃ§a jÃ¡ confirmada!</span>';
            }
        }

        // Load student attendance history
        function loadStudentAttendanceHistory() {
            const historyHtml = `
                <div style="space-y: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <span>Aula 15 - 27/06</span>
                        <span style="color: #10B981;">âœ… Presente</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <span>Aula 14 - 25/06</span>
                        <span style="color: #10B981;">âœ… Presente</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <span>Aula 13 - 22/06</span>
                        <span style="color: #EF4444;">âŒ Ausente</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(245, 158, 11, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <span>Aula 12 - 20/06</span>
                        <span style="color: #F59E0B;">â° Atrasado</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <span>Aula 11 - 18/06</span>
                        <span style="color: #10B981;">âœ… Presente</span>
                    </div>
                </div>
            `;
            document.getElementById('studentAttendanceHistory').innerHTML = historyHtml;
        }

        // Load student progress in techniques
        function loadStudentProgress() {
            const progressHtml = `
                <div style="space-y: 0.5rem;">
                    <div style="padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #10B981;">âœ… Postura de Guarda</div>
                        <small style="color: #CBD5E1;">Dominada - 95% precisÃ£o</small>
                    </div>
                    <div style="padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #10B981;">âœ… Soco Direto</div>
                        <small style="color: #CBD5E1;">Dominada - 88% precisÃ£o</small>
                    </div>
                    <div style="padding: 0.5rem; background: rgba(245, 158, 11, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #F59E0B;">ðŸ”„ Defesa Contra Soco</div>
                        <small style="color: #CBD5E1;">Em progresso - 65% precisÃ£o</small>
                    </div>
                    <div style="padding: 0.5rem; background: rgba(75, 85, 99, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #6B7280;">â³ Joelhada</div>
                        <small style="color: #CBD5E1;">PrÃ³xima tÃ©cnica</small>
                    </div>
                    <div style="padding: 0.5rem; background: rgba(75, 85, 99, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #6B7280;">â³ Esquiva Lateral</div>
                        <small style="color: #CBD5E1;">PrÃ³xima tÃ©cnica</small>
                    </div>
                </div>
            `;
            document.getElementById('studentTechniquesProgress').innerHTML = progressHtml;
        }

        // Load student challenges
        function loadStudentChallenges() {
            const challengesHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                        <h5 style="color: #3B82F6; margin-bottom: 0.5rem;">ðŸ“± Desafio da Semana</h5>
                        <p style="margin-bottom: 1rem;">Pratique 10 socos diretos em casa e filme</p>
                        <button style="width: 100%; padding: 0.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Enviar VÃ­deo
                        </button>
                    </div>
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                        <h5 style="color: #10B981; margin-bottom: 0.5rem;">âœ… Desafio Completo</h5>
                        <p style="margin-bottom: 1rem;">Postura de guarda por 2 minutos</p>
                        <div style="color: #10B981; font-weight: 600;">+50 Pontos XP</div>
                    </div>
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.3);">
                        <h5 style="color: #F59E0B; margin-bottom: 0.5rem;">â° Desafio Extra</h5>
                        <p style="margin-bottom: 1rem;">Treine cardio por 15 minutos</p>
                        <button style="width: 100%; padding: 0.5rem; background: #F59E0B; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Marcar Completo
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('studentChallenges').innerHTML = challengesHtml;
        }

        // Student QR scan function
        function studentQRScan() {
            const resultDiv = document.getElementById('studentQRResult');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                resultDiv.innerHTML = '<span style="color: #F59E0B;">ðŸ“· Ativando cÃ¢mera...</span>';
                
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        resultDiv.innerHTML = `
                            <div style="margin: 1rem 0;">
                                <video id="studentQRVideo" width="200" height="150" style="border-radius: 8px; background: #000;"></video>
                                <div style="margin-top: 0.5rem;">
                                    <button onclick="stopStudentQRScan()" style="background: #EF4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        Parar
                                    </button>
                                </div>
                            </div>
                        `;
                        const video = document.getElementById('studentQRVideo');
                        video.srcObject = stream;
                        video.play();
                        
                        // Simulate QR detection after 3 seconds
                        setTimeout(() => {
                            studentMarkPresenceQR();
                        }, 3000);
                    })
                    .catch(err => {
                        resultDiv.innerHTML = '<span style="color: #EF4444;">âŒ Erro ao acessar cÃ¢mera</span>';
                    });
            } else {
                resultDiv.innerHTML = '<span style="color: #EF4444;">âŒ CÃ¢mera nÃ£o disponÃ­vel</span>';
            }
        }

        function stopStudentQRScan() {
            const video = document.getElementById('studentQRVideo');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('studentQRResult').innerHTML = 'Escaneie o QR code mostrado pelo instrutor';
        }

        function studentMarkPresenceQR() {
            stopStudentQRScan();
            markStudentPresent('QR_CODE');
            document.getElementById('studentQRResult').innerHTML = '<span style="color: #10B981;">âœ… QR Code detectado! PresenÃ§a confirmada</span>';
        }

        // Student GPS check
        function studentGPSCheck() {
            const resultDiv = document.getElementById('studentGPSResult');
            
            if (navigator.geolocation) {
                resultDiv.innerHTML = '<span style="color: #F59E0B;">ðŸ“ Verificando localizaÃ§Ã£o...</span>';
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Academy coordinates (mock)
                        const academyLat = -23.5505;
                        const academyLng = -46.6333;
                        
                        const distance = calculateDistance(lat, lng, academyLat, academyLng);
                        
                        if (distance < 0.1) { // Within 100m
                            markStudentPresent('GEOLOCATION');
                            resultDiv.innerHTML = '<span style="color: #10B981;">âœ… LocalizaÃ§Ã£o confirmada! PresenÃ§a marcada</span>';
                        } else {
                            resultDiv.innerHTML = `<span style="color: #EF4444;">âŒ VocÃª estÃ¡ a ${distance.toFixed(2)}km da academia</span>`;
                        }
                    },
                    error => {
                        resultDiv.innerHTML = '<span style="color: #EF4444;">âŒ Erro ao obter localizaÃ§Ã£o</span>';
                    }
                );
            } else {
                resultDiv.innerHTML = '<span style="color: #EF4444;">âŒ GPS nÃ£o disponÃ­vel</span>';
            }
        }

        // Student manual check-in
        function studentManualCheckIn() {
            markStudentPresent('MANUAL');
            document.getElementById('studentManualResult').innerHTML = '<span style="color: #10B981;">âœ… PresenÃ§a confirmada manualmente!</span>';
        }

        // Mark student present (unified function)
        async function markStudentPresent(method) {
            if (!currentStudent) {
                showToast('Erro: aluno nÃ£o identificado', 'error');
                return;
            }

            try {
                const attendanceData = {
                    studentId: currentStudent.id,
                    classId: currentClassId,
                    courseId: '750273f9-7508-4fbf-affb-8efe189f2875',
                    lessonNumber: currentLessonNumber,
                    date: new Date().toISOString(),
                    present: true,
                    arrived_late: false,
                    left_early: false,
                    method: method
                };

                const response = await fetch('/api/attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(attendanceData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast(`PresenÃ§a confirmada via ${method}!`);
                    // Update stats
                    updateStudentStats({present: true});
                } else {
                    throw new Error(result.message || 'Failed to mark attendance');
                }
            } catch (error) {
                console.error('Erro ao marcar presenÃ§a:', error);
                showToast('Erro ao confirmar presenÃ§a', 'error');
            }
        }

        // Navigation functionality consolidated in main showSection function above

        // ==========================================
        // PUBLIC CHECK-IN KIOSK FUNCTIONALITY
        // ==========================================

        let publicCheckinStudents = [];
        let checkinCount = 0;
        let selectedStudentForCheckin = null;

        // Load public check-in interface
        async function loadPublicCheckin() {
            await loadStudentsForCheckin();
            loadRecentCheckins();
            updateCheckinCount();
            document.getElementById('quickMatricula').value = '';
            document.getElementById('quickResult').innerHTML = 'Digite sua matrÃ­cula e pressione Enter';
        }

        // Load students for visual selection
        async function loadStudentsForCheckin() {
            try {
                const response = await fetch(`/api/students`);
                const result = await response.json();

                if (result.success) {
                    publicCheckinStudents = result.data;
                    displayStudentGrid();
                }
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
            }
        }

        // Display student grid with photos
        function displayStudentGrid() {
            const grid = document.getElementById('studentGrid');
            
            if (!grid) {
                console.error('studentGrid element not found');
                return;
            }
            
            const html = publicCheckinStudents.map(item => {
                // Check if data is in enrollment.student format or direct student format
                const student = item?.student || item;
                if (!student || !student.id) {
                    console.warn('Invalid student data in enrollment:', item);
                    return '';
                }
                
                // Safe access to user data
                const user = student.user || {};
                const firstName = user.firstName || 'N';
                const lastName = user.lastName || 'A';
                const initials = firstName.charAt(0) + lastName.charAt(0);
                
                return `
                    <div onclick="selectStudentForCheckin('${student.id}')" 
                         class="student-card" id="card-${student.id}"
                         style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                         onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'; this.style.borderColor='#3B82F6'"
                         onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='transparent'">
                        
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #3B82F6, #10B981); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.5rem; margin: 0 auto 0.5rem;">
                            ${initials}
                        </div>
                        
                        <div style="font-weight: 600; color: white; font-size: 0.875rem; margin-bottom: 0.25rem;">
                            ${firstName}
                        </div>
                        <div style="font-weight: 600; color: white; font-size: 0.875rem; margin-bottom: 0.5rem;">
                            ${lastName}
                        </div>
                        
                        <div style="font-size: 0.75rem; color: #CBD5E1;">
                            ID: ${student.id.slice(0, 6)}...
                        </div>
                        
                        <div id="status-${student.id}" style="margin-top: 0.5rem; font-size: 0.75rem;">
                            <span style="color: #6B7280;">ðŸ‘¤ Ausente</span>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = html;
        }

        // Select student for check-in
        function selectStudentForCheckin(studentId) {
            // Reset all cards
            document.querySelectorAll('.student-card').forEach(card => {
                card.style.background = 'rgba(255,255,255,0.1)';
                card.style.borderColor = 'transparent';
            });

            // Highlight selected card
            const selectedCard = document.getElementById(`card-${studentId}`);
            if (selectedCard) {
                selectedCard.style.background = 'rgba(16, 185, 129, 0.2)';
                selectedCard.style.borderColor = '#10B981';
            }

            selectedStudentForCheckin = studentId;
            
            // Find student info - handle both direct student format and enrollment format
            const studentItem = publicCheckinStudents.find(item => {
                const student = item?.student || item;
                return student && student.id === studentId;
            });
            
            if (studentItem) {
                const student = studentItem?.student || studentItem;
                const user = student.user || {};
                const firstName = user.firstName || 'N';
                const lastName = user.lastName || 'A';
                document.getElementById('quickResult').innerHTML = 
                    `<span style="color: #10B981;">âœ… ${firstName} ${lastName} selecionado</span>`;
                
                // Auto check-in after 2 seconds
                setTimeout(() => {
                    publicCheckinStudent(studentId);
                }, 2000);
            }
        }

        // Handle quick search by typing
        function handleQuickSearch(event) {
            const query = event.target.value.trim();
            
            if (event.key === 'Enter' && query) {
                quickCheckin();
                return;
            }

            if (!query) {
                document.getElementById('quickResult').innerHTML = 'Digite sua matrÃ­cula e pressione Enter';
                return;
            }

            // Real-time search - handle both direct student format and enrollment format
            const found = publicCheckinStudents.find(item => {
                const student = item?.student || item;
                if (!student || !student.user) return false;
                const user = student.user;
                return student.id.includes(query) || 
                       (user.email || '').includes(query) ||
                       `${user.firstName || 'N'} ${user.lastName || 'A'}`.toLowerCase().includes(query.toLowerCase());
            });

            if (found) {
                const student = found?.student || found;
                selectedStudentForCheckin = student.id;
                const user = student.user || {};
                const firstName = user.firstName || 'N';
                const lastName = user.lastName || 'A';
                document.getElementById('quickResult').innerHTML = 
                    `<span style="color: #10B981;">âœ… ${firstName} ${lastName} encontrado - Pressione Enter</span>`;
            } else {
                selectedStudentForCheckin = null;
                document.getElementById('quickResult').innerHTML = 
                    `<span style="color: #F59E0B;">âš ï¸ Aluno nÃ£o encontrado</span>`;
            }
        }

        // Quick check-in function
        function quickCheckin() {
            if (!selectedStudentForCheckin) {
                document.getElementById('quickResult').innerHTML = 
                    `<span style="color: #EF4444;">âŒ Digite uma matrÃ­cula vÃ¡lida</span>`;
                return;
            }

            publicCheckinStudent(selectedStudentForCheckin);
        }

        // Public check-in student (unified function)
        async function publicCheckinStudent(studentId) {
            try {
                const attendanceData = {
                    studentId: studentId,
                    classId: currentClassId,
                    courseId: '750273f9-7508-4fbf-affb-8efe189f2875',
                    lessonNumber: currentLessonNumber,
                    date: new Date().toISOString(),
                    present: true,
                    arrived_late: false,
                    left_early: false,
                    method: 'KIOSK'
                };

                const response = await fetch('/api/attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(attendanceData)
                });

                const result = await response.json();
                
                if (result.success) {
                    const studentItem = publicCheckinStudents.find(item => {
                        const student = item?.student || item;
                        return student && student.id === studentId;
                    });
                    
                    if (studentItem) {
                        const student = studentItem?.student || studentItem;
                        const user = student.user || {};
                        const studentName = `${user.firstName || 'N'} ${user.lastName || 'A'}`;
                        
                        // Update UI
                        updateStudentCheckinStatus(studentId, true);
                        showSuccessAnimation(studentName);
                        loadRecentCheckins();
                        updateCheckinCount();
                        
                        // Clear selection
                        selectedStudentForCheckin = null;
                        document.getElementById('quickMatricula').value = '';
                        document.getElementById('quickResult').innerHTML = 'Digite sua matrÃ­cula e pressione Enter';
                    }
                    
                } else {
                    throw new Error(result.message || 'Failed to mark attendance');
                }
            } catch (error) {
                console.error('Erro no check-in:', error);
                document.getElementById('quickResult').innerHTML = 
                    `<span style="color: #EF4444;">âŒ Erro no check-in</span>`;
            }
        }

        // Update student check-in status in the grid
        function updateStudentCheckinStatus(studentId, present) {
            const statusDiv = document.getElementById(`status-${studentId}`);
            const card = document.getElementById(`card-${studentId}`);
            
            if (present) {
                statusDiv.innerHTML = '<span style="color: #10B981;">âœ… Presente</span>';
                card.style.background = 'rgba(16, 185, 129, 0.1)';
                card.style.borderColor = '#10B981';
                card.onclick = null; // Disable further clicks
                card.style.cursor = 'default';
            }
        }

        // Show success animation
        function showSuccessAnimation(studentName) {
            const animation = document.createElement('div');
            animation.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(16, 185, 129, 0.95); color: white; padding: 2rem;
                border-radius: 16px; font-size: 1.5rem; font-weight: bold;
                z-index: 10000; text-align: center; min-width: 300px;
                animation: successPulse 0.5s ease-in-out;
            `;
            animation.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;">âœ…</div>
                <div>Check-in Realizado!</div>
                <div style="font-size: 1rem; margin-top: 0.5rem;">${studentName}</div>
            `;
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes successPulse {
                    0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                    50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(animation);
            
            setTimeout(() => {
                document.body.removeChild(animation);
                document.head.removeChild(style);
            }, 3000);
        }

        // Load recent check-ins
        async function loadRecentCheckins() {
            try {
                const response = await fetch(`/api/classes/${currentClassId}/lessons/${currentLessonNumber}/attendance`);
                const result = await response.json();

                if (result.success) {
                    displayRecentCheckins(result.data);
                }
            } catch (error) {
                console.error('Erro ao carregar check-ins:', error);
            }
        }

        // Display recent check-ins
        function displayRecentCheckins(attendanceRecords) {
            const container = document.getElementById('recentCheckins');
            
            if (!attendanceRecords || attendanceRecords.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6B7280;">
                        Nenhum check-in hoje ainda
                    </div>
                `;
                return;
            }

            const html = attendanceRecords
                .filter(record => record.present)
                .map(record => {
                    const student = publicCheckinStudents.find(e => e.student.id === record.studentId);
                    if (!student) return '';
                    
                    const time = new Date().toLocaleTimeString('pt-BR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid #10B981;">
                            <div>
                                <div style="font-weight: 600; color: white;">
                                    ${(student.student?.user?.firstName || 'N/A')} ${(student.student?.user?.lastName || '')}
                                </div>
                                <div style="font-size: 0.875rem; color: #CBD5E1;">
                                    ID: ${(student.student?.id || 'N/A').toString().slice(0, 8)}...
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #10B981; font-weight: 600;">âœ… Presente</div>
                                <div style="font-size: 0.875rem; color: #CBD5E1;">${time}</div>
                            </div>
                        </div>
                    `;
                })
                .join('');

            container.innerHTML = html || `
                <div style="text-align: center; padding: 2rem; color: #6B7280;">
                    Nenhum check-in hoje ainda
                </div>
            `;
        }

        // Update check-in count
        function updateCheckinCount() {
            // Count present students
            fetch(`/api/classes/${currentClassId}/lessons/${currentLessonNumber}/attendance`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const presentCount = result.data.filter(record => record.present).length;
                        const totalStudents = publicCheckinStudents.length;
                        document.getElementById('checkinCount').textContent = `${presentCount} Presentes`;
                    }
                })
                .catch(error => console.error('Erro ao atualizar contador:', error));
        }

        // Refresh student grid
        function refreshStudentGrid() {
            loadStudentsForCheckin();
            showToast('Lista de alunos atualizada');
        }

        // Public QR Scanner
        function togglePublicQRScanner() {
            const camera = document.getElementById('publicQRCamera');
            
            if (camera.style.display === 'none') {
                startPublicQRScanner();
            } else {
                stopPublicQRScanner();
            }
        }

        function startPublicQRScanner() {
            const camera = document.getElementById('publicQRCamera');
            const result = document.getElementById('publicQRResult');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                camera.style.display = 'block';
                camera.innerHTML = `
                    <div style="background: rgba(0,0,0,0.8); padding: 1rem; border-radius: 8px; display: inline-block;">
                        <video id="publicQRVideo" width="300" height="200" style="border-radius: 8px;"></video>
                        <div style="margin-top: 1rem;">
                            <button onclick="stopPublicQRScanner()" style="background: #EF4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                                Parar Scanner
                            </button>
                        </div>
                    </div>
                `;
                
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        const video = document.getElementById('publicQRVideo');
                        video.srcObject = stream;
                        video.play();
                        result.innerHTML = '<span style="color: #10B981;">ðŸ“· Scanner ativo - Aponte para o QR code</span>';
                        
                        // Simulate QR detection after 5 seconds
                        setTimeout(() => {
                            if (publicCheckinStudents.length > 0) {
                                const randomStudent = publicCheckinStudents[0].student; // Use first student for demo
                                publicCheckinStudent(randomStudent.id);
                                result.innerHTML = '<span style="color: #10B981;">âœ… QR Code detectado!</span>';
                                stopPublicQRScanner();
                            }
                        }, 5000);
                    })
                    .catch(err => {
                        result.innerHTML = '<span style="color: #EF4444;">âŒ Erro ao acessar cÃ¢mera</span>';
                    });
            } else {
                result.innerHTML = '<span style="color: #EF4444;">âŒ CÃ¢mera nÃ£o disponÃ­vel</span>';
            }
        }

        function stopPublicQRScanner() {
            const video = document.getElementById('publicQRVideo');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('publicQRCamera').style.display = 'none';
            document.getElementById('publicQRResult').innerHTML = 'Escaneie o QR code do seu cartÃ£o de aluno';
        }

        // ==========================================
        // STUDENT DETAILS MODAL FUNCTIONS
        // ==========================================

        // Store current students data globally for modal access
        window.currentStudents = [];

        // Update currentStudents when data is loaded
        const originalLoadStudents = loadStudents;
        loadStudents = async function() {
            await originalLoadStudents();
            window.currentStudents = allStudents || [];
        };

        // Open student details modal
        window.openStudentDetails = async function(studentId) {
            try {
                console.log('Opening student details for ID:', studentId);
                
                // Find student data from current students list
                const student = window.currentStudents?.find(s => s.id === studentId);
                
                if (!student) {
                    console.error('Student not found:', studentId);
                    showToast('Aluno nÃ£o encontrado', 'error');
                    return;
                }

                // Populate modal with student data
                populateStudentModal(student);
                
                // Show modal
                document.getElementById('studentDetailsModal').style.display = 'block';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                
            } catch (error) {
                console.error('Error opening student details:', error);
                showToast('Erro ao abrir detalhes do aluno', 'error');
            }
        };

        // Close student details modal
        window.closeStudentModal = function() {
            document.getElementById('studentDetailsModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        };

        // Switch between tabs in student modal
        window.switchStudentTab = function(tabName) {
            console.log(`ðŸ”„ switchStudentTab called with: ${tabName}`);
            
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.student-tab-content');
            console.log(`ðŸ” Found ${tabContents.length} tab contents`);
            tabContents.forEach(tab => {
                console.log(`ðŸ”’ Hiding tab: ${tab.id}`);
                tab.style.display = 'none';
            });

            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.student-tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.color = '#94A3B8';
                btn.style.borderBottomColor = 'transparent';
            });

            // Show selected tab content
            const selectedTab = document.getElementById(`student-tab-${tabName}`);
            console.log(`ðŸŽ¯ Looking for tab: student-tab-${tabName}`);
            console.log(`ðŸŽ¯ Found selectedTab:`, selectedTab);
            if (selectedTab) {
                selectedTab.style.display = 'block';
                console.log(`âœ… Showing tab: ${selectedTab.id}`);
            } else {
                console.error(`âŒ Tab not found: student-tab-${tabName}`);
            }

            // Add active class to selected tab button
            const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
                selectedBtn.style.color = '#3B82F6';
                selectedBtn.style.borderBottomColor = '#3B82F6';
            }

            // Load dynamic content based on tab
            loadTabContent(tabName);
        };

        // Populate student modal with data
        function populateStudentModal(student) {
            try {
                // Header information
                const user = student.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                document.getElementById('modalStudentName').textContent = fullName || 'Nome nÃ£o informado';
                document.getElementById('modalStudentId').textContent = `ID: ${student.id?.substring(0, 8) || 'N/A'}...`;

                // Summary information
                document.getElementById('modalStudentStatus').textContent = student.isActive ? 'Ativo' : 'Inativo';
                document.getElementById('modalStudentCategory').textContent = getCategoryText(student.category);
                document.getElementById('modalStudentClasses').textContent = '1'; // Default for now
                document.getElementById('modalStudentAttendance').textContent = '85%'; // Default for now

                // Basic Information
                document.getElementById('modalFullName').textContent = fullName || 'NÃ£o informado';
                document.getElementById('modalCpf').textContent = user.cpf ? formatCPF(user.cpf) : 'NÃ£o informado';
                document.getElementById('modalBirthDate').textContent = user.birthDate ? new Date(user.birthDate).toLocaleDateString('pt-BR') : 'NÃ£o informado';
                document.getElementById('modalAge').textContent = calculateAge(user.birthDate) || 'N/A';
                document.getElementById('modalGender').textContent = getGenderText(student.gender);
                document.getElementById('modalEmail').textContent = user.email || 'NÃ£o informado';
                document.getElementById('modalPhone').textContent = user.phone || 'NÃ£o informado';

                // Address Information
                document.getElementById('modalPostalCode').textContent = student.postalCode || 'NÃ£o informado';
                document.getElementById('modalAddress').textContent = student.address || 'NÃ£o informado';
                document.getElementById('modalAddressNumber').textContent = student.addressNumber || 'NÃ£o informado';
                document.getElementById('modalNeighborhood').textContent = student.neighborhood || 'NÃ£o informado';
                document.getElementById('modalCity').textContent = student.city || 'NÃ£o informado';
                document.getElementById('modalState').textContent = student.state || 'NÃ£o informado';

                // Academic Information
                document.getElementById('modalRegistration').textContent = student.matricula || student.id?.substring(0, 8) || 'N/A';
                document.getElementById('modalEnrollmentDate').textContent = student.createdAt ? new Date(student.createdAt).toLocaleDateString('pt-BR') : 'NÃ£o informado';
                document.getElementById('modalStudentCategoryDetails').textContent = getCategoryText(student.category);
                document.getElementById('modalStatusDetails').textContent = student.isActive ? 'Ativo' : 'Inativo';
                document.getElementById('modalSpecialNeeds').textContent = student.specialNeeds?.length > 0 ? student.specialNeeds.join(', ') : 'Nenhuma';

                // Emergency Contact (placeholder for now)
                document.getElementById('modalEmergencyName').textContent = student.emergencyContact || 'NÃ£o informado';
                document.getElementById('modalEmergencyPhone').textContent = 'NÃ£o informado';
                document.getElementById('modalEmergencyRelation').textContent = 'NÃ£o informado';

            } catch (error) {
                console.error('Error populating student modal:', error);
            }
        }

        // Load dynamic tab content
        function loadTabContent(tabName) {
            const tabContent = document.getElementById(`student-tab-${tabName}`);
            
            switch(tabName) {
                case 'courses':
                    if (tabContent && tabContent.innerHTML.includes('Carregando')) {
                        tabContent.innerHTML = `
                            <div style="background: rgba(59, 130, 246, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <h3 style="color: #3B82F6; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>ðŸ“š</span> Cursos Matriculados
                                </h3>
                                <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #10B981; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: #10B981; font-weight: bold;">ðŸ¥‹ Krav Maga Faixa Branca - Defesa Pessoal 1</div>
                                            <div style="color: #CBD5E1; font-size: 0.875rem; margin-top: 0.25rem;">Iniciado em: 01/06/2025 â€¢ Progresso: 31%</div>
                                        </div>
                                        <div style="background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">
                                            ATIVO
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 2rem; color: #6B7280;">
                                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸŽ¯</div>
                                    <p style="margin: 0;">Pronto para novos desafios! Considere matricular em cursos avanÃ§ados.</p>
                                </div>
                            </div>
                        `;
                    }
                    break;
                case 'classes':
                    if (tabContent && tabContent.innerHTML.includes('Carregando')) {
                        tabContent.innerHTML = `
                            <div style="background: rgba(245, 158, 11, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                                <h3 style="color: #F59E0B; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>ðŸ«</span> Turmas Participantes
                                </h3>
                                <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #3B82F6; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div style="color: #3B82F6; font-weight: bold;">Turma 1 - TerÃ§as e Quintas</div>
                                        <div style="background: #3B82F6; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">
                                            ATIVO
                                        </div>
                                    </div>
                                    <div style="color: #CBD5E1; font-size: 0.875rem;">
                                        <div>â° HorÃ¡rio: 18:00 - 19:00</div>
                                        <div>ðŸ‘¥ Capacidade: 15/20 alunos</div>
                                        <div>ðŸ“… PrÃ³xima aula: Quinta, 05/06/2025</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    break;
                case 'progress':
                    if (tabContent && tabContent.innerHTML.includes('Carregando')) {
                        tabContent.innerHTML = `
                            <div style="display: grid; gap: 2rem;">
                                <div style="background: rgba(139, 92, 246, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                                    <h3 style="color: #8B5CF6; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>ðŸ“ˆ</span> Progresso Geral
                                    </h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                        <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                            <div style="color: #10B981; font-size: 2rem; font-weight: bold;">5</div>
                                            <div style="color: #CBD5E1; font-size: 0.875rem;">TÃ©cnicas Dominadas</div>
                                        </div>
                                        <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                                            <div style="color: #3B82F6; font-size: 2rem; font-weight: bold;">65</div>
                                            <div style="color: #CBD5E1; font-size: 0.875rem;">Pontos XP</div>
                                        </div>
                                        <div style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                                            <div style="color: #F59E0B; font-size: 2rem; font-weight: bold;">85%</div>
                                            <div style="color: #CBD5E1; font-size: 0.875rem;">FrequÃªncia</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    break;
                case 'financial':
                    if (tabContent && tabContent.innerHTML.includes('Carregando')) {
                        tabContent.innerHTML = `
                            <div style="background: rgba(16, 185, 129, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                                <h3 style="color: #10B981; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>ðŸ’°</span> SituaÃ§Ã£o Financeira
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                    <div>
                                        <h4 style="color: #CBD5E1; margin: 0 0 1rem 0;">Plano Atual</h4>
                                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #3B82F6;">
                                            <div style="color: #3B82F6; font-weight: bold; margin-bottom: 0.5rem;">Plano Mensal Premium</div>
                                            <div style="color: #CBD5E1; font-size: 0.875rem;">R$ 150,00/mÃªs</div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 style="color: #CBD5E1; margin: 0 0 1rem 0;">Status Pagamento</h4>
                                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #10B981;">
                                            <div style="color: #10B981; font-weight: bold; margin-bottom: 0.5rem;">âœ… Em Dia</div>
                                            <div style="color: #CBD5E1; font-size: 0.875rem;">PrÃ³ximo vencimento: 01/07/2025</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    break;
                case 'attendance':
                    if (tabContent && tabContent.innerHTML.includes('Carregando')) {
                        tabContent.innerHTML = `
                            <div style="background: rgba(59, 130, 246, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <h3 style="color: #3B82F6; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>ðŸ“Š</span> HistÃ³rico de FrequÃªncia
                                </h3>
                                <div style="display: grid; gap: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                        <span style="color: #CBD5E1;">Aula 15 - 27/06/2025</span>
                                        <span style="color: #10B981; font-weight: bold;">âœ… Presente</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                        <span style="color: #CBD5E1;">Aula 14 - 25/06/2025</span>
                                        <span style="color: #10B981; font-weight: bold;">âœ… Presente</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                                        <span style="color: #CBD5E1;">Aula 13 - 22/06/2025</span>
                                        <span style="color: #EF4444; font-weight: bold;">âŒ Ausente</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    break;
                case 'history':
                    if (tabContent && tabContent.innerHTML.includes('Carregando')) {
                        tabContent.innerHTML = `
                            <div style="background: rgba(139, 92, 246, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                                <h3 style="color: #8B5CF6; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>ðŸ“œ</span> HistÃ³rico de Atividades
                                </h3>
                                <div style="display: grid; gap: 1rem;">
                                    <div style="padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid #3B82F6;">
                                        <div style="color: #3B82F6; font-weight: bold; margin-bottom: 0.25rem;">MatrÃ­cula Realizada</div>
                                        <div style="color: #CBD5E1; font-size: 0.875rem;">01/06/2025 - Curso: Krav Maga Faixa Branca</div>
                                    </div>
                                    <div style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10B981;">
                                        <div style="color: #10B981; font-weight: bold; margin-bottom: 0.25rem;">Primeira AvaliaÃ§Ã£o</div>
                                        <div style="color: #CBD5E1; font-size: 0.875rem;">15/06/2025 - Nota: 8.5/10</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    break;
            }
        }

        // Helper functions for modal
        function calculateAge(birthDate) {
            if (!birthDate) return null;
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age + ' anos';
        }

        function getGenderText(gender) {
            const genderMap = {
                'MASCULINO': 'Masculino',
                'FEMININO': 'Feminino',
                'MALE': 'Masculino',
                'FEMALE': 'Feminino'
            };
            return genderMap[gender] || gender || 'NÃ£o informado';
        }

        function getCategoryText(category) {
            const categoryMap = {
                'ADULT': 'Adulto',
                'INICIANTE1': 'Iniciante 1',
                'INICIANTE2': 'Iniciante 2',
                'INTERMEDIARIO1': 'IntermediÃ¡rio 1',
                'INTERMEDIARIO2': 'IntermediÃ¡rio 2',
                'AVANCADO1': 'AvanÃ§ado 1',
                'AVANCADO2': 'AvanÃ§ado 2'
            };
            return categoryMap[category] || category || 'NÃ£o informado';
        }

        // Additional modal functions for footer buttons
        window.editStudentInfo = function() {
            const modal = document.getElementById('studentDetailsModal');
            const studentId = modal.dataset.currentStudentId;
            
            if (studentId) {
                closeStudentModal();
                // Use existing edit function
                openStudentEditPage(studentId);
            } else {
                showToast('Erro: ID do aluno nÃ£o encontrado', 'error');
            }
        };

        window.addStudentToClass = function() {
            const modal = document.getElementById('studentDetailsModal');
            const studentId = modal.dataset.currentStudentId;
            
            if (studentId) {
                const student = window.currentStudents?.find(s => s.id === studentId);
                if (student) {
                    const user = student.user || {};
                    const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                    
                    showToast(`Funcionalidade em desenvolvimento: Adicionar ${fullName} Ã  turma`, 'info');
                } else {
                    showToast('Aluno nÃ£o encontrado', 'error');
                }
            } else {
                showToast('Erro: ID do aluno nÃ£o encontrado', 'error');
            }
        };

        // Update the populateStudentModal function to store student ID
        const originalPopulateStudentModal = populateStudentModal;
        populateStudentModal = function(student) {
            // Store student ID in modal for footer button functions
            const modal = document.getElementById('studentDetailsModal');
            if (modal) {
                modal.dataset.currentStudentId = student.id;
            }
            
            // Call original function
            originalPopulateStudentModal(student);
        };

        // Event listeners for modal
        document.addEventListener('DOMContentLoaded', function() {
            // Close modal when clicking outside
            const modal = document.getElementById('studentDetailsModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target.id === 'studentDetailsModal') {
                        closeStudentModal();
                    }
                });
            }

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal && modal.style.display === 'block') {
                    closeStudentModal();
                }
            });
        });

        // ==========================================
        // COURSE MANAGEMENT FUNCTIONS  
        // ==========================================

        // Show course details
        function showCourseDetails() {
            showToast('Funcionalidade em desenvolvimento', 'info');
        }

        // Show lesson plan manager
        function showLessonPlanManager() {
            showSection('course-management');
            loadAllLessonPlans();
        }

        // Show lessons by unit
        function showLessonsByUnit(unit) {
            document.getElementById('current-unit-name').textContent = getUnitName(unit);
            loadLessonPlansByUnit(unit);
        }

        // Show all lessons
        function showAllLessons() {
            document.getElementById('current-unit-name').textContent = 'Todas as Unidades';
            loadAllLessonPlans();
        }

        // Get unit display name
        function getUnitName(unit) {
            const units = {
                'fundamentos': 'Fundamentos (Aulas 1-10)',
                'golpes': 'Golpes BÃ¡sicos (Aulas 4-15)', 
                'defesas': 'Defesas BÃ¡sicas (Aulas 10-25)',
                'avancadas': 'Defesas AvanÃ§adas (Aulas 25-35)',
                'integracao': 'IntegraÃ§Ã£o (Aulas 35-48)'
            };
            return units[unit] || 'Unidade Desconhecida';
        }

        // Load all lesson plans
        async function loadAllLessonPlans() {
            console.log('ðŸ“‹ Carregando todos os planos de aula...');
            
            // Update current unit name indicator
            const unitNameElement = document.getElementById('current-unit-name');
            if (unitNameElement) {
                unitNameElement.textContent = 'Todas as Unidades';
            }
            
            try {
                // Show loading state
                const tbody = document.getElementById('lesson-plans-table-body');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸ”„</div>
                                Carregando todos os planos de aula...
                            </td>
                        </tr>
                    `;
                }
                
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Generate sample lesson plans for all units
                const allPlans = [
                    ...generateSampleLessonPlansForUnit('fundamentos'),
                    ...generateSampleLessonPlansForUnit('golpes'),
                    ...generateSampleLessonPlansForUnit('defesas'),
                    ...generateSampleLessonPlansForUnit('avancadas'),
                    ...generateSampleLessonPlansForUnit('integracao')
                ];
                
                // Display all plans
                displayLessonPlans(allPlans);
                
                // Show success message
                showToast(`Carregados ${allPlans.length} planos de aula de todas as unidades`, 'success');

            } catch (error) {
                console.error('Erro ao carregar planos de aula:', error);
                showToast('Erro ao carregar planos de aula', 'error');
                
                // Show error state
                const tbody = document.getElementById('lesson-plans-table-body');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; color: #EF4444; padding: 2rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">âŒ</div>
                                Erro ao carregar planos de aula
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Load lessons by unit
        async function loadLessonPlansByUnit(unit) {
            console.log(`ðŸ“š Carregando planos de aula para unidade: ${unit}`);
            
            // Update current unit name indicator
            const unitNameElement = document.getElementById('current-unit-name');
            if (unitNameElement) {
                unitNameElement.textContent = getUnitName(unit);
            }
            
            // Show loading state
            const tbody = document.getElementById('lesson-plans-table-body');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸ”„</div>
                            Carregando planos de aula para ${getUnitName(unit)}...
                        </td>
                    </tr>
                `;
            }
            
            try {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Generate sample lesson plans for the unit
                const samplePlans = generateSampleLessonPlansForUnit(unit);
                
                // Display the filtered plans
                displayLessonPlans(samplePlans);
                
                // Show success message
                showToast(`Carregados ${samplePlans.length} planos de aula para ${getUnitName(unit)}`, 'success');
                
            } catch (error) {
                console.error('Erro ao carregar planos de aula por unidade:', error);
                showToast('Erro ao carregar planos de aula', 'error');
                
                // Show error state
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; color: #EF4444; padding: 2rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">âŒ</div>
                                Erro ao carregar planos de aula
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Generate sample lesson plans for specific unit
        function generateSampleLessonPlansForUnit(unit) {
            const unitData = {
                'fundamentos': {
                    name: 'Fundamentos',
                    lessons: [
                        { lesson: 1, title: 'Postura e MovimentaÃ§Ã£o BÃ¡sica', techniques: 'Postura de combate, movimentaÃ§Ã£o lateral' },
                        { lesson: 2, title: 'Posicionamento Defensivo', techniques: 'DistÃ¢ncia de seguranÃ§a, posicionamento corporal' },
                        { lesson: 3, title: 'Fundamentos de Ataque', techniques: 'Soco direto, cruzado' },
                        { lesson: 4, title: 'Fundamentos de Defesa', techniques: 'Bloqueios bÃ¡sicos, esquivas' },
                        { lesson: 5, title: 'CoordenaÃ§Ã£o Motora', techniques: 'CoordenaÃ§Ã£o olho-mÃ£o, reflexos' },
                        { lesson: 6, title: 'Condicionamento FÃ­sico', techniques: 'Aquecimento, condicionamento bÃ¡sico' },
                        { lesson: 7, title: 'TÃ©cnicas de RespiraÃ§Ã£o', techniques: 'RespiraÃ§Ã£o em combate, controle de ansiedade' },
                        { lesson: 8, title: 'Trabalho de Pernas', techniques: 'Chutes bÃ¡sicos, mobilidade' },
                        { lesson: 9, title: 'IntegraÃ§Ã£o de Movimentos', techniques: 'CombinaÃ§Ã£o de tÃ©cnicas bÃ¡sicas' },
                        { lesson: 10, title: 'AvaliaÃ§Ã£o de Fundamentos', techniques: 'Teste prÃ¡tico, avaliaÃ§Ã£o de progresso' }
                    ],
                    color: '#10B981'
                },
                'golpes': {
                    name: 'Golpes BÃ¡sicos',
                    lessons: [
                        { lesson: 11, title: 'Socos Diretos', techniques: 'Jab, cross, hook' },
                        { lesson: 12, title: 'Socos Curvos', techniques: 'Uppercut, ganchos laterais' },
                        { lesson: 13, title: 'Chutes Frontais', techniques: 'Chute frontal, chute lateral' },
                        { lesson: 14, title: 'Chutes Circulares', techniques: 'Chute circular, chute ascendente' },
                        { lesson: 15, title: 'Joelhadas', techniques: 'Joelhada frontal, joelhada lateral' },
                        { lesson: 16, title: 'Cotovelos', techniques: 'Cotovelo horizontal, cotovelo vertical' },
                        { lesson: 17, title: 'CombinaÃ§Ãµes de Golpes', techniques: 'SequÃªncias de socos e chutes' },
                        { lesson: 18, title: 'Trabalho de Foco', techniques: 'PrecisÃ£o, timing, distÃ¢ncia' },
                        { lesson: 19, title: 'Sparring Controlado', techniques: 'AplicaÃ§Ã£o em combate controlado' },
                        { lesson: 20, title: 'AvaliaÃ§Ã£o de Golpes', techniques: 'Teste de tÃ©cnicas de ataque' }
                    ],
                    color: '#3B82F6'
                },
                'defesas': {
                    name: 'Defesas BÃ¡sicas',
                    lessons: [
                        { lesson: 21, title: 'Defesas contra Socos', techniques: 'Bloqueios, desvios de socos' },
                        { lesson: 22, title: 'Defesas contra Chutes', techniques: 'Bloqueios de chutes, esquivas' },
                        { lesson: 23, title: 'Defesas contra Agarramentos', techniques: 'LibertaÃ§Ã£o de agarramentos' },
                        { lesson: 24, title: 'Defesas contra Enforcamentos', techniques: 'Defesa contra enforcamento frontal' },
                        { lesson: 25, title: 'Defesas contra EmpurrÃµes', techniques: 'RecuperaÃ§Ã£o de equilÃ­brio' },
                        { lesson: 26, title: 'Defesas contra Tapas', techniques: 'Bloqueios e contra-ataques' },
                        { lesson: 27, title: 'Defesas Combinadas', techniques: 'Defesa + contra-ataque' },
                        { lesson: 28, title: 'Mobilidade Defensiva', techniques: 'MovimentaÃ§Ã£o defensiva' },
                        { lesson: 29, title: 'Timing Defensivo', techniques: 'Momento certo para defesa' },
                        { lesson: 30, title: 'AvaliaÃ§Ã£o de Defesas', techniques: 'Teste de defesas bÃ¡sicas' }
                    ],
                    color: '#8B5CF6'
                },
                'avancadas': {
                    name: 'Defesas AvanÃ§adas',
                    lessons: [
                        { lesson: 31, title: 'Defesas contra Armas Brancas', techniques: 'Defesa contra faca, estilete' },
                        { lesson: 32, title: 'Defesas contra BastÃµes', techniques: 'Defesa contra cassetete, vara' },
                        { lesson: 33, title: 'Defesas contra MÃºltiplos Atacantes', techniques: 'EstratÃ©gias de mÃºltiplos oponentes' },
                        { lesson: 34, title: 'Defesas no Solo', techniques: 'Defesas caÃ­do, levantamento rÃ¡pido' },
                        { lesson: 35, title: 'Defesas em EspaÃ§os Confinados', techniques: 'Combate em elevador, corredor' },
                        { lesson: 36, title: 'Defesas contra Agarramentos AvanÃ§ados', techniques: 'Mata-leÃ£o, guilhotina' },
                        { lesson: 37, title: 'TÃ©cnicas de FinalizaÃ§Ã£o', techniques: 'ImobilizaÃ§Ãµes, pontos de pressÃ£o' },
                        { lesson: 38, title: 'Psicologia de Combate', techniques: 'Controle emocional, tomada de decisÃ£o' },
                        { lesson: 39, title: 'CenÃ¡rios Reais', techniques: 'SimulaÃ§Ãµes de situaÃ§Ãµes reais' },
                        { lesson: 40, title: 'AvaliaÃ§Ã£o AvanÃ§ada', techniques: 'Teste de tÃ©cnicas avanÃ§adas' }
                    ],
                    color: '#F59E0B'
                },
                'integracao': {
                    name: 'IntegraÃ§Ã£o',
                    lessons: [
                        { lesson: 41, title: 'IntegraÃ§Ã£o de TÃ©cnicas', techniques: 'CombinaÃ§Ã£o de todas as tÃ©cnicas' },
                        { lesson: 42, title: 'Sparring AvanÃ§ado', techniques: 'Combate livre controlado' },
                        { lesson: 43, title: 'Defesa Pessoal Aplicada', techniques: 'SituaÃ§Ãµes reais de autodefesa' },
                        { lesson: 44, title: 'Condicionamento AvanÃ§ado', techniques: 'PreparaÃ§Ã£o fÃ­sica intensa' },
                        { lesson: 45, title: 'TÃ¡ticas de SobrevivÃªncia', techniques: 'EstratÃ©gias de fuga e escape' },
                        { lesson: 46, title: 'Exame PrÃ¡tico', techniques: 'AvaliaÃ§Ã£o prÃ¡tica completa' },
                        { lesson: 47, title: 'DemonstraÃ§Ã£o de Habilidades', techniques: 'ApresentaÃ§Ã£o de tÃ©cnicas dominadas' },
                        { lesson: 48, title: 'CerimÃ´nia de GraduaÃ§Ã£o', techniques: 'AvaliaÃ§Ã£o final, certificaÃ§Ã£o' }
                    ],
                    color: '#EF4444'
                }
            };
            
            const unitInfo = unitData[unit];
            if (!unitInfo) {
                console.error(`Unidade desconhecida: ${unit}`);
                return [];
            }
            
            return unitInfo.lessons.map(lesson => ({
                lessonNumber: lesson.lesson,
                weekNumber: Math.ceil(lesson.lesson / 2),
                title: lesson.title,
                unit: unitInfo.name,
                techniques: lesson.techniques,
                duration: '60 min',
                level: Math.min(Math.ceil(lesson.lesson / 10), 5),
                status: lesson.lesson <= 15 ? 'ConcluÃ­da' : 'Pendente',
                statusColor: lesson.lesson <= 15 ? '#10B981' : '#6B7280'
            }));
        }

        // Display lesson plans in table
        function displayLessonPlans(plans) {
            const tbody = document.getElementById('lesson-plans-table-body');
            
            if (plans.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸ“­</div>
                            Nenhum plano de aula encontrado
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = plans.map(plan => `
                <tr style="border-left: 3px solid ${plan.statusColor};">
                    <td style="font-weight: bold; color: #F8FAFC;">${plan.lessonNumber}</td>
                    <td style="color: #CBD5E1;">${plan.weekNumber}</td>
                    <td style="color: #F8FAFC; font-weight: 500;">${plan.title}</td>
                    <td style="color: #CBD5E1;">${plan.unit}</td>
                    <td style="color: #CBD5E1; font-size: 0.85rem;">${plan.techniques}</td>
                    <td style="color: #CBD5E1;">${plan.duration}</td>
                    <td style="text-align: center;">
                        ${'â­'.repeat(plan.level)}
                    </td>
                    <td style="color: ${plan.statusColor}; font-weight: 500;">${plan.status}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn" onclick="viewLessonPlan(${plan.lessonNumber})" 
                                    style="background: #3B82F6; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                ðŸ‘ï¸ Ver
                            </button>
                            <button class="btn" onclick="editLessonPlan(${plan.lessonNumber})" 
                                    style="background: #F59E0B; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                âœï¸ Editar
                            </button>
                            <button class="btn" onclick="generateAIVariation(${plan.lessonNumber})" 
                                    style="background: #8B5CF6; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                ðŸ¤– IA
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // View lesson plan details
        function viewLessonPlan(lessonNumber) {
            showToast(`Visualizando plano da Aula ${lessonNumber}`, 'info');
            // TODO: Open lesson plan detail modal
        }

        // Edit lesson plan
        function editLessonPlan(lessonNumber) {
            showToast(`Editando plano da Aula ${lessonNumber}`, 'info');
            // TODO: Open lesson plan editor
        }

        // Generate AI variation
        function generateAIVariation(lessonNumber) {
            showToast(`Gerando variaÃ§Ã£o IA para Aula ${lessonNumber}...`, 'info');
            // TODO: Call AI generation API
        }

        // Open AI lesson generator
        function openAILessonGenerator() {
            showToast('Gerador IA em desenvolvimento - Em breve!', 'info');
            // TODO: Open AI generator modal
        }

        // Show curriculum builder
        function showCurriculumBuilder() {
            showToast('Curriculum Builder em desenvolvimento', 'info');
        }

        // Show progress analytics
        function showProgressAnalytics() {
            showToast('Analytics em desenvolvimento', 'info');
        }

        // Export lesson plans
        function exportLessonPlans() {
            showToast('Exportando planos de aula...', 'info');
            // TODO: Generate PDF or CSV export
        }

        // Import lesson plans
        function importLessonPlans() {
            showToast('ImportaÃ§Ã£o em desenvolvimento', 'info');
            // TODO: File upload functionality
        }

        // Initialize course management when section loads
        window.addEventListener('load', () => {
            // Load lesson plans if course-management is the initial section
            if (window.location.hash === '#course-management') {
                setTimeout(() => loadAllLessonPlans(), 500);
            }
        });

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    </script>

    <!-- Techniques Manager Modal -->
    <div id="techniquesManagerModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>ðŸ¥Š Banco de PosiÃ§Ãµes/TÃ©cnicas</h2>
                <button class="btn btn-secondary" onclick="closeTechniquesManagerModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 1.5rem;">
                    <!-- Stats Overview -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(59, 130, 246, 0.2); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #3B82F6;" id="totalTechniquesCount">42</div>
                            <div style="color: #CBD5E1; font-size: 0.9rem;">Total TÃ©cnicas</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.2); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #10B981;" id="categoriesCount">8</div>
                            <div style="color: #CBD5E1; font-size: 0.9rem;">Categorias</div>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.2); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #F59E0B;" id="coursesUsingCount">2</div>
                            <div style="color: #CBD5E1; font-size: 0.9rem;">Cursos Usando</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.2); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #8B5CF6;" id="reusedCount">15</div>
                            <div style="color: #CBD5E1; font-size: 0.9rem;">Reutilizadas</div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="text" id="techniqueSearch" placeholder="Buscar tÃ©cnica..." 
                                   style="padding: 0.5rem; border-radius: 6px; border: 1px solid #374151; background: rgba(55, 65, 81, 0.5); color: #F8FAFC; width: 300px;">
                            <select id="categoryFilter" style="padding: 0.5rem; border-radius: 6px; border: 1px solid #374151; background: rgba(55, 65, 81, 0.5); color: #F8FAFC;">
                                <option value="">Todas Categorias</option>
                                <option value="STANCE">Postura</option>
                                <option value="STRIKE">Golpes</option>
                                <option value="DEFENSE">Defesa</option>
                                <option value="GRAPPLING">Agarramento</option>
                                <option value="COMBO">CombinaÃ§Ã£o</option>
                                <option value="MOVEMENT">MovimentaÃ§Ã£o</option>
                                <option value="SCENARIO">CenÃ¡rio</option>
                                <option value="CONDITIONING">Condicionamento</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="openAddTechniqueModal()">
                            <span>âž•</span> Nova TÃ©cnica
                        </button>
                    </div>

                    <!-- Techniques Table -->
                    <div style="border: 1px solid #374151; border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: rgba(55, 65, 81, 0.5);">
                                <tr>
                                    <th style="padding: 1rem; text-align: left; color: #F8FAFC; border-bottom: 1px solid #374151;">Nome</th>
                                    <th style="padding: 1rem; text-align: left; color: #F8FAFC; border-bottom: 1px solid #374151;">Categoria</th>
                                    <th style="padding: 1rem; text-align: left; color: #F8FAFC; border-bottom: 1px solid #374151;">NÃ­vel</th>
                                    <th style="padding: 1rem; text-align: left; color: #F8FAFC; border-bottom: 1px solid #374151;">Usado em</th>
                                    <th style="padding: 1rem; text-align: left; color: #F8FAFC; border-bottom: 1px solid #374151;">PrÃ©-requisitos</th>
                                    <th style="padding: 1rem; text-align: center; color: #F8FAFC; border-bottom: 1px solid #374151;">AÃ§Ãµes</th>
                                </tr>
                            </thead>
                            <tbody id="techniquesTableBody" style="color: #CBD5E1;">
                                <tr>
                                    <td colspan="6" style="padding: 2rem; text-align: center;">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">â³</div>
                                        Carregando tÃ©cnicas...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Technique Modal -->
    <div id="addTechniqueModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>âž• Adicionar Nova TÃ©cnica</h2>
                <button class="btn btn-secondary" onclick="closeAddTechniqueModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <form id="addTechniqueForm" style="display: grid; gap: 1rem;">
                    <div class="form-group">
                        <label for="techniqueName">Nome da TÃ©cnica *</label>
                        <input type="text" id="techniqueName" required placeholder="Ex: Defesa 360Â° Superior">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="techniqueCategory">Categoria *</label>
                            <select id="techniqueCategory" required>
                                <option value="">Selecione</option>
                                <option value="STANCE">ðŸ¥‹ Postura</option>
                                <option value="STRIKE">ðŸ‘Š Golpes</option>
                                <option value="DEFENSE">ðŸ›¡ï¸ Defesa</option>
                                <option value="GRAPPLING">ðŸ¤¼ Agarramento</option>
                                <option value="COMBO">âš¡ CombinaÃ§Ã£o</option>
                                <option value="MOVEMENT">ðŸƒ MovimentaÃ§Ã£o</option>
                                <option value="SCENARIO">ðŸŽ­ CenÃ¡rio</option>
                                <option value="CONDITIONING">ðŸ’ª Condicionamento</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="techniqueLevel">NÃ­vel *</label>
                            <select id="techniqueLevel" required>
                                <option value="BEGINNER">â­ Iniciante</option>
                                <option value="INTERMEDIATE">â­â­ IntermediÃ¡rio</option>
                                <option value="ADVANCED">â­â­â­ AvanÃ§ado</option>
                                <option value="EXPERT">â­â­â­â­ Expert</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="techniqueDescription">DescriÃ§Ã£o</label>
                        <textarea id="techniqueDescription" rows="3" placeholder="DescriÃ§Ã£o detalhada da tÃ©cnica..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="techniqueInstructions">InstruÃ§Ãµes Passo a Passo</label>
                        <textarea id="techniqueInstructions" rows="4" placeholder="1. PosiÃ§Ã£o inicial...&#10;2. Movimento principal...&#10;3. FinalizaÃ§Ã£o..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="techniquePrerequisites">PrÃ©-requisitos (opcional)</label>
                        <input type="text" id="techniquePrerequisites" placeholder="Ex: Guarda de Boxe, MovimentaÃ§Ã£o BÃ¡sica">
                    </div>

                    <div class="form-group">
                        <label for="techniqueKeyPoints">Pontos-Chave</label>
                        <textarea id="techniqueKeyPoints" rows="3" placeholder="Aspectos importantes para execuÃ§Ã£o correta..."></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="techniqueEquipment">Equipamentos</label>
                            <input type="text" id="techniqueEquipment" placeholder="Ex: Tatame, Pads, Luvas">
                        </div>
                        <div class="form-group">
                            <label for="techniqueDuration">DuraÃ§Ã£o (minutos)</label>
                            <input type="number" id="techniqueDuration" min="1" max="60" value="10">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddTechniqueModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveTechnique()">
                    <span>ðŸ’¾</span> Salvar TÃ©cnica
                </button>
            </div>
        </div>
    </div>

    <!-- Universal Course Creator Modal -->
    <div id="universalCourseModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>ðŸŽ­ Criador Universal de Cursos</h2>
                <button class="btn btn-secondary" onclick="closeUniversalCourseModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 2rem;">
                    <!-- Martial Art & Level Selection -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ¥‹ Arte Marcial e NÃ­vel</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="martialArt">Arte Marcial *</label>
                                    <select id="martialArt" required onchange="updateTechniquesForArt()">
                                        <option value="">Selecione</option>
                                        <option value="KRAV_MAGA">ðŸ¥Š Krav Maga</option>
                                        <option value="JIU_JITSU">ðŸ¥‹ Jiu-Jitsu</option>
                                        <option value="BOXING">ðŸ‘Š Boxe</option>
                                        <option value="MUAY_THAI">ðŸ¦µ Muay Thai</option>
                                        <option value="KARATE">ðŸ¥‹ KaratÃª</option>
                                        <option value="TAEKWONDO">ðŸ¦µ Taekwondo</option>
                                        <option value="MMA">ðŸ¥Š MMA</option>
                                        <option value="CAPOEIRA">ðŸ¤¸ Capoeira</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="beltLevel">Faixa/NÃ­vel *</label>
                                    <select id="beltLevel" required onchange="updateBeltInfo()">
                                        <option value="">Primeiro selecione a arte</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="courseGraduation">GraduaÃ§Ã£o/Grau</label>
                                    <select id="courseGraduation">
                                        <option value="">Sem graduaÃ§Ã£o</option>
                                        <option value="1">1Âº Grau</option>
                                        <option value="2">2Âº Grau</option>
                                        <option value="3">3Âº Grau</option>
                                        <option value="4">4Âº Grau</option>
                                        <option value="5">5Âº Grau</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="beltInfo" style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #3B82F6; display: none;">
                                <div id="beltInfoContent"></div>
                            </div>
                        </div>
                    </div>

                    <!-- RAG Status Indicator -->
                    <div id="ragStatus" style="margin-bottom: 1rem;">
                        <!-- RAG status will be populated dynamically -->
                    </div>
                    
                    <!-- Course Basic Info -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ“š InformaÃ§Ãµes do Curso</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="universalCourseTitle">Nome do Curso *</label>
                                    <input type="text" id="universalCourseTitle" placeholder="Ex: Jiu-Jitsu Faixa Azul - TÃ©cnicas AvanÃ§adas" required>
                                </div>
                                <div class="form-group">
                                    <label for="universalCourseDuration">DuraÃ§Ã£o (semanas) *</label>
                                    <input type="number" id="universalCourseDuration" value="20" min="4" max="52" required>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="universalCourseLevel">NÃ­vel de Dificuldade</label>
                                    <select id="universalCourseLevel">
                                        <option value="BEGINNER">â­ Iniciante</option>
                                        <option value="INTERMEDIATE">â­â­ IntermediÃ¡rio</option>
                                        <option value="ADVANCED">â­â­â­ AvanÃ§ado</option>
                                        <option value="EXPERT">â­â­â­â­ Expert</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="lessonsPerWeekUniversal">Aulas por Semana</label>
                                    <select id="lessonsPerWeekUniversal">
                                        <option value="1">1 aula</option>
                                        <option value="2" selected>2 aulas</option>
                                        <option value="3">3 aulas</option>
                                        <option value="4">4 aulas</option>
                                        <option value="5">5 aulas</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="universalCourseObjectives">Objetivos do Curso</label>
                                <textarea id="universalCourseObjectives" rows="3" placeholder="Descreva os objetivos principais do curso..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Technique Selection -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ¥Š SeleÃ§Ã£o de TÃ©cnicas</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #3B82F6;">
                                <h4 style="color: #3B82F6; margin-bottom: 0.5rem;">ðŸ’¡ EstratÃ©gia de SeleÃ§Ã£o</h4>
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1;">
                                        <input type="radio" name="selectionStrategy" value="reuse" checked>
                                        <span>ðŸ”„ Reutilizar do Faixa Branca + Novas</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1;">
                                        <input type="radio" name="selectionStrategy" value="fresh">
                                        <span>ðŸ†• SeleÃ§Ã£o Completamente Nova</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1;">
                                        <input type="radio" name="selectionStrategy" value="custom">
                                        <span>âš™ï¸ SeleÃ§Ã£o Manual</span>
                                    </label>
                                </div>
                            </div>

                            <div id="techniqueSelectionArea" style="border: 1px solid #374151; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                                <div style="padding: 2rem; text-align: center; color: #CBD5E1;">
                                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸŽ¯</div>
                                    Carregando banco de tÃ©cnicas para seleÃ§Ã£o...
                                </div>
                            </div>

                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="color: #F59E0B; font-weight: bold;">TÃ©cnicas Selecionadas:</span>
                                    <span id="selectedTechniquesCount" style="color: #F8FAFC;">0</span>
                                </div>
                                <div id="selectedTechniquesList" style="color: #CBD5E1; font-size: 0.9rem;">
                                    Nenhuma tÃ©cnica selecionada ainda
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Document Upload for Yellow Belt -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ“„ Seu Modelo de Curso</h3>
                        <div style="border: 2px dashed #374151; border-radius: 12px; padding: 2rem; text-align: center; background: rgba(55, 65, 81, 0.3);">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“‹</div>
                            <input type="file" id="courseModelFile" accept=".pdf,.doc,.docx,.txt,.md" 
                                   style="display: none;" onchange="handleCourseModelUpload(event)">
                            <button type="button" onclick="document.getElementById('yellowBeltModel').click()" 
                                    style="background: #F59E0B; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; margin-bottom: 1rem;">
                                ðŸ“Ž Upload Modelo de Curso
                            </button>
                            <p style="color: #CBD5E1; font-size: 0.9rem;">
                                FaÃ§a upload do seu modelo de curso (opcional)<br>
                                A IA usarÃ¡ este documento para estruturar o curso
                            </p>
                            <div id="courseModelFileInfo" style="margin-top: 1rem;"></div>
                        </div>
                    </div>

                    <!-- AI Configuration -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ¤– ConfiguraÃ§Ã£o da IA</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">ðŸŽ¯ Gerar Planos de Aula</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="universalGeneratePlans" checked>
                                    <span style="color: #CBD5E1;">Gerar automaticamente todos os planos</span>
                                </div>
                            </div>
                            <div>
                                <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">ðŸ¤– Modelo IA</label>
                                <select id="universalAiModel" style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #374151; background: rgba(55, 65, 81, 0.5); color: #F8FAFC;">
                                    <option value="claude-3">Claude 3 (Recomendado)</option>
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="gemini">Gemini</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="color: #CBD5E1; font-size: 0.9rem;">
                        â±ï¸ Tempo estimado: 5-8 minutos
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="closeUniversalCourseModal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="createUniversalCourse()" id="createUniversalBtn">
                            <span>ðŸŽ­</span> Criar Curso
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Technique Audit Modal -->
    <div id="techniqueAuditModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>ðŸ” Auditoria de TÃ©cnica</h2>
                <button class="btn btn-secondary" onclick="closeTechniqueAuditModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="techniqueAuditContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="approveTechnique()" id="approveBtn">
                    <span>âœ…</span> Aprovar
                </button>
                <button class="btn btn-warning" onclick="editTechnique()" id="editBtn" style="margin-left: 1rem;">
                    <span>âœï¸</span> Editar
                </button>
                <button class="btn btn-danger" onclick="rejectTechnique()" id="rejectBtn" style="margin-left: 1rem;">
                    <span>âŒ</span> Rejeitar
                </button>
                <button class="btn btn-secondary" onclick="closeTechniqueAuditModal()" style="margin-left: 1rem;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Video Upload Modal -->
    <div id="videoUploadModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>ðŸ“¹ Upload de VÃ­deo - TÃ©cnica</h2>
                <button class="btn btn-secondary" onclick="closeVideoUploadModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 1.5rem;">
                    <div id="videoTechniqueInfo" style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                        <!-- Technique info will be shown here -->
                    </div>
                    
                    <div style="border: 2px dashed #374151; border-radius: 12px; padding: 2rem; text-align: center; background: rgba(55, 65, 81, 0.3);">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“¹</div>
                        <input type="file" id="techniqueVideo" accept="video/*" 
                               style="display: none;" onchange="handleVideoUpload(event)">
                        <button type="button" onclick="document.getElementById('techniqueVideo').click()" 
                                style="background: #3B82F6; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; margin-bottom: 1rem;">
                            ðŸ“Ž Selecionar VÃ­deo
                        </button>
                        <p style="color: #CBD5E1; font-size: 0.9rem;">
                            Formatos aceitos: MP4, AVI, MOV<br>
                            Tamanho mÃ¡ximo: 100MB
                        </p>
                        <div id="videoPreview" style="margin-top: 1rem;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="videoDescription">DescriÃ§Ã£o do VÃ­deo</label>
                        <textarea id="videoDescription" rows="3" placeholder="Descreva o que estÃ¡ sendo demonstrado no vÃ­deo..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="uploadVideo()" id="uploadVideoBtn">
                    <span>ðŸš€</span> Upload VÃ­deo
                </button>
                <button class="btn btn-secondary" onclick="closeVideoUploadModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Document Uploader Modal -->
    <div id="documentUploaderModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>ðŸ“Ž Adicionar ConteÃºdo Ã  Base de Conhecimento</h2>
                <button class="btn btn-secondary" onclick="closeDocumentUploader()">âœ•</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 2rem;">
                    
                    <!-- Upload Tabs -->
                    <div style="display: flex; gap: 1rem; border-bottom: 1px solid #374151; padding-bottom: 1rem;">
                        <button class="upload-tab active" onclick="switchUploadTab('documents')" id="documentsTab">
                            ðŸ“„ Documentos
                        </button>
                        <button class="upload-tab" onclick="switchUploadTab('text')" id="textTab">
                            ðŸ“ Texto Manual
                        </button>
                        <button class="upload-tab" onclick="switchUploadTab('links')" id="linksTab">
                            ðŸ”— Links/URLs
                        </button>
                        <button class="upload-tab" onclick="switchUploadTab('youtube')" id="youtubeTab">
                            ðŸ“º YouTube
                        </button>
                    </div>
                    
                    <!-- Document Upload Section -->
                    <div id="documentsSection" class="upload-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ“„ Upload de Documentos</h3>
                        <div style="border: 2px dashed #374151; border-radius: 12px; padding: 2rem; text-align: center; background: rgba(55, 65, 81, 0.3);">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“</div>
                            <input type="file" id="documentFiles" multiple accept=".pdf,.doc,.docx,.txt,.md,.rtf" 
                                   style="display: none;" onchange="handleDocumentUpload(event)">
                            <button type="button" onclick="document.getElementById('documentFiles').click()" 
                                    style="background: #8B5CF6; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; margin-bottom: 1rem;">
                                ðŸ“Ž Selecionar Documentos
                            </button>
                            <p style="color: #CBD5E1; font-size: 0.9rem;">
                                Formatos aceitos: PDF, DOC, DOCX, TXT, MD, RTF<br>
                                MÃºltiplos arquivos permitidos â€¢ Tamanho mÃ¡ximo: 50MB por arquivo
                            </p>
                            <div id="documentPreview" style="margin-top: 1rem;"></div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 1rem;">
                            <label for="documentTags">Tags (separadas por vÃ­rgula)</label>
                            <input type="text" id="documentTags" placeholder="krav-maga, defesa-pessoal, iniciante, faixa-branca">
                        </div>
                    </div>
                    
                    <!-- Text Input Section -->
                    <div id="textSection" class="upload-section" style="display: none;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ“ Adicionar Texto Manual</h3>
                        <div class="form-group">
                            <label for="textTitle">TÃ­tulo do ConteÃºdo *</label>
                            <input type="text" id="textTitle" placeholder="Ex: PrincÃ­pios Fundamentais do Krav Maga" required>
                        </div>
                        <div class="form-group">
                            <label for="textContent">ConteÃºdo *</label>
                            <textarea id="textContent" rows="12" placeholder="Cole aqui seu conteÃºdo de texto, manuais, instruÃ§Ãµes, metodologias..." required></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="textCategory">Categoria</label>
                                <select id="textCategory">
                                    <option value="">Selecione</option>
                                    <option value="METHODOLOGY">Metodologia</option>
                                    <option value="TECHNIQUES">TÃ©cnicas</option>
                                    <option value="THEORY">Teoria</option>
                                    <option value="SAFETY">SeguranÃ§a</option>
                                    <option value="PROGRESSION">ProgressÃ£o</option>
                                    <option value="EVALUATION">AvaliaÃ§Ã£o</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="textTags">Tags</label>
                                <input type="text" id="textTags" placeholder="defesa, ataque, movimento">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Links Section -->
                    <div id="linksSection" class="upload-section" style="display: none;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ”— Adicionar Links/URLs</h3>
                        <div class="form-group">
                            <label for="linkUrl">URL *</label>
                            <input type="url" id="linkUrl" placeholder="https://exemplo.com/artigo-sobre-krav-maga" required>
                        </div>
                        <div class="form-group">
                            <label for="linkTitle">TÃ­tulo (opcional)</label>
                            <input type="text" id="linkTitle" placeholder="SerÃ¡ extraÃ­do automaticamente se nÃ£o preenchido">
                        </div>
                        <div class="form-group">
                            <label for="linkDescription">DescriÃ§Ã£o</label>
                            <textarea id="linkDescription" rows="3" placeholder="Breve descriÃ§Ã£o sobre o conteÃºdo do link"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="linkTags">Tags</label>
                            <input type="text" id="linkTags" placeholder="artigo, externa, referÃªncia">
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <div style="color: #3B82F6; font-weight: bold; margin-bottom: 0.5rem;">â„¹ï¸ ExtraÃ§Ã£o AutomÃ¡tica</div>
                            <div style="color: #CBD5E1; font-size: 0.9rem;">
                                O sistema irÃ¡ extrair automaticamente o texto do site e indexar o conteÃºdo.
                            </div>
                        </div>
                    </div>
                    
                    <!-- YouTube Section -->
                    <div id="youtubeSection" class="upload-section" style="display: none;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ“º VÃ­deos do YouTube</h3>
                        <div class="form-group">
                            <label for="youtubeUrl">URL do YouTube *</label>
                            <input type="url" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=..." required>
                        </div>
                        <div class="form-group">
                            <label for="youtubeDescription">DescriÃ§Ã£o do ConteÃºdo</label>
                            <textarea id="youtubeDescription" rows="3" placeholder="Descreva o que Ã© abordado no vÃ­deo"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="youtubeTags">Tags</label>
                            <input type="text" id="youtubeTags" placeholder="video, demonstraÃ§Ã£o, tutorial">
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <div style="color: #F59E0B; font-weight: bold; margin-bottom: 0.5rem;">ðŸŽ¯ ExtraÃ§Ã£o de TranscriÃ§Ã£o</div>
                            <div style="color: #CBD5E1; font-size: 0.9rem;">
                                O sistema irÃ¡ extrair a transcriÃ§Ã£o automÃ¡tica do vÃ­deo (se disponÃ­vel) e indexar o conteÃºdo.
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="uploadContent()" id="uploadContentBtn">
                    <span>ðŸš€</span> Adicionar Ã  Base
                </button>
                <button class="btn btn-secondary" onclick="closeDocumentUploader()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- RAG Test Modal -->
    <div id="ragTestModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>ðŸ§ª Teste do Sistema RAG</h2>
                <button class="btn btn-secondary" onclick="closeRAGTest()">âœ•</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 1.5rem;">
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                        <h4 style="color: #3B82F6; margin-bottom: 0.5rem;">ðŸŽ¯ Como Funciona o Teste</h4>
                        <div style="color: #CBD5E1; font-size: 0.9rem;">
                            FaÃ§a uma pergunta ou solicite informaÃ§Ãµes. A IA irÃ¡ buscar na sua base de conhecimento 
                            e retornar uma resposta baseada nos seus documentos.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ragQuestion">Sua Pergunta</label>
                        <textarea id="ragQuestion" rows="3" placeholder="Ex: Como ensinar defesa contra agarramento para iniciantes?"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="ragMartialArt">Arte Marcial (opcional)</label>
                            <select id="ragMartialArt">
                                <option value="">Todas</option>
                                <option value="KRAV_MAGA">Krav Maga</option>
                                <option value="JIU_JITSU">Jiu-Jitsu</option>
                                <option value="BOXING">Boxe</option>
                                <option value="MUAY_THAI">Muay Thai</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ragLevel">NÃ­vel (opcional)</label>
                            <select id="ragLevel">
                                <option value="">Todos</option>
                                <option value="BEGINNER">Iniciante</option>
                                <option value="INTERMEDIATE">IntermediÃ¡rio</option>
                                <option value="ADVANCED">AvanÃ§ado</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="ragResults" style="min-height: 200px; background: rgba(55, 65, 81, 0.3); border-radius: 8px; padding: 1rem;">
                        <div style="text-align: center; color: #9CA3AF; padding: 2rem;">
                            Digite sua pergunta e clique em "Consultar RAG" para ver a resposta
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="consultRAG()" id="consultRAGBtn">
                    <span>ðŸ§ </span> Consultar RAG
                </button>
                <button class="btn btn-secondary" onclick="closeRAGTest()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- AI Course Generator Modal -->
    <div id="aiCourseGeneratorModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>ðŸŽ¯ Gerador IA de Curso Completo</h2>
                <button class="btn btn-secondary" onclick="closeAICourseGeneratorModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 2rem;">
                    <!-- Modo de CriaÃ§Ã£o -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸŽ›ï¸ Modo de CriaÃ§Ã£o</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="creation-mode-card" onclick="selectCreationMode('scratch')" 
                                 style="padding: 1.5rem; border: 2px solid #374151; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸš€</div>
                                <h4 style="color: #F8FAFC; margin-bottom: 0.5rem;">Do Zero</h4>
                                <p style="color: #CBD5E1; font-size: 0.9rem;">IA cria tudo baseado apenas nas informaÃ§Ãµes bÃ¡sicas</p>
                            </div>
                            <div class="creation-mode-card" onclick="selectCreationMode('document')" 
                                 style="padding: 1.5rem; border: 2px solid #374151; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ“„</div>
                                <h4 style="color: #F8FAFC; margin-bottom: 0.5rem;">Com Documentos</h4>
                                <p style="color: #CBD5E1; font-size: 0.9rem;">IA usa documentos modelo, curriculums, planos existentes</p>
                            </div>
                        </div>
                        <input type="hidden" id="creationMode" value="">
                    </div>

                    <!-- InformaÃ§Ãµes BÃ¡sicas do Curso -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ“š InformaÃ§Ãµes BÃ¡sicas</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="courseTitle">Nome do Curso *</label>
                                    <input type="text" id="courseTitle" placeholder="Ex: Krav Maga Faixa Preta - Instrutor" required>
                                </div>
                                <div class="form-group">
                                    <label for="courseDuration">DuraÃ§Ã£o (semanas) *</label>
                                    <input type="number" id="courseDuration" min="1" max="52" value="24" required>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="courseLevel">NÃ­vel *</label>
                                    <select id="courseLevel" required>
                                        <option value="">Selecione</option>
                                        <option value="INICIANTE">Iniciante</option>
                                        <option value="INTERMEDIARIO">IntermediÃ¡rio</option>
                                        <option value="AVANCADO">AvanÃ§ado</option>
                                        <option value="INSTRUTOR">Instrutor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="courseCategory">Categoria *</label>
                                    <select id="courseCategory" required>
                                        <option value="">Selecione</option>
                                        <option value="ADULT">Adulto</option>
                                        <option value="KIDS">Infantil</option>
                                        <option value="TEEN">Adolescente</option>
                                        <option value="SENIOR">Terceira Idade</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="lessonsPerWeek">Aulas por Semana</label>
                                    <select id="lessonsPerWeek">
                                        <option value="1">1 aula</option>
                                        <option value="2" selected>2 aulas</option>
                                        <option value="3">3 aulas</option>
                                        <option value="4">4 aulas</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="courseObjectives">Objetivos Principais</label>
                                <textarea id="courseObjectives" rows="3" 
                                          placeholder="Ex: Desenvolver habilidades de defesa pessoal, aumentar condicionamento fÃ­sico, preparar instrutores..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Upload de Documentos -->
                    <div class="form-section" id="documentSection" style="display: none;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ“ Documentos e Contexto</h3>
                        <div style="display: grid; gap: 1.5rem;">
                            
                            <!-- Templates PrÃ©-definidos -->
                            <div>
                                <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">ðŸŽ¯ Templates DisponÃ­veis</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <button type="button" class="template-btn" onclick="loadTemplate('krav-maga-basic')" 
                                            style="padding: 0.75rem; background: rgba(59, 130, 246, 0.2); border: 1px solid #3B82F6; border-radius: 8px; color: #3B82F6; cursor: pointer;">
                                        ðŸ¥‹ Krav Maga BÃ¡sico
                                    </button>
                                    <button type="button" class="template-btn" onclick="loadTemplate('self-defense')" 
                                            style="padding: 0.75rem; background: rgba(16, 185, 129, 0.2); border: 1px solid #10B981; border-radius: 8px; color: #10B981; cursor: pointer;">
                                        ðŸ›¡ï¸ Defesa Pessoal
                                    </button>
                                    <button type="button" class="template-btn" onclick="loadTemplate('instructor')" 
                                            style="padding: 0.75rem; background: rgba(245, 158, 11, 0.2); border: 1px solid #F59E0B; border-radius: 8px; color: #F59E0B; cursor: pointer;">
                                        ðŸ‘¨â€ðŸ« FormaÃ§Ã£o Instrutor
                                    </button>
                                </div>
                            </div>

                            <!-- Upload de Arquivos -->
                            <div>
                                <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">ðŸ“Ž Upload de Documentos</label>
                                <div style="border: 2px dashed #374151; border-radius: 12px; padding: 2rem; text-align: center; background: rgba(55, 65, 81, 0.3);">
                                    <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“</div>
                                    <input type="file" id="courseDocuments" multiple accept=".pdf,.doc,.docx,.txt,.md" 
                                           style="display: none;" onchange="handleFileUpload(event)">
                                    <button type="button" onclick="document.getElementById('courseDocuments').click()" 
                                            style="background: #3B82F6; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; margin-bottom: 1rem;">
                                        Selecionar Arquivos
                                    </button>
                                    <p style="color: #CBD5E1; font-size: 0.9rem;">
                                        Aceita: PDF, DOC, DOCX, TXT, MD<br>
                                        <strong>SugestÃµes:</strong> Curriculums, planos modelo, regulamentos, metodologias
                                    </p>
                                    <div id="uploadedFiles" style="margin-top: 1rem;"></div>
                                </div>
                            </div>

                            <!-- Contexto Adicional -->
                            <div>
                                <label for="additionalContext" style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">ðŸ’­ Contexto Adicional</label>
                                <textarea id="additionalContext" rows="4" 
                                          placeholder="InformaÃ§Ãµes especÃ­ficas: metodologia preferida, restriÃ§Ãµes, adaptaÃ§Ãµes necessÃ¡rias, experiÃªncias anteriores, cultura da academia, etc."
                                          style="width: 100%; padding: 1rem; background: rgba(55, 65, 81, 0.5); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC;"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- ConfiguraÃ§Ãµes AvanÃ§adas -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">âš™ï¸ ConfiguraÃ§Ãµes AvanÃ§adas</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">ðŸŽ¯ Gerar Planos de Aula</label>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="generateLessonPlans" checked>
                                        <span style="color: #CBD5E1;">Gerar automaticamente todos os planos de aula</span>
                                    </div>
                                </div>
                                <div>
                                    <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">ðŸ† Incluir AvaliaÃ§Ãµes</label>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="includeEvaluations" checked>
                                        <span style="color: #CBD5E1;">Criar sistema de avaliaÃ§Ãµes e exames</span>
                                    </div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">ðŸ§© AdaptaÃ§Ãµes Especiais</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.25rem; color: #CBD5E1; margin-right: 1rem;">
                                            <input type="checkbox" name="adaptations" value="TEA">
                                            <span>TEA</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.25rem; color: #CBD5E1; margin-right: 1rem;">
                                            <input type="checkbox" name="adaptations" value="TDAH">
                                            <span>TDAH</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.25rem; color: #CBD5E1;">
                                            <input type="checkbox" name="adaptations" value="MOBILIDADE_REDUZIDA">
                                            <span>Mobilidade Reduzida</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label for="aiModel" style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">ðŸ¤– Modelo de IA</label>
                                    <select id="aiModel">
                                        <option value="gpt-4">GPT-4 (Mais criativo)</option>
                                        <option value="claude-3">Claude 3 (Mais estruturado)</option>
                                        <option value="gemini">Gemini (Balanceado)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="color: #CBD5E1; font-size: 0.9rem;">
                        â±ï¸ Tempo estimado: 3-5 minutos
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="closeAICourseGeneratorModal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="generateCourseWithAI()" id="generateCourseBtn">
                            <span>ðŸŽ¯</span> Gerar Curso Completo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Lesson Generator Modal -->
    <div id="aiGeneratorModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>ðŸ¤– Gerador IA de Planos de Aula</h2>
                <button class="btn btn-secondary" onclick="closeAIGeneratorModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <form id="aiGeneratorForm" style="display: grid; gap: 1.5rem;">
                    <div class="form-group">
                        <label for="aiLessonNumber">NÃºmero da Aula</label>
                        <input type="number" id="aiLessonNumber" min="1" max="48" value="16" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="aiLessonUnit">Unidade do Curriculum</label>
                        <select id="aiLessonUnit" required>
                            <option value="">Selecione uma unidade</option>
                            <option value="fundamentos">ðŸ¥Š Fundamentos (Aulas 1-10)</option>
                            <option value="golpes">ðŸ‘Š Golpes BÃ¡sicos (Aulas 4-15)</option>
                            <option value="defesas">ðŸ›¡ï¸ Defesas BÃ¡sicas (Aulas 10-25)</option>
                            <option value="avancadas">âš”ï¸ Defesas AvanÃ§adas (Aulas 25-35)</option>
                            <option value="integracao">ðŸŽ­ IntegraÃ§Ã£o (Aulas 35-48)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="aiMainTechnique">TÃ©cnica Principal</label>
                        <input type="text" id="aiMainTechnique" placeholder="Ex: Defesa 360Â° Interior" required>
                    </div>

                    <div class="form-group">
                        <label for="aiLessonObjectives">Objetivos da Aula</label>
                        <textarea id="aiLessonObjectives" rows="3" 
                                  placeholder="Ex: Desenvolver coordenaÃ§Ã£o motora, Aplicar tÃ©cnica em cenÃ¡rio real..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="aiSpecialNeeds">AdaptaÃ§Ãµes Especiais</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1;">
                                <input type="checkbox" id="aiTEA" value="TEA">
                                <span>TEA</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1;">
                                <input type="checkbox" id="aiTDAH" value="TDAH">
                                <span>TDAH</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1;">
                                <input type="checkbox" id="aiMobilidade" value="MOBILIDADE_REDUZIDA">
                                <span>Mobilidade Reduzida</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="aiDifficulty">NÃ­vel de Dificuldade</label>
                        <select id="aiDifficulty" required>
                            <option value="1">â­ Iniciante</option>
                            <option value="2">â­â­ IntermediÃ¡rio</option>
                            <option value="3">â­â­â­ AvanÃ§ado</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAIGeneratorModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="generateLessonPlanWithAI()">
                    <span>ðŸ¤–</span> Gerar Plano com IA
                </button>
            </div>
        </div>
    </div>

    <script>
        // Utility function to reduce console noise in production
        function logQuiet(message, ...args) {
            // Only log important messages to reduce noise
            if (message.includes('âœ…') || message.includes('âŒ') || message.includes('âš ï¸')) {
                console.log(message, ...args);
            }
        }

        // ==========================================
        // TECHNIQUES MANAGER FUNCTIONALITY
        // ==========================================

        let allTechniques = [];
        let selectedTechniques = [];
        let courseModelFile = null;
        let beltSystems = {};
        let auditResults = [];
        let pendingTechniques = [];
        
        // RAG System Variables (declared in main script section)

        // Open Techniques Manager Modal
        function openTechniquesManager() {
            document.getElementById('techniquesManagerModal').classList.add('active');
            loadTechniquesDatabase();
        }

        // Close Techniques Manager Modal
        function closeTechniquesManagerModal() {
            document.getElementById('techniquesManagerModal').classList.remove('active');
        }

        // Load techniques database
        async function loadTechniquesDatabase() {
            try {
                // Generate mock techniques based on existing course data
                allTechniques = generateMockTechniques();
                displayTechniquesTable(allTechniques);
                updateTechniquesStats();
            } catch (error) {
                console.error('Erro ao carregar tÃ©cnicas:', error);
                showToast('Erro ao carregar banco de tÃ©cnicas', 'error');
            }
        }

        // Generate mock techniques database with audit status
        function generateMockTechniques() {
            const techniques = [
                // Krav Maga - Beginner (Practitioner 1)
                { id: '1', name: 'Guarda de Boxe', category: 'STANCE', level: 'BEGINNER', martialArt: 'KRAV_MAGA', usedIn: ['Practitioner 1'], prerequisites: '', isPreviousLevel: false, status: 'APPROVED', videoUrl: null, auditScore: 98 },
                { id: '2', name: 'Jab (Soco Direto)', category: 'STRIKE', level: 'BEGINNER', martialArt: 'KRAV_MAGA', usedIn: ['Practitioner 1'], prerequisites: 'Guarda de Boxe', isPreviousLevel: false, status: 'APPROVED', videoUrl: null, auditScore: 95 },
                { id: '3', name: 'Cross (Soco Cruzado)', category: 'STRIKE', level: 'BEGINNER', martialArt: 'KRAV_MAGA', usedIn: ['Practitioner 1'], prerequisites: 'Guarda de Boxe, Jab', isPreviousLevel: false },
                { id: '4', name: 'Hook (Gancho)', category: 'STRIKE', level: 'BEGINNER', martialArt: 'KRAV_MAGA', usedIn: ['Practitioner 1'], prerequisites: 'Jab, Cross', isPreviousLevel: false },
                { id: '5', name: 'Uppercut', category: 'STRIKE', level: 'BEGINNER', martialArt: 'KRAV_MAGA', usedIn: ['Practitioner 1'], prerequisites: 'Hook', isPreviousLevel: false },
                { id: '6', name: 'Defesa 360Â° Interior', category: 'DEFENSE', level: 'BEGINNER', usedIn: ['Faixa Branca'], prerequisites: 'Guarda de Boxe', isFromWhiteBelt: true },
                { id: '7', name: 'Defesa 360Â° Exterior', category: 'DEFENSE', level: 'BEGINNER', usedIn: ['Faixa Branca'], prerequisites: 'Defesa 360Â° Interior', isFromWhiteBelt: true },
                { id: '8', name: 'Joelhada Frontal', category: 'STRIKE', level: 'BEGINNER', usedIn: ['Faixa Branca'], prerequisites: 'Guarda de Boxe', isFromWhiteBelt: true },
                { id: '9', name: 'Chute Frontal', category: 'STRIKE', level: 'BEGINNER', usedIn: ['Faixa Branca'], prerequisites: 'Joelhada Frontal', isFromWhiteBelt: true },
                { id: '10', name: 'Esquiva Lateral', category: 'MOVEMENT', level: 'BEGINNER', usedIn: ['Faixa Branca'], prerequisites: 'MovimentaÃ§Ã£o BÃ¡sica', isFromWhiteBelt: true },
                
                // Jiu-Jitsu techniques
                { id: '23', name: 'Closed Guard', category: 'GRAPPLING', level: 'BEGINNER', martialArt: 'JIU_JITSU', usedIn: ['White Belt'], prerequisites: '', isPreviousLevel: false },
                { id: '24', name: 'Armbar from Guard', category: 'GRAPPLING', level: 'INTERMEDIATE', martialArt: 'JIU_JITSU', usedIn: ['Blue Belt'], prerequisites: 'Closed Guard', isPreviousLevel: false },
                { id: '25', name: 'Triangle Choke', category: 'GRAPPLING', level: 'INTERMEDIATE', martialArt: 'JIU_JITSU', usedIn: ['Blue Belt'], prerequisites: 'Closed Guard', isPreviousLevel: false },
                
                // Boxing techniques
                { id: '26', name: 'Orthodox Stance', category: 'STANCE', level: 'BEGINNER', martialArt: 'BOXING', usedIn: ['Beginner'], prerequisites: '', isPreviousLevel: false },
                { id: '27', name: 'Slip and Counter', category: 'COMBO', level: 'INTERMEDIATE', martialArt: 'BOXING', usedIn: ['Amateur'], prerequisites: 'Orthodox Stance, Jab', isPreviousLevel: false },
                
                // Muay Thai techniques
                { id: '28', name: 'Fighting Stance', category: 'STANCE', level: 'BEGINNER', martialArt: 'MUAY_THAI', usedIn: ['White Prajioud'], prerequisites: '', isPreviousLevel: false },
                { id: '29', name: 'Roundhouse Kick', category: 'STRIKE', level: 'INTERMEDIATE', martialArt: 'MUAY_THAI', usedIn: ['Yellow Prajioud'], prerequisites: 'Fighting Stance', isPreviousLevel: false },
                
                // General techniques (work for all martial arts)
                { id: '30', name: 'Basic Conditioning', category: 'CONDITIONING', level: 'BEGINNER', martialArt: 'GENERAL', usedIn: ['All Levels'], prerequisites: '', isPreviousLevel: false },
                { id: '31', name: 'Situational Awareness', category: 'SCENARIO', level: 'BEGINNER', martialArt: 'GENERAL', usedIn: ['All Levels'], prerequisites: '', isPreviousLevel: false },
                
                // Krav Maga - Intermediate
                { id: '11', name: 'Defesa 360Â° Superior', category: 'DEFENSE', level: 'INTERMEDIATE', martialArt: 'KRAV_MAGA', usedIn: [], prerequisites: 'Defesa 360Â° Interior, Defesa 360Â° Exterior', isPreviousLevel: false },
                { id: '12', name: 'Combo Jab-Cross-Hook', category: 'COMBO', level: 'INTERMEDIATE', martialArt: 'KRAV_MAGA', usedIn: [], prerequisites: 'Jab, Cross, Hook', isPreviousLevel: false },
                { id: '13', name: 'Defesa contra Agarramento de Ombros', category: 'DEFENSE', level: 'INTERMEDIATE', martialArt: 'KRAV_MAGA', usedIn: [], prerequisites: 'Defesa 360Â°', isPreviousLevel: false },
                { id: '14', name: 'Cotovelo Horizontal', category: 'STRIKE', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Joelhada Frontal', isFromWhiteBelt: false },
                { id: '15', name: 'Chute Lateral', category: 'STRIKE', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Chute Frontal', isFromWhiteBelt: false },
                { id: '16', name: 'Defesa contra Estrangulamento Lateral', category: 'DEFENSE', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Defesa contra Estrangulamento Frontal', isFromWhiteBelt: false },
                { id: '17', name: 'LiberaÃ§Ã£o de Pegada no Punho', category: 'DEFENSE', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'MovimentaÃ§Ã£o BÃ¡sica', isFromWhiteBelt: false },
                { id: '18', name: 'Defesa contra EmpurrÃ£o', category: 'DEFENSE', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Esquiva Lateral', isFromWhiteBelt: false },
                { id: '19', name: 'Joelhada Diagonal', category: 'STRIKE', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Joelhada Frontal', isFromWhiteBelt: false },
                { id: '20', name: 'Combo Defesa-Contra-Ataque', category: 'COMBO', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Defesa 360Â°, Jab-Cross', isFromWhiteBelt: false },
                
                // AvanÃ§adas para futuras faixas
                { id: '21', name: 'Defesa contra MÃºltiplos Atacantes', category: 'SCENARIO', level: 'ADVANCED', martialArt: 'KRAV_MAGA', usedIn: [], prerequisites: 'Combo Defesa-Contra-Ataque', isPreviousLevel: false },
                { id: '22', name: 'FinalizaÃ§Ã£o e Fuga', category: 'SCENARIO', level: 'ADVANCED', martialArt: 'KRAV_MAGA', usedIn: [], prerequisites: 'Defesa contra MÃºltiplos Atacantes', isPreviousLevel: false }
            ];

            return techniques.map(tech => ({
                ...tech,
                description: generateTechniqueDescription(tech),
                instructions: generateTechniqueInstructions(tech),
                keyPoints: generateTechniqueKeyPoints(tech),
                equipment: generateTechniqueEquipment(tech.category),
                duration: getTechniqueDuration(tech.level),
                // Audit fields
                status: tech.status || 'PENDING',
                auditScore: tech.auditScore || null,
                duplicateOf: null,
                qualityIssues: [],
                videoUrl: tech.videoUrl || null,
                createdAt: new Date().toISOString(),
                lastAuditAt: tech.status === 'APPROVED' ? new Date().toISOString() : null
            }));
        }

        // Display techniques table
        function displayTechniquesTable(techniques) {
            const tbody = document.getElementById('techniquesTableBody');
            
            if (techniques.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 2rem; text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸ”</div>
                            Nenhuma tÃ©cnica encontrada
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = techniques.map(tech => `
                <tr style="border-bottom: 1px solid #374151;">
                    <td style="padding: 1rem;">
                        <div style="font-weight: bold; color: #F8FAFC; margin-bottom: 0.25rem;">${tech.name}</div>
                        <div style="font-size: 0.8rem; color: #9CA3AF;">${tech.description}</div>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="background: ${getCategoryColor(tech.category)}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                            ${getCategoryIcon(tech.category)} ${getCategoryName(tech.category)}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="color: ${getLevelColor(tech.level)};">
                            ${'â­'.repeat(getLevelStars(tech.level))} ${getLevelName(tech.level)}
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="color: #CBD5E1;">
                            ${tech.usedIn.length > 0 ? tech.usedIn.join(', ') : 'NÃ£o usado'}
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="color: #9CA3AF; font-size: 0.8rem;">
                            ${tech.prerequisites || 'Nenhum'}
                        </div>
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="viewTechniqueDetails('${tech.id}')" style="background: #3B82F6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">
                                ðŸ‘ï¸
                            </button>
                            <button onclick="editTechnique('${tech.id}')" style="background: #F59E0B; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">
                                âœï¸
                            </button>
                            <button onclick="deleteTechnique('${tech.id}')" style="background: #EF4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">
                                ðŸ—‘ï¸
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update techniques stats
        function updateTechniquesStats() {
            document.getElementById('totalTechniquesCount').textContent = allTechniques.length;
            document.getElementById('categoriesCount').textContent = new Set(allTechniques.map(t => t.category)).size;
            document.getElementById('coursesUsingCount').textContent = new Set(allTechniques.flatMap(t => t.usedIn)).size;
            document.getElementById('reusedCount').textContent = allTechniques.filter(t => t.usedIn.length > 0).length;
        }

        // Helper functions for technique display
        function getCategoryColor(category) {
            const colors = {
                'STANCE': '#3B82F6',
                'STRIKE': '#EF4444', 
                'DEFENSE': '#10B981',
                'GRAPPLING': '#8B5CF6',
                'COMBO': '#F59E0B',
                'MOVEMENT': '#06B6D4',
                'SCENARIO': '#EC4899',
                'CONDITIONING': '#84CC16'
            };
            return colors[category] || '#6B7280';
        }

        function getCategoryIcon(category) {
            const icons = {
                'STANCE': 'ðŸ¥‹',
                'STRIKE': 'ðŸ‘Š',
                'DEFENSE': 'ðŸ›¡ï¸',
                'GRAPPLING': 'ðŸ¤¼',
                'COMBO': 'âš¡',
                'MOVEMENT': 'ðŸƒ',
                'SCENARIO': 'ðŸŽ­',
                'CONDITIONING': 'ðŸ’ª'
            };
            return icons[category] || 'ðŸ¥Š';
        }

        function getCategoryName(category) {
            const names = {
                'STANCE': 'Postura',
                'STRIKE': 'Golpe',
                'DEFENSE': 'Defesa',
                'GRAPPLING': 'Agarramento',
                'COMBO': 'CombinaÃ§Ã£o',
                'MOVEMENT': 'Movimento',
                'SCENARIO': 'CenÃ¡rio',
                'CONDITIONING': 'Condicionamento'
            };
            return names[category] || category;
        }

        function getLevelColor(level) {
            const colors = {
                'BEGINNER': '#10B981',
                'INTERMEDIATE': '#F59E0B',
                'ADVANCED': '#EF4444',
                'EXPERT': '#8B5CF6'
            };
            return colors[level] || '#6B7280';
        }

        function getLevelStars(level) {
            const stars = {
                'BEGINNER': 1,
                'INTERMEDIATE': 2,
                'ADVANCED': 3,
                'EXPERT': 4
            };
            return stars[level] || 1;
        }

        function getLevelName(level) {
            const names = {
                'BEGINNER': 'Iniciante',
                'INTERMEDIATE': 'IntermediÃ¡rio',
                'ADVANCED': 'AvanÃ§ado',
                'EXPERT': 'Expert'
            };
            return names[level] || level;
        }

        // Generate technique details
        function generateTechniqueDescription(tech) {
            const descriptions = {
                'STANCE': 'PosiÃ§Ã£o fundamental para execuÃ§Ã£o de tÃ©cnicas',
                'STRIKE': 'TÃ©cnica de ataque direcionada para neutralizar ameaÃ§as',
                'DEFENSE': 'Movimento defensivo para proteÃ§Ã£o contra ataques',
                'GRAPPLING': 'TÃ©cnica de combate prÃ³ximo e controle corporal',
                'COMBO': 'SequÃªncia combinada de movimentos tÃ©cnicos',
                'MOVEMENT': 'PadrÃ£o de movimentaÃ§Ã£o e posicionamento',
                'SCENARIO': 'AplicaÃ§Ã£o prÃ¡tica em situaÃ§Ãµes realÃ­sticas',
                'CONDITIONING': 'ExercÃ­cio para desenvolvimento fÃ­sico especÃ­fico'
            };
            return descriptions[tech.category] || 'TÃ©cnica de Krav Maga';
        }

        function generateTechniqueInstructions(tech) {
            return `1. PosiÃ§Ã£o inicial: ${tech.prerequisites ? 'A partir de ' + tech.prerequisites : 'Postura neutra'}\n2. ExecuÃ§Ã£o da tÃ©cnica ${tech.name}\n3. FinalizaÃ§Ã£o em posiÃ§Ã£o segura\n4. Retorno Ã  guarda`;
        }

        function generateTechniqueKeyPoints(tech) {
            return `Manter postura correta, aplicar forÃ§a adequada, precisÃ£o na execuÃ§Ã£o, fluidez do movimento`;
        }

        function generateTechniqueEquipment(category) {
            const equipment = {
                'STANCE': 'Tatame',
                'STRIKE': 'Tatame, Pads de foco',
                'DEFENSE': 'Tatame, Equipamento de proteÃ§Ã£o',
                'GRAPPLING': 'Tatame, ProteÃ§Ãµes',
                'COMBO': 'Tatame, Pads, Luvas',
                'MOVEMENT': 'Tatame, EspaÃ§o amplo',
                'SCENARIO': 'Tatame, Equipamentos variados',
                'CONDITIONING': 'Tatame, Equipamentos de treino'
            };
            return equipment[category] || 'Tatame';
        }

        function getTechniqueDuration(level) {
            const durations = {
                'BEGINNER': 10,
                'INTERMEDIATE': 15,
                'ADVANCED': 20,
                'EXPERT': 25
            };
            return durations[level] || 10;
        }

        // Technique actions
        function viewTechniqueDetails(techniqueId) {
            const technique = allTechniques.find(t => t.id === techniqueId);
            if (technique) {
                showToast(`Visualizando: ${technique.name}`, 'info');
                // TODO: Open technique details modal
            }
        }

        function editTechnique(techniqueId) {
            const technique = allTechniques.find(t => t.id === techniqueId);
            if (technique) {
                showToast(`Editando: ${technique.name}`, 'info');
                // TODO: Open edit technique modal
            }
        }

        function deleteTechnique(techniqueId) {
            const technique = allTechniques.find(t => t.id === techniqueId);
            if (technique && confirm(`Deseja excluir a tÃ©cnica "${technique.name}"?`)) {
                allTechniques = allTechniques.filter(t => t.id !== techniqueId);
                displayTechniquesTable(allTechniques);
                updateTechniquesStats();
                showToast(`TÃ©cnica "${technique.name}" excluÃ­da`, 'success');
            }
        }

        // Add new technique
        function openAddTechniqueModal() {
            document.getElementById('addTechniqueModal').classList.add('active');
        }

        function closeAddTechniqueModal() {
            document.getElementById('addTechniqueModal').classList.remove('active');
            document.getElementById('addTechniqueForm').reset();
        }

        function saveTechnique() {
            const formData = {
                id: Date.now().toString(),
                name: document.getElementById('techniqueName').value,
                category: document.getElementById('techniqueCategory').value,
                level: document.getElementById('techniqueLevel').value,
                description: document.getElementById('techniqueDescription').value,
                instructions: document.getElementById('techniqueInstructions').value,
                prerequisites: document.getElementById('techniquePrerequisites').value,
                keyPoints: document.getElementById('techniqueKeyPoints').value,
                equipment: document.getElementById('techniqueEquipment').value,
                duration: parseInt(document.getElementById('techniqueDuration').value),
                usedIn: [],
                isFromWhiteBelt: false
            };

            if (!formData.name || !formData.category || !formData.level) {
                showToast('Preencha todos os campos obrigatÃ³rios', 'error');
                return;
            }

            allTechniques.push(formData);
            displayTechniquesTable(allTechniques);
            updateTechniquesStats();
            closeAddTechniqueModal();
            showToast(`TÃ©cnica "${formData.name}" adicionada com sucesso!`, 'success');
        }

        // Search and filter techniques
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('techniqueSearch');
            const categoryFilter = document.getElementById('categoryFilter');

            if (searchInput) {
                searchInput.addEventListener('input', filterTechniques);
            }
            if (categoryFilter) {
                categoryFilter.addEventListener('change', filterTechniques);
            }
        });

        function filterTechniques() {
            const searchTerm = document.getElementById('techniqueSearch')?.value.toLowerCase() || '';
            const selectedCategory = document.getElementById('categoryFilter')?.value || '';

            let filteredTechniques = allTechniques.filter(tech => {
                const matchesSearch = tech.name.toLowerCase().includes(searchTerm) || 
                                    tech.description.toLowerCase().includes(searchTerm);
                const matchesCategory = !selectedCategory || tech.category === selectedCategory;
                
                return matchesSearch && matchesCategory;
            });

            displayTechniquesTable(filteredTechniques);
        }

        // ==========================================
        // UNIVERSAL COURSE CREATOR
        // ==========================================

        // Open Universal Course Creator (RAG-Enhanced)
        function openUniversalCourseCreator() {
            document.getElementById('universalCourseModal').classList.add('active');
            loadTechniqueSelectionArea();
            initializeBeltSystems();
            updateRAGStatus(); // Add RAG status update
        }

        // Close Universal Course Creator
        function closeUniversalCourseModal() {
            document.getElementById('universalCourseModal').classList.remove('active');
            selectedTechniques = [];
            courseModelFile = null;
            updateSelectedTechniquesList();
        }

        // Initialize belt systems for different martial arts
        function initializeBeltSystems() {
            beltSystems = {
                'KRAV_MAGA': {
                    name: 'Krav Maga',
                    levels: [
                        { value: 'PRACTITIONER_1', name: 'Practitioner 1', color: '#FFFFFF' },
                        { value: 'PRACTITIONER_2', name: 'Practitioner 2', color: '#FFD700' },
                        { value: 'PRACTITIONER_3', name: 'Practitioner 3', color: '#FFA500' },
                        { value: 'GRADUATE_1', name: 'Graduate 1', color: '#32CD32' },
                        { value: 'GRADUATE_2', name: 'Graduate 2', color: '#0000FF' },
                        { value: 'EXPERT_1', name: 'Expert 1', color: '#8B4513' },
                        { value: 'EXPERT_2', name: 'Expert 2', color: '#000000' }
                    ]
                },
                'JIU_JITSU': {
                    name: 'Jiu-Jitsu',
                    levels: [
                        { value: 'WHITE', name: 'Faixa Branca', color: '#FFFFFF' },
                        { value: 'BLUE', name: 'Faixa Azul', color: '#0000FF' },
                        { value: 'PURPLE', name: 'Faixa Roxa', color: '#800080' },
                        { value: 'BROWN', name: 'Faixa Marrom', color: '#8B4513' },
                        { value: 'BLACK', name: 'Faixa Preta', color: '#000000' }
                    ]
                },
                'BOXING': {
                    name: 'Boxe',
                    levels: [
                        { value: 'BEGINNER', name: 'Iniciante', color: '#FFFFFF' },
                        { value: 'AMATEUR', name: 'Amador', color: '#C0C0C0' },
                        { value: 'SEMI_PRO', name: 'Semi-Profissional', color: '#FFD700' },
                        { value: 'PROFESSIONAL', name: 'Profissional', color: '#000000' }
                    ]
                },
                'MUAY_THAI': {
                    name: 'Muay Thai',
                    levels: [
                        { value: 'WHITE', name: 'Prajioud Branco', color: '#FFFFFF' },
                        { value: 'YELLOW', name: 'Prajioud Amarelo', color: '#FFD700' },
                        { value: 'GREEN', name: 'Prajioud Verde', color: '#008000' },
                        { value: 'BLUE', name: 'Prajioud Azul', color: '#0000FF' },
                        { value: 'RED', name: 'Prajioud Vermelho', color: '#FF0000' },
                        { value: 'BLACK', name: 'Prajioud Preto', color: '#000000' }
                    ]
                },
                'KARATE': {
                    name: 'KaratÃª',
                    levels: [
                        { value: 'WHITE', name: 'Faixa Branca', color: '#FFFFFF' },
                        { value: 'YELLOW', name: 'Faixa Amarela', color: '#FFD700' },
                        { value: 'ORANGE', name: 'Faixa Laranja', color: '#FFA500' },
                        { value: 'GREEN', name: 'Faixa Verde', color: '#008000' },
                        { value: 'BLUE', name: 'Faixa Azul', color: '#0000FF' },
                        { value: 'BROWN', name: 'Faixa Marrom', color: '#8B4513' },
                        { value: 'BLACK', name: 'Faixa Preta', color: '#000000' }
                    ]
                },
                'TAEKWONDO': {
                    name: 'Taekwondo',
                    levels: [
                        { value: 'WHITE', name: 'Faixa Branca', color: '#FFFFFF' },
                        { value: 'YELLOW', name: 'Faixa Amarela', color: '#FFD700' },
                        { value: 'GREEN', name: 'Faixa Verde', color: '#008000' },
                        { value: 'BLUE', name: 'Faixa Azul', color: '#0000FF' },
                        { value: 'RED', name: 'Faixa Vermelha', color: '#FF0000' },
                        { value: 'BLACK', name: 'Faixa Preta', color: '#000000' }
                    ]
                },
                'MMA': {
                    name: 'MMA',
                    levels: [
                        { value: 'BEGINNER', name: 'Iniciante', color: '#FFFFFF' },
                        { value: 'INTERMEDIATE', name: 'IntermediÃ¡rio', color: '#FFD700' },
                        { value: 'ADVANCED', name: 'AvanÃ§ado', color: '#FFA500' },
                        { value: 'PRO', name: 'Profissional', color: '#000000' }
                    ]
                },
                'CAPOEIRA': {
                    name: 'Capoeira',
                    levels: [
                        { value: 'CRUA', name: 'CordÃ£o Cru', color: '#F5F5DC' },
                        { value: 'AMARELO', name: 'CordÃ£o Amarelo', color: '#FFD700' },
                        { value: 'LARANJA', name: 'CordÃ£o Laranja', color: '#FFA500' },
                        { value: 'AZUL', name: 'CordÃ£o Azul', color: '#0000FF' },
                        { value: 'VERDE', name: 'CordÃ£o Verde', color: '#008000' },
                        { value: 'ROXO', name: 'CordÃ£o Roxo', color: '#800080' },
                        { value: 'MARROM', name: 'CordÃ£o Marrom', color: '#8B4513' },
                        { value: 'VERMELHO', name: 'CordÃ£o Vermelho', color: '#FF0000' }
                    ]
                }
            };
        }

        // Update belt options when martial art changes
        function updateTechniquesForArt() {
            const martialArt = document.getElementById('martialArt').value;
            const beltSelect = document.getElementById('beltLevel');
            
            // Clear belt options
            beltSelect.innerHTML = '<option value="">Selecione a faixa/nÃ­vel</option>';
            
            if (martialArt && beltSystems[martialArt]) {
                const system = beltSystems[martialArt];
                system.levels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level.value;
                    option.textContent = level.name;
                    option.style.color = level.color === '#FFFFFF' ? '#000000' : level.color;
                    beltSelect.appendChild(option);
                });
            }
            
            // Update techniques based on martial art
            updateTechniqueSelectionStrategy();
        }

        // Update belt info display
        function updateBeltInfo() {
            const martialArt = document.getElementById('martialArt').value;
            const beltLevel = document.getElementById('beltLevel').value;
            const beltInfo = document.getElementById('beltInfo');
            const beltInfoContent = document.getElementById('beltInfoContent');
            
            if (martialArt && beltLevel && beltSystems[martialArt]) {
                const system = beltSystems[martialArt];
                const level = system.levels.find(l => l.value === beltLevel);
                
                if (level) {
                    beltInfoContent.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <div style="width: 30px; height: 20px; background: ${level.color}; border: 1px solid #374151; border-radius: 4px;"></div>
                            <div>
                                <div style="font-weight: bold; color: #F8FAFC;">${system.name} - ${level.name}</div>
                                <div style="color: #9CA3AF; font-size: 0.9rem;">Sistema de graduaÃ§Ã£o selecionado</div>
                            </div>
                        </div>
                    `;
                    beltInfo.style.display = 'block';
                    
                    // Auto-populate course title
                    const titleField = document.getElementById('universalCourseTitle');
                    if (!titleField.value) {
                        titleField.value = `${system.name} ${level.name} - Curso Completo`;
                    }
                } else {
                    beltInfo.style.display = 'none';
                }
            } else {
                beltInfo.style.display = 'none';
            }
        }

        // Get martial art name
        function getMartialArtName(artCode) {
            return beltSystems[artCode]?.name || artCode;
        }

        // Load technique selection area
        function loadTechniqueSelectionArea() {
            if (allTechniques.length === 0) {
                allTechniques = generateMockTechniques();
            }

            updateTechniqueSelectionStrategy();
        }

        // Update technique selection based on strategy
        function updateTechniqueSelectionStrategy() {
            const strategy = document.querySelector('input[name="selectionStrategy"]:checked')?.value || 'reuse';
            const selectionArea = document.getElementById('techniqueSelectionArea');

            let techniquesToShow = [];

            const martialArt = document.getElementById('martialArt')?.value;
            const beltLevel = document.getElementById('beltLevel')?.value;
            
            // Filter techniques by martial art if selected
            let availableTechniques = allTechniques;
            if (martialArt) {
                availableTechniques = allTechniques.filter(t => 
                    t.martialArt === martialArt || t.martialArt === 'GENERAL'
                );
            }
            
            switch (strategy) {
                case 'reuse':
                    // Show techniques from previous belt level + new ones
                    const previousLevelTechniques = availableTechniques.filter(t => t.isPreviousLevel);
                    const newTechniques = availableTechniques.filter(t => !t.isPreviousLevel && t.level === 'INTERMEDIATE');
                    selectedTechniques = [...previousLevelTechniques];
                    techniquesToShow = newTechniques;
                    break;
                    
                case 'fresh':
                    // Show techniques appropriate for the belt level
                    selectedTechniques = [];
                    techniquesToShow = availableTechniques.filter(t => {
                        if (!beltLevel) return t.level === 'BEGINNER';
                        
                        if (beltLevel === 'WHITE' || beltLevel === 'PRACTITIONER_1' || beltLevel === 'BEGINNER' || beltLevel === 'CRUA') {
                            return t.level === 'BEGINNER';
                        } else if (beltLevel === 'BLACK' || beltLevel === 'EXPERT_1' || beltLevel === 'PRO' || beltLevel === 'VERMELHO') {
                            return t.level === 'ADVANCED' || t.level === 'EXPERT';
                        } else {
                            return t.level === 'INTERMEDIATE';
                        }
                    });
                    break;
                    
                case 'custom':
                    // Show all techniques for manual selection
                    selectedTechniques = [];
                    techniquesToShow = availableTechniques;
                    break;
            }

            displayTechniqueSelection(techniquesToShow, strategy);
            updateSelectedTechniquesList();
        }

        // Display technique selection interface
        function displayTechniqueSelection(techniques, strategy) {
            const selectionArea = document.getElementById('techniqueSelectionArea');
            
            let content = '';
            
            if (strategy === 'reuse') {
                const previousTechniques = allTechniques.filter(t => t.isPreviousLevel);
                content = `
                    <div style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border-bottom: 1px solid #374151;">
                        <h4 style="color: #10B981; margin-bottom: 0.5rem;">âœ… TÃ©cnicas do NÃ­vel Anterior (JÃ¡ IncluÃ­das)</h4>
                        <div style="color: #CBD5E1; font-size: 0.9rem;">
                            ${previousTechniques.length > 0 ? previousTechniques.map(t => t.name).join(', ') : 'Nenhuma tÃ©cnica do nÃ­vel anterior'}
                        </div>
                    </div>
                    <div style="padding: 1rem;">
                        <h4 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ“ Selecione TÃ©cnicas Adicionais:</h4>
                `;
            } else {
                content = `
                    <div style="padding: 1rem;">
                        <h4 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ“ Selecione as TÃ©cnicas:</h4>
                `;
            }

            content += techniques.map(tech => `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border-bottom: 1px solid #374151; hover: background-color: rgba(255,255,255,0.05);">
                    <input type="checkbox" id="tech_${tech.id}" value="${tech.id}" onchange="toggleTechniqueSelection('${tech.id}')">
                    <label for="tech_${tech.id}" style="flex: 1; cursor: pointer; color: #F8FAFC;">
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">${tech.name}</div>
                        <div style="font-size: 0.8rem; color: #9CA3AF;">
                            ${getCategoryIcon(tech.category)} ${getCategoryName(tech.category)} â€¢ 
                            ${'â­'.repeat(getLevelStars(tech.level))} ${getLevelName(tech.level)}
                        </div>
                    </label>
                </div>
            `).join('');

            content += '</div>';
            selectionArea.innerHTML = content;
        }

        // Toggle technique selection
        function toggleTechniqueSelection(techniqueId) {
            const technique = allTechniques.find(t => t.id === techniqueId);
            const checkbox = document.getElementById(`tech_${techniqueId}`);
            
            if (checkbox.checked) {
                if (!selectedTechniques.find(t => t.id === techniqueId)) {
                    selectedTechniques.push(technique);
                }
            } else {
                selectedTechniques = selectedTechniques.filter(t => t.id !== techniqueId);
            }
            
            updateSelectedTechniquesList();
        }

        // Update selected techniques list
        function updateSelectedTechniquesList() {
            const countElement = document.getElementById('selectedTechniquesCount');
            const listElement = document.getElementById('selectedTechniquesList');
            
            countElement.textContent = selectedTechniques.length;
            
            if (selectedTechniques.length === 0) {
                listElement.textContent = 'Nenhuma tÃ©cnica selecionada ainda';
            } else {
                listElement.innerHTML = selectedTechniques.map(tech => 
                    `<span style="background: ${getCategoryColor(tech.category)}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; margin: 0.25rem; display: inline-block; font-size: 0.8rem;">
                        ${getCategoryIcon(tech.category)} ${tech.name}
                    </span>`
                ).join('');
            }
        }

        // Handle Course model upload
        function handleCourseModelUpload(event) {
            const file = event.target.files[0];
            if (file) {
                courseModelFile = file;
                document.getElementById('courseModelFileInfo').innerHTML = `
                    <div style="text-align: left; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border: 1px solid #F59E0B;">
                        <div style="color: #F59E0B; font-weight: bold; margin-bottom: 0.5rem;">ðŸ“Ž Arquivo Carregado:</div>
                        <div style="color: #F8FAFC;">${getFileIcon(file.name)} ${file.name}</div>
                        <div style="color: #9CA3AF; font-size: 0.8rem;">${formatFileSize(file.size)}</div>
                    </div>
                `;
                showToast(`Modelo "${file.name}" carregado com sucesso!`, 'success');
            }
        }

        // Create Universal Course (RAG-Enhanced)
        async function createUniversalCourse() {
            const courseData = {
                title: document.getElementById('universalCourseTitle').value,
                duration: parseInt(document.getElementById('universalCourseDuration').value),
                objectives: document.getElementById('universalCourseObjectives').value,
                martialArt: document.getElementById('martialArt').value,
                beltLevel: document.getElementById('beltLevel').value,
                graduation: document.getElementById('courseGraduation').value,
                level: document.getElementById('universalCourseLevel').value,
                lessonsPerWeek: parseInt(document.getElementById('lessonsPerWeekUniversal').value),
                selectedTechniques: selectedTechniques,
                modelFile: courseModelFile,
                generatePlans: document.getElementById('universalGeneratePlans').checked,
                aiModel: document.getElementById('universalAiModel').value,
                selectionStrategy: document.querySelector('input[name="selectionStrategy"]:checked')?.value
            };

            if (!courseData.title || !courseData.martialArt || !courseData.beltLevel || selectedTechniques.length === 0) {
                showToast('Preencha todos os campos obrigatÃ³rios e selecione tÃ©cnicas', 'error');
                return;
            }

            // Show loading state
            const createBtn = document.getElementById('createUniversalBtn');
            const originalText = createBtn.innerHTML;
            createBtn.innerHTML = '<span>â³</span> Criando Curso...';
            createBtn.disabled = true;

            try {
                // RAG Enhancement: Query knowledge base for course-relevant content
                const ragEnhancement = await queryRAGForCourseCreation(courseData);
                courseData.ragContent = ragEnhancement;
                
                await simulateUniversalCourseCreation(courseData);
                
                showToast(`Curso de ${getMartialArtName(courseData.martialArt)} criado com sucesso! ${ragEnhancement.usedSources > 0 ? 'ðŸ§  Enriquecido com ' + ragEnhancement.usedSources + ' fontes da base de conhecimento' : ''}`, 'success');
                closeUniversalCourseModal();
                
                // Refresh course data
                showSection('courses');
                
            } catch (error) {
                console.error('Erro ao criar curso:', error);
                showToast('Erro ao criar curso', 'error');
            } finally {
                // Restore button state
                createBtn.innerHTML = originalText;
                createBtn.disabled = false;
            }
        }

        // Simulate Universal course creation (RAG-Enhanced)
        async function simulateUniversalCourseCreation(courseData) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const enhancedCourse = {
                        title: courseData.title,
                        duration: courseData.duration,
                        totalTechniques: courseData.selectedTechniques.length,
                        techniques: courseData.selectedTechniques.map(t => ({
                            name: t.name,
                            category: t.category,
                            level: t.level,
                            isFromWhiteBelt: t.isFromWhiteBelt
                        })),
                        strategy: courseData.selectionStrategy,
                        modelFile: courseData.modelFile?.name,
                        generatePlans: courseData.generatePlans,
                        totalLessons: courseData.duration * courseData.lessonsPerWeek,
                        aiModel: courseData.aiModel,
                        courseStructure: generateRAGEnhancedStructure(courseData),
                        ragEnhancements: courseData.ragContent
                    };
                    
                    console.log('ðŸŽ“ RAG-Enhanced Universal Course Created:', enhancedCourse);
                    
                    // If lesson plans should be generated, create RAG-enhanced plans
                    if (courseData.generatePlans) {
                        enhancedCourse.lessonPlans = generateRAGEnhancedLessonPlans(courseData);
                        console.log('ðŸ“š Generated RAG-Enhanced Lesson Plans:', enhancedCourse.lessonPlans.length);
                    }
                    
                    resolve(enhancedCourse);
                }, 4000); // Simulate 4 second creation
            });
        }

        // Generate Yellow Belt course structure
        function generateYellowBeltStructure(courseData) {
            const totalLessons = courseData.duration * 2;
            const techniquesPerLesson = Math.ceil(courseData.selectedTechniques.length / totalLessons);
            
            return {
                totalWeeks: courseData.duration,
                totalLessons: totalLessons,
                lessonsPerWeek: 2,
                techniquesDistribution: courseData.selectedTechniques.reduce((acc, tech, index) => {
                    const lessonNumber = Math.floor(index / techniquesPerLesson) + 1;
                    if (!acc[lessonNumber]) acc[lessonNumber] = [];
                    acc[lessonNumber].push(tech.name);
                    return acc;
                }, {}),
                prerequisites: {
                    requiredCourse: 'Krav Maga Faixa Branca',
                    minimumGrade: '70%',
                    requiredTechniques: allTechniques.filter(t => t.isFromWhiteBelt).map(t => t.name)
                }
            };
        }

        // Listen for strategy changes
        document.addEventListener('change', function(e) {
            if (e.target.name === 'selectionStrategy') {
                updateTechniqueSelectionStrategy();
            }
        });

        // ==========================================
        // AI COURSE GENERATOR FUNCTIONALITY
        // ==========================================

        let uploadedFiles = [];
        let selectedTemplate = null;

        // Open AI Course Generator Modal
        function openAICourseGenerator() {
            document.getElementById('aiCourseGeneratorModal').classList.add('active');
            resetCourseForm();
        }

        // Close AI Course Generator Modal
        function closeAICourseGeneratorModal() {
            document.getElementById('aiCourseGeneratorModal').classList.remove('active');
            resetCourseForm();
        }

        // Select creation mode
        function selectCreationMode(mode) {
            document.getElementById('creationMode').value = mode;
            
            // Update UI
            document.querySelectorAll('.creation-mode-card').forEach(card => {
                card.style.borderColor = '#374151';
                card.style.background = '';
            });
            
            const selectedCard = event.target.closest('.creation-mode-card');
            selectedCard.style.borderColor = '#3B82F6';
            selectedCard.style.background = 'rgba(59, 130, 246, 0.1)';
            
            // Show/hide document section
            const documentSection = document.getElementById('documentSection');
            if (mode === 'document') {
                documentSection.style.display = 'block';
            } else {
                documentSection.style.display = 'none';
            }
        }

        // Load template
        function loadTemplate(templateType) {
            selectedTemplate = templateType;
            
            // Update template buttons
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.style.background = btn.style.background.replace('0.2', '0.1');
            });
            event.target.style.background = event.target.style.background.replace('0.1', '0.3');
            
            // Load template data
            const templates = {
                'krav-maga-basic': {
                    title: 'Krav Maga Faixa Branca - Defesa Pessoal 1',
                    level: 'INICIANTE',
                    category: 'ADULT',
                    duration: 24,
                    objectives: 'Desenvolver habilidades fundamentais de defesa pessoal, melhorar condicionamento fÃ­sico, ensinar consciÃªncia situacional'
                },
                'self-defense': {
                    title: 'Defesa Pessoal para Mulheres',
                    level: 'INICIANTE',
                    category: 'ADULT',
                    duration: 12,
                    objectives: 'Ensinar tÃ©cnicas bÃ¡sicas de defesa, desenvolver confianÃ§a, promover seguranÃ§a pessoal'
                },
                'instructor': {
                    title: 'FormaÃ§Ã£o de Instrutores Krav Maga',
                    level: 'INSTRUTOR',
                    category: 'ADULT',
                    duration: 36,
                    objectives: 'Formar instrutores qualificados, ensinar metodologia de ensino, desenvolver habilidades de lideranÃ§a'
                }
            };
            
            const template = templates[templateType];
            if (template) {
                document.getElementById('courseTitle').value = template.title;
                document.getElementById('courseLevel').value = template.level;
                document.getElementById('courseCategory').value = template.category;
                document.getElementById('courseDuration').value = template.duration;
                document.getElementById('courseObjectives').value = template.objectives;
            }

            showToast(`Template "${templateType}" carregado com sucesso!`, 'success');
        }

        // Handle file upload
        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            uploadedFiles = [...uploadedFiles, ...files];
            
            displayUploadedFiles();
            showToast(`${files.length} arquivo(s) carregado(s)`, 'success');
        }

        // Display uploaded files
        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            
            if (uploadedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div style="text-align: left; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #374151;">
                    <h4 style="color: #F8FAFC; margin-bottom: 0.5rem;">ðŸ“Ž Arquivos Carregados:</h4>
                    ${uploadedFiles.map((file, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(59, 130, 246, 0.1); border-radius: 6px; margin-bottom: 0.5rem;">
                            <span style="color: #CBD5E1;">
                                ${getFileIcon(file.name)} ${file.name} 
                                <small style="color: #9CA3AF;">(${formatFileSize(file.size)})</small>
                            </span>
                            <button onclick="removeFile(${index})" style="background: #EF4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">
                                âœ•
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Remove file
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayUploadedFiles();
            showToast('Arquivo removido', 'info');
        }

        // Get file icon
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'ðŸ“„',
                'doc': 'ðŸ“',
                'docx': 'ðŸ“',
                'txt': 'ðŸ“„',
                'md': 'ðŸ“‹'
            };
            return icons[ext] || 'ðŸ“';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Generate course with AI
        async function generateCourseWithAI() {
            const formData = collectCourseFormData();
            
            if (!validateCourseForm(formData)) {
                return;
            }

            // Show loading state
            const generateBtn = document.getElementById('generateCourseBtn');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<span>â³</span> Gerando Curso...';
            generateBtn.disabled = true;

            try {
                // Simulate AI course generation
                await simulateAICourseGeneration(formData);
                
                showToast('Curso gerado com sucesso! Criando planos de aula...', 'success');
                
                if (formData.generateLessonPlans) {
                    await simulateLessonPlansGeneration(formData);
                    showToast('Planos de aula gerados com sucesso!', 'success');
                }
                
                closeAICourseGeneratorModal();
                // Refresh course data
                loadAllLessonPlans();
                
            } catch (error) {
                console.error('Erro na geraÃ§Ã£o do curso:', error);
                showToast('Erro ao gerar curso', 'error');
            } finally {
                // Restore button state
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        // Collect form data
        function collectCourseFormData() {
            return {
                mode: document.getElementById('creationMode').value,
                title: document.getElementById('courseTitle').value,
                duration: document.getElementById('courseDuration').value,
                level: document.getElementById('courseLevel').value,
                category: document.getElementById('courseCategory').value,
                lessonsPerWeek: document.getElementById('lessonsPerWeek').value,
                objectives: document.getElementById('courseObjectives').value,
                additionalContext: document.getElementById('additionalContext').value,
                generateLessonPlans: document.getElementById('generateLessonPlans').checked,
                includeEvaluations: document.getElementById('includeEvaluations').checked,
                aiModel: document.getElementById('aiModel').value,
                adaptations: Array.from(document.querySelectorAll('input[name="adaptations"]:checked')).map(cb => cb.value),
                uploadedFiles: uploadedFiles,
                selectedTemplate: selectedTemplate
            };
        }

        // Validate form
        function validateCourseForm(formData) {
            if (!formData.mode) {
                showToast('Selecione um modo de criaÃ§Ã£o', 'error');
                return false;
            }
            
            if (!formData.title || !formData.level || !formData.category) {
                showToast('Preencha todos os campos obrigatÃ³rios', 'error');
                return false;
            }
            
            if (formData.mode === 'document' && uploadedFiles.length === 0 && !selectedTemplate) {
                showToast('Carregue documentos ou selecione um template', 'error');
                return false;
            }
            
            return true;
        }

        // Simulate AI course generation
        async function simulateAICourseGeneration(formData) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('ðŸŽ¯ IA Generated Course:', {
                        title: formData.title,
                        structure: generateCourseStructure(formData),
                        curriculum: generateCourseCurriculum(formData),
                        objectives: formData.objectives.split(',').map(obj => obj.trim()),
                        totalLessons: formData.duration * formData.lessonsPerWeek,
                        weeks: formData.duration,
                        level: formData.level,
                        category: formData.category,
                        adaptations: formData.adaptations,
                        evaluationSystem: formData.includeEvaluations ? generateEvaluationSystem(formData) : null,
                        generatedWith: {
                            model: formData.aiModel,
                            mode: formData.mode,
                            documentsUsed: uploadedFiles.map(f => f.name),
                            template: selectedTemplate
                        }
                    });
                    resolve();
                }, 3000); // Simulate 3 second generation
            });
        }

        // Generate course structure
        function generateCourseStructure(formData) {
            const totalLessons = formData.duration * formData.lessonsPerWeek;
            const unitsCount = Math.ceil(totalLessons / 10);
            
            return {
                totalWeeks: formData.duration,
                lessonsPerWeek: formData.lessonsPerWeek,
                totalLessons: totalLessons,
                units: Array.from({length: unitsCount}, (_, i) => ({
                    number: i + 1,
                    name: generateUnitName(i, formData.level),
                    lessonsStart: i * 10 + 1,
                    lessonsEnd: Math.min((i + 1) * 10, totalLessons),
                    focus: generateUnitFocus(i, formData.level)
                }))
            };
        }

        // Generate unit names based on level
        function generateUnitName(unitIndex, level) {
            const unitNames = {
                'INICIANTE': ['Fundamentos', 'TÃ©cnicas BÃ¡sicas', 'Defesas Simples', 'AplicaÃ§Ã£o PrÃ¡tica'],
                'INTERMEDIARIO': ['RevisÃ£o AvanÃ§ada', 'TÃ©cnicas Complexas', 'Defesas MÃºltiplas', 'CenÃ¡rios Reais'],
                'AVANCADO': ['Refinamento TÃ©cnico', 'Combos AvanÃ§ados', 'Defesas Extremas', 'InstruÃ§Ã£o'],
                'INSTRUTOR': ['Metodologia', 'Pedagogia', 'DemonstraÃ§Ã£o', 'AvaliaÃ§Ã£o']
            };
            
            return unitNames[level]?.[unitIndex] || `Unidade ${unitIndex + 1}`;
        }

        // Generate unit focus
        function generateUnitFocus(unitIndex, level) {
            const focuses = {
                'INICIANTE': ['CoordenaÃ§Ã£o e postura', 'TÃ©cnicas fundamentais', 'ReaÃ§Ãµes bÃ¡sicas', 'ConfianÃ§a'],
                'INTERMEDIARIO': ['PrecisÃ£o tÃ©cnica', 'CombinaÃ§Ãµes', 'Adaptabilidade', 'Condicionamento'],
                'AVANCADO': ['PerfeiÃ§Ã£o tÃ©cnica', 'Criatividade', 'LideranÃ§a', 'EspecializaÃ§Ã£o'],
                'INSTRUTOR': ['Ensino efetivo', 'ComunicaÃ§Ã£o', 'CorreÃ§Ã£o tÃ©cnica', 'Desenvolvimento de alunos']
            };
            
            return focuses[level]?.[unitIndex] || 'Desenvolvimento geral';
        }

        // Generate course curriculum
        function generateCourseCurriculum(formData) {
            return {
                principles: generateCoursePrinciples(formData.level),
                techniques: generateCourseTechniques(formData.level),
                progressionSystem: generateProgressionSystem(formData.level),
                equipmentNeeded: generateEquipmentList(formData.level)
            };
        }

        // Generate evaluation system
        function generateEvaluationSystem(formData) {
            return {
                evaluationMethods: ['TÃ©cnica individual', 'CenÃ¡rios prÃ¡ticos', 'Exame teÃ³rico', 'AvaliaÃ§Ã£o contÃ­nua'],
                gradingCriteria: ['PrecisÃ£o tÃ©cnica', 'AplicaÃ§Ã£o prÃ¡tica', 'Conhecimento teÃ³rico', 'ProgressÃ£o'],
                examSchedule: generateExamSchedule(formData.duration),
                certificationRequirements: ['75% frequÃªncia mÃ­nima', 'AprovaÃ§Ã£o em todas avaliaÃ§Ãµes', 'DemonstraÃ§Ã£o prÃ¡tica']
            };
        }

        // Simulate lesson plans generation
        async function simulateLessonPlansGeneration(formData) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('ðŸ“š IA Generated Lesson Plans for course:', formData.title);
                    resolve();
                }, 2000);
            });
        }

        // Reset form
        function resetCourseForm() {
            document.getElementById('creationMode').value = '';
            document.querySelectorAll('.creation-mode-card').forEach(card => {
                card.style.borderColor = '#374151';
                card.style.background = '';
            });
            document.getElementById('documentSection').style.display = 'none';
            uploadedFiles = [];
            selectedTemplate = null;
            displayUploadedFiles();
        }

        // Helper functions for curriculum generation
        function generateCoursePrinciples(level) {
            const principles = {
                'INICIANTE': ['SeguranÃ§a primeiro', 'Simplicidade', 'Efetividade', 'ProgressÃ£o gradual'],
                'INTERMEDIARIO': ['Adaptabilidade', 'FluÃªncia tÃ©cnica', 'Tomada de decisÃ£o', 'Condicionamento'],
                'AVANCADO': ['Maestria tÃ©cnica', 'Criatividade', 'LideranÃ§a', 'InovaÃ§Ã£o'],
                'INSTRUTOR': ['Pedagogia efetiva', 'ComunicaÃ§Ã£o clara', 'Desenvolvimento de outros', 'Responsabilidade']
            };
            return principles[level] || principles['INICIANTE'];
        }

        function generateCourseTechniques(level) {
            const techniques = {
                'INICIANTE': ['Postura bÃ¡sica', 'Golpes fundamentais', 'Defesas simples', 'MovimentaÃ§Ã£o'],
                'INTERMEDIARIO': ['CombinaÃ§Ãµes', 'Defesas mÃºltiplas', 'Contra-ataques', 'CenÃ¡rios variados'],
                'AVANCADO': ['TÃ©cnicas complexas', 'ImprovisaÃ§Ã£o', 'Ensino', 'EspecializaÃ§Ã£o'],
                'INSTRUTOR': ['DemonstraÃ§Ã£o perfeita', 'CorreÃ§Ã£o tÃ©cnica', 'AdaptaÃ§Ã£o metodolÃ³gica', 'AvaliaÃ§Ã£o']
            };
            return techniques[level] || techniques['INICIANTE'];
        }

        function generateProgressionSystem(level) {
            return {
                assessmentFrequency: level === 'INSTRUTOR' ? 'Semanal' : 'Quinzenal',
                practiceHours: level === 'INICIANTE' ? '2-3 horas/semana' : '4-6 horas/semana',
                masteryLevel: level === 'INICIANTE' ? '70%' : '85%'
            };
        }

        function generateEquipmentList(level) {
            const equipment = {
                'INICIANTE': ['Tatame', 'Roupas confortÃ¡veis'],
                'INTERMEDIARIO': ['Tatame', 'Luvas', 'Protetores'],
                'AVANCADO': ['Tatame completo', 'Equipamentos variados', 'Material de treino'],
                'INSTRUTOR': ['Todo equipamento', 'Material didÃ¡tico', 'Recursos audiovisuais']
            };
            return equipment[level] || equipment['INICIANTE'];
        }

        function generateExamSchedule(duration) {
            const exams = [];
            for (let week = 6; week <= duration; week += 6) {
                exams.push(`Semana ${week}: AvaliaÃ§Ã£o de Unidade`);
            }
            exams.push(`Semana ${duration}: Exame Final`);
            return exams;
        }

        // ==========================================
        // AI LESSON GENERATOR FUNCTIONALITY
        // ==========================================

        // Open AI Generator Modal  
        function openAILessonGenerator() {
            document.getElementById('aiGeneratorModal').classList.add('active');
        }

        // Close AI Generator Modal
        function closeAIGeneratorModal() {
            document.getElementById('aiGeneratorModal').classList.remove('active');
        }

        // Generate lesson plan with AI
        async function generateLessonPlanWithAI() {
            const formData = {
                lessonNumber: document.getElementById('aiLessonNumber').value,
                unit: document.getElementById('aiLessonUnit').value,
                mainTechnique: document.getElementById('aiMainTechnique').value,
                objectives: document.getElementById('aiLessonObjectives').value,
                difficulty: document.getElementById('aiDifficulty').value,
                specialNeeds: Array.from(document.querySelectorAll('#aiGeneratorForm input[type="checkbox"]:checked')).map(cb => cb.value)
            };

            if (!formData.lessonNumber || !formData.unit || !formData.mainTechnique) {
                showToast('Preencha todos os campos obrigatÃ³rios', 'error');
                return;
            }

            // Show loading state
            const generateBtn = document.querySelector('[onclick="generateLessonPlanWithAI()"]');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<span>â³</span> Gerando...';
            generateBtn.disabled = true;

            try {
                // Simulate AI generation - replace with actual API call
                await simulateAIGeneration(formData);
                
                showToast('Plano de aula gerado com sucesso!', 'success');
                closeAIGeneratorModal();
                loadAllLessonPlans(); // Refresh the lesson plans table
                
            } catch (error) {
                console.error('Erro na geraÃ§Ã£o IA:', error);
                showToast('Erro ao gerar plano de aula', 'error');
            } finally {
                // Restore button state
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        // ==========================================
        // CENTRAL RAG SYSTEM - MEMORIA DOS AGENTES IA
        // ==========================================
        
        // Initialize RAG knowledge base and RAG chunks (renamed to avoid conflict)
        const ragKnowledgeBase = {
            techniques: [],
            lessons: [],
            students: [],
            courses: []
        };
        
        // Central RAG Service - Memory for all AI agents
        class CentralRAGService {
            constructor() {
                this.knowledgeBase = ragKnowledgeBase;
                this.ragChunks = window.ragChunks || [];
            }
            
            // Universal query method for all AI agents
            async queryKnowledge(query, context = {}) {
                try {
                    const enhancedQuery = this.enhanceQuery(query, context);
                    const relevantChunks = this.findRelevantChunks(enhancedQuery);
                    const response = await this.generateResponse(enhancedQuery, relevantChunks, context);
                    
                    return {
                        success: true,
                        answer: response.answer,
                        sources: response.sources,
                        confidence: response.confidence,
                        chunks: relevantChunks.length,
                        context: context
                    };
                } catch (error) {
                    console.error('RAG Query Error:', error);
                    return {
                        success: false,
                        answer: 'Desculpe, nÃ£o consegui acessar a base de conhecimento no momento.',
                        sources: [],
                        confidence: 0
                    };
                }
            }
            
            // Enhance query with context information
            enhanceQuery(query, context) {
                let enhancedQuery = query;
                
                if (context.martialArt) {
                    enhancedQuery += ` ${context.martialArt}`;
                }
                
                if (context.level) {
                    enhancedQuery += ` ${context.level}`;
                }
                
                if (context.module) {
                    enhancedQuery += ` ${context.module}`;
                }
                
                return enhancedQuery;
            }
            
            // Find relevant chunks using enhanced search
            findRelevantChunks(query) {
                const queryWords = query.toLowerCase().split(' ').filter(word => word.length > 2);
                
                return this.ragChunks.filter(chunk => {
                    const chunkWords = chunk.content.toLowerCase();
                    const titleWords = chunk.sourceTitle.toLowerCase();
                    const tagWords = chunk.tags.join(' ').toLowerCase();
                    
                    const score = queryWords.reduce((acc, word) => {
                        let points = 0;
                        if (chunkWords.includes(word)) points += 3;
                        if (titleWords.includes(word)) points += 5;
                        if (tagWords.includes(word)) points += 2;
                        return acc + points;
                    }, 0);
                    
                    chunk.relevanceScore = score;
                    return score > 0;
                }).sort((a, b) => b.relevanceScore - a.relevanceScore).slice(0, 5);
            }
            
            // Generate contextualized response
            async generateResponse(query, chunks, context) {
                await sleep(300); // Simulate processing
                
                if (chunks.length === 0) {
                    return {
                        answer: 'NÃ£o encontrei informaÃ§Ãµes especÃ­ficas sobre isso na base de conhecimento. Considere adicionar mais conteÃºdo relacionado.',
                        sources: [],
                        confidence: 0
                    };
                }
                
                const contextualAnswer = this.generateContextualAnswer(query, chunks, context);
                
                return {
                    answer: contextualAnswer,
                    sources: chunks.map(chunk => ({
                        title: chunk.sourceTitle,
                        type: chunk.sourceType,
                        relevantText: chunk.content.substring(0, 150) + '...',
                        score: chunk.relevanceScore
                    })),
                    confidence: Math.min(95, Math.max(60, chunks[0]?.relevanceScore * 10 || 60))
                };
            }
            
            // Generate contextual answer based on agent type
            generateContextualAnswer(query, chunks, context) {
                const combinedContent = chunks.map(c => c.content).join('\n\n');
                const agentType = context.agent || 'general';
                
                // Agent-specific response formatting
                switch (agentType) {
                    case 'course-creator':
                        return this.formatForCourseCreator(query, combinedContent, context);
                    case 'lesson-planner':
                        return this.formatForLessonPlanner(query, combinedContent, context);
                    case 'technique-auditor':
                        return this.formatForTechniqueAuditor(query, combinedContent, context);
                    case 'instructor-assistant':
                        return this.formatForInstructorAssistant(query, combinedContent, context);
                    case 'student-advisor':
                        return this.formatForStudentAdvisor(query, combinedContent, context);
                    default:
                        return this.formatGeneralResponse(query, combinedContent, context);
                }
            }
            
            // Agent-specific formatting methods
            formatForCourseCreator(query, content, context) {
                return `ðŸ“š **OrientaÃ§Ã£o para CriaÃ§Ã£o de Curso:** Baseado na base de conhecimento, para ${context.martialArt || 'esta arte marcial'} ${context.level || ''}: ${content.substring(0, 300)}. Recomendo seguir essa metodologia na estruturaÃ§Ã£o do curso.`;
            }
            
            formatForLessonPlanner(query, content, context) {
                return `ðŸ“ **OrientaÃ§Ã£o para Plano de Aula:** Para esta aula especÃ­fica, a base de conhecimento sugere: ${content.substring(0, 250)}. Adapte conforme o nÃ­vel da turma e objetivos especÃ­ficos.`;
            }
            
            formatForTechniqueAuditor(query, content, context) {
                return `ðŸ” **AnÃ¡lise de TÃ©cnica:** Segundo os padrÃµes documentados: ${content.substring(0, 200)}. Use estes critÃ©rios para validar a qualidade e consistÃªncia das tÃ©cnicas.`;
            }
            
            formatForInstructorAssistant(query, content, context) {
                return `ðŸ‘¨â€ðŸ« **Suporte ao Instrutor:** Com base na experiÃªncia documentada: ${content.substring(0, 250)}. Esta orientaÃ§Ã£o pode ajudar na conduÃ§Ã£o da aula.`;
            }
            
            formatForStudentAdvisor(query, content, context) {
                return `ðŸŽ“ **OrientaÃ§Ã£o ao Aluno:** Baseado nas melhores prÃ¡ticas: ${content.substring(0, 250)}. Isso pode ajudar no seu desenvolvimento e progresso.`;
            }
            
            formatGeneralResponse(query, content, context) {
                return `ðŸ’¡ **InformaÃ§Ã£o da Base de Conhecimento:** ${content.substring(0, 300)}. Esta informaÃ§Ã£o estÃ¡ baseada no conteÃºdo que vocÃª adicionou ao sistema.`;
            }
        }
        
        // Initialize Central RAG Service
        const centralRAG = new CentralRAGService();
        
        // RAG-Enhanced AI generation for lesson plans
        async function simulateAIGeneration(formData) {
            return new Promise(async (resolve) => {
                try {
                    // Query Central RAG for lesson planning guidance
                    const context = {
                        agent: 'lesson-planner',
                        unit: formData.unit,
                        technique: formData.mainTechnique,
                        module: 'lesson-planning'
                    };
                    
                    const ragQueries = [
                        `plano aula ${formData.unit} ${formData.mainTechnique}`,
                        `metodologia ensino ${formData.mainTechnique}`,
                        `progressÃ£o pedagÃ³gica aquecimento tÃ©cnica`,
                        'adaptaÃ§Ãµes necessidades especiais ensino'
                    ];
                    
                    let ragEnhancements = [];
                    
                    for (const query of ragQueries) {
                        const ragResponse = await centralRAG.queryKnowledge(query, context);
                        if (ragResponse.success) {
                            ragEnhancements.push(ragResponse);
                        }
                    }
                    
                    setTimeout(() => {
                        const enhancedPlan = {
                            lesson: formData.lessonNumber,
                            unit: formData.unit,
                            technique: formData.mainTechnique,
                            objectives: formData.objectives.split(',').map(obj => obj.trim()),
                            warmup: generateWarmupActivities(formData.unit),
                            techniques: generateTechniqueActivities(formData.mainTechnique),
                            simulations: generateSimulationActivities(formData.mainTechnique),
                            cooldown: generateCooldownActivities(),
                            adaptations: generateAdaptations(formData.specialNeeds),
                            equipment: generateEquipmentList(formData.unit),
                            tacticalModule: generateTacticalModule(formData.unit),
                            ragEnhancements: ragEnhancements,
                            enhancedBy: 'Central RAG System'
                        };
                        
                        console.log('ðŸ§  RAG-Enhanced Lesson Plan Generated:', enhancedPlan);
                        resolve(enhancedPlan);
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error in RAG-enhanced generation:', error);
                    resolve();
                }
            });
        }

        // AI Helper Functions for generating lesson plan components
        function generateWarmupActivities(unit) {
            const warmups = {
                'fundamentos': ['Aquecimento articular', 'Corrida leve', 'ExercÃ­cios de coordenaÃ§Ã£o'],
                'golpes': ['Shadowboxing', 'Aquecimento de punhos', 'Mobilidade de ombros'],
                'defesas': ['ExercÃ­cios de reaÃ§Ã£o', 'Aquecimento defensivo', 'CoordenaÃ§Ã£o motora'],
                'avancadas': ['Aquecimento intenso', 'ExercÃ­cios de agilidade', 'PreparaÃ§Ã£o mental'],
                'integracao': ['Aquecimento completo', 'PreparaÃ§Ã£o para combos', 'ExercÃ­cios de fluidez']
            };
            return warmups[unit] || ['Aquecimento geral'];
        }

        function generateTechniqueActivities(technique) {
            return [
                `DemonstraÃ§Ã£o da tÃ©cnica: ${technique}`,
                'PrÃ¡tica em slow motion',
                'RepetiÃ§Ãµes com parceiro',
                'CorreÃ§Ã£o de postura',
                'PrÃ¡tica em velocidade normal'
            ];
        }

        function generateSimulationActivities(technique) {
            return [
                `AplicaÃ§Ã£o de ${technique} em cenÃ¡rio simulado`,
                'VariaÃ§Ãµes de distÃ¢ncia',
                'CenÃ¡rios de pressÃ£o',
                'CombinaÃ§Ãµes com outras tÃ©cnicas'
            ];
        }

        function generateCooldownActivities() {
            return [
                'Alongamento geral',
                'ExercÃ­cios de respiraÃ§Ã£o',
                'Relaxamento muscular',
                'ReflexÃ£o sobre a aula'
            ];
        }

        function generateAdaptations(specialNeeds) {
            const adaptations = {};
            if (specialNeeds.includes('TEA')) {
                adaptations.TEA = 'DemonstraÃ§Ã£o visual clara, instruÃ§Ãµes estruturadas, ambiente previsÃ­vel';
            }
            if (specialNeeds.includes('TDAH')) {
                adaptations.TDAH = 'InstruÃ§Ãµes curtas, pausas frequentes, atividades dinÃ¢micas';
            }
            if (specialNeeds.includes('MOBILIDADE_REDUZIDA')) {
                adaptations.MOBILIDADE_REDUZIDA = 'AdaptaÃ§Ãµes para movimentos limitados, exercÃ­cios sentados';
            }
            return adaptations;
        }

        function generateEquipmentList(unit) {
            const equipment = {
                'fundamentos': ['Tatame', 'Espelho'],
                'golpes': ['Tatame', 'Pads de foco', 'Luvas'],
                'defesas': ['Tatame', 'Equipamentos de proteÃ§Ã£o'],
                'avancadas': ['Tatame', 'Equipamentos variados', 'ProteÃ§Ãµes'],
                'integracao': ['Tatame completo', 'Todos equipamentos']
            };
            return equipment[unit] || ['Tatame bÃ¡sico'];
        }

        function generateTacticalModule(unit) {
            const modules = {
                'fundamentos': 'RegulaÃ§Ã£o Emocional',
                'golpes': 'PrecisÃ£o e Timing',
                'defesas': 'ConsciÃªncia Situacional',
                'avancadas': 'Tomada de DecisÃ£o',
                'integracao': 'AplicaÃ§Ã£o PrÃ¡tica'
            };
            return modules[unit] || 'Desenvolvimento TÃ¡tico';
        }

        // Auto-fill technique based on unit selection
        document.getElementById('aiLessonUnit').addEventListener('change', function() {
            const unit = this.value;
            const techniqueField = document.getElementById('aiMainTechnique');
            const techniques = {
                'fundamentos': 'Guarda de Boxe',
                'golpes': 'Jab (Soco Direto)',
                'defesas': 'Defesa 360Â° Interior',
                'avancadas': 'Defesa contra Agarramento',
                'integracao': 'Combo Jab-Cross-Hook'
            };
            if (techniques[unit]) {
                techniqueField.value = techniques[unit];
            }
        });

        // ==========================================
        // SISTEMA DE AUDITORIA IA
        // ==========================================

        let currentTechniqueForAudit = null;
        let currentVideoFile = null;

        // Open audit panel
        function openTechniqueAuditPanel() {
            document.getElementById('auditPanel').style.display = 'block';
            updateAuditStats();
        }

        // Close audit panel
        function closeAuditPanel() {
            document.getElementById('auditPanel').style.display = 'none';
        }

        // Run full audit with IA
        async function runFullAudit() {
            const auditBtn = document.querySelector('#auditPanel .btn-primary');
            const originalText = auditBtn.innerHTML;
            
            auditBtn.innerHTML = '<span>ðŸ¤–</span> Analisando...';
            auditBtn.disabled = true;

            try {
                // Simulate IA audit process
                await simulateAIAudit();
                
                showToast('Auditoria IA concluÃ­da com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro na auditoria:', error);
                showToast('Erro durante a auditoria', 'error');
            } finally {
                auditBtn.innerHTML = originalText;
                auditBtn.disabled = false;
            }
        }

        // Simulate AI audit process
        async function simulateAIAudit() {
            const techniques = allTechniques.length > 0 ? allTechniques : generateMockTechniques();
            auditResults = [];
            
            // Step 1: Detect duplicates
            document.getElementById('auditResults').innerHTML = `
                <div style="color: #F59E0B; padding: 1rem;">
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">ðŸ” Etapa 1/3: Detectando Duplicatas...</div>
                    <div class="progress-bar" style="background: #374151; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: #F59E0B; height: 100%; width: 33%; transition: width 0.3s;"></div>
                    </div>
                </div>
            `;
            await sleep(1000);
            
            // Step 2: Analyze quality
            document.getElementById('auditResults').innerHTML = `
                <div style="color: #3B82F6; padding: 1rem;">
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">ðŸŽ¯ Etapa 2/3: Analisando Qualidade...</div>
                    <div class="progress-bar" style="background: #374151; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: #3B82F6; height: 100%; width: 66%; transition: width 0.3s;"></div>
                    </div>
                </div>
            `;
            await sleep(1000);
            
            // Step 3: Generate results
            document.getElementById('auditResults').innerHTML = `
                <div style="color: #10B981; padding: 1rem;">
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">ðŸ“Š Etapa 3/3: Gerando RelatÃ³rio...</div>
                    <div class="progress-bar" style="background: #374151; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: #10B981; height: 100%; width: 100%; transition: width 0.3s;"></div>
                    </div>
                </div>
            `;
            await sleep(1000);
            
            // Generate audit results with RAG enhancement
            const duplicateResults = detectDuplicates(techniques);
            const qualityResults = analyzeQualityWithRAG(techniques, auditGuidance);
            
            auditResults = [...duplicateResults, ...qualityResults];
            
            // Add RAG insights to results
            if (auditGuidance.success) {
                auditResults.unshift({
                    type: 'RAG_INSIGHT',
                    technique: null,
                    severity: 'INFO',
                    message: `ðŸ§  Base de Conhecimento: ${auditGuidance.answer}`,
                    confidence: auditGuidance.confidence,
                    sources: auditGuidance.sources
                });
            }
            
            displayAuditResults();
            updateAuditStats();
        }

        // Detect duplicate techniques
        function detectDuplicates(techniques) {
            const duplicates = [];
            const seen = new Map();
            
            techniques.forEach(tech => {
                const key = `${tech.martialArt}-${tech.category}-${tech.name.toLowerCase()}`;
                if (seen.has(key)) {
                    const original = seen.get(key);
                    duplicates.push({
                        type: 'DUPLICATE',
                        technique: tech,
                        originalTechnique: original,
                        severity: 'HIGH',
                        message: `TÃ©cnica "${tech.name}" parece ser duplicata de "${original.name}"`
                    });
                } else {
                    seen.set(key, tech);
                }
                
                // Check for similar names (fuzzy matching)
                techniques.forEach(otherTech => {
                    if (tech.id !== otherTech.id && tech.martialArt === otherTech.martialArt) {
                        const similarity = calculateSimilarity(tech.name, otherTech.name);
                        if (similarity > 0.8) {
                            duplicates.push({
                                type: 'SIMILAR',
                                technique: tech,
                                originalTechnique: otherTech,
                                severity: 'MEDIUM',
                                similarity: similarity,
                                message: `TÃ©cnica "${tech.name}" Ã© muito similar a "${otherTech.name}" (${Math.round(similarity * 100)}% similar)`
                            });
                        }
                    }
                });
            });
            
            return duplicates;
        }

        // Analyze technique quality
        function analyzeQuality(techniques) {
            const qualityIssues = [];
            
            techniques.forEach(tech => {
                let score = 100;
                const issues = [];
                
                // Check name length
                if (tech.name.length < 3) {
                    score -= 20;
                    issues.push('Nome muito curto');
                }
                
                // Check description quality
                if (!tech.description || tech.description.length < 10) {
                    score -= 15;
                    issues.push('DescriÃ§Ã£o insuficiente');
                }
                
                // Check prerequisites logic
                if (tech.level === 'ADVANCED' && !tech.prerequisites) {
                    score -= 10;
                    issues.push('TÃ©cnica avanÃ§ada sem prÃ©-requisitos');
                }
                
                // Check martial art consistency
                if (tech.martialArt === 'BOXING' && tech.category === 'GRAPPLING') {
                    score -= 25;
                    issues.push('Incompatibilidade: Boxe nÃ£o inclui tÃ©cnicas de grappling');
                }
                
                // Check video presence for important techniques
                if (tech.level === 'BEGINNER' && !tech.videoUrl) {
                    score -= 5;
                    issues.push('TÃ©cnica bÃ¡sica sem vÃ­deo demonstrativo');
                }
                
                if (score < 80 || issues.length > 0) {
                    qualityIssues.push({
                        type: 'QUALITY',
                        technique: tech,
                        severity: score < 60 ? 'HIGH' : score < 80 ? 'MEDIUM' : 'LOW',
                        score: score,
                        issues: issues,
                        message: `Problemas de qualidade detectados (Score: ${score}/100)`
                    });
                }
            });
            
            return qualityIssues;
        }

        // Calculate name similarity
        function calculateSimilarity(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;
            const matrix = Array(len2 + 1).fill(null).map(() => Array(len1 + 1).fill(null));
            
            for (let i = 0; i <= len1; i++) matrix[0][i] = i;
            for (let j = 0; j <= len2; j++) matrix[j][0] = j;
            
            for (let j = 1; j <= len2; j++) {
                for (let i = 1; i <= len1; i++) {
                    const indicator = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(
                        matrix[j][i - 1] + 1,
                        matrix[j - 1][i] + 1,
                        matrix[j - 1][i - 1] + indicator
                    );
                }
            }
            
            return 1 - matrix[len2][len1] / Math.max(len1, len2);
        }

        // Display audit results
        function displayAuditResults() {
            const resultsDiv = document.getElementById('auditResults');
            
            if (auditResults.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; color: #10B981; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">âœ…</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Auditoria ConcluÃ­da!</div>
                        <div>Nenhum problema detectado. Todas as tÃ©cnicas estÃ£o em ordem.</div>
                    </div>
                `;
                return;
            }
            
            const duplicates = auditResults.filter(r => r.type === 'DUPLICATE' || r.type === 'SIMILAR');
            const qualityIssues = auditResults.filter(r => r.type === 'QUALITY');
            
            let html = '';
            
            if (duplicates.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #EF4444; margin-bottom: 1rem;">ðŸ”´ Duplicatas Detectadas (${duplicates.length})</h3>
                        ${duplicates.map(duplicate => `
                            <div class="audit-item" style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid #EF4444; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                                <div style="display: flex; justify-content: between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: #F8FAFC; margin-bottom: 0.5rem;">
                                            ${duplicate.technique.name} (${duplicate.technique.martialArt})
                                        </div>
                                        <div style="color: #CBD5E1; margin-bottom: 0.5rem;">${duplicate.message}</div>
                                        <div style="font-size: 0.9rem; color: #9CA3AF;">
                                            Severity: ${duplicate.severity}
                                            ${duplicate.similarity ? ` | Similaridade: ${Math.round(duplicate.similarity * 100)}%` : ''}
                                        </div>
                                    </div>
                                    <button onclick="auditTechnique('${duplicate.technique.id}')" 
                                            style="background: #3B82F6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                                        ðŸ” Revisar
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (qualityIssues.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #F59E0B; margin-bottom: 1rem;">âš ï¸ Problemas de Qualidade (${qualityIssues.length})</h3>
                        ${qualityIssues.map(issue => `
                            <div class="audit-item" style="background: rgba(245, 158, 11, 0.1); border-left: 4px solid #F59E0B; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                                <div style="display: flex; justify-content: between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: #F8FAFC; margin-bottom: 0.5rem;">
                                            ${issue.technique.name} (Score: ${issue.score}/100)
                                        </div>
                                        <div style="color: #CBD5E1; margin-bottom: 0.5rem;">
                                            Problemas: ${issue.issues.join(', ')}
                                        </div>
                                        <div style="font-size: 0.9rem; color: #9CA3AF;">
                                            Severity: ${issue.severity}
                                        </div>
                                    </div>
                                    <button onclick="auditTechnique('${issue.technique.id}')" 
                                            style="background: #3B82F6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                                        ðŸ” Revisar
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }

        // Update audit statistics
        function updateAuditStats() {
            const techniques = allTechniques.length > 0 ? allTechniques : generateMockTechniques();
            
            const approved = techniques.filter(t => t.status === 'APPROVED').length;
            const pending = techniques.filter(t => t.status === 'PENDING').length;
            const duplicates = auditResults.filter(r => r.type === 'DUPLICATE' || r.type === 'SIMILAR').length;
            const qualityIssues = auditResults.filter(r => r.type === 'QUALITY').length;
            
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('duplicatesCount').textContent = duplicates;
            document.getElementById('qualityIssuesCount').textContent = qualityIssues;
        }

        // Audit specific technique
        function auditTechnique(techniqueId) {
            const technique = allTechniques.find(t => t.id === techniqueId);
            if (!technique) return;
            
            currentTechniqueForAudit = technique;
            
            const auditData = auditResults.find(r => r.technique.id === techniqueId);
            
            document.getElementById('techniqueAuditContent').innerHTML = `
                <div style="display: grid; gap: 1.5rem;">
                    <!-- Technique Info -->
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                        <h3 style="color: #3B82F6; margin-bottom: 1rem;">ðŸ“‹ InformaÃ§Ãµes da TÃ©cnica</h3>
                        <div style="display: grid; gap: 0.5rem;">
                            <div><strong>Nome:</strong> ${technique.name}</div>
                            <div><strong>Arte Marcial:</strong> ${getMartialArtName(technique.martialArt)}</div>
                            <div><strong>Categoria:</strong> ${getCategoryName(technique.category)}</div>
                            <div><strong>NÃ­vel:</strong> ${getLevelName(technique.level)}</div>
                            <div><strong>Status:</strong> <span style="color: ${getStatusColor(technique.status)}">${getStatusName(technique.status)}</span></div>
                        </div>
                    </div>
                    
                    <!-- Audit Results -->
                    ${auditData ? `
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #EF4444;">
                            <h3 style="color: #EF4444; margin-bottom: 1rem;">âš ï¸ Problemas Detectados</h3>
                            <div style="color: #CBD5E1;">${auditData.message}</div>
                            ${auditData.issues ? `
                                <div style="margin-top: 1rem;">
                                    <strong>Detalhes:</strong>
                                    <ul style="margin-top: 0.5rem; padding-left: 1rem;">
                                        ${auditData.issues.map(issue => `<li>${issue}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Actions -->
                    <div style="background: rgba(55, 65, 81, 0.3); padding: 1rem; border-radius: 8px;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ðŸ› ï¸ AÃ§Ãµes DisponÃ­veis</h3>
                        <div style="display: grid; gap: 1rem;">
                            <button onclick="openVideoUpload('${technique.id}')" 
                                    style="background: #8B5CF6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer;">
                                ðŸ“¹ Adicionar VÃ­deo
                            </button>
                            <button onclick="editTechniqueDetails('${technique.id}')" 
                                    style="background: #F59E0B; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer;">
                                âœï¸ Editar Detalhes
                            </button>
                        </div>
                    </div>
                    
                    <!-- Video Section -->
                    ${technique.videoUrl ? `
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px;">
                            <h3 style="color: #10B981; margin-bottom: 1rem;">ðŸ“¹ VÃ­deo Atual</h3>
                            <div style="color: #CBD5E1;">VÃ­deo jÃ¡ carregado: ${technique.videoUrl}</div>
                        </div>
                    ` : `
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px;">
                            <h3 style="color: #F59E0B; margin-bottom: 1rem;">ðŸ“¹ VÃ­deo Pendente</h3>
                            <div style="color: #CBD5E1;">Nenhum vÃ­deo carregado para esta tÃ©cnica</div>
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('techniqueAuditModal').classList.add('active');
        }

        // Approve technique
        function approveTechnique() {
            if (!currentTechniqueForAudit) return;
            
            currentTechniqueForAudit.status = 'APPROVED';
            currentTechniqueForAudit.lastAuditAt = new Date().toISOString();
            
            // Remove from audit results
            auditResults = auditResults.filter(r => r.technique.id !== currentTechniqueForAudit.id);
            
            updateAuditStats();
            displayAuditResults();
            closeTechniqueAuditModal();
            
            showToast('TÃ©cnica aprovada com sucesso!', 'success');
        }

        // Reject technique
        function rejectTechnique() {
            if (!currentTechniqueForAudit) return;
            
            currentTechniqueForAudit.status = 'REJECTED';
            currentTechniqueForAudit.lastAuditAt = new Date().toISOString();
            
            updateAuditStats();
            displayAuditResults();
            closeTechniqueAuditModal();
            
            showToast('TÃ©cnica rejeitada', 'warning');
        }

        // Edit technique
        function editTechnique() {
            if (!currentTechniqueForAudit) return;
            
            // Open technique for editing
            closeTechniqueAuditModal();
            openTechniquesManager();
            
            // Simulate finding and editing the technique
            showToast('Abrindo tÃ©cnica para ediÃ§Ã£o...', 'info');
        }

        // Close audit modal
        function closeTechniqueAuditModal() {
            document.getElementById('techniqueAuditModal').classList.remove('active');
            currentTechniqueForAudit = null;
        }

        // ==========================================
        // SISTEMA DE VÃDEOS
        // ==========================================

        // Open video upload
        function openVideoUpload(techniqueId) {
            const technique = allTechniques.find(t => t.id === techniqueId);
            if (!technique) return;
            
            currentTechniqueForAudit = technique;
            
            document.getElementById('videoTechniqueInfo').innerHTML = `
                <h4 style="color: #3B82F6; margin-bottom: 0.5rem;">ðŸ“‹ TÃ©cnica: ${technique.name}</h4>
                <div style="color: #CBD5E1; font-size: 0.9rem;">
                    ${getMartialArtName(technique.martialArt)} â€¢ ${getCategoryName(technique.category)} â€¢ ${getLevelName(technique.level)}
                </div>
            `;
            
            document.getElementById('videoUploadModal').classList.add('active');
        }

        // Handle video upload
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/quicktime'];
            if (!validTypes.includes(file.type)) {
                showToast('Formato de vÃ­deo nÃ£o suportado', 'error');
                return;
            }
            
            // Validate file size (100MB)
            if (file.size > 100 * 1024 * 1024) {
                showToast('Arquivo muito grande. MÃ¡ximo: 100MB', 'error');
                return;
            }
            
            currentVideoFile = file;
            
            // Show preview
            const preview = document.getElementById('videoPreview');
            const videoUrl = URL.createObjectURL(file);
            
            preview.innerHTML = `
                <div style="text-align: left; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid #10B981;">
                    <div style="color: #10B981; font-weight: bold; margin-bottom: 0.5rem;">ðŸ“¹ VÃ­deo Selecionado:</div>
                    <div style="color: #F8FAFC; margin-bottom: 0.5rem;">${file.name}</div>
                    <div style="color: #9CA3AF; font-size: 0.8rem; margin-bottom: 1rem;">${formatFileSize(file.size)}</div>
                    <video controls style="width: 100%; max-width: 300px; border-radius: 6px;">
                        <source src="${videoUrl}" type="${file.type}">
                        Seu navegador nÃ£o suporta o elemento de vÃ­deo.
                    </video>
                </div>
            `;
            
            showToast('VÃ­deo carregado e pronto para upload!', 'success');
        }

        // Upload video
        async function uploadVideo() {
            if (!currentVideoFile || !currentTechniqueForAudit) {
                showToast('Selecione um vÃ­deo primeiro', 'error');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadVideoBtn');
            const originalText = uploadBtn.innerHTML;
            
            uploadBtn.innerHTML = '<span>â³</span> Fazendo Upload...';
            uploadBtn.disabled = true;
            
            try {
                // Simulate upload process
                await sleep(2000);
                
                // Update technique with video URL (simulated)
                const videoUrl = `videos/${currentTechniqueForAudit.id}/${currentVideoFile.name}`;
                currentTechniqueForAudit.videoUrl = videoUrl;
                currentTechniqueForAudit.videoDescription = document.getElementById('videoDescription').value;
                
                showToast('VÃ­deo carregado com sucesso!', 'success');
                closeVideoUploadModal();
                
                // Update audit stats
                updateAuditStats();
                
            } catch (error) {
                console.error('Erro no upload:', error);
                showToast('Erro durante o upload', 'error');
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            }
        }

        // Close video upload modal
        function closeVideoUploadModal() {
            document.getElementById('videoUploadModal').classList.remove('active');
            currentVideoFile = null;
            document.getElementById('videoPreview').innerHTML = '';
            document.getElementById('videoDescription').value = '';
        }

        // ==========================================
        // UTILITY FUNCTIONS FOR AUDIT
        // ==========================================

        function getStatusColor(status) {
            const colors = {
                'APPROVED': '#10B981',
                'PENDING': '#F59E0B',
                'REJECTED': '#EF4444'
            };
            return colors[status] || '#6B7280';
        }

        function getStatusName(status) {
            const names = {
                'APPROVED': 'Aprovada',
                'PENDING': 'Pendente',
                'REJECTED': 'Rejeitada'
            };
            return names[status] || status;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ==========================================
        // SISTEMA RAG - BASE DE CONHECIMENTO
        // ==========================================

        // Initialize knowledge base with sample data
        function initializeKnowledgeBase() {
            // Try to load from localStorage first
            const hasStoredData = loadKnowledgeBaseFromStorage();
            
            // If no stored data, initialize with sample data
            if (!hasStoredData) {
                knowledgeBase = [
                {
                    id: '1',
                    type: 'DOCUMENT',
                    title: 'Manual Krav Maga Faixa Branca',
                    content: 'O Krav Maga Ã© um sistema de defesa pessoal desenvolvido para as forÃ§as de defesa israelenses. PrincÃ­pios fundamentais: 1) Evitar conflitos sempre que possÃ­vel, 2) Neutralizar ameaÃ§as rapidamente, 3) Usar movimentos naturais e instintivos...',
                    tags: ['krav-maga', 'defesa-pessoal', 'iniciante', 'principios'],
                    category: 'METHODOLOGY',
                    martialArt: 'KRAV_MAGA',
                    level: 'BEGINNER',
                    createdAt: new Date().toISOString(),
                    chunked: true
                },
                {
                    id: '2',
                    type: 'TEXT',
                    title: 'ProgressÃ£o MetodolÃ³gica para Iniciantes',
                    content: 'A progressÃ£o no Krav Maga deve seguir uma ordem lÃ³gica: 1) ConsciÃªncia situacional e prevenÃ§Ã£o, 2) Posturas e movimentos bÃ¡sicos, 3) TÃ©cnicas de golpes bÃ¡sicos, 4) Defesas contra ataques simples, 5) CombinaÃ§Ãµes e fluxo...',
                    tags: ['progressao', 'metodologia', 'ensino'],
                    category: 'PROGRESSION',
                    martialArt: 'KRAV_MAGA',
                    level: 'BEGINNER',
                    createdAt: new Date().toISOString(),
                    chunked: true
                },
                {
                    id: '3',
                    type: 'LINK',
                    title: 'Fundamentos da BiomecÃ¢nica no Krav Maga',
                    content: 'A biomecÃ¢nica no Krav Maga enfatiza o uso eficiente do corpo para maximizar a forÃ§a enquanto minimiza o gasto energÃ©tico. Conceitos chave incluem: transferÃªncia de peso, rotaÃ§Ã£o de quadril, alinhamento corporal...',
                    url: 'https://exemplo.com/biomecanica-krav-maga',
                    tags: ['biomecanica', 'tecnica', 'fundamentos'],
                    category: 'THEORY',
                    martialArt: 'KRAV_MAGA',
                    level: 'INTERMEDIATE',
                    createdAt: new Date().toISOString(),
                    chunked: true
                }
                ];
                
                // Generate chunks for RAG
                generateRAGChunks();
                
                // Save initial data to localStorage
                saveKnowledgeBaseToStorage();
            }
        }

        // Generate chunks for semantic search
        function generateRAGChunks() {
            ragChunks = [];
            let chunkId = 1;
            
            knowledgeBase.forEach(item => {
                // Split content into chunks of ~200 words
                const words = item.content.split(' ');
                const chunkSize = 200;
                
                for (let i = 0; i < words.length; i += chunkSize) {
                    const chunkWords = words.slice(i, i + chunkSize);
                    const chunkContent = chunkWords.join(' ');
                    
                    ragChunks.push({
                        id: chunkId++,
                        sourceId: item.id,
                        sourceType: item.type,
                        sourceTitle: item.title,
                        content: chunkContent,
                        tags: item.tags,
                        category: item.category,
                        martialArt: item.martialArt,
                        level: item.level,
                        embedding: generateMockEmbedding(chunkContent) // Simulated embedding
                    });
                }
            });
            
            // Save chunks to localStorage after generation
            saveKnowledgeBaseToStorage();
        }

        // Generate mock embedding (in real implementation, use actual AI embedding)
        function generateMockEmbedding(text) {
            // This is a simplified mock - in real implementation, use OpenAI embeddings or similar
            const words = text.toLowerCase().split(' ');
            const vector = new Array(384).fill(0); // 384-dimensional vector
            
            words.forEach((word, index) => {
                const hash = word.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0);
                vector[Math.abs(hash) % 384] += 1;
            });
            
            // Normalize vector
            const magnitude = Math.sqrt(vector.reduce((sum, val) => sum + val * val, 0));
            return vector.map(val => magnitude > 0 ? val / magnitude : 0);
        }

        // Open knowledge base panel
        function openKnowledgeBase() {
            document.getElementById('knowledgeBasePanel').style.display = 'block';
            if (knowledgeBase.length === 0) {
                initializeKnowledgeBase();
            }
            updateKnowledgeBaseStats();
            displayKnowledgeContent();
        }

        // Close knowledge base panel
        function closeKnowledgeBase() {
            document.getElementById('knowledgeBasePanel').style.display = 'none';
        }

        // Update knowledge base statistics
        function updateKnowledgeBaseStats() {
            const documents = knowledgeBase.filter(item => item.type === 'DOCUMENT').length;
            const texts = knowledgeBase.filter(item => item.type === 'TEXT').length;
            const links = knowledgeBase.filter(item => item.type === 'LINK').length;
            const chunks = ragChunks.length;
            
            document.getElementById('documentsCount').textContent = documents;
            document.getElementById('textsCount').textContent = texts;
            document.getElementById('linksCount').textContent = links;
            document.getElementById('chunksCount').textContent = chunks;
            
            const lastIndexed = knowledgeBase.length > 0 ? 'Agora mesmo' : 'Nunca';
            document.getElementById('lastIndexed').textContent = lastIndexed;
        }

        // Display knowledge content
        function displayKnowledgeContent() {
            const contentDiv = document.getElementById('knowledgeContent');
            
            if (knowledgeBase.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; color: #CBD5E1; padding: 2rem;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸ§ </div>
                        Sua base de conhecimento estÃ¡ vazia. Clique em "Adicionar ConteÃºdo" para comeÃ§ar.
                    </div>
                `;
                return;
            }
            
            const groupedByType = {
                'DOCUMENT': knowledgeBase.filter(item => item.type === 'DOCUMENT'),
                'TEXT': knowledgeBase.filter(item => item.type === 'TEXT'),
                'LINK': knowledgeBase.filter(item => item.type === 'LINK'),
                'YOUTUBE': knowledgeBase.filter(item => item.type === 'YOUTUBE')
            };
            
            let html = '';
            
            Object.entries(groupedByType).forEach(([type, items]) => {
                if (items.length === 0) return;
                
                const typeInfo = {
                    'DOCUMENT': { icon: 'ðŸ“„', name: 'Documentos', color: '#8B5CF6' },
                    'TEXT': { icon: 'ðŸ“', name: 'Textos', color: '#10B981' },
                    'LINK': { icon: 'ðŸ”—', name: 'Links', color: '#3B82F6' },
                    'YOUTUBE': { icon: 'ðŸ“º', name: 'YouTube', color: '#EF4444' }
                };
                
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: ${typeInfo[type].color}; margin-bottom: 1rem;">${typeInfo[type].icon} ${typeInfo[type].name} (${items.length})</h3>
                        ${items.map(item => `
                            <div style="background: rgba(55, 65, 81, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid ${typeInfo[type].color};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: #F8FAFC; margin-bottom: 0.5rem;">${item.title}</div>
                                        <div style="color: #CBD5E1; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                            ${item.content.length > 100 ? item.content.substring(0, 100) + '...' : item.content}
                                        </div>
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                                            ${item.tags.map(tag => `
                                                <span style="background: ${typeInfo[type].color}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                                    ${tag}
                                                </span>
                                            `).join('')}
                                        </div>
                                        <div style="font-size: 0.8rem; color: #9CA3AF;">
                                            ${getMartialArtName(item.martialArt)} â€¢ ${item.category} â€¢ ${item.level}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button onclick="editKnowledgeItem('${item.id}')" 
                                                style="background: #F59E0B; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">
                                            âœï¸
                                        </button>
                                        <button onclick="deleteKnowledgeItem('${item.id}')" 
                                                style="background: #EF4444; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">
                                            ðŸ—‘ï¸
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
        }

        // Open document uploader
        function openDocumentUploader() {
            console.log('ðŸ“Ž Abrindo modal de upload...');
            const modal = document.getElementById('documentUploaderModal');
            if (modal) {
                modal.classList.add('active');
                switchUploadTab('documents');
                console.log('âœ… Modal de upload aberto com sucesso!');
            } else {
                console.error('âŒ Modal documentUploaderModal nÃ£o encontrado!');
            }
        }

        // Close document uploader
        function closeDocumentUploader() {
            document.getElementById('documentUploaderModal').classList.remove('active');
            resetUploadForm();
        }

        // Switch upload tab
        function switchUploadTab(tabName) {
            currentUploadTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.upload-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Show/hide sections
            document.querySelectorAll('.upload-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(tabName + 'Section').style.display = 'block';
        }

        // Handle document upload
        function handleDocumentUpload(event) {
            const files = Array.from(event.target.files);
            uploadedDocuments = files;
            
            displayDocumentPreview(files);
        }

        // Display document preview
        function displayDocumentPreview(files) {
            const preview = document.getElementById('documentPreview');
            
            if (files.length === 0) {
                preview.innerHTML = '';
                return;
            }
            
            preview.innerHTML = `
                <div style="text-align: left; margin-top: 1rem; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid #8B5CF6;">
                    <div style="color: #8B5CF6; font-weight: bold; margin-bottom: 0.5rem;">ðŸ“Ž ${files.length} Arquivo(s) Selecionado(s):</div>
                    ${files.map(file => `
                        <div style="color: #F8FAFC; margin-bottom: 0.25rem;">
                            ${getFileIcon(file.name)} ${file.name} (${formatFileSize(file.size)})
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Upload content to knowledge base
        async function uploadContent() {
            console.log('ðŸš€ Iniciando upload de conteÃºdo...');
            const uploadBtn = document.getElementById('uploadContentBtn');
            const originalText = uploadBtn.innerHTML;
            
            uploadBtn.innerHTML = '<span>â³</span> Processando...';
            uploadBtn.disabled = true;
            
            try {
                console.log('ðŸ“Š Tab atual:', currentUploadTab);
                let newItems = [];
                
                switch (currentUploadTab) {
                    case 'documents':
                        console.log('ðŸ“„ Processando documentos...');
                        newItems = await processDocuments();
                        break;
                    case 'text':
                        console.log('ðŸ“ Processando texto...');
                        newItems = await processTextInput();
                        break;
                    case 'links':
                        console.log('ðŸ”— Processando links...');
                        newItems = await processLink();
                        break;
                    case 'youtube':
                        console.log('ðŸ“º Processando YouTube...');
                        newItems = await processYouTube();
                        break;
                }
                
                // Add to knowledge base
                console.log('ðŸ“š Itens processados:', newItems.length);
                console.log('ðŸ“ Base antes:', knowledgeBase.length);
                
                knowledgeBase.push(...newItems);
                
                console.log('ðŸ“ Base depois:', knowledgeBase.length);
                
                // Regenerate chunks
                console.log('âš¡ Gerando chunks RAG...');
                generateRAGChunks();
                
                // Save to localStorage (generateRAGChunks already saves, but being explicit)
                console.log('ðŸ’¾ Salvando no localStorage...');
                saveKnowledgeBaseToStorage();
                
                // Update display
                console.log('ðŸ”„ Atualizando interface...');
                updateKnowledgeBaseStats();
                displayKnowledgeContent();
                
                // Also update main section if it's open
                const currentSection = document.querySelector('.content-section:not([style*="display: none"])');
                if (currentSection && currentSection.id === 'knowledge-base') {
                    displayKnowledgeContentInMain();
                }
                
                closeDocumentUploader();
                
                // Show detailed success message
                const successMessage = `âœ… SUCESSO! ${newItems.length} item(s) processado(s):
ðŸ“ Base: ${knowledgeBase.length} itens total
ðŸ§  Chunks: ${ragChunks.length} chunks RAG
ðŸ’¾ Salvo no localStorage
ðŸ”„ Interface atualizada`;
                
                showToast(successMessage, 'success');
                
                // Also log detailed info to console
                console.log('ðŸŽ‰ UPLOAD COMPLETO!');
                console.log('ðŸ“Š EstatÃ­sticas finais:');
                console.log('  ðŸ“ Total na base:', knowledgeBase.length);
                console.log('  ðŸ§  Total chunks:', ragChunks.length);
                console.log('  ðŸ’¾ Salvo no localStorage:', !!localStorage.getItem('academiaKnowledgeBase'));
                console.log('  ðŸ“‹ Itens adicionados:', newItems.map(item => item.title));
                
            } catch (error) {
                console.error('Erro no upload:', error);
                showToast('Erro ao processar conteÃºdo', 'error');
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            }
        }

        // Process documents
        async function processDocuments() {
            if (uploadedDocuments.length === 0) {
                throw new Error('Nenhum documento selecionado');
            }
            
            const tags = document.getElementById('documentTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const items = [];
            
            for (const file of uploadedDocuments) {
                // Simulate document processing
                await sleep(500);
                
                const content = await simulateDocumentExtraction(file);
                
                items.push({
                    id: generateId(),
                    type: 'DOCUMENT',
                    title: file.name.replace(/\.[^/.]+$/, ''),
                    content: content,
                    filename: file.name,
                    fileSize: file.size,
                    tags: tags,
                    category: 'METHODOLOGY',
                    martialArt: 'GENERAL',
                    level: 'BEGINNER',
                    createdAt: new Date().toISOString(),
                    chunked: false
                });
            }
            
            return items;
        }

        // Process text input
        async function processTextInput() {
            console.log('âœï¸ Processando entrada de texto...');
            const title = document.getElementById('textTitle').value.trim();
            const content = document.getElementById('textContent').value.trim();
            const category = document.getElementById('textCategory').value || 'METHODOLOGY';
            const tags = document.getElementById('textTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            console.log('ðŸ“ Dados coletados:', { title, content: content.substring(0, 50) + '...', category, tags });
            
            if (!title || !content) {
                console.error('âŒ TÃ­tulo ou conteÃºdo vazio');
                throw new Error('TÃ­tulo e conteÃºdo sÃ£o obrigatÃ³rios');
            }
            
            const newItem = {
                id: generateId(),
                type: 'TEXT',
                title: title,
                content: content,
                tags: tags,
                category: category,
                martialArt: 'GENERAL',
                level: 'BEGINNER',
                createdAt: new Date().toISOString(),
                chunked: false
            };
            
            console.log('âœ… Item de texto criado:', newItem);
            return [newItem];
        }

        // Process link
        async function processLink() {
            const url = document.getElementById('linkUrl').value.trim();
            const title = document.getElementById('linkTitle').value.trim();
            const description = document.getElementById('linkDescription').value.trim();
            const tags = document.getElementById('linkTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            if (!url) {
                throw new Error('URL Ã© obrigatÃ³ria');
            }
            
            // Simulate web scraping
            await sleep(1000);
            const extractedContent = await simulateWebScraping(url);
            
            return [{
                id: generateId(),
                type: 'LINK',
                title: title || extractedContent.title,
                content: description || extractedContent.content,
                url: url,
                tags: tags,
                category: 'THEORY',
                martialArt: 'GENERAL',
                level: 'INTERMEDIATE',
                createdAt: new Date().toISOString(),
                chunked: false
            }];
        }

        // Process YouTube
        async function processYouTube() {
            const url = document.getElementById('youtubeUrl').value.trim();
            const description = document.getElementById('youtubeDescription').value.trim();
            const tags = document.getElementById('youtubeTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            if (!url || !url.includes('youtube.com')) {
                throw new Error('URL vÃ¡lida do YouTube Ã© obrigatÃ³ria');
            }
            
            // Simulate YouTube transcript extraction
            await sleep(1500);
            const transcriptData = await simulateYouTubeTranscript(url);
            
            return [{
                id: generateId(),
                type: 'YOUTUBE',
                title: transcriptData.title,
                content: description || transcriptData.transcript,
                url: url,
                videoId: transcriptData.videoId,
                duration: transcriptData.duration,
                tags: tags,
                category: 'TECHNIQUES',
                martialArt: 'GENERAL',
                level: 'INTERMEDIATE',
                createdAt: new Date().toISOString(),
                chunked: false
            }];
        }

        // Simulate document extraction (in real implementation, use PDF.js, mammoth.js, etc.)
        async function simulateDocumentExtraction(file) {
            const sampleContents = {
                'pdf': 'ConteÃºdo extraÃ­do do PDF: Este documento contÃ©m informaÃ§Ãµes detalhadas sobre tÃ©cnicas de defesa pessoal, incluindo posturas bÃ¡sicas, movimentos fundamentais e princÃ­pios de seguranÃ§a...',
                'doc': 'ConteÃºdo extraÃ­do do DOC: Manual de treinamento com metodologia estruturada para ensino de artes marciais, progressÃ£o pedagÃ³gica e avaliaÃ§Ã£o de alunos...',
                'txt': 'ConteÃºdo do arquivo TXT: Notas e observaÃ§Ãµes sobre a aplicaÃ§Ã£o prÃ¡tica de tÃ©cnicas em situaÃ§Ãµes reais, consideraÃ§Ãµes de seguranÃ§a e adaptaÃ§Ãµes para diferentes pÃºblicos...'
            };
            
            const extension = file.name.split('.').pop().toLowerCase();
            return sampleContents[extension] || 'ConteÃºdo extraÃ­do do documento carregado com informaÃ§Ãµes relevantes para a base de conhecimento.';
        }

        // Simulate web scraping
        async function simulateWebScraping(url) {
            return {
                title: 'Artigo sobre BiomecÃ¢nica em Artes Marciais',
                content: 'Artigo tÃ©cnico sobre a aplicaÃ§Ã£o de princÃ­pios biomecÃ¢nicos no treinamento de artes marciais, incluindo anÃ¡lise de movimento, eficiÃªncia energÃ©tica e prevenÃ§Ã£o de lesÃµes...'
            };
        }

        // Simulate YouTube transcript
        async function simulateYouTubeTranscript(url) {
            const videoId = url.split('v=')[1] || 'mock-video-id';
            
            return {
                title: 'Tutorial: TÃ©cnica de Defesa BÃ¡sica',
                videoId: videoId,
                duration: '8:45',
                transcript: 'TranscriÃ§Ã£o do vÃ­deo: Hoje vamos aprender a tÃ©cnica bÃ¡sica de defesa contra agarramento frontal. Primeiro, posicionem os pÃ©s na largura dos ombros...'
            };
        }

        // Reset upload form
        function resetUploadForm() {
            uploadedDocuments = [];
            
            // Clear all form fields
            document.getElementById('documentFiles').value = '';
            document.getElementById('documentTags').value = '';
            document.getElementById('documentPreview').innerHTML = '';
            
            document.getElementById('textTitle').value = '';
            document.getElementById('textContent').value = '';
            document.getElementById('textCategory').value = '';
            document.getElementById('textTags').value = '';
            
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkTitle').value = '';
            document.getElementById('linkDescription').value = '';
            document.getElementById('linkTags').value = '';
            
            document.getElementById('youtubeUrl').value = '';
            document.getElementById('youtubeDescription').value = '';
            document.getElementById('youtubeTags').value = '';
        }

        // Search knowledge base
        function searchKnowledge() {
            const query = document.getElementById('knowledgeSearch').value.trim();
            if (!query) {
                displayKnowledgeContent();
                return;
            }
            
            // Simple text search (in real implementation, use semantic search)
            const results = knowledgeBase.filter(item => 
                item.title.toLowerCase().includes(query.toLowerCase()) ||
                item.content.toLowerCase().includes(query.toLowerCase()) ||
                item.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
            );
            
            displaySearchResults(results, query);
        }

        // Display search results
        function displaySearchResults(results, query) {
            const contentDiv = document.getElementById('knowledgeContent');
            
            if (results.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; color: #CBD5E1; padding: 2rem;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸ”</div>
                        Nenhum resultado encontrado para "${query}"
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                    <h3 style="color: #3B82F6; margin-bottom: 0.5rem;">ðŸ” Resultados da Busca</h3>
                    <div style="color: #CBD5E1;">Encontrados ${results.length} resultado(s) para "${query}"</div>
                </div>
            `;
            
            results.forEach(item => {
                const typeInfo = {
                    'DOCUMENT': { icon: 'ðŸ“„', color: '#8B5CF6' },
                    'TEXT': { icon: 'ðŸ“', color: '#10B981' },
                    'LINK': { icon: 'ðŸ”—', color: '#3B82F6' },
                    'YOUTUBE': { icon: 'ðŸ“º', color: '#EF4444' }
                };
                
                const info = typeInfo[item.type];
                
                html += `
                    <div style="background: rgba(55, 65, 81, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid ${info.color};">
                        <div style="font-weight: bold; color: #F8FAFC; margin-bottom: 0.5rem;">
                            ${info.icon} ${item.title}
                        </div>
                        <div style="color: #CBD5E1; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            ${highlightQuery(item.content.substring(0, 200) + '...', query)}
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${item.tags.map(tag => `
                                <span style="background: ${info.color}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                    ${highlightQuery(tag, query)}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
        }

        // Highlight query in text
        function highlightQuery(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark style="background: #F59E0B; color: #000;">$1</mark>');
        }

        // Test RAG system
        function testRAG() {
            document.getElementById('ragTestModal').classList.add('active');
        }

        // Close RAG test modal
        function closeRAGTest() {
            document.getElementById('ragTestModal').classList.remove('active');
            document.getElementById('ragQuestion').value = '';
            document.getElementById('ragResults').innerHTML = `
                <div style="text-align: center; color: #9CA3AF; padding: 2rem;">
                    Digite sua pergunta e clique em "Consultar RAG" para ver a resposta
                </div>
            `;
        }

        // Consult RAG system
        async function consultRAG() {
            const question = document.getElementById('ragQuestion').value.trim();
            const martialArt = document.getElementById('ragMartialArt').value;
            const level = document.getElementById('ragLevel').value;
            
            if (!question) {
                showToast('Digite uma pergunta primeiro', 'error');
                return;
            }
            
            const consultBtn = document.getElementById('consultRAGBtn');
            const originalText = consultBtn.innerHTML;
            
            consultBtn.innerHTML = '<span>ðŸ§ </span> Consultando...';
            consultBtn.disabled = true;
            
            try {
                // Simulate RAG query
                const response = await simulateRAGQuery(question, martialArt, level);
                displayRAGResponse(response);
                
            } catch (error) {
                console.error('Erro na consulta RAG:', error);
                showToast('Erro na consulta', 'error');
            } finally {
                consultBtn.innerHTML = originalText;
                consultBtn.disabled = false;
            }
        }

        // Simulate RAG query (in real implementation, use vector search + LLM)
        async function simulateRAGQuery(question, martialArt, level) {
            await sleep(1500);
            
            // Find relevant chunks based on keywords
            const queryWords = question.toLowerCase().split(' ');
            const relevantChunks = ragChunks.filter(chunk => {
                const chunkWords = chunk.content.toLowerCase();
                return queryWords.some(word => chunkWords.includes(word)) ||
                       (martialArt && chunk.martialArt === martialArt) ||
                       (level && chunk.level === level);
            }).slice(0, 3); // Top 3 most relevant chunks
            
            if (relevantChunks.length === 0) {
                return {
                    answer: 'Desculpe, nÃ£o encontrei informaÃ§Ãµes relevantes na sua base de conhecimento para responder essa pergunta. Considere adicionar mais conteÃºdo relacionado ao tema.',
                    sources: [],
                    confidence: 0
                };
            }
            
            // Simulate LLM response based on retrieved chunks
            const context = relevantChunks.map(chunk => chunk.content).join('\n\n');
            
            return {
                answer: `Baseado na sua base de conhecimento, posso responder: ${generateContextualAnswer(question, context)}`,
                sources: relevantChunks.map(chunk => ({
                    title: chunk.sourceTitle,
                    type: chunk.sourceType,
                    relevantText: chunk.content.substring(0, 150) + '...'
                })),
                confidence: Math.round(Math.random() * 30 + 70) // 70-100%
            };
        }

        // Generate contextual answer
        function generateContextualAnswer(question, context) {
            const questionLower = question.toLowerCase();
            
            if (questionLower.includes('defesa') && questionLower.includes('iniciante')) {
                return 'Para iniciantes, a defesa deve comeÃ§ar com consciÃªncia situacional e prevenÃ§Ã£o. As tÃ©cnicas bÃ¡sicas incluem posturas defensivas, movimentos naturais e contra-ataques simples. Ã‰ importante sempre priorizar a fuga e buscar ajuda quando possÃ­vel.';
            }
            
            if (questionLower.includes('progressÃ£o') || questionLower.includes('metodologia')) {
                return 'A progressÃ£o metodolÃ³gica deve seguir uma sequÃªncia lÃ³gica: primeiro os fundamentos (postura, distÃ¢ncia), depois tÃ©cnicas bÃ¡sicas (golpes simples), defesas contra ataques comuns, e por fim combinaÃ§Ãµes mais complexas. Cada etapa deve ser dominada antes de avanÃ§ar.';
            }
            
            if (questionLower.includes('ensinar') || questionLower.includes('instrutor')) {
                return 'Para ensinar efetivamente, utilize demonstraÃ§Ã£o clara, prÃ¡tica repetitiva, correÃ§Ã£o individual e progressÃ£o gradual. Adapte as tÃ©cnicas conforme a capacidade de cada aluno e sempre enfatize a seguranÃ§a e os princÃ­pios fundamentais.';
            }
            
            return 'Baseado no contexto da sua base de conhecimento, esta informaÃ§Ã£o estÃ¡ relacionada aos princÃ­pios e metodologias que vocÃª documentou. Recomendo revisar os documentos especÃ­ficos para detalhes mais aprofundados.';
        }

        // Display RAG response
        function displayRAGResponse(response) {
            const resultsDiv = document.getElementById('ragResults');
            
            resultsDiv.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <!-- Answer -->
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #10B981;">
                        <h4 style="color: #10B981; margin-bottom: 0.5rem;">ðŸ¤– Resposta da IA</h4>
                        <div style="color: #F8FAFC; line-height: 1.6;">${response.answer}</div>
                    </div>
                    
                    <!-- Confidence -->
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #3B82F6; font-weight: bold;">ConfianÃ§a da Resposta:</span>
                            <span style="color: #F8FAFC; font-size: 1.1rem;">${response.confidence}%</span>
                        </div>
                        <div style="background: #374151; height: 6px; border-radius: 3px; margin-top: 0.5rem; overflow: hidden;">
                            <div style="background: #3B82F6; height: 100%; width: ${response.confidence}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <!-- Sources -->
                    ${response.sources.length > 0 ? `
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px;">
                            <h4 style="color: #F59E0B; margin-bottom: 0.5rem;">ðŸ“š Fontes Consultadas</h4>
                            ${response.sources.map(source => `
                                <div style="background: rgba(55, 65, 81, 0.5); padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 6px;">
                                    <div style="font-weight: bold; color: #F8FAFC; margin-bottom: 0.25rem;">
                                        ${getTypeIcon(source.type)} ${source.title}
                                    </div>
                                    <div style="color: #CBD5E1; font-size: 0.9rem;">${source.relevantText}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Get type icon
        function getTypeIcon(type) {
            const icons = {
                'DOCUMENT': 'ðŸ“„',
                'TEXT': 'ðŸ“',
                'LINK': 'ðŸ”—',
                'YOUTUBE': 'ðŸ“º'
            };
            return icons[type] || 'ðŸ“„';
        }

        // Reindex knowledge base
        async function reindexKnowledgeBase() {
            const reindexBtn = document.querySelector('#knowledgeBasePanel .btn-success');
            const originalText = reindexBtn.innerHTML;
            
            reindexBtn.innerHTML = '<span>âš¡</span> Reindexando...';
            reindexBtn.disabled = true;
            
            try {
                await sleep(2000);
                generateRAGChunks();
                updateKnowledgeBaseStats();
                
                showToast('Base de conhecimento reindexada com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro na reindexaÃ§Ã£o:', error);
                showToast('Erro durante a reindexaÃ§Ã£o', 'error');
            } finally {
                reindexBtn.innerHTML = originalText;
                reindexBtn.disabled = false;
            }
        }

        // Edit knowledge item (placeholder)
        function editKnowledgeItem(itemId) {
            showToast('Funcionalidade de ediÃ§Ã£o serÃ¡ implementada', 'info');
        }

        // Delete knowledge item
        function deleteKnowledgeItem(itemId) {
            if (confirm('Tem certeza que deseja remover este item da base de conhecimento?')) {
                knowledgeBase = knowledgeBase.filter(item => item.id !== itemId);
                generateRAGChunks();
                updateKnowledgeBaseStats();
                displayKnowledgeContent();
                showToast('Item removido da base de conhecimento', 'success');
            }
        }

        // RAG-Enhanced audit helper functions
        function analyzeQualityWithRAG(techniques, ragGuidance) {
            const qualityIssues = [];
            
            // Extract quality criteria from RAG if available
            const ragCriteria = extractQualityCriteria(ragGuidance);
            
            techniques.forEach(tech => {
                let score = 100;
                const issues = [];
                
                // Standard quality checks
                if (tech.name.length < 3) {
                    score -= 20;
                    issues.push('Nome muito curto');
                }
                
                if (!tech.description || tech.description.length < 10) {
                    score -= 15;
                    issues.push('DescriÃ§Ã£o insuficiente');
                }
                
                if (tech.level === 'ADVANCED' && !tech.prerequisites) {
                    score -= 10;
                    issues.push('TÃ©cnica avanÃ§ada sem prÃ©-requisitos');
                }
                
                // RAG-Enhanced quality checks
                if (ragCriteria.length > 0) {
                    ragCriteria.forEach(criterion => {
                        if (!evaluateCriterion(tech, criterion)) {
                            score -= criterion.penalty;
                            issues.push(`ðŸ§  RAG: ${criterion.message}`);
                        }
                    });
                }
                
                // Check consistency with RAG standards
                if (ragGuidance.success) {
                    if (tech.description && !containsKeyElements(tech.description, ragGuidance)) {
                        score -= 5;
                        issues.push('ðŸ§  RAG: DescriÃ§Ã£o nÃ£o segue padrÃµes documentados');
                    }
                }
                
                if (issues.length > 0) {
                    qualityIssues.push({
                        type: 'QUALITY',
                        technique: tech,
                        severity: score < 60 ? 'HIGH' : (score < 80 ? 'MEDIUM' : 'LOW'),
                        score: score,
                        issues: issues,
                        message: `TÃ©cnica "${tech.name}" - Score: ${score}/100`,
                        ragEnhanced: ragGuidance.success
                    });
                }
            });
            
            return qualityIssues;
        }
        
        // Extract quality criteria from RAG guidance
        function extractQualityCriteria(ragGuidance) {
            if (!ragGuidance || !ragGuidance.success) {
                return [];
            }
            
            const criteria = [];
            const content = ragGuidance.answer.toLowerCase();
            
            // Look for common quality indicators in RAG content
            if (content.includes('seguranca') || content.includes('seguranÃ§a')) {
                criteria.push({
                    field: 'safetyNotes',
                    required: true,
                    penalty: 15,
                    message: 'Faltam consideraÃ§Ãµes de seguranÃ§a'
                });
            }
            
            if (content.includes('prerequisito') || content.includes('prÃ©-requisito')) {
                criteria.push({
                    field: 'prerequisites',
                    required: true,
                    penalty: 10,
                    message: 'PrÃ©-requisitos nÃ£o especificados'
                });
            }
            
            if (content.includes('progressao') || content.includes('progressÃ£o')) {
                criteria.push({
                    field: 'progressionNotes',
                    required: false,
                    penalty: 5,
                    message: 'Notas de progressÃ£o ausentes'
                });
            }
            
            return criteria;
        }
        
        // Evaluate a criterion against a technique
        function evaluateCriterion(technique, criterion) {
            const field = technique[criterion.field];
            
            if (criterion.required) {
                return field && field.length > 0;
            }
            
            return true; // Non-required criteria pass by default
        }
        
        // Check if description contains key elements from RAG
        function containsKeyElements(description, ragGuidance) {
            const content = ragGuidance.answer.toLowerCase();
            const desc = description.toLowerCase();
            
            // Extract key terms from RAG guidance
            const keyTerms = ['tecnica', 'movimento', 'posicao', 'defensiva', 'ataque'];
            const foundTerms = keyTerms.filter(term => content.includes(term) && desc.includes(term));
            
            return foundTerms.length >= 2; // At least 2 key terms should match
        }
        
        // Global RAG query function for any agent
        async function queryRAGForAgent(query, agentType, context = {}) {
            const fullContext = {
                ...context,
                agent: agentType
            };
            
            return await centralRAG.queryKnowledge(query, fullContext);
        }
        
        // ==========================================
        // KNOWLEDGE BASE FRONTEND FUNCTIONS
        // ==========================================
        
        // Open knowledge uploader modal (Global function)
        window.openKnowledgeUploader = function() {
            console.log('ðŸ“š Abrindo base de conhecimento...');
            // Call the existing document uploader function
            openDocumentUploader();
        };
        
        // Test RAG system (Global function)
        window.testRAGSystem = function() {
            document.getElementById('ragTestModal').classList.add('active');
            // Reset the form
            document.getElementById('ragQuestion').value = '';
            document.getElementById('ragMartialArt').value = '';
            document.getElementById('ragLevel').value = '';
            document.getElementById('ragResults').innerHTML = `
                <div style="text-align: center; color: #9CA3AF; padding: 2rem;">
                    Digite sua pergunta e clique em "Consultar RAG" para ver a resposta
                </div>
            `;
        };
        
        // Enhanced reindex function (Global function)
        window.reindexKnowledgeBase = function() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<span>âš¡</span> Reindexando...';
            btn.disabled = true;
            
            setTimeout(() => {
                generateRAGChunks();
                updateKnowledgeBaseStats();
                displayKnowledgeContentInMain();
                
                showToast('Base de conhecimento reindexada com sucesso!', 'success');
                
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        };
        
        // Search knowledge base (Global function)
        window.searchKnowledgeBase = function() {
            const query = document.getElementById('knowledgeSearchInput').value.trim();
            if (query) {
                searchKnowledgeContentInMain(query);
            } else {
                displayKnowledgeContentInMain();
            }
        };
        
        // Search function specifically for main section
        function searchKnowledgeContentInMain(query) {
            const results = knowledgeBase.filter(item => {
                const searchText = `${item.title} ${item.content} ${item.tags.join(' ')}`.toLowerCase();
                return searchText.includes(query.toLowerCase());
            });
            
            const contentDiv = document.getElementById('knowledgeContentDisplay');
            if (!contentDiv) return;
            
            if (results.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; color: #CBD5E1; padding: 2rem;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸ”</div>
                        Nenhum resultado encontrado para "${query}"
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="displayKnowledgeContentInMain()">
                                ðŸ“‹ Mostrar Tudo
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                    <h3 style="color: #3B82F6; margin-bottom: 0.5rem;">ðŸ” Resultados da Busca</h3>
                    <div style="color: #CBD5E1;">Encontrados ${results.length} resultado(s) para "${query}"</div>
                    <button class="btn btn-sm btn-secondary" onclick="displayKnowledgeContentInMain()" style="margin-top: 0.5rem;">
                        ðŸ“‹ Mostrar Tudo
                    </button>
                </div>
            `;
            
            results.forEach(item => {
                const typeInfo = {
                    'DOCUMENT': { icon: 'ðŸ“„', color: '#8B5CF6' },
                    'TEXT': { icon: 'ðŸ“', color: '#10B981' },
                    'LINK': { icon: 'ðŸ”—', color: '#3B82F6' },
                    'YOUTUBE': { icon: 'ðŸ“º', color: '#EF4444' }
                };
                
                const info = typeInfo[item.type];
                
                // Highlight query in text
                const highlightedContent = item.content.substring(0, 200).replace(
                    new RegExp(`(${query})`, 'gi'),
                    '<mark style="background: #F59E0B; color: #000;">$1</mark>'
                );
                
                html += `
                    <div style="background: rgba(55, 65, 81, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid ${info.color};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div style="font-weight: bold; color: #F8FAFC;">
                                ${info.icon} ${item.title}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="editKnowledgeItem('${item.id}')" style="background: none; border: none; color: #3B82F6; cursor: pointer; padding: 0.25rem; font-size: 1rem;" title="Editar">âœï¸</button>
                                <button onclick="deleteKnowledgeItem('${item.id}')" style="background: none; border: none; color: #EF4444; cursor: pointer; padding: 0.25rem; font-size: 1rem;" title="Excluir">âŒ</button>
                            </div>
                        </div>
                        <div style="color: #CBD5E1; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            ${highlightedContent}${item.content.length > 200 ? '...' : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                            ${item.tags.map(tag => {
                                const highlightedTag = tag.replace(new RegExp(`(${query})`, 'gi'), '<mark style="background: rgba(255,255,255,0.3); color: white;">$1</mark>');
                                return `<span style="background: ${info.color}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${highlightedTag}</span>`;
                            }).join('')}
                        </div>
                        <div style="font-size: 0.75rem; color: #9CA3AF;">
                            Adicionado: ${new Date(item.createdAt).toLocaleDateString('pt-BR')}
                        </div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
        }
        
        // Update knowledge base stats in the main section
        function updateKnowledgeBaseStats() {
            const documentsCount = knowledgeBase.length;
            const chunksCount = ragChunks.length;
            const lastUpdate = documentsCount > 0 ? 'Agora mesmo' : 'Nunca';
            const status = documentsCount > 0 ? 'Ativo' : 'Vazio';
            
            // Main section stats
            const documentsEl = document.getElementById('knowledgeStatsDocuments');
            const chunksEl = document.getElementById('knowledgeStatsChunks');
            const lastUpdateEl = document.getElementById('knowledgeStatsLastUpdate');
            const statusEl = document.getElementById('knowledgeStatsStatus');
            
            if (documentsEl) documentsEl.textContent = documentsCount;
            if (chunksEl) chunksEl.textContent = chunksCount;
            if (lastUpdateEl) lastUpdateEl.textContent = lastUpdate;
            if (statusEl) statusEl.textContent = status;
            
            // Update badge
            const badge = document.getElementById('knowledge-base-badge');
            if (badge) {
                if (documentsCount > 0) {
                    badge.textContent = documentsCount.toString();
                    badge.style.background = '#10B981';
                } else {
                    badge.textContent = 'RAG';
                    badge.style.background = '#8B5CF6';
                }
            }
        }
        
        // Display knowledge base content in the main section
        function displayKnowledgeContentInMain() {
            const contentDiv = document.getElementById('knowledgeContentDisplay');
            if (!contentDiv) return;
            
            if (knowledgeBase.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; color: #9CA3AF; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“š</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Base de Conhecimento Vazia</div>
                        <div style="font-size: 0.9rem;">Adicione documentos, textos, links ou vÃ­deos para comeÃ§ar</div>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="openKnowledgeUploader()">
                                âž• Adicionar Primeiro ConteÃºdo
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            knowledgeBase.forEach(item => {
                const typeInfo = {
                    'DOCUMENT': { icon: 'ðŸ“„', color: '#8B5CF6' },
                    'TEXT': { icon: 'ðŸ“', color: '#10B981' },
                    'LINK': { icon: 'ðŸ”—', color: '#3B82F6' },
                    'YOUTUBE': { icon: 'ðŸ“º', color: '#EF4444' }
                };
                
                const info = typeInfo[item.type];
                
                html += `
                    <div style="background: rgba(55, 65, 81, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid ${info.color};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div style="font-weight: bold; color: #F8FAFC;">
                                ${info.icon} ${item.title}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="editKnowledgeItem('${item.id}')" style="background: none; border: none; color: #3B82F6; cursor: pointer; padding: 0.25rem; font-size: 1rem;" title="Editar">âœï¸</button>
                                <button onclick="deleteKnowledgeItem('${item.id}')" style="background: none; border: none; color: #EF4444; cursor: pointer; padding: 0.25rem; font-size: 1rem;" title="Excluir">âŒ</button>
                            </div>
                        </div>
                        <div style="color: #CBD5E1; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            ${item.content.substring(0, 200)}${item.content.length > 200 ? '...' : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                            ${item.tags.map(tag => `
                                <span style="background: ${info.color}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                    ${tag}
                                </span>
                            `).join('')}
                        </div>
                        <div style="font-size: 0.75rem; color: #9CA3AF;">
                            Adicionado: ${new Date(item.createdAt).toLocaleDateString('pt-BR')}
                        </div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
        }
        
        // Override existing upload function to update main section
        const originalUploadContent = uploadContent;
        if (typeof uploadContent === 'function') {
            uploadContent = function() {
                const result = originalUploadContent.apply(this, arguments);
                setTimeout(() => {
                    updateKnowledgeBaseStats();
                    displayKnowledgeContentInMain();
                }, 500);
                return result;
            };
        }
        
        // Override delete function to update main section
        const originalDeleteKnowledgeItem = deleteKnowledgeItem;
        if (typeof deleteKnowledgeItem === 'function') {
            deleteKnowledgeItem = function(itemId) {
                const result = originalDeleteKnowledgeItem.apply(this, arguments);
                setTimeout(() => {
                    updateKnowledgeBaseStats();
                    displayKnowledgeContentInMain();
                }, 100);
                return result;
            };
        }
        
        // Enhanced showSection to handle knowledge base - will be defined later
        function enhanceShowSection() {
            if (typeof showSection === 'function') {
                const originalShowSection = showSection;
                window.showSection = function(sectionName) {
                    originalShowSection(sectionName);
                    
                    if (sectionName === 'knowledge-base') {
                        setTimeout(() => {
                            if (typeof updateKnowledgeBaseStats === 'function') updateKnowledgeBaseStats();
                            if (typeof displayKnowledgeContentInMain === 'function') displayKnowledgeContentInMain();
                        }, 100);
                    }
                };
            }
        }
        
        // Test function for debugging
        function testKnowledgeBase() {
            console.log('ðŸ§ª Testando base de conhecimento...');
            console.log('ðŸ“ Base atual:', knowledgeBase);
            console.log('ðŸ•°ï¸ Chunks atuais:', ragChunks);
            
            // Add test item
            const testItem = {
                id: 'test-' + Date.now(),
                type: 'TEXT',
                title: 'Teste de Funcionamento',
                content: 'Este Ã© um item de teste para verificar se a base de conhecimento estÃ¡ funcionando.',
                tags: ['teste', 'debug'],
                category: 'TEST',
                martialArt: 'GENERAL',
                level: 'BEGINNER',
                createdAt: new Date().toISOString(),
                chunked: false
            };
            
            knowledgeBase.push(testItem);
            generateRAGChunks();
            updateKnowledgeBaseStats();
            displayKnowledgeContentInMain();
            
            console.log('âœ… Item de teste adicionado!');
            console.log('ðŸ“ Base apÃ³s teste:', knowledgeBase);
            
            // Add clear storage button for testing
            setTimeout(() => {
                const clearBtn = document.createElement('button');
                clearBtn.className = 'btn btn-danger';
                clearBtn.innerHTML = 'ðŸ—‘ï¸ Limpar Storage';
                clearBtn.onclick = function() {
                    if (confirm('Limpar toda a base de conhecimento do localStorage?')) {
                        clearKnowledgeBaseStorage();
                        updateKnowledgeBaseStats();
                        displayKnowledgeContentInMain();
                        showToast('Base de conhecimento limpa!', 'success');
                    }
                };
                clearBtn.style.margin = '1rem';
                clearBtn.style.marginLeft = '0.5rem';
                
                const knowledgeSection = document.getElementById('knowledge-base');
                if (knowledgeSection) {
                    knowledgeSection.appendChild(clearBtn);
                }
            }, 100);
        }
        
        // Initialize knowledge base on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Inicializando base de conhecimento...');
            
            // Test basic functionality first
            try {
                updateKnowledgeBaseStats();
                console.log('âœ… updateKnowledgeBaseStats executado com sucesso');
            } catch (error) {
                console.error('âŒ Erro em updateKnowledgeBaseStats:', error);
            }
            
            // Test if functions are available
            console.log('ðŸ” Verificando funÃ§Ãµes...');
            console.log('openKnowledgeUploader:', typeof window.openKnowledgeUploader);
            console.log('testRAGSystem:', typeof window.testRAGSystem);
            console.log('reindexKnowledgeBase:', typeof window.reindexKnowledgeBase);
            console.log('searchKnowledgeBase:', typeof window.searchKnowledgeBase);
            
            // Add test button for debugging (remove in production)
            setTimeout(() => {
                const knowledgeSection = document.getElementById('knowledge-base');
                if (knowledgeSection) {
                    const testBtn = document.createElement('button');
                    testBtn.className = 'btn btn-warning';
                    testBtn.innerHTML = 'ðŸ§ª Teste Debug';
                    testBtn.onclick = testKnowledgeBase;
                    testBtn.style.margin = '1rem';
                    knowledgeSection.appendChild(testBtn);
                    // Test button removed - no longer needed
                } else {
                    console.log('âš ï¸ SeÃ§Ã£o knowledge-base nÃ£o encontrada');
                }
            }, 1000);
        });
        
        // Functions now defined at the top of the script
        
        // Generate unique ID
        function generateId() {
            return 'kb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Delete knowledge item
        function deleteKnowledgeItem(itemId) {
            if (!confirm('Tem certeza que deseja excluir este item da base de conhecimento?')) {
                return;
            }
            
            try {
                const index = knowledgeBase.findIndex(item => item.id === itemId);
                if (index !== -1) {
                    const deletedItem = knowledgeBase.splice(index, 1)[0];
                    console.log('ðŸ—‘ï¸ Item removido:', deletedItem.title);
                    
                    // Regenerate chunks and save
                    generateRAGChunks();
                    
                    // Update display
                    updateKnowledgeBaseStats();
                    displayKnowledgeContentInMain();
                    
                    showToast('Item removido da base de conhecimento', 'success');
                } else {
                    console.error('âŒ Item nÃ£o encontrado:', itemId);
                    showToast('Item nÃ£o encontrado', 'error');
                }
            } catch (error) {
                console.error('âŒ Erro ao excluir item:', error);
                showToast('Erro ao excluir item', 'error');
            }
        }
        
        // Edit knowledge item (placeholder for future implementation)
        function editKnowledgeItem(itemId) {
            const item = knowledgeBase.find(item => item.id === itemId);
            if (item) {
                // For now, show item details in alert (can be enhanced with a modal later)
                const details = `
TÃ­tulo: ${item.title}
Tipo: ${item.type}
ConteÃºdo: ${item.content.substring(0, 200)}...
Tags: ${item.tags.join(', ')}
Categoria: ${item.category}
Arte Marcial: ${item.martialArt}
NÃ­vel: ${item.level}
                `.trim();
                
                alert(`EdiÃ§Ã£o de itens serÃ¡ implementada em breve.\n\nDetalhes do item:\n${details}`);
            } else {
                showToast('Item nÃ£o encontrado', 'error');
            }
        }
        
        // Initialize knowledge base on page load
        window.addEventListener('load', function() {
            console.log('ðŸš€ Inicializando sistema de persistÃªncia...');
            
            // Load knowledge base from storage
            const hasData = loadKnowledgeBaseFromStorage();
            
            if (hasData) {
                console.log('âœ… Dados carregados do localStorage');
                // Update UI if knowledge base section is visible
                setTimeout(() => {
                    updateKnowledgeBaseStats();
                    displayKnowledgeContentInMain();
                }, 500);
            } else {
                console.log('ðŸ“ Nenhum dado encontrado no localStorage');
            }
        });

    </script>

    <!-- Simple Widgets Sidebar -->
    <aside class="dashboard-widgets" id="dashboardWidgets">
            <!-- Quick Actions Widget -->
            <div class="widget">
                <div class="widget-header">
                    <div class="widget-title">
                        <span>âš¡</span>
                        AÃ§Ãµes RÃ¡pidas
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <button class="btn btn-primary" onclick="openKnowledgeUploader()" style="width: 100%; justify-content: center;">
                        ðŸ“š Upload RAG
                    </button>
                    <button class="btn btn-secondary" onclick="testRAGSystem()" style="width: 100%; justify-content: center;">
                        ðŸ§  Testar IA
                    </button>
                </div>
            </div>

            <!-- Students Info -->
            <div class="widget">
                <div class="widget-header">
                    <div class="widget-title">
                        <span>ðŸ‘¥</span>
                        Resumo Alunos
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #CBD5E1; font-size: 0.875rem;">Total</span>
                        <span style="color: #3B82F6; font-weight: 600;" id="widget-total-students">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #CBD5E1; font-size: 0.875rem;">Ativos</span>
                        <span style="color: #10B981; font-weight: 600;" id="widget-active-students">0</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Enhanced JavaScript Functions -->
    <script>
        // UX-Enhanced Navigation Functions
        function toggleSidebar() {
            const container = document.getElementById('dashboardContainer');
            const sidebar = document.getElementById('dashboardSidebar');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('open');
            } else {
                container.classList.toggle('collapsed');
            }
        }

        // Second showSection function removed - was duplicated

        // Update main header based on current section
        function updateMainHeader(sectionName) {
            const titles = {
                'dashboard': { title: 'Dashboard', subtitle: 'VisÃ£o geral da academia' },
                'students': { title: 'GestÃ£o de Alunos', subtitle: 'Cadastro e acompanhamento de alunos' },
                'courses': { title: 'Cursos', subtitle: 'GestÃ£o de cursos e turmas' },
                'quick-checkin': { title: 'Check-in RÃ¡pido', subtitle: 'Sistema de presenÃ§a simplificado' },
                'course-creator': { title: 'Criador de Cursos', subtitle: 'Ferramenta de criaÃ§Ã£o de conteÃºdo' },
                'knowledge-base': { title: 'Base de Conhecimento', subtitle: 'Documentos e recursos' },
                'attendance': { title: 'Controle de FrequÃªncia', subtitle: 'GestÃ£o de presenÃ§a' },
                'evaluations': { title: 'AvaliaÃ§Ãµes', subtitle: 'Sistema de avaliaÃ§Ãµes' }
            };

            const config = titles[sectionName] || { title: 'Academia', subtitle: 'Sistema de gestÃ£o' };
            
            document.getElementById('mainTitle').textContent = config.title;
            document.getElementById('mainSubtitle').textContent = config.subtitle;
        }

        // Generate AI insights for current section
        function generateSectionInsight(sectionName) {
            const insights = {
                'dashboard': [
                    'IA detectou aumento de 15% no engajamento dos alunos nas Ãºltimas 2 semanas',
                    'RecomendaÃ§Ã£o: Maria Silva estÃ¡ pronta para tÃ©cnicas avanÃ§adas',
                    'TendÃªncia positiva: Taxa de retenÃ§Ã£o subiu para 94% este mÃªs'
                ],
                'students': [
                    'IA identificou 2 alunos com padrÃ£o de baixa frequÃªncia - intervenÃ§Ã£o recomendada',
                    'Carlos Rodrigues mostra aptidÃ£o excepcional para contra-ataques',
                    'SugestÃ£o: Ana Oliveira pode ser mentora para novos alunos'
                ],
                'courses': [
                    'IA sugere ajuste no mÃ³dulo de defesas bÃ¡sicas baseado no feedback dos alunos',
                    'Novo curso "Defesa Feminina" recomendado pela anÃ¡lise de demanda',
                    'ProgressÃ£o Ã³tima detectada: 85% dos alunos dominam fundamentos'
                ]
            };

            const sectionInsights = insights[sectionName] || insights['dashboard'];
            const randomInsight = sectionInsights[Math.floor(Math.random() * sectionInsights.length)];
            
            const aiInsightElement = document.getElementById('aiInsightText');
            if (aiInsightElement) {
                aiInsightElement.textContent = randomInsight;
            }
        }

        // Generate AI insight on demand
        function generateAIInsight() {
            const insights = [
                'IA detectou padrÃ£o: alunos respondem melhor a tÃ©cnicas demonstradas em duplas',
                'RecomendaÃ§Ã£o: implementar aquecimento especÃ­fico para joelho direito (3 alunos)',
                'TendÃªncia: horÃ¡rio das 19h tem 20% mais engajamento que o das 18h',
                'IA sugere: quebra de 5 minutos a cada 25 minutos melhora retenÃ§Ã£o em 30%',
                'Insight comportamental: mÃºsica instrumental aumenta foco durante tÃ©cnicas complexas'
            ];

            const randomInsight = insights[Math.floor(Math.random() * insights.length)];
            const aiInsightElement = document.getElementById('aiInsightText');
            if (aiInsightElement) {
                aiInsightElement.textContent = randomInsight;
            }
            
            // Show brief animation
            const banner = document.getElementById('aiInsightsBanner');
            if (banner) {
                banner.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    banner.style.transform = 'scale(1)';
                }, 200);
            }
        }

        // Load section-specific data
        function loadSectionData(sectionName) {
            if (sectionName === 'students') {
                loadStudents();
            } else if (sectionName === 'knowledge-base') {
                displayKnowledgeContentInMain();
                updateKnowledgeBaseStats();
            }
            
            // Update RAG items count in widget
            document.getElementById('ragItemsCount').textContent = `${knowledgeBase.length} itens`;
        }

        // Enhanced page initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize dashboard
            generateSectionInsight('dashboard');
            
            // Set up responsive behavior
            window.addEventListener('resize', function() {
                const container = document.getElementById('dashboardContainer');
                if (window.innerWidth <= 768) {
                    container.classList.add('mobile');
                } else {
                    container.classList.remove('mobile');
                    document.getElementById('dashboardSidebar').classList.remove('open');
                }
            });

            // Initialize mobile state if needed
            if (window.innerWidth <= 768) {
                document.getElementById('dashboardContainer').classList.add('mobile');
            }

            // Update RAG items count
            setTimeout(() => {
                const ragItemsElement = document.getElementById('ragItemsCount');
                if (ragItemsElement) {
                    ragItemsElement.textContent = `${knowledgeBase.length} itens`;
                }
            }, 1000);
            
            // Load financial data when page loads
            loadFinancialData();
        });

        // ===== FINANCIAL MODULE FUNCTIONS =====
        
        // Global financial data (reuse existing allPlans variable)
        // let allPlans = []; // Already declared above
        let allSubscriptions = [];
        let allPayments = [];

        // Tab switching function
        function switchFinancialTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.financial-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.financial-tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            const contentElement = document.getElementById(`financial-${tabName}`);
            contentElement.classList.add('active');
            contentElement.style.display = 'block';
            
            // Load data for the selected tab
            switch(tabName) {
                case 'plans':
                    loadPlans();
                    break;
                case 'expenses':
                    // Load expenses data - to be implemented
                    console.log('Loading expenses data...');
                    break;
                case 'payments':
                    loadPayments();
                    break;
                case 'settings':
                    // Load financial settings - to be implemented
                    console.log('Loading financial settings...');
                    break;
            }
        }

        // Load all financial data
        async function loadFinancialData() {
            await Promise.all([
                loadPlans(),
                loadPayments()
                // loadSubscriptions removed - replaced with expenses
            ]);
            updateFinancialOverview();
        }

        // Load billing plans
        async function loadPlans() {
            try {
                const response = await fetch('/api/billing-plans');
                const data = await response.json();
                
                if (data.success) {
                    allPlans = data.data || [];
                    updatePlansTable();
                } else {
                    console.error('Erro ao carregar planos:', data.message);
                    // Show empty state
                    allPlans = [];
                    updatePlansTable();
                }
            } catch (error) {
                console.error('Erro ao carregar planos:', error);
                // Show empty state on error
                allPlans = [];
                updatePlansTable();
            }
        }

        // Update plans table
        function updatePlansTable() {
            const tbody = document.getElementById('plansTableBody');
            
            if (!tbody) {
                console.error('plansTableBody element not found');
                return;
            }
            
            if (!allPlans || !Array.isArray(allPlans) || allPlans.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                            Nenhum plano cadastrado. Clique em "Novo Plano" para comeÃ§ar.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = allPlans.map(plan => {
                const billingTypeMap = {
                    'MONTHLY': 'Mensal',
                    'QUARTERLY': 'Trimestral', 
                    'YEARLY': 'Anual'
                };
                
                const categoryMap = {
                    'ADULT': 'Adulto',
                    'INICIANTE1': 'Iniciante 1',
                    'INICIANTE2': 'Iniciante 2',
                    'INICIANTE3': 'Iniciante 3'
                };
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: #E2E8F0;">${plan.name}</div>
                            ${plan.description ? `<div style="font-size: 0.75rem; color: #94A3B8; margin-top: 0.25rem;">${plan.description}</div>` : ''}
                        </td>
                        <td>
                            <span style="font-weight: 600; color: #10B981;">R$ ${parseFloat(plan.price).toFixed(2)}</span>
                        </td>
                        <td>${billingTypeMap[plan.billingType] || plan.billingType}</td>
                        <td>${plan.classesPerWeek}x/semana</td>
                        <td>${categoryMap[plan.category] || 'Todas'}</td>
                        <td>
                            <span class="badge ${plan.isActive ? 'success' : 'inactive'}">
                                ${plan.isActive ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn edit" onclick="editPlan('${plan.id}')" title="Editar Plano">
                                âœï¸ Editar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load subscriptions from API (DEPRECATED - replaced with expenses)
        async function loadSubscriptions() {
            try {
                console.log('loadSubscriptions called - function deprecated, expenses section used instead');
                
                // Set empty data to prevent errors
                allSubscriptions = [];
                
                // Don't try to update table that no longer exists
                return;
            } catch (error) {
                console.error('Erro ao carregar assinaturas:', error);
                allSubscriptions = [];
                // Don't call updateSubscriptionsTable - function deprecated
            }
        }

        // Update subscriptions table (DEPRECATED - now using expenses)
        function updateSubscriptionsTable() {
            // This function is deprecated since subscriptions section was replaced with expenses
            console.log('updateSubscriptionsTable called - function deprecated, using expenses section instead');
            return;
            
            tbody.innerHTML = allSubscriptions.map(sub => {
                const studentName = sub.student?.name || 'Nome nÃ£o informado';
                const planName = sub.plan?.name || 'Plano nÃ£o informado';
                const price = parseFloat(sub.currentPrice || 0);
                const nextBilling = sub.nextBillingDate ? new Date(sub.nextBillingDate).toLocaleDateString('pt-BR') : 'NÃ£o definido';
                
                // Status mapping
                const statusMap = {
                    'ACTIVE': { text: 'Ativa', class: 'success' },
                    'INACTIVE': { text: 'Inativa', class: 'inactive' },
                    'CANCELLED': { text: 'Cancelada', class: 'warning' },
                    'EXPIRED': { text: 'Expirada', class: 'warning' },
                    'SUSPENDED': { text: 'Suspensa', class: 'warning' }
                };
                
                const statusInfo = statusMap[sub.status] || { text: sub.status, class: 'inactive' };
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: #E2E8F0;">${studentName}</div>
                            ${sub.student?.email ? `<div style="font-size: 0.75rem; color: #94A3B8; margin-top: 0.25rem;">${sub.student.email}</div>` : ''}
                        </td>
                        <td>
                            <div style="font-weight: 500; color: #E2E8F0;">${planName}</div>
                            ${sub.plan?.classesPerWeek ? `<div style="font-size: 0.75rem; color: #94A3B8; margin-top: 0.25rem;">${sub.plan.classesPerWeek}x/semana</div>` : ''}
                        </td>
                        <td>
                            <span style="font-weight: 600; color: #10B981;">R$ ${price.toFixed(2)}</span>
                        </td>
                        <td>${nextBilling}</td>
                        <td>
                            <span class="badge ${statusInfo.class}">
                                ${statusInfo.text}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn edit" onclick="editSubscription('${sub.id}')" title="Editar Assinatura">
                                âœï¸ Editar
                            </button>
                            <button class="action-btn view" onclick="viewSubscriptionDetails('${sub.id}')" title="Ver Detalhes">
                                ðŸ‘ï¸ Ver
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load payments 
        async function loadPayments() {
            // No mock data - show empty state
            allPayments = [];
            updatePaymentsTable();
        }

        // Update payments table
        function updatePaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');
            
            if (!tbody) {
                console.error('paymentsTableBody element not found');
                return;
            }
            
            if (!allPayments || allPayments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                            Nenhum pagamento encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = allPayments.map(payment => `
                <tr>
                    <td>${new Date(payment.date).toLocaleDateString('pt-BR')}</td>
                    <td>${payment.student.name}</td>
                    <td>R$ ${parseFloat(payment.amount).toFixed(2)}</td>
                    <td>
                        <span class="badge ${payment.status === 'PAID' ? 'success' : 'warning'}">
                            ${payment.status === 'PAID' ? 'Pago' : 'Pendente'}
                        </span>
                    </td>
                    <td>${payment.method}</td>
                    <td>
                        <button class="action-btn view" onclick="viewPayment('${payment.id}')" title="Ver Detalhes">
                            ðŸ‘ï¸ Ver
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Load reports (mock)
        function loadFinancialSettings() {
            // Load financial settings - placeholder
            console.log('Financial settings loaded');
        }

        // Update financial overview
        function updateFinancialOverview() {
            const totalRevenue = allPayments.reduce((sum, payment) => 
                payment.status === 'PAID' ? sum + payment.amount : sum, 0
            );
            
            document.getElementById('total-revenue').textContent = `R$ ${totalRevenue.toFixed(2)}`;
            document.getElementById('active-subscriptions').textContent = allSubscriptions.filter(s => s.status === 'ACTIVE').length;
            document.getElementById('pending-payments').textContent = allPayments.filter(p => p.status !== 'PAID').length;
            document.getElementById('total-plans').textContent = allPlans.filter(p => p.isActive).length;
            document.getElementById('financial-count').textContent = allSubscriptions.length;
        }

        // Modal functions

        function openAddSubscriptionModal() {
            // Load students and plans for selection
            loadStudentsForSubscription();
            loadPlansForSubscription();
            document.getElementById('addSubscriptionModal').classList.add('active');
        }

        // Load students for subscription modal
        async function loadStudentsForSubscription() {
            try {
                const response = await fetch('/api/students');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('subscriptionStudent');
                    select.innerHTML = '<option value="">Selecione um aluno...</option>' +
                        data.data.map(student => {
                            const user = student.user || {};
                            const firstName = user.firstName || 'N';
                            const lastName = user.lastName || 'A';
                            const name = `${firstName} ${lastName}`;
                            return `<option value="${student.id}">${name}</option>`;
                        }).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
            }
        }

        // Load plans for subscription modal
        function loadPlansForSubscription() {
            const select = document.getElementById('subscriptionPlan');
            select.innerHTML = '<option value="">Selecione um plano...</option>' +
                allPlans.filter(plan => plan.isActive).map(plan => 
                    `<option value="${plan.id}">${plan.name} - R$ ${parseFloat(plan.price).toFixed(2)}</option>`
                ).join('');
        }

        // Form handlers
        document.getElementById('addSubscriptionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                studentId: document.getElementById('subscriptionStudent').value,
                planId: document.getElementById('subscriptionPlan').value,
                startDate: document.getElementById('subscriptionStartDate').value,
                customPrice: document.getElementById('subscriptionCustomPrice').value || null
            };
            
            if (!formData.studentId || !formData.planId) {
                alert('Por favor, selecione um aluno e um plano');
                return;
            }
            
            try {
                const response = await fetch('/api/subscriptions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Assinatura criada com sucesso!');
                    closeModal('addSubscriptionModal');
                    loadSubscriptions();
                    updateFinancialOverview();
                } else {
                    alert('Erro ao criar assinatura: ' + data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao criar assinatura');
            }
        });


        // Subscription details function
        function viewSubscriptionDetails(subId) {
            const subscription = allSubscriptions.find(sub => sub.id === subId);
            if (!subscription) {
                alert('Assinatura nÃ£o encontrada');
                return;
            }
            
            const details = `
DETALHES DA ASSINATURA

ðŸ‘¤ Aluno: ${subscription.student.name}
ðŸ“§ Email: ${subscription.student.email || 'NÃ£o informado'}

ðŸ“‹ Plano: ${subscription.plan.name}
ðŸ’° Valor: R$ ${parseFloat(subscription.currentPrice).toFixed(2)}
ðŸ“… Tipo: ${subscription.plan.billingType === 'MONTHLY' ? 'Mensal' : subscription.plan.billingType === 'QUARTERLY' ? 'Trimestral' : 'Anual'}
ðŸ¥‹ Aulas: ${subscription.plan.classesPerWeek}x por semana

ðŸ“… Data de InÃ­cio: ${new Date(subscription.startDate).toLocaleDateString('pt-BR')}
ðŸ”„ PrÃ³ximo Vencimento: ${subscription.nextBillingDate ? new Date(subscription.nextBillingDate).toLocaleDateString('pt-BR') : 'NÃ£o definido'}
ðŸ“Š Status: ${subscription.status === 'ACTIVE' ? 'Ativa' : subscription.status}

${subscription.financialResponsible ? `ðŸ’³ ResponsÃ¡vel Financeiro: ${subscription.financialResponsible.name}` : 'ðŸ’³ ResponsÃ¡vel: PrÃ³prio aluno'}
            `;
            
            alert(details);
        }

        // Placeholder functions  
        // editPlan function moved to avoid duplicates - see line 16469

        function editSubscription(subId) {
            alert('Funcionalidade de ediÃ§Ã£o de assinatura em desenvolvimento.\n\nAssinatura ID: ' + subId);
        }

        function viewPayment(paymentId) {
            alert('VisualizaÃ§Ã£o de pagamento em desenvolvimento');
        }

        // ==========================================
        // FINANCIAL RESPONSIBLES MANAGEMENT
        // ==========================================

        let allResponsibles = [];

        // Load financial responsibles
        async function loadFinancialResponsiblesList() {
            try {
                document.getElementById('responsiblesLoadingState').style.display = 'block';
                document.getElementById('responsiblesEmptyState').style.display = 'none';
                
                const response = await fetch('/api/financial-responsibles');
                const result = await response.json();
                
                if (result.success) {
                    allResponsibles = result.data;
                    updateResponsiblesTable(allResponsibles);
                    updateResponsiblesStats(allResponsibles);
                    
                    if (allResponsibles.length === 0) {
                        document.getElementById('responsiblesLoadingState').style.display = 'none';
                        document.getElementById('responsiblesEmptyState').style.display = 'block';
                    } else {
                        document.getElementById('responsiblesLoadingState').style.display = 'none';
                    }
                } else {
                    throw new Error(result.message || 'Failed to load responsibles');
                }
            } catch (error) {
                console.error('Erro ao carregar responsÃ¡veis:', error);
                document.getElementById('responsiblesLoadingState').innerHTML = `
                    <div style="text-align: center; color: #EF4444; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">âš ï¸</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Erro ao carregar responsÃ¡veis</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">${error.message}</div>
                    </div>
                `;
            }
        }

        // Update responsibles table
        function updateResponsiblesTable(responsibles) {
            const tbody = document.getElementById('responsiblesTableBody');
            
            tbody.innerHTML = responsibles.map(responsible => `
                <tr>
                    <td>
                        <div class="student-name">${responsible.name}</div>
                    </td>
                    <td>
                        <span class="student-cpf">${formatCPF(responsible.cpfCnpj)}</span>
                    </td>
                    <td>
                        <span class="student-email">${responsible.email}</span>
                    </td>
                    <td>
                        <span class="student-phone">${responsible.phone || 'N/A'}</span>
                    </td>
                    <td>
                        <span class="badge ${responsible.relationshipType === 'PARENT' ? 'success' : 'info'}">
                            ${responsible.relationshipType || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <span class="badge info">${responsible.studentsCount || 0}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="openEditResponsibleModal('${responsible.id}')" title="Editar">
                                âœï¸
                            </button>
                            <button class="action-btn delete" onclick="deleteResponsible('${responsible.id}')" title="Excluir">
                                ðŸ—‘ï¸
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update responsibles stats
        function updateResponsiblesStats(responsibles) {
            document.getElementById('totalResponsibles').textContent = responsibles.length;
            document.getElementById('activeResponsibles').textContent = responsibles.length;
            
            const totalStudents = responsibles.reduce((sum, r) => sum + (r.studentsCount || 0), 0);
            document.getElementById('studentsWithResponsibles').textContent = totalStudents;
            
            const avgStudents = responsibles.length > 0 ? (totalStudents / responsibles.length).toFixed(1) : '0';
            document.getElementById('avgStudentsPerResponsible').textContent = avgStudents;
            
            // Update badge count
            document.getElementById('responsibles-count').textContent = responsibles.length;
        }

        // Filter responsibles
        function filterResponsibles() {
            const searchTerm = document.getElementById('responsibleSearch').value.toLowerCase();
            const filtered = allResponsibles.filter(responsible => 
                responsible.name.toLowerCase().includes(searchTerm) ||
                responsible.cpfCnpj.includes(searchTerm) ||
                responsible.email.toLowerCase().includes(searchTerm)
            );
            updateResponsiblesTable(filtered);
        }

        // Open add responsible modal
        function openAddResponsibleModal() {
            document.getElementById('addResponsibleForm').reset();
            document.getElementById('addResponsibleModal').classList.add('active');
        }

        // Open edit responsible modal
        async function openEditResponsibleModal(responsibleId) {
            const responsible = allResponsibles.find(r => r.id === responsibleId);
            if (!responsible) {
                alert('ResponsÃ¡vel nÃ£o encontrado');
                return;
            }
            
            // Populate form
            document.getElementById('editResponsibleId').value = responsible.id;
            document.getElementById('editResponsibleName').value = responsible.name;
            document.getElementById('editResponsibleCpfCnpj').value = responsible.cpfCnpj;
            document.getElementById('editResponsibleEmail').value = responsible.email;
            document.getElementById('editResponsiblePhone').value = responsible.phone || '';
            document.getElementById('editResponsibleBirthDate').value = responsible.birthDate ? responsible.birthDate.split('T')[0] : '';
            document.getElementById('editResponsibleRelationType').value = responsible.relationshipType || '';
            
            document.getElementById('editResponsibleModal').classList.add('active');
        }

        // Delete responsible
        async function deleteResponsible(responsibleId) {
            const responsible = allResponsibles.find(r => r.id === responsibleId);
            if (!responsible) return;
            
            if (!confirm(`Tem certeza que deseja excluir o responsÃ¡vel "${responsible.name}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/financial-responsibles/${responsibleId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('ResponsÃ¡vel excluÃ­do com sucesso!', 'success');
                    loadFinancialResponsiblesList();
                } else {
                    throw new Error('Erro ao excluir responsÃ¡vel');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao excluir responsÃ¡vel', 'error');
            }
        }

        
        // ==========================================
        // PAYMENT PLANS MANAGEMENT (CONTINUATION)
        // ==========================================

        // Load payment plans
        async function loadPaymentPlansList() {
            console.log('ðŸ”„ Loading payment plans list...');
            try {
                const loadingElement = document.getElementById('plansLoadingState');
                const emptyElement = document.getElementById('plansEmptyState');
                
                if (loadingElement) loadingElement.style.display = 'block';
                if (emptyElement) emptyElement.style.display = 'none';
                
                console.log('ðŸ“¡ Fetching billing plans from API...');
                const response = await fetch('/api/billing-plans');
                const result = await response.json();
                
                console.log('ðŸ“Š API Response:', result);
                
                if (result.success) {
                    allPlans = result.data || [];
                    console.log('ðŸ“‹ Plans loaded:', allPlans.length, 'plans');
                    
                    updatePaymentPlansTable(allPlans);
                    updatePlansStats(allPlans);
                    
                    if (allPlans.length === 0) {
                        if (loadingElement) loadingElement.style.display = 'none';
                        if (emptyElement) emptyElement.style.display = 'block';
                        console.log('âš ï¸ No plans found - showing empty state');
                    } else {
                        if (loadingElement) loadingElement.style.display = 'none';
                        console.log('âœ… Plans table updated successfully');
                    }
                } else {
                    throw new Error(result.message || 'Failed to load plans');
                }
            } catch (error) {
                console.error('Erro ao carregar planos:', error);
                
                // Initialize allPlans as empty array to prevent undefined errors
                allPlans = [];
                updatePaymentPlansTable(allPlans);
                updatePlansStats(allPlans);
                
                document.getElementById('plansLoadingState').innerHTML = `
                    <div style="text-align: center; color: #EF4444; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">âš ï¸</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Erro ao carregar planos</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">${error.message}</div>
                    </div>
                `;
            }
        }

        // Load courses for plan modal
        async function loadCoursesForPlanModal() {
            try {
                console.log('ðŸ“š Carregando cursos para modal de planos...');
                const response = await fetch('/api/courses');
                const result = await response.json();
                
                if (result.success && result.data) {
                    allCourses = result.data;
                    const select = document.getElementById('planCourse');
                    
                    // Para seleÃ§Ã£o mÃºltipla, nÃ£o incluÃ­mos opÃ§Ã£o vazia
                    // Cada curso Ã© uma opÃ§Ã£o selecionÃ¡vel independente
                    select.innerHTML = allCourses.map(course => {
                        const level = course.level || 'BEGINNER';
                        const duration = course.duration || 24;
                        const category = course.category || 'ADULT';
                        
                        return `<option value="${course.id}" title="${course.description || course.name}">
                            ${course.name} (${level} - ${duration} semanas - ${category})
                        </option>`;
                    }).join('');
                    
                    console.log(`âœ… ${allCourses.length} cursos carregados para seleÃ§Ã£o mÃºltipla`);
                } else {
                    console.error('âŒ Nenhum curso encontrado:', result);
                    const select = document.getElementById('planCourse');
                    select.innerHTML = '<option value="" disabled>Nenhum curso disponÃ­vel</option>';
                }
            } catch (error) {
                console.error('âŒ Erro ao carregar cursos:', error);
                const select = document.getElementById('planCourse');
                select.innerHTML = '<option value="" disabled>Erro ao carregar cursos</option>';
            }
        }

        // Update plans table (for payment plans section)
        function updatePaymentPlansTable(plans) {
            console.log('ðŸ”„ Updating payment plans table with', plans?.length, 'plans');
            const tbody = document.getElementById('plansTableBody');
            
            // Check if tbody exists and plans is an array
            if (!tbody) {
                console.error('âŒ plansTableBody element not found in DOM');
                return;
            }
            
            if (!plans || !Array.isArray(plans)) {
                console.warn('âš ï¸ Plans data is undefined or not an array:', plans);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94A3B8; padding: 2rem;">Nenhum plano encontrado</td></tr>';
                return;
            }
            
            console.log('ðŸ“‹ Processing', plans.length, 'plans for table');
            
            tbody.innerHTML = plans.map(plan => {
                const courseName = (allCourses && Array.isArray(allCourses)) 
                    ? allCourses.find(c => c.id === plan.courseId)?.name || 'Geral'
                    : 'Geral';
                
                return `
                <tr ondblclick="openPlanEditPage('${plan.id}')" style="cursor: pointer;">
                    <td>
                        <div class="student-name">${plan.name}</div>
                        <div style="font-size: 0.8rem; color: #94A3B8;">${plan.description || ''}</div>
                    </td>
                    <td>
                        <span class="student-email">${courseName}</span>
                    </td>
                    <td>
                        <span class="badge ${plan.category === 'ADULT' ? 'success' : 'info'}">
                            ${plan.category}
                        </span>
                    </td>
                    <td>
                        <span class="metric-value" style="color: #10B981; font-weight: bold;">
                            R$ ${parseFloat(plan.price).toFixed(2)}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${plan.billingType === 'MONTHLY' ? 'info' : 'warning'}">
                            ${plan.billingType === 'MONTHLY' ? 'Mensal' : plan.billingType}
                        </span>
                    </td>
                    <td>
                        <span class="badge info">${plan.activeSubscriptions || 0}</span>
                    </td>
                    <td>
                        <span class="badge ${plan.isActive ? 'success' : 'danger'}">
                            ${plan.isActive ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editPlan('${plan.id}')" title="Editar">
                                âœï¸
                            </button>
                            <button class="action-btn delete" onclick="deletePlan('${plan.id}')" title="Excluir">
                                ðŸ—‘ï¸
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
            
            console.log('âœ… Table HTML updated. Rows in tbody:', tbody.children.length);
        }

        // Update plans stats
        function updatePlansStats(plans) {
            // Check if plans is an array
            if (!plans || !Array.isArray(plans)) {
                console.warn('Plans data is undefined or not an array for stats:', plans);
                const totalElement = document.getElementById('totalPlansCount');
                const activeElement = document.getElementById('activePlansCount');
                if (totalElement) totalElement.textContent = '0';
                if (activeElement) activeElement.textContent = '0';
                return;
            }
            
            const totalElement = document.getElementById('totalPlansCount');
            const activeElement = document.getElementById('activePlansCount');
            
            if (totalElement) totalElement.textContent = plans.length;
            if (activeElement) activeElement.textContent = plans.filter(p => p.isActive !== false).length;
            
            const avgPrice = plans.length > 0 ? 
                (plans.reduce((sum, p) => sum + parseFloat(p.price || 0), 0) / plans.length).toFixed(2) : '0.00';
            const avgPriceElement = document.getElementById('avgPlanPrice');
            if (avgPriceElement) avgPriceElement.textContent = `R$ ${avgPrice}`;
            
            const monthlyPlans = plans.filter(p => p.billingType === 'MONTHLY').length;
            const monthlyElement = document.getElementById('monthlyPlansCount');
            if (monthlyElement) monthlyElement.textContent = monthlyPlans;
            
            // Update badge count (if exists)
            const countElement = document.getElementById('plans-count');
            if (countElement) countElement.textContent = plans.length;
        }

        // Open add plan modal
        function openAddPlanModal() {
            loadCoursesForPlanModal();
            document.getElementById('addPlanForm').reset();
            
            // Reset modal to create mode
            document.querySelector('#addPlanModal .modal-title').textContent = 'Novo Plano de Pagamento';
            document.querySelector('#addPlanModal button[type="submit"]').textContent = 'Criar Plano';
            delete document.getElementById('addPlanForm').dataset.editingPlanId;
            
            // Reset to first tab
            switchPlanTab('basic');
            
            document.getElementById('addPlanModal').classList.add('active');
        }

        // Switch between plan modal tabs
        function switchPlanTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.plan-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.plan-tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            const selectedTab = document.querySelector(`.plan-tab[data-tab="${tabName}"]`);
            const selectedContent = document.getElementById(`planTab-${tabName}`);
            
            if (selectedTab && selectedContent) {
                selectedTab.classList.add('active');
                selectedContent.classList.add('active');
            }
            
            // Load content for specific tabs
            if (tabName === 'courses') {
                loadCoursesForPlanSelection();
            } else if (tabName === 'preview') {
                updatePlanPreview();
            }
        }

        // Load courses for plan selection (enhanced version)
        async function loadCoursesForPlanSelection() {
            const coursesGrid = document.getElementById('coursesGrid');
            
            try {
                // Show loading state
                coursesGrid.innerHTML = `
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Carregando cursos disponÃ­veis...</p>
                    </div>
                `;
                
                const response = await fetch('/api/courses');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const courses = result.data;
                    
                    // Update stats
                    document.getElementById('coursesTotalCount').textContent = `${courses.length} cursos disponÃ­veis`;
                    updateSelectedCoursesCount();
                    
                    // Render courses grid
                    coursesGrid.innerHTML = courses.map(course => `
                        <div class="course-card" onclick="toggleCourseSelection('${course.id}', this)">
                            <div class="course-card-header">
                                <div>
                                    <h4 style="color: #E2E8F0; margin: 0 0 0.5rem 0; font-size: 1.1rem;">${course.name}</h4>
                                    <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">${course.description || 'DescriÃ§Ã£o nÃ£o disponÃ­vel'}</p>
                                </div>
                                <input type="checkbox" class="course-checkbox" data-course-id="${course.id}">
                            </div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                                <div style="color: #94A3B8; font-size: 0.875rem;">
                                    <div>ðŸŽ“ ${course.totalLessons || 48} aulas</div>
                                    <div>â±ï¸ ${course.duration || '12 meses'}</div>
                                    <div>ðŸ‘¥ ${course.maxStudents || 20} alunos max</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    coursesGrid.innerHTML = `
                        <div style="text-align: center; color: #94A3B8; padding: 3rem;">
                            <h4>ðŸ“š Nenhum curso disponÃ­vel</h4>
                            <p>Crie cursos primeiro para associÃ¡-los aos planos.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar cursos:', error);
                coursesGrid.innerHTML = `
                    <div style="text-align: center; color: #EF4444; padding: 3rem;">
                        <h4>âŒ Erro ao carregar cursos</h4>
                        <p>Tente novamente ou verifique a conexÃ£o.</p>
                    </div>
                `;
            }
        }

        // Toggle course selection
        function toggleCourseSelection(courseId, cardElement) {
            const checkbox = cardElement.querySelector('.course-checkbox');
            const isSelected = checkbox.checked;
            
            // Toggle selection
            checkbox.checked = !isSelected;
            
            // Update visual state
            if (!isSelected) {
                cardElement.classList.add('selected');
            } else {
                cardElement.classList.remove('selected');
            }
            
            // Update legacy multi-select field
            updateLegacyPlanCourseField();
            updateSelectedCoursesCount();
            updatePlanPreview();
        }

        // Select all courses
        function selectAllCourses() {
            document.querySelectorAll('.course-card').forEach(card => {
                const checkbox = card.querySelector('.course-checkbox');
                checkbox.checked = true;
                card.classList.add('selected');
            });
            updateLegacyPlanCourseField();
            updateSelectedCoursesCount();
            updatePlanPreview();
        }

        // Clear all course selections
        function clearAllCourses() {
            document.querySelectorAll('.course-card').forEach(card => {
                const checkbox = card.querySelector('.course-checkbox');
                checkbox.checked = false;
                card.classList.remove('selected');
            });
            updateLegacyPlanCourseField();
            updateSelectedCoursesCount();
            updatePlanPreview();
        }

        // Update selected courses count
        function updateSelectedCoursesCount() {
            const selectedCount = document.querySelectorAll('.course-checkbox:checked').length;
            document.getElementById('coursesSelectedCount').textContent = `${selectedCount} cursos selecionados`;
        }

        // Update legacy plan course field for compatibility
        function updateLegacyPlanCourseField() {
            const legacySelect = document.getElementById('planCourse');
            const selectedCourses = document.querySelectorAll('.course-checkbox:checked');
            
            // Clear existing options
            legacySelect.innerHTML = '';
            
            // Add selected courses as options
            selectedCourses.forEach(checkbox => {
                const courseId = checkbox.dataset.courseId;
                const card = checkbox.closest('.course-card');
                const courseName = card.querySelector('h4').textContent;
                
                const option = document.createElement('option');
                option.value = courseId;
                option.textContent = courseName;
                option.selected = true;
                legacySelect.appendChild(option);
            });
        }

        // Update plan preview (Enhanced for new tab system)
        function updatePlanPreview() {
            const courseSelect = document.getElementById('planCourse');
            const categorySelect = document.getElementById('planCategory');
            const billingTypeSelect = document.getElementById('planBillingType');
            const classesPerWeekSelect = document.getElementById('planClassesPerWeek');
            
            const selectedCourses = Array.from(courseSelect.selectedOptions).map(option => option.text);
            const courseName = selectedCourses.length > 0 ? selectedCourses.join(', ') : 'Nenhum curso selecionado';
            const category = categorySelect.value;
            const billingType = billingTypeSelect?.value || 'MONTHLY';
            const classesPerWeek = classesPerWeekSelect?.value || '2';
            
            // Suggested category prices mapping (not enforced)
            const suggestedCategoryPrices = {
                'ADULT': '180.00',
                'FEMALE': '170.00',
                'SENIOR': '130.00',
                'CHILD': '120.00',
                'INICIANTE1': '120.00',
                'INICIANTE2': '130.00',
                'INICIANTE3': '140.00',
                'HEROI1': '160.00',
                'HEROI2': '170.00',
                'HEROI3': '180.00',
                'MASTER_1': '200.00',
                'MASTER_2': '220.00',
                'MASTER_3': '250.00'
            };
            
            const selectedCount = courseSelect.selectedOptions.length;
            const planName = selectedCount === 0 ? 'Novo Plano' :
                selectedCount === 1 ? `${courseName} - ${category}` : 
                `Multi-Curso (${selectedCount} cursos) - ${category}`;
            
            const customPrice = document.getElementById('planCustomPrice').value;
            
            // Only suggest price if field is completely empty, don't enforce it
            if (!customPrice && category) {
                const suggestedPrice = suggestedCategoryPrices[category] || '150.00';
                const adjustedPrice = selectedCount > 1 ? 
                    (parseFloat(suggestedPrice) * 1.5).toFixed(2) : suggestedPrice;
                
                // Set placeholder instead of value, so user can choose
                document.getElementById('planCustomPrice').placeholder = `SugestÃ£o: R$ ${adjustedPrice}`;
            }
            
            const price = customPrice || '0.00';
            
            // Update preview elements
            document.getElementById('previewPlanName').textContent = planName;
            document.getElementById('previewPlanPrice').textContent = `R$ ${parseFloat(price || 0).toFixed(2)}`;
            
            const description = selectedCount === 0 ? 'Selecione pelo menos um curso para continuar' :
                selectedCount === 1 ? `Plano ${category.toLowerCase()} para ${courseName}` :
                `Plano ${category.toLowerCase()} com acesso a ${selectedCount} cursos: ${courseName}`;
            document.getElementById('previewPlanDescription').textContent = description;
            
            // Update detailed preview information
            const categoryNames = {
                'ADULT': 'Adulto',
                'FEMALE': 'Feminino',
                'SENIOR': 'Senior/Idoso',
                'CHILD': 'Infantil/CrianÃ§a',
                'INICIANTE1': 'Iniciante 1',
                'INICIANTE2': 'Iniciante 2',
                'INICIANTE3': 'Iniciante 3',
                'HEROI1': 'HerÃ³i 1',
                'HEROI2': 'HerÃ³i 2',
                'HEROI3': 'HerÃ³i 3',
                'MASTER_1': 'Master 1',
                'MASTER_2': 'Master 2',
                'MASTER_3': 'Master 3'
            };
            
            const billingTypeNames = {
                'MONTHLY': 'Mensal',
                'WEEKLY': 'Semanal',
                'QUARTERLY': 'Trimestral',
                'YEARLY': 'Anual'
            };
            
            document.getElementById('previewCategory').textContent = categoryNames[category] || category || 'NÃ£o definida';
            document.getElementById('previewBillingType').textContent = billingTypeNames[billingType] || billingType;
            document.getElementById('previewCourses').textContent = selectedCount > 0 ? courseName : 'Nenhum curso selecionado';
            document.getElementById('previewClassesPerWeek').textContent = classesPerWeek === 'unlimited' ? 'Ilimitado' : `${classesPerWeek} aulas`;
            
            // Auto-fill form fields
            if (!document.getElementById('planName').value) {
                document.getElementById('planName').value = planName;
            }
            if (!document.getElementById('planDescription').value && selectedCount > 0) {
                document.getElementById('planDescription').value = description;
            }
        }

        // Edit plan
        async function editPlanOldModal(planId) {
            try {
                console.log('ðŸ”§ Editando plano (Old Modal):', planId);
                
                // Fetch plan data from server
                const response = await fetch(`/api/billing-plans/${planId}`);
                const result = await response.json();
                
                if (!result.success) {
                    console.error('âŒ Erro ao buscar plano:', result.error);
                    showToast('Erro ao carregar dados do plano: ' + result.message, 'error');
                    return;
                }
                
                const plan = result.data;
                console.log('ðŸ“‹ Dados do plano carregados:', plan);
                
                // Load courses first and wait for completion
                await loadCoursesForPlanModal();
                
                // Fill form with plan data
                const courseSelect = document.getElementById('planCourse');
                
                // Handle multiple course selection for editing
                if (plan.courseIds && Array.isArray(plan.courseIds)) {
                    // Clear all selections first
                    for (let option of courseSelect.options) {
                        option.selected = false;
                    }
                    // Select the courses associated with this plan
                    plan.courseIds.forEach(courseId => {
                        const option = courseSelect.querySelector(`option[value="${courseId}"]`);
                        if (option) option.selected = true;
                    });
                } else if (plan.courseId) {
                    // Backward compatibility for single course
                    courseSelect.value = plan.courseId;
                }
            
            document.getElementById('planCategory').value = plan.category || '';
            document.getElementById('planName').value = plan.name || '';
            document.getElementById('planCustomPrice').value = plan.price || '';
            document.getElementById('planDescription').value = plan.description || '';
            document.getElementById('planBillingType').value = plan.billingType || 'MONTHLY';
            document.getElementById('planClassesPerWeek').value = plan.classesPerWeek || 2;
            
            // Update modal title and button
            document.querySelector('#addPlanModal .modal-title').textContent = 'Editar Plano de Pagamento';
            document.querySelector('#addPlanModal button[type="submit"]').textContent = 'Atualizar Plano';
            
            // Store plan ID for update
            document.getElementById('addPlanForm').dataset.editingPlanId = planId;
            
            // Show modal
            document.getElementById('addPlanModal').classList.add('active');
            
                // Update preview
                setTimeout(() => updatePlanPreview(), 100);
                
            } catch (error) {
                console.error('âŒ Erro ao editar plano:', error);
                showToast('Erro ao carregar plano para ediÃ§Ã£o: ' + error.message, 'error');
            }
        }

        // Delete plan
        async function deletePlan(planId) {
            console.log('ðŸ—‘ï¸ Attempting to delete plan:', planId);
            console.log('ðŸ“Š Available plans:', allPlans);
            
            const plan = allPlans.find(p => p.id == planId || p.id === planId);
            if (!plan) {
                console.error('âŒ Plan not found in allPlans array');
                console.error('ðŸ” Searched for ID:', planId, 'Type:', typeof planId);
                console.error('ðŸ“‹ Available IDs:', allPlans.map(p => ({id: p.id, type: typeof p.id})));
                showNotification('Plano nÃ£o encontrado', 'error');
                return;
            }
            
            if (!confirm(`Tem certeza que deseja excluir o plano "${plan.name}"?`)) {
                return;
            }
            
            try {
                console.log('ðŸ—‘ï¸ Deleting plan via API...');
                
                const response = await fetch(`/api/billing-plans/${planId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Remove from local array
                    const planIndex = allPlans.findIndex(p => p.id == planId || p.id === planId);
                    if (planIndex !== -1) {
                        allPlans.splice(planIndex, 1);
                    }
                    
                    // Update display
                    updatePaymentPlansTable(allPlans);
                    updatePlansStats(allPlans);
                    
                    showToast('Plano excluÃ­do com sucesso!', 'success');
                } else {
                    throw new Error(data.message || data.error || 'Erro ao excluir plano');
                }
                
            } catch (error) {
                console.error('Erro:', error);
                showToast(`Erro ao excluir plano: ${error.message}`, 'error');
            }
        }

        // ==========================================
        // ADVANCED PLAN FORM CONTROLS
        // ==========================================
        
        // Toggle installment options based on billing type
        function toggleInstallmentOptions() {
            const billingType = document.getElementById('planBillingType').value;
            const installmentOptions = document.getElementById('installmentOptions');
            const recurringOptions = document.getElementById('recurringOptions');
            
            if (billingType === 'CREDIT_CARD_INSTALLMENT') {
                installmentOptions.style.display = 'block';
                recurringOptions.style.display = 'none';
            } else if (billingType === 'RECURRING') {
                installmentOptions.style.display = 'none';
                recurringOptions.style.display = 'block';
            } else {
                installmentOptions.style.display = 'none';
                recurringOptions.style.display = 'none';
            }
        }
        
        // Toggle unlimited access options
        function toggleUnlimitedOptions() {
            const accessType = document.getElementById('planAccessType').value;
            const limitedOptions = document.getElementById('limitedAccessOptions');
            
            if (accessType === 'unlimited') {
                limitedOptions.style.display = 'none';
                // Set unlimited values
                document.getElementById('planClassesPerWeek').value = '7';
                document.getElementById('planMaxClasses').value = '';
            } else {
                limitedOptions.style.display = 'block';
            }
        }
        
        // Enhanced category pricing with new categories
        const categoryPricing = {
            'ADULT': { price: 180.00, name: 'Adulto' },
            'FEMALE': { price: 170.00, name: 'Feminino' },
            'SENIOR': { price: 130.00, name: 'Senior/Idoso' },
            'CHILD': { price: 120.00, name: 'Infantil/CrianÃ§a' },
            'INICIANTE1': { price: 120.00, name: 'Iniciante 1' },
            'INICIANTE2': { price: 130.00, name: 'Iniciante 2' },
            'INICIANTE3': { price: 140.00, name: 'Iniciante 3' },
            'HEROI1': { price: 160.00, name: 'HerÃ³i 1' },
            'HEROI2': { price: 170.00, name: 'HerÃ³i 2' },
            'HEROI3': { price: 180.00, name: 'HerÃ³i 3' },
            'MASTER_1': { price: 200.00, name: 'Master 1' },
            'MASTER_2': { price: 220.00, name: 'Master 2' },
            'MASTER_3': { price: 250.00, name: 'Master 3' }
        };
        
        // Billing type translations
        const billingTypeNames = {
            'MONTHLY': 'Mensal',
            'QUARTERLY': 'Trimestral', 
            'YEARLY': 'Anual',
            'CREDIT_CARD_INSTALLMENT': 'CartÃ£o Parcelado',
            'RECURRING': 'Assinatura Recorrente',
            'LIFETIME': 'VitalÃ­cio'
        };

        // ==========================================
        // NAVIGATION AND INITIALIZATION
        // ==========================================

        // Enhanced navigation handling
        document.addEventListener('DOMContentLoaded', function() {
            // Add navigation click handlers
            document.querySelectorAll('.nav-link[data-page]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    showSection(page);
                });
            });

            // Initial page load
            showSection('dashboard');
        });

        // Third showSection function removed - was duplicated

        // Load section-specific data
        function loadSectionData(sectionName) {
            switch (sectionName) {
                case 'students':
                    loadStudents();
                    break;
                case 'financial-responsibles':
                    loadFinancialResponsiblesList();
                    break;
                case 'payment-plans':
                    loadPaymentPlansList();
                    break;
                case 'financial':
                    if (typeof loadFinancialData === 'function') {
                        loadFinancialData();
                    }
                    break;
                case 'attendance':
                    if (typeof loadAttendanceList === 'function') {
                        loadAttendanceList();
                    }
                    break;
                case 'quick-checkin':
                    if (typeof loadStudentsForCheckin === 'function') {
                        loadStudentsForCheckin();
                    }
                    break;
                case 'public-checkin':
                    if (typeof loadStudentsForPublicCheckin === 'function') {
                        loadStudentsForPublicCheckin();
                    }
                    break;
                default:
                    // No specific loading needed
                    break;
            }
        }

        // ==========================================
        // STUDENT ENROLLMENT WITH AUTOMATIC PLAN PREVIEW
        // ==========================================

        // Load courses for student modal
        async function loadCoursesForStudentModal() {
            try {
                const response = await fetch('/api/courses');
                const result = await response.json();
                
                if (result.success) {
                    const select = document.getElementById('studentCourse');
                    select.innerHTML = '<option value="">Selecione um curso (opcional)</option>' +
                        result.data.map(course => 
                            `<option value="${course.id}">${course.name}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar cursos:', error);
            }
        }

        // Update student plan preview based on category and course
        function updateStudentPlanPreview() {
            const courseSelect = document.getElementById('studentCourse');
            const categorySelect = document.getElementById('studentCategory');
            const courseName = courseSelect.options[courseSelect.selectedIndex]?.text || '';
            const category = categorySelect.value;
            
            if (courseSelect.value && category) {
                const planName = `${courseName} - ${category}`;
                // Use flexible pricing instead of hardcoded values
                const price = '0.00'; // Let user set their own price
                
                document.getElementById('previewStudentPlanName').textContent = planName;
                document.getElementById('previewStudentPlanPrice').textContent = `R$ ${parseFloat(price).toFixed(2)}`;
                document.getElementById('previewStudentPlanDescription').textContent = 
                    `Plano automÃ¡tico para ${courseName} categoria ${category}`;
                
                document.getElementById('studentPlanPreview').style.display = 'block';
            } else {
                document.getElementById('studentPlanPreview').style.display = 'none';
            }
        }

        function updateEditStudentPlanPreview() {
            const courseSelect = document.getElementById('editStudentCourse');
            const categorySelect = document.getElementById('editStudentCategory');
            const courseName = courseSelect.options[courseSelect.selectedIndex]?.text || '';
            const category = categorySelect.value;
            
            if (courseSelect.value && category) {
                const planName = `${courseName} - ${category}`;
                // Use flexible pricing instead of hardcoded values
                const price = '0.00'; // Let user set their own price
                
                document.getElementById('previewEditStudentPlanName').textContent = planName;
                document.getElementById('previewEditStudentPlanPrice').textContent = `R$ ${parseFloat(price).toFixed(2)}`;
                document.getElementById('previewEditStudentPlanDescription').textContent = 
                    `Plano automÃ¡tico para ${courseName} categoria ${category}`;
                
                document.getElementById('editStudentPlanPreview').style.display = 'block';
            } else {
                document.getElementById('editStudentPlanPreview').style.display = 'none';
            }
        }

        // Enhanced switch between tabs in edit modal with UX improvements
        function switchEditTab(tabName) {
            // Hide all tab contents with fade effect
            const tabContents = document.querySelectorAll('.edit-tab-content');
            tabContents.forEach(tab => {
                tab.style.opacity = '0';
                setTimeout(() => tab.style.display = 'none', 150);
            });

            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.edit-tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains('primary')) {
                    btn.style.background = 'transparent';
                    btn.style.color = '#94A3B8';
                } else {
                    btn.style.color = '#94A3B8';
                    btn.style.borderBottomColor = 'transparent';
                }
            });

            // Show selected tab content with fade in
            setTimeout(() => {
                const selectedTab = document.getElementById(`edit-tab-${tabName}`);
                if (selectedTab) {
                    selectedTab.style.display = 'block';
                    setTimeout(() => selectedTab.style.opacity = '1', 50);
                }
            }, 150);

            // Add active class to selected tab button
            const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
                if (selectedBtn.classList.contains('primary')) {
                    selectedBtn.style.background = 'linear-gradient(135deg, #3B82F6, #1D4ED8)';
                    selectedBtn.style.color = 'white';
                } else {
                    selectedBtn.style.color = '#3B82F6';
                    selectedBtn.style.borderBottomColor = '#3B82F6';
                }
            }

            // Load content and populate overview tab
            if (tabName === 'overview') {
                populateOverviewTab();
            }
            
            // Load financial tab content
            if (tabName === 'financial') {
                loadStudentFinancialTab();
            }
        }

        // Form progress tracking
        function updateFormProgress() {
            const form = document.getElementById('editStudentForm');
            const inputs = form.querySelectorAll('input[required], select[required]');
            let completed = 0;
            
            inputs.forEach(input => {
                if (input.value && input.value.trim() !== '') {
                    completed++;
                }
            });
            
            const progress = Math.round((completed / inputs.length) * 100);
            const progressBar = document.getElementById('editFormProgress');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
        }

        // Auto-fill demo data
        function autoFillDemo() {
            document.getElementById('editFirstName').value = 'JoÃ£o';
            document.getElementById('editLastName').value = 'Silva';
            document.getElementById('editEmail').value = 'joao.silva@email.com';
            document.getElementById('editPhone').value = '(11) 99999-9999';
            document.getElementById('editCpf').value = '123.456.789-00';
            document.getElementById('editBirthDate').value = '1985-05-15';
            document.getElementById('editCategory').value = 'ADULT';
            document.getElementById('editGender').value = 'MASCULINO';
            
            updateFormProgress();
            showToast('âœ… Dados demo preenchidos com sucesso!', 'success');
        }

        // Populate overview tab with current data
        function populateOverviewTab() {
            const firstName = document.getElementById('editFirstName').value;
            const lastName = document.getElementById('editLastName').value;
            const email = document.getElementById('editEmail').value;
            const phone = document.getElementById('editPhone').value;
            const cpf = document.getElementById('editCpf').value;
            const category = document.getElementById('editCategory').value;
            
            // Update overview fields
            document.getElementById('overviewFullName').textContent = `${firstName} ${lastName}`.trim() || '-';
            document.getElementById('overviewEmail').textContent = email || '-';
            document.getElementById('overviewPhone').textContent = phone || '-';
            document.getElementById('overviewCpf').textContent = cpf || '-';
            document.getElementById('overviewCategory').textContent = category || '-';
            document.getElementById('overviewStatus').textContent = 'Ativo';
            document.getElementById('overviewEnrollment').textContent = new Date().toLocaleDateString('pt-BR');
            document.getElementById('overviewPhysical').textContent = 'IntermediÃ¡rio';
        }

        // Update student summary card
        function updateStudentSummary(student) {
            const user = student.user || {};
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
            
            document.getElementById('editStudentSummaryName').textContent = fullName || 'Nome do Aluno';
            document.getElementById('editStudentSummaryId').textContent = `ID: ${student.id || '-'}`;
            document.getElementById('editStudentSummaryCategory').textContent = `Categoria: ${student.category || '-'}`;
            document.getElementById('editStudentLastModified').textContent = 'agora mesmo';
        }

        // Placeholder functions for tab content loading
        function loadStudentProgressTab() {
            const progressTab = document.getElementById('edit-tab-progress');
            if (progressTab) {
                progressTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“ˆ</div>
                        <p>Funcionalidade de progresso em desenvolvimento...</p>
                    </div>
                `;
            }
        }

        window.loadStudentFinancialTab = async function() {
            const studentId = currentEditingStudentId || document.getElementById('editStudentForm')?.dataset.editingStudentId;
            if (!studentId) {
                console.error('Student ID not found for financial tab');
                return;
            }
            
            try {
                // Load current plan information
                await loadStudentCurrentPlan(studentId);
                
                // Load payment status
                await loadStudentPaymentStatus(studentId);
                
                // Load payment history  
                await loadStudentPaymentHistory(studentId);
                
                // Load available plans for upgrade
                await loadAvailablePlansForUpgrade(studentId);
                
            } catch (error) {
                console.error('Error loading student financial data:', error);
                showToast('Erro ao carregar informaÃ§Ãµes financeiras', 'error');
            }
        };

        // Enhanced load student's current plan with better UX
        async function loadStudentCurrentPlan(studentId) {
            const container = document.getElementById('currentPlanContainer');
            
            // Show loading state with better UX
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; padding: 2rem; gap: 1rem;">
                    <div style="width: 20px; height: 20px; border: 2px solid #3B82F6; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span style="color: #94A3B8;">Carregando informaÃ§Ãµes do plano...</span>
                </div>
            `;
            
            try {
                console.log('ðŸ”„ [UX] Loading plan for student:', studentId);
                
                // Force refresh subscription data with retry logic
                let subscription = null;
                let attempts = 0;
                const maxAttempts = 3;
                
                while (!subscription && attempts < maxAttempts) {
                    attempts++;
                    console.log(`ðŸ”„ [UX] Attempt ${attempts}/${maxAttempts}`);
                    
                    const subscriptionResponse = await fetch(`/api/students/${studentId}/subscription?_=${Date.now()}`);
                    
                    if (subscriptionResponse.ok) {
                        const subscriptionResult = await subscriptionResponse.json();
                        console.log('ðŸ” [UX] Subscription API response:', subscriptionResult);
                        
                        if (subscriptionResult.success && subscriptionResult.data) {
                            subscription = subscriptionResult.data;
                            console.log('âœ… [UX] Subscription found:', subscription);
                            console.log('ðŸ” [UX] Plan in subscription:', subscription.plan);
                            console.log('ðŸ” [UX] Has plan?', !!subscription.plan);
                            break;
                        }
                    }
                    
                    // Wait before retry
                    if (attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                console.log('ðŸ” [FINAL CHECK] subscription:', subscription);
                console.log('ðŸ” [FINAL CHECK] subscription.plan:', subscription?.plan);
                console.log('ðŸ” [FINAL CHECK] condition result:', !!(subscription && subscription.plan));
                
                // Force debug: if we have subscription but no plan, try to fix it
                if (subscription && !subscription.plan && subscription.planId) {
                    console.log('ðŸ”§ [FORCE FIX] Subscription has planId but no plan object, forcing plan load...');
                    try {
                        const planResponse = await fetch(`/api/billing-plans`);
                        const plansData = await planResponse.json();
                        const matchingPlan = plansData.data?.find(p => p.id === subscription.planId);
                        if (matchingPlan) {
                            subscription.plan = matchingPlan;
                            console.log('âœ… [FORCE FIX] Plan loaded manually:', matchingPlan.name);
                        }
                    } catch (e) {
                        console.error('âŒ [FORCE FIX] Failed to load plan:', e);
                    }
                }
                
                if (subscription && subscription.plan) {
                    // Student has an active subscription - Enhanced UI
                    const plan = subscription.plan;
                    console.log('âœ… [UX] Plan data loaded:', plan);
                    
                    container.innerHTML = `
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05)); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 16px; padding: 2rem; position: relative; overflow: hidden;">
                            <!-- Success indicator -->
                            <div style="position: absolute; top: 1rem; right: 1rem; background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(16, 185, 129, 0.3);">
                                âœ… ATIVO
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: start;">
                                <div>
                                    <h3 style="color: #10B981; margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 700;">${plan.name}</h3>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                        <div style="background: rgba(15, 23, 42, 0.3); padding: 1rem; border-radius: 8px;">
                                            <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">VALOR MENSAL</div>
                                            <div style="color: #F8FAFC; font-size: 1.1rem; font-weight: 600;">R$ ${parseFloat(plan.price).toFixed(2)}</div>
                                        </div>
                                        <div style="background: rgba(15, 23, 42, 0.3); padding: 1rem; border-radius: 8px;">
                                            <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">CATEGORIA</div>
                                            <div style="color: #F8FAFC; font-size: 1.1rem; font-weight: 600;">${plan.category}</div>
                                        </div>
                                        <div style="background: rgba(15, 23, 42, 0.3); padding: 1rem; border-radius: 8px;">
                                            <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">AULAS/SEMANA</div>
                                            <div style="color: #F8FAFC; font-size: 1.1rem; font-weight: 600;">${plan.classesPerWeek || 'Ilimitado'}</div>
                                        </div>
                                    </div>
                                    
                                    ${plan.description ? `<p style="color: #CBD5E1; font-size: 0.875rem; margin: 0; opacity: 0.8;">${plan.description}</p>` : ''}
                                </div>
                                
                                <div style="text-align: center;">
                                    <div style="background: linear-gradient(135deg, #10B981, #059669); border-radius: 16px; padding: 2rem; min-width: 140px; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);">
                                        <div style="color: white; font-size: 1.8rem; font-weight: bold; margin-bottom: 0.5rem;">R$ ${parseFloat(plan.price).toFixed(2)}</div>
                                        <div style="color: rgba(255, 255, 255, 0.8); font-size: 0.875rem;">${plan.billingType === 'MONTHLY' ? 'por mÃªs' : 'total'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Update sidebar with success
                    updateSidebarFinancialStatus(true, plan);
                    console.log('âœ… [UX] Plan UI updated successfully');
                    
                } else {
                    // No subscription found - Enhanced empty state
                    console.log('â„¹ï¸ [UX] No active subscription found');
                    container.innerHTML = `
                        <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(217, 119, 6, 0.05)); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 16px; padding: 3rem; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.6;">ðŸ“‹</div>
                            <h3 style="color: #F59E0B; margin: 0 0 1rem 0; font-size: 1.3rem;">Nenhum plano ativo</h3>
                            <p style="color: #94A3B8; margin: 0 0 2rem 0; font-size: 0.875rem; max-width: 300px; margin-left: auto; margin-right: auto;">Este aluno precisa de um plano de pagamento para acessar as aulas e funcionalidades da academia.</p>
                            
                            <button onclick="assignPlanToStudent('${studentId}')" 
                                    style="background: linear-gradient(135deg, #F59E0B, #D97706); border: none; color: white; padding: 1rem 2rem; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(245, 158, 11, 0.4)';"
                                    onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)';">
                                ðŸ“‹ Atribuir Plano de Pagamento
                            </button>
                        </div>
                    `;
                    
                    // Update sidebar to show no plan
                    updateSidebarFinancialStatus(false, null);
                }
                
            } catch (error) {
                console.error('âŒ [UX] Error loading current plan:', error);
                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(220, 38, 38, 0.05)); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 16px; padding: 3rem; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem; color: #EF4444;">âš ï¸</div>
                        <h3 style="color: #EF4444; margin: 0 0 1rem 0;">Erro ao carregar plano</h3>
                        <p style="color: #94A3B8; margin: 0 0 2rem 0; font-size: 0.875rem;">NÃ£o foi possÃ­vel carregar as informaÃ§Ãµes do plano. Tente novamente.</p>
                        
                        <button onclick="loadStudentCurrentPlan('${studentId}')" 
                                style="background: #374151; border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem;">
                            ðŸ”„ Tentar Novamente
                        </button>
                    </div>
                `;
                
                // Update sidebar to show error state
                updateSidebarFinancialStatus(false, null);
            }
        }

        // Load student payment status
        async function loadStudentPaymentStatus(studentId) {
            const container = document.getElementById('paymentStatusContainer');
            
            try {
                // Mock payment status for now - replace with real API call
                const paymentStatus = {
                    status: 'NO_PLAN',
                    lastPayment: null,
                    nextDueDate: null,
                    amount: 0.00
                };
                
                const statusColor = paymentStatus.status === 'UP_TO_DATE' ? '#10B981' : 
                                  paymentStatus.status === 'OVERDUE' ? '#EF4444' : '#F59E0B';
                
                const statusText = paymentStatus.status === 'UP_TO_DATE' ? 'âœ… Em dia' :
                                 paymentStatus.status === 'OVERDUE' ? 'âŒ Em atraso' : 'âš ï¸ Vencendo';
                
                container.innerHTML = `
                    <div style="margin-bottom: 0.5rem;"><strong>Ãšltimo Pagamento:</strong> ${new Date(paymentStatus.lastPayment).toLocaleDateString('pt-BR')}</div>
                    <div style="margin-bottom: 0.5rem;"><strong>PrÃ³ximo Vencimento:</strong> ${new Date(paymentStatus.nextDueDate).toLocaleDateString('pt-BR')}</div>
                    <div style="margin-bottom: 0.5rem;"><strong>Valor:</strong> R$ ${paymentStatus.amount.toFixed(2)}</div>
                    <div style="margin-bottom: 0.5rem;"><strong>Status:</strong> <span style="color: ${statusColor};">${statusText}</span></div>
                `;
            } catch (error) {
                console.error('Error loading payment status:', error);
                container.innerHTML = `<p style="color: #EF4444;">Erro ao carregar status de pagamento</p>`;
            }
        }

        // Load student payment history
        async function loadStudentPaymentHistory(studentId) {
            const container = document.getElementById('paymentHistoryContainer');
            
            try {
                // Mock payment history for now - replace with real API call
                const paymentHistory = [
                    // No hardcoded payments - will load from API when implemented
                ];
                
                if (paymentHistory.length > 0) {
                    container.innerHTML = paymentHistory.map(payment => {
                        const statusIcon = payment.status === 'PAID' ? 'âœ…' : payment.status === 'PENDING' ? 'â³' : 'âŒ';
                        const statusColor = payment.status === 'PAID' ? '#10B981' : payment.status === 'PENDING' ? '#F59E0B' : '#EF4444';
                        
                        return `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                                <span>${new Date(payment.date).toLocaleDateString('pt-BR')}</span>
                                <span style="color: ${statusColor};">${statusIcon} R$ ${payment.amount.toFixed(2)}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p style="color: #94A3B8; text-align: center;">Nenhum pagamento registrado</p>';
                }
            } catch (error) {
                console.error('Error loading payment history:', error);
                container.innerHTML = `<p style="color: #EF4444;">Erro ao carregar histÃ³rico</p>`;
            }
        }

        // Load available plans for upgrade
        async function loadAvailablePlansForUpgrade(studentId) {
            const container = document.getElementById('availablePlansContainer');
            
            try {
                const response = await fetch('/api/billing-plans');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const plans = result.data.slice(0, 3); // Show top 3 plans
                    
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            ${plans.map(plan => `
                                <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; padding: 1.5rem; text-align: center;">
                                    <h5 style="color: #3B82F6; margin: 0 0 0.5rem 0; font-size: 1rem;">${plan.name}</h5>
                                    <div style="color: #E2E8F0; font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">R$ ${parseFloat(plan.price).toFixed(2)}</div>
                                    <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 1rem;">${plan.billingType === 'MONTHLY' ? 'Mensal' : plan.billingType}</div>
                                    <button class="btn btn-sm btn-outline" onclick="upgradeToPlan('${studentId}', '${plan.id}')" style="width: 100%; padding: 0.5rem;">
                                        Upgrade
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #94A3B8;">
                            <p>Nenhum plano disponÃ­vel para upgrade</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading available plans:', error);
                container.innerHTML = `
                    <div style="text-align: center; color: #EF4444;">
                        <p>Erro ao carregar planos disponÃ­veis</p>
                    </div>
                `;
            }
        }

        // Open edit student plan modal
        function openEditStudentPlan() {
            const studentId = document.getElementById('editStudentForm')?.dataset.editingStudentId;
            if (!studentId) {
                showToast('ID do aluno nÃ£o encontrado', 'error');
                return;
            }
            
            showToast('Funcionalidade de ediÃ§Ã£o de plano em desenvolvimento', 'info');
            // TODO: Implement plan editing modal
        }

        // Assign plan to student
        function assignPlanToStudent(studentId) {
            showToast('Funcionalidade de atribuiÃ§Ã£o de plano em desenvolvimento', 'info');
            // TODO: Implement plan assignment modal
        }

        // Upgrade student to new plan
        function upgradeToPlan(studentId, planId) {
            showToast(`Upgrade para plano ${planId} em desenvolvimento`, 'info');
            // TODO: Implement plan upgrade functionality
        }

        function loadStudentAttendanceTab() {
            const attendanceTab = document.getElementById('edit-tab-attendance');
            if (attendanceTab) {
                attendanceTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“Š</div>
                        <p>HistÃ³rico de frequÃªncia em desenvolvimento...</p>
                    </div>
                `;
            }
        }

        // FunÃ§Ã£o removida - agora usando loadStudentCoursesTab do students.js

        // FunÃ§Ã£o removida - agora usando loadStudentClassesTab do students.js

        function loadStudentHistoryTab() {
            const historyTab = document.getElementById('edit-tab-history');
            if (historyTab) {
                historyTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“œ</div>
                        <p>HistÃ³rico do aluno em desenvolvimento...</p>
                    </div>
                `;
            }
        }

        // NOTE: openAddStudentModal is defined earlier in the file, this is a duplicate - removed

        // Form submission handlers
        document.getElementById('addResponsibleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('responsibleName').value,
                cpfCnpj: document.getElementById('responsibleCpfCnpj').value,
                email: document.getElementById('responsibleEmail').value,
                phone: document.getElementById('responsiblePhone').value,
                birthDate: document.getElementById('responsibleBirthDate').value,
                address: document.getElementById('responsibleAddress').value,
                addressNumber: document.getElementById('responsibleAddressNumber').value,
                complement: document.getElementById('responsibleComplement').value,
                neighborhood: document.getElementById('responsibleNeighborhood').value,
                city: document.getElementById('responsibleCity').value,
                state: document.getElementById('responsibleState').value,
                zipCode: document.getElementById('responsibleZipCode').value,
                relationshipType: document.getElementById('responsibleRelationType').value
            };
            
            try {
                const response = await fetch('/api/financial-responsibles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('ResponsÃ¡vel criado com sucesso!', 'success');
                    closeModal('addResponsibleModal');
                    loadFinancialResponsiblesList();
                } else {
                    throw new Error(result.message || 'Erro ao criar responsÃ¡vel');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao criar responsÃ¡vel: ' + error.message, 'error');
            }
        });

        document.getElementById('addPlanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const isEditing = form.dataset.editingPlanId;
            
            const courseSelect = document.getElementById('planCourse');
            const selectedCourseIds = Array.from(courseSelect.selectedOptions).map(option => option.value);
            
            const formData = {
                courseIds: selectedCourseIds,
                // Backward compatibility: if only one course selected, also send courseId
                courseId: selectedCourseIds.length === 1 ? selectedCourseIds[0] : null,
                category: document.getElementById('planCategory').value,
                name: document.getElementById('planName').value,
                customPrice: document.getElementById('planCustomPrice').value,
                description: document.getElementById('planDescription').value,
                billingType: document.getElementById('planBillingType').value,
                classesPerWeek: parseInt(document.getElementById('planClassesPerWeek').value)
            };
            
            try {
                let response, result;
                
                if (isEditing) {
                    // Update existing plan
                    response = await fetch(`/api/billing-plans/${isEditing}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: formData.name,
                            description: formData.description,
                            price: parseFloat(formData.customPrice),
                            billingType: formData.billingType,
                            classesPerWeek: formData.classesPerWeek,
                            category: formData.category,
                            courseIds: selectedCourseIds,
                            courseId: selectedCourseIds.length === 1 ? selectedCourseIds[0] : null
                        })
                    });
                    result = await response.json();
                    
                    if (result.success) {
                        showToast('Plano atualizado com sucesso!', 'success');
                        closeModal('addPlanModal');
                        loadPaymentPlansList();
                    } else {
                        throw new Error(result.message || 'Erro ao atualizar plano');
                    }
                } else {
                    // Create new plan
                    response = await fetch('/api/payment-plans', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    result = await response.json();
                    
                    if (result.success) {
                        const message = result.data.isExisting ? 
                            'Plano existente encontrado!' : 
                            'Plano criado com sucesso!';
                        showToast(message, 'success');
                        closeModal('addPlanModal');
                        loadPaymentPlansList();
                    } else {
                        throw new Error(result.message || 'Erro ao criar plano');
                    }
                }
            } catch (error) {
                console.error('Erro:', error);
                const action = isEditing ? 'atualizar' : 'criar';
                showToast(`Erro ao ${action} plano: ` + error.message, 'error');
            }
        });

        // ========================================
        // ðŸŽ¯ NOVO SISTEMA UX DE CURSOS - FUNÃ‡Ã•ES JAVASCRIPT
        // ========================================

        // Global variables for new courses interface
        let currentCourseData = null;
        let currentCoursesTab = 'overview';
        let lessonsData = [];
        let techniquesData = [];
        let ragDocuments = [];

        // Tab Management
        function switchCourseTab(tabName) {
            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = '#CBD5E1';
            });
            
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = 'linear-gradient(135deg, #3B82F6, #1D4ED8)';
                activeBtn.style.color = 'white';
            }

            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Show selected tab content
            const tabContent = document.getElementById(`tab-${tabName}`);
            if (tabContent) {
                tabContent.style.display = 'block';
                currentCoursesTab = tabName;
                
                // Load content based on tab
                switch(tabName) {
                    case 'lessons':
                        loadLessonsTable();
                        break;
                    case 'techniques':
                        loadTechniquesDisplay();
                        break;
                    case 'evaluations':
                        loadEvaluationsDisplay();
                        break;
                    case 'ai-rag':
                        loadRAGInterface();
                        break;
                }
            }
        }

        // Lessons Table Management
        async function loadLessonsTable() {
            try {
                lessonsData = generateMockLessons();
                renderLessonsTable();
            } catch (error) {
                console.error('Error loading lessons:', error);
                lessonsData = generateMockLessons();
                renderLessonsTable();
            }
        }

        function generateMockLessons() {
            const lessons = [];
            const units = {
                1: { name: 'Fundamentos', color: '#10B981' },
                2: { name: 'Golpes BÃ¡sicos', color: '#3B82F6' },
                3: { name: 'Defesas BÃ¡sicas', color: '#8B5CF6' },
                4: { name: 'Defesas AvanÃ§adas', color: '#F59E0B' },
                5: { name: 'IntegraÃ§Ã£o', color: '#EF4444' }
            };

            const techniquesPool = [
                ['Guarda de Boxe', 'MovimentaÃ§Ã£o BÃ¡sica'],
                ['Jab', 'Cross'],
                ['Hook', 'Uppercut'],
                ['Joelhada Frontal', 'Chute Frontal'],
                ['Defesa 360Â° Interior', 'Defesa 360Â° Exterior'],
                ['Esquiva Lateral', 'Bloqueio Ativo'],
                ['Combo Jab-Cross', 'Contra-ataque'],
                ['Defesa contra Estrangulamento', 'LiberaÃ§Ã£o de Pegada'],
                ['IntegraÃ§Ã£o TÃ©cnicas', 'CenÃ¡rio Real']
            ];

            for (let i = 1; i <= 48; i++) {
                const unitNum = Math.ceil(i / 10);
                const unit = units[Math.min(unitNum, 5)];
                const isCompleted = i <= 15;
                const isCurrent = i === 16;
                
                lessons.push({
                    number: i,
                    status: isCompleted ? 'completed' : (isCurrent ? 'current' : 'upcoming'),
                    unit: unit.name,
                    unitColor: unit.color,
                    techniques: techniquesPool[Math.floor((i-1) / 5) % techniquesPool.length],
                    objectives: [
                        'Desenvolver coordenaÃ§Ã£o motora',
                        'Aplicar tÃ©cnica em cenÃ¡rio real',
                        'Melhorar precisÃ£o e timing'
                    ],
                    sequence: `Aula ${i} de 48`,
                    tacticalModule: ['RegulaÃ§Ã£o Emocional', 'ConsciÃªncia Situacional', 'Tomada de DecisÃ£o'][Math.floor(i / 4) % 3]
                });
            }

            return lessons;
        }

        function renderLessonsTable() {
            const tbody = document.getElementById('lessonsTableBody');
            if (!tbody) return;

            const filteredLessons = filterLessonsData();
            
            tbody.innerHTML = filteredLessons.map(lesson => `
                <tr style="border-bottom: 1px solid #374151; transition: background-color 0.2s;" 
                    onmouseover="this.style.backgroundColor='rgba(59, 130, 246, 0.05)'" 
                    onmouseout="this.style.backgroundColor='transparent'">
                    <td style="padding: 1rem; color: #F8FAFC; font-weight: 600;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: ${lesson.unitColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">
                                ${lesson.number}
                            </span>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        ${getStatusBadge(lesson.status)}
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 8px; height: 8px; background: ${lesson.unitColor}; border-radius: 50%;"></div>
                            ${lesson.unit}
                        </div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                            ${lesson.techniques.map(tech => `
                                <span style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                    ${tech}
                                </span>
                            `).join('')}
                        </div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1; font-size: 0.875rem;">
                        <div>${lesson.objectives[0]}</div>
                        <div style="color: #94A3B8; margin-top: 0.25rem;">+ ${lesson.objectives.length - 1} mais</div>
                    </td>
                    <td style="padding: 1rem; color: #94A3B8; font-size: 0.875rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                ${lesson.sequence}
                            </span>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="viewLessonDetails(${lesson.number})" 
                                    class="btn btn-small btn-secondary" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                ðŸ‘ï¸ Ver
                            </button>
                            <button onclick="editLesson(${lesson.number})" 
                                    class="btn btn-small btn-primary" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                âœï¸ Editar
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusBadge(status) {
            const badges = {
                completed: '<span style="background: #059669; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">âœ… ConcluÃ­da</span>',
                current: '<span style="background: #3B82F6; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">ðŸ”„ Atual</span>',
                upcoming: '<span style="background: #6B7280; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">â³ PrÃ³xima</span>'
            };
            return badges[status] || badges.upcoming;
        }

        function filterLessonsData() {
            const unitFilter = document.getElementById('unitFilter')?.value || 'all';
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            const searchTerm = document.getElementById('searchLessons')?.value.toLowerCase() || '';

            return lessonsData.filter(lesson => {
                const unitMatch = unitFilter === 'all' || lesson.unit.includes(unitFilter);
                const statusMatch = statusFilter === 'all' || lesson.status === statusFilter;
                const searchMatch = searchTerm === '' || 
                    lesson.techniques.some(tech => tech.toLowerCase().includes(searchTerm)) ||
                    lesson.objectives.some(obj => obj.toLowerCase().includes(searchTerm));
                
                return unitMatch && statusMatch && searchMatch;
            });
        }

        // Filter functions
        function filterLessonsByUnit() { renderLessonsTable(); }
        function filterLessonsByStatus() { renderLessonsTable(); }
        function searchLessons() { renderLessonsTable(); }

        // Techniques Management
        async function loadTechniquesDisplay() {
            techniquesData = generateMockTechniques();
            renderTechniquesDisplay();
        }

        function generateMockTechniques() {
            return [
                {
                    name: 'Fundamentos',
                    color: '#10B981',
                    techniques: [
                        { name: 'Guarda de Boxe', description: 'PosiÃ§Ã£o bÃ¡sica de defesa', difficulty: 1 },
                        { name: 'MovimentaÃ§Ã£o BÃ¡sica', description: 'Deslocamentos fundamentais', difficulty: 1 },
                        { name: 'Postura de Combate', description: 'Stance ideal para defesa', difficulty: 1 }
                    ]
                },
                {
                    name: 'Golpes BÃ¡sicos',
                    color: '#3B82F6',
                    techniques: [
                        { name: 'Jab', description: 'Soco direto com a mÃ£o da frente', difficulty: 2 },
                        { name: 'Cross', description: 'Soco cruzado com forÃ§a', difficulty: 2 },
                        { name: 'Hook', description: 'Gancho lateral potente', difficulty: 3 }
                    ]
                },
                {
                    name: 'Defesas BÃ¡sicas',
                    color: '#8B5CF6',
                    techniques: [
                        { name: 'Defesa 360Â°', description: 'Bloqueio circular universal', difficulty: 3 },
                        { name: 'Esquiva Lateral', description: 'Desvio do corpo para os lados', difficulty: 2 },
                        { name: 'Defesa contra Estrangulamento', description: 'LiberaÃ§Ã£o de pegada no pescoÃ§o', difficulty: 4 }
                    ]
                }
            ];
        }

        function renderTechniquesDisplay() {
            const container = document.getElementById('techniquesContainer');
            if (!container) return;

            container.innerHTML = techniquesData.map(unit => `
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: ${unit.color}; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: rgba(${hexToRgb(unit.color)}, 0.1); border-radius: 8px;">
                        <div style="width: 10px; height: 10px; background: ${unit.color}; border-radius: 50%;"></div>
                        ${unit.name} (${unit.techniques.length} tÃ©cnicas)
                    </h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        ${unit.techniques.map(technique => `
                            <div onclick="showTechniqueDetails('${technique.name}')" 
                                 style="padding: 1rem; background: rgba(59, 130, 246, 0.05); border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent;"
                                 onmouseover="this.style.borderColor='${unit.color}'; this.style.background='rgba(${hexToRgb(unit.color)}, 0.1)'"
                                 onmouseout="this.style.borderColor='transparent'; this.style.background='rgba(59, 130, 246, 0.05)'">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.25rem;">${technique.name}</div>
                                        <div style="color: #CBD5E1; font-size: 0.875rem;">${technique.description}</div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div style="color: #F59E0B;">
                                            ${'â­'.repeat(technique.difficulty)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function showTechniqueDetails(techniqueName) {
            const detailsContainer = document.getElementById('techniqueDetails');
            if (!detailsContainer) return;

            // Find technique in data
            let foundTechnique = null;
            let foundUnit = null;
            
            for (const unit of techniquesData) {
                const technique = unit.techniques.find(t => t.name === techniqueName);
                if (technique) {
                    foundTechnique = technique;
                    foundUnit = unit;
                    break;
                }
            }

            if (!foundTechnique) return;

            detailsContainer.innerHTML = `
                <div style="padding: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: rgba(${hexToRgb(foundUnit.color)}, 0.1); border-radius: 8px;">
                        <div style="width: 40px; height: 40px; background: ${foundUnit.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                            ðŸ¥Š
                        </div>
                        <div>
                            <h3 style="color: #F8FAFC; margin: 0; margin-bottom: 0.25rem;">${foundTechnique.name}</h3>
                            <div style="color: ${foundUnit.color}; font-size: 0.875rem; font-weight: 600;">${foundUnit.name}</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #F8FAFC; margin-bottom: 0.75rem;">ðŸ“‹ DescriÃ§Ã£o</h4>
                        <p style="color: #CBD5E1; line-height: 1.6;">${foundTechnique.description}</p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #F8FAFC; margin-bottom: 0.75rem;">â­ Dificuldade</h4>
                        <div style="color: #F59E0B; font-size: 1.25rem;">
                            ${'â­'.repeat(foundTechnique.difficulty)} (${foundTechnique.difficulty}/5)
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.75rem;">
                        <button onclick="editTechnique('${foundTechnique.name}')" class="btn btn-primary" style="flex: 1;">
                            <span>âœï¸</span> Editar TÃ©cnica
                        </button>
                        <button onclick="addToLesson('${foundTechnique.name}')" class="btn btn-secondary" style="flex: 1;">
                            <span>âž•</span> Adicionar Ã  Aula
                        </button>
                    </div>
                </div>
            `;
        }

        // Evaluations Management
        function loadEvaluationsDisplay() {
            const container = document.getElementById('evaluationsContainer');
            if (!container) return;

            const evaluations = [
                { module: 1, name: 'Fundamentos', lesson: 8, status: 'completed', date: '15/06/2025', average: 8.5 },
                { module: 2, name: 'Golpes BÃ¡sicos', lesson: 16, status: 'completed', date: '29/06/2025', average: 7.8 },
                { module: 3, name: 'Defesas BÃ¡sicas', lesson: 24, status: 'upcoming', date: '13/07/2025', average: null },
                { module: 4, name: 'Defesas AvanÃ§adas', lesson: 32, status: 'upcoming', date: '27/07/2025', average: null },
                { module: 5, name: 'IntegraÃ§Ã£o Final', lesson: 40, status: 'upcoming', date: '10/08/2025', average: null }
            ];

            container.innerHTML = evaluations.map(eval => `
                <div style="background: rgba(59, 130, 246, 0.05); border-radius: 12px; padding: 1.5rem; border: 1px solid #374151;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="color: #F8FAFC; margin: 0;">MÃ³dulo ${eval.module}: ${eval.name}</h4>
                        ${eval.status === 'completed' ? 
                            `<span style="background: #059669; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">âœ… Realizada</span>` :
                            `<span style="background: #6B7280; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">â³ Pendente</span>`
                        }
                    </div>
                    
                    <div style="color: #CBD5E1; margin-bottom: 1rem;">
                        <div style="margin-bottom: 0.5rem;"><strong>ðŸ“… Data:</strong> ${eval.date}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>ðŸ“‹ Aula:</strong> ${eval.lesson}/48</div>
                        ${eval.average ? 
                            `<div><strong>ðŸ“Š MÃ©dia da Turma:</strong> <span style="color: #10B981; font-weight: bold;">${eval.average}/10</span></div>` :
                            `<div><strong>ðŸ“Š MÃ©dia:</strong> <span style="color: #6B7280;">Pendente</span></div>`
                        }
                    </div>

                    <div style="display: flex; gap: 0.75rem;">
                        ${eval.status === 'completed' ? 
                            `<button onclick="viewEvaluationResults(${eval.module})" class="btn btn-secondary" style="flex: 1; font-size: 0.875rem;">
                                <span>ðŸ“Š</span> Ver Resultados
                            </button>` :
                            `<button onclick="scheduleEvaluation(${eval.module})" class="btn btn-primary" style="flex: 1; font-size: 0.875rem;">
                                <span>ðŸ“…</span> Agendar
                            </button>`
                        }
                        <button onclick="editEvaluation(${eval.module})" class="btn btn-secondary" style="flex: 1; font-size: 0.875rem;">
                            <span>âœï¸</span> Editar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // RAG Interface
        function loadRAGInterface() {
            initializeRAGDocuments();
        }

        function initializeRAGDocuments() {
            ragDocuments = [
                {
                    id: 'agenda',
                    name: 'Agenda do Aluno Faixa Branca.pdf',
                    description: 'Estrutura pedagÃ³gica e cronograma',
                    type: 'pdf',
                    indexed: true
                },
                {
                    id: 'plano',
                    name: 'Plano de Curso Faixa Branca.pdf', 
                    description: 'Metodologia e tÃ©cnicas detalhadas',
                    type: 'pdf',
                    indexed: true
                }
            ];
        }

        async function sendRAGQuery() {
            const input = document.getElementById('ragChatInput');
            const chatContainer = document.getElementById('ragChatContainer');
            
            if (!input || !chatContainer || !input.value.trim()) return;

            const query = input.value.trim();
            input.value = '';

            // Add user message
            addChatMessage(chatContainer, query, 'user');
            
            // Add loading message
            const loadingId = addChatMessage(chatContainer, 'Processando consulta com IA...', 'assistant', true);

            try {
                // Simulate RAG query processing
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Remove loading message
                document.getElementById(loadingId)?.remove();
                
                // Add AI response
                const response = generateRAGResponse(query);
                addChatMessage(chatContainer, response, 'assistant');
                
            } catch (error) {
                document.getElementById(loadingId)?.remove();
                addChatMessage(chatContainer, 'Erro ao processar consulta. Tente novamente.', 'error');
            }
        }

        function addChatMessage(container, message, type, isLoading = false) {
            const messageId = 'msg-' + Date.now();
            const colors = {
                user: { bg: 'rgba(59, 130, 246, 0.1)', text: '#3B82F6', icon: 'ðŸ‘¤' },
                assistant: { bg: 'rgba(16, 185, 129, 0.1)', text: '#10B981', icon: 'ðŸ¤–' },
                error: { bg: 'rgba(239, 68, 68, 0.1)', text: '#EF4444', icon: 'âŒ' }
            };
            
            const style = colors[type] || colors.assistant;
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.style.cssText = `
                display: flex; gap: 0.75rem; margin-bottom: 1rem; padding: 1rem; 
                background: ${style.bg}; border-radius: 8px; align-items: flex-start;
            `;
            
            messageDiv.innerHTML = `
                <div style="color: ${style.text}; font-size: 1.25rem;">${style.icon}</div>
                <div style="flex: 1; color: #CBD5E1; line-height: 1.6;">
                    ${message}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            return messageId;
        }

        function generateRAGResponse(query) {
            const responses = {
                'tea': 'Para alunos com TEA, recomendo: 1) DemonstraÃ§Ãµes visuais claras e repetitivas, 2) Ambiente com menos estÃ­mulos sonoros, 3) Rotina previsÃ­vel e sinais visuais, 4) Pausas quando necessÃ¡rio.',
                'adaptaÃ§Ã£o': 'AdaptaÃ§Ãµes incluem: modificar intensidade, usar apoios visuais, ajustar tempo de execuÃ§Ã£o, e personalizar instruÃ§Ãµes conforme necessidades especiais.',
                'tÃ©cnica': 'Baseado nos documentos, cada tÃ©cnica deve seguir: explicaÃ§Ã£o clara, demonstraÃ§Ã£o, prÃ¡tica supervisionada, correÃ§Ã£o individual, e aplicaÃ§Ã£o em cenÃ¡rio.',
                'avaliaÃ§Ã£o': 'O sistema de avaliaÃ§Ã£o modular inclui 5 etapas: Fundamentos (aula 8), Golpes (16), Defesas bÃ¡sicas (24), Defesas avanÃ§adas (32), e IntegraÃ§Ã£o (40).'
            };

            const lowQuery = query.toLowerCase();
            for (const [key, response] of Object.entries(responses)) {
                if (lowQuery.includes(key)) {
                    return response;
                }
            }

            return 'Com base nos documentos RAG, posso ajudar com informaÃ§Ãµes sobre estrutura pedagÃ³gica, adaptaÃ§Ãµes para necessidades especiais, metodologia de ensino, e sistema de avaliaÃ§Ãµes. Poderia ser mais especÃ­fico sobre sua dÃºvida?';
        }

        // Course Generator
        async function generateCourseWithRAG(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const courseData = {
                martialArt: formData.get('martialArt'),
                level: formData.get('level'),
                targetAudience: formData.get('targetAudience'),
                duration: formData.get('duration'),
                objectives: formData.get('objectives'),
                document: formData.get('document')
            };

            // Show loading state
            const generateBtn = event.target.querySelector('button[type="submit"]');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<span>â³</span> Gerando...';
            generateBtn.disabled = true;

            try {
                // Simulate course generation
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Success message
                showNotification('Curso gerado com sucesso! ðŸŽ‰', 'success');
                
                // Reset form
                event.target.reset();
                
            } catch (error) {
                showNotification('Erro ao gerar curso. Tente novamente.', 'error');
            } finally {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        // ========================================
        // SIMPLE COURSE CREATOR FUNCTIONS
        // ========================================

        // Store course preview data globally
        let coursePreviewData = null;

        // Open simple course creator (show the interface)
        function openSimpleCourseCreator() {
            const simpleCourseCreator = document.getElementById('simpleCourseCreator');
            const advancedForm = document.getElementById('courseGeneratorForm');
            
            // Show simple creator, hide advanced form
            simpleCourseCreator.style.display = 'block';
            advancedForm.style.display = 'none';
            
            // Focus on the course name input
            document.getElementById('quickCourseName').focus();
            
            showNotification('âœ¨ Modo de criaÃ§Ã£o rÃ¡pida ativado! Digite apenas o nome do curso.', 'success');
        }

        // Show advanced course form
        function showAdvancedCourseForm() {
            const simpleCourseCreator = document.getElementById('simpleCourseCreator');
            const advancedForm = document.getElementById('courseGeneratorForm');
            
            // Hide simple creator, show advanced form
            simpleCourseCreator.style.display = 'none';
            advancedForm.style.display = 'block';
            
            showNotification('ðŸŽ›ï¸ Modo avanÃ§ado ativado! Personalize todos os detalhes do curso.', 'info');
        }

        // Create course automatically with AI
        async function createQuickCourse() {
            const courseName = document.getElementById('quickCourseName').value.trim();
            
            if (!courseName) {
                showNotification('âŒ Por favor, digite o nome do curso.', 'error');
                return;
            }

            try {
                showNotification('ðŸ¤– IA analisando e gerando curso automaticamente...', 'info');
                
                // Generate course data using AI
                const courseData = await generateCourseDataFromName(courseName);
                
                // Create course via API
                await createCourseViaAPI(courseData);
                
                // Clear input and show success
                document.getElementById('quickCourseName').value = '';
                document.getElementById('coursePreviewArea').style.display = 'none';
                
                showNotification('ðŸŽ‰ Curso criado com sucesso!', 'success');
                
                // Refresh courses list if function exists
                if (typeof updateCoursesTable === 'function') {
                    updateCoursesTable();
                }
                
            } catch (error) {
                showNotification('âŒ Erro ao criar curso: ' + error.message, 'error');
            }
        }

        // Preview course before creating
        async function previewQuickCourse() {
            const courseName = document.getElementById('quickCourseName').value.trim();
            
            if (!courseName) {
                showNotification('âŒ Por favor, digite o nome do curso para gerar preview.', 'error');
                return;
            }

            try {
                showNotification('ðŸ” Gerando preview do curso...', 'info');
                
                // Generate course data
                const courseData = await generateCourseDataFromName(courseName);
                coursePreviewData = courseData;
                
                // Show preview
                displayCoursePreview(courseData);
                
            } catch (error) {
                showNotification('âŒ Erro ao gerar preview: ' + error.message, 'error');
            }
        }

        // Generate course data from just the name using AI
        async function generateCourseDataFromName(courseName) {
            // Smart parsing of course name
            const lowerName = courseName.toLowerCase();
            
            // Detect martial art
            let martialArt = 'krav-maga'; // default
            let martialArtDisplay = 'Krav Maga';
            
            if (lowerName.includes('jiu-jitsu') || lowerName.includes('jiujitsu')) {
                martialArt = 'jiu-jitsu';
                martialArtDisplay = 'Jiu-Jitsu';
            } else if (lowerName.includes('boxe')) {
                martialArt = 'boxe';
                martialArtDisplay = 'Boxe';
            } else if (lowerName.includes('muay thai')) {
                martialArt = 'muay-thai';
                martialArtDisplay = 'Muay Thai';
            } else if (lowerName.includes('karate') || lowerName.includes('karatÃª')) {
                martialArt = 'karate';
                martialArtDisplay = 'KaratÃª';
            } else if (lowerName.includes('taekwondo')) {
                martialArt = 'taekwondo';
                martialArtDisplay = 'Taekwondo';
            } else if (lowerName.includes('judo') || lowerName.includes('judÃ´')) {
                martialArt = 'judo';
                martialArtDisplay = 'JudÃ´';
            } else if (lowerName.includes('mma')) {
                martialArt = 'mma';
                martialArtDisplay = 'MMA';
            }
            
            // Detect level/belt and map to CourseLevel enum
            let level = 'BEGINNER';
            let levelDisplay = 'Faixa Branca';
            
            if (lowerName.includes('amarela') || lowerName.includes('yellow')) {
                level = 'BEGINNER';
                levelDisplay = 'Faixa Amarela';
            } else if (lowerName.includes('laranja') || lowerName.includes('orange')) {
                level = 'INTERMEDIATE';
                levelDisplay = 'Faixa Laranja';
            } else if (lowerName.includes('verde') || lowerName.includes('green')) {
                level = 'INTERMEDIATE';
                levelDisplay = 'Faixa Verde';
            } else if (lowerName.includes('azul') || lowerName.includes('blue')) {
                level = 'INTERMEDIATE';
                levelDisplay = 'Faixa Azul';
            } else if (lowerName.includes('roxa') || lowerName.includes('purple')) {
                level = 'ADVANCED';
                levelDisplay = 'Faixa Roxa';
            } else if (lowerName.includes('marrom') || lowerName.includes('brown')) {
                level = 'ADVANCED';
                levelDisplay = 'Faixa Marrom';
            } else if (lowerName.includes('preta') || lowerName.includes('black')) {
                level = 'EXPERT';
                levelDisplay = 'Faixa Preta';
            } else if (lowerName.includes('master') || lowerName.includes('mestre')) {
                level = 'MASTER';
                levelDisplay = 'Mestre';
            }
            
            // Detect audience
            let audience = 'adultos';
            let ageGroup = '18-65';
            
            if (lowerName.includes('crianÃ§a') || lowerName.includes('infantil') || lowerName.includes('kids')) {
                audience = 'crianÃ§as';
                ageGroup = '6-12';
            } else if (lowerName.includes('adolescent') || lowerName.includes('teen')) {
                audience = 'adolescentes';
                ageGroup = '13-17';
            } else if (lowerName.includes('senior') || lowerName.includes('idoso')) {
                audience = 'seniors';
                ageGroup = '65+';
            }
            
            // Generate course structure
            const courseData = {
                name: courseName,
                martialArt: martialArt,
                level: level,
                description: `Curso de ${martialArtDisplay} - ${levelDisplay} para ${audience}. Metodologia adaptada e progressiva focada em tÃ©cnicas fundamentais, desenvolvimento fÃ­sico e mental, com Ãªnfase em aplicaÃ§Ã£o prÃ¡tica e seguranÃ§a.`,
                ageGroup: ageGroup,
                duration: audience === 'crianÃ§as' ? 16 : 24, // weeks
                totalLessons: audience === 'crianÃ§as' ? 32 : 48,
                objectives: [
                    'Desenvolver tÃ©cnicas fundamentais de ' + martialArtDisplay,
                    'Melhorar condicionamento fÃ­sico e flexibilidade',
                    'Aumentar consciÃªncia situacional e autoconfianÃ§a',
                    'Promover disciplina e respeito',
                    'Preparar para evoluÃ§Ã£o para prÃ³ximo nÃ­vel'
                ],
                evaluationCriteria: [
                    'ExecuÃ§Ã£o correta das tÃ©cnicas bÃ¡sicas',
                    'Conhecimento teÃ³rico dos princÃ­pios',
                    'ProgressÃ£o fÃ­sica e mental',
                    'FrequÃªncia e dedicaÃ§Ã£o nas aulas',
                    'DemonstraÃ§Ã£o prÃ¡tica em situaÃ§Ãµes controladas'
                ]
            };
            
            return courseData;
        }

        // Display course preview
        function displayCoursePreview(courseData) {
            const previewArea = document.getElementById('coursePreviewArea');
            const previewContent = document.getElementById('coursePreviewContent');
            
            previewContent.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <strong style="color: #3B82F6;">ðŸ“š Nome:</strong><br>
                        <span style="color: #CBD5E1;">${courseData.name}</span>
                    </div>
                    <div>
                        <strong style="color: #3B82F6;">ðŸ¥‹ Arte Marcial:</strong><br>
                        <span style="color: #CBD5E1;">${courseData.martialArt}</span>
                    </div>
                    <div>
                        <strong style="color: #3B82F6;">ðŸŽ¯ NÃ­vel:</strong><br>
                        <span style="color: #CBD5E1;">${courseData.level}</span>
                    </div>
                    <div>
                        <strong style="color: #3B82F6;">ðŸ‘¥ Faixa EtÃ¡ria:</strong><br>
                        <span style="color: #CBD5E1;">${courseData.ageGroup} anos</span>
                    </div>
                    <div>
                        <strong style="color: #3B82F6;">â±ï¸ DuraÃ§Ã£o:</strong><br>
                        <span style="color: #CBD5E1;">${courseData.duration} semanas</span>
                    </div>
                    <div>
                        <strong style="color: #3B82F6;">ðŸ“‹ Aulas:</strong><br>
                        <span style="color: #CBD5E1;">${courseData.totalLessons} aulas (${courseData.lessonDuration}min cada)</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <strong style="color: #3B82F6;">ðŸ“ DescriÃ§Ã£o:</strong><br>
                    <span style="color: #CBD5E1; font-size: 0.9rem; line-height: 1.4;">${courseData.description}</span>
                </div>
                
                <div>
                    <strong style="color: #3B82F6;">ðŸŽ¯ Objetivos:</strong><br>
                    <ul style="color: #CBD5E1; font-size: 0.9rem; margin: 0.5rem 0; padding-left: 1.2rem;">
                        ${courseData.objectives.map(obj => `<li>${obj}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            previewArea.style.display = 'block';
            showNotification('ðŸ‘ï¸ Preview gerado! Revise os detalhes antes de criar.', 'success');
        }

        // Confirm and create course from preview
        async function confirmCreateCourse() {
            if (!coursePreviewData) {
                showNotification('âŒ Nenhum curso para confirmar. Gere um preview primeiro.', 'error');
                return;
            }

            try {
                await createCourseViaAPI(coursePreviewData);
                
                // Clear everything
                document.getElementById('quickCourseName').value = '';
                document.getElementById('coursePreviewArea').style.display = 'none';
                coursePreviewData = null;
                
                showNotification('ðŸŽ‰ Curso confirmado e criado com sucesso!', 'success');
                
                // Refresh courses list
                if (typeof updateCoursesTable === 'function') {
                    updateCoursesTable();
                }
                
            } catch (error) {
                showNotification('âŒ Erro ao confirmar criaÃ§Ã£o: ' + error.message, 'error');
            }
        }

        // Edit course details (switch to advanced form)
        function editCourseDetails() {
            if (!coursePreviewData) {
                showNotification('âŒ Nenhum curso para editar. Gere um preview primeiro.', 'error');
                return;
            }

            // Fill advanced form with preview data
            fillAdvancedFormWithData(coursePreviewData);
            
            // Switch to advanced form
            showAdvancedCourseForm();
            
            showNotification('âœï¸ Dados carregados no formulÃ¡rio avanÃ§ado para ediÃ§Ã£o.', 'info');
        }

        // Fill advanced form with course data
        function fillAdvancedFormWithData(courseData) {
            // Fill form fields if they exist
            const fields = {
                'martialArtSelect': courseData.martialArt,
                'courseLevelSelect': courseData.level,
                'courseNameInput': courseData.name,
                'courseDescriptionInput': courseData.description,
                'courseDurationInput': courseData.duration,
                'totalLessonsInput': courseData.totalLessons,
                'courseObjectivesInput': courseData.objectives.join('\\n'),
                'evaluationCriteriaInput': courseData.evaluationCriteria.join('\\n')
            };
            
            for (const [fieldId, value] of Object.entries(fields)) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = value;
                }
            }
        }

        // Create course via API
        async function createCourseViaAPI(courseData) {
            try {
                const response = await fetch('/api/courses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(courseData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Erro desconhecido ao criar curso');
                }

                return result.data;
                
            } catch (error) {
                console.error('Error creating course via API:', error);
                throw error;
            }
        }

        // Utility Functions
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? 
                `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
                '59, 130, 246';
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: '#10B981',
                error: '#EF4444',
                info: '#3B82F6',
                warning: '#F59E0B'
            };

            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                background: ${colors[type]}; color: white; padding: 1rem 1.5rem;
                border-radius: 8px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transform: translateX(100%); transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Slide in
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            
            // Auto remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Placeholder functions for buttons
        function loadSelectedCourse() { console.log('Loading selected course...'); }
        function editCourseDetails() { showNotification('Funcionalidade em desenvolvimento', 'info'); }
        function openLessonPlanManager() { switchCourseTab('lessons'); }
        function openTechniquesLibrary() { switchCourseTab('techniques'); }
        function generateProgressReport() { showNotification('Gerando relatÃ³rio...', 'info'); }
        function openRAGInterface() { switchCourseTab('ai-rag'); }
        function viewLessonDetails(num) { showNotification(`Visualizando aula ${num}`, 'info'); }
        function editLesson(num) { showNotification(`Editando aula ${num}`, 'info'); }
        function editTechnique(name) { showNotification(`Editando tÃ©cnica: ${name}`, 'info'); }
        function addToLesson(name) { showNotification(`Adicionando ${name} Ã  aula`, 'success'); }
        function viewEvaluationResults(module) { showNotification(`Resultados do mÃ³dulo ${module}`, 'info'); }
        
        // Assign functions to window after they are defined
        window.editLesson = editLesson;
        function scheduleEvaluation(module) { showNotification(`Agendando avaliaÃ§Ã£o mÃ³dulo ${module}`, 'info'); }
        function editEvaluation(module) { showNotification(`Editando mÃ³dulo ${module}`, 'info'); }
        function uploadRAGDocument() { showNotification('Funcionalidade de upload em desenvolvimento', 'info'); }
        function viewRAGDocument(id) { showNotification(`Visualizando documento: ${id}`, 'info'); }
        function exportLessonPlans() { showNotification('Exportando planos de aula...', 'info'); }
        function useExistingTemplate() { showNotification('Usando template do Faixa Branca...', 'info'); }
        function openRAGCourseCreator() { switchCourseTab('ai-rag'); }
        function importCourseDocument() { document.getElementById('courseDocument')?.click(); }

        // Initialize courses interface when tab is switched
        function showCourses() {
            showSection('courses');
            // Initialize default tab when courses section is opened
            setTimeout(() => switchCourseTab('overview'), 100);
            // Load courses data to populate the table
            loadCourses();
        }

        // Add CSS animations for courses interface
        const coursesStyle = document.createElement('style');
        coursesStyle.textContent = `
            @keyframes pulse {
                0%, 100% { opacity: 0.4; }
                50% { opacity: 1; }
            }
            .tab-btn:hover {
                background: rgba(59, 130, 246, 0.1) !important;
                color: #3B82F6 !important;
            }
            .tab-content {
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(coursesStyle);

        // ===============================
        // CLASSES (TURMAS) FUNCTIONS
        // ===============================
        
        function createNewClass() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div class="create-class-modal" style="
                    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
                    border-radius: 20px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 90vh;
                    overflow-y: auto;
                    border: 1px solid #334155;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
                    transform: translateY(20px) scale(0.95);
                    transition: all 0.3s ease;
                ">
                    <!-- Header -->
                    <div style="padding: 2rem 2rem 1rem 2rem; border-bottom: 1px solid #334155;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="color: #F8FAFC; margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700;">âž• Criar Nova Turma</h2>
                                <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">Configure uma nova turma para o curso</p>
                            </div>
                            <button onclick="closeCreateClassModal()" style="
                                background: rgba(239, 68, 68, 0.1);
                                border: 1px solid rgba(239, 68, 68, 0.3);
                                color: #EF4444;
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 1.2rem;
                                transition: all 0.2s;
                            ">
                                âœ•
                            </button>
                        </div>
                    </div>
                    
                    <!-- Form Content -->
                    <div style="padding: 2rem;">
                        <form id="createClassForm" style="display: grid; gap: 1.5rem;">
                            <!-- Course Selection -->
                            <div>
                                <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">ðŸ“š Curso Base</label>
                                <select id="courseSelect" required style="
                                    width: 100%;
                                    background: #1E293B;
                                    border: 1px solid #475569;
                                    color: #F8FAFC;
                                    padding: 0.75rem;
                                    border-radius: 8px;
                                    font-size: 0.875rem;
                                ">
                                    <option value="">Selecione um curso</option>
                                    <option value="krav-maga-basic">Krav Maga - Faixa Branca</option>
                                    <option value="krav-maga-advanced">Krav Maga - Faixa Amarela</option>
                                    <option value="self-defense">Defesa Pessoal BÃ¡sica</option>
                                </select>
                            </div>
                            
                            <!-- Class Details -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">ðŸ·ï¸ Nome da Turma</label>
                                    <input type="text" id="className" required placeholder="Ex: Turma 3 - Tarde" style="
                                        width: 100%;
                                        background: #1E293B;
                                        border: 1px solid #475569;
                                        color: #F8FAFC;
                                        padding: 0.75rem;
                                        border-radius: 8px;
                                        font-size: 0.875rem;
                                    ">
                                </div>
                                <div>
                                    <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">ðŸ‘¥ Capacidade MÃ¡xima</label>
                                    <input type="number" id="classCapacity" required value="20" min="5" max="50" style="
                                        width: 100%;
                                        background: #1E293B;
                                        border: 1px solid #475569;
                                        color: #F8FAFC;
                                        padding: 0.75rem;
                                        border-radius: 8px;
                                        font-size: 0.875rem;
                                    ">
                                </div>
                            </div>
                            
                            <!-- Schedule Configuration -->
                            <div>
                                <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">ðŸ“… Dias da Semana</label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="monday" style="accent-color: #3B82F6;"> Segunda
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="tuesday" style="accent-color: #3B82F6;"> TerÃ§a
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="wednesday" style="accent-color: #3B82F6;"> Quarta
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="thursday" style="accent-color: #3B82F6;"> Quinta
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="friday" style="accent-color: #3B82F6;"> Sexta
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="saturday" style="accent-color: #3B82F6;"> SÃ¡bado
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="sunday" style="accent-color: #3B82F6;"> Domingo
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Time Configuration -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">ðŸ• HorÃ¡rio de InÃ­cio</label>
                                    <input type="time" id="startTime" required value="08:00" style="
                                        width: 100%;
                                        background: #1E293B;
                                        border: 1px solid #475569;
                                        color: #F8FAFC;
                                        padding: 0.75rem;
                                        border-radius: 8px;
                                        font-size: 0.875rem;
                                    ">
                                </div>
                                <div>
                                    <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">â±ï¸ DuraÃ§Ã£o (minutos)</label>
                                    <select id="classDuration" required style="
                                        width: 100%;
                                        background: #1E293B;
                                        border: 1px solid #475569;
                                        color: #F8FAFC;
                                        padding: 0.75rem;
                                        border-radius: 8px;
                                        font-size: 0.875rem;
                                    ">
                                        <option value="60">60 minutos</option>
                                        <option value="90">90 minutos</option>
                                        <option value="120">120 minutos</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Instructor Selection -->
                            <div>
                                <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">ðŸ‘¨â€ðŸ« Instrutor ResponsÃ¡vel</label>
                                <select id="instructorSelect" required style="
                                    width: 100%;
                                    background: #1E293B;
                                    border: 1px solid #475569;
                                    color: #F8FAFC;
                                    padding: 0.75rem;
                                    border-radius: 8px;
                                    font-size: 0.875rem;
                                ">
                                    <option value="">Selecione um instrutor</option>
                                    <option value="prof-silva">Prof. Silva</option>
                                    <option value="prof-costa">Prof. Costa</option>
                                    <option value="prof-santos">Prof. Santos</option>
                                </select>
                            </div>
                            
                            <!-- Start Date -->
                            <div>
                                <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">ðŸ“… Data de InÃ­cio</label>
                                <input type="date" id="startDate" required style="
                                    width: 100%;
                                    background: #1E293B;
                                    border: 1px solid #475569;
                                    color: #F8FAFC;
                                    padding: 0.75rem;
                                    border-radius: 8px;
                                    font-size: 0.875rem;
                                ">
                            </div>
                            
                            <!-- Additional Notes -->
                            <div>
                                <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">ðŸ“ ObservaÃ§Ãµes (Opcional)</label>
                                <textarea id="classNotes" placeholder="InformaÃ§Ãµes adicionais sobre a turma..." style="
                                    width: 100%;
                                    background: #1E293B;
                                    border: 1px solid #475569;
                                    color: #F8FAFC;
                                    padding: 0.75rem;
                                    border-radius: 8px;
                                    font-size: 0.875rem;
                                    min-height: 80px;
                                    resize: vertical;
                                "></textarea>
                            </div>
                        </form>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                            <button onclick="closeCreateClassModal()" style="
                                background: rgba(107, 114, 128, 0.1);
                                border: 1px solid #6B7280;
                                color: #9CA3AF;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                                transition: all 0.2s;
                            ">
                                Cancelar
                            </button>
                            <button onclick="submitCreateClass()" style="
                                background: linear-gradient(135deg, #10B981, #059669);
                                border: none;
                                color: white;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                                transition: all 0.2s;
                            ">
                                âž• Criar Turma
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default start date to next Monday
            const nextMonday = new Date();
            const day = nextMonday.getDay();
            const daysUntilMonday = day === 0 ? 1 : 8 - day;
            nextMonday.setDate(nextMonday.getDate() + daysUntilMonday);
            document.getElementById('startDate').value = nextMonday.toISOString().split('T')[0];
            
            // Animate modal in
            setTimeout(() => {
                modal.style.opacity = '1';
                const modalContent = modal.querySelector('.create-class-modal');
                modalContent.style.transform = 'translateY(0) scale(1)';
            }, 50);
        }
        
        function viewClassSchedule() {
            alert('ðŸš§ FunÃ§Ã£o em desenvolvimento: Cronograma de Turmas\n\nExibirÃ¡:\nâ€¢ CalendÃ¡rio completo\nâ€¢ Aulas agendadas\nâ€¢ Conflitos de horÃ¡rio\nâ€¢ Feriados e pausas');
        }
        
        function viewClassDetails(classId) {
            alert(`ðŸš§ Visualizando detalhes da Turma ${classId}\n\nInformaÃ§Ãµes disponÃ­veis:\nâ€¢ Lista de alunos\nâ€¢ Progresso da turma\nâ€¢ HistÃ³rico de frequÃªncia\nâ€¢ AvaliaÃ§Ãµes realizadas`);
        }
        
        function manageClassSchedule(classId) {
            alert(`ðŸš§ Gerenciando agenda da Turma ${classId}\n\nFuncionalidades:\nâ€¢ Reagendar aulas\nâ€¢ Marcar faltas do instrutor\nâ€¢ Aulas de reposiÃ§Ã£o\nâ€¢ AlteraÃ§Ãµes de horÃ¡rio`);
        }
        
        function filterClasses() {
            const filter = document.getElementById('classStatusFilter').value;
            console.log('Filtering classes by:', filter);
            // Implementar filtragem das turmas
        }
        
        // Update classes count in sidebar
        function updateClassesCount() {
            // No hardcoded data - will be populated by real API calls
        }
        
        // Initialize classes data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateClassesCount();
        });

        // ===============================
        // COURSE GENERATION FUNCTIONS
        // ===============================
        
        function generateCourseWithRAG(event) {
            event.preventDefault();
            
            // Collect form data
            const formData = {
                martialArt: document.getElementById('martialArtSelect').value,
                courseLevel: document.getElementById('courseLevelSelect').value,
                courseName: document.getElementById('courseName').value,
                courseDescription: document.getElementById('courseDescription').value,
                targetAudience: document.getElementById('targetAudienceSelect').value,
                genderTarget: document.getElementById('genderTargetSelect').value,
                context: document.getElementById('contextSelect').value,
                courseDuration: document.getElementById('courseDuration').value,
                totalLessons: document.getElementById('totalLessons').value,
                lessonDuration: document.getElementById('lessonDuration').value,
                courseObjectives: document.getElementById('courseObjectives').value,
                evaluationCriteria: document.getElementById('evaluationCriteria').value,
                teachingStyle: document.getElementById('teachingStyle').value,
                aiInstructions: document.getElementById('aiInstructions').value,
                
                // Special adaptations
                adaptations: {
                    TEA: document.getElementById('adaptTEA').checked,
                    TDAH: document.getElementById('adaptTDH').checked,
                    mobility: document.getElementById('adaptMobility').checked,
                    visual: document.getElementById('adaptVisual').checked,
                    auditory: document.getElementById('adaptAuditory').checked,
                    cardiac: document.getElementById('adaptCardiac').checked
                }
            };

            // Validate required fields
            if (!formData.martialArt || !formData.courseLevel || !formData.courseName || 
                !formData.courseDescription || !formData.targetAudience || !formData.courseObjectives) {
                showToast('âš ï¸ Preencha todos os campos obrigatÃ³rios', 'warning');
                return;
            }

            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span>â³</span> Gerando com IA...';
            submitBtn.disabled = true;

            // Simulate RAG-powered course generation
            setTimeout(() => {
                console.log('Course data to be sent to RAG system:', formData);
                
                // Create course based on form data
                const generatedCourse = createCourseFromRAG(formData);
                
                // Add to courses list (simulate API call)
                addNewCourseToInterface(generatedCourse);
                
                // Show success message
                showToast(`âœ… Curso "${formData.courseName}" gerado com sucesso usando IA + RAG!`, 'success');
                
                // Reset form
                document.getElementById('courseGeneratorForm').reset();
                
                // Restore button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
            }, 3000);
        }

        function createCourseFromRAG(formData) {
            // Simulate RAG processing using knowledge base
            const course = {
                id: Date.now(),
                name: formData.courseName,
                description: formData.courseDescription,
                martialArt: formData.martialArt,
                level: formData.courseLevel,
                targetAudience: formData.targetAudience,
                duration: parseInt(formData.courseDuration),
                totalLessons: parseInt(formData.totalLessons),
                lessonDuration: parseInt(formData.lessonDuration),
                objectives: formData.courseObjectives.split(',').map(obj => obj.trim()),
                evaluationCriteria: formData.evaluationCriteria,
                teachingStyle: formData.teachingStyle,
                adaptations: formData.adaptations,
                
                // Generate lesson structure based on RAG knowledge
                lessons: generateLessonsFromRAG(formData),
                
                // Generate techniques based on RAG
                techniques: generateTechniquesFromRAG(formData),
                
                createdAt: new Date().toISOString(),
                status: 'active'
            };
            
            return course;
        }

        function generateLessonsFromRAG(formData) {
            // Base knowledge from RAG (simulated)
            const baseStructure = {
                'krav-maga': {
                    'branca': ['Fundamentos', 'Golpes BÃ¡sicos', 'Defesas BÃ¡sicas', 'Defesas AvanÃ§adas', 'IntegraÃ§Ã£o'],
                    'amarela': ['RevisÃ£o', 'CombinaÃ§Ãµes', 'CenÃ¡rios RealÃ­sticos', 'Defesas Complexas', 'Condicionamento'],
                    'laranja': ['TÃ©cnicas AvanÃ§adas', 'MÃºltiplos Atacantes', 'Armas Brancas', 'SituaÃ§Ãµes Extremas', 'LideranÃ§a']
                }
            };
            
            const totalLessons = parseInt(formData.totalLessons);
            const modules = baseStructure[formData.martialArt]?.[formData.courseLevel] || 
                           ['MÃ³dulo 1', 'MÃ³dulo 2', 'MÃ³dulo 3', 'MÃ³dulo 4', 'MÃ³dulo 5'];
            
            const lessons = [];
            const lessonsPerModule = Math.floor(totalLessons / modules.length);
            
            modules.forEach((module, moduleIndex) => {
                for (let i = 0; i < lessonsPerModule; i++) {
                    const lessonNumber = moduleIndex * lessonsPerModule + i + 1;
                    lessons.push({
                        number: lessonNumber,
                        module: module,
                        title: `${module} - Aula ${i + 1}`,
                        objectives: [`Objetivo especÃ­fico da aula ${lessonNumber}`],
                        techniques: [`TÃ©cnica ${lessonNumber}A`, `TÃ©cnica ${lessonNumber}B`],
                        duration: parseInt(formData.lessonDuration)
                    });
                }
            });
            
            return lessons;
        }

        function generateTechniquesFromRAG(formData) {
            // RAG-based technique generation (simulated)
            const baseTechniques = {
                'krav-maga': {
                    'branca': ['Guarda de Boxe', 'Jab', 'Cross', 'Joelhada Frontal', 'Chute Frontal', 'Defesa 360Â°'],
                    'amarela': ['Hook', 'Uppercut', 'CombinaÃ§Ã£o Jab-Cross', 'Defesa Dupla', 'Contra-ataque'],
                    'laranja': ['TÃ©cnicas de Solo', 'Defesa vs Faca', 'Defesa vs BastÃ£o', 'MÃºltiplos Atacantes']
                }
            };
            
            return baseTechniques[formData.martialArt]?.[formData.courseLevel] || 
                   ['TÃ©cnica 1', 'TÃ©cnica 2', 'TÃ©cnica 3', 'TÃ©cnica 4', 'TÃ©cnica 5'];
        }

        function addNewCourseToInterface(course) {
            // Update courses count in header
            const coursesCount = document.getElementById('totalCoursesCount');
            if (coursesCount) {
                const currentCount = parseInt(coursesCount.textContent) || 0;
                coursesCount.textContent = currentCount + 1;
            }
            
            // Add to course selector
            const courseSelector = document.getElementById('courseSelector');
            if (courseSelector) {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.name;
                courseSelector.appendChild(option);
            }
            
            // Store in local storage (simulate backend)
            const existingCourses = JSON.parse(localStorage.getItem('generatedCourses') || '[]');
            existingCourses.push(course);
            localStorage.setItem('generatedCourses', JSON.stringify(existingCourses));
            
            console.log('Course added to interface:', course);
        }

        function useExistingTemplate() {
            const templates = [
                'Krav Maga Faixa Branca - Defesa Pessoal 1',
                'Krav Maga Faixa Amarela - Defesa Pessoal 2',
                'Jiu-Jitsu Fundamentos - Faixa Branca',
                'Boxe Iniciante - TÃ©cnicas BÃ¡sicas'
            ];
            
            const selectedTemplate = prompt('Escolha um template:\n' + 
                templates.map((t, i) => `${i + 1}. ${t}`).join('\n'));
            
            if (selectedTemplate && selectedTemplate > 0 && selectedTemplate <= templates.length) {
                const template = templates[selectedTemplate - 1];
                showToast(`ðŸ“‹ Template "${template}" carregado!`, 'info');
                
                // Auto-fill form with template data (simplified)
                if (template.includes('Krav Maga Faixa Branca')) {
                    document.getElementById('martialArtSelect').value = 'krav-maga';
                    document.getElementById('courseLevelSelect').value = 'branca';
                    document.getElementById('courseName').value = template;
                    document.getElementById('targetAudienceSelect').value = 'adultos';
                    document.getElementById('courseObjectives').value = 'Desenvolver defesa pessoal, melhorar condicionamento fÃ­sico, construir autoconfianÃ§a';
                }
            }
        }

        function previewCourse() {
            // Collect current form data
            const formData = {
                name: document.getElementById('courseName').value || 'Novo Curso',
                martialArt: document.getElementById('martialArtSelect').value || 'NÃ£o especificado',
                level: document.getElementById('courseLevelSelect').value || 'NÃ£o especificado',
                duration: document.getElementById('courseDuration').value || '0',
                totalLessons: document.getElementById('totalLessons').value || '0'
            };
            
            const previewContent = `
ðŸ“š PREVIEW DO CURSO

ðŸ¥‹ Nome: ${formData.name}
ðŸŽ¯ Arte Marcial: ${formData.martialArt}
ðŸŽ–ï¸ NÃ­vel: ${formData.level}
â±ï¸ DuraÃ§Ã£o: ${formData.duration} semanas
ðŸ“– Total de Aulas: ${formData.totalLessons}

ðŸ§  GeraÃ§Ã£o com RAG:
â€¢ Base de conhecimento: Agenda + Plano Faixa Branca
â€¢ IA adaptarÃ¡ metodologia para seus parÃ¢metros
â€¢ Estrutura pedagÃ³gica comprovada
â€¢ AdaptaÃ§Ãµes automÃ¡ticas por pÃºblico-alvo

ðŸ’¡ PrÃ³ximos passos:
1. Complete todos os campos
2. Clique em "Gerar com IA + RAG"
3. Aguarde processamento (3-5s)
4. Curso serÃ¡ adicionado Ã  biblioteca
            `;
            
            alert(previewContent);
        }

        // Edit existing course template
        function editCourseTemplate(courseId) {
            showToast('ðŸš§ FunÃ§Ã£o em desenvolvimento: Editar Template de Curso\n\nPermitirÃ¡:\nâ€¢ Modificar estrutura do curso\nâ€¢ Alterar sequÃªncia de tÃ©cnicas\nâ€¢ Adaptar planos de aula\nâ€¢ Personalizar avaliaÃ§Ãµes', 'info');
        }

        // Duplicate existing course
        function duplicateCourse() {
            const selectedCourse = document.getElementById('courseSelector').value;
            const courseName = document.getElementById('courseSelector').selectedOptions[0].text;
            
            const newCourseName = prompt(`Digite o nome para o curso duplicado:\n\nOriginal: ${courseName}`, `${courseName} - CÃ³pia`);
            
            if (newCourseName && newCourseName.trim()) {
                showToast(`ðŸ“‹ Curso "${newCourseName}" duplicado com sucesso!\n\nAgora vocÃª pode editÃ¡-lo independentemente.`, 'success');
                
                // Add the duplicated course to selector
                const courseSelector = document.getElementById('courseSelector');
                const option = document.createElement('option');
                option.value = `curso-${Date.now()}`;
                option.textContent = newCourseName.trim();
                courseSelector.appendChild(option);
                courseSelector.value = option.value;
                
                // Update courses count
                const coursesCount = document.getElementById('totalCoursesCount');
                if (coursesCount) {
                    const currentCount = parseInt(coursesCount.textContent) || 0;
                    coursesCount.textContent = currentCount + 1;
                }
            }
        }

        // ==========================================
        // STUDENT EDIT PAGE (DEDICATED) FUNCTIONS
        // ==========================================
        // (Function moved to top of file for proper scope)

        function saveStudentEdit(studentId) {
            const firstName = document.getElementById('editFirstName').value;
            const lastName = document.getElementById('editLastName').value;
            const email = document.getElementById('editEmail').value;
            const phone = document.getElementById('editPhone').value;
            const cpf = document.getElementById('editCpf').value;
            
            const updateData = {
                firstName,
                lastName,
                email,
                phone,
                cpf
            };
            
            fetch(`/api/students/${studentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('âœ… Aluno atualizado com sucesso!', 'success');
                    closeEditToast();
                    // Reload students data
                    if (typeof loadStudents === 'function') {
                        loadStudents();
                    } else {
                        loadData(); // fallback
                    }
                } else {
                    showToast('âŒ Erro ao atualizar aluno: ' + (data.message || 'Erro desconhecido'), 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao atualizar aluno:', error);
                showToast('âŒ Erro ao atualizar aluno: ' + error.message, 'error');
            });
        }

        function showCustomToast(content, type = 'info', duration = 3000) {
            const existingToast = document.querySelector('.custom-toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.innerHTML = content;
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 10000;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                border: 1px solid #374151;
                animation: slideIn 0.3s ease-out;
            `;

            document.body.appendChild(toast);

            if (duration > 0) {
                setTimeout(() => {
                    if (toast && toast.parentNode) {
                        toast.remove();
                    }
                }, duration);
            }
        }

        function closeEditToast() {
            const toast = document.querySelector('.custom-toast');
            if (toast) {
                toast.remove();
            }
        }

        // OLD COMPLEX FUNCTION BELOW - REPLACED WITH SIMPLE VERSION ABOVE
        async function openStudentEditPage_OLD(studentId) {
            try {
                console.log('ðŸ”„ Abrindo pÃ¡gina de ediÃ§Ã£o do aluno:', studentId);
                currentEditingStudentId = studentId;

                // Fetch student data
                const response = await fetch(`/api/students`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Erro ao carregar dados do estudante');
                }
                
                // Find the specific student
                const student = data.data.find(s => s.id === studentId);
                if (!student) {
                    throw new Error('Estudante nÃ£o encontrado');
                }

                currentEditingStudent = student;
                
                // Hide students list and show edit page
                document.getElementById('students').style.display = 'none';
                document.getElementById('student-edit-page').style.display = 'block';
                
                // Update page header with student info
                updateEditPageHeader(student);
                
                // Load the edit form
                loadEditPageForm(student);
                
                // Update sidebar with student stats
                updateEditPageSidebar(student);
                
                // Set active tab to edit
                switchPageTab('edit');
                
                console.log('âœ… PÃ¡gina de ediÃ§Ã£o carregada com sucesso');
                
            } catch (error) {
                console.error('âŒ Erro ao abrir pÃ¡gina de ediÃ§Ã£o:', error);
                showNotification(`Erro: ${error.message}`, 'error');
            }
        }


        // Load overview tab content
        function loadOverviewTabContent() {
            const overviewTab = document.getElementById('page-tab-overview');
            const student = currentEditingStudent;
            const user = student.user || {};

            overviewTab.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="color: #F8FAFC; margin: 0 0 1rem 0;">ðŸ‘¤ Dados Pessoais</h4>
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem; border: 1px solid #334155;">
                            <div style="margin-bottom: 0.75rem;">
                                <div style="color: #94A3B8; font-size: 0.875rem;">Nome Completo</div>
                                <div style="color: #F8FAFC; font-weight: 600;">${user.firstName || ''} ${user.lastName || ''}</div>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <div style="color: #94A3B8; font-size: 0.875rem;">Email</div>
                                <div style="color: #F8FAFC;">${user.email || 'NÃ£o informado'}</div>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <div style="color: #94A3B8; font-size: 0.875rem;">Telefone</div>
                                <div style="color: #F8FAFC;">${user.phone || 'NÃ£o informado'}</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #F8FAFC; margin: 0 0 1rem 0;">ðŸ¥‹ Dados AcadÃªmicos</h4>
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem; border: 1px solid #334155;">
                            <div style="margin-bottom: 0.75rem;">
                                <div style="color: #94A3B8; font-size: 0.875rem;">Categoria</div>
                                <div style="color: #F8FAFC; font-weight: 600;">${student.category || 'N/A'}</div>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <div style="color: #94A3B8; font-size: 0.875rem;">NÃ­vel</div>
                                <div style="color: #F8FAFC;">NÃ­vel ${student.globalLevel || '1'}</div>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <div style="color: #94A3B8; font-size: 0.875rem;">XP Total</div>
                                <div style="color: #F8FAFC;">${student.totalXP || '0'} pontos</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Progress tab with detailed content
        function loadProgressTabContent() {
            const progressTab = document.getElementById('progressContent');
            progressTab.innerHTML = `
                <!-- Overall Progress -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #10B981; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        ðŸ“Š Progresso Geral
                        <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                            EM ALTA
                        </div>
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                        <div style="text-align: center;">
                            <div style="position: relative; display: inline-block; margin-bottom: 1rem;">
                                <svg width="140" height="140" viewBox="0 0 140 140">
                                    <circle cx="70" cy="70" r="60" fill="none" stroke="#334155" stroke-width="12"/>
                                    <circle cx="70" cy="70" r="60" fill="none" stroke="#10B981" stroke-width="12"
                                            stroke-dasharray="377" stroke-dashoffset="260" stroke-linecap="round"
                                            transform="rotate(-90 70 70)"/>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                    <div style="color: #10B981; font-size: 1.75rem; font-weight: bold;">31%</div>
                                    <div style="color: #94A3B8; font-size: 0.8rem;">COMPLETO</div>
                                </div>
                            </div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">Aula 15 de 48</div>
                        </div>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1;">FrequÃªncia mÃ©dia:</span>
                                <span style="color: #10B981; font-weight: 600;">95%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1;">TÃ©cnicas dominadas:</span>
                                <span style="color: #F8FAFC; font-weight: 600;">13 de 42</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1;">XP total acumulado:</span>
                                <span style="color: #8B5CF6; font-weight: 600;">1,250 XP</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1;">Ranking na turma:</span>
                                <span style="color: #F59E0B; font-weight: 600;">3Âº de 15</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1;">Tempo atÃ© prÃ³xima faixa:</span>
                                <span style="color: #3B82F6; font-weight: 600;">~8 semanas</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TÃ©cnicas por Categoria -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">ðŸ¥‹ Progresso por Categoria de TÃ©cnica</h4>
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem; border: 1px solid #475569;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: #F8FAFC; font-weight: 600;">ðŸ‘Š Golpes BÃ¡sicos</span>
                                <span style="color: #10B981;">85%</span>
                            </div>
                            <div style="background: #1E293B; border-radius: 4px; height: 6px; width: 100%; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #10B981, #059669); height: 100%; width: 85%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="color: #94A3B8; font-size: 0.75rem; margin-top: 0.25rem;">Socos, chutes, cotoveladas â€¢ 6 de 7 tÃ©cnicas</div>
                        </div>
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem; border: 1px solid #475569;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: #F8FAFC; font-weight: 600;">ðŸ›¡ï¸ Defesas BÃ¡sicas</span>
                                <span style="color: #F59E0B;">65%</span>
                            </div>
                            <div style="background: #1E293B; border-radius: 4px; height: 6px; width: 100%; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #F59E0B, #D97706); height: 100%; width: 65%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="color: #94A3B8; font-size: 0.75rem; margin-top: 0.25rem;">Bloqueios, esquivas â€¢ 4 de 6 tÃ©cnicas</div>
                        </div>
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem; border: 1px solid #475569;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: #F8FAFC; font-weight: 600;">ðŸ¤¸ MovimentaÃ§Ã£o</span>
                                <span style="color: #10B981;">90%</span>
                            </div>
                            <div style="background: #1E293B; border-radius: 4px; height: 6px; width: 100%; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #10B981, #059669); height: 100%; width: 90%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="color: #94A3B8; font-size: 0.75rem; margin-top: 0.25rem;">Postura, deslocamento â€¢ 3 de 3 tÃ©cnicas</div>
                        </div>
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem; border: 1px solid #475569;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: #F8FAFC; font-weight: 600;">âš”ï¸ TÃ©cnicas AvanÃ§adas</span>
                                <span style="color: #64748B;">0%</span>
                            </div>
                            <div style="background: #1E293B; border-radius: 4px; height: 6px; width: 100%; overflow: hidden;">
                                <div style="background: #64748B; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="color: #94A3B8; font-size: 0.75rem; margin-top: 0.25rem;">NÃ£o iniciado â€¢ 0 de 26 tÃ©cnicas</div>
                        </div>
                    </div>
                </div>

                <!-- EvoluÃ§Ã£o Temporal -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #8B5CF6; margin: 0 0 1rem 0;">ðŸ“ˆ EvoluÃ§Ã£o nas Ãšltimas Semanas</h4>
                    <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.5rem; align-items: end; height: 120px; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px; border: 1px solid #475569;">
                        <div style="text-align: center;">
                            <div style="background: #10B981; height: 60px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S1</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #10B981; height: 75px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S2</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #F59E0B; height: 45px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S3</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #10B981; height: 85px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S4</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #10B981; height: 90px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S5</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #3B82F6; height: 70px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S6</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #10B981; height: 95px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S7</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #8B5CF6; height: 100px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S8</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; background: #10B981; border-radius: 2px;"></div>
                            <span style="color: #CBD5E1; font-size: 0.875rem;">Excelente (90%+)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; background: #3B82F6; border-radius: 2px;"></div>
                            <span style="color: #CBD5E1; font-size: 0.875rem;">Bom (70-89%)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; background: #F59E0B; border-radius: 2px;"></div>
                            <span style="color: #CBD5E1; font-size: 0.875rem;">Regular (50-69%)</span>
                        </div>
                    </div>
                </div>

                <!-- Achievements -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                    <h4 style="color: #F59E0B; margin: 0 0 1rem 0;">ðŸ† Conquistas e Badges</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸŽ¯</div>
                            <div style="color: #10B981; font-weight: 600; font-size: 0.875rem;">FrequÃªncia Exemplar</div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">95% nas Ãºltimas 4 semanas</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ”¥</div>
                            <div style="color: #8B5CF6; font-weight: 600; font-size: 0.875rem;">SequÃªncia de Ouro</div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">7 aulas consecutivas</div>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">âš¡</div>
                            <div style="color: #F59E0B; font-weight: 600; font-size: 0.875rem;">Progresso RÃ¡pido</div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">31% em 6 semanas</div>
                        </div>
                        <div style="background: rgba(71, 85, 105, 0.1); border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid rgba(71, 85, 105, 0.2); opacity: 0.6;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ¥‹</div>
                            <div style="color: #94A3B8; font-weight: 600; font-size: 0.875rem;">Primeiro Sparring</div>
                            <div style="color: #64748B; font-size: 0.75rem;">Em breve</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== NOVAS FUNÃ‡Ã•ES DAS ABAS =====

        // AI Dashboard Tab
        function loadAIDashboardContent() {
            const aiTab = document.getElementById('aiDashboardContent');
            aiTab.innerHTML = `
                <!-- AI Dashboard Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <!-- Performance Score -->
                    <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                        <h4 style="color: #10B981; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            ðŸŽ¯ Score de Performance IA
                        </h4>
                        <div style="text-align: center;">
                            <div style="position: relative; display: inline-block;">
                                <svg width="120" height="120" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" fill="none" stroke="#334155" stroke-width="8"/>
                                    <circle cx="60" cy="60" r="54" fill="none" stroke="#10B981" stroke-width="8"
                                            stroke-dasharray="339" stroke-dashoffset="82" stroke-linecap="round"
                                            transform="rotate(-90 60 60)"/>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                    <div style="color: #10B981; font-size: 1.5rem; font-weight: bold;">87%</div>
                                    <div style="color: #94A3B8; font-size: 0.7rem;">EXCELENTE</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; color: #94A3B8; font-size: 0.875rem; text-align: center;">
                            Baseado em frequÃªncia, evoluÃ§Ã£o tÃ©cnica e engajamento
                        </div>
                    </div>

                    <!-- Risk Assessment -->
                    <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                        <h4 style="color: #F59E0B; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            âš ï¸ AnÃ¡lise de Risco
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1; font-size: 0.875rem;">Risco de Abandono</span>
                                <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                                    BAIXO (15%)
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1; font-size: 0.875rem;">Pontualidade</span>
                                <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                                    Ã“TIMA
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1; font-size: 0.875rem;">EvoluÃ§Ã£o TÃ©cnica</span>
                                <div style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; border: 1px solid rgba(245, 158, 11, 0.3);">
                                    ACIMA DA MÃ‰DIA
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #8B5CF6; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        ðŸ§  Insights IA Personalizados
                    </h4>
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="color: #C4B5FD; font-weight: 600; margin-bottom: 0.5rem;">âœ¨ Pontos Fortes</div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">
                                â€¢ Excelente frequÃªncia (95% nas Ãºltimas 4 semanas)<br>
                                â€¢ EvoluÃ§Ã£o consistente em tÃ©cnicas de defesa<br>
                                â€¢ Alta motivaÃ§Ã£o em treinamentos de sparring
                            </div>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <div style="color: #FCD34D; font-weight: 600; margin-bottom: 0.5rem;">ðŸ’¡ Oportunidades</div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">
                                â€¢ Focar em tÃ©cnicas de ground fighting (score atual: 65%)<br>
                                â€¢ Participar mais dos desafios semanais<br>
                                â€¢ Considerar treinamento adicional de flexibilidade
                            </div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div style="color: #6EE7B7; font-weight: 600; margin-bottom: 0.5rem;">ðŸŽ¯ RecomendaÃ§Ã£o IA</div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">
                                Aluno modelo com evoluÃ§Ã£o exemplar. SugestÃ£o: promover para instrutor assistente voluntÃ¡rio para motivar outros alunos iniciantes.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Prediction -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                    <h4 style="color: #3B82F6; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        ðŸ“ˆ PrediÃ§Ãµes e TendÃªncias
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="color: #60A5FA; font-size: 1.25rem; font-weight: bold;">92%</div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">Chance de completar faixa</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div style="color: #34D399; font-size: 1.25rem; font-weight: bold;">4.8</div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">Score satisfaÃ§Ã£o (IA)</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <div style="color: #FBBF24; font-size: 1.25rem; font-weight: bold;">8 sem</div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">Tempo para prÃ³xima faixa</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // FunÃ§Ã£o removida - agora usando loadPlansTabContent do students.js

        // Function to update sidebar financial status
        function updateSidebarFinancialStatus(hasActiveSubscription, currentPlan) {
            console.log('ðŸ”„ updateSidebarFinancialStatus called:', { 
                hasActiveSubscription, 
                planName: currentPlan?.name,
                planObject: currentPlan 
            });
            const sidebarFinancial = document.getElementById('sidebarFinancialStatus');
            if (!sidebarFinancial) {
                console.error('âŒ Elemento sidebarFinancialStatus nÃ£o encontrado');
                return;
            }
            
            if (hasActiveSubscription && currentPlan) {
                const planName = currentPlan.name || currentPlan.title || 'Plano sem nome';
                const planPrice = currentPlan.price || currentPlan.amount || '0';
                const billingType = currentPlan.billingType || currentPlan.billingCycle || '';
                
                sidebarFinancial.innerHTML = `
                    <div style="color: #10B981; font-weight: bold; margin-bottom: 0.5rem;">âœ… Plano Ativo</div>
                    <div style="color: #CBD5E1; font-size: 0.875rem;">R$ ${planPrice}${billingType === 'MONTHLY' ? '/mÃªs' : billingType === 'YEARLY' ? '/ano' : ''}</div>
                    <div style="color: #94A3B8; font-size: 0.75rem; margin-top: 0.25rem;">${planName}</div>
                `;
                console.log('âœ… Sidebar atualizado com plano:', planName);
                sidebarFinancial.style.background = 'rgba(16, 185, 129, 0.1)';
                sidebarFinancial.style.borderColor = 'rgba(16, 185, 129, 0.3)';
            } else {
                sidebarFinancial.innerHTML = `
                    <div style="color: #F59E0B; font-weight: bold; margin-bottom: 0.5rem;">âš ï¸ Sem Plano</div>
                    <div style="color: #CBD5E1; font-size: 0.875rem;">Atribuir plano de pagamento</div>
                    <div style="color: #94A3B8; font-size: 0.75rem; margin-top: 0.25rem;">Acesso limitado</div>
                `;
                sidebarFinancial.style.background = 'rgba(245, 158, 11, 0.1)';
                sidebarFinancial.style.borderColor = 'rgba(245, 158, 11, 0.3)';
            }
        }

        // Function to assign a plan to the current student
        async function assignPlanToStudent(planId) {
            const studentId = window.getCurrentEditingStudentId ? window.getCurrentEditingStudentId() : currentEditingStudentId;
            if (!studentId) {
                showToast('Erro: ID do aluno nÃ£o encontrado', 'error');
                return;
            }
            
            try {
                showToast('â³ Atribuindo plano e inscrevendo em cursos...', 'info');
                
                let success = false;
                let responseData = null;
                let lastError = null;
                
                // Try new auto-enrollment route first
                try {
                    console.log('ðŸ”„ Tentando rota com inscriÃ§Ã£o automÃ¡tica...');
                    const response = await fetch(`/api/students/${currentEditingStudentId}/assign-plan-with-courses`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            planId: planId
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            success = true;
                            responseData = data;
                            console.log('âœ… Rota com inscriÃ§Ã£o automÃ¡tica funcionou:', data);
                            
                            // Show detailed success message with enrollment info
                            const summary = data.data.autoEnrollmentSummary;
                            if (summary.coursesEnrolled > 0 || summary.classesAssigned > 0) {
                                showToast(`âœ… Plano "${summary.planAssigned}" atribuÃ­do!\nðŸ“š ${summary.coursesEnrolled} curso(s) inscrito(s)\nðŸ• ${summary.classesAssigned} turma(s) atribuÃ­da(s)`, 'success');
                            } else {
                                showToast(`âœ… Plano "${summary.planAssigned}" atribuÃ­do com sucesso!`, 'success');
                            }
                        }
                    } else {
                        const errorData = await response.json();
                        lastError = errorData.error || errorData.message || `HTTP ${response.status}`;
                        console.log('âš ï¸ Rota com inscriÃ§Ã£o automÃ¡tica falhou:', lastError);
                    }
                } catch (error) {
                    lastError = error.message;
                    console.log('âš ï¸ Erro na rota com inscriÃ§Ã£o automÃ¡tica:', error.message);
                }
                
                // Fallback to financial route if auto-enrollment failed
                if (!success) {
                    try {
                        console.log('ðŸ”„ Tentando rota financeira como fallback...');
                        const response = await fetch('/api/financial/subscriptions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                studentId: currentEditingStudentId,
                                planId: planId,
                                startDate: new Date().toISOString()
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                success = true;
                                responseData = data;
                                console.log('âœ… Rota financeira funcionou:', data);
                                showToast('âœ… Plano atribuÃ­do (sem inscriÃ§Ã£o automÃ¡tica)', 'success');
                            }
                        } else {
                            const errorData = await response.json();
                            lastError = errorData.error || errorData.message || `HTTP ${response.status}`;
                            console.log('âš ï¸ Rota financeira falhou:', lastError);
                        }
                    } catch (error) {
                        lastError = error.message;
                        console.log('âš ï¸ Erro na rota financeira:', error.message);
                    }
                }
                
                // Final fallback to student subscription route
                if (!success) {
                    try {
                        console.log('ðŸ”„ Tentando rota alternativa de subscription...');
                        const response = await fetch(`/api/students/${currentEditingStudentId}/subscription`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                planId: planId,
                                startDate: new Date().toISOString()
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                success = true;
                                responseData = data;
                                console.log('âœ… Rota alternativa funcionou:', data);
                                showToast('âœ… Plano atribuÃ­do (mÃ©todo alternativo)', 'success');
                            }
                        } else {
                            const errorData = await response.json();
                            lastError = errorData.error || errorData.message || `HTTP ${response.status}`;
                            console.log('âš ï¸ Rota alternativa falhou:', lastError);
                        }
                    } catch (error) {
                        lastError = error.message;
                        console.log('âš ï¸ Erro na rota alternativa:', error.message);
                    }
                }
                
                // Handle the result
                if (success) {
                    showToast('âœ… Plano atribuÃ­do com sucesso!', 'success');
                    
                    // Enhanced reload with immediate visual feedback
                    showToast('ðŸ”„ Atualizando interface...', 'info');
                    
                    setTimeout(async () => {
                        console.log('ðŸ”„ [UX] Recarregando apÃ³s atribuiÃ§Ã£o de plano...');
                        
                        try {
                            // Multiple verification attempts for robustness
                            let verificationSuccess = false;
                            for (let i = 0; i < 3; i++) {
                                const checkResponse = await fetch(`/api/students/${currentEditingStudentId}/subscription?_=${Date.now()}`);
                                const checkData = await checkResponse.json();
                                console.log(`ðŸ” [UX] Verification attempt ${i + 1}:`, checkData);
                                
                                if (checkData.success && checkData.data && checkData.data.plan) {
                                    verificationSuccess = true;
                                    console.log('âœ… [UX] Plan verification successful!');
                                    break;
                                }
                                
                                // Wait before next attempt
                                if (i < 2) await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                            
                            // Force UI reload
                            await Promise.all([
                                loadPlansTabContent(currentEditingStudentId),
                                loadStudentFinancialTab()
                            ]);
                            
                            if (verificationSuccess) {
                                showToast('âœ… Plano atualizado com sucesso!', 'success');
                            } else {
                                showToast('âš ï¸ Plano atribuÃ­do, recarregue a pÃ¡gina se nÃ£o aparecer', 'warning');
                            }
                            
                        } catch (error) {
                            console.error('âŒ [UX] Error during reload:', error);
                            showToast('âŒ Erro ao atualizar interface', 'error');
                        }
                    }, 800);
                    
                } else {
                    // Show error message - no more fallback
                    const errorMessage = lastError || 'Erro desconhecido';
                    console.error('âŒ Todas as rotas falharam:', errorMessage);
                    showToast(`âŒ Erro ao atribuir plano: ${errorMessage}`, 'error');
                }
                
            } catch (error) {
                console.error('âŒ Erro geral:', error);
                showToast(`âŒ Erro inesperado: ${error.message}`, 'error');
            }
        }

        // Function to edit current student plan - Enhanced with full functionality
        async function editStudentPlan() {
            if (!currentEditingStudentId) {
                showToast('âŒ Erro: ID do aluno nÃ£o encontrado', 'error');
                return;
            }
            
            try {
                // Get current subscription and available plans
                showToast('ðŸ”„ Carregando dados para ediÃ§Ã£o...', 'info');
                
                const [subscriptionResponse, plansResponse] = await Promise.all([
                    fetch(`/api/students/${currentEditingStudentId}/subscription`),
                    fetch('/api/billing-plans')
                ]);
                
                const subscriptionData = await subscriptionResponse.json();
                const plansData = await plansResponse.json();
                
                if (!subscriptionData.success || !subscriptionData.data) {
                    showToast('âŒ Este aluno nÃ£o possui plano ativo para editar', 'error');
                    return;
                }
                
                const currentSubscription = subscriptionData.data;
                console.log('ðŸ” [DEBUG] currentSubscription in editStudentPlan:', currentSubscription);
                console.log('ðŸ” [DEBUG] currentSubscription.plan:', currentSubscription.plan);
                
                const currentPlan = currentSubscription.plan;
                if (!currentPlan) {
                    showToast('âŒ Dados do plano nÃ£o encontrados. Recarregue a pÃ¡gina e tente novamente.', 'error');
                    return;
                }
                
                const availablePlans = plansData.success ? plansData.data : [];
                
                // Create edit plan modal
                openEditPlanModal(currentSubscription, currentPlan, availablePlans);
                
            } catch (error) {
                console.error('Error opening plan editor:', error);
                showToast('âŒ Erro ao carregar dados para ediÃ§Ã£o', 'error');
            }
        }

        // Function to open edit plan modal with modern UI
        function openEditPlanModal(currentSubscription, currentPlan, availablePlans) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div class="edit-plan-modal" style="
                    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
                    border-radius: 20px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 90vh;
                    overflow-y: auto;
                    border: 1px solid #334155;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
                    transform: translateY(20px) scale(0.95);
                    transition: all 0.3s ease;
                ">
                    <!-- Header -->
                    <div style="padding: 2rem 2rem 1rem 2rem; border-bottom: 1px solid #334155;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="color: #F8FAFC; margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700;">âœï¸ Editar Plano</h2>
                                <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">Altere o plano de pagamento do aluno</p>
                            </div>
                            <button onclick="closeEditPlanModal()" style="
                                background: rgba(239, 68, 68, 0.1);
                                border: 1px solid rgba(239, 68, 68, 0.3);
                                color: #EF4444;
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 1.2rem;
                                transition: all 0.2s;
                            " onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'">
                                âœ•
                            </button>
                        </div>
                    </div>
                    
                    <!-- Current Plan Display -->
                    <div style="padding: 2rem;">
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05)); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #10B981; margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                                ðŸ“‹ Plano Atual
                                <span style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">ATIVO</span>
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">PLANO</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">${currentPlan.name}</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">VALOR</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">R$ ${parseFloat(currentPlan.price).toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">CATEGORIA</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">${currentPlan.category}</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">AULAS/SEMANA</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">${currentPlan.classesPerWeek || 'Ilimitado'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Plan Selection -->
                        <h3 style="color: #F8FAFC; margin: 0 0 1rem 0; font-size: 1.1rem;">ðŸ”„ Alterar para:</h3>
                        <div style="display: grid; gap: 1rem; max-height: 400px; overflow-y: auto; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 12px; border: 1px solid #334155;">
                            ${availablePlans.filter(plan => plan.id !== currentPlan.id && plan.isActive).map(plan => `
                                <div class="plan-option" data-plan-id="${plan.id}" style="
                                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(29, 78, 216, 0.05));
                                    border: 1px solid rgba(59, 130, 246, 0.2);
                                    border-radius: 12px;
                                    padding: 1.5rem;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    position: relative;
                                " onmouseover="this.style.borderColor='#3B82F6'; this.style.background='linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.1))'" onmouseout="this.style.borderColor='rgba(59, 130, 246, 0.2)'; this.style.background='linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(29, 78, 216, 0.05))'" onclick="selectNewPlan('${plan.id}', '${plan.name}', '${plan.price}', '${plan.category}')">
                                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: start;">
                                        <div>
                                            <h4 style="color: #3B82F6; margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 600;">${plan.name}</h4>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 0.75rem;">
                                                <div>
                                                    <span style="color: #94A3B8; font-size: 0.75rem;">CATEGORIA:</span>
                                                    <span style="color: #CBD5E1; font-size: 0.875rem; margin-left: 0.25rem;">${plan.category}</span>
                                                </div>
                                                <div>
                                                    <span style="color: #94A3B8; font-size: 0.75rem;">AULAS:</span>
                                                    <span style="color: #CBD5E1; font-size: 0.875rem; margin-left: 0.25rem;">${plan.classesPerWeek || 'Ilimitado'}/sem</span>
                                                </div>
                                                <div>
                                                    <span style="color: #94A3B8; font-size: 0.75rem;">TIPO:</span>
                                                    <span style="color: #CBD5E1; font-size: 0.875rem; margin-left: 0.25rem;">${plan.billingType === 'MONTHLY' ? 'Mensal' : plan.billingType}</span>
                                                </div>
                                            </div>
                                            ${plan.description ? `<p style="color: #94A3B8; font-size: 0.875rem; margin: 0; opacity: 0.8;">${plan.description}</p>` : ''}
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); border-radius: 12px; padding: 1rem; min-width: 100px;">
                                                <div style="color: white; font-size: 1.2rem; font-weight: bold; margin-bottom: 0.25rem;">R$ ${parseFloat(plan.price).toFixed(2)}</div>
                                                <div style="color: rgba(255, 255, 255, 0.8); font-size: 0.75rem;">${plan.billingType === 'MONTHLY' ? 'mensal' : 'total'}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: space-between;">
                            <!-- Remove Plan Button -->
                            <button onclick="console.log('ðŸ—‘ï¸ Remove button clicked!'); confirmRemovePlan()" style="
                                background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
                                border: 1px solid #EF4444;
                                color: #EF4444;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                                transition: all 0.2s;
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                            " onmouseover="this.style.background='linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1))'">
                                ðŸ—‘ï¸ Remover Plano
                            </button>
                            
                            <!-- Right side buttons -->
                            <div style="display: flex; gap: 1rem;">
                                <button onclick="closeEditPlanModal()" style="
                                    background: rgba(107, 114, 128, 0.1);
                                    border: 1px solid #6B7280;
                                    color: #9CA3AF;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='rgba(107, 114, 128, 0.2)'" onmouseout="this.style.background='rgba(107, 114, 128, 0.1)'">
                                    Cancelar
                                </button>
                                <button id="confirmPlanChangeBtn" onclick="console.log('âœï¸ Confirm change button clicked!'); confirmPlanChange()" disabled style="
                                    background: linear-gradient(135deg, #10B981, #059669);
                                    border: none;
                                    color: white;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: not-allowed;
                                    font-weight: 600;
                                    opacity: 0.5;
                                    transition: all 0.2s;
                                ">
                                    Confirmar AlteraÃ§Ã£o
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Animate modal in
            setTimeout(() => {
                modal.style.opacity = '1';
                const modalContent = modal.querySelector('.edit-plan-modal');
                modalContent.style.transform = 'translateY(0) scale(1)';
            }, 50);
            
            // Store current subscription for later use
            window.currentEditingSubscription = currentSubscription;
            window.selectedNewPlanId = null;
        }

        // Function to select a new plan
        function selectNewPlan(planId, planName, planPrice, planCategory) {
            console.log('ðŸŽ¯ [DEBUG] selectNewPlan called:', { planId, planName, planPrice, planCategory });
            
            // Clear previous selections
            document.querySelectorAll('.plan-option').forEach(option => {
                option.style.borderColor = 'rgba(59, 130, 246, 0.2)';
                option.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(29, 78, 216, 0.05))';
            });
            
            // Highlight selected plan
            const selectedOption = document.querySelector(`[data-plan-id="${planId}"]`);
            if (selectedOption) {
                selectedOption.style.borderColor = '#10B981';
                selectedOption.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1))';
                console.log('âœ… [DEBUG] Plan option highlighted');
            } else {
                console.error('âŒ [DEBUG] Plan option not found for planId:', planId);
            }
            
            // Enable confirm button
            const confirmBtn = document.getElementById('confirmPlanChangeBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.style.cursor = 'pointer';
                confirmBtn.style.opacity = '1';
                confirmBtn.innerHTML = `Alterar para ${planName} (R$ ${parseFloat(planPrice).toFixed(2)})`;
                console.log('âœ… [DEBUG] Confirm button enabled');
            } else {
                console.error('âŒ [DEBUG] Confirm button not found');
            }
            
            // Store selected plan
            window.selectedNewPlanId = planId;
            console.log('âœ… [DEBUG] Selected plan stored:', planId);
        }

        // Function to confirm plan change
        async function confirmPlanChange() {
            console.log('ðŸ”„ [DEBUG] confirmPlanChange called - START');
            console.log('ðŸ”„ [DEBUG] selectedNewPlanId:', window.selectedNewPlanId);
            console.log('ðŸ”„ [DEBUG] currentEditingSubscription:', window.currentEditingSubscription);
            console.log('ðŸ”„ [DEBUG] currentEditingStudentId:', currentEditingStudentId);
            
            if (!window.selectedNewPlanId || !window.currentEditingSubscription) {
                console.error('âŒ [DEBUG] Missing required data for plan change');
                showToast('âŒ Erro: Dados de alteraÃ§Ã£o nÃ£o encontrados', 'error');
                return;
            }
            
            try {
                showToast('ðŸ”„ Alterando plano...', 'info');
                
                // Disable button during processing
                const confirmBtn = document.getElementById('confirmPlanChangeBtn');
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = 'ðŸ”„ Processando...';
                }
                
                // Update subscription with new plan
                const response = await fetch(`/api/students/${currentEditingStudentId}/subscription`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        planId: window.selectedNewPlanId,
                        subscriptionId: window.currentEditingSubscription.id
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast('âœ… Plano alterado com sucesso!', 'success');
                    closeEditPlanModal();
                    
                    // Reload financial tab to show changes
                    setTimeout(() => {
                        loadStudentFinancialTab();
                        loadPlansTabContent(currentEditingStudentId);
                    }, 1000);
                    
                } else {
                    throw new Error(result.message || 'Erro ao alterar plano');
                }
                
            } catch (error) {
                console.error('Error changing plan:', error);
                showToast(`âŒ Erro ao alterar plano: ${error.message}`, 'error');
                
                // Re-enable button
                const confirmBtn = document.getElementById('confirmPlanChangeBtn');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = 'Confirmar AlteraÃ§Ã£o';
                }
            }
        }

        // Function to confirm plan removal
        async function confirmRemovePlanStandalone() {
            console.log('ðŸ”„ [DEBUG] confirmRemovePlanStandalone called - START');
            console.log('ðŸ”„ [DEBUG] currentEditingStudentId:', currentEditingStudentId);
            
            if (!currentEditingStudentId) {
                console.error('âŒ [DEBUG] Missing currentEditingStudentId for plan removal');
                showToast('âŒ Erro: Aluno nÃ£o identificado', 'error');
                return;
            }
            
            // Show confirmation dialog
            const confirmRemoval = confirm('âš ï¸ Tem certeza que deseja REMOVER o plano deste aluno?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita.');
            
            if (!confirmRemoval) {
                console.log('ðŸ”„ [DEBUG] Plan removal cancelled by user');
                return;
            }
            
            try {
                showToast('ðŸ”„ Removendo plano...', 'info');
                
                // Get current subscription to remove
                const subscriptionResponse = await fetch(`/api/students/${currentEditingStudentId}/subscription`);
                const subscriptionData = await subscriptionResponse.json();
                
                if (!subscriptionData.success || !subscriptionData.data) {
                    showToast('âŒ Erro: Plano nÃ£o encontrado', 'error');
                    return;
                }
                
                const subscriptionId = subscriptionData.data.id;
                
                // Remove subscription by setting status to CANCELLED
                const response = await fetch(`/api/students/${currentEditingStudentId}/subscription`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('âœ… [DEBUG] Plan removed successfully');
                    showToast('âœ… Plano removido com sucesso!', 'success');
                    
                    // Refresh the plan data
                    await forceRefreshPlanData();
                    
                    // Update UI to show no plan
                    updateSidebarFinancialStatus({
                        hasActiveSubscription: false,
                        planName: null,
                        planObject: null
                    });
                    
                } else {
                    throw new Error(result.message || 'Erro desconhecido');
                }
                
            } catch (error) {
                console.error('Error removing plan:', error);
                showToast(`âŒ Erro ao remover plano: ${error.message}`, 'error');
            }
        }

        // Function to close edit plan modal
        function closeEditPlanModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.style.opacity = '0';
                const modalContent = modal.querySelector('.edit-plan-modal');
                modalContent.style.transform = 'translateY(20px) scale(0.95)';
                
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
            
            // Clean up global variables
            window.currentEditingSubscription = null;
            window.selectedNewPlanId = null;
        }

        // Function to force refresh plan data - DEBUG
        async function forceRefreshPlanData() {
            console.log('ðŸ”„ [FORCE REFRESH] Recarregando dados do plano...');
            try {
                // Reload both plan sections
                await loadStudentCurrentPlan(currentEditingStudentId);
                await loadPlansTabContent(currentEditingStudentId);
                showToast('ðŸ”„ Dados recarregados', 'info');
            } catch (error) {
                console.error('âŒ [FORCE REFRESH] Erro:', error);
                showToast('âŒ Erro ao recarregar dados', 'error');
            }
        }

        // Function to view plan history
        function viewPlanHistory() {
            showToast('ðŸ“Š Funcionalidade de histÃ³rico serÃ¡ implementada em breve', 'info');
            console.log('ðŸ“Š Plan history requested for student:', currentEditingStudentId);
        }

        // ========== CLASSES/TURMAS FUNCTIONS ==========

        // Function to handle class transfer actions
        function transferClassActions() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div class="transfer-modal" style="
                    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
                    border-radius: 20px;
                    width: 90%;
                    max-width: 600px;
                    max-height: 90vh;
                    overflow-y: auto;
                    border: 1px solid #334155;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
                    transform: translateY(20px) scale(0.95);
                    transition: all 0.3s ease;
                ">
                    <!-- Header -->
                    <div style="padding: 2rem 2rem 1rem 2rem; border-bottom: 1px solid #334155;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="color: #F8FAFC; margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700;">ðŸ”„ Transferir de Turma</h2>
                                <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">Mover aluno para outra turma disponÃ­vel</p>
                            </div>
                            <button onclick="closeTransferModal()" style="
                                background: rgba(239, 68, 68, 0.1);
                                border: 1px solid rgba(239, 68, 68, 0.3);
                                color: #EF4444;
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 1.2rem;
                                transition: all 0.2s;
                            ">
                                âœ•
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding: 2rem;">
                        <!-- Current Class -->
                        <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #3B82F6; margin: 0 0 1rem 0; font-size: 1.1rem;">ðŸ“ Turma Atual</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem;">TURMA</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Turma 1 - ManhÃ£</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem;">HORÃRIO</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Ter/Qui 08:00</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem;">INSTRUTOR</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Prof. Silva</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Available Classes -->
                        <h3 style="color: #F8FAFC; margin: 0 0 1rem 0; font-size: 1.1rem;">ðŸŽ¯ Turmas DisponÃ­veis</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div class="transfer-option" onclick="selectTransferClass('class2')" style="
                                background: rgba(139, 92, 246, 0.05);
                                border: 1px solid rgba(139, 92, 246, 0.2);
                                border-radius: 12px;
                                padding: 1.5rem;
                                cursor: pointer;
                                transition: all 0.2s;
                            " onmouseover="this.style.borderColor='#8B5CF6'" onmouseout="this.style.borderColor='rgba(139, 92, 246, 0.2)'">
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center;">
                                    <div>
                                        <div style="color: #A855F7; font-weight: 600; margin-bottom: 0.5rem;">Turma 2 - Noite</div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem;">
                                            <div>
                                                <span style="color: #94A3B8; font-size: 0.75rem;">HORÃRIO:</span>
                                                <span style="color: #CBD5E1; font-size: 0.875rem; margin-left: 0.25rem;">Seg/Qua 19:00</span>
                                            </div>
                                            <div>
                                                <span style="color: #94A3B8; font-size: 0.75rem;">INSTRUTOR:</span>
                                                <span style="color: #CBD5E1; font-size: 0.875rem; margin-left: 0.25rem;">Prof. Costa</span>
                                            </div>
                                            <div>
                                                <span style="color: #94A3B8; font-size: 0.75rem;">VAGAS:</span>
                                                <span style="color: #10B981; font-size: 0.875rem; margin-left: 0.25rem;">8 livres</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="background: rgba(139, 92, 246, 0.1); color: #A855F7; padding: 0.75rem; border-radius: 8px; font-weight: 600;">
                                        ðŸ”„ Transferir
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                            <button onclick="closeTransferModal()" style="
                                background: rgba(107, 114, 128, 0.1);
                                border: 1px solid #6B7280;
                                color: #9CA3AF;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                                transition: all 0.2s;
                            ">
                                Cancelar
                            </button>
                            <button id="confirmTransferBtn" onclick="confirmClassTransfer()" disabled style="
                                background: linear-gradient(135deg, #3B82F6, #1D4ED8);
                                border: none;
                                color: white;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: not-allowed;
                                font-weight: 600;
                                opacity: 0.5;
                                transition: all 0.2s;
                            ">
                                Confirmar TransferÃªncia
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Animate modal in
            setTimeout(() => {
                modal.style.opacity = '1';
                const modalContent = modal.querySelector('.transfer-modal');
                modalContent.style.transform = 'translateY(0) scale(1)';
            }, 50);
        }

        // Function to close transfer modal
        function closeTransferModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.style.opacity = '0';
                const modalContent = modal.querySelector('.transfer-modal');
                modalContent.style.transform = 'translateY(20px) scale(0.95)';
                
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // Function to select transfer class
        function selectTransferClass(classId) {
            // Clear previous selections
            document.querySelectorAll('.transfer-option').forEach(option => {
                option.style.borderColor = 'rgba(139, 92, 246, 0.2)';
                option.style.background = 'rgba(139, 92, 246, 0.05)';
            });
            
            // Highlight selected option
            const selectedOption = document.querySelector(`[onclick="selectTransferClass('${classId}')"]`);
            if (selectedOption) {
                selectedOption.style.borderColor = '#10B981';
                selectedOption.style.background = 'rgba(16, 185, 129, 0.1)';
            }
            
            // Enable confirm button
            const confirmBtn = document.getElementById('confirmTransferBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.style.cursor = 'pointer';
                confirmBtn.style.opacity = '1';
            }
            
            // Store selected class
            window.selectedTransferClass = classId;
        }

        // Function to confirm class transfer
        function confirmClassTransfer() {
            if (!window.selectedTransferClass) {
                showToast('âŒ Selecione uma turma para transferir', 'error');
                return;
            }
            
            showToast('ðŸ”„ Transferindo aluno...', 'info');
            
            // Simulate transfer process
            setTimeout(() => {
                showToast('âœ… Aluno transferido com sucesso para Turma 2!', 'success');
                closeTransferModal();
                
                // Reload classes tab
                loadClassesTabContent();
            }, 2000);
        }

        // Function to handle pause class actions
        function pauseClassActions() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
                    border-radius: 20px;
                    width: 90%;
                    max-width: 500px;
                    border: 1px solid #334155;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
                    transform: translateY(20px) scale(0.95);
                    transition: all 0.3s ease;
                ">
                    <div style="padding: 2rem;">
                        <h2 style="color: #F59E0B; margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            â¸ï¸ Pausar Temporariamente
                        </h2>
                        <p style="color: #94A3B8; margin: 0 0 2rem 0; font-size: 0.875rem;">
                            Suspender temporariamente as aulas do aluno. Escolha o perÃ­odo de pausa:
                        </p>
                        
                        <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                            <div onclick="selectPausePeriod('1week')" class="pause-option" style="
                                background: rgba(245, 158, 11, 0.05);
                                border: 1px solid rgba(245, 158, 11, 0.2);
                                border-radius: 8px;
                                padding: 1rem;
                                cursor: pointer;
                                transition: all 0.2s;
                            ">
                                <div style="color: #F59E0B; font-weight: 600;">ðŸ“… 1 Semana</div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">Pausa atÃ© ${new Date(Date.now() + 7*24*60*60*1000).toLocaleDateString()}</div>
                            </div>
                            
                            <div onclick="selectPausePeriod('1month')" class="pause-option" style="
                                background: rgba(245, 158, 11, 0.05);
                                border: 1px solid rgba(245, 158, 11, 0.2);
                                border-radius: 8px;
                                padding: 1rem;
                                cursor: pointer;
                                transition: all 0.2s;
                            ">
                                <div style="color: #F59E0B; font-weight: 600;">ðŸ“… 1 MÃªs</div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">Pausa atÃ© ${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString()}</div>
                            </div>
                            
                            <div onclick="selectPausePeriod('custom')" class="pause-option" style="
                                background: rgba(245, 158, 11, 0.05);
                                border: 1px solid rgba(245, 158, 11, 0.2);
                                border-radius: 8px;
                                padding: 1rem;
                                cursor: pointer;
                                transition: all 0.2s;
                            ">
                                <div style="color: #F59E0B; font-weight: 600;">ðŸ“… Data Personalizada</div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">Escolher data especÃ­fica</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="closePauseModal()" style="
                                background: rgba(107, 114, 128, 0.1);
                                border: 1px solid #6B7280;
                                color: #9CA3AF;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                            ">
                                Cancelar
                            </button>
                            <button id="confirmPauseBtn" onclick="confirmPause()" disabled style="
                                background: linear-gradient(135deg, #F59E0B, #D97706);
                                border: none;
                                color: white;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: not-allowed;
                                font-weight: 600;
                                opacity: 0.5;
                            ">
                                Confirmar Pausa
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.querySelector('div').style.transform = 'translateY(0) scale(1)';
            }, 50);
        }

        // Function to close pause modal
        function closePauseModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // Function to select pause period
        function selectPausePeriod(period) {
            document.querySelectorAll('.pause-option').forEach(option => {
                option.style.borderColor = 'rgba(245, 158, 11, 0.2)';
                option.style.background = 'rgba(245, 158, 11, 0.05)';
            });
            
            event.target.closest('.pause-option').style.borderColor = '#10B981';
            event.target.closest('.pause-option').style.background = 'rgba(16, 185, 129, 0.1)';
            
            const confirmBtn = document.getElementById('confirmPauseBtn');
            confirmBtn.disabled = false;
            confirmBtn.style.cursor = 'pointer';
            confirmBtn.style.opacity = '1';
            
            window.selectedPausePeriod = period;
        }

        // Function to confirm pause
        function confirmPause() {
            if (!window.selectedPausePeriod) return;
            
            showToast('â¸ï¸ Pausando aulas do aluno...', 'info');
            
            setTimeout(() => {
                const periodText = window.selectedPausePeriod === '1week' ? '1 semana' : 
                                 window.selectedPausePeriod === '1month' ? '1 mÃªs' : 'perÃ­odo personalizado';
                showToast(`âœ… Aulas pausadas por ${periodText}`, 'success');
                closePauseModal();
            }, 1500);
        }

        // Function to handle add class actions
        function addClassActions() {
            showToast('âž• Adicionando turma extra...', 'info');
            
            setTimeout(() => {
                showToast('âœ… Turma extra adicionada! O aluno pode participar de aulas de reposiÃ§Ã£o.', 'success');
                
                // Reload classes tab to show changes
                loadClassesTabContent();
            }, 2000);
        }

        // Functions for Create Class Modal
        function closeCreateClassModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.style.opacity = '0';
                const modalContent = modal.querySelector('.create-class-modal');
                modalContent.style.transform = 'translateY(20px) scale(0.95)';
                
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        function submitCreateClass() {
            const form = document.getElementById('createClassForm');
            const formData = new FormData(form);
            
            // Validate required fields
            const courseSelect = document.getElementById('courseSelect');
            const className = document.getElementById('className');
            const classCapacity = document.getElementById('classCapacity');
            const startTime = document.getElementById('startTime');
            const classDuration = document.getElementById('classDuration');
            const instructorSelect = document.getElementById('instructorSelect');
            const startDate = document.getElementById('startDate');
            
            if (!courseSelect.value) {
                showToast('âŒ Selecione um curso base', 'error');
                courseSelect.focus();
                return;
            }
            
            if (!className.value.trim()) {
                showToast('âŒ Digite o nome da turma', 'error');
                className.focus();
                return;
            }
            
            if (!classCapacity.value || classCapacity.value < 5) {
                showToast('âŒ Capacidade mÃ­nima Ã© 5 alunos', 'error');
                classCapacity.focus();
                return;
            }
            
            if (!instructorSelect.value) {
                showToast('âŒ Selecione um instrutor', 'error');
                instructorSelect.focus();
                return;
            }
            
            if (!startDate.value) {
                showToast('âŒ Selecione a data de inÃ­cio', 'error');
                startDate.focus();
                return;
            }
            
            // Check if at least one day is selected
            const selectedDays = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            if (selectedDays.length === 0) {
                showToast('âŒ Selecione pelo menos um dia da semana', 'error');
                return;
            }
            
            // Collect all form data
            const classData = {
                course: courseSelect.value,
                name: className.value.trim(),
                capacity: parseInt(classCapacity.value),
                startTime: startTime.value,
                duration: parseInt(classDuration.value),
                instructor: instructorSelect.value,
                startDate: startDate.value,
                selectedDays: selectedDays,
                notes: document.getElementById('classNotes').value.trim()
            };
            
            // Show loading state
            const submitBtn = document.querySelector('button[onclick="submitCreateClass()"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'ðŸ”„ Criando...';
            submitBtn.disabled = true;
            
            showToast('ðŸ”„ Criando nova turma...', 'info');
            
            // Real API call
            fetch('/api/classes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(classData)
            })
            .then(response => response.json())
            .then(result => {
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                if (result.success) {
                    // Show success message
                    showToast(`âœ… Turma "${classData.name}" criada com sucesso!`, 'success');
                    
                    console.log('ðŸ“ Nova turma criada:', result.data);
                    
                    // Close modal
                    closeCreateClassModal();
                    
                    // Reload classes page if we're on it
                    if (window.location.hash === '#classes' || document.querySelector('.nav-item.active')?.textContent?.includes('Classes')) {
                        setTimeout(() => {
                            location.reload(); // Reload to show new class
                        }, 1000);
                    }
                } else {
                    throw new Error(result.message || 'Failed to create class');
                }
            })
            .catch(error => {
                console.error('âŒ Error creating class:', error);
                
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                // Show error message
                showToast(`âŒ Erro ao criar turma: ${error.message}`, 'error');
            });
        }

        // Function to assign plan when student has none
        function assignStudentPlan() {
            showToast('Selecione um plano disponÃ­vel abaixo para atribuir ao aluno', 'info');
        }

        // Classes Tab
        function loadClassesTabContent() {
            const classesTab = document.getElementById('classesContent');
            classesTab.innerHTML = `
                <!-- Current Classes -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #10B981; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        ðŸ• Turmas Ativas
                        <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                            2 TURMAS
                        </div>
                    </h4>
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div style="color: #60A5FA; font-weight: 600;">Turma 1 - ManhÃ£</div>
                                <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                                    PRINCIPAL
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.875rem;">HorÃ¡rio</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Ter/Qui 08:00</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.875rem;">Instrutor</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Prof. Silva</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.875rem;">Alunos</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">15/20</div>
                                </div>
                            </div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div style="color: #C4B5FD; font-weight: 600;">Turma 2 - Noite</div>
                                <div style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; border: 1px solid rgba(245, 158, 11, 0.3);">
                                    SECUNDÃRIA
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.875rem;">HorÃ¡rio</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Seg/Qua 19:00</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.875rem;">Instrutor</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Prof. Costa</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.875rem;">Alunos</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">12/20</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule View -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">ðŸ“… Cronograma Semanal</h4>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">DOM</div>
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">SEG</div>
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">TER</div>
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">QUA</div>
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">QUI</div>
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">SEX</div>
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">SÃB</div>
                        
                        <div style="text-align: center; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px;">-</div>
                        <div style="text-align: center; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="color: #C4B5FD; font-size: 0.75rem;">19:00</div>
                            <div style="color: #F8FAFC; font-size: 0.75rem; font-weight: 600;">T2</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="color: #60A5FA; font-size: 0.75rem;">08:00</div>
                            <div style="color: #F8FAFC; font-size: 0.75rem; font-weight: 600;">T1</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="color: #C4B5FD; font-size: 0.75rem;">19:00</div>
                            <div style="color: #F8FAFC; font-size: 0.75rem; font-weight: 600;">T2</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="color: #60A5FA; font-size: 0.75rem;">08:00</div>
                            <div style="color: #F8FAFC; font-size: 0.75rem; font-weight: 600;">T1</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px;">-</div>
                        <div style="text-align: center; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px;">-</div>
                    </div>
                </div>

                <!-- Class Actions -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                    <h4 style="color: #F59E0B; margin: 0 0 1rem 0;">âš¡ AÃ§Ãµes de Turma</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <button onclick="transferClassActions()" style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ðŸ”„ Transferir Turma
                        </button>
                        <button onclick="pauseClassActions()" style="background: rgba(245, 158, 11, 0.1); border: 1px solid #F59E0B; color: #F59E0B; padding: 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            â¸ï¸ Pausar Temporariamente
                        </button>
                        <button onclick="addClassActions()" style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10B981; color: #10B981; padding: 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            âž• Adicionar Turma Extra
                        </button>
                    </div>
                </div>
            `;
        }

        // Courses Tab
        function loadCoursesTabContent() {
            const coursesTab = document.getElementById('coursesContent');
            coursesTab.innerHTML = `
                <!-- Current Course -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #10B981; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        ðŸ“š Curso Atual
                        <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                            EM PROGRESSO
                        </div>
                    </h4>
                    <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1.5rem; border: 1px solid #475569;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h5 style="color: #F8FAFC; margin: 0; font-size: 1.125rem;">Krav Maga Faixa Branca - Defesa Pessoal 1</h5>
                            <div style="color: #10B981; font-weight: 600;">31% completo</div>
                        </div>
                        <div style="background: #1E293B; border-radius: 6px; height: 8px; width: 100%; overflow: hidden; margin-bottom: 1rem;">
                            <div style="background: linear-gradient(90deg, #10B981, #059669); height: 100%; width: 31%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">Aula Atual</div>
                                <div style="color: #F8FAFC; font-weight: 600;">15 de 48</div>
                            </div>
                            <div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">TÃ©cnicas Aprendidas</div>
                                <div style="color: #F8FAFC; font-weight: 600;">13 de 42</div>
                            </div>
                            <div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">InÃ­cio</div>
                                <div style="color: #F8FAFC; font-weight: 600;">01/06/2025</div>
                            </div>
                            <div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">PrevisÃ£o ConclusÃ£o</div>
                                <div style="color: #F8FAFC; font-weight: 600;">15/12/2025</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Course Modules -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">ðŸ“– MÃ³dulos do Curso</h4>
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="color: #6EE7B7; font-weight: 600;">âœ… MÃ³dulo 1: Fundamentos</div>
                                <div style="background: rgba(16, 185, 129, 0.2); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem;">
                                    COMPLETO
                                </div>
                            </div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">Postura, distÃ¢ncia, movimentaÃ§Ã£o bÃ¡sica â€¢ 8 aulas</div>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="color: #60A5FA; font-weight: 600;">ðŸ”„ MÃ³dulo 2: Golpes BÃ¡sicos</div>
                                <div style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem;">
                                    EM PROGRESSO
                                </div>
                            </div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">Socos, chutes, joelhadas e cotoveladas â€¢ 7 de 12 aulas</div>
                        </div>
                        <div style="background: rgba(71, 85, 105, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(71, 85, 105, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="color: #94A3B8; font-weight: 600;">â³ MÃ³dulo 3: Defesas BÃ¡sicas</div>
                                <div style="background: rgba(71, 85, 105, 0.2); color: #94A3B8; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem;">
                                    PENDENTE
                                </div>
                            </div>
                            <div style="color: #64748B; font-size: 0.875rem;">Defesas contra socos e agarrÃµes â€¢ 12 aulas</div>
                        </div>
                        <div style="background: rgba(71, 85, 105, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(71, 85, 105, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="color: #94A3B8; font-weight: 600;">â³ MÃ³dulo 4: TÃ©cnicas AvanÃ§adas</div>
                                <div style="background: rgba(71, 85, 105, 0.2); color: #94A3B8; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem;">
                                    PENDENTE
                                </div>
                            </div>
                            <div style="color: #64748B; font-size: 0.875rem;">Defesas no solo e mÃºltiplos atacantes â€¢ 10 aulas</div>
                        </div>
                        <div style="background: rgba(71, 85, 105, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(71, 85, 105, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="color: #94A3B8; font-weight: 600;">â³ MÃ³dulo 5: IntegraÃ§Ã£o e Sparring</div>
                                <div style="background: rgba(71, 85, 105, 0.2); color: #94A3B8; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem;">
                                    PENDENTE
                                </div>
                            </div>
                            <div style="color: #64748B; font-size: 0.875rem;">AplicaÃ§Ã£o prÃ¡tica e simulaÃ§Ãµes â€¢ 8 aulas</div>
                        </div>
                    </div>
                </div>

                <!-- Available Courses -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                    <h4 style="color: #F59E0B; margin: 0 0 1rem 0;">ðŸŽ¯ PrÃ³ximos Cursos DisponÃ­veis</h4>
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="color: #C4B5FD; font-weight: 600; margin-bottom: 0.5rem;">ðŸ¥‹ Krav Maga Faixa Amarela - Defesa Pessoal 2</div>
                            <div style="color: #CBD5E1; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                TÃ©cnicas avanÃ§adas, defesa contra armas brancas, mÃºltiplos atacantes
                            </div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">
                                Prerequisito: Completar Faixa Branca â€¢ DuraÃ§Ã£o: 6 meses
                            </div>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <div style="color: #FCD34D; font-weight: 600; margin-bottom: 0.5rem;">ðŸ† Curso de Instrutor Assistente</div>
                            <div style="color: #CBD5E1; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                Metodologia de ensino, gestÃ£o de turma, primeiros socorros
                            </div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">
                                Prerequisito: Faixa Amarela â€¢ DuraÃ§Ã£o: 3 meses
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Financial tab placeholder
        function loadFinancialTabContent() {
            const financialTab = document.getElementById('page-tab-financial');
            financialTab.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #94A3B8;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ’°</div>
                    <h3 style="color: #F8FAFC; margin-bottom: 0.5rem;">Financeiro em Desenvolvimento</h3>
                    <p>Esta funcionalidade serÃ¡ implementada em breve.</p>
                </div>
            `;
        }

        // Activity tab placeholder
        function loadActivityTabContent() {
            const activityTab = document.getElementById('page-tab-activity');
            activityTab.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #94A3B8;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“ˆ</div>
                    <h3 style="color: #F8FAFC; margin-bottom: 0.5rem;">Atividades em Desenvolvimento</h3>
                    <p>Esta funcionalidade serÃ¡ implementada em breve.</p>
                </div>
            `;
        }


        // Back to students list
        function backToStudentsList() {
            document.getElementById('student-edit-page').style.display = 'none';
            document.getElementById('students').style.display = 'block';
            
            currentEditingStudentId = null;
            currentEditingStudent = null;
        }

        // Cancel student edit
        function cancelStudentEdit() {
            if (confirm('Tem certeza que deseja cancelar? Todas as alteraÃ§Ãµes nÃ£o salvas serÃ£o perdidas.')) {
                backToStudentsList();
            }
        }

        // Save student from page
        async function saveStudentPage() {
            if (!currentEditingStudentId) {
                showNotification('Erro: ID do aluno nÃ£o encontrado', 'error');
                return;
            }

            const saveBtn = document.querySelector('button[onclick="saveStudentPage()"]');
            const originalText = saveBtn.innerHTML;
            
            try {
                // Show loading state
                saveBtn.innerHTML = 'â³ Salvando...';
                saveBtn.disabled = true;
                
                // Collect form data
                const formData = {
                    firstName: document.getElementById('pageFirstName').value.trim(),
                    lastName: document.getElementById('pageLastName').value.trim(),
                    email: document.getElementById('pageEmail').value.trim(),
                    phone: document.getElementById('pagePhone').value.trim(),
                    category: document.getElementById('pageCategory').value,
                    gender: document.getElementById('pageGender').value,
                    physicalCondition: document.getElementById('pagePhysicalCondition').value,
                    emergencyContact: document.getElementById('pageEmergencyContact').value.trim(),
                    medicalConditions: document.getElementById('pageMedicalConditions').value.trim(),
                    isActive: true
                };
                
                // Enhanced validation
                if (!formData.firstName || !formData.lastName || !formData.email) {
                    throw new Error('Nome, sobrenome e email sÃ£o obrigatÃ³rios');
                }
                
                if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
                    throw new Error('Email deve ter um formato vÃ¡lido');
                }
                
                console.log('ðŸ“¤ Enviando dados do estudante:', formData);
                
                // Update student via API
                const response = await fetch(`/api/students/${currentEditingStudentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || `Erro ${response.status}: ${response.statusText}`);
                }
                
                if (!result.success) {
                    throw new Error(result.message || 'Erro ao atualizar dados');
                }
                
                console.log('âœ… Estudante atualizado com sucesso:', result);
                
                // Show success feedback
                saveBtn.innerHTML = 'âœ… Salvo!';
                saveBtn.style.background = '#10B981';
                
                // Update header with new data
                updateEditPageHeader({
                    id: currentEditingStudentId,
                    category: formData.category,
                    user: {
                        firstName: formData.firstName,
                        lastName: formData.lastName
                    }
                });
                
                // Go back to students list after success
                setTimeout(() => {
                    backToStudentsList();
                    loadStudents(); // Reload students to show updated data
                    showNotification('Dados do aluno atualizados com sucesso! ðŸŽ‰', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('âŒ Erro ao salvar estudante:', error);
                
                // Show error feedback
                saveBtn.innerHTML = 'âŒ Erro';
                saveBtn.style.background = '#EF4444';
                
                showNotification(`Erro ao salvar: ${error.message}`, 'error');
                
                // Restore button after error
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }, 2000);
            }
        }

        // Quick actions from edit page
        function quickCheckinFromEdit() {
            showNotification('Check-in rÃ¡pido em desenvolvimento', 'info');
        }

        function viewStudentProgress() {
            switchPageTab('progress');
        }

        function managePayments() {
            switchPageTab('financial');
        }

        // Update the existing openStudentEdit function to use the dedicated page
        async function openStudentEdit(studentId) {
            console.log('âœï¸ Redirecionando para pÃ¡gina de ediÃ§Ã£o:', studentId);
            await openStudentEditPage(studentId);
        }

        // ==========================================
        // UNIFIED STUDENT INTERACTION SYSTEM
        // ==========================================

        // Central function for all student interactions
        function handleStudentInteraction(studentId, action, event = null) {
            switch (action) {
                case 'view':
                    openStudentDetails(studentId);
                    break;
                case 'edit':
                    openStudentEditPage(studentId);
                    break;
                case 'doubleclick':
                    if (event) {
                        handleStudentDoubleClick(event, studentId);
                    } else {
                        openStudentEditPage(studentId);
                    }
                    break;
                case 'checkin':
                    quickCheckin(studentId);
                    break;
                default:
                    console.warn('AÃ§Ã£o nÃ£o reconhecida:', action);
                    openStudentDetails(studentId);
            }
        }

        // Enhanced function to handle all edit actions consistently
        function openStudentEditAction(studentId) {
            console.log('ðŸŽ¯ AÃ§Ã£o unificada de ediÃ§Ã£o para aluno:', studentId);
            openStudentEditPage(studentId);
        }

        // ==========================================
        // CLEAN UX - SIMPLIFIED STUDENT INTERACTION
        // ==========================================

        // Unified clean function - ONE action for everything
        function openStudentEditor(studentId) {
            console.log('ðŸš€ UX Limpa: Abrindo editor de aluno:', studentId);
            showNotification('ðŸ“ Carregando editor...', 'info');
            openStudentEditPage(studentId);
        }

        // Redirect old functions to new clean UX
        function openStudentDetails(studentId) {
            console.log('ðŸ”„ Redirecionando visualizaÃ§Ã£o para ediÃ§Ã£o direta:', studentId);
            openStudentEditPage(studentId);
        }

        // Simplified student interaction - No more double click complexity
        function handleStudentClick(studentId) {
            console.log('ðŸŽ¯ UX Limpa: Abrindo editor direto para aluno:', studentId);
            showNotification('ðŸ“ Carregando editor de aluno...', 'info');
            openStudentEditPage(studentId);
        }

        // Add visual feedback for double click
        function addDoubleClickFeedback(event) {
            const card = event.currentTarget;
            
            // Create ripple effect
            const ripple = document.createElement('div');
            ripple.style.cssText = `
                position: absolute;
                width: 100px;
                height: 100px;
                background: radial-gradient(circle, rgba(59, 130, 246, 0.6) 0%, transparent 70%);
                border-radius: 50%;
                transform: translate(-50%, -50%) scale(0);
                pointer-events: none;
                animation: ripple 0.6s ease-out;
                left: ${event.offsetX}px;
                top: ${event.offsetY}px;
                z-index: 10;
            `;
            
            card.style.position = 'relative';
            card.appendChild(ripple);
            
            // Remove ripple after animation
            setTimeout(() => {
                if (card.contains(ripple)) {
                    card.removeChild(ripple);
                }
            }, 600);
        }

        // Add ripple animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes ripple {
                0% {
                    transform: translate(-50%, -50%) scale(0);
                    opacity: 1;
                }
                100% {
                    transform: translate(-50%, -50%) scale(4);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // ==========================================
        // INFRASTRUCTURE MANAGEMENT FUNCTIONS
        // ==========================================

        // Global variables for infrastructure data
        let allUnits = [];
        let allMats = [];
        let allInstructors = [];

        // ==========================================
        // SISTEMA DE ASSOCIAÃ‡Ã•ES HIERÃRQUICAS
        // ==========================================
        
        async function loadStudentWithAssociations(studentId) {
            console.log('ðŸ”„ Carregando aluno com associaÃ§Ãµes:', studentId);
            
            try {
                // Buscar dados do aluno, matrÃ­culas e assinaturas em paralelo
                const [studentResponse, enrollmentsResponse, subscriptionsResponse] = await Promise.all([
                    fetch(`/api/students/${studentId}`),
                    fetch(`/api/students/${studentId}/enrollments`),
                    fetch(`/api/students/${studentId}/subscriptions`)
                ]);
                
                const studentData = await studentResponse.json();
                const enrollmentsData = await enrollmentsResponse.json();
                const subscriptionsData = await subscriptionsResponse.json();
                
                if (!studentData.success) {
                    throw new Error(studentData.message || 'Erro ao carregar dados do aluno');
                }
                
                // Buscar dados complementares
                const [classesResponse, coursesResponse, plansResponse] = await Promise.all([
                    fetch('/api/classes'),
                    fetch('/api/courses'),
                    fetch('/api/billing-plans')
                ]);
                
                const classesData = await classesResponse.json();
                const coursesData = await coursesResponse.json();
                const plansData = await plansResponse.json();
                
                // Processar associaÃ§Ãµes
                const associations = processStudentAssociations(
                    studentData.data,
                    enrollmentsData.success ? enrollmentsData.data : [],
                    subscriptionsData.success ? subscriptionsData.data : [],
                    classesData.success ? classesData.data : [],
                    coursesData.success ? coursesData.data : [],
                    plansData.success ? plansData.data : []
                );
                
                console.log('âœ… AssociaÃ§Ãµes processadas:', associations);
                
                return {
                    student: studentData.data,
                    associations: associations
                };
                
            } catch (error) {
                console.error('âŒ Erro ao carregar aluno com associaÃ§Ãµes:', error);
                return null;
            }
        }
        
        function processStudentAssociations(student, enrollments, subscriptions, allClasses, allCourses, allPlans) {
            console.log('ðŸ”„ Processando associaÃ§Ãµes do aluno...');
            
            const associations = {
                plans: [],
                courses: [],
                classes: [],
                hierarchy: []
            };
            
            // Processar assinaturas de planos
            subscriptions.forEach(subscription => {
                if (subscription.plan || subscription.billingPlan) {
                    const plan = subscription.plan || subscription.billingPlan;
                    associations.plans.push({
                        subscription: subscription,
                        plan: plan
                    });
                }
            });
            
            // Processar matrÃ­culas
            enrollments.forEach(enrollment => {
                if (enrollment.course) {
                    associations.courses.push({
                        enrollment: enrollment,
                        course: enrollment.course
                    });
                }
                
                if (enrollment.class) {
                    associations.classes.push({
                        enrollment: enrollment,
                        class: enrollment.class
                    });
                }
            });
            
            // Criar hierarquia
            associations.plans.forEach(planAssoc => {
                const planHierarchy = {
                    plan: planAssoc.plan,
                    subscription: planAssoc.subscription,
                    courses: [],
                    directClasses: []
                };
                
                // Encontrar cursos relacionados ao plano
                associations.courses.forEach(courseAssoc => {
                    const course = courseAssoc.course;
                    if (course.category === planAssoc.plan.category || 
                        course.level === planAssoc.plan.level ||
                        course.planId === planAssoc.plan.id ||
                        course.id === planAssoc.plan.courseId) {
                        
                        const courseInPlan = {
                            course: course,
                            enrollment: courseAssoc.enrollment,
                            classes: []
                        };
                        
                        // Encontrar turmas do curso
                        associations.classes.forEach(classAssoc => {
                            if (classAssoc.class.courseId === course.id) {
                                courseInPlan.classes.push({
                                    class: classAssoc.class,
                                    enrollment: classAssoc.enrollment
                                });
                            }
                        });
                        
                        planHierarchy.courses.push(courseInPlan);
                    }
                });
                
                // Verificar se o plano tem um courseId direto que ainda nÃ£o foi adicionado
                if (planAssoc.plan.courseId && allCourses && allCourses.length > 0) {
                    const planCourse = allCourses.find(course => course.id === planAssoc.plan.courseId);
                    if (planCourse) {
                        // Verificar se o curso jÃ¡ foi adicionado
                        const courseAlreadyAdded = planHierarchy.courses.some(courseInPlan => 
                            courseInPlan.course.id === planCourse.id
                        );
                        
                        if (!courseAlreadyAdded) {
                            console.log('ðŸŽ“ Adicionando curso direto do plano:', planCourse.name);
                            const courseInPlan = {
                                course: planCourse,
                                enrollment: null, // Sem matrÃ­cula ainda
                                classes: []
                            };
                            
                            // Encontrar turmas do curso
                            associations.classes.forEach(classAssoc => {
                                if (classAssoc.class.courseId === planCourse.id) {
                                    courseInPlan.classes.push({
                                        class: classAssoc.class,
                                        enrollment: classAssoc.enrollment
                                    });
                                }
                            });
                            
                            planHierarchy.courses.push(courseInPlan);
                        }
                    }
                }
                
                // Encontrar turmas diretas do plano (sem curso)
                associations.classes.forEach(classAssoc => {
                    const isInCourse = planHierarchy.courses.some(courseInPlan => 
                        courseInPlan.classes.some(c => c.class.id === classAssoc.class.id)
                    );
                    
                    if (!isInCourse && (
                        classAssoc.class.category === planAssoc.plan.category || 
                        classAssoc.class.level === planAssoc.plan.level ||
                        classAssoc.class.planId === planAssoc.plan.id
                    )) {
                        planHierarchy.directClasses.push({
                            class: classAssoc.class,
                            enrollment: classAssoc.enrollment
                        });
                    }
                });
                
                associations.hierarchy.push(planHierarchy);
            });
            
            // Se nÃ£o hÃ¡ planos, criar uma estrutura bÃ¡sica
            if (associations.hierarchy.length === 0 && (associations.courses.length > 0 || associations.classes.length > 0)) {
                associations.hierarchy.push({
                    plan: { name: 'Sem Plano Definido', category: 'Geral' },
                    subscription: null,
                    courses: associations.courses.map(courseAssoc => ({
                        course: courseAssoc.course,
                        enrollment: courseAssoc.enrollment,
                        classes: associations.classes.filter(classAssoc => 
                            classAssoc.class.courseId === courseAssoc.course.id
                        )
                    })),
                    directClasses: associations.classes.filter(classAssoc => 
                        !associations.courses.some(courseAssoc => 
                            courseAssoc.course.id === classAssoc.class.courseId
                        )
                    )
                });
            }
            
            console.log('âœ… AssociaÃ§Ãµes processadas:', associations);
            return associations;
        }
        
        function renderStudentClassesWithHierarchy(associations) {
            console.log('ðŸŽ¨ Renderizando turmas com hierarquia...');
            
            const classesTab = document.getElementById('student-classes-content');
            if (!classesTab) {
                console.error('âŒ Elemento student-classes-content nÃ£o encontrado');
                return;
            }
            
            if (!associations || associations.hierarchy.length === 0) {
                classesTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“‹</div>
                        <p>Nenhuma turma encontrada para este aluno</p>
                        <button onclick="loadStudentClassesTab()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ðŸ”„ Recarregar
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 1.5rem; padding: 1rem;">';
            
            associations.hierarchy.forEach((planHierarchy, planIndex) => {
                const plan = planHierarchy.plan;
                const subscription = planHierarchy.subscription;
                
                // Contar total de turmas neste plano
                const totalClasses = planHierarchy.courses.reduce((total, course) => 
                    total + course.classes.length, 0
                ) + planHierarchy.directClasses.length;
                
                html += `
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05)); border: 1px solid #10B981; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(16, 185, 129, 0.3);">
                            <div>
                                <h4 style="color: #10B981; margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                                    ðŸ’Ž ${plan.name}
                                </h4>
                                <p style="color: #94A3B8; margin: 0.25rem 0; font-size: 0.9rem;">
                                    ${plan.price ? `R$ ${parseFloat(plan.price).toFixed(2)}/mÃªs` : 'PreÃ§o nÃ£o definido'} â€¢ 
                                    ${plan.category || 'Categoria nÃ£o definida'} â€¢ 
                                    ${subscription ? subscription.status || 'Ativo' : 'Sem assinatura'}
                                </p>
                            </div>
                            <div style="text-align: right; color: #10B981; font-size: 0.8rem;">
                                <div style="font-weight: bold; font-size: 1.2rem;">${totalClasses}</div>
                                <div>turma(s)</div>
                            </div>
                        </div>
                `;
                
                // Renderizar cursos com suas turmas
                if (planHierarchy.courses.length > 0) {
                    planHierarchy.courses.forEach(courseInPlan => {
                        const course = courseInPlan.course;
                        
                        html += `
                            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <h5 style="color: #3B82F6; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    ðŸ“š ${course.name}
                                </h5>
                                <p style="color: #E5E7EB; margin: 0 0 1rem 0; font-size: 0.85rem;">
                                    ${course.description || 'DescriÃ§Ã£o nÃ£o disponÃ­vel'}
                                </p>
                        `;
                        
                        // Renderizar turmas do curso
                        if (courseInPlan.classes.length > 0) {
                            courseInPlan.classes.forEach(classInCourse => {
                                const classData = classInCourse.class;
                                const enrollment = classInCourse.enrollment;
                                
                                html += `
                                    <div style="background: rgba(15, 23, 42, 0.7); border: 1px solid #475569; border-radius: 6px; padding: 0.75rem; margin: 0.5rem 0; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: #E5E7EB; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                                ðŸ• ${classData.name}
                                            </div>
                                            <div style="color: #9CA3AF; font-size: 0.75rem; margin-top: 0.25rem;">
                                                ðŸ“… ${classData.schedule || 'HorÃ¡rio flexÃ­vel'} â€¢ 
                                                ðŸ‘¥ ${classData.capacity || 'Sem limite'} vagas â€¢ 
                                                Status: ${enrollment.status || 'Ativo'}
                                            </div>
                                            ${classData.description ? `<div style="color: #6B7280; font-size: 0.7rem; margin-top: 0.25rem;">${classData.description}</div>` : ''}
                                        </div>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button onclick="quickCheckinToClass('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #10B981; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                                âœ“ Check-in
                                            </button>
                                            <button onclick="viewClassDetails('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                                ðŸ‘ï¸ Detalhes
                                            </button>
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            html += `
                                <div style="color: #9CA3AF; font-style: italic; text-align: center; padding: 1rem; background: rgba(107, 114, 128, 0.1); border-radius: 6px;">
                                    ðŸ“– Curso teÃ³rico - sem turmas prÃ¡ticas associadas
                                </div>
                            `;
                        }
                        
                        html += '</div>';
                    });
                }
                
                // Renderizar turmas diretas do plano
                if (planHierarchy.directClasses.length > 0) {
                    html += `
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #F59E0B; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                            <h5 style="color: #F59E0B; margin: 0 0 0.75rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                ðŸŽ¯ Turmas Diretas do Plano
                            </h5>
                    `;
                    
                    planHierarchy.directClasses.forEach(directClass => {
                        const classData = directClass.class;
                        const enrollment = directClass.enrollment;
                        
                        html += `
                            <div style="background: rgba(15, 23, 42, 0.7); border: 1px solid #475569; border-radius: 6px; padding: 0.75rem; margin: 0.5rem 0; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #E5E7EB; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                        ðŸ• ${classData.name}
                                    </div>
                                    <div style="color: #9CA3AF; font-size: 0.75rem; margin-top: 0.25rem;">
                                        ðŸ“… ${classData.schedule || 'HorÃ¡rio flexÃ­vel'} â€¢ 
                                        ðŸ‘¥ ${classData.capacity || 'Sem limite'} vagas â€¢ 
                                        Status: ${enrollment.status || 'Ativo'}
                                    </div>
                                    ${classData.description ? `<div style="color: #6B7280; font-size: 0.7rem; margin-top: 0.25rem;">${classData.description}</div>` : ''}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="quickCheckinToClass('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #10B981; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        âœ“ Check-in
                                    </button>
                                    <button onclick="viewClassDetails('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        ðŸ‘ï¸ Detalhes
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            classesTab.innerHTML = html;
            
            console.log('âœ… Turmas renderizadas com hierarquia');
        }
        
        function renderStudentCoursesWithHierarchy(associations) {
            console.log('ðŸŽ¨ [MAIN] Renderizando cursos com hierarquia...');
            console.log('ðŸ” [MAIN] Debug associations recebidas:', associations);
            
            const coursesTab = document.getElementById('student-courses-content');
            if (!coursesTab) {
                console.error('âŒ Elemento student-courses-content nÃ£o encontrado');
                return;
            }
            
            if (!associations || associations.hierarchy.length === 0) {
                coursesTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“š</div>
                        <p>Nenhum curso encontrado para este aluno</p>
                        <button onclick="loadStudentCoursesTab()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ðŸ”„ Recarregar
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 1.5rem; padding: 1rem;">';
            
            associations.hierarchy.forEach((planHierarchy, planIndex) => {
                const plan = planHierarchy.plan;
                const subscription = planHierarchy.subscription;
                
                console.log(`ðŸ” Debug plano ${planIndex}:`, {
                    plan: plan.name,
                    coursesLength: planHierarchy.courses.length,
                    courses: planHierarchy.courses
                });
                
                if (planHierarchy.courses.length === 0) {
                    console.log(`âš ï¸ Plano ${plan.name} nÃ£o tem cursos, pulando...`);
                    return; // Pular planos sem cursos
                }
                
                html += `
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05)); border: 1px solid #10B981; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(16, 185, 129, 0.3);">
                            <div>
                                <h4 style="color: #10B981; margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                                    ðŸ’Ž ${plan.name}
                                </h4>
                                <p style="color: #94A3B8; margin: 0.25rem 0; font-size: 0.9rem;">
                                    ${plan.price ? `R$ ${parseFloat(plan.price).toFixed(2)}/mÃªs` : 'PreÃ§o nÃ£o definido'} â€¢ 
                                    ${plan.category || 'Categoria nÃ£o definida'} â€¢ 
                                    ${subscription ? subscription.status || 'Ativo' : 'Sem assinatura'}
                                </p>
                            </div>
                            <div style="text-align: right; color: #10B981; font-size: 0.8rem;">
                                <div style="font-weight: bold; font-size: 1.2rem;">${planHierarchy.courses.length}</div>
                                <div>curso(s)</div>
                            </div>
                        </div>
                `;
                
                // Renderizar cursos
                planHierarchy.courses.forEach(courseInPlan => {
                    const course = courseInPlan.course;
                    const enrollment = courseInPlan.enrollment;
                    
                    html += `
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h5 style="color: #3B82F6; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                        ðŸ“š ${course.name}
                                    </h5>
                                    <p style="color: #E5E7EB; margin: 0 0 0.75rem 0; font-size: 0.85rem;">
                                        ${course.description || 'DescriÃ§Ã£o nÃ£o disponÃ­vel'}
                                    </p>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; font-size: 0.75rem; color: #9CA3AF;">
                                        <div>ðŸ“Š NÃ­vel: ${course.level || 'N/A'}</div>
                                        <div>ðŸ·ï¸ Categoria: ${course.category || 'N/A'}</div>
                                        <div>ðŸ“… MatrÃ­cula: ${enrollment.enrolledAt ? new Date(enrollment.enrolledAt).toLocaleDateString('pt-BR') : 'N/A'}</div>
                                        <div>âš¡ Status: ${enrollment.status || 'Ativo'}</div>
                                    </div>
                                    ${courseInPlan.classes.length > 0 ? `
                                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(59, 130, 246, 0.3);">
                                            <div style="color: #3B82F6; font-size: 0.8rem; margin-bottom: 0.5rem; font-weight: 600;">
                                                ðŸ• Turmas Associadas (${courseInPlan.classes.length})
                                            </div>
                                            <div style="display: grid; gap: 0.25rem;">
                                                ${courseInPlan.classes.map(classInCourse => `
                                                    <div style="background: rgba(15, 23, 42, 0.5); border-radius: 4px; padding: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                                        <span style="color: #E5E7EB; font-size: 0.75rem;">
                                                            ${classInCourse.class.name} â€¢ ${classInCourse.class.schedule || 'HorÃ¡rio flexÃ­vel'}
                                                        </span>
                                                        <button onclick="quickCheckinToClass('${classInCourse.class.id}')" style="padding: 0.125rem 0.375rem; background: #10B981; color: white; border: none; border-radius: 3px; font-size: 0.625rem; cursor: pointer;">
                                                            âœ“
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-left: 1rem;">
                                    <button onclick="viewCourseProgress('${course.id}')" style="padding: 0.5rem 0.75rem; background: #8B5CF6; color: white; border: none; border-radius: 6px; font-size: 0.75rem; cursor: pointer; white-space: nowrap;">
                                        ðŸ“ˆ Progresso
                                    </button>
                                    <button onclick="viewCourseDetails('${course.id}')" style="padding: 0.5rem 0.75rem; background: #3B82F6; color: white; border: none; border-radius: 6px; font-size: 0.75rem; cursor: pointer; white-space: nowrap;">
                                        ðŸ‘ï¸ Detalhes
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            
            console.log('ðŸ” HTML gerado:', html.substring(0, 200) + '...');
            console.log('ðŸ” Element coursesTab:', coursesTab);
            
            coursesTab.innerHTML = html;
            
            // Debug: Force visibility
            coursesTab.style.display = 'block';
            coursesTab.style.visibility = 'visible';
            coursesTab.style.opacity = '1';
            
            // Debug: Check parent elements
            let parent = coursesTab.parentElement;
            while (parent) {
                console.log('ðŸ” Parent element:', parent.tagName, parent.id, parent.style.display);
                if (parent.style.display === 'none' || parent.style.visibility === 'hidden') {
                    console.log('âŒ Parent element is hidden!', parent);
                    if (parent.id === 'student-tab-courses') {
                        console.log('âš ï¸ A aba de assinatura nÃ£o estÃ¡ ativa! Clique na aba "ðŸ’³ Assinatura" para ver o conteÃºdo.');
                    }
                }
                parent = parent.parentElement;
                if (parent === document.body) break;
            }
            
            console.log('âœ… Cursos renderizados com hierarquia');
            console.log('ðŸ” HTML final inserido no DOM:', coursesTab.innerHTML.substring(0, 200) + '...');
            console.log('ðŸ” coursesTab styles:', {
                display: coursesTab.style.display,
                visibility: coursesTab.style.visibility,
                opacity: coursesTab.style.opacity
            });
        }

        // FunÃ§Ãµes de aÃ§Ã£o para os botÃµes (placeholders)
        function quickCheckinToClass(classId) {
            console.log('ðŸŽ¯ Quick check-in para turma:', classId);
            alert(`ðŸŽ¯ Check-in rÃ¡pido na turma ${classId}\n\n(Funcionalidade em desenvolvimento)`);
        }

        function viewClassDetails(classId) {
            console.log('ðŸ‘ï¸ Visualizar detalhes da turma:', classId);
            alert(`ðŸ‘ï¸ Detalhes da turma ${classId}\n\n(Funcionalidade em desenvolvimento)`);
        }

        function viewCourseProgress(courseId) {
            console.log('ðŸ“ˆ Visualizar progresso do curso:', courseId);
            alert(`ðŸ“ˆ Progresso do curso ${courseId}\n\n(Funcionalidade em desenvolvimento)`);
        }

        function viewCourseDetails(courseId) {
            console.log('ðŸ‘ï¸ Visualizar detalhes do curso:', courseId);
            alert(`ðŸ‘ï¸ Detalhes do curso ${courseId}\n\n(Funcionalidade em desenvolvimento)`);
        }

        // ==========================================
        // UNITS MANAGEMENT
        // ==========================================

        // Load units data
        async function loadUnits() {
            try {
                document.getElementById('unitsLoadingState').style.display = 'block';
                document.getElementById('unitsEmptyState').style.display = 'none';
                
                const response = await fetch('/api/units');
                const data = await response.json();
                
                if (data.success) {
                    allUnits = data.data;
                    displayUnits(allUnits);
                    updateUnitsStats();
                } else {
                    throw new Error(data.message || 'Erro ao carregar unidades');
                }
            } catch (error) {
                console.error('Erro ao carregar unidades:', error);
                showToast('Erro ao carregar unidades: ' + error.message, 'error');
                document.getElementById('unitsEmptyState').style.display = 'block';
            } finally {
                document.getElementById('unitsLoadingState').style.display = 'none';
            }
        }

        // Display units in table
        function displayUnits(units) {
            const tbody = document.getElementById('unitsTableBody');
            
            if (!units || units.length === 0) {
                document.getElementById('unitsEmptyState').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }
            
            document.getElementById('unitsEmptyState').style.display = 'none';
            
            tbody.innerHTML = units.map(unit => `
                <tr style="border-bottom: 1px solid #334155;">
                    <td style="padding: 1rem; color: #F8FAFC;">
                        <div style="font-weight: 600;">${unit.name}</div>
                        <div style="font-size: 0.875rem; color: #94A3B8;">${unit.description || 'Sem descriÃ§Ã£o'}</div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        <div style="font-size: 0.875rem;">${unit.address}</div>
                        <div style="font-size: 0.75rem; color: #94A3B8;">${unit.city}, ${unit.state}</div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                        <div style="background: rgba(139, 92, 246, 0.1); color: #8B5CF6; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                            ${unit._count?.mats || 0}
                        </div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                        <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                            ${unit.capacity}
                        </div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                        <div style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                            ${unit._count?.classes || 0}
                        </div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        ${unit.responsibleName || 'NÃ£o informado'}
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <span style="background: ${unit.isActive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; color: ${unit.isActive ? '#10B981' : '#EF4444'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">
                            ${unit.isActive ? 'ATIVO' : 'INATIVO'}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editUnit('${unit.id}')" style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                âœï¸ Editar
                            </button>
                            <button onclick="viewUnitDetails('${unit.id}')" style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8B5CF6; color: #8B5CF6; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                ðŸ‘ï¸ Ver
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update units statistics
        function updateUnitsStats() {
            const totalUnits = allUnits.length;
            const totalMats = allUnits.reduce((sum, unit) => sum + (unit._count?.mats || 0), 0);
            const totalCapacity = allUnits.reduce((sum, unit) => sum + unit.capacity, 0);
            const totalClasses = allUnits.reduce((sum, unit) => sum + (unit._count?.classes || 0), 0);
            
            document.getElementById('totalUnitsCount').textContent = totalUnits;
            document.getElementById('totalMatsCount').textContent = totalMats;
            document.getElementById('totalCapacityCount').textContent = totalCapacity;
            document.getElementById('activeClassesCount').textContent = totalClasses;
        }

        // Search units
        function searchUnits() {
            const searchTerm = document.getElementById('unitsSearchInput').value.toLowerCase();
            const filteredUnits = allUnits.filter(unit => 
                unit.name.toLowerCase().includes(searchTerm) ||
                unit.description?.toLowerCase().includes(searchTerm) ||
                unit.address.toLowerCase().includes(searchTerm) ||
                unit.city.toLowerCase().includes(searchTerm)
            );
            displayUnits(filteredUnits);
        }

        // Modal functions for units
        function openAddUnitModal() {
            showToast('Modal de adicionar unidade em desenvolvimento', 'info');
        }

        function editUnit(unitId) {
            showToast(`Editando unidade ${unitId}`, 'info');
        }

        function viewUnitDetails(unitId) {
            showToast(`Visualizando detalhes da unidade ${unitId}`, 'info');
        }

        function exportUnitsReport() {
            showToast('RelatÃ³rio de unidades em desenvolvimento', 'info');
        }

        // ==========================================
        // MATS MANAGEMENT
        // ==========================================

        // Load mats data
        async function loadMats() {
            try {
                document.getElementById('matsLoadingState').style.display = 'block';
                document.getElementById('matsEmptyState').style.display = 'none';
                
                const response = await fetch('/api/mats');
                const data = await response.json();
                
                if (data.success) {
                    allMats = data.data;
                    displayMats(allMats);
                    updateMatsStats();
                    loadUnitFilterOptions();
                } else {
                    throw new Error(data.message || 'Erro ao carregar tatames');
                }
            } catch (error) {
                console.error('Erro ao carregar tatames:', error);
                showToast('Erro ao carregar tatames: ' + error.message, 'error');
                document.getElementById('matsEmptyState').style.display = 'block';
            } finally {
                document.getElementById('matsLoadingState').style.display = 'none';
            }
        }

        // Display mats in table
        function displayMats(mats) {
            const tbody = document.getElementById('matsTableBody');
            
            if (!mats || mats.length === 0) {
                document.getElementById('matsEmptyState').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }
            
            document.getElementById('matsEmptyState').style.display = 'none';
            
            tbody.innerHTML = mats.map(mat => `
                <tr style="border-bottom: 1px solid #334155;">
                    <td style="padding: 1rem; color: #F8FAFC;">
                        <div style="font-weight: 600;">${mat.name}</div>
                        <div style="font-size: 0.875rem; color: #94A3B8;">${mat.description || 'Sem descriÃ§Ã£o'}</div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        ${mat.unit?.name || 'Sem unidade'}
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                        <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                            ${mat.capacity}
                        </div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        ${mat.dimensions || 'NÃ£o informado'}
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        <div style="font-size: 0.875rem;">${mat.equipment?.join(', ') || 'Nenhum'}</div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                        <div style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                            ${mat._count?.classes || 0}
                        </div>
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <span style="background: ${mat.isActive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; color: ${mat.isActive ? '#10B981' : '#EF4444'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">
                            ${mat.isActive ? 'ATIVO' : 'INATIVO'}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editMat('${mat.id}')" style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                âœï¸ Editar
                            </button>
                            <button onclick="viewMatDetails('${mat.id}')" style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8B5CF6; color: #8B5CF6; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                ðŸ‘ï¸ Ver
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update mats statistics
        function updateMatsStats() {
            const totalMats = allMats.length;
            const totalCapacity = allMats.reduce((sum, mat) => sum + mat.capacity, 0);
            const matsInUse = allMats.filter(mat => mat._count?.classes > 0).length;
            const matsAvailable = allMats.filter(mat => mat.isActive && !mat._count?.classes).length;
            
            document.getElementById('matsCount').textContent = totalMats;
            document.getElementById('matsCapacity').textContent = totalCapacity;
            document.getElementById('matsInUse').textContent = matsInUse;
            document.getElementById('matsAvailable').textContent = matsAvailable;
        }

        // Load unit filter options
        function loadUnitFilterOptions() {
            const select = document.getElementById('unitFilter');
            if (!select) return;
            
            const units = [...new Set(allMats.map(mat => mat.unit?.name).filter(Boolean))];
            const optionsHTML = '<option value="">Todas as Unidades</option>' +
                units.map(unitName => `<option value="${unitName}">${unitName}</option>`).join('');
            
            select.innerHTML = optionsHTML;
        }

        // Filter mats by unit
        function filterMatsByUnit() {
            const selectedUnit = document.getElementById('unitFilter').value;
            const filteredMats = selectedUnit 
                ? allMats.filter(mat => mat.unit?.name === selectedUnit)
                : allMats;
            displayMats(filteredMats);
        }

        // Clear mat filters
        function clearMatFilters() {
            document.getElementById('unitFilter').value = '';
            document.getElementById('matsSearchInput').value = '';
            displayMats(allMats);
        }

        // Search mats
        function searchMats() {
            const searchTerm = document.getElementById('matsSearchInput').value.toLowerCase();
            const filteredMats = allMats.filter(mat => 
                mat.name.toLowerCase().includes(searchTerm) ||
                mat.description?.toLowerCase().includes(searchTerm) ||
                mat.unit?.name.toLowerCase().includes(searchTerm)
            );
            displayMats(filteredMats);
        }

        // Modal functions for mats
        function openAddMatModal() {
            showToast('Modal de adicionar tatame em desenvolvimento', 'info');
        }

        function editMat(matId) {
            showToast(`Editando tatame ${matId}`, 'info');
        }

        function viewMatDetails(matId) {
            showToast(`Visualizando detalhes do tatame ${matId}`, 'info');
        }

        function exportMatsReport() {
            showToast('RelatÃ³rio de tatames em desenvolvimento', 'info');
        }

        // ==========================================
        // INSTRUCTORS MANAGEMENT
        // ==========================================

        // Load instructors data
        async function loadInstructors() {
            try {
                document.getElementById('instructorsLoadingState').style.display = 'block';
                document.getElementById('instructorsEmptyState').style.display = 'none';
                
                const response = await fetch('/api/instructors');
                const data = await response.json();
                
                if (data.success) {
                    allInstructors = data.data;
                    displayInstructors(allInstructors);
                    updateInstructorsStats();
                } else {
                    throw new Error(data.message || 'Erro ao carregar professores');
                }
            } catch (error) {
                console.error('Erro ao carregar professores:', error);
                showToast('Erro ao carregar professores: ' + error.message, 'error');
                document.getElementById('instructorsEmptyState').style.display = 'block';
            } finally {
                document.getElementById('instructorsLoadingState').style.display = 'none';
            }
        }

        // Display instructors in table
        function displayInstructors(instructors) {
            const tbody = document.getElementById('instructorsTableBody');
            
            if (!instructors || instructors.length === 0) {
                document.getElementById('instructorsEmptyState').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }
            
            document.getElementById('instructorsEmptyState').style.display = 'none';
            
            tbody.innerHTML = instructors.map(instructor => {
                const user = instructor.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                
                return `
                    <tr style="border-bottom: 1px solid #334155;">
                        <td style="padding: 1rem; color: #F8FAFC;">
                            <div style="font-weight: 600;">${fullName || 'Nome nÃ£o informado'}</div>
                            <div style="font-size: 0.875rem; color: #94A3B8;">${instructor.bio ? instructor.bio.substring(0, 50) + '...' : 'Sem biografia'}</div>
                        </td>
                        <td style="padding: 1rem; color: #CBD5E1;">
                            ${user.email || 'Email nÃ£o informado'}
                        </td>
                        <td style="padding: 1rem; color: #CBD5E1;">
                            <div style="font-size: 0.875rem;">${instructor.specializations?.join(', ') || 'Nenhuma'}</div>
                        </td>
                        <td style="padding: 1rem; color: #CBD5E1;">
                            <div style="font-size: 0.875rem;">${instructor.martialArts?.join(', ') || 'Nenhuma'}</div>
                        </td>
                        <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                            <div style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                                ${instructor.experience || 0} anos
                            </div>
                        </td>
                        <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                            <div style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                                ${instructor._count?.classes || 0}
                            </div>
                        </td>
                        <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                            ${instructor.hourlyRate ? `R$ ${instructor.hourlyRate.toFixed(2)}` : 'NÃ£o informado'}
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <span style="background: ${instructor.isActive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; color: ${instructor.isActive ? '#10B981' : '#EF4444'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">
                                ${instructor.isActive ? 'ATIVO' : 'INATIVO'}
                            </span>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="editInstructor('${instructor.id}')" style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                    âœï¸ Editar
                                </button>
                                <button onclick="viewInstructorDetails('${instructor.id}')" style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8B5CF6; color: #8B5CF6; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                    ðŸ‘ï¸ Ver
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update instructors statistics
        function updateInstructorsStats() {
            const totalInstructors = allInstructors.length;
            const activeInstructors = allInstructors.filter(inst => inst.isActive).length;
            const instructorsWithClasses = allInstructors.filter(inst => inst._count?.classes > 0).length;
            const avgExperience = allInstructors.length > 0 
                ? Math.round(allInstructors.reduce((sum, inst) => sum + (inst.experience || 0), 0) / allInstructors.length)
                : 0;
            
            document.getElementById('instructorsCount').textContent = totalInstructors;
            document.getElementById('instructorsActive').textContent = activeInstructors;
            document.getElementById('instructorsWithClasses').textContent = instructorsWithClasses;
            document.getElementById('avgExperience').textContent = avgExperience;
        }

        // Search instructors
        function searchInstructors() {
            const searchTerm = document.getElementById('instructorsSearchInput').value.toLowerCase();
            const filteredInstructors = allInstructors.filter(instructor => {
                const user = instructor.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                return fullName.includes(searchTerm) ||
                       user.email?.toLowerCase().includes(searchTerm) ||
                       instructor.specializations?.some(spec => spec.toLowerCase().includes(searchTerm)) ||
                       instructor.martialArts?.some(art => art.toLowerCase().includes(searchTerm));
            });
            displayInstructors(filteredInstructors);
        }

        // Modal functions for instructors
        function openAddInstructorModal() {
            showToast('Modal de adicionar professor em desenvolvimento', 'info');
        }

        function editInstructor(instructorId) {
            showToast(`Editando professor ${instructorId}`, 'info');
        }

        function viewInstructorDetails(instructorId) {
            showToast(`Visualizando detalhes do professor ${instructorId}`, 'info');
        }

        function exportInstructorsReport() {
            showToast('RelatÃ³rio de professores em desenvolvimento', 'info');
        }

        // ==========================================
        // PAYMENT PLANS MISSING FUNCTIONS
        // ==========================================

        // Open Add Plan Page (full screen instead of modal)
        function openAddPlanPage() {
            console.log('ðŸ†• Opening Add Plan Page...');
            
            // Navigate to full-screen plan edit page in creation mode
            clearPlanEditForm();
            updatePlanEditPageTitle('Criar Novo Plano', 'Preencha as informaÃ§Ãµes para criar um novo plano');
            showSection('plan-edit');
            
            // Set form to creation mode
            document.getElementById('planEditForm').dataset.mode = 'create';
            delete document.getElementById('planEditForm').dataset.editingPlanId;
            
            // Reset to first tab and load courses
            switchPlanEditTab('basic');
            loadCoursesForPlanEdit();
            
            showToast('Abrindo formulÃ¡rio de novo plano', 'info');
        }

        // Switch between plan edit tabs (for full-screen page)
        window.switchPlanEditTab = function(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.plan-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.plan-tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            const selectedTab = document.querySelector(`.plan-tab[data-tab="${tabName}"]`);
            const selectedContent = document.getElementById(`planEditTab-${tabName}`);
            
            if (selectedTab && selectedContent) {
                selectedTab.classList.add('active');
                selectedContent.classList.add('active');
            }
            
            // Load content for specific tabs
            if (tabName === 'courses') {
                // Only reload if not already loaded
                const coursesGrid = document.getElementById('editCoursesGrid');
                if (!coursesGrid || !coursesGrid.innerHTML.includes('planCourses')) {
                    console.log('ðŸ”„ switchPlanEditTab courses - Loading for first time');
                    const currentSelection = getCurrentlySelectedCourseIds();
                    loadCoursesForPlanEdit(currentSelection);
                } else {
                    console.log('âœ… switchPlanEditTab courses - Already loaded, skipping reload');
                }
            } else if (tabName === 'preview') {
                updatePlanEditPreview();
            }
        }

        // Helper function to get currently selected course IDs
        function getCurrentlySelectedCourseIds() {
            const checkboxes = document.querySelectorAll('#editCoursesGrid .course-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-course-id'));
        }

        // Load courses for plan edit selection
        async function loadCoursesForPlanEdit(preselectCourseIds = []) {
            console.log('ðŸŽ“ loadCoursesForPlanEdit started with preselect:', preselectCourseIds);
            const coursesGrid = document.getElementById('editCoursesGrid');
            
            try {
                // Show loading state
                coursesGrid.innerHTML = `
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Carregando cursos disponÃ­veis...</p>
                    </div>
                `;
                
                console.log('ðŸŽ“ Fetching courses from /api/courses...');
                const response = await fetch('/api/courses');
                const result = await response.json();
                console.log('ðŸŽ“ Courses API response:', result);
                
                if (result.success && result.data.length > 0) {
                    const courses = result.data;
                    
                    console.log('ðŸŽ“ Courses loaded for edit:', courses.length);
                    console.log('ðŸŽ“ First course:', courses[0]);
                    
                    // Update stats
                    document.getElementById('editCoursesTotalCount').textContent = `${courses.length} cursos disponÃ­veis`;
                    updateSelectedEditCoursesCount();
                    
                    // Simplified course selection interface
                    coursesGrid.innerHTML = `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: #E2E8F0; margin: 0 0 1rem 0;">Selecionar Cursos para o Plano</h4>
                            <p style="color: #94A3B8; margin: 0 0 1rem 0; font-size: 0.875rem;">Marque os cursos que fazem parte deste plano:</p>
                        </div>
                        
                        <div style="display: grid; gap: 0.75rem;">
                            ${courses.map(course => `
                                <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.8); border: 2px solid rgba(148, 163, 184, 0.2); border-radius: 8px; cursor: pointer; transition: all 0.2s ease;" 
                                       onmouseover="this.style.borderColor='rgba(59, 130, 246, 0.5)'" 
                                       onmouseout="this.style.borderColor='rgba(148, 163, 184, 0.2)'">
                                    <input type="checkbox" 
                                           name="planCourses" 
                                           value="${course.id}" 
                                           ${preselectCourseIds.includes(course.id) ? 'checked' : ''}
                                           style="width: 20px; height: 20px; accent-color: #10B981; cursor: pointer;"
                                           onchange="updateCourseSelection(this)">
                                    <div style="flex: 1;">
                                        <h5 style="color: #E2E8F0; margin: 0 0 0.25rem 0; font-size: 1rem; font-weight: 600;">${course.name}</h5>
                                        <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">${course.description || 'DescriÃ§Ã£o nÃ£o disponÃ­vel'}</p>
                                    </div>
                                    <div style="color: #94A3B8; font-size: 0.75rem; text-align: right;">
                                        <div>ðŸŽ“ ${course.totalClasses || 48} aulas</div>
                                        <div>ðŸ‘¥ ${course._count?.studentCourses || 0} alunos</div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                        
                        <div id="selectedCoursesDisplay" style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px;">
                            <h5 style="color: #E2E8F0; margin: 0 0 0.5rem 0;">Cursos Selecionados: <span id="selectedCount">0</span></h5>
                            <div id="selectedCourseNames" style="color: #94A3B8; font-size: 0.875rem;">Nenhum curso selecionado</div>
                        </div>
                    `;
                    
                    // Update the display immediately
                    updateSimpleCourseDisplay();
                } else {
                    coursesGrid.innerHTML = `
                        <div style="text-align: center; color: #94A3B8; padding: 3rem;">
                            <h4>ðŸ“š Nenhum curso disponÃ­vel</h4>
                            <p>Crie cursos primeiro para associÃ¡-los aos planos.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('âŒ Erro ao carregar cursos:', error);
                coursesGrid.innerHTML = `
                    <div style="text-align: center; color: #EF4444; padding: 3rem;">
                        <h4>âŒ Erro ao carregar cursos</h4>
                        <p>Tente novamente ou verifique a conexÃ£o.</p>
                    </div>
                `;
                throw error; // Re-throw to ensure promise rejects
            }
            
            console.log('ðŸŽ“ loadCoursesForPlanEdit completed successfully');
            return true; // Ensure promise resolves
        }

        // Simple course selection function
        function updateCourseSelection(checkbox) {
            const label = checkbox.closest('label');
            
            // Visual feedback
            if (checkbox.checked) {
                label.style.borderColor = '#10B981';
                label.style.background = 'rgba(16, 185, 129, 0.1)';
            } else {
                label.style.borderColor = 'rgba(148, 163, 184, 0.2)';
                label.style.background = 'rgba(15, 23, 42, 0.8)';
            }
            
            updateSimpleCourseDisplay();
            updateLegacyEditPlanCourseField();
        }

        // Simple display update
        function updateSimpleCourseDisplay() {
            const checkboxes = document.querySelectorAll('#editCoursesGrid input[name="planCourses"]:checked');
            const countElement = document.getElementById('selectedCount');
            const namesElement = document.getElementById('selectedCourseNames');
            
            if (!countElement || !namesElement) return;
            
            const count = checkboxes.length;
            countElement.textContent = count;
            
            if (count === 0) {
                namesElement.textContent = 'Nenhum curso selecionado';
            } else {
                const names = Array.from(checkboxes).map(cb => {
                    const label = cb.closest('label');
                    return label.querySelector('h5').textContent;
                });
                namesElement.textContent = names.join(', ');
            }
            
            updateSelectedEditCoursesCount();
        }

        // Select all courses in edit page with visual feedback
        function selectAllEditCourses() {
            document.querySelectorAll('#editCoursesGrid .course-card').forEach(card => {
                const checkbox = card.querySelector('.course-checkbox');
                const selectionIndicator = card.querySelector('.selection-indicator');
                
                checkbox.checked = true;
                card.classList.add('selected');
                
                // Apply visual state
                card.style.border = '2px solid #3B82F6';
                card.style.background = 'rgba(59, 130, 246, 0.1)';
                card.style.transform = 'scale(1.02)';
                
                if (selectionIndicator) {
                    selectionIndicator.style.display = 'block';
                }
            });
            updateLegacyEditPlanCourseField();
            updateSelectedEditCoursesCount();
            updatePlanEditPreview();
            showToast('Todos os cursos foram selecionados', 'success');
        }

        // Clear all course selections in edit page with visual feedback
        function clearAllEditCourses() {
            document.querySelectorAll('#editCoursesGrid .course-card').forEach(card => {
                const checkbox = card.querySelector('.course-checkbox');
                const selectionIndicator = card.querySelector('.selection-indicator');
                
                checkbox.checked = false;
                card.classList.remove('selected');
                
                // Reset visual state
                card.style.border = '2px solid rgba(148, 163, 184, 0.2)';
                card.style.background = 'rgba(15, 23, 42, 0.8)';
                card.style.transform = 'scale(1)';
                
                if (selectionIndicator) {
                    selectionIndicator.style.display = 'none';
                }
            });
            updateLegacyEditPlanCourseField();
            updateSelectedEditCoursesCount();
            updatePlanEditPreview();
            showToast('SeleÃ§Ã£o de cursos foi limpa', 'info');
        }

        // Update selected courses count in edit page
        function updateSelectedEditCoursesCount() {
            const selectedCount = document.querySelectorAll('#editCoursesGrid input[name="planCourses"]:checked').length;
            const element = document.getElementById('editCoursesSelectedCount');
            if (element) {
                element.textContent = `${selectedCount} cursos selecionados`;
            }
            
            // Show/hide validation alerts
            const validationAlert = document.getElementById('coursesValidationAlert');
            const successAlert = document.getElementById('coursesSuccessAlert');
            
            if (selectedCount === 0) {
                if (validationAlert) {
                    validationAlert.style.display = 'block';
                }
                if (successAlert) {
                    successAlert.style.display = 'none';
                }
            } else {
                if (validationAlert) {
                    validationAlert.style.display = 'none';
                }
                if (successAlert) {
                    successAlert.style.display = 'block';
                }
            }
        }

        // Update legacy plan course field for compatibility in edit page
        function updateLegacyEditPlanCourseField() {
            const legacySelect = document.getElementById('editPlanCourse');
            const selectedCourses = document.querySelectorAll('#editCoursesGrid .course-checkbox:checked');
            
            // Clear existing options
            legacySelect.innerHTML = '';
            
            // Add selected courses as options
            selectedCourses.forEach(checkbox => {
                const courseId = checkbox.dataset.courseId;
                const card = checkbox.closest('.course-card');
                const courseName = card.querySelector('h4').textContent;
                
                const option = document.createElement('option');
                option.value = courseId;
                option.textContent = courseName;
                option.selected = true;
                legacySelect.appendChild(option);
            });
        }

        // Update plan preview in edit page (Enhanced for new tab system)
        function updatePlanEditPreview() {
            const courseSelect = document.getElementById('editPlanCourse');
            const categorySelect = document.getElementById('editPlanCategory');
            const billingTypeSelect = document.getElementById('editPlanBillingType');
            const classesPerWeekSelect = document.getElementById('editPlanClassesPerWeek');
            
            const selectedCourses = Array.from(courseSelect.selectedOptions).map(option => option.text);
            const courseName = selectedCourses.length > 0 ? selectedCourses.join(', ') : 'Nenhum curso selecionado';
            const category = categorySelect.value;
            const billingType = billingTypeSelect?.value || 'MONTHLY';
            const classesPerWeek = classesPerWeekSelect?.value || '2';
            
            // Suggested category prices mapping (not enforced)
            const suggestedCategoryPrices = {
                'ADULT': '180.00',
                'FEMALE': '170.00',
                'SENIOR': '130.00',
                'CHILD': '120.00',
                'INICIANTE1': '120.00',
                'INICIANTE2': '130.00',
                'INICIANTE3': '140.00',
                'HEROI1': '160.00',
                'HEROI2': '170.00',
                'HEROI3': '180.00',
                'MASTER_1': '200.00',
                'MASTER_2': '220.00',
                'MASTER_3': '250.00'
            };
            
            const selectedCount = courseSelect.selectedOptions.length;
            const planName = selectedCount === 0 ? 'Novo Plano' :
                selectedCount === 1 ? `${courseName} - ${category}` : 
                `Multi-Curso (${selectedCount} cursos) - ${category}`;
            
            const customPrice = document.getElementById('editPlanPrice')?.value || '';
            
            // Only suggest price if field is completely empty, don't enforce it
            if (!customPrice && category) {
                const suggestedPrice = suggestedCategoryPrices[category] || '150.00';
                const adjustedPrice = selectedCount > 1 ? 
                    (parseFloat(suggestedPrice) * 1.5).toFixed(2) : suggestedPrice;
                
                // Set placeholder instead of value, so user can choose
                document.getElementById('editPlanPrice').placeholder = `SugestÃ£o: R$ ${adjustedPrice}`;
            }
            
            const price = customPrice || '0.00';
            
            // Update preview elements
            document.getElementById('editPreviewPlanName').textContent = planName;
            document.getElementById('editPreviewPlanPrice').textContent = `R$ ${parseFloat(price || 0).toFixed(2)}`;
            
            const description = selectedCount === 0 ? 'Selecione pelo menos um curso para continuar' :
                selectedCount === 1 ? `Plano ${category.toLowerCase()} para ${courseName}` :
                `Plano ${category.toLowerCase()} com acesso a ${selectedCount} cursos: ${courseName}`;
            document.getElementById('editPreviewPlanDescription').textContent = description;
            
            // Update detailed preview information
            const categoryNames = {
                'ADULT': 'Adulto',
                'FEMALE': 'Feminino',
                'SENIOR': 'Senior/Idoso',
                'CHILD': 'Infantil/CrianÃ§a',
                'INICIANTE1': 'Iniciante 1',
                'INICIANTE2': 'Iniciante 2',
                'INICIANTE3': 'Iniciante 3',
                'HEROI1': 'HerÃ³i 1',
                'HEROI2': 'HerÃ³i 2',
                'HEROI3': 'HerÃ³i 3',
                'MASTER_1': 'Master 1',
                'MASTER_2': 'Master 2',
                'MASTER_3': 'Master 3'
            };
            
            const billingTypeNames = {
                'MONTHLY': 'Mensal',
                'WEEKLY': 'Semanal',
                'QUARTERLY': 'Trimestral',
                'YEARLY': 'Anual'
            };
            
            document.getElementById('editPreviewCategory').textContent = categoryNames[category] || category || 'NÃ£o definida';
            document.getElementById('editPreviewBillingType').textContent = billingTypeNames[billingType] || billingType;
            document.getElementById('editPreviewCourses').textContent = selectedCount > 0 ? courseName : 'Nenhum curso selecionado';
            document.getElementById('editPreviewClassesPerWeek').textContent = classesPerWeek === 'unlimited' ? 'Ilimitado' : `${classesPerWeek} aulas`;
            
            // Auto-fill form fields
            const nameField = document.getElementById('editPlanName');
            const descField = document.getElementById('editPlanDescription');
            
            if (nameField && !nameField.value) {
                nameField.value = planName;
            }
            if (descField && !descField.value && selectedCount > 0) {
                descField.value = description;
            }
        }

        // Edit Plan function - open plan edit page in edit mode
        function editPlan(planId) {
            console.log('âœï¸ Opening edit plan page for:', planId);
            console.log('ðŸ” Debug: allPlans array:', allPlans);
            
            // Find the plan to edit
            const plan = allPlans.find(p => p.id === planId);
            if (!plan) {
                console.error('âŒ Plan not found in allPlans:', planId);
                console.error('ðŸ“‹ Available plans:', allPlans.map(p => ({ id: p.id, name: p.name })));
                showToast('Plano nÃ£o encontrado', 'error');
                return;
            }
            
            console.log('âœ… Plan found:', plan);
            
            // Clear form and populate with existing data
            clearPlanEditForm();
            populatePlanEditForm(plan);
            
            // Update page title
            updatePlanEditPageTitle('Editar Plano', `Editando: ${plan.name}`);
            
            // Navigate to plan edit page
            showSection('plan-edit');
            
            // Set form to edit mode
            const form = document.getElementById('planEditForm');
            if (form) {
                form.dataset.mode = 'edit';
                form.dataset.editingPlanId = planId;
                console.log('âœ… Form mode set to edit, plan ID:', planId);
                console.log('ðŸ” Form dataset after setting:', form.dataset);
            } else {
                console.error('âŒ Form not found: planEditForm');
            }
            
            // Store current plan ID globally
            window.currentPlanId = planId;
            console.log('âœ… Global currentPlanId set to:', planId);
            
            showToast('Carregando dados do plano...', 'info');
        }

        

        // Filter Plans function
        function filterPlans() {
            console.log('ðŸ” Filtering payment plans...');
            
            const searchTerm = document.getElementById('planSearchInput')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('categoryFilterSelect')?.value || '';
            const billingTypeFilter = document.getElementById('billingTypeFilter')?.value || '';
            
            // Make sure allPlans is available
            if (!allPlans || !Array.isArray(allPlans)) {
                console.log('No plans data available for filtering');
                return;
            }
            
            // Filter the plans based on criteria
            const filteredPlans = allPlans.filter(plan => {
                // Search term filter (check name, description, course name)
                const matchesSearch = !searchTerm || 
                    plan.name?.toLowerCase().includes(searchTerm) ||
                    plan.description?.toLowerCase().includes(searchTerm) ||
                    (plan.course?.name || '').toLowerCase().includes(searchTerm);
                
                // Category filter
                const matchesCategory = !categoryFilter || plan.category === categoryFilter;
                
                // Billing type filter
                const matchesBillingType = !billingTypeFilter || plan.billingType === billingTypeFilter;
                
                return matchesSearch && matchesCategory && matchesBillingType;
            });
            
            console.log(`Filtered ${filteredPlans.length} plans from ${allPlans.length} total`);
            
            // Update the table with filtered results
            updatePaymentPlansTable(filteredPlans);
            
            // Update the count text
            document.getElementById('plansCountText').textContent = 
                `${filteredPlans.length} plano(s) encontrado(s) ${filteredPlans.length !== allPlans.length ? `(filtrado de ${allPlans.length})` : ''}`;
        }

        // Edit Plan function
        async function editPlanModal(planId) {
            try {
                console.log(`âœï¸ Editing plan ${planId} (Modal Version)`);
                
                // Fetch plan details from API
                const response = await fetch(`/api/billing-plans`);
                const result = await response.json();
                
                if (!result.success) {
                    console.error('âŒ Error fetching plans:', result.error);
                    showToast('Erro ao carregar planos: ' + result.message, 'error');
                    return;
                }
                
                // Find the specific plan
                const plan = result.data.find(p => p.id === planId);
                if (!plan) {
                    showToast('Plano nÃ£o encontrado', 'error');
                    return;
                }
                
                console.log('ðŸ“‹ Plan data loaded:', plan);
                
                // Populate form with current values
                const editForm = `
                <div style="max-width: 600px; margin: 0 auto; padding: 2rem; background: #1E293B; border-radius: 12px;">
                    <h3 style="color: #3B82F6; margin-bottom: 1.5rem;">âœï¸ Editar Plano</h3>
                    <form id="editPlanForm" onsubmit="submitPlanEdit(event, '${planId}')">
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">Nome do Plano:</label>
                            <input type="text" id="editPlanName" value="${plan.name || ''}" 
                                   style="width: 100%; padding: 0.75rem; background: #374151; border: 1px solid #4B5563; border-radius: 8px; color: white;" required>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">DescriÃ§Ã£o:</label>
                            <textarea id="editPlanDescription" rows="3" 
                                      style="width: 100%; padding: 0.75rem; background: #374151; border: 1px solid #4B5563; border-radius: 8px; color: white;">${plan.description || ''}</textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">Categoria:</label>
                                <select id="editPlanCategory" style="width: 100%; padding: 0.75rem; background: #374151; border: 1px solid #4B5563; border-radius: 8px; color: white;">
                                    <option value="ADULT" ${plan.category === 'ADULT' ? 'selected' : ''}>Adulto</option>
                                    <option value="CHILD" ${plan.category === 'CHILD' ? 'selected' : ''}>Infantil</option>
                                    <option value="SENIOR" ${plan.category === 'SENIOR' ? 'selected' : ''}>Senior</option>
                                    <option value="FEMALE" ${plan.category === 'FEMALE' ? 'selected' : ''}>Feminino</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">PreÃ§o (R$):</label>
                                <input type="number" id="editPlanPrice" value="${plan.price || ''}" step="0.01" 
                                       style="width: 100%; padding: 0.75rem; background: #374151; border: 1px solid #4B5563; border-radius: 8px; color: white;" required>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">Tipo de CobranÃ§a:</label>
                                <select id="editPlanBillingType" style="width: 100%; padding: 0.75rem; background: #374151; border: 1px solid #4B5563; border-radius: 8px; color: white;">
                                    <option value="MONTHLY" ${plan.billingType === 'MONTHLY' ? 'selected' : ''}>Mensal</option>
                                    <option value="QUARTERLY" ${plan.billingType === 'QUARTERLY' ? 'selected' : ''}>Trimestral</option>
                                    <option value="YEARLY" ${plan.billingType === 'YEARLY' ? 'selected' : ''}>Anual</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">Aulas por Semana:</label>
                                <input type="number" id="editPlanClassesPerWeek" value="${plan.classesPerWeek || 2}" min="1" max="7" 
                                       style="width: 100%; padding: 0.75rem; background: #374151; border: 1px solid #4B5563; border-radius: 8px; color: white;">
                            </div>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">
                                <input type="checkbox" id="editPlanIsActive" ${plan.isActive ? 'checked' : ''} style="margin-right: 0.5rem;">
                                Plano Ativo
                            </label>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" onclick="closeEditPlanModal()" 
                                    style="padding: 0.75rem 1.5rem; background: #4B5563; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Cancelar
                            </button>
                            <button type="submit" 
                                    style="padding: 0.75rem 1.5rem; background: #3B82F6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Salvar AlteraÃ§Ãµes
                            </button>
                        </div>
                    </form>
                </div>`;
                
                // Create modal overlay
                const modalOverlay = document.createElement('div');
                modalOverlay.id = 'editPlanModal';
                modalOverlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; 
                    justify-content: center; z-index: 1000;
                `;
                modalOverlay.innerHTML = editForm;
                
                document.body.appendChild(modalOverlay);
                
            } catch (error) {
                console.error('âŒ Error in editPlan:', error);
                showToast('Erro ao abrir editor de plano: ' + error.message, 'error');
            }
        }

        // Submit plan edit
        async function submitPlanEdit(event, planId) {
            event.preventDefault();
            
            try {
                // Get the form element
                const form = event.target;
                
                const formData = {
                    name: form.querySelector('#editPlanName').value,
                    description: form.querySelector('#editPlanDescription').value,
                    category: form.querySelector('#editPlanCategory').value,
                    price: parseFloat(form.querySelector('#editPlanPrice').value),
                    billingType: form.querySelector('#editPlanBillingType').value,
                    classesPerWeek: parseInt(form.querySelector('#editPlanClassesPerWeek').value),
                    isActive: form.querySelector('#editPlanIsActive').checked
                };
                
                console.log('ðŸ“¤ Updating plan:', formData);
                
                const response = await fetch(`/api/billing-plans/${planId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('âœ… Plano atualizado com sucesso!', 'success');
                    closeEditPlanModal();
                    // Reload plans table
                    loadPaymentPlansList();
                } else {
                    showToast('âŒ Erro ao atualizar plano: ' + result.message, 'error');
                }
                
            } catch (error) {
                console.error('âŒ Error updating plan:', error);
                showToast('Erro ao atualizar plano: ' + error.message, 'error');
            }
        }

        // Close edit plan modal
        function closeEditPlanModal() {
            const modal = document.getElementById('editPlanModal');
            if (modal) {
                modal.remove();
            }
        }

        // Delete Plan function for table (REMOVED - using deletePlanFromTable instead)

        // ==========================================
        // REMOVED DUPLICATE FUNCTION - USING VERSION ABOVE
        // ==========================================

        // ==========================================
        // AUTO-LOAD DATA FOR INFRASTRUCTURE SECTIONS (Already handled above)
        // ==========================================

        // ==========================================
        // STUDENT TABLE INITIALIZATION (PERMANENT FIX)
        // ==========================================
        
        // Initialize student table event delegation when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Initializing student table event delegation...');
            
            // Setup event delegation after a small delay to ensure DOM is ready
            setTimeout(() => {
                setupStudentTableEventDelegation();
                console.log('âœ… Student table event delegation initialized on page load');
            }, 500);
        });
        
        // Backup initialization for cases where DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            // DOMContentLoaded will handle it
        } else {
            // DOM is already ready
            setTimeout(() => {
                setupStudentTableEventDelegation();
                console.log('âœ… Student table event delegation initialized (DOM already ready)');
            }, 100);
        }

        // Plan Edit Functions
        let currentPlanId = null;
        
        // Emergency navigation function for payment plans
        function forceNavigateToPaymentPlans() {
            console.log('ðŸš¨ Emergency navigation to payment plans');
            
            // Method 1: Hide all sections manually
            const allSections = document.querySelectorAll('.content-section');
            allSections.forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            // Method 2: Show payment plans section
            const paymentPlansSection = document.getElementById('payment-plans');
            if (paymentPlansSection) {
                paymentPlansSection.classList.add('active');
                paymentPlansSection.style.display = 'block';
                console.log('âœ… Payment plans section shown');
            }
            
            // Method 3: Update navigation state
            const navButtons = document.querySelectorAll('.nav-link');
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            const plansButton = document.querySelector('[data-page="payment-plans"]');
            if (plansButton) {
                plansButton.classList.add('active');
                console.log('âœ… Navigation button activated');
            }
            
            // Method 4: Reload plans list
            if (typeof loadPaymentPlansList === 'function') {
                loadPaymentPlansList();
            }
            
            // Clear any global state
            currentPlanId = null;
            
            console.log('âœ… Emergency navigation completed');
        }
        
        // Debug function to test navigation
        window.debugNavigation = function() {
            console.log('ðŸ” DEBUGGING NAVIGATION');
            console.log('Current sections:', Array.from(document.querySelectorAll('.content-section')).map(s => ({
                id: s.id,
                active: s.classList.contains('active'),
                display: s.style.display || 'default'
            })));
            console.log('Payment plans section:', document.getElementById('payment-plans'));
            console.log('Plan edit section:', document.getElementById('plan-edit'));
            console.log('Navigation buttons:', Array.from(document.querySelectorAll('.nav-link')).map(b => ({
                text: b.textContent.trim(),
                page: b.getAttribute('data-page'),
                active: b.classList.contains('active')
            })));
        };

        // openPlanEditPage function moved to DOMContentLoaded event handler above

        window.populatePlanEditForm = async function(plan) {
            console.log('ðŸ“ Populating comprehensive form with plan data:', plan);
            
            try {
                // Helper function to safely set element value
                const safeSetValue = (elementId, value) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.value = value || '';
                        console.log(`âœ… Set ${elementId} = ${value}`);
                    } else {
                        console.warn(`âš ï¸ Element not found: ${elementId}`);
                    }
                };

                // Helper function to safely set checkbox
                const safeSetCheckbox = (elementId, checked) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.checked = checked;
                        console.log(`âœ… Set checkbox ${elementId} = ${checked}`);
                    } else {
                        console.warn(`âš ï¸ Checkbox not found: ${elementId}`);
                    }
                };

                // Basic information
                safeSetValue('editPlanName', plan.name);
                safeSetValue('editPlanDescription', plan.description);
                safeSetValue('editPlanCourse', plan.courseId);
                safeSetValue('editPlanCategory', plan.category);
                
                // Financial settings
                safeSetValue('editPlanPrice', plan.price);
                safeSetValue('editPlanBillingType', plan.billingType || 'MONTHLY');
                safeSetValue('editPlanClassesPerWeek', plan.weeklyClasses || 2);
                safeSetValue('editPlanWeeklyClasses', plan.weeklyClasses || 2);
                safeSetValue('editPlanDuration', plan.duration || 12);
                safeSetValue('editPlanGracePeriod', plan.gracePeriod || 0);
                
                // Sync the fields if the function exists
                if (typeof syncWeeklyClassesField === 'function') {
                    syncWeeklyClassesField();
                }
                
                // Features (default to checked for demonstration)
                safeSetCheckbox('editPlanFeatureAccess', true);
                safeSetCheckbox('editPlanFeatureEquipment', plan.category === 'ADULT');
                safeSetCheckbox('editPlanFeatureNutrition', plan.hasNutrition || plan.category === 'ADULT');
                safeSetCheckbox('editPlanFeaturePersonal', plan.hasPersonalTraining || false);
                safeSetCheckbox('editPlanFeatureEvents', true);
                safeSetCheckbox('editPlanFeatureMaterial', true);
                
                // Status and configurations
                safeSetCheckbox('editPlanIsActive', plan.isActive !== false);
                safeSetCheckbox('editPlanAllowUpgrade', true);
                safeSetCheckbox('editPlanAutoRenewal', true);
                safeSetValue('editPlanStudentLimit', plan.studentLimit);
                safeSetValue('editPlanNotes', plan.notes);

                console.log('âœ… Comprehensive form populated successfully');
            } catch (error) {
                console.error('âŒ Error populating comprehensive form:', error);
                showNotification('Erro ao carregar dados do plano', 'error');
            }
        }

        // Note: backToPlans() function is defined later in the code to avoid duplication

        // Clear plan edit form for creation mode
        function clearPlanEditForm() {
            console.log('ðŸ§¹ Clearing plan edit form...');
            
            // Helper function to safely clear element value
            const safeClearValue = (elementId, value = '') => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = value;
                }
            };
            
            // Helper function to safely set checkbox
            const safeClearCheckbox = (elementId, checked = false) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.checked = checked;
                }
            };
            
            // Clear all form fields
            safeClearValue('editPlanName');
            safeClearValue('editPlanDescription');
            safeClearValue('editPlanCourse');
            safeClearValue('editPlanCategory');
            safeClearValue('editPlanPrice');
            safeClearValue('editPlanBillingType', 'MONTHLY');
            safeClearValue('editPlanWeeklyClasses', '2');
            safeClearValue('editPlanDuration', '30');
            safeClearValue('editPlanGracePeriod', '5');
            safeClearCheckbox('editPlanIsActive', true);
            safeClearCheckbox('editPlanAllowUpgrade', true);
            safeClearCheckbox('editPlanAutoRenewal', false);
            safeClearValue('editPlanStudentLimit');
            safeClearValue('editPlanNotes');
        }

        // Sync the visible select field with the hidden field
        function syncWeeklyClassesField() {
            const selectField = document.getElementById('editPlanClassesPerWeek');
            const hiddenField = document.getElementById('editPlanWeeklyClasses');
            
            if (selectField && hiddenField) {
                const value = selectField.value;
                hiddenField.value = value === 'unlimited' ? 999 : value;
            }
        }

        // Update plan edit page title and subtitle
        function updatePlanEditPageTitle(title, subtitle) {
            console.log('ðŸ“ Updating plan edit page title:', title);
            
            const titleElement = document.querySelector('#plan-edit h1');
            const subtitleElement = document.getElementById('planEditSubtitle');
            
            if (titleElement) {
                titleElement.innerHTML = title.includes('âœï¸') ? title : `âœï¸ ${title}`;
            }
            
            if (subtitleElement) {
                subtitleElement.textContent = subtitle;
            }
        }

        // Back to plans function with enhanced debugging
        function backToPlans() {
            console.log('ðŸ”™ Returning to plans list...');
            console.log('ðŸ“ Current section before:', document.querySelector('.content-section.active')?.id);
            
            // Clear any plan-specific data
            currentPlanId = null;
            
            // Try multiple approaches to ensure navigation works
            try {
                // Method 1: Hide current section and show target section directly
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });
                
                // Show payment plans section
                const paymentPlansSection = document.getElementById('payment-plans');
                if (paymentPlansSection) {
                    paymentPlansSection.classList.add('active');
                    paymentPlansSection.style.display = 'block';
                    console.log('âœ… Payment plans section shown directly');
                } else {
                    console.error('âŒ Payment plans section not found');
                }
                
                // Method 2: Also try with showSection function
                if (typeof showSection === 'function') {
                    showSection('payment-plans');
                    console.log('âœ… Called showSection function');
                } else {
                    console.error('âŒ showSection function not found');
                }
                
                // Method 3: Emergency navigation as fallback
                setTimeout(() => {
                    const currentSection = document.querySelector('.content-section.active');
                    if (!currentSection || currentSection.id !== 'payment-plans') {
                        console.log('ðŸš¨ Normal navigation failed, using emergency method');
                        forceNavigateToPaymentPlans();
                    }
                }, 100);
                
                // Update navigation button state
                document.querySelectorAll('.nav-link').forEach(button => {
                    button.classList.remove('active');
                });
                
                const plansNavButton = document.querySelector('[data-page="payment-plans"]');
                if (plansNavButton) {
                    plansNavButton.classList.add('active');
                    console.log('âœ… Navigation button activated');
                } else {
                    console.error('âŒ Navigation button not found');
                }
                
                // Refresh the plans list
                if (typeof loadPaymentPlansList === 'function') {
                    loadPaymentPlansList();
                    console.log('âœ… Plans list refreshed');
                }
                
                console.log('ðŸ“ Current section after:', document.querySelector('.content-section.active')?.id);
                
                // Show success message
                if (typeof showToast === 'function') {
                    showToast('Voltou para lista de planos', 'info');
                } else {
                    console.log('âœ… Voltou para lista de planos');
                }
                
            } catch (error) {
                console.error('âŒ Error in backToPlans:', error);
                alert('Erro ao voltar para lista de planos. Veja o console para detalhes.');
            }
        }

        // FunÃ§Ã£o de teste para debug do salvamento
        function testSavePlanDebug() {
            console.log('ðŸ§ª ===== TESTE DE DEBUG DO SALVAMENTO =====');
            
            // Preencher campos obrigatÃ³rios automaticamente
            const nameField = document.getElementById('editPlanName');
            const categoryField = document.getElementById('editPlanCategory');
            const priceField = document.getElementById('editPlanPrice');
            
            if (nameField) nameField.value = 'Plano Teste Debug';
            if (categoryField) categoryField.value = 'ADULT';
            if (priceField) priceField.value = '150';
            
            console.log('âœ… Campos obrigatÃ³rios preenchidos automaticamente');
            
            // Tentar executar salvamento
            if (typeof savePlanChanges === 'function') {
                console.log('âœ… FunÃ§Ã£o savePlanChanges encontrada, executando...');
                savePlanChanges();
            } else {
                console.log('âŒ FunÃ§Ã£o savePlanChanges nÃ£o encontrada');
            }
            
            console.log('ðŸ§ª ===== FIM DO TESTE =====');
        }

        async function savePlanChanges() {
            console.log('ðŸ’¾ Iniciando salvamento de plano...');
            
            const form = document.getElementById('planEditForm');
            
            // Enhanced form mode detection
            const formMode = form?.dataset?.mode;
            const formEditingPlanId = form?.dataset?.editingPlanId;
            const globalCurrentPlanId = window.currentPlanId;
            
            // Determine if we're in create mode
            const isCreateMode = formMode === 'create';
            
            // Determine the current plan ID for edit mode
            const currentPlanId = formEditingPlanId || globalCurrentPlanId;
            
            console.log('ðŸ” ID Resolution Debug:');
            console.log('  - formEditingPlanId:', formEditingPlanId);
            console.log('  - globalCurrentPlanId:', globalCurrentPlanId);
            console.log('  - Final currentPlanId:', currentPlanId);
            
            console.log('ðŸ“‹ Modo de operaÃ§Ã£o:', isCreateMode ? 'CriaÃ§Ã£o' : 'EdiÃ§Ã£o');
            console.log('ðŸ“‹ Form encontrado:', !!form);
            
            // Enhanced debugging - log current status
            console.log('ðŸ” Enhanced Debug - Current State:');
            console.log('- Form element:', form);
            console.log('- Form mode:', formMode);
            console.log('- Form editing plan ID:', formEditingPlanId);
            console.log('- Global current plan ID:', globalCurrentPlanId);
            console.log('- Final current plan ID:', currentPlanId);
            console.log('- isCreateMode:', isCreateMode);
            
            // Validate that we have a plan ID for edit mode
            if (!isCreateMode && !currentPlanId) {
                console.error('âŒ Erro: Tentando editar plano sem ID vÃ¡lido');
                showToast('Erro: ID do plano nÃ£o encontrado para ediÃ§Ã£o', 'error');
                return;
            }
            
            // Helper function to safely get element value
            const safeGetValue = (elementId, defaultValue = '') => {
                const element = document.getElementById(elementId);
                return element ? element.value : defaultValue;
            };
            
            // Helper function to safely get checkbox state
            const safeGetChecked = (elementId, defaultValue = false) => {
                const element = document.getElementById(elementId);
                return element ? element.checked : defaultValue;
            };
            
            // Collect selected courses from the simplified interface
            const selectedCourseCheckboxes = document.querySelectorAll('#editCoursesGrid input[name="planCourses"]:checked');
            const selectedCourseIds = Array.from(selectedCourseCheckboxes).map(cb => cb.value);
            
            console.log('ðŸŽ“ Cursos selecionados:', selectedCourseIds);
            console.log('ðŸŽ“ Checkboxes encontradas:', selectedCourseCheckboxes.length);
            console.log('ðŸŽ“ Grid de cursos:', document.getElementById('editCoursesGrid'));
            
            // Debug: Log all form elements before collecting data
            console.log('ðŸ” Debug - Verificando elementos do formulÃ¡rio:');
            console.log('- editPlanMaxClasses:', document.getElementById('editPlanMaxClasses')?.value);
            console.log('- editPlanDuration:', document.getElementById('editPlanDuration')?.value);
            console.log('- editPlanGracePeriod:', document.getElementById('editPlanGracePeriod')?.value);
            console.log('- editPlanPersonalTraining:', document.getElementById('editPlanPersonalTraining')?.checked);
            console.log('- editPlanNotes:', document.getElementById('editPlanNotes')?.value);
            
            // Enhanced course data for API (moved before formData)
            const courseData = {
                primaryCourseId: selectedCourseIds.length > 0 ? selectedCourseIds[0] : null,
                allCourseIds: selectedCourseIds,
                courseCount: selectedCourseIds.length
            };
            
            console.log('ðŸŽ“ [SAVE_DEBUG] Checkboxes encontradas:', selectedCourseCheckboxes);
            console.log('ðŸŽ“ [SAVE_DEBUG] Dados de curso para API:', courseData);
            console.log('ðŸŽ“ [SAVE_DEBUG] IDs extraÃ­dos:', selectedCourseIds);
            
            // Collect form data with correct field IDs
            const formData = {
                // Basic Information (Schema Fields)
                name: safeGetValue('editPlanName'),
                description: safeGetValue('editPlanDescription'),
                courseId: courseData.primaryCourseId,
                courseIds: selectedCourseIds, // Add courseIds at top level for backend compatibility
                category: safeGetValue('editPlanCategory'),
                price: parseFloat(safeGetValue('editPlanPrice', '0')),
                billingType: safeGetValue('editPlanBillingType', 'MONTHLY'),
                
                // Schema Fields - Advanced Configuration
                classesPerWeek: parseInt(safeGetValue('editPlanClassesPerWeek', '2')) || 2,
                maxClasses: safeGetValue('editPlanMaxClasses') ? parseInt(safeGetValue('editPlanMaxClasses')) : null,
                isUnlimitedAccess: safeGetChecked('editPlanFeatureAccess', true),
                
                // Schema Fields - Features
                hasPersonalTraining: safeGetChecked('editPlanPersonalTraining') || safeGetChecked('editPlanFeaturePersonal'),
                hasNutrition: safeGetChecked('editPlanNutrition') || safeGetChecked('editPlanFeatureNutrition'),
                accessAllModalities: safeGetChecked('editPlanAllModalities'),
                allowFreeze: safeGetChecked('editPlanFreezeOption'),
                freezeMaxDays: 30,
                
                // Schema Fields - Payment Configuration  
                allowInstallments: false,
                maxInstallments: 1,
                isRecurring: safeGetValue('editPlanBillingType', 'MONTHLY') === 'MONTHLY',
                recurringInterval: safeGetValue('editPlanBillingType', 'MONTHLY') === 'MONTHLY' ? 30 : null,
                
                // Schema Fields - Status
                isActive: safeGetChecked('editPlanIsActive', true),
                
                // Custom Features (JSON field) - Store additional configurations
                features: {
                    // Advanced Configuration (not in schema)
                    duration: safeGetValue('editPlanDuration') ? parseInt(safeGetValue('editPlanDuration')) : 12,
                    gracePeriod: safeGetValue('editPlanGracePeriod') ? parseInt(safeGetValue('editPlanGracePeriod')) : 5,
                    studentLimit: safeGetValue('editPlanStudentLimit') ? parseInt(safeGetValue('editPlanStudentLimit')) : null,
                    
                    // Extra Features (not in schema)
                    hasFullAccess: safeGetChecked('editPlanFeatureAccess'),
                    hasEquipmentAccess: safeGetChecked('editPlanFeatureEquipment'),
                    hasEventAccess: safeGetChecked('editPlanFeatureEvents'),
                    hasMaterialAccess: safeGetChecked('editPlanFeatureMaterial'),
                    
                    // Plan Configuration (not in schema)
                    allowUpgrade: safeGetChecked('editPlanAllowUpgrade'),
                    autoRenewal: safeGetChecked('editPlanAutoRenewal'),
                    notes: safeGetValue('editPlanNotes'),
                    
                    // Course Configuration
                    courseIds: selectedCourseIds
                }
            };
            
            // Debug: Log collected form data
            console.log('ðŸ“‹ Dados coletados do formulÃ¡rio:', JSON.stringify(formData, null, 2));
            console.log('ðŸ“‹ Validando campos obrigatÃ³rios...');
            console.log('- Nome:', formData.name || 'VAZIO');
            console.log('- Categoria:', formData.category || 'VAZIO');
            console.log('- PreÃ§o:', formData.price || 'VAZIO');
            
            // Validate required fields
            if (!formData.name || !formData.price) {
                showToast('Preencha todos os campos obrigatÃ³rios (Nome e PreÃ§o)', 'error');
                return;
            }
            
            // Set default category if empty
            if (!formData.category) {
                formData.category = 'ADULT'; // Default category
                console.log('ðŸ“‹ Categoria definida como padrÃ£o: ADULT');
            }
            
            // Validate course selection (relaxed validation)
            if (selectedCourseIds.length === 0) {
                console.log('âš ï¸ Nenhum curso selecionado, mas permitindo salvamento');
                showToast('Aviso: Nenhum curso foi associado ao plano', 'warning');
                // Continue with saving instead of blocking
            } else {
                console.log(`âœ… ${selectedCourseIds.length} curso(s) selecionado(s)`);
                showToast(`${selectedCourseIds.length} curso(s) associado(s) ao plano`, 'success');
            }
            
            try {
                console.log('ðŸš€ Preparando para enviar dados para API...');
                console.log('ðŸ” Debug - Dados que serÃ£o enviados:', JSON.stringify(formData, null, 2));
                
                if (isCreateMode) {
                    console.log('âœ¨ Modo criaÃ§Ã£o - enviando para POST /api/billing-plans');
                    showToast('Criando novo plano...', 'info');
                    
                    console.log('ðŸ“¡ Fazendo requisiÃ§Ã£o POST para /api/billing-plans');
                    
                    // Create new plan via API
                    const response = await fetch('/api/billing-plans', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    console.log('ðŸ“¡ Resposta recebida:', response.status, response.statusText);
                    
                    const result = await response.json();
                    console.log('ðŸ“¡ Dados da resposta:', result);
                    
                    if (response.ok && result.success) {
                        console.log('âœ… Plano criado com sucesso via API');
                        // Add to local array
                        allPlans.push(result.data);
                        showToast('Plano criado com sucesso!', 'success');
                    } else {
                        console.error('âŒ Erro na resposta da API:', result);
                        throw new Error(result.message || result.error || 'Erro ao criar plano');
                    }
                    
                } else {
                    console.log('ðŸ”„ Modo ediÃ§Ã£o - enviando para PUT /api/billing-plans/' + currentPlanId);
                    console.log('ðŸŽ“ [SAVE_DEBUG] Cursos sendo enviados:', formData.features.courseIds);
                    console.log('ðŸ” [SAVE_DEBUG] FormData completo antes do envio:', JSON.stringify(formData, null, 2));
                    showToast('Atualizando plano...', 'info');
                    
                    console.log('ðŸ“¡ Fazendo requisiÃ§Ã£o PUT para /api/billing-plans/' + currentPlanId);
                    
                    // Update existing plan via API
                    const response = await fetch(`/api/billing-plans/${currentPlanId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    console.log('ðŸ“¡ Resposta recebida:', response.status, response.statusText);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('ðŸ“¡ Dados da resposta:', result);
                        
                        if (result.success) {
                            console.log('âœ… Plano atualizado com sucesso via API');
                            
                            // Update local data with the actual response data
                            const planIndex = allPlans.findIndex(p => p.id === currentPlanId);
                            if (planIndex !== -1) {
                                // Update with data from API response
                                allPlans[planIndex] = { ...allPlans[planIndex], ...result.data };
                                console.log('âœ… Local data updated with API response');
                            } else {
                                console.warn('âš ï¸ Plan not found in allPlans array for local update');
                            }
                            
                            showToast('Plano atualizado com sucesso!', 'success');
                        } else {
                            console.error('âŒ Erro na resposta da API:', result);
                            throw new Error(result.message || 'Erro ao atualizar plano');
                        }
                    } else {
                        console.error('âŒ Erro HTTP:', response.status, response.statusText);
                        throw new Error('Erro na API ao atualizar plano');
                    }
                }
                
                console.log('ðŸ”™ Voltando para lista de planos...');
                // Go back to plans list and refresh
                backToPlans();
                console.log('âœ… Processo de salvamento concluÃ­do!');
                
            } catch (error) {
                console.error('ðŸ’¥ Erro durante salvamento:', error);
                console.error('ðŸ’¥ Stack trace:', error.stack);
                showToast(`Erro ao salvar plano: ${error.message}`, 'error');
            }
        }

        // Test function to debug the save plan process
        function testSavePlanDebugEnhanced() {
            console.log('ðŸ§¦ ===== TESTE DE DEBUG MELHORADO =====');
            
            // Test form presence
            const form = document.getElementById('planEditForm');
            console.log('1. Form encontrado:', !!form);
            
            if (!form) {
                console.error('âŒ Form nÃ£o encontrado! Verifique se estÃ¡ na tela de ediÃ§Ã£o de plano.');
                return;
            }
            
            console.log('2. Form mode:', form.dataset.mode);
            console.log('3. currentPlanId:', window.currentPlanId);
            
            // Test required fields
            const nameField = document.getElementById('editPlanName');
            const categoryField = document.getElementById('editPlanCategory');
            const priceField = document.getElementById('editPlanPrice');
            
            console.log('4. Campos obrigatÃ³rios:');
            console.log('   - Nome:', nameField?.value || 'VAZIO');
            console.log('   - Categoria:', categoryField?.value || 'VAZIO');
            console.log('   - PreÃ§o:', priceField?.value || 'VAZIO');
            
            // Auto-fill if empty
            if (!nameField?.value) {
                nameField.value = 'Plano Teste Debug Enhanced';
                console.log('   âœ… Nome preenchido automaticamente');
            }
            if (!categoryField?.value) {
                categoryField.value = 'ADULT';
                console.log('   âœ… Categoria preenchida automaticamente');
            }
            if (!priceField?.value) {
                priceField.value = '199.99';
                console.log('   âœ… PreÃ§o preenchido automaticamente');
            }
            
            console.log('5. Testando funÃ§Ã£o savePlanChanges...');
            
            if (typeof savePlanChanges === 'function') {
                console.log('   âœ… FunÃ§Ã£o savePlanChanges encontrada');
                console.log('   ðŸš€ Executando savePlanChanges...');
                
                try {
                    savePlanChanges();
                    console.log('   âœ… savePlanChanges executada sem erro sÃ­ncrono');
                } catch (error) {
                    console.error('   âŒ Erro ao executar savePlanChanges:', error);
                }
            } else {
                console.error('   âŒ FunÃ§Ã£o savePlanChanges nÃ£o encontrada');
            }
        }
        
        // Test function to verify form state
        function testFormState() {
            console.log('ðŸ“‹ ===== TESTE DO ESTADO DO FORMULÃRIO =====');
            
            const form = document.getElementById('planEditForm');
            if (!form) {
                console.error('âŒ Form nÃ£o encontrado');
                return;
            }
            
            console.log('1. Form encontrado:', form);
            console.log('2. Form dataset:', form.dataset);
            console.log('3. Form mode:', form.dataset.mode);
            console.log('4. Editing plan ID:', form.dataset.editingPlanId);
            console.log('5. Global currentPlanId:', window.currentPlanId);
            
            // Test individual fields
            const nameField = document.getElementById('editPlanName');
            const categoryField = document.getElementById('editPlanCategory');
            const priceField = document.getElementById('editPlanPrice');
            
            console.log('6. Campos:');
            console.log('   - Nome:', nameField?.value);
            console.log('   - Categoria:', categoryField?.value);
            console.log('   - PreÃ§o:', priceField?.value);
            
            // Test if we can manually set form mode
            if (form.dataset.mode !== 'edit') {
                console.log('âš ï¸ Tentando definir modo de ediÃ§Ã£o manualmente...');
                form.dataset.mode = 'edit';
                form.dataset.editingPlanId = 'test-plan-id';
                window.currentPlanId = 'test-plan-id';
                console.log('âœ… Modo definido manualmente');
            }
        }
        
        async function deleteCurrentPlan() {
            if (!currentPlanId) {
                showNotification('Erro: ID do plano nÃ£o encontrado', 'error');
                return;
            }
            
            const plan = allPlans.find(p => p.id == currentPlanId || p.id === currentPlanId);
            if (!plan) {
                console.error('âŒ Current plan not found in allPlans array');
                console.error('ðŸ” Searched for ID:', currentPlanId, 'Type:', typeof currentPlanId);
                console.error('ðŸ“‹ Available IDs:', allPlans.map(p => ({id: p.id, type: typeof p.id})));
                showNotification('Plano nÃ£o encontrado', 'error');
                return;
            }
            
            if (!confirm(`Tem certeza que deseja excluir o plano "${plan.name}"?`)) {
                return;
            }
            
            try {
                showNotification('Excluindo plano...', 'info');
                
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Remove from local data
                const planIndex = allPlans.findIndex(p => p.id === currentPlanId);
                if (planIndex !== -1) {
                    allPlans.splice(planIndex, 1);
                }
                
                showNotification('Plano excluÃ­do com sucesso!', 'success');
                
                // Go back to plans list and refresh
                backToPlans();
                updatePaymentPlansTable(allPlans);
                updatePlansStats(allPlans);
                
            } catch (error) {
                console.error('Error deleting plan:', error);
                showNotification('Erro ao excluir plano', 'error');
            }
        }

        // ==========================================
        // STUDENT SUBSCRIPTION TAB LOADER
        // ==========================================

        // Load student subscription tab content
        window.loadStudentSubscriptionTab = async function() {
            console.log('ðŸ’³ Loading student subscription tab...');
            
            const container = document.getElementById('coursesContent');
            if (!container) {
                console.error('âŒ coursesContent container not found');
                return;
            }

            // Show loading state
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #94A3B8;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ’³</div>
                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando dados da assinatura...</div>
                    <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                </div>
            `;

            try {
                // Import and call the subscription function from students.js
                const { getCurrentStudentSubscriptionDetails } = await import('./js/students.js');
                const subscriptionDetails = await getCurrentStudentSubscriptionDetails();
                
                // Import and call the render function
                const studentsModule = await import('./js/students.js');
                if (studentsModule.renderStudentSubscriptionDetails) {
                    studentsModule.renderStudentSubscriptionDetails(subscriptionDetails, container);
                } else {
                    // Fallback to manual rendering
                    console.log('ðŸ“Š Subscription details loaded:', subscriptionDetails);
                    
                    if (!subscriptionDetails.hasSubscription) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: #94A3B8;">
                                <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">ðŸ’³</div>
                                <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">
                                    Nenhuma assinatura ativa
                                </div>
                                <div style="font-size: 0.875rem; margin-bottom: 2rem;">
                                    Este aluno nÃ£o possui uma assinatura de plano ativa
                                </div>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 1.5rem;">
                                <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">ðŸ’³ Assinatura Ativa</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                    <div>
                                        <div style="color: #94A3B8; font-size: 0.875rem;">Plano</div>
                                        <div style="color: #F8FAFC; font-weight: 600;">${subscriptionDetails.plan?.name || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="color: #94A3B8; font-size: 0.875rem;">Status</div>
                                        <div style="color: #10B981; font-weight: 600;">${subscriptionDetails.paymentStatus}</div>
                                    </div>
                                    <div>
                                        <div style="color: #94A3B8; font-size: 0.875rem;">Valor</div>
                                        <div style="color: #10B981; font-weight: 600;">R$ ${parseFloat(subscriptionDetails.plan?.price || 0).toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                console.log('âœ… Student subscription tab loaded successfully');

            } catch (error) {
                console.error('âŒ Error loading subscription tab:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #EF4444;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">âš ï¸</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Erro ao carregar assinatura</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Verifique a conexÃ£o com o servidor</div>
                        <button onclick="window.loadStudentSubscriptionTab()" 
                                style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 1rem;">
                            ðŸ”„ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        };

        // Make renderStudentSubscriptionDetails globally available
        window.createSubscriptionForStudent = function() {
            console.log('âž• Creating subscription for current student...');
            // TODO: Open subscription creation modal with current student pre-selected
            if (window.openAddSubscriptionModal) {
                window.openAddSubscriptionModal();
                // Pre-select current student if possible
                const currentStudentId = window.currentEditingStudentId;
                if (currentStudentId) {
                    setTimeout(() => {
                        const studentSelect = document.getElementById('subscriptionStudent');
                        if (studentSelect) {
                            studentSelect.value = currentStudentId;
                        }
                    }, 500);
                }
            }
        };

        window.editStudentSubscription = function() {
            console.log('âœï¸ Editing subscription for current student...');
            // TODO: Open subscription edit modal
            showToast('Funcionalidade em desenvolvimento', 'info');
        };

        window.viewSubscriptionHistory = function() {
            console.log('ðŸ“Š Viewing subscription history for current student...');
            // TODO: Show subscription payment history
            showToast('Funcionalidade em desenvolvimento', 'info');
        };

        window.viewCourseDetails = function(courseId) {
            console.log('ðŸ“– Viewing course details:', courseId);
            // TODO: Open course details modal or navigate to course page
            showToast('Abrindo detalhes do curso...', 'info');
            // For now, redirect to courses management with course highlighted
            setTimeout(() => {
                showSection('courses');
                // TODO: Add course highlighting logic
            }, 500);
        };

        // ==========================================
        // SUBSCRIPTIONS MANAGEMENT
        // ==========================================

        // Note: allSubscriptions is already declared at line ~18118
        let allStudentsForSubscriptions = [];
        let allPlansForSubscriptions = [];

        // Load subscriptions list
        async function loadSubscriptionsList() {
            console.log('ðŸ”„ Loading subscriptions list...');
            try {
                const loadingElement = document.getElementById('subscriptionsLoadingState');
                const emptyElement = document.getElementById('subscriptionsEmptyState');
                const tableContainer = document.querySelector('#subscriptions .table-container');
                
                if (loadingElement) loadingElement.style.display = 'block';
                if (emptyElement) emptyElement.style.display = 'none';
                if (tableContainer) tableContainer.style.display = 'none';

                // Fetch subscriptions data
                console.log('ðŸ“¡ Fetching subscriptions from API...');
                const subscriptionsResponse = await fetch('/api/subscriptions');
                
                if (subscriptionsResponse.ok) {
                    const subscriptionsData = await subscriptionsResponse.json();
                    allSubscriptions = subscriptionsData.data || [];
                    console.log('âœ… Subscriptions loaded:', allSubscriptions.length);
                } else {
                    console.warn('âš ï¸ Subscriptions API not available, using empty array');
                    allSubscriptions = [];
                }

                // Update UI
                updateSubscriptionsTable(allSubscriptions);
                updateSubscriptionsStats(allSubscriptions);
                updateSubscriptionsCount();

                if (loadingElement) loadingElement.style.display = 'none';
                
                if (allSubscriptions.length === 0) {
                    if (emptyElement) emptyElement.style.display = 'block';
                } else {
                    if (tableContainer) tableContainer.style.display = 'block';
                }

            } catch (error) {
                console.error('âŒ Error loading subscriptions:', error);
                const loadingElement = document.getElementById('subscriptionsLoadingState');
                if (loadingElement) {
                    loadingElement.innerHTML = `
                        <div style="text-align: center; color: #EF4444; padding: 3rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">âš ï¸</div>
                            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Erro ao carregar assinaturas</div>
                            <div style="font-size: 0.9rem; opacity: 0.7;">Verifique a conexÃ£o com a API</div>
                        </div>
                    `;
                }
            }
        }

        // Update subscriptions table
        function updateSubscriptionsTable(subscriptions) {
            const tableBody = document.getElementById('subscriptionsTableBody');
            if (!tableBody) return;

            if (!subscriptions || subscriptions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #94A3B8; padding: 2rem;">Nenhuma assinatura encontrada</td></tr>';
                return;
            }

            tableBody.innerHTML = subscriptions.map(subscription => {
                const statusColors = {
                    'ACTIVE': '#10B981',
                    'PENDING': '#F59E0B',
                    'SUSPENDED': '#EF4444',
                    'CANCELLED': '#6B7280',
                    'EXPIRED': '#374151'
                };

                const statusLabels = {
                    'ACTIVE': 'Ativa',
                    'PENDING': 'Pendente',
                    'SUSPENDED': 'Suspensa',
                    'CANCELLED': 'Cancelada',
                    'EXPIRED': 'Expirada'
                };

                const paymentMethodLabels = {
                    'CREDIT_CARD': 'CartÃ£o de CrÃ©dito',
                    'DEBIT_CARD': 'CartÃ£o de DÃ©bito',
                    'PIX': 'PIX',
                    'BANK_SLIP': 'Boleto',
                    'CASH': 'Dinheiro',
                    'BANK_TRANSFER': 'TransferÃªncia'
                };

                return `
                    <tr style="cursor: pointer;" ondblclick="editSubscription('${subscription.id}')">
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #3B82F6, #1D4ED8); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem;">
                                    ${subscription.student?.firstName?.charAt(0) || '?'}${subscription.student?.lastName?.charAt(0) || ''}
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #F8FAFC;">${subscription.student?.firstName || 'N/A'} ${subscription.student?.lastName || ''}</div>
                                    <div style="font-size: 0.875rem; color: #94A3B8;">${subscription.student?.email || 'Email nÃ£o disponÃ­vel'}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #F8FAFC;">${subscription.plan?.name || 'Plano nÃ£o encontrado'}</div>
                            <div style="font-size: 0.875rem; color: #94A3B8;">${subscription.plan?.category || 'N/A'}</div>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #10B981; font-size: 1.1rem;">R$ ${parseFloat(subscription.plan?.price || 0).toFixed(2)}</div>
                        </td>
                        <td>
                            <span style="background: ${statusColors[subscription.status] || '#6B7280'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                                ${statusLabels[subscription.status] || subscription.status}
                            </span>
                        </td>
                        <td style="color: #CBD5E1;">${new Date(subscription.startDate).toLocaleDateString('pt-BR')}</td>
                        <td style="color: #CBD5E1;">${subscription.nextPaymentDate ? new Date(subscription.nextPaymentDate).toLocaleDateString('pt-BR') : 'N/A'}</td>
                        <td style="color: #CBD5E1;">${paymentMethodLabels[subscription.paymentMethod] || subscription.paymentMethod}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="editSubscription('${subscription.id}')" style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;" title="Editar">
                                    âœï¸
                                </button>
                                <button onclick="deleteSubscription('${subscription.id}')" style="background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;" title="Excluir">
                                    ðŸ—‘ï¸
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update subscriptions stats
        function updateSubscriptionsStats(subscriptions) {
            const totalElement = document.getElementById('totalSubscriptionsCount');
            const activeElement = document.getElementById('activeSubscriptionsCount');
            const pendingElement = document.getElementById('pendingSubscriptionsCount');
            const revenueElement = document.getElementById('totalSubscriptionRevenue');

            if (totalElement) totalElement.textContent = subscriptions.length;
            
            const activeCount = subscriptions.filter(s => s.status === 'ACTIVE').length;
            if (activeElement) activeElement.textContent = activeCount;
            
            const pendingCount = subscriptions.filter(s => s.status === 'PENDING').length;
            if (pendingElement) pendingElement.textContent = pendingCount;
            
            const totalRevenue = subscriptions
                .filter(s => s.status === 'ACTIVE')
                .reduce((sum, s) => sum + parseFloat(s.plan?.price || 0), 0);
            if (revenueElement) revenueElement.textContent = `R$ ${totalRevenue.toFixed(2)}`;
        }

        // Update subscriptions count in menu
        function updateSubscriptionsCount() {
            const countElement = document.getElementById('subscriptions-count');
            if (countElement && allSubscriptions) {
                countElement.textContent = allSubscriptions.length;
            }
        }

        // Open add subscription modal
        async function openAddSubscriptionModal() {
            console.log('ðŸ”„ Opening add subscription modal...');
            
            // Load students and plans for dropdowns
            await loadStudentsAndPlansForSubscriptions();
            
            // Clear form
            document.getElementById('subscriptionForm').reset();
            document.getElementById('subscriptionModalTitle').textContent = 'âž• Nova Assinatura';
            document.getElementById('subscriptionForm').dataset.mode = 'add';
            
            // Set default start date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('subscriptionStartDate').value = today;
            
            // Show modal
            document.getElementById('subscriptionModal').style.display = 'block';
        }

        // Load students and plans for subscription form
        async function loadStudentsAndPlansForSubscriptions() {
            try {
                // Load students
                const studentsResponse = await fetch('/api/students');
                if (studentsResponse.ok) {
                    const studentsData = await studentsResponse.json();
                    allStudentsForSubscriptions = studentsData.data || [];
                    
                    const studentSelect = document.getElementById('subscriptionStudent');
                    studentSelect.innerHTML = '<option value="">Selecione um aluno</option>' +
                        allStudentsForSubscriptions.map(student => 
                            `<option value="${student.id}">${student.user.firstName} ${student.user.lastName} - ${student.user.email}</option>`
                        ).join('');
                }

                // Load plans
                const plansResponse = await fetch('/api/financial/plans');
                if (plansResponse.ok) {
                    const plansData = await plansResponse.json();
                    allPlansForSubscriptions = plansData.data || [];
                    
                    const planSelect = document.getElementById('subscriptionPlan');
                    const planFilter = document.getElementById('subscriptionPlanFilter');
                    
                    const planOptions = allPlansForSubscriptions.map(plan => 
                        `<option value="${plan.id}">${plan.name} - R$ ${parseFloat(plan.price).toFixed(2)} (${plan.category})</option>`
                    ).join('');
                    
                    planSelect.innerHTML = '<option value="">Selecione um plano</option>' + planOptions;
                    planFilter.innerHTML = '<option value="">Todos Planos</option>' + planOptions;
                }
                
            } catch (error) {
                console.error('Error loading students and plans:', error);
            }
        }

        // Update subscription plan details display
        function updateSubscriptionPlanDetails() {
            const planSelect = document.getElementById('subscriptionPlan');
            const planDetailsDiv = document.getElementById('subscriptionPlanDetails');
            const planDetailsContent = document.getElementById('planDetailsContent');
            
            const selectedPlanId = planSelect.value;
            
            if (!selectedPlanId) {
                planDetailsDiv.style.display = 'none';
                return;
            }
            
            const selectedPlan = allPlansForSubscriptions.find(plan => plan.id === selectedPlanId);
            
            if (selectedPlan) {
                planDetailsContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <strong>ðŸ’° Valor:</strong> R$ ${parseFloat(selectedPlan.price).toFixed(2)}
                        </div>
                        <div>
                            <strong>ðŸ“‚ Categoria:</strong> ${selectedPlan.category}
                        </div>
                        <div>
                            <strong>ðŸ”„ CobranÃ§a:</strong> ${selectedPlan.billingType || 'N/A'}
                        </div>
                        <div>
                            <strong>â±ï¸ DuraÃ§Ã£o:</strong> ${selectedPlan.duration || 'N/A'} meses
                        </div>
                    </div>
                    ${selectedPlan.description ? `<div style="margin-top: 0.5rem;"><strong>ðŸ“ DescriÃ§Ã£o:</strong> ${selectedPlan.description}</div>` : ''}
                `;
                planDetailsDiv.style.display = 'block';
            }
        }

        // Close subscription modal
        function closeSubscriptionModal() {
            document.getElementById('subscriptionModal').style.display = 'none';
        }

        // Edit subscription
        async function editSubscription(subscriptionId) {
            console.log('âœï¸ Editing subscription:', subscriptionId);
            
            const subscription = allSubscriptions.find(s => s.id === subscriptionId);
            if (!subscription) {
                showToast('Assinatura nÃ£o encontrada', 'error');
                return;
            }
            
            // Load students and plans for dropdowns
            await loadStudentsAndPlansForSubscriptions();
            
            // Populate form with subscription data
            document.getElementById('subscriptionStudent').value = subscription.studentId;
            document.getElementById('subscriptionPlan').value = subscription.planId;
            document.getElementById('subscriptionStartDate').value = subscription.startDate.split('T')[0];
            document.getElementById('subscriptionPaymentMethod').value = subscription.paymentMethod;
            document.getElementById('subscriptionPaymentDay').value = subscription.paymentDay || '';
            document.getElementById('subscriptionStatus').value = subscription.status;
            document.getElementById('subscriptionNotes').value = subscription.notes || '';
            
            // Update modal title and mode
            document.getElementById('subscriptionModalTitle').textContent = 'âœï¸ Editar Assinatura';
            document.getElementById('subscriptionForm').dataset.mode = 'edit';
            document.getElementById('subscriptionForm').dataset.subscriptionId = subscriptionId;
            
            // Update plan details display
            updateSubscriptionPlanDetails();
            
            // Show modal
            document.getElementById('subscriptionModal').style.display = 'block';
        }

        // Delete subscription
        async function deleteSubscription(subscriptionId) {
            const subscription = allSubscriptions.find(s => s.id === subscriptionId);
            if (!subscription) {
                showToast('Assinatura nÃ£o encontrada', 'error');
                return;
            }
            
            const studentName = subscription.student ? `${subscription.student.firstName} ${subscription.student.lastName}` : 'Aluno desconhecido';
            
            if (!confirm(`Tem certeza que deseja excluir a assinatura de ${studentName}?`)) {
                return;
            }
            
            try {
                showToast('Excluindo assinatura...', 'info');
                
                const response = await fetch(`/api/subscriptions/${subscriptionId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('Assinatura excluÃ­da com sucesso!', 'success');
                    await loadSubscriptionsList(); // Reload list
                } else {
                    throw new Error('Erro na API ao excluir assinatura');
                }
                
            } catch (error) {
                console.error('Error deleting subscription:', error);
                showToast('Erro ao excluir assinatura', 'error');
            }
        }

        // Handle subscription form submission
        document.addEventListener('DOMContentLoaded', function() {
            const subscriptionForm = document.getElementById('subscriptionForm');
            if (subscriptionForm) {
                subscriptionForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const mode = this.dataset.mode;
                    const subscriptionId = this.dataset.subscriptionId;
                    
                    const subscriptionData = {
                        studentId: document.getElementById('subscriptionStudent').value,
                        planId: document.getElementById('subscriptionPlan').value,
                        startDate: document.getElementById('subscriptionStartDate').value,
                        paymentMethod: document.getElementById('subscriptionPaymentMethod').value,
                        paymentDay: document.getElementById('subscriptionPaymentDay').value || null,
                        status: document.getElementById('subscriptionStatus').value,
                        notes: document.getElementById('subscriptionNotes').value || null
                    };
                    
                    try {
                        showToast(mode === 'add' ? 'Criando assinatura...' : 'Atualizando assinatura...', 'info');
                        
                        const url = mode === 'add' ? '/api/subscriptions' : `/api/subscriptions/${subscriptionId}`;
                        const method = mode === 'add' ? 'POST' : 'PUT';
                        
                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(subscriptionData)
                        });
                        
                        if (response.ok) {
                            showToast(mode === 'add' ? 'Assinatura criada com sucesso!' : 'Assinatura atualizada com sucesso!', 'success');
                            closeSubscriptionModal();
                            await loadSubscriptionsList(); // Reload list
                        } else {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Erro na API');
                        }
                        
                    } catch (error) {
                        console.error('Error saving subscription:', error);
                        showToast('Erro ao salvar assinatura: ' + error.message, 'error');
                    }
                });
            }
        });

        // Filter subscriptions
        function filterSubscriptions() {
            const searchTerm = document.getElementById('subscriptionSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('subscriptionStatusFilter').value;
            const planFilter = document.getElementById('subscriptionPlanFilter').value;
            
            const filteredSubscriptions = allSubscriptions.filter(subscription => {
                const matchesSearch = !searchTerm || 
                    subscription.student?.firstName?.toLowerCase().includes(searchTerm) ||
                    subscription.student?.lastName?.toLowerCase().includes(searchTerm) ||
                    subscription.student?.email?.toLowerCase().includes(searchTerm) ||
                    subscription.plan?.name?.toLowerCase().includes(searchTerm);
                    
                const matchesStatus = !statusFilter || subscription.status === statusFilter;
                const matchesPlan = !planFilter || subscription.planId === planFilter;
                
                return matchesSearch && matchesStatus && matchesPlan;
            });
            
            updateSubscriptionsTable(filteredSubscriptions);
        }

    </script>
</body>
</html>