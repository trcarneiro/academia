                    </div>
                    
                    <button class="btn btn-primary">Salvar Configura√ß√µes</button>
                </div>
            </div>
        </div>
        
        <!-- Challenges -->
        <div id="challenges" class="content-section">
            <div class="page-header">
                <h1>Desafios Semanais</h1>
                <p>Sistema de desafios e gamifica√ß√£o</p>
            </div>
            
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">Desafios Dispon√≠veis</div>
                </div>
                <div style="color: #CBD5E1;">
                    <p>‚Ä¢ 24 desafios catalogados</p>
                    <p>‚Ä¢ Adaptados por categoria e g√™nero</p>
                    <p>‚Ä¢ Sistema de pontos integrado</p>
                    <br>
                    <p><em>Interface de desafios em desenvolvimento.</em></p>
                </div>
            </div>
        </div>
        
        <!-- Knowledge Base -->
        <div id="knowledge-base" class="content-section">
            <div class="page-header">
                <h1>üß† Base de Conhecimento</h1>
                <p>Mem√≥ria central dos agentes IA - Upload de documentos, textos, links e v√≠deos</p>
            </div>
            
            <div style="display: grid; gap: 1.5rem;">
                <!-- Knowledge Base Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #8B5CF6;">
                        <div style="color: #8B5CF6; font-weight: bold; margin-bottom: 0.5rem;">üìö Documentos</div>
                        <div style="color: #F8FAFC; font-size: 1.5rem; font-weight: bold;" id="knowledgeStatsDocuments">0</div>
                    </div>
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #10B981;">
                        <div style="color: #10B981; font-weight: bold; margin-bottom: 0.5rem;">üï∞Ô∏è Chunks RAG</div>
                        <div style="color: #F8FAFC; font-size: 1.5rem; font-weight: bold;" id="knowledgeStatsChunks">0</div>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #3B82F6;">
                        <div style="color: #3B82F6; font-weight: bold; margin-bottom: 0.5rem;">‚è±Ô∏è √öltima Indexa√ß√£o</div>
                        <div style="color: #F8FAFC; font-size: 0.875rem;" id="knowledgeStatsLastUpdate">Nunca</div>
                    </div>
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #F59E0B;">
                        <div style="color: #F59E0B; font-weight: bold; margin-bottom: 0.5rem;">‚öôÔ∏è Status RAG</div>
                        <div style="color: #F8FAFC; font-size: 0.875rem;" id="knowledgeStatsStatus">Vazio</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openKnowledgeUploader()">
                        <span>‚ûï</span> Adicionar Conte√∫do
                    </button>
                    <button class="btn btn-success" onclick="reindexKnowledgeBase()">
                        <span>‚ö°</span> Reindexar Base
                    </button>
                    <button class="btn btn-info" onclick="testRAGSystem()">
                        <span>üó∫Ô∏è</span> Testar RAG
                    </button>
                    <button class="btn btn-secondary" onclick="searchKnowledgeBase()">
                        <span>üîç</span> Buscar
                    </button>
                </div>
                
                <!-- Knowledge Base Content -->
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">Conte√∫do da Base de Conhecimento</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="text" id="knowledgeSearchInput" placeholder="Buscar na base..." style="padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #1F2937; color: #F8FAFC; width: 200px;" onkeyup="if(event.key==='Enter') searchKnowledgeBase()">
                            <button class="btn btn-sm btn-primary" onclick="searchKnowledgeBase()">üîç</button>
                        </div>
                    </div>
                    <div id="knowledgeContentDisplay" style="min-height: 300px;">
                        <div style="text-align: center; color: #9CA3AF; padding: 3rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üìö</div>
                            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Base de Conhecimento Vazia</div>
                            <div style="font-size: 0.9rem;">Adicione documentos, textos, links ou v√≠deos para come√ßar</div>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-primary" onclick="openKnowledgeUploader()">
                                    ‚ûï Adicionar Primeiro Conte√∫do
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Financial Responsibles -->
        <div id="financial-responsibles" class="content-section">
            <div class="page-header">
                <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Respons√°veis Financeiros</h1>
                <p>Gest√£o de respons√°veis financeiros dos alunos</p>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-value" id="totalResponsibles">0</div>
                    <div class="stat-label">Total de Respons√°veis</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeResponsibles">0</div>
                    <div class="stat-label">Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="studentsWithResponsibles">0</div>
                    <div class="stat-label">Alunos com Respons√°vel</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgStudentsPerResponsible">0</div>
                    <div class="stat-label">M√©dia p/ Respons√°vel</div>
                </div>
            </div>

            <!-- Search and Actions -->
            <div class="simple-search">
                <input type="text" 
                       id="responsibleSearch" 
                       class="search-input"
                       placeholder="üîç Buscar por nome, CPF, email..." 
                       onkeyup="filterResponsibles()"
                       autocomplete="off">
                
                <button class="btn btn-primary" onclick="openAddResponsibleModal()">
                    <span>‚ûï</span>
                    Novo Respons√°vel
                </button>
            </div>
            
            <!-- Responsibles Table -->
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">Lista de Respons√°veis Financeiros</div>
                </div>
                <div class="responsibles-table-container">
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF/CNPJ</th>
                                <th>Email</th>
                                <th>Telefone</th>
                                <th>Rela√ß√£o</th>
                                <th>Alunos</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="responsiblesTableBody">
                            <!-- Responsibles will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="responsiblesLoadingState" class="loading-state">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando respons√°veis...</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                    </div>
                </div>
                <div id="responsiblesEmptyState" class="empty-state" style="display: none;">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhum respons√°vel encontrado</div>
                        <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece adicionando o primeiro respons√°vel financeiro</div>
                        <button class="btn btn-primary" onclick="openAddResponsibleModal()">
                            <span>‚ûï</span>
                            Adicionar Primeiro Respons√°vel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Plans -->
        <!-- Payment Plans Management -->
        <div id="payment-plans" class="content-section">
            <!-- Modern Page Header -->
            <div class="page-header" style="background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #FFFFFF, #F3E8FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üìÑ Planos da Academia</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #F3E8FF; font-size: 1.1rem;">Gerencie os planos de curso oferecidos pela academia - valores, categorias e condi√ß√µes</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="openAddPlanModal()" style="background: linear-gradient(135deg, #059669, #10B981); border: none; padding: 0.75rem 1.5rem;">
                            <span>‚ûï</span> Novo Plano
                        </button>
                        <button class="btn btn-secondary" onclick="loadPaymentPlansList()" style="padding: 0.75rem 1.5rem;">
                            <span>üîÑ</span> Atualizar
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="totalPlansCount">0</div>
                        <div style="font-size: 0.875rem; color: #F3E8FF;">Total Planos</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="activePlansCount">0</div>
                        <div style="font-size: 0.875rem; color: #F3E8FF;">Ativos</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="avgPlanPrice">R$ 0</div>
                        <div style="font-size: 0.875rem; color: #F3E8FF;">Valor M√©dio</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="monthlyPlansCount">0</div>
                        <div style="font-size: 0.875rem; color: #F3E8FF;">Mensais</div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="data-controls" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
                <div style="flex: 1; position: relative;">
                    <input type="text" id="planSearchInput" placeholder="üîç Buscar planos..." 
                           style="width: 100%; padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 12px; color: #F8FAFC; font-size: 0.875rem;"
                           onkeyup="filterPlans()">
                </div>
                <select id="categoryFilterSelect" onchange="filterPlans()" 
                        style="padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC; font-size: 0.875rem;">
                    <option value="">Todas Categorias</option>
                    <option value="ADULT">Adulto</option>
                    <option value="CHILD">Infantil</option>
                    <option value="SENIOR">Senior</option>
                    <option value="FEMALE">Feminino</option>
                </select>
                <select id="billingTypeFilter" onchange="filterPlans()" 
                        style="padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC; font-size: 0.875rem;">
                    <option value="">Todos Tipos</option>
                    <option value="MONTHLY">Mensal</option>
                    <option value="QUARTERLY">Trimestral</option>
                    <option value="YEARLY">Anual</option>
                    <option value="CREDIT_CARD_INSTALLMENT">Cart√£o Parcelado</option>
                </select>
                <button class="btn btn-primary" onclick="openAddPlanPage()" style="background: linear-gradient(135deg, #8B5CF6, #EC4899); padding: 0.75rem 1.5rem;">
                    <span>‚ûï</span> Novo Plano
                </button>
            </div>

            <!-- Plans Table -->
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">üìÑ Planos de Curso da Academia</div>
                    <div class="table-actions">
                        <span style="color: #CBD5E1; font-size: 0.875rem;" id="plansCountText">Carregando...</span>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #1E293B; border-bottom: 1px solid #374151;">
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Plano</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Curso</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Categoria</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Valor</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Tipo</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Aulas/Semana</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">Status</th>
                                <th style="padding: 1rem; text-align: left; color: #F8FAFC; font-weight: 600;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="plansTableBody">
                            <!-- Plans will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Loading State -->
            <div id="plansLoadingState" class="loading-state">
                <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üìÑ</div>
                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando planos...</div>
                    <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="plansEmptyState" class="empty-state" style="display: none;">
                <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhum plano encontrado</div>
                    <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece criando o primeiro plano de pagamento</div>
                    <button class="btn btn-primary" onclick="openAddPlanPage()">
                        <span>‚ûï</span> Criar Primeiro Plano
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Plan Edit Page -->
        <div id="plan-edit" class="content-section" style="display: none;">
            <div class="page-header" style="background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #FFFFFF, #F3E8FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">‚úèÔ∏è Editar Plano</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #F3E8FF; font-size: 1.1rem;" id="planEditSubtitle">Edite as informa√ß√µes do plano selecionado</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="backToPlans()" style="padding: 0.75rem 1.5rem;">
                            <span>‚Üê</span> Voltar
                        </button>
                        <button class="btn btn-primary" onclick="savePlanChanges()" style="background: linear-gradient(135deg, #059669, #10B981); border: none; padding: 0.75rem 1.5rem;">
                            <span>üíæ</span> Salvar
                        </button>
                        <button class="btn btn-secondary" onclick="testSavePlanDebug()" style="background: #6B7280; border: none; padding: 0.75rem 1.5rem; margin-left: 0.5rem;">
                            <span>üß™</span> Teste Debug
                        </button>
                    </div>
                </div>
            </div>

            <!-- Plan Edit Form with Tabs -->
            <div class="form-container" style="background: rgba(15, 23, 42, 0.6); border-radius: 16px; padding: 2rem; border: 1px solid rgba(51, 65, 85, 0.8);">
                
                <!-- Tab Navigation -->
                <div class="plan-tabs" style="margin-bottom: 2rem;">
                    <button type="button" class="plan-tab active" onclick="switchPlanEditTab('basic')" data-tab="basic">
                        üìã Informa√ß√µes B√°sicas
                    </button>
                    <button type="button" class="plan-tab" onclick="switchPlanEditTab('courses')" data-tab="courses">
                        üéì Cursos Associados
                    </button>
                    <button type="button" class="plan-tab" onclick="switchPlanEditTab('advanced')" data-tab="advanced">
                        ‚öôÔ∏è Configura√ß√µes
                    </button>
                    <button type="button" class="plan-tab" onclick="switchPlanEditTab('preview')" data-tab="preview">
                        üëÅÔ∏è Preview
                    </button>
                </div>

                <form id="planEditForm">
                    <!-- Tab 1: Basic Information -->
                    <div id="planEditTab-basic" class="plan-tab-content active">
                        <div class="tab-header" style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #3B82F6; margin-bottom: 0.5rem; font-size: 1.5rem;">üìã Informa√ß√µes B√°sicas do Plano</h3>
                            <p style="color: #94A3B8; margin: 0;">Configure os dados fundamentais do seu plano de pagamento</p>
                        </div>
                        
                        <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                            <div class="form-group">
                                <label class="form-label">Nome do Plano *</label>
                                <input type="text" class="form-input" id="editPlanName" placeholder="Ex: Plano Premium Krav Maga" required>
                                <small class="form-hint">üîÑ Ser√° gerado automaticamente baseado nos cursos selecionados</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Categoria *</label>
                                <select class="form-select" id="editPlanCategory" required onchange="updatePlanEditPreview()">
                                    <option value="">Selecione uma categoria...</option>
                                    <option value="ADULT">üë® Adulto</option>
                                    <option value="FEMALE">üë© Feminino</option>
                                    <option value="SENIOR">üë¥ Senior/Idoso</option>
                                    <option value="CHILD">üßí Infantil/Crian√ßa</option>
                                    <option value="INICIANTE1">ü•â Iniciante 1</option>
                                    <option value="INICIANTE2">ü•â Iniciante 2</option>
                                    <option value="INICIANTE3">ü•â Iniciante 3</option>
                                    <option value="HEROI1">ü•à Her√≥i 1</option>
                                    <option value="HEROI2">ü•à Her√≥i 2</option>
                                    <option value="HEROI3">ü•à Her√≥i 3</option>
                                    <option value="MASTER_1">ü•á Master 1</option>
                                    <option value="MASTER_2">ü•á Master 2</option>
                                    <option value="MASTER_3">ü•á Master 3</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Valor do Plano *</label>
                                <input type="number" class="form-input" id="editPlanPrice" step="0.01" placeholder="R$ 0,00" required>
                                <small class="form-hint">üí∞ Insira o valor do plano conforme sua estrat√©gia de pre√ßos</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tipo de Cobran√ßa *</label>
                                <select class="form-select" id="editPlanBillingType" required onchange="updatePlanEditPreview()">
                                    <option value="MONTHLY">üí≥ Mensal</option>
                                    <option value="WEEKLY">üìÖ Semanal</option>
                                    <option value="QUARTERLY">üìä Trimestral</option>
                                    <option value="YEARLY">üóìÔ∏è Anual</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Descri√ß√£o do Plano</label>
                            <textarea class="form-input" id="editPlanDescription" rows="3" placeholder="Descri√ß√£o detalhada dos benef√≠cios e caracter√≠sticas do plano..."></textarea>
                        </div>
                        
                        <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <div></div>
                            <button type="button" class="btn btn-primary" onclick="switchPlanEditTab('courses')" style="min-width: 200px;">
                                Pr√≥ximo: Cursos Associados ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab 2: Associated Courses -->
                    <div id="planEditTab-courses" class="plan-tab-content">
                        <div class="tab-header" style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #3B82F6; margin-bottom: 0.5rem; font-size: 1.5rem;">üéì Cursos Associados ao Plano</h3>
                            <p style="color: #94A3B8; margin: 0;">Selecione todos os cursos que estar√£o inclusos neste plano</p>
                            <div class="validation-alert" id="coursesValidationAlert" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid #EF4444; color: #EF4444; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> √â obrigat√≥rio selecionar pelo menos um curso para o plano.
                            </div>
                            <div class="success-alert" id="coursesSuccessAlert" style="display: none; background: rgba(16, 185, 129, 0.1); border: 1px solid #10B981; color: #10B981; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                ‚úÖ <strong>Perfeito!</strong> Cursos selecionados para o plano.
                            </div>
                        </div>
                        
                        <div class="courses-selection-container">
                            <div class="selection-header">
                                <div class="selection-stats">
                                    <span class="stat-badge" id="editCoursesSelectedCount">0 cursos selecionados</span>
                                    <span class="stat-badge" id="editCoursesTotalCount">0 cursos dispon√≠veis</span>
                                </div>
                                <div class="selection-actions">
                                    <button type="button" class="btn btn-sm btn-outline" onclick="selectAllEditCourses()">Selecionar Todos</button>
                                    <button type="button" class="btn btn-sm btn-outline" onclick="clearAllEditCourses()">Limpar Sele√ß√£o</button>
                                </div>
                            </div>
                            
                            <div class="courses-grid" id="editCoursesGrid">
                                <!-- Courses will be loaded here dynamically -->
                                <div class="loading-state">
                                    <div class="spinner"></div>
                                    <p>Carregando cursos dispon√≠veis...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <button type="button" class="btn btn-secondary" onclick="switchPlanEditTab('basic')" style="min-width: 200px;">
                                ‚Üê Voltar: Informa√ß√µes B√°sicas
                            </button>
                            <button type="button" class="btn btn-primary" onclick="switchPlanEditTab('advanced')" style="min-width: 200px;">
                                Pr√≥ximo: Configura√ß√µes ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab 3: Advanced Configuration -->
                    <div id="planEditTab-advanced" class="plan-tab-content">
                        <div class="tab-header" style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #3B82F6; margin-bottom: 0.5rem; font-size: 1.5rem;">‚öôÔ∏è Configura√ß√µes Avan√ßadas</h3>
                            <p style="color: #94A3B8; margin: 0;">Configure recursos especiais e limita√ß√µes do plano</p>
                        </div>
                        
                        <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                            <div class="form-group">
                                <label class="form-label">Aulas por Semana</label>
                                <select class="form-select" id="editPlanClassesPerWeek" onchange="syncWeeklyClassesField()">
                                    <option value="1">1 aula por semana</option>
                                    <option value="2" selected>2 aulas por semana</option>
                                    <option value="3">3 aulas por semana</option>
                                    <option value="4">4 aulas por semana</option>
                                    <option value="5">5 aulas por semana</option>
                                    <option value="unlimited">‚ôæÔ∏è Ilimitado</option>
                                </select>
                                <!-- Hidden field for JS compatibility -->
                                <input type="hidden" id="editPlanWeeklyClasses" value="2">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">M√°ximo de Aulas por M√™s</label>
                                <input type="number" class="form-input" id="editPlanMaxClasses" min="1" max="50" placeholder="Ex: 8 aulas">
                                <small class="form-hint">Deixe em branco para ilimitado</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Dura√ß√£o do Plano (meses)</label>
                                <input type="number" class="form-input" id="editPlanDuration" min="1" max="36" placeholder="Ex: 12 meses" value="12">
                                <small class="form-hint">Dura√ß√£o em meses do plano</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Per√≠odo de Car√™ncia (dias)</label>
                                <input type="number" class="form-input" id="editPlanGracePeriod" min="0" max="30" placeholder="Ex: 5 dias" value="5">
                                <small class="form-hint">Dias de car√™ncia para cancelamento</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Limite de Alunos</label>
                                <input type="number" class="form-input" id="editPlanStudentLimit" min="1" placeholder="Ex: 50 alunos">
                                <small class="form-hint">Deixe em branco para ilimitado</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Recursos Extras</label>
                            <div class="extras-grid">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanPersonalTraining"> 
                                    üí™ Personal Training
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanNutrition"> 
                                    ü•ó Plano Nutricional
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanAllModalities"> 
                                    ü•ã Todas Modalidades
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFreezeOption"> 
                                    ‚ùÑÔ∏è Permite Congelar
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFeatureAccess" checked> 
                                    üîë Acesso Total
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFeatureEquipment"> 
                                    üèãÔ∏è Equipamentos
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFeaturePersonal"> 
                                    üí™ Personal Training
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFeatureNutrition"> 
                                    ü•ó Nutricional
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFeatureEvents" checked> 
                                    üéâ Eventos
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanFeatureMaterial" checked> 
                                    üìö Material Did√°tico
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Configura√ß√µes do Plano</label>
                            <div class="extras-grid">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanIsActive" checked> 
                                    ‚úÖ Plano Ativo
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanAllowUpgrade" checked> 
                                    üìà Permite Upgrade
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="editPlanAutoRenewal"> 
                                    üîÑ Renova√ß√£o Autom√°tica
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Observa√ß√µes</label>
                            <textarea class="form-input" id="editPlanNotes" rows="3" placeholder="Observa√ß√µes adicionais sobre o plano..."></textarea>
                        </div>
                        
                        <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <button type="button" class="btn btn-secondary" onclick="switchPlanEditTab('courses')" style="min-width: 200px;">
                                ‚Üê Voltar: Cursos Associados
                            </button>
                            <button type="button" class="btn btn-primary" onclick="switchPlanEditTab('preview')" style="min-width: 200px;">
                                Pr√≥ximo: Preview ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab 4: Preview -->
                    <div id="planEditTab-preview" class="plan-tab-content">
                        <div class="tab-header" style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #3B82F6; margin-bottom: 0.5rem; font-size: 1.5rem;">üëÅÔ∏è Preview do Plano</h3>
                            <p style="color: #94A3B8; margin: 0;">Visualize como o plano ficar√° antes de salvar</p>
                        </div>
                        
                        <div id="editPlanPreview" class="preview-container">
                            <div class="preview-card">
                                <div class="preview-header">
                                    <h4 id="editPreviewPlanName">Nome do Plano</h4>
                                    <div class="preview-price" id="editPreviewPlanPrice">R$ 0,00</div>
                                </div>
                                <div class="preview-body">
                                    <p id="editPreviewPlanDescription">Descri√ß√£o do plano</p>
                                    <div class="preview-details">
                                        <div class="detail-item">
                                            <span class="detail-label">Categoria:</span>
                                            <span class="detail-value" id="editPreviewCategory">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Tipo de Cobran√ßa:</span>
                                            <span class="detail-value" id="editPreviewBillingType">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Cursos Inclusos:</span>
                                            <span class="detail-value" id="editPreviewCourses">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Aulas por Semana:</span>
                                            <span class="detail-value" id="editPreviewClassesPerWeek">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <button type="button" class="btn btn-secondary" onclick="switchPlanEditTab('advanced')" style="min-width: 200px;">
                                ‚Üê Voltar: Configura√ß√µes
                            </button>
                            <button type="button" class="btn btn-primary btn-large" onclick="savePlanChanges()" style="min-width: 200px;">
                                üíæ Salvar Plano
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="testSavePlanDebug()" style="min-width: 150px; margin-left: 1rem;">
                                üß™ Teste Debug
                            </button>
                        </div>
                    </div>
                    
                    <!-- Hidden legacy field for compatibility -->
                    <select id="editPlanCourse" multiple style="display: none;"></select>
                </form>
            </div>
        </div>
        
        <!-- Subscriptions Management -->
        <div id="subscriptions" class="content-section">
            <!-- Modern Page Header -->
            <div class="page-header" style="background: linear-gradient(135deg, #059669 0%, #10B981 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #FFFFFF, #D1FAE5); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üí≥ Gest√£o de Assinaturas</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #D1FAE5; font-size: 1.1rem;">Gerencie assinaturas ativas dos alunos, planos contratados e status de pagamento</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="openAddSubscriptionModal()" style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); border: none; padding: 0.75rem 1.5rem;">
                            <span>‚ûï</span> Nova Assinatura
                        </button>
                        <button class="btn btn-secondary" onclick="loadSubscriptionsList()" style="padding: 0.75rem 1.5rem;">
                            <span>üîÑ</span> Atualizar
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="totalSubscriptionsCount">0</div>
                        <div style="font-size: 0.875rem; color: #D1FAE5;">Total Assinaturas</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="activeSubscriptionsCount">0</div>
                        <div style="font-size: 0.875rem; color: #D1FAE5;">Ativas</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="pendingSubscriptionsCount">0</div>
                        <div style="font-size: 0.875rem; color: #D1FAE5;">Pendentes</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FFFFFF;" id="totalSubscriptionRevenue">R$ 0</div>
                        <div style="font-size: 0.875rem; color: #D1FAE5;">Receita Total</div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="data-controls" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
                <div style="flex: 1; position: relative;">
                    <input type="text" id="subscriptionSearchInput" placeholder="üîç Buscar por aluno, e-mail ou plano..." 
                           style="width: 100%; padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 12px; color: #F8FAFC; font-size: 0.875rem;"
                           onkeyup="filterSubscriptions()">
                </div>
                <select id="subscriptionStatusFilter" onchange="filterSubscriptions()" 
                        style="padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC; font-size: 0.875rem;">
                    <option value="">Todos Status</option>
                    <option value="ACTIVE">Ativa</option>
                    <option value="PENDING">Pendente</option>
                    <option value="SUSPENDED">Suspensa</option>
                    <option value="CANCELLED">Cancelada</option>
                    <option value="EXPIRED">Expirada</option>
                </select>
                <select id="subscriptionPlanFilter" onchange="filterSubscriptions()" 
                        style="padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC; font-size: 0.875rem;">
                    <option value="">Todos Planos</option>
                </select>
            </div>

            <!-- Data Table -->
            <div class="table-container">
                <table class="data-table-content">
                    <thead>
                        <tr>
                            <th>Aluno</th>
                            <th>Plano</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>In√≠cio</th>
                            <th>Pr√≥ximo Pagamento</th>
                            <th>M√©todo</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="subscriptionsTableBody">
                        <!-- Subscriptions will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Loading States -->
            <div id="subscriptionsLoadingState" class="loading-state">
                <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üí≥</div>
                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando assinaturas...</div>
                    <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                </div>
            </div>
            <div id="subscriptionsEmptyState" class="empty-state" style="display: none;">
                <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üí≥</div>
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhuma assinatura encontrada</div>
                    <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece criando a primeira assinatura</div>
                    <button class="btn btn-primary" onclick="openAddSubscriptionModal()">
                        <span>‚ûï</span>
                        Criar Primeira Assinatura
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Subscription Modal -->
        <div id="subscriptionModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="subscriptionModalTitle">‚ûï Nova Assinatura</h2>
                    <button class="btn-close" onclick="closeSubscriptionModal()">&times;</button>
                </div>
                <form id="subscriptionForm">
                    <div class="modal-body">
                        <!-- Student Selection -->
                        <div class="form-group">
                            <label class="form-label">üë§ Aluno *</label>
                            <select id="subscriptionStudent" class="form-control" required>
                                <option value="">Selecione um aluno</option>
                            </select>
                        </div>

                        <!-- Plan Selection -->
                        <div class="form-group">
                            <label class="form-label">üìÑ Plano *</label>
                            <select id="subscriptionPlan" class="form-control" required onchange="updateSubscriptionPlanDetails()">
                                <option value="">Selecione um plano</option>
                            </select>
                        </div>

                        <!-- Plan Details Display -->
                        <div id="subscriptionPlanDetails" style="display: none; background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <h4 style="color: #3B82F6; margin-bottom: 0.5rem;">üìã Detalhes do Plano</h4>
                            <div id="planDetailsContent"></div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Start Date -->
                            <div class="form-group">
                                <label class="form-label">üìÖ Data de In√≠cio *</label>
                                <input type="date" id="subscriptionStartDate" class="form-control" required>
                            </div>

                            <!-- Payment Method -->
                            <div class="form-group">
                                <label class="form-label">üí≥ M√©todo de Pagamento *</label>
                                <select id="subscriptionPaymentMethod" class="form-control" required>
                                    <option value="">Selecione</option>
                                    <option value="CREDIT_CARD">Cart√£o de Cr√©dito</option>
                                    <option value="DEBIT_CARD">Cart√£o de D√©bito</option>
                                    <option value="PIX">PIX</option>
                                    <option value="BANK_SLIP">Boleto Banc√°rio</option>
                                    <option value="CASH">Dinheiro</option>
                                    <option value="BANK_TRANSFER">Transfer√™ncia</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Payment Day -->
                            <div class="form-group">
                                <label class="form-label">üìÜ Dia do Pagamento</label>
                                <select id="subscriptionPaymentDay" class="form-control">
                                    <option value="">Auto (data de in√≠cio)</option>
                                    <option value="1">1</option>
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                </select>
                            </div>

                            <!-- Status -->
                            <div class="form-group">
                                <label class="form-label">üìä Status *</label>
                                <select id="subscriptionStatus" class="form-control" required>
                                    <option value="ACTIVE">Ativa</option>
                                    <option value="PENDING">Pendente</option>
                                    <option value="SUSPENDED">Suspensa</option>
                                    <option value="CANCELLED">Cancelada</option>
                                </select>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="form-group">
                            <label class="form-label">üìù Observa√ß√µes</label>
                            <textarea id="subscriptionNotes" class="form-control" rows="3" placeholder="Observa√ß√µes sobre a assinatura..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeSubscriptionModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">üíæ Salvar Assinatura</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Units Management -->
        <div id="units" class="content-section">
            <div class="page-header" style="background: linear-gradient(135deg, #1E293B 0%, #334155 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #3B82F6, #8B5CF6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üè¢ Gest√£o de Unidades</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #94A3B8; font-size: 1.1rem;">Administre locais, endere√ßos e capacidades das unidades da academia</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="openAddUnitModal()" style="background: linear-gradient(135deg, #059669, #10B981); border: none; padding: 0.75rem 1.5rem;">
                            <span>‚ûï</span> Nova Unidade
                        </button>
                        <button class="btn btn-secondary" onclick="loadUnits()" style="padding: 0.75rem 1.5rem;">
                            <span>üîÑ</span> Atualizar
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #3B82F6;" id="totalUnitsCount">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Unidades</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #8B5CF6;" id="totalMatsCount">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Tatames</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #10B981;" id="totalCapacityCount">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Capacidade Total</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #F59E0B;" id="activeClassesCount">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Turmas Ativas</div>
                    </div>
                </div>
            </div>

            <!-- Units Table -->
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">üìã Lista de Unidades</div>
                    <div class="table-actions">
                        <input type="text" placeholder="üîç Buscar unidade..." 
                               style="background: #1E293B; border: 1px solid #374151; color: #F8FAFC; padding: 0.5rem 1rem; border-radius: 8px; margin-right: 1rem;" 
                               id="unitsSearchInput" onkeyup="searchUnits()">
                        <button class="btn btn-secondary" onclick="exportUnitsReport()">
                            üìä Relat√≥rio
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table-content">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Endere√ßo</th>
                                <th>Tatames</th>
                                <th>Capacidade</th>
                                <th>Turmas</th>
                                <th>Respons√°vel</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="unitsTableBody">
                            <!-- Units will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="unitsLoadingState" class="loading-state">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üè¢</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando unidades...</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                    </div>
                </div>
                <div id="unitsEmptyState" class="empty-state" style="display: none;">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üè¢</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhuma unidade encontrada</div>
                        <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece cadastrando a primeira unidade da academia</div>
                        <button class="btn btn-primary" onclick="openAddUnitModal()">
                            <span>‚ûï</span>
                            Criar Primeira Unidade
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mats Management -->
        <div id="mats" class="content-section">
            <div class="page-header" style="background: linear-gradient(135deg, #1E293B 0%, #334155 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #8B5CF6, #EC4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ü•ã Gest√£o de Tatames</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #94A3B8; font-size: 1.1rem;">Administre espa√ßos de treinamento, equipamentos e capacidades</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="openAddMatModal()" style="background: linear-gradient(135deg, #7C3AED, #8B5CF6); border: none; padding: 0.75rem 1.5rem;">
                            <span>‚ûï</span> Novo Tatame
                        </button>
                        <button class="btn btn-secondary" onclick="loadMats()" style="padding: 0.75rem 1.5rem;">
                            <span>üîÑ</span> Atualizar
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #8B5CF6;" id="matsCount">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Total Tatames</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #10B981;" id="matsCapacity">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Capacidade Total</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #3B82F6;" id="matsInUse">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Em Uso</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #F59E0B;" id="matsAvailable">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Dispon√≠veis</div>
                    </div>
                </div>
            </div>

            <!-- Filter by Unit -->
            <div style="background: #1E293B; border-radius: 12px; padding: 1rem; margin-bottom: 2rem; border: 1px solid #334155;">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <label style="color: #CBD5E1; font-weight: 600;">Filtrar por Unidade:</label>
                    <select id="unitFilter" onchange="filterMatsByUnit()" style="background: #0F172A; border: 1px solid #374151; color: #F8FAFC; padding: 0.5rem 1rem; border-radius: 8px; min-width: 200px;">
                        <option value="">Todas as Unidades</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                    <button class="btn btn-secondary" onclick="clearMatFilters()" style="padding: 0.5rem 1rem;">
                        <span>üßπ</span> Limpar Filtros
                    </button>
                </div>
            </div>

            <!-- Mats Table -->
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">üìã Lista de Tatames</div>
                    <div class="table-actions">
                        <input type="text" placeholder="üîç Buscar tatame..." 
                               style="background: #1E293B; border: 1px solid #374151; color: #F8FAFC; padding: 0.5rem 1rem; border-radius: 8px; margin-right: 1rem;" 
                               id="matsSearchInput" onkeyup="searchMats()">
                        <button class="btn btn-secondary" onclick="exportMatsReport()">
                            üìä Relat√≥rio
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table-content">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Unidade</th>
                                <th>Capacidade</th>
                                <th>Dimens√µes</th>
                                <th>Equipamentos</th>
                                <th>Turmas</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="matsTableBody">
                            <!-- Mats will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="matsLoadingState" class="loading-state">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ü•ã</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando tatames...</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                    </div>
                </div>
                <div id="matsEmptyState" class="empty-state" style="display: none;">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ü•ã</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhum tatame encontrado</div>
                        <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece cadastrando o primeiro tatame</div>
                        <button class="btn btn-primary" onclick="openAddMatModal()">
                            <span>‚ûï</span>
                            Criar Primeiro Tatame
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Instructors Management -->
        <div id="instructors" class="content-section">
            <div class="page-header" style="background: linear-gradient(135deg, #1E293B 0%, #334155 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #F59E0B, #EF4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üë®‚Äçüè´ Gest√£o de Professores</h1>
                        <p style="margin: 0.5rem 0 0 0; color: #94A3B8; font-size: 1.1rem;">Administre instrutores, especializa√ß√µes e hor√°rios dispon√≠veis</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="openAddInstructorModal()" style="background: linear-gradient(135deg, #F59E0B, #EF4444); border: none; padding: 0.75rem 1.5rem;">
                            <span>‚ûï</span> Novo Professor
                        </button>
                        <button class="btn btn-secondary" onclick="loadInstructors()" style="padding: 0.75rem 1.5rem;">
                            <span>üîÑ</span> Atualizar
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #F59E0B;" id="instructorsCount">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Professores</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #10B981;" id="instructorsActive">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Ativos</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #3B82F6;" id="instructorsWithClasses">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Com Turmas</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 12px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #8B5CF6;" id="avgExperience">0</div>
                        <div style="font-size: 0.875rem; color: #CBD5E1;">Anos Experi√™ncia</div>
                    </div>
                </div>
            </div>

            <!-- Instructors Table -->
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">üìã Lista de Professores</div>
                    <div class="table-actions">
                        <input type="text" placeholder="üîç Buscar professor..." 
                               style="background: #1E293B; border: 1px solid #374151; color: #F8FAFC; padding: 0.5rem 1rem; border-radius: 8px; margin-right: 1rem;" 
                               id="instructorsSearchInput" onkeyup="searchInstructors()">
                        <button class="btn btn-secondary" onclick="exportInstructorsReport()">
                            üìä Relat√≥rio
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table-content">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Especializa√ß√µes</th>
                                <th>Artes Marciais</th>
                                <th>Experi√™ncia</th>
                                <th>Turmas</th>
                                <th>Valor/Hora</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="instructorsTableBody">
                            <!-- Instructors will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="instructorsLoadingState" class="loading-state">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üë®‚Äçüè´</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando professores...</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                    </div>
                </div>
                <div id="instructorsEmptyState" class="empty-state" style="display: none;">
                    <div style="text-align: center; color: #CBD5E1; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üë®‚Äçüè´</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Nenhum professor encontrado</div>
                        <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 1.5rem;">Comece cadastrando o primeiro professor</div>
                        <button class="btn btn-primary" onclick="openAddInstructorModal()">
                            <span>‚ûï</span>
                            Cadastrar Primeiro Professor
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings -->
        <div id="settings" class="content-section">
            <div class="page-header">
                <h1>Configura√ß√µes</h1>
                <p>Configura√ß√µes gerais do sistema</p>
            </div>
            
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">Status do Sistema</div>
                </div>
                <div style="color: #CBD5E1;">
                    <p>‚Ä¢ Banco de dados: ‚úÖ Conectado</p>
                    <p>‚Ä¢ APIs: ‚úÖ 27 endpoints funcionais</p>
                    <p>‚Ä¢ Frontend: ‚úÖ Interface responsiva</p>
                    <p>‚Ä¢ Dados: ‚úÖ 4 alunos, 42 t√©cnicas, 48 aulas</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Debug Button for Testing Modal -->
    <div style="position: fixed; top: 10px; right: 10px; z-index: 9999;">
        <button onclick="openAddStudentModal()" style="background: #10B981; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">
            üß™ TESTE MODAL
        </button>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Adicionar Novo Aluno</h2>
                <button class="close-btn" onclick="closeModal('addStudentModal')">&times;</button>
            </div>
            <form id="addStudentForm">
                <div class="form-group">
                    <label class="form-label">Nome Completo</label>
                    <input type="text" class="form-input" id="studentName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="studentEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Telefone</label>
                    <input type="tel" class="form-input" id="studentPhone" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Data de Nascimento</label>
                    <input type="date" class="form-input" id="studentBirthDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">G√™nero</label>
                    <select class="form-select" id="studentGender" required>
                        <option value="">Selecione...</option>
                        <option value="MASCULINO">Masculino</option>
                        <option value="FEMININO">Feminino</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Categoria</label>
                    <select class="form-select" id="studentCategory" required onchange="updateStudentPlanPreview()">
                        <option value="">Selecione...</option>
                        <option value="ADULT">Adulto</option>
                        <option value="INICIANTE1">Iniciante 1</option>
                        <option value="INICIANTE2">Iniciante 2</option>
                        <option value="INTERMEDIARIO1">Intermedi√°rio 1</option>
                        <option value="INTERMEDIARIO2">Intermedi√°rio 2</option>
                        <option value="AVANCADO1">Avan√ßado 1</option>
                        <option value="AVANCADO2">Avan√ßado 2</option>
                        <option value="MASTER">Master</option>
                        <option value="INSTRUCTOR">Instrutor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Turma</label>
                    <select class="form-select" id="studentClass" required>
                        <option value="">Selecione uma turma...</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Plano de Pagamento</label>
                    <select class="form-select" id="studentBillingPlan" onchange="onPlanChange()">
                        <option value="">Selecione um plano (opcional)</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                    <small style="color: #94A3B8; margin-top: 0.5rem; display: block;">
                        Selecione um plano de pagamento ou deixe em branco para sele√ß√£o autom√°tica
                    </small>
                </div>

                <!-- Container para sele√ß√£o de turmas baseada no plano -->
                <div id="classesSelectionContainer" style="display: none;" class="form-group">
                    <label class="form-label">üéØ Turmas</label>
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>

                <!-- Container para sele√ß√£o de cursos baseada no plano -->
                <div id="coursesSelectionContainer" style="display: none;" class="form-group">
                    <label class="form-label">üìö Cursos</label>
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>

                <!-- Container para exibi√ß√£o do custo total -->
                <div id="totalCostDisplay" style="display: none;" class="form-group">
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
                <div class="form-group">
                    <label class="form-label">Curso</label>
                    <select class="form-select" id="studentCourse" onchange="updateStudentPlanPreview()">
                        <option value="">Selecione um curso (opcional)</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Respons√°vel Financeiro</label>
                    <select class="form-select" id="studentFinancialResponsible">
                        <option value="">Selecione um respons√°vel (opcional)</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                    <small style="color: #94A3B8; margin-top: 0.5rem; display: block;">
                        Selecione um respons√°vel financeiro existente ou deixe em branco se o pr√≥prio aluno √© respons√°vel
                    </small>
                </div>
                
                <!-- Intelligent Plan Preview -->
                <div id="studentPlanPreview" class="form-section" style="display: none;">
                    <h3>üí∞ Plano Autom√°tico</h3>
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #10B981;">
                        <div style="color: #10B981; font-weight: bold; margin-bottom: 0.5rem;" id="previewStudentPlanName">Nome do Plano</div>
                        <div style="color: #F8FAFC; font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;" id="previewStudentPlanPrice">R$ 0,00</div>
                        <div style="color: #CBD5E1; font-size: 0.9rem;" id="previewStudentPlanDescription">Descri√ß√£o do plano</div>
                        <div style="color: #94A3B8; font-size: 0.8rem; margin-top: 0.5rem;">
                            ‚úÖ Matr√≠cula autom√°tica no curso e plano ser√° criada
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addStudentModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar Aluno</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Student Modal - Complete Version -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2 id="editStudentModalTitle">Editar Aluno</h2>
                <span class="close" onclick="closeEditStudentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Student Summary Card -->
                <div style="padding: 1.5rem 2rem; background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                üë§
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 1.25rem;" id="editStudentSummaryName">Nome do Aluno</h3>
                                <div style="display: flex; gap: 1rem; margin-top: 0.25rem; font-size: 0.875rem; opacity: 0.9;">
                                    <span id="editStudentSummaryId">ID: -</span>
                                    <span id="editStudentSummaryCategory">Categoria: -</span>
                                    <span id="editStudentSummaryStatus">Status: Ativo</span>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem;">
                                üíæ Modificado h√° <span id="editStudentLastModified">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Tabs Navigation -->
                <div style="padding: 0 2rem; background: #1E293B; border-bottom: 1px solid #334155;">
                    <div style="display: flex; gap: 0;">
                        <!-- Primary Tab (Edit) -->
                        <button class="edit-tab-btn active primary" onclick="switchEditTab('edit')" data-tab="edit" 
                                style="padding: 1rem 2rem; background: linear-gradient(135deg, #3B82F6, #1D4ED8); border: none; color: white; border-radius: 8px 8px 0 0; font-weight: 700; cursor: pointer; position: relative; z-index: 2; margin-right: 1rem;">
                            ‚úèÔ∏è Editar Dados
                        </button>
                        <!-- Secondary Tabs (View) -->
                        <div style="display: flex; gap: 0.25rem; align-items: end;">
                            <button class="edit-tab-btn secondary" onclick="switchEditTab('overview')" data-tab="overview" 
                                    style="padding: 0.75rem 1.25rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                                üìã Vis√£o Geral
                            </button>
                            <button class="edit-tab-btn secondary" onclick="switchEditTab('academic')" data-tab="academic" 
                                    style="padding: 0.75rem 1.25rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                                üéì Acad√™mico
                            </button>
                            <button class="edit-tab-btn secondary" onclick="switchEditTab('financial')" data-tab="financial" 
                                    style="padding: 0.75rem 1.25rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                                üí∞ Financeiro
                            </button>
                            <button class="edit-tab-btn secondary" onclick="switchEditTab('progress')" data-tab="progress" 
                                    style="padding: 0.75rem 1.25rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                                üìà Progresso
                            </button>
                            <button class="edit-tab-btn secondary" onclick="switchEditTab('activity')" data-tab="activity" 
                                    style="padding: 0.75rem 1.25rem; background: transparent; border: none; color: #94A3B8; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                                üìä Atividades
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab Contents -->
                <div style="padding: 2rem;">
                    <!-- Edit Tab -->
                    <div id="edit-tab-edit" class="edit-tab-content">
                        <!-- Progress Indicator -->
                        <div style="background: #0F172A; padding: 1rem 2rem; margin: -2rem -2rem 2rem -2rem; border-bottom: 1px solid #334155;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <h3 style="color: #F8FAFC; margin: 0; font-size: 1.1rem;">üìù Editando Perfil</h3>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <div style="width: 8px; height: 8px; background: #10B981; border-radius: 50%;"></div>
                                        <span style="color: #10B981; font-size: 0.875rem;">Dados salvos automaticamente</span>
                                    </div>
                                    <button type="button" onclick="autoFillDemo()" style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8B5CF6; color: #8B5CF6; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                                        üéØ Preencher Demo
                                    </button>
                                </div>
                            </div>
                            <div style="background: #1E293B; border-radius: 6px; height: 4px; overflow: hidden;">
                                <div id="editFormProgress" style="background: linear-gradient(90deg, #3B82F6, #10B981); height: 100%; width: 20%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>

                        <form id="editStudentForm" onchange="updateFormProgress()">
                            <input type="hidden" id="editStudentId" name="editStudentId">
                            <input type="hidden" id="editUserId" name="editUserId">
                            
                            <!-- Step 1: Informa√ß√µes Pessoais -->
                            <div class="form-section" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05)); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #3B82F6, #1D4ED8); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.875rem;">1</div>
                                    <h3 style="color: #F8FAFC; margin: 0; font-size: 1.1rem;">üë§ Dados Pessoais</h3>
                                    <div style="flex: 1; height: 1px; background: linear-gradient(90deg, #3B82F6, transparent);"></div>
                                </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editFirstName">Nome *</label>
                                <input type="text" id="editFirstName" name="editFirstName" required>
                            </div>
                            <div class="form-group">
                                <label for="editLastName">Sobrenome *</label>
                                <input type="text" id="editLastName" name="editLastName" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editEmail">Email *</label>
                                <input type="email" id="editEmail" name="editEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="editPhone">Telefone</label>
                                <input type="tel" id="editPhone" name="editPhone">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCpf">CPF</label>
                                <input type="text" id="editCpf" name="editCpf" placeholder="000.000.000-00">
                            </div>
                            <div class="form-group">
                                <label for="editBirthDate">Data de Nascimento</label>
                                <input type="date" id="editBirthDate" name="editBirthDate">
                            </div>
                        </div>
                    </div>

                            </div>

                            <!-- Step 2: Informa√ß√µes da Academia -->
                            <div class="form-section" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(139, 92, 246, 0.05)); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #10B981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.875rem;">2</div>
                                    <h3 style="color: #F8FAFC; margin: 0; font-size: 1.1rem;">ü•ã Academia</h3>
                                    <div style="flex: 1; height: 1px; background: linear-gradient(90deg, #10B981, transparent);"></div>
                                </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCategory">Categoria *</label>
                                <select id="editCategory" name="editCategory" required>
                                    <option value="ADULT">Adulto</option>
                                    <option value="INICIANTE1">Iniciante 1</option>
                                    <option value="INICIANTE2">Iniciante 2</option>
                                    <option value="MASTER1">Master 1</option>
                                    <option value="MASTER2">Master 2</option>
                                    <option value="MASTER3">Master 3</option>
                                    <option value="HEROI1">Her√≥i 1</option>
                                    <option value="HEROI2">Her√≥i 2</option>
                                    <option value="HEROI3">Her√≥i 3</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editGender">G√™nero *</label>
                                <select id="editGender" name="editGender" required>
                                    <option value="MASCULINO">Masculino</option>
                                    <option value="FEMININO">Feminino</option>
                                    <option value="OUTRO">Outro</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editPhysicalCondition">Condi√ß√£o F√≠sica</label>
                                <select id="editPhysicalCondition" name="editPhysicalCondition">
                                    <option value="INICIANTE">Iniciante</option>
                                    <option value="BASICO">B√°sico</option>
                                    <option value="INTERMEDIARIO">Intermedi√°rio</option>
                                    <option value="AVANCADO">Avan√ßado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editEnrollmentDate">Data de Matr√≠cula</label>
                                <input type="date" id="editEnrollmentDate" name="editEnrollmentDate">
                            </div>
                        </div>
                    </div>

                            </div>

                            <!-- Step 3: Informa√ß√µes M√©dicas -->
                            <div class="form-section" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(245, 158, 11, 0.05)); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(239, 68, 68, 0.2);">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #EF4444, #DC2626); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.875rem;">3</div>
                                    <h3 style="color: #F8FAFC; margin: 0; font-size: 1.1rem;">üè• Sa√∫de & Emerg√™ncia</h3>
                                    <div style="flex: 1; height: 1px; background: linear-gradient(90deg, #EF4444, transparent);"></div>
                                </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="editMedicalConditions">Condi√ß√µes M√©dicas</label>
                                <textarea id="editMedicalConditions" name="editMedicalConditions" rows="3" 
                                          placeholder="Alergias, medicamentos, limita√ß√µes f√≠sicas, etc."></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editEmergencyContact">Contato de Emerg√™ncia</label>
                                <input type="text" id="editEmergencyContact" name="editEmergencyContact" 
                                       placeholder="Nome e telefone">
                            </div>
                            <div class="form-group">
                                <label for="editSpecialNeeds">Necessidades Especiais</label>
                                <select id="editSpecialNeeds" name="editSpecialNeeds" multiple>
                                    <option value="TEA">TEA (Autismo)</option>
                                    <option value="TDAH">TDAH</option>
                                    <option value="MobilidadeReduzida">Mobilidade Reduzida</option>
                                    <option value="DeficienciaVisual">Defici√™ncia Visual</option>
                                    <option value="DeficienciaAuditiva">Defici√™ncia Auditiva</option>
                                </select>
                            </div>
                        </div>
                    </div>

                            </div>

                            <!-- Step 4: Status e Progresso (Read-only) -->
                            <div class="form-section" id="editProgressSection" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(99, 102, 241, 0.05)); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #8B5CF6, #7C3AED); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.875rem;">4</div>
                                    <h3 style="color: #F8FAFC; margin: 0; font-size: 1.1rem;">üìä Estat√≠sticas (Somente Leitura)</h3>
                                    <div style="flex: 1; height: 1px; background: linear-gradient(90deg, #8B5CF6, transparent);"></div>
                                </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTotalXP">XP Total</label>
                                <input type="number" id="editTotalXP" name="editTotalXP" readonly>
                            </div>
                            <div class="form-group">
                                <label for="editGlobalLevel">N√≠vel Global</label>
                                <input type="number" id="editGlobalLevel" name="editGlobalLevel" readonly>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCurrentStreak">Sequ√™ncia Atual</label>
                                <input type="number" id="editCurrentStreak" name="editCurrentStreak" readonly>
                            </div>
                            <div class="form-group">
                                <label for="editLastCheckinDate">√öltima Presen√ßa</label>
                                <input type="datetime-local" id="editLastCheckinDate" name="editLastCheckinDate" readonly>
                            </div>
                        </div>
                        </form>
                    </div>

                        </form>
                    </div>

                    <!-- Overview Tab -->
                    <div id="edit-tab-overview" class="edit-tab-content" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <!-- Personal Summary -->
                            <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <h4 style="color: #3B82F6; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>üë§</span> Informa√ß√µes Pessoais
                                </h4>
                                <div style="display: grid; gap: 0.75rem; color: #CBD5E1;">
                                    <div><strong>Nome:</strong> <span id="overviewFullName">-</span></div>
                                    <div><strong>Email:</strong> <span id="overviewEmail">-</span></div>
                                    <div><strong>Telefone:</strong> <span id="overviewPhone">-</span></div>
                                    <div><strong>CPF:</strong> <span id="overviewCpf">-</span></div>
                                </div>
                            </div>

                            <!-- Academy Summary -->
                            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(139, 92, 246, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                                <h4 style="color: #10B981; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>ü•ã</span> Status Academia
                                </h4>
                                <div style="display: grid; gap: 0.75rem; color: #CBD5E1;">
                                    <div><strong>Categoria:</strong> <span id="overviewCategory">-</span></div>
                                    <div><strong>Status:</strong> <span id="overviewStatus">-</span></div>
                                    <div><strong>Matr√≠cula:</strong> <span id="overviewEnrollment">-</span></div>
                                    <div><strong>Condi√ß√£o F√≠sica:</strong> <span id="overviewPhysical">-</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Academic Tab -->
                    <div id="edit-tab-academic" class="edit-tab-content" style="display: none;">
                        <div style="text-align: center; padding: 3rem; color: #6B7280;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üéì</div>
                            <p>Carregando informa√ß√µes acad√™micas...</p>
                        </div>
                    </div>

                    <div id="edit-tab-classes" class="edit-tab-content" style="display: none;">
                        <div style="text-align: center; padding: 3rem; color: #6B7280;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üè´</div>
                            <p>Carregando informa√ß√µes de turmas...</p>
                        </div>
                    </div>

                    <!-- Progress Tab -->
                    <div id="edit-tab-progress" class="edit-tab-content" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                            <!-- XP Stats -->
                            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(139, 92, 246, 0.3); text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚≠ê</div>
                                <div style="color: #8B5CF6; font-size: 1.5rem; font-weight: bold;" id="progressXP">1,250</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">XP Total</div>
                            </div>
                            <!-- Level -->
                            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(16, 185, 129, 0.3); text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üèÜ</div>
                                <div style="color: #10B981; font-size: 1.5rem; font-weight: bold;" id="progressLevel">N√≠vel 5</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">Gradua√ß√£o</div>
                            </div>
                            <!-- Streak -->
                            <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(245, 158, 11, 0.3); text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üî•</div>
                                <div style="color: #F59E0B; font-size: 1.5rem; font-weight: bold;" id="progressStreak">7 dias</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">Sequ√™ncia</div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Tab -->
                    <div id="edit-tab-financial" class="edit-tab-content" style="display: none;">
                        <!-- Current Plan Section -->
                        <div style="margin-bottom: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 style="color: #F8FAFC; margin: 0; font-size: 1.25rem;">üìã Plano Atual</h3>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-secondary btn-sm" onclick="loadStudentFinancialTab()" style="padding: 0.5rem 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; font-size: 0.875rem;">
                                        üîÑ Atualizar
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="openEditStudentPlan()" style="padding: 0.5rem 1rem;">
                                        ‚úèÔ∏è Editar Plano
                                    </button>
                                </div>
                            </div>
                            
                            <div id="currentPlanContainer" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(29, 78, 216, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <div class="loading-state">
                                    <div style="text-align: center; color: #94A3B8;">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìÑ</div>
                                        <p>Carregando informa√ß√µes do plano...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <!-- Payment Status -->
                            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                                <h4 style="color: #10B981; margin: 0 0 1rem 0;">üí≥ Status Pagamento</h4>
                                <div id="paymentStatusContainer" style="color: #CBD5E1;">
                                    <div class="loading-state">
                                        <div style="text-align: center; color: #94A3B8;">
                                            <p>Carregando status...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payment History -->
                            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(124, 58, 237, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                                <h4 style="color: #8B5CF6; margin: 0 0 1rem 0;">üìä Hist√≥rico de Pagamentos</h4>
                                <div id="paymentHistoryContainer" style="color: #CBD5E1; font-size: 0.875rem;">
                                    <div class="loading-state">
                                        <div style="text-align: center; color: #94A3B8;">
                                            <p>Carregando hist√≥rico...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Available Plans for Upgrade -->
                        <div style="margin-top: 2rem;">
                            <h3 style="color: #F8FAFC; margin: 0 0 1rem 0; font-size: 1.25rem;">üöÄ Planos Dispon√≠veis para Upgrade</h3>
                            <div id="availablePlansContainer" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(217, 119, 6, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                                <div class="loading-state">
                                    <div style="text-align: center; color: #94A3B8;">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚¨ÜÔ∏è</div>
                                        <p>Carregando planos dispon√≠veis...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Tab -->
                    <div id="edit-tab-activity" class="edit-tab-content" style="display: none;">
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(29, 78, 216, 0.05)); border-radius: 12px; padding: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">üìä Frequ√™ncia Recente</h4>
                            <div style="color: #CBD5E1;">
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #374151;">
                                    <span>02/07/2025 - Aula 15</span>
                                    <span style="color: #10B981;">‚úÖ Presente</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #374151;">
                                    <span>27/06/2025 - Aula 14</span>
                                    <span style="color: #10B981;">‚úÖ Presente</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #374151;">
                                    <span>25/06/2025 - Aula 13</span>
                                    <span style="color: #EF4444;">‚ùå Ausente</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditStudentModal()">
                    Cancelar
                </button>
                <button type="button" id="saveEditStudentBtn" class="btn btn-primary" onclick="saveEditStudent()">
                    üíæ Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>

    <!-- Add Financial Responsible Modal -->
    <div id="addResponsibleModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2 class="modal-title">Novo Respons√°vel Financeiro</h2>
                <button class="close-btn" onclick="closeModal('addResponsibleModal')">&times;</button>
            </div>
            <form id="addResponsibleForm">
                <div class="form-section">
                    <h3>Dados Pessoais</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-input" id="responsibleName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CPF/CNPJ *</label>
                            <input type="text" class="form-input" id="responsibleCpfCnpj" required placeholder="000.000.000-00">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-input" id="responsibleEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefone</label>
                            <input type="tel" class="form-input" id="responsiblePhone" placeholder="(11) 99999-9999">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-input" id="responsibleBirthDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Rela√ß√£o</label>
                            <select class="form-select" id="responsibleRelationType">
                                <option value="">Selecione...</option>
                                <option value="PARENT">Pai/M√£e</option>
                                <option value="GUARDIAN">Respons√°vel Legal</option>
                                <option value="SPOUSE">C√¥njuge</option>
                                <option value="RELATIVE">Familiar</option>
                                <option value="OTHER">Outro</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Endere√ßo</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Endere√ßo</label>
                            <input type="text" class="form-input" id="responsibleAddress" placeholder="Rua, Avenida, etc.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√∫mero</label>
                            <input type="text" class="form-input" id="responsibleAddressNumber" placeholder="123">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Complemento</label>
                            <input type="text" class="form-input" id="responsibleComplement" placeholder="Apto, Bloco, etc.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bairro</label>
                            <input type="text" class="form-input" id="responsibleNeighborhood">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-input" id="responsibleCity">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="responsibleState">
                                <option value="">Selecione...</option>
                                <option value="SP">S√£o Paulo</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="ES">Esp√≠rito Santo</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="PR">Paran√°</option>
                                <option value="RS">Rio Grande do Sul</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-input" id="responsibleZipCode" placeholder="00000-000">
                        </div>
                        <div class="form-group"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addResponsibleModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar Respons√°vel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Financial Responsible Modal -->
    <div id="editResponsibleModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2 class="modal-title">Editar Respons√°vel Financeiro</h2>
                <button class="close-btn" onclick="closeModal('editResponsibleModal')">&times;</button>
            </div>
            <form id="editResponsibleForm">
                <input type="hidden" id="editResponsibleId">
                <div class="form-section">
                    <h3>Dados Pessoais</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-input" id="editResponsibleName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CPF/CNPJ *</label>
                            <input type="text" class="form-input" id="editResponsibleCpfCnpj" required readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-input" id="editResponsibleEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefone</label>
                            <input type="tel" class="form-input" id="editResponsiblePhone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-input" id="editResponsibleBirthDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Rela√ß√£o</label>
                            <select class="form-select" id="editResponsibleRelationType">
                                <option value="">Selecione...</option>
                                <option value="PARENT">Pai/M√£e</option>
                                <option value="GUARDIAN">Respons√°vel Legal</option>
                                <option value="SPOUSE">C√¥njuge</option>
                                <option value="RELATIVE">Familiar</option>
                                <option value="OTHER">Outro</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editResponsibleModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modern Plan Creation Modal with Tabs -->
    <div id="addPlanModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">‚ú® Criar Novo Plano de Pagamento</h2>
                <button class="close-btn" onclick="closeModal('addPlanModal')">&times;</button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="plan-tabs">
                <button type="button" class="plan-tab active" onclick="switchPlanTab('basic')" data-tab="basic">
                    üìã Informa√ß√µes B√°sicas
                </button>
                <button type="button" class="plan-tab" onclick="switchPlanTab('courses')" data-tab="courses">
                    üéì Cursos Associados
                </button>
                <button type="button" class="plan-tab" onclick="switchPlanTab('advanced')" data-tab="advanced">
                    ‚öôÔ∏è Configura√ß√µes
                </button>
                <button type="button" class="plan-tab" onclick="switchPlanTab('preview')" data-tab="preview">
                    üëÅÔ∏è Preview
                </button>
            </div>
            
            <form id="addPlanForm">
                <!-- Tab 1: Basic Information -->
                <div id="planTab-basic" class="plan-tab-content active">
                    <div class="tab-header">
                        <h3>üìã Informa√ß√µes B√°sicas do Plano</h3>
                        <p>Configure os dados fundamentais do seu plano de pagamento</p>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Nome do Plano *</label>
                            <input type="text" class="form-input" id="planName" placeholder="Ex: Plano Premium Krav Maga" required>
                            <small class="form-hint">üîÑ Ser√° gerado automaticamente baseado nos cursos selecionados</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Categoria *</label>
                            <select class="form-select" id="planCategory" required onchange="updatePlanPreview()">
                                <option value="">Selecione uma categoria...</option>
                                <option value="ADULT">üë® Adulto</option>
                                <option value="FEMALE">üë© Feminino</option>
                                <option value="SENIOR">üë¥ Senior/Idoso</option>
                                <option value="CHILD">üßí Infantil/Crian√ßa</option>
                                <option value="INICIANTE1">ü•â Iniciante 1</option>
                                <option value="INICIANTE2">ü•â Iniciante 2</option>
                                <option value="INICIANTE3">ü•â Iniciante 3</option>
                                <option value="HEROI1">ü•à Her√≥i 1</option>
                                <option value="HEROI2">ü•à Her√≥i 2</option>
                                <option value="HEROI3">ü•à Her√≥i 3</option>
                                <option value="MASTER_1">ü•á Master 1</option>
                                <option value="MASTER_2">ü•á Master 2</option>
                                <option value="MASTER_3">ü•á Master 3</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Valor do Plano *</label>
                            <input type="number" class="form-input" id="planCustomPrice" step="0.01" placeholder="R$ 0,00" required>
                            <small class="form-hint">üí∞ Insira o valor do plano conforme sua estrat√©gia de pre√ßos</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tipo de Cobran√ßa *</label>
                            <select class="form-select" id="planBillingType" required onchange="updatePlanPreview()">
                                <option value="MONTHLY">üí≥ Mensal</option>
                                <option value="WEEKLY">üìÖ Semanal</option>
                                <option value="QUARTERLY">üìä Trimestral</option>
                                <option value="YEARLY">üóìÔ∏è Anual</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label">Descri√ß√£o do Plano</label>
                        <textarea class="form-input" id="planDescription" rows="3" placeholder="Descri√ß√£o detalhada dos benef√≠cios e caracter√≠sticas do plano..."></textarea>
                    </div>
                    
                    <div class="tab-navigation">
                        <button type="button" class="btn btn-primary" onclick="switchPlanTab('courses')">
                            Pr√≥ximo: Cursos Associados ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Tab 2: Associated Courses -->
                <div id="planTab-courses" class="plan-tab-content">
                    <div class="tab-header">
                        <h3>üéì Cursos Associados ao Plano</h3>
                        <p>Selecione todos os cursos que estar√£o inclusos neste plano</p>
                    </div>
                    
                    <div class="courses-selection-container">
                        <div class="selection-header">
                            <div class="selection-stats">
                                <span class="stat-badge" id="coursesSelectedCount">0 cursos selecionados</span>
                                <span class="stat-badge" id="coursesTotalCount">0 cursos dispon√≠veis</span>
                            </div>
                            <div class="selection-actions">
                                <button type="button" class="btn btn-sm btn-outline" onclick="selectAllCourses()">Selecionar Todos</button>
                                <button type="button" class="btn btn-sm btn-outline" onclick="clearAllCourses()">Limpar Sele√ß√£o</button>
                            </div>
                        </div>
                        
                        <div class="courses-grid" id="coursesGrid">
                            <!-- Courses will be loaded here dynamically -->
                            <div class="loading-state">
                                <div class="spinner"></div>
                                <p>Carregando cursos dispon√≠veis...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-navigation">
                        <button type="button" class="btn btn-secondary" onclick="switchPlanTab('basic')">
                            ‚Üê Voltar: Informa√ß√µes B√°sicas
                        </button>
                        <button type="button" class="btn btn-primary" onclick="switchPlanTab('advanced')">
                            Pr√≥ximo: Configura√ß√µes ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Tab 3: Advanced Configuration -->
                <div id="planTab-advanced" class="plan-tab-content">
                    <div class="tab-header">
                        <h3>‚öôÔ∏è Configura√ß√µes Avan√ßadas</h3>
                        <p>Configure recursos especiais e limita√ß√µes do plano</p>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Aulas por Semana</label>
                            <select class="form-select" id="planClassesPerWeek">
                                <option value="1">1 aula por semana</option>
                                <option value="2" selected>2 aulas por semana</option>
                                <option value="3">3 aulas por semana</option>
                                <option value="4">4 aulas por semana</option>
                                <option value="5">5 aulas por semana</option>
                                <option value="unlimited">‚ôæÔ∏è Ilimitado</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">M√°ximo de Aulas por M√™s</label>
                            <input type="number" class="form-input" id="planMaxClasses" min="1" max="50" placeholder="Ex: 8 aulas">
                            <small class="form-hint">Deixe em branco para ilimitado</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Recursos Extras</label>
                        <div class="extras-grid">
                            <label class="checkbox-label">
                                <input type="checkbox" id="planPersonalTraining"> 
                                üí™ Personal Training
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="planNutrition"> 
                                ü•ó Plano Nutricional
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="planAllModalities"> 
                                ü•ã Todas Modalidades
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="planFreezeOption"> 
                                ‚ùÑÔ∏è Permite Congelar
                            </label>
                        </div>
                    </div>
                    
                    <div class="tab-navigation">
                        <button type="button" class="btn btn-secondary" onclick="switchPlanTab('courses')">
                            ‚Üê Voltar: Cursos Associados
                        </button>
                        <button type="button" class="btn btn-primary" onclick="switchPlanTab('preview')">
                            Pr√≥ximo: Preview ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Tab 4: Preview -->
                <div id="planTab-preview" class="plan-tab-content">
                    <div class="tab-header">
                        <h3>üëÅÔ∏è Preview do Plano</h3>
                        <p>Visualize como o plano ficar√° antes de criar</p>
                    </div>
                    
                    <div id="planPreview" class="preview-container">
                        <div class="preview-card">
                            <div class="preview-header">
                                <h4 id="previewPlanName">Nome do Plano</h4>
                                <div class="preview-price" id="previewPlanPrice">R$ 0,00</div>
                            </div>
                            <div class="preview-body">
                                <p id="previewPlanDescription">Descri√ß√£o do plano</p>
                                <div class="preview-details">
                                    <div class="detail-item">
                                        <span class="detail-label">Categoria:</span>
                                        <span class="detail-value" id="previewCategory">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Tipo de Cobran√ßa:</span>
                                        <span class="detail-value" id="previewBillingType">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Cursos Inclusos:</span>
                                        <span class="detail-value" id="previewCourses">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Aulas por Semana:</span>
                                        <span class="detail-value" id="previewClassesPerWeek">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-navigation">
                        <button type="button" class="btn btn-secondary" onclick="switchPlanTab('advanced')">
                            ‚Üê Voltar: Configura√ß√µes
                        </button>
                        <button type="submit" class="btn btn-primary btn-large">
                            ‚ú® Criar Plano
                        </button>
                    </div>
                </div>
                
                <!-- Hidden legacy field for compatibility -->
                <select id="planCourse" multiple style="display: none;"></select>
            </form>
        </div>
    </div>
            </form>
        </div>
    </div>

    <!-- Add Course Modal -->
    <div id="addCourseModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Novo Curso</h2>
                <button class="close-btn" onclick="closeModal('addCourseModal')">&times;</button>
            </div>
            <form id="addCourseForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Nome do Curso</label>
                        <input type="text" class="form-input" id="courseName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select class="form-select" id="courseCategory" required>
                            <option value="ADULT">Adulto</option>
                            <option value="INICIANTE1">Iniciante 1</option>
                            <option value="INICIANTE2">Iniciante 2</option>
                            <option value="INICIANTE3">Iniciante 3</option>
                            <option value="HEROI1">Her√≥i 1</option>
                            <option value="HEROI2">Her√≥i 2</option>
                            <option value="HEROI3">Her√≥i 3</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descri√ß√£o</label>
                    <textarea class="form-input" id="courseDescription" rows="3"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">N√≠vel</label>
                        <select class="form-select" id="courseLevel" required>
                            <option value="BEGINNER">Iniciante</option>
                            <option value="INTERMEDIATE">Intermedi√°rio</option>
                            <option value="ADVANCED">Avan√ßado</option>
                            <option value="EXPERT">Especialista</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total de Aulas</label>
                        <input type="number" class="form-input" id="courseTotalClasses" min="1" max="100" value="48" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Aulas por Semana</label>
                        <input type="number" class="form-input" id="courseClassesPerWeek" min="1" max="7" value="2" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Dura√ß√£o (semanas)</label>
                        <input type="number" class="form-input" id="courseDuration" min="1" max="52" value="24" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Idade M√≠nima</label>
                        <input type="number" class="form-input" id="courseMinAge" min="5" max="100" value="16" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Idade M√°xima</label>
                        <input type="number" class="form-input" id="courseMaxAge" min="5" max="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Objetivos do Curso (um por linha)</label>
                    <textarea class="form-input" id="courseObjectives" rows="4" 
                        placeholder="Ex: Desenvolver t√©cnicas b√°sicas de defesa pessoal&#10;Melhorar condicionamento f√≠sico&#10;Aumentar autoconfian√ßa"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Requisitos (um por linha)</label>
                    <textarea class="form-input" id="courseRequirements" rows="3" 
                        placeholder="Ex: Atestado m√©dico&#10;Termo de responsabilidade&#10;Uniforme adequado"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCourseModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Curso</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Course Modal -->
    <div id="editCourseModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Editar Curso</h2>
                <button class="close-btn" onclick="closeModal('editCourseModal')">&times;</button>
            </div>
            <form id="editCourseForm">
                <input type="hidden" id="editCourseId">
                <!-- Same fields as add course, but with edit prefix -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Nome do Curso</label>
                        <input type="text" class="form-input" id="editCourseName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select class="form-select" id="editCourseCategory" required>
                            <option value="ADULT">Adulto</option>
                            <option value="INICIANTE1">Iniciante 1</option>
                            <option value="INICIANTE2">Iniciante 2</option>
                            <option value="INICIANTE3">Iniciante 3</option>
                            <option value="HEROI1">Her√≥i 1</option>
                            <option value="HEROI2">Her√≥i 2</option>
                            <option value="HEROI3">Her√≥i 3</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descri√ß√£o</label>
                    <textarea class="form-input" id="editCourseDescription" rows="3"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">N√≠vel</label>
                        <select class="form-select" id="editCourseLevel" required>
                            <option value="BEGINNER">Iniciante</option>
                            <option value="INTERMEDIATE">Intermedi√°rio</option>
                            <option value="ADVANCED">Avan√ßado</option>
                            <option value="EXPERT">Especialista</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total de Aulas</label>
                        <input type="number" class="form-input" id="editCourseTotalClasses" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Aulas por Semana</label>
                        <input type="number" class="form-input" id="editCourseClassesPerWeek" min="1" max="7" required>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editCourseModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Add Subscription Modal -->
    <div id="addSubscriptionModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Nova Assinatura</h2>
                <button class="close-btn" onclick="closeModal('addSubscriptionModal')">&times;</button>
            </div>
            <form id="addSubscriptionForm">
                <div class="form-group">
                    <label class="form-label">Aluno</label>
                    <select class="form-select" id="subscriptionStudent" required>
                        <option value="">Selecione um aluno...</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Plano</label>
                    <select class="form-select" id="subscriptionPlan" required>
                        <option value="">Selecione um plano...</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Data de In√≠cio</label>
                        <input type="date" class="form-input" id="subscriptionStartDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pre√ßo Personalizado (opcional)</label>
                        <input type="number" class="form-input" id="subscriptionCustomPrice" placeholder="Deixe vazio para usar pre√ßo do plano" step="0.01" min="0">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addSubscriptionModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Assinatura</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lesson Plan Modal -->
    <div id="lessonPlanModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Plano de Aula</h2>
                <button class="close-btn" onclick="closeModal('lessonPlanModal')">&times;</button>
            </div>
            <form id="lessonPlanForm">
                <input type="hidden" id="lessonCourseId">
                <input type="hidden" id="lessonNumber">
                
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">T√≠tulo da Aula</label>
                        <input type="text" class="form-input" id="lessonTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dura√ß√£o (min)</label>
                        <input type="number" class="form-input" id="lessonDuration" min="30" max="180" value="60" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dificuldade</label>
                        <select class="form-select" id="lessonDifficulty" required>
                            <option value="BEGINNER">Iniciante</option>
                            <option value="INTERMEDIATE">Intermedi√°rio</option>
                            <option value="ADVANCED">Avan√ßado</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Objetivos da Aula</label>
                    <textarea class="form-input" id="lessonObjectives" rows="2" 
                        placeholder="Ex: Aprender t√©cnica de soco direto, Praticar defesa contra estrangulamento"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Aquecimento (10-15 min)</label>
                    <textarea class="form-input" id="lessonWarmUp" rows="3" 
                        placeholder="Ex: Corrida leve, alongamento din√¢mico, exerc√≠cios articulares"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Conte√∫do Principal (30-40 min)</label>
                    <textarea class="form-input" id="lessonMainContent" rows="4" 
                        placeholder="Ex: Demonstra√ß√£o da t√©cnica, pr√°tica em pares, aplica√ß√£o em situa√ß√µes simuladas"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Desaquecimento (5-10 min)</label>
                    <textarea class="form-input" id="lessonCoolDown" rows="2" 
                        placeholder="Ex: Alongamento est√°tico, respira√ß√£o, relaxamento"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Equipamentos Necess√°rios</label>
                    <input type="text" class="form-input" id="lessonEquipment" 
                        placeholder="Ex: Paos, luvas, colchonetes (separar por v√≠rgula)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Adapta√ß√µes para Necessidades Especiais</label>
                    <textarea class="form-input" id="lessonAdaptations" rows="2" 
                        placeholder="Ex: Exerc√≠cios modificados para pessoas com mobilidade reduzida"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Observa√ß√µes e Notas</label>
                    <textarea class="form-input" id="lessonNotes" rows="2" 
                        placeholder="Ex: Enfatizar seguran√ßa, aten√ß√£o especial ao alinhamento corporal"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('lessonPlanModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Plano</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lesson Feedback Modal -->
    <div id="lessonFeedbackModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Feedback P√≥s-Aula</h2>
                <button class="close-btn" onclick="closeModal('lessonFeedbackModal')">&times;</button>
            </div>
            <form id="lessonFeedbackForm">
                <input type="hidden" id="feedbackCourseId">
                <input type="hidden" id="feedbackLessonNumber">
                
                <div class="form-group">
                    <label class="form-label">Como foi a aula? (Geral)</label>
                    <textarea class="form-input" id="feedbackGeneral" rows="3" 
                        placeholder="Ex: Aula correu bem, alunos participativos, t√©cnica foi bem assimilada"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Dificuldades Observadas</label>
                    <textarea class="form-input" id="feedbackDifficulties" rows="3" 
                        placeholder="Ex: Alguns alunos tiveram dificuldade com o movimento de quadril"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Melhorias para Pr√≥xima Aula</label>
                    <textarea class="form-input" id="feedbackImprovements" rows="3" 
                        placeholder="Ex: Revisar t√©cnica b√°sica, dar mais tempo para pr√°tica individual"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Alunos Presentes</label>
                    <input type="number" class="form-input" id="feedbackStudentsPresent" min="0">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('lessonFeedbackModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Feedback</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { showToast } from './js/ui.js';
        window.showToast = showToast;
    </script>
    <script>
        // ... existing code ...
        // Functions will be assigned to window later when they are defined
    </script>
    <script type="module">
        import { 
            loadAttendance, 
            renderAttendance, 
            checkIn 
        } from './js/attendance.js';

        // Attach to window for inline event handlers
        window.loadAttendance = loadAttendance;
        window.renderAttendance = renderAttendance;
        window.checkIn = checkIn;
    </script>
    <script type="module" src="./js/main.js"></script>
    <script type="module">
        import { 
            loadSettings, 
            renderSettings, 
            saveSettings 
        } from './js/settings.js';

        // Attach to window for inline event handlers
        window.loadSettings = loadSettings;
        window.renderSettings = renderSettings;
        window.saveSettings = saveSettings;
    </script>
    <script>
        // ==========================================
        // GLOBAL VARIABLES
        // ==========================================
        
        // Knowledge Base System
        let knowledgeBase = [];
        let ragChunks = [];
        let uploadedDocuments = [];
        
        // Make variables globally accessible
        window.ragChunks = ragChunks;
        let currentUploadTab = 'documents';
        
        // ==========================================
        // KNOWLEDGE BASE PERSISTENCE FUNCTIONS
        // ==========================================
        
        // Save knowledge base to localStorage
        function saveKnowledgeBaseToStorage() {
            try {
                localStorage.setItem('academiaKnowledgeBase', JSON.stringify(knowledgeBase));
                localStorage.setItem('academiaRAGChunks', JSON.stringify(ragChunks));
                console.log('üíæ Base de conhecimento salva no localStorage');
            } catch (error) {
                console.error('‚ùå Erro ao salvar base de conhecimento:', error);
            }
        }
        
        // Load knowledge base from localStorage
        function loadKnowledgeBaseFromStorage() {
            try {
                const storedKnowledgeBase = localStorage.getItem('academiaKnowledgeBase');
                const storedRAGChunks = localStorage.getItem('academiaRAGChunks');
                
                if (storedKnowledgeBase) {
                    knowledgeBase = JSON.parse(storedKnowledgeBase);
                    console.log('üìö Base de conhecimento carregada do localStorage:', knowledgeBase.length, 'itens');
                }
                
                if (storedRAGChunks) {
                    ragChunks = JSON.parse(storedRAGChunks);
                    console.log('üß† Chunks RAG carregados do localStorage:', ragChunks.length, 'chunks');
                } else if (knowledgeBase.length > 0) {
                    // Regenerate chunks if knowledge base exists but chunks don't
                    generateRAGChunks();
                }
                
                return knowledgeBase.length > 0;
            } catch (error) {
                console.error('‚ùå Erro ao carregar base de conhecimento:', error);
                return false;
            }
        }
        
        // Clear knowledge base from localStorage
        function clearKnowledgeBaseStorage() {
            try {
                localStorage.removeItem('academiaKnowledgeBase');
                localStorage.removeItem('academiaRAGChunks');
                knowledgeBase = [];
                ragChunks = [];
                console.log('üóëÔ∏è Base de conhecimento limpa do localStorage');
            } catch (error) {
                console.error('‚ùå Erro ao limpar base de conhecimento:', error);
            }
        }
        
        // Define essential functions immediately
        window.openKnowledgeUploader = function() {
            console.log('üìö Abrindo base de conhecimento...');
            try {
                openDocumentUploader();
            } catch (error) {
                console.error('‚ùå Erro ao abrir document uploader:', error);
                alert('Erro ao abrir o modal de upload. Verifique o console.');
            }
        };
        
        window.testRAGSystem = function() {
            console.log('üó∫Ô∏è Abrindo teste RAG...');
            document.getElementById('ragTestModal').classList.add('active');
        };
        
        window.reindexKnowledgeBase = function() {
            console.log('‚ö° Reindexando base...');
            try {
                if (typeof generateRAGChunks === 'function') {
                    generateRAGChunks();
                }
                if (typeof updateKnowledgeBaseStats === 'function') {
                    updateKnowledgeBaseStats();
                }
                if (typeof showToast === 'function') {
                    showToast('Base reindexada!', 'success');
                }
            } catch (error) {
                console.error('‚ùå Erro ao reindexar:', error);
            }
        };
        
        window.searchKnowledgeBase = function() {
            console.log('üîç Buscando...');
            try {
                const query = document.getElementById('knowledgeSearchInput')?.value.trim();
                if (query && typeof searchKnowledgeContentInMain === 'function') {
                    searchKnowledgeContentInMain(query);
                } else if (typeof displayKnowledgeContentInMain === 'function') {
                    displayKnowledgeContentInMain();
                }
            } catch (error) {
                console.error('‚ùå Erro na busca:', error);
            }
        };
        
        // Global variables for student editing
        let currentEditingStudentId = null;
        let currentEditingStudent = null;

        // Dedicated student edit page function (uses full page) - MOVED TO TOP
        async function openStudentEditPage(studentId) {
            try {
                console.log('üîÑ Abrindo p√°gina de edi√ß√£o do aluno:', studentId);
                console.log('üîç Debug: studentId recebido:', studentId, typeof studentId);
                
                if (!studentId) {
                    throw new Error('ID do estudante n√£o fornecido');
                }
                
                currentEditingStudentId = studentId;

                // Find student in existing data first
                let student = null;
                console.log('üîç Debug: Verificando allStudents:', typeof window.allStudents, window.allStudents ? window.allStudents.length : 'undefined');
                
                if (typeof window.allStudents !== 'undefined' && window.allStudents) {
                    student = window.allStudents.find(s => s.id === studentId);
                    console.log('üîç Debug: Estudante encontrado em allStudents:', !!student);
                }
                
                if (!student) {
                    console.log('üîç Debug: Buscando estudante via API...');
                    // Fallback: fetch from API
                    const response = await fetch(`/api/students`);
                    const data = await response.json();
                    
                    console.log('üîç Debug: Resposta da API:', data.success, data.data ? data.data.length : 'sem dados');
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Erro ao carregar dados do estudante');
                    }
                    
                    student = data.data.find(s => s.id === studentId);
                    console.log('üîç Debug: Estudante encontrado na API:', !!student);
                }

                if (!student) {
                    throw new Error('Estudante n√£o encontrado com ID: ' + studentId);
                }

                console.log('‚úÖ Debug: Estudante carregado:', student.user?.firstName, student.user?.lastName);
                currentEditingStudent = student;
                
                // Check if elements exist before manipulating them
                const studentsSection = document.getElementById('students');
                const editPageSection = document.getElementById('student-edit-page');
                
                console.log('üîç Debug: Elementos DOM encontrados:', !!studentsSection, !!editPageSection);
                
                if (!studentsSection || !editPageSection) {
                    throw new Error('Elementos da p√°gina n√£o encontrados');
                }
                
                // Hide students list and show edit page
                studentsSection.style.display = 'none';
                editPageSection.style.display = 'block';
                
                console.log('‚úÖ Debug: Tela de edi√ß√£o exibida');
                
                // Update page header with student info
                try {
                    updateEditPageHeader(student);
                    console.log('‚úÖ Debug: Header atualizado');
                } catch (headerError) {
                    console.error('‚ùå Erro no header:', headerError);
                }
                
                // Load the edit form
                try {
                    loadEditPageForm(student);
                    console.log('‚úÖ Debug: Formul√°rio carregado');
                } catch (formError) {
                    console.error('‚ùå Erro no formul√°rio:', formError);
                }
                
                // Update sidebar with student stats
                try {
                    updateEditPageSidebar(student);
                    console.log('‚úÖ Debug: Sidebar atualizado');
                } catch (sidebarError) {
                    console.error('‚ùå Erro no sidebar:', sidebarError);
                }
                
                // Set active tab to edit
                try {
                    switchPageTab('edit');
                    console.log('‚úÖ Debug: Tab ativado');
                } catch (tabError) {
                    console.error('‚ùå Erro no tab:', tabError);
                }
                
                console.log('‚úÖ P√°gina de edi√ß√£o carregada com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir p√°gina de edi√ß√£o:', error);
                alert(`Erro ao abrir edi√ß√£o: ${error.message}`); // Usando alert para garantir que vemos o erro
            }
        }

        // Update edit page header with student information
        function updateEditPageHeader(student) {
            const user = student.user || {};
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'Aluno sem nome';
            const studentId = student.id;
            const category = student.category || 'N/A';
            
            document.getElementById('editPageStudentName').textContent = fullName;
            document.getElementById('editPageStudentId').textContent = `ID: ${studentId}`;
            document.getElementById('editPageStudentCategory').textContent = `Categoria: ${category}`;
        }

        // Load form in the edit page
        function loadEditPageForm(student) {
            const formContainer = document.getElementById('pageFormContainer');
            
            // Create form HTML with all student fields
            formContainer.innerHTML = `
                <form id="editPageStudentForm" style="display: grid; gap: 2rem;">
                    <!-- Personal Information Section -->
                    <div style="background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                        <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            üë§ Informa√ß√µes Pessoais
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="pageFirstName" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Nome</label>
                                <input type="text" id="pageFirstName" value="${student.user?.firstName || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;" required>
                            </div>
                            <div class="form-group">
                                <label for="pageLastName" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Sobrenome</label>
                                <input type="text" id="pageLastName" value="${student.user?.lastName || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;" required>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label for="pageEmail" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Email</label>
                                <input type="email" id="pageEmail" value="${student.user?.email || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;" required>
                            </div>
                            <div class="form-group">
                                <label for="pagePhone" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Telefone</label>
                                <input type="tel" id="pagePhone" value="${student.user?.phone || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;">
                            </div>
                        </div>
                    </div>

                    <!-- Academic Information Section -->
                    <div style="background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                        <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            ü•ã Informa√ß√µes Acad√™micas
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="pageCategory" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Categoria</label>
                                <select id="pageCategory" style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;">
                                    <option value="ADULT" ${student.category === 'ADULT' ? 'selected' : ''}>Adulto</option>
                                    <option value="CHILD" ${student.category === 'CHILD' ? 'selected' : ''}>Crian√ßa</option>
                                    <option value="INICIANTE1" ${student.category === 'INICIANTE1' ? 'selected' : ''}>Iniciante 1</option>
                                    <option value="INICIANTE2" ${student.category === 'INICIANTE2' ? 'selected' : ''}>Iniciante 2</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pageGender" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">G√™nero</label>
                                <select id="pageGender" style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;">
                                    <option value="MASCULINO" ${student.gender === 'MASCULINO' ? 'selected' : ''}>Masculino</option>
                                    <option value="FEMININO" ${student.gender === 'FEMININO' ? 'selected' : ''}>Feminino</option>
                                    <option value="OUTRO" ${student.gender === 'OUTRO' ? 'selected' : ''}>Outro</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <label for="pagePhysicalCondition" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Condi√ß√£o F√≠sica</label>
                            <select id="pagePhysicalCondition" style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;">
                                <option value="INICIANTE" ${student.physicalCondition === 'INICIANTE' ? 'selected' : ''}>Iniciante</option>
                                <option value="INTERMEDIARIO" ${student.physicalCondition === 'INTERMEDIARIO' ? 'selected' : ''}>Intermedi√°rio</option>
                                <option value="AVANCADO" ${student.physicalCondition === 'AVANCADO' ? 'selected' : ''}>Avan√ßado</option>
                            </select>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div style="background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                        <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            üìã Informa√ß√µes Adicionais
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div class="form-group">
                                <label for="pageEmergencyContact" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Contato de Emerg√™ncia</label>
                                <input type="text" id="pageEmergencyContact" value="${student.emergencyContact || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC;">
                            </div>
                            <div class="form-group">
                                <label for="pageMedicalConditions" style="color: #94A3B8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Condi√ß√µes M√©dicas</label>
                                <textarea id="pageMedicalConditions" rows="3" 
                                          style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; color: #F8FAFC; resize: vertical;">${student.medicalConditions || ''}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields -->
                    <input type="hidden" id="pageStudentId" value="${student.id}">
                    <input type="hidden" id="pageUserId" value="${student.userId}">
                </form>
            `;

            // Add real-time form validation
            const inputs = formContainer.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', updatePageFormProgress);
            });

            updatePageFormProgress();
            
            // Pre-load financial tab content to ensure plan information is available
            setTimeout(() => {
                console.log('üîÑ Pre-loading financial tab...');
                loadStudentFinancialTab();
            }, 1000);
        }

        // Update sidebar with student stats
        function updateEditPageSidebar(student) {
            document.getElementById('sidebarXP').textContent = student.totalXP || '0';
            document.getElementById('sidebarLevel').textContent = `Nv. ${student.globalLevel || '1'}`;
            document.getElementById('sidebarStreak').textContent = `${student.currentStreak || '0'} dias`;
        }

        // Switch between page tabs
        function switchPageTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.page-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.page-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = '#94A3B8';
            });

            // Show selected tab content
            const selectedTab = document.getElementById(`page-tab-${tabName}`);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }

            // Add active class to selected tab button
            const selectedBtn = document.querySelector(`[data-page-tab="${tabName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
                selectedBtn.style.background = 'linear-gradient(135deg, #3B82F6, #1D4ED8)';
                selectedBtn.style.color = 'white';
            }

            // Load specific tab content
            loadPageTabContent(tabName);
        }

        // Load content for specific tab
        function loadPageTabContent(tabName) {
            // Use centralized functions from students.js module
            switch (tabName) {
                case 'ai-dashboard':
                    if (window.loadAIDashboardContent) {
                        window.loadAIDashboardContent();
                    }
                    break;
                case 'plans':
                    if (window.loadPlansTabContent) {
                        window.loadPlansTabContent();
                    }
                    break;
                case 'classes':
                    console.log('üéØ Carregando aba de turmas...');
                    if (window.loadStudentClassesTab) {
                        window.loadStudentClassesTab();
                    }
                    break;
                case 'courses':
                    console.log('üí≥ Carregando aba de assinatura...');
                    if (window.loadStudentSubscriptionTab) {
                        window.loadStudentSubscriptionTab();
                    }
                    break;
                case 'progress':
                    if (window.loadProgressTabContent) {
                        window.loadProgressTabContent();
                    }
                    break;
                default:
                    // Edit tab is already loaded
                    break;
            }
        }

        // Update form progress
        function updatePageFormProgress() {
            const form = document.getElementById('editPageStudentForm');
            if (!form) return;

            const inputs = form.querySelectorAll('input[required], select[required]');
            let completed = 0;
            
            inputs.forEach(input => {
                if (input.value && input.value.trim() !== '') {
                    completed++;
                }
            });
            
            const progress = Math.round((completed / inputs.length) * 100);
            const progressBar = document.getElementById('pageFormProgress');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
        }

        // Tab content loading functions - placeholder implementations
        function loadAIDashboardContent() {
            const content = document.getElementById('page-tab-ai-dashboard');
            if (content) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94A3B8;">
                        ü§ñ Dashboard IA em desenvolvimento
                    </div>
                `;
            }
        }

        async function loadPlansTabContent() {
            const content = document.getElementById('page-tab-plans');
            if (!content) return;
            
            // Get student ID from centralized state management
            const studentId = window.getCurrentEditingStudentId ? window.getCurrentEditingStudentId() : currentEditingStudentId;
            console.log('üéØ Loading plans tab for student:', studentId);
            
            if (!studentId) {
                content.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #EF4444;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ùå</div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">ID do aluno n√£o encontrado</div>
                        <div style="font-size: 0.875rem; color: #94A3B8;">
                            Selecione um aluno para visualizar os planos dispon√≠veis
                        </div>
                    </div>
                `;
                return;
            }
            
            // Update local reference
            currentEditingStudentId = studentId;
            
            // üîí USAR M√ìDULO ISOLADO SE DISPON√çVEL (Desabilitado temporariamente)
            if (false && window.ModuleLoader && window.ModuleLoader.isModuleLoaded('PlansManager')) {
                try {
                    console.log('üîå Usando m√≥dulo PlansManager isolado');
                    
                    // Criar container para o m√≥dulo
                    content.innerHTML = '<div id="isolatedPlansContainer"></div>';
                    
                    // Inicializar e carregar dados
                    const plansManager = window.PlansManager.init(studentId);
                    await plansManager.loadPlansData();
                    
                    // Renderizar interface isolada
                    const success = plansManager.renderPlansInterface('isolatedPlansContainer');
                    
                    if (success) {
                        console.log('‚úÖ Interface de planos carregada via m√≥dulo isolado');
                        if (window.showToast) {
                            window.showToast('üì¶ Usando interface modular protegida', 'info');
                        }
                        return; // Sai da fun√ß√£o, usa m√≥dulo isolado
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è M√≥dulo isolado falhou, usando fallback:', error);
                }
            }
            
            // üîÑ FALLBACK PARA SISTEMA ORIGINAL
            // Show loading state
            content.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; padding: 3rem; color: #94A3B8;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üîÑ</div>
                        <div>Carregando planos e assinaturas...</div>
                    </div>
                </div>
            `;
            
            // Double-check student ID (should already be validated above)
            if (!studentId) {
                console.error('‚ùå Student ID missing after validation');
                return;
            }

            try {
                // Load available billing plans first - try multiple routes
                console.log('üì° Fetching billing plans...');
                let plansData = null;
                let availablePlans = [];
                
                // Try financial route first, then fallback to billing-plans, then mock data
                try {
                    console.log('üîç Tentando rota financeira...');
                    const financialResponse = await fetch('/api/billing-plans');
                    if (financialResponse.ok) {
                        plansData = await financialResponse.json();
                        console.log('üìä Financial plans response:', plansData.success ? `${plansData.data.length} planos` : 'sem dados');
                        // Filtrar apenas planos ativos
                        availablePlans = plansData.success ? 
                            plansData.data.filter(plan => plan.isActive === true) : [];
                        console.log('‚úÖ Planos ativos encontrados:', availablePlans.length);
                    } else {
                        throw new Error(`Financial route returned ${financialResponse.status}`);
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Rota financeira falhou:', error.message, '- tentando billing-plans...');
                    try {
                        const billingResponse = await fetch('/api/billing-plans');
                        if (billingResponse.ok) {
                            plansData = await billingResponse.json();
                            console.log('üìä Billing plans response:', plansData.success ? `${plansData.data.length} planos` : 'sem dados');
                            // Filtrar apenas planos ativos
                            availablePlans = plansData.success ? 
                                plansData.data.filter(plan => plan.isActive === true) : [];
                            console.log('‚úÖ Planos ativos encontrados:', availablePlans.length);
                        } else {
                            throw new Error(`Billing route returned ${billingResponse.status}`);
                        }
                    } catch (billingError) {
                        console.log('‚ö†Ô∏è Ambas as rotas falharam:', billingError.message, '- usando dados mock...');
                        // Use comprehensive mock data as fallback
                        console.log('üìù Carregando 10 planos de demonstra√ß√£o...');
                        
                        // Show info toast about mock data
                        if (typeof showToast === 'function') {
                            showToast('üìù Usando dados de demonstra√ß√£o para planos', 'info');
                        }
                        availablePlans = [
                            {
                                id: 'plan-1',
                                name: 'Plano B√°sico Adulto',
                                description: 'Ideal para iniciantes - 2 aulas por semana com t√©cnicas fundamentais',
                                category: 'ADULT',
                                price: '150.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 2,
                                maxClasses: 8,
                                hasPersonalTraining: false,
                                hasNutrition: false,
                                allowFreeze: true,
                                isActive: true,
                                features: ['Aulas em grupo', 'Material did√°tico', 'Suporte t√©cnico']
                            },
                            {
                                id: 'plan-2',
                                name: 'Plano Premium Adulto',
                                description: 'Acesso ilimitado com benef√≠cios extras e personal training',
                                category: 'ADULT',
                                price: '280.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 0,
                                maxClasses: null,
                                hasPersonalTraining: true,
                                hasNutrition: true,
                                allowFreeze: true,
                                isActive: true,
                                features: ['Aulas ilimitadas', 'Personal training', 'Consultoria nutricional', 'Acesso VIP']
                            },
                            {
                                id: 'plan-3',
                                name: 'Plano Infantil',
                                description: 'Krav Maga Kids - 2 aulas por semana com foco l√∫dico e educativo',
                                category: 'CHILD',
                                price: '120.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 2,
                                maxClasses: 8,
                                hasPersonalTraining: false,
                                hasNutrition: false,
                                allowFreeze: true,
                                isActive: true,
                                features: ['M√©todo l√∫dico', 'Acompanhamento parental', 'Certificado de progresso']
                            },
                            {
                                id: 'plan-4',
                                name: 'Plano Feminino Especializado',
                                description: 'Turmas exclusivamente femininas com foco em defesa pessoal',
                                category: 'FEMALE',
                                price: '170.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 3,
                                maxClasses: 12,
                                hasPersonalTraining: false,
                                hasNutrition: false,
                                allowFreeze: true,
                                isActive: true,
                                features: ['Hor√°rios exclusivos', 'Instrutora especializada', 'Workshops de autodefesa']
                            },
                            {
                                id: 'plan-5',
                                name: 'Plano Senior Adaptado',
                                description: 'Treinamento adaptado para terceira idade com foco em mobilidade',
                                category: 'SENIOR',
                                price: '130.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 2,
                                maxClasses: 8,
                                hasPersonalTraining: false,
                                hasNutrition: true,
                                allowFreeze: true,
                                isActive: true,
                                features: ['Baixo impacto', 'Acompanhamento m√©dico', 'Exerc√≠cios adaptados']
                            },
                            {
                                id: 'plan-6',
                                name: 'Plano Anual Premium',
                                description: 'Desconto especial para pagamento anual - 12 meses de acesso completo',
                                category: 'ADULT',
                                price: '1800.00',
                                billingType: 'YEARLY',
                                classesPerWeek: 0,
                                maxClasses: null,
                                hasPersonalTraining: true,
                                hasNutrition: true,
                                allowFreeze: true,
                                isActive: true,
                                features: ['Desconto de 20%', 'Acesso ilimitado', 'Personal training', 'Consultoria completa']
                            },
                            {
                                id: 'plan-7',
                                name: 'Plano Trimestral Intensivo',
                                description: '3 meses de treinamento intensivo com resultados acelerados',
                                category: 'ADULT',
                                price: '450.00',
                                billingType: 'QUARTERLY',
                                classesPerWeek: 4,
                                maxClasses: 48,
                                hasPersonalTraining: false,
                                hasNutrition: true,
                                allowFreeze: false,
                                isActive: true,
                                features: ['4x por semana', 'Plano nutricional', 'Avalia√ß√£o mensal']
                            },
                            {
                                id: 'plan-8',
                                name: 'Plano Familiar',
                                description: 'Desconto especial para fam√≠lias - at√© 4 membros',
                                category: 'ADULT',
                                price: '400.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 3,
                                maxClasses: 48,
                                hasPersonalTraining: false,
                                hasNutrition: false,
                                allowFreeze: true,
                                isActive: true,
                                features: ['At√© 4 pessoas', 'Hor√°rios flex√≠veis', 'Desconto familiar']
                            },
                            {
                                id: 'plan-9',
                                name: 'Plano VIP Master',
                                description: 'Experi√™ncia completa com todos os benef√≠cios e exclusividades',
                                category: 'ADULT',
                                price: '500.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 0,
                                maxClasses: null,
                                hasPersonalTraining: true,
                                hasNutrition: true,
                                allowFreeze: true,
                                isActive: true,
                                features: ['Acesso VIP', 'Personal 2x/semana', 'Nutricionista', 'Prioridade m√°xima']
                            },
                            {
                                id: 'plan-10',
                                name: 'Plano Corporativo',
                                description: 'Para empresas - treinamento de equipes com desconto especial',
                                category: 'ADULT',
                                price: '800.00',
                                billingType: 'MONTHLY',
                                classesPerWeek: 5,
                                maxClasses: null,
                                hasPersonalTraining: false,
                                hasNutrition: false,
                                allowFreeze: true,
                                isActive: true,
                                features: ['At√© 10 pessoas', 'Hor√°rio corporativo', 'Relat√≥rios de progresso']
                            }
                        ];
                    }
                }
                
                // Try to load student subscription data (may not exist)
                let currentPlan = null;
                let hasActiveSubscription = false;
                let isSimulatedSubscription = false;
                
                try {
                    console.log('üîç Verificando assinatura do aluno...');
                    const subscriptionResponse = await fetch(`/api/students/${studentId}/subscription`);
                    
                    if (subscriptionResponse.ok) {
                        const subscriptionData = await subscriptionResponse.json();
                        if (subscriptionData.success && subscriptionData.data) {
                            currentPlan = subscriptionData.data.plan;
                            hasActiveSubscription = true;
                            console.log('‚úÖ Assinatura ativa encontrada:', currentPlan.name);
                        } else {
                            console.log('‚ÑπÔ∏è Aluno sem plano ativo (resposta vazia)');
                        }
                    } else if (subscriptionResponse.status === 404) {
                        console.log('‚ÑπÔ∏è Aluno sem plano ativo (404 - normal para novos alunos)');
                    } else {
                        console.log('‚ö†Ô∏è Erro ao buscar assinatura:', subscriptionResponse.status);
                    }
                } catch (subscriptionError) {
                    console.log('‚ÑπÔ∏è Nenhuma assinatura encontrada para o aluno (isso √© normal para novos alunos)');
                }
                
                // Check for simulated subscriptions if no real subscription found
                if (!hasActiveSubscription) {
                    const simulatedAssignments = JSON.parse(localStorage.getItem('simulatedPlanAssignments') || '[]');
                    const studentAssignment = simulatedAssignments.find(a => a.studentId === studentId && a.isActive);
                    
                    if (studentAssignment) {
                        // Find the plan details from available plans
                        const simulatedPlan = availablePlans.find(p => p.id === studentAssignment.planId);
                        if (simulatedPlan) {
                            currentPlan = {
                                ...simulatedPlan,
                                subscriptionId: studentAssignment.id,
                                createdAt: studentAssignment.createdAt,
                                isTemporary: studentAssignment.isTemporary || false,
                                syncAttempts: studentAssignment.syncAttempts || 0
                            };
                            hasActiveSubscription = true;
                            isSimulatedSubscription = true;
                            
                            if (studentAssignment.isTemporary) {
                                console.log('üìù Assinatura tempor√°ria encontrada (aguardando sincroniza√ß√£o):', currentPlan.name);
                            } else {
                                console.log('üìù Assinatura simulada encontrada:', currentPlan.name);
                            }
                        }
                    }
                }
                
                content.innerHTML = `
                    <div style="display: grid; gap: 2rem; max-width: 1000px; margin: 0 auto;">
                        
                        <!-- Header with Quick Actions -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="color: #F8FAFC; margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.5rem;">üìã</span>
                                Gest√£o de Planos
                                ${!plansData || !plansData.success ? 
                                    '<span style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">DEMO</span>' 
                                    : ''
                                }
                            </h3>
                            <div style="display: flex; gap: 0.75rem;">
                                ${!hasActiveSubscription ? `
                                    <button onclick="showQuickPlanSelector()" 
                                            style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                        üöÄ Assinar Plano Agora
                                    </button>
                                ` : `
                                    <button onclick="showPlanChangeOptions()" 
                                            style="background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                        üîÑ Trocar Plano
                                    </button>
                                    <button onclick="showPlanCancellation()" 
                                            style="background: rgba(239, 68, 68, 0.1); color: #EF4444; border: 1px solid #EF4444; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                        üõë Gerenciar Plano
                                    </button>
                                `}
                                <button onclick="showPlanManagementPolicies()" 
                                        style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; border: 1px solid #3B82F6; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                    üìã Pol√≠ticas
                                </button>
                            </div>
                        </div>

                        <!-- Current Plan Status -->
                        <div style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.8)); border-radius: 16px; padding: 2rem; border: 1px solid ${hasActiveSubscription ? '#10B981' : '#EF4444'}; position: relative; overflow: hidden;">
                            ${hasActiveSubscription ? `
                                <!-- Active Plan Display -->
                                <div style="position: absolute; top: 1rem; right: 1rem;">
                                    <span style="background: linear-gradient(135deg, ${currentPlan?.isTemporary ? '#F59E0B, #D97706' : '#10B981, #059669'}); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600; box-shadow: 0 2px 8px rgba(${currentPlan?.isTemporary ? '245, 158, 11' : '16, 185, 129'}, 0.3);">
                                        ${currentPlan?.isTemporary ? '‚è≥ SINCRONIZANDO' : (isSimulatedSubscription ? 'üìù DEMO' : '‚úÖ ATIVO')}
                                    </span>
                                </div>
                                ${currentPlan?.isTemporary ? `
                                    <div style="position: absolute; top: 4rem; right: 1rem;">
                                        <span style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(245, 158, 11, 0.3);">
                                            Tentativa ${currentPlan?.syncAttempts || 0}/288
                                        </span>
                                    </div>
                                ` : ''}
                                <div style="margin-bottom: 1.5rem;">
                                    <h4 style="color: #10B981; margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700;">
                                        ${currentPlan?.name || 'Plano sem nome'}
                                    </h4>
                                    <p style="color: #94A3B8; margin: 0; font-size: 1rem;">
                                        ${currentPlan?.description || 'Sem descri√ß√£o dispon√≠vel'}
                                        ${currentPlan?.isTemporary ? ' <strong style="color: #F59E0B;">(Aguardando sincroniza√ß√£o com servidor)</strong>' : ''}
                                    </p>
                                    </p>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: center;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 12px; padding: 1rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                                            <div style="color: #10B981; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">üí≥ VALOR MENSAL</div>
                                            <div style="color: #F8FAFC; font-size: 1.5rem; font-weight: bold;">R$ ${(parseFloat(currentPlan?.price) || 0).toFixed(2)}</div>
                                        </div>
                                        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 12px; padding: 1rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                            <div style="color: #3B82F6; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">üéØ CATEGORIA</div>
                                            <div style="color: #F8FAFC; font-size: 1.125rem; font-weight: 600;">${currentPlan?.category || currentPlan?.targetCategory || 'N/A'}</div>
                                        </div>
                                        <div style="background: rgba(245, 158, 11, 0.1); border-radius: 12px; padding: 1rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                                            <div style="color: #F59E0B; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">üìÖ AULAS/SEMANA</div>
                                            <div style="color: #F8FAFC; font-size: 1.125rem; font-weight: 600;">${currentPlan?.classesPerWeek || 'Ilimitado'}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="text-align: center;">
                                        <button onclick="showPlanDetails('${currentPlan?.id}')" 
                                                style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; margin-bottom: 0.5rem; width: 100%;">
                                            üìÑ Ver Detalhes
                                        </button>
                                        <br>
                                        <button onclick="showPlanChangeOptions()" 
                                                style="background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; width: 100%;">
                                            üîÑ Trocar Plano
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <!-- No Plan State -->
                                <div style="text-align: center; padding: 2rem;">
                                    <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                                    <h4 style="color: #EF4444; margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 700;">
                                        Nenhum Plano Ativo
                                    </h4>
                                    <p style="color: #94A3B8; margin: 0 0 1rem 0; font-size: 1.125rem;">
                                        Este aluno n√£o possui um plano de pagamento ativo.
                                    </p>
                                    <p style="color: #F59E0B; margin: 0 0 2rem 0; font-size: 1rem; font-weight: 600;">
                                        ‚ö° Para liberar o acesso √†s aulas, √© necess√°rio assinar um plano.
                                    </p>
                                    <div style="display: flex; gap: 1rem; justify-content: center; align-items: center;">
                                        <button onclick="showQuickPlanSelector()" 
                                                style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.125rem; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);">
                                            üöÄ Assinar Plano Agora
                                        </button>
                                        <div style="color: #64748B; font-size: 0.875rem; text-align: left;">
                                            <div>‚úÖ ${availablePlans.length} planos ativos dispon√≠veis</div>
                                            <div>üí∞ A partir de R$ ${Math.min(...availablePlans.map(p => parseFloat(p.price)))}</div>
                                        </div>
                                    </div>
                                </div>
                            `}
                        </div>

                        <!-- Complete Plans Showcase (visible when no plan) -->
                        ${!hasActiveSubscription ? `
                            <div id="quickPlanSelector" style="background: rgba(15, 23, 42, 0.5); border-radius: 16px; padding: 2rem; border: 1px solid #334155;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">                            <h4 style="color: #F8FAFC; margin: 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                                ‚ö° Escolha seu Plano Ideal
                                <span style="background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">‚úÖ APENAS ATIVOS</span>
                                <span style="background: #EF4444; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">URGENTE</span>
                            </h4>
                                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                                        <span style="color: #94A3B8; font-size: 0.875rem;">${availablePlans.length} planos dispon√≠veis</span>
                                        <select id="planTypeFilter" onchange="filterPlansByType()" style="background: #1E293B; border: 1px solid #475569; color: #F8FAFC; padding: 0.5rem; border-radius: 6px; font-size: 0.875rem;">
                                            <option value="">Todos os tipos</option>
                                            <option value="MONTHLY">Mensais</option>
                                            <option value="QUARTERLY">Trimestrais</option>
                                            <option value="YEARLY">Anuais</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Plans organized by category -->
                                <div style="display: grid; gap: 2rem;">
                                    
                                    <!-- Popular Plans Section -->
                                    <div>
                                        <h5 style="color: #10B981; margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                            üî• Mais Populares
                                        </h5>
                                        <div class="plans-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">
                                            ${availablePlans.filter(plan => ['plan-2', 'plan-1', 'plan-9'].includes(plan.id)).map(plan => `
                                                <div class="plan-card-enhanced" data-category="${plan.category}" data-billing="${plan.billingType}" 
                                                     style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9)); 
                                                            border: 2px solid #10B981; border-radius: 16px; padding: 1.5rem; cursor: pointer; 
                                                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden;" 
                                                     onclick="selectPlanQuickly('${plan.id}')" 
                                                     onmouseover="this.style.borderColor='#059669'; this.style.transform='translateY(-6px)'; this.style.boxShadow='0 20px 40px rgba(16, 185, 129, 0.3)'" 
                                                     onmouseout="this.style.borderColor='#10B981'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            
                                                    <!-- Popular badge -->
                                                    <div style="position: absolute; top: -1px; right: -1px; background: linear-gradient(135deg, #F59E0B, #D97706); 
                                                                color: white; padding: 0.5rem 1rem; border-radius: 0 16px 0 16px; font-size: 0.75rem; font-weight: 600;">
                                                        ${plan.id === 'plan-2' ? 'üëë PREMIUM' : plan.id === 'plan-9' ? 'üíé VIP' : 'üî• POPULAR'}
                                                    </div>
                                                    
                                                    <div style="margin-bottom: 1.5rem;">
                                                        <h5 style="color: #F8FAFC; margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 700;">
                                                            ${plan.name}
                                                        </h5>
                                                        <p style="color: #94A3B8; margin: 0 0 1rem 0; font-size: 0.875rem; line-height: 1.4;">
                                                            ${plan.description}
                                                        </p>
                                                    </div>
                                                    
                                                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 1.5rem; align-items: center; margin-bottom: 1.5rem;">
                                                        <div style="display: grid; gap: 0.75rem;">
                                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                                <span style="color: #94A3B8; font-size: 0.875rem;">üìä Categoria:</span>
                                                                <span style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                                                    ${plan.category}
                                                                </span>
                                                            </div>
                                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                                <span style="color: #94A3B8; font-size: 0.875rem;">üìÖ Aulas/semana:</span>
                                                                <span style="color: #F8FAFC; font-weight: 600; font-size: 0.875rem;">
                                                                    ${plan.classesPerWeek === 0 ? 'Ilimitado' : plan.classesPerWeek + 'x'}
                                                                </span>
                                                            </div>
                                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                                <span style="color: #94A3B8; font-size: 0.875rem;">üí≥ Cobran√ßa:</span>
                                                                <span style="color: #F8FAFC; font-weight: 600; font-size: 0.875rem;">
                                                                    ${plan.billingType === 'MONTHLY' ? 'Mensal' : 
                                                                      plan.billingType === 'QUARTERLY' ? 'Trimestral' : 
                                                                      plan.billingType === 'YEARLY' ? 'Anual' : plan.billingType}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div style="text-align: center;">
                                                            <div style="color: #10B981; font-size: 2rem; font-weight: bold; margin-bottom: 0.25rem;">
                                                                R$ ${(parseFloat(plan.price)).toFixed(0)}
                                                            </div>
                                                            <div style="color: #94A3B8; font-size: 0.75rem;">
                                                                /${plan.billingType === 'MONTHLY' ? 'm√™s' : 
                                                                  plan.billingType === 'QUARTERLY' ? 'trim' : 
                                                                  plan.billingType === 'YEARLY' ? 'ano' : 'per√≠odo'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Features -->
                                                    ${plan.features && plan.features.length > 0 ? `
                                                        <div style="margin-bottom: 1.5rem;">
                                                            <div style="color: #F8FAFC; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">‚ú® Incluso:</div>
                                                            <div style="display: grid; gap: 0.5rem;">
                                                                ${plan.features.slice(0, 3).map(feature => `
                                                                    <div style="color: #94A3B8; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                                                                        <span style="color: #10B981;">‚úì</span> ${feature}
                                                                    </div>
                                                                `).join('')}
                                                                ${plan.features.length > 3 ? `
                                                                    <div style="color: #3B82F6; font-size: 0.875rem; font-weight: 600;">
                                                                        +${plan.features.length - 3} benef√≠cios adicionais
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    <!-- Special badges -->
                                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                                                        ${plan.hasPersonalTraining ? '<span style="background: rgba(16, 185, 129, 0.2); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">üèÉ‚Äç‚ôÇÔ∏è Personal</span>' : ''}
                                                        ${plan.hasNutrition ? '<span style="background: rgba(245, 158, 11, 0.2); color: #F59E0B; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">ü•ó Nutri√ß√£o</span>' : ''}
                                                        ${plan.allowFreeze ? '<span style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">‚ùÑÔ∏è Congelamento</span>' : ''}
                                                    </div>
                                                    
                                                    <button style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; 
                                                                   padding: 1rem; border-radius: 12px; width: 100%; font-weight: 700; font-size: 1rem;
                                                                   cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);"
                                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.4)'"
                                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                                                        üöÄ Assinar Agora
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <!-- All Other Plans Section -->
                                    <div>
                                        <h5 style="color: #3B82F6; margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                            üìã Todos os Planos (${availablePlans.length})
                                        </h5>
                                        <div class="all-plans-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                                            ${availablePlans.map(plan => `
                                                <div class="plan-card-compact" data-category="${plan.category}" data-billing="${plan.billingType}" 
                                                     style="background: rgba(30, 41, 59, 0.6); border: 1px solid #475569; border-radius: 12px; 
                                                            padding: 1.25rem; cursor: pointer; transition: all 0.3s;" 
                                                     onclick="selectPlanQuickly('${plan.id}')" 
                                                     onmouseover="this.style.borderColor='#3B82F6'; this.style.transform='translateY(-2px)'" 
                                                     onmouseout="this.style.borderColor='#475569'; this.style.transform='translateY(0)'">
                                                    
                                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                                        <div style="flex: 1;">
                                                            <h6 style="color: #F8FAFC; margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 600;">
                                                                ${plan.name}
                                                            </h6>
                                                            <div style="color: #94A3B8; font-size: 0.875rem; line-height: 1.3; margin-bottom: 0.75rem;">
                                                                ${plan.description.substring(0, 80)}${plan.description.length > 80 ? '...' : ''}
                                                            </div>
                                                        </div>
                                                        <div style="text-align: right; margin-left: 1rem;">
                                                            <div style="color: #10B981; font-size: 1.25rem; font-weight: bold;">
                                                                R$ ${(parseFloat(plan.price)).toFixed(0)}
                                                            </div>
                                                            <div style="color: #94A3B8; font-size: 0.75rem;">
                                                                /${plan.billingType === 'MONTHLY' ? 'm√™s' : 
                                                                  plan.billingType === 'QUARTERLY' ? 'trim' : 
                                                                  plan.billingType === 'YEARLY' ? 'ano' : 'per√≠odo'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem; font-size: 0.875rem;">
                                                        <div style="display: flex; justify-content: space-between;">
                                                            <span style="color: #94A3B8;">Categoria:</span>
                                                            <span style="color: #F8FAFC; font-weight: 600;">${plan.category}</span>
                                                        </div>
                                                        <div style="display: flex; justify-content: space-between;">
                                                            <span style="color: #94A3B8;">Aulas:</span>
                                                            <span style="color: #F8FAFC; font-weight: 600;">
                                                                ${plan.classesPerWeek === 0 ? 'Ilimitado' : plan.classesPerWeek + 'x/sem'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Compact badges -->
                                                    <div style="display: flex; gap: 0.25rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                                        ${plan.hasPersonalTraining ? '<span style="background: rgba(16, 185, 129, 0.2); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem;">Personal</span>' : ''}
                                                        ${plan.hasNutrition ? '<span style="background: rgba(245, 158, 11, 0.2); color: #F59E0B; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem;">Nutri√ß√£o</span>' : ''}
                                                        ${plan.allowFreeze ? '<span style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem;">Congelamento</span>' : ''}
                                                    </div>
                                                    
                                                    <button style="background: #3B82F6; color: white; border: none; padding: 0.75rem; 
                                                                   border-radius: 8px; width: 100%; font-weight: 600; font-size: 0.875rem;
                                                                   cursor: pointer; transition: all 0.2s;" 
                                                            onmouseover="this.style.background='#2563EB'"
                                                            onmouseout="this.style.background='#3B82F6'">
                                                        Selecionar Plano
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- All Plans Section (collapsible) -->
                        <div id="allPlansSection" style="background: rgba(15, 23, 42, 0.5); border-radius: 16px; padding: 2rem; border: 1px solid #334155; ${!hasActiveSubscription ? 'display: none;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">                            <h4 style="color: #F8FAFC; margin: 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                                üìã Todos os Planos Dispon√≠veis
                                <span style="background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">‚úÖ APENAS ATIVOS</span>
                            </h4>
                                <div style="display: flex; gap: 0.75rem;">
                                    <select id="planCategoryFilter" onchange="filterPlansByCategory()" style="background: #1E293B; border: 1px solid #475569; color: #F8FAFC; padding: 0.5rem; border-radius: 6px;">
                                        <option value="">Todas as categorias</option>
                                        <option value="ADULT">Adulto</option>
                                        <option value="CHILD">Infantil</option>
                                        <option value="SENIOR">Senior</option>
                                        <option value="FEMALE">Feminino</option>
                                    </select>
                                    <select id="planBillingTypeFilter" onchange="filterPlansByType()" style="background: #1E293B; border: 1px solid #475569; color: #F8FAFC; padding: 0.5rem; border-radius: 6px;">
                                        <option value="">Todos os tipos</option>
                                        <option value="MONTHLY">Mensal</option>
                                        <option value="QUARTERLY">Trimestral</option>
                                        <option value="YEARLY">Anual</option>
                                        <option value="CREDIT_CARD_INSTALLMENT">Parcelado</option>
                                        <option value="RECURRING">Recorrente</option>
                                    </select>
                                    <button onclick="toggleAllPlansView()" 
                                            style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                                        ${hasActiveSubscription ? 'üìä Expandir' : 'üìÅ Recolher'}
                                    </button>
                                </div>
                            </div>
                            
                            <div id="plansGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">
                                ${availablePlans.map(plan => `
                                    <div class="plan-card" data-category="${plan.category || ''}" data-billing="${plan.billingType || plan.billingCycle || ''}"
                                         style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.8)); 
                                                border: 2px solid ${currentPlan && currentPlan.id === plan.id ? '#10B981' : '#475569'}; 
                                                border-radius: 12px; padding: 1.5rem; transition: all 0.3s; position: relative;">
                                        
                                        ${currentPlan && currentPlan.id === plan.id ? `
                                            <div style="position: absolute; top: -1px; right: -1px; background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 0.5rem 1rem; border-radius: 0 12px 0 12px; font-size: 0.75rem; font-weight: 600;">
                                                ‚úÖ PLANO ATUAL
                                            </div>
                                        ` : ''}
                                        
                                        <div style="margin-bottom: 1.5rem;">
                                            <h5 style="color: #F8FAFC; margin: 0 0 0.5rem 0; font-size: 1.125rem; font-weight: 600;">
                                                ${plan.name || 'Plano sem nome'}
                                            </h5>
                                            <p style="color: #94A3B8; margin: 0; font-size: 0.875rem; line-height: 1.4;">
                                                ${plan.description || 'Sem descri√ß√£o dispon√≠vel'}
                                            </p>
                                        </div>
                                        
                                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center; margin-bottom: 1.5rem;">
                                            <div style="display: grid; gap: 0.75rem;">
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #94A3B8; font-size: 0.875rem;">Categoria:</span>
                                                    <span style="color: #F8FAFC; font-weight: 600; font-size: 0.875rem;">${plan.category || 'N/A'}</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #94A3B8; font-size: 0.875rem;">Aulas/semana:</span>
                                                    <span style="color: #F8FAFC; font-weight: 600; font-size: 0.875rem;">${plan.classesPerWeek || 'Ilimitado'}</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #94A3B8; font-size: 0.875rem;">Dura√ß√£o:</span>
                                                    <span style="color: #F8FAFC; font-weight: 600; font-size: 0.875rem;">${
                                                        (plan.billingType || plan.billingCycle) === 'MONTHLY' ? 'Mensal' : 
                                                        (plan.billingType || plan.billingCycle) === 'QUARTERLY' ? 'Trimestral' : 
                                                        (plan.billingType || plan.billingCycle) === 'YEARLY' ? 'Anual' : 
                                                        (plan.billingType || plan.billingCycle) === 'CREDIT_CARD_INSTALLMENT' ? 'Parcelado' :
                                                        (plan.billingType || plan.billingCycle) === 'RECURRING' ? 'Recorrente' : 'N/A'
                                                    }</span>
                                                </div>
                                            </div>
                                            
                                            <div style="text-align: right;">
                                                <div style="color: #10B981; font-size: 1.5rem; font-weight: bold; margin-bottom: 0.25rem;">
                                                    R$ ${(parseFloat(plan.price) || 0).toFixed(2)}
                                                </div>
                                                <div style="color: #94A3B8; font-size: 0.75rem;">por m√™s</div>
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 0.75rem;">
                                            ${!(currentPlan && currentPlan.id === plan.id) ? `
                                                <button onclick="switchToPlan('${plan.id}')" 
                                                        style="background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; border: none; padding: 0.75rem; border-radius: 8px; flex: 1; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                                    ${hasActiveSubscription ? 'üîÑ Trocar para Este' : 'üöÄ Assinar Plano'}
                                                </button>
                                            ` : `
                                                <button style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10B981; color: #10B981; padding: 0.75rem; border-radius: 8px; flex: 1; font-weight: 600; cursor: not-allowed;">
                                                    ‚úÖ Plano Ativo
                                                </button>
                                            `}
                                            <button onclick="showPlanDetails('${plan.id}')" 
                                                    style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 0.75rem; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                                üìÑ
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${availablePlans.length === 0 ? `
                                <div style="text-align: center; padding: 3rem; color: #94A3B8;">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                                    <div style="font-size: 1.125rem; font-weight: 600;">Nenhum plano dispon√≠vel</div>
                                    <div style="font-size: 0.875rem; margin-top: 0.5rem;">Entre em contato com a administra√ß√£o para mais informa√ß√µes</div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Payment History Section -->
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 16px; padding: 2rem; border: 1px solid #334155;">
                            <h4 style="color: #F8FAFC; margin: 0 0 1.5rem 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                                üí∞ Hist√≥rico de Pagamentos
                                <span style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">EM BREVE</span>
                            </h4>
                            <div style="background: rgba(30, 41, 59, 0.5); border-radius: 12px; padding: 2rem; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üìä</div>
                                <div style="color: #94A3B8; font-size: 1rem;">
                                    Hist√≥rico de pagamentos em desenvolvimento
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Erro ao carregar dados dos planos:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #EF4444;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                        <div style="font-weight: 600;">Erro ao carregar dados dos planos</div>
                        <div style="font-size: 0.875rem; margin-top: 0.5rem; color: #94A3B8;">${error.message}</div>
                        <button onclick="loadPlansTabContent()" style="background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1rem; cursor: pointer;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // Edit Responsible function
        async function editResponsible() {
            const form = document.getElementById('editResponsibleForm');
            const formData = new FormData(form);
            
            const responsibleId = document.getElementById('editResponsibleId').value;
            const responsibleData = {
                name: document.getElementById('editResponsibleName').value.trim(),
                email: document.getElementById('editResponsibleEmail').value.trim(),
                phone: document.getElementById('editResponsiblePhone').value.trim(),
                birthDate: document.getElementById('editResponsibleBirthDate').value || null,
                relationshipType: document.getElementById('editResponsibleRelationType').value || null
            };

            // Validation
            if (!responsibleData.name || !responsibleData.email) {
                showToast('Por favor, preencha todos os campos obrigat√≥rios', 'error');
                return;
            }

            try {
                showToast('‚è≥ Atualizando respons√°vel...', 'info');
                
                const response = await fetch(`/api/financial-responsibles/${responsibleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(responsibleData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('‚úÖ Respons√°vel atualizado com sucesso!', 'success');
                    closeModal('editResponsibleModal');
                    loadFinancialResponsiblesList(); // Refresh the list
                } else {
                    throw new Error(data.message || data.error || 'Erro ao atualizar respons√°vel');
                }
            } catch (error) {
                console.error('Erro ao editar respons√°vel:', error);
                showToast(`Erro ao atualizar respons√°vel: ${error.message}`, 'error');
            }
        }

        // Add form submission handler for edit responsible form
        document.addEventListener('DOMContentLoaded', function() {
            const editResponsibleForm = document.getElementById('editResponsibleForm');
            if (editResponsibleForm) {
                editResponsibleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    editResponsible();
                });
            }
        });

        
        // ==========================================
        // UX FUNCTIONS FOR ENHANCED PLAN MANAGEMENT
        // ==========================================
        
        // Quick plan selector for users without plans
        function showQuickPlanSelector() {
            const selector = document.getElementById('quickPlanSelector');
            if (selector) {
                selector.scrollIntoView({ behavior: 'smooth', block: 'center' });
                selector.style.animation = 'pulse 1s ease-in-out';
            }
        }
        
        // Select plan quickly (one-click subscription)
        async function selectPlanQuickly(planId) {
            if (!currentEditingStudentId) {
                showToast('Erro: ID do aluno n√£o encontrado', 'error');
                return;
            }
            
            try {
                const confirmation = confirm('üöÄ Deseja atribuir este plano ao aluno?');
                if (!confirmation) return;
                
                // Use the improved assignment function
                await assignPlanToStudent(planId);
                
            } catch (error) {
                console.error('Erro ao atribuir plano rapidamente:', error);
                showToast('‚ùå Erro ao atribuir plano: ' + error.message, 'error');
            }
        }
        
        // Show plan change options for users with active plans
        function showPlanChangeOptions() {
            const allPlansSection = document.getElementById('allPlansSection');
            if (allPlansSection) {
                allPlansSection.style.display = 'block';
                allPlansSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Highlight available plans
                const planCards = allPlansSection.querySelectorAll('.plan-card');
                planCards.forEach(card => {
                    if (!card.querySelector('[style*="PLANO ATUAL"]')) {
                        card.style.animation = 'glow 2s ease-in-out';
                        setTimeout(() => {
                            card.style.animation = '';
                        }, 2000);
                    }
                });
            }
            
            showToast('üí° Selecione um novo plano abaixo para trocar', 'info');
        }
        
        // Show plan management options (deactivate vs delete)
        async function showPlanCancellation() {
            const studentId = window.getCurrentEditingStudentId ? window.getCurrentEditingStudentId() : currentEditingStudentId;
            if (!studentId) {
                showToast('Erro: ID do aluno n√£o encontrado', 'error');
                return;
            }

            try {
                // Verificar se o plano j√° foi usado (tem hist√≥rico de pagamentos ou aulas)
                const hasUsageHistory = await checkPlanUsageHistory(studentId);
                
                if (hasUsageHistory) {
                    // Plano foi usado - s√≥ pode ser desativado
                    const confirmation = confirm(`‚ö†Ô∏è DESATIVAR PLANO

Este plano possui hist√≥rico de uso (pagamentos ou aulas registradas).
Por pol√≠ticas de auditoria, ele n√£o pode ser exclu√≠do, apenas desativado.

‚ö†Ô∏è ATEN√á√ÉO:
‚Ä¢ O aluno perder√° acesso √†s aulas futuras
‚Ä¢ O hist√≥rico ser√° mantido para auditoria
‚Ä¢ A assinatura ser√° desativada (n√£o cancelada)
‚Ä¢ √â poss√≠vel reativar posteriormente se necess√°rio

Confirma a DESATIVA√á√ÉO do plano?`);
                    
                    if (confirmation) {
                        await deactivateStudentPlan();
                    }
                } else {
                    // Plano nunca foi usado - pode ser exclu√≠do ou desativado
                    const action = confirm(`üóëÔ∏è GERENCIAR PLANO

Este plano nunca foi utilizado (sem pagamentos ou aulas registradas).

Escolha uma a√ß√£o:
‚Ä¢ OK = EXCLUIR PERMANENTEMENTE (remove todos os dados)
‚Ä¢ Cancelar = DESATIVAR APENAS (mant√©m dados para auditoria)

‚ö†Ô∏è EXCLUS√ÉO √© irrevers√≠vel!
Deseja EXCLUIR permanentemente?`);
                    
                    if (action) {
                        await deleteStudentPlan();
                    } else {
                        const deactivateConfirm = confirm(`üìù DESATIVAR PLANO

O plano ser√° desativado mas mantido no sistema.

Confirma a DESATIVA√á√ÉO?`);
                        
                        if (deactivateConfirm) {
                            await deactivateStudentPlan();
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar hist√≥rico do plano:', error);
                showToast('‚ùå Erro ao verificar hist√≥rico do plano: ' + error.message, 'error');
            }
        }

        // Check if plan has usage history
        async function checkPlanUsageHistory(studentId) {
            try {
                // Verificar pagamentos
                const paymentsResponse = await fetch(`/api/students/${studentId}/payments`);
                const paymentsData = paymentsResponse.ok ? await paymentsResponse.json() : { data: [] };
                const hasPayments = paymentsData.data && paymentsData.data.length > 0;

                // Verificar aulas/presen√ßas
                const attendanceResponse = await fetch(`/api/students/${studentId}/attendance`);
                const attendanceData = attendanceResponse.ok ? await attendanceResponse.json() : { data: [] };
                const hasAttendance = attendanceData.data && attendanceData.data.length > 0;

                // Verificar se tem assinatura ativa h√° mais de 7 dias
                const subscriptionResponse = await fetch(`/api/students/${studentId}/subscription`);
                const subscriptionData = subscriptionResponse.ok ? await subscriptionResponse.json() : null;
                let hasActiveSubscription = false;
                
                if (subscriptionData && subscriptionData.data) {
                    const createdDate = new Date(subscriptionData.data.createdAt);
                    const now = new Date();
                    const daysSinceCreation = (now - createdDate) / (1000 * 60 * 60 * 24);
                    hasActiveSubscription = daysSinceCreation > 7; // Plano ativo h√° mais de 7 dias
                }

                console.log('üîç Hist√≥rico de uso do plano:', {
                    hasPayments,
                    hasAttendance,
                    hasActiveSubscription,
                    totalUsage: hasPayments || hasAttendance || hasActiveSubscription
                });

                return hasPayments || hasAttendance || hasActiveSubscription;
            } catch (error) {
                console.error('Erro ao verificar hist√≥rico:', error);
                // Em caso de erro, assumir que tem hist√≥rico (mais seguro)
                return true;
            }
        }

        // Deactivate student plan (soft delete)
        async function deactivateStudentPlan() {
            const studentId = window.getCurrentEditingStudentId ? window.getCurrentEditingStudentId() : currentEditingStudentId;
            try {
                showToast('‚è≥ Desativando plano...', 'info');
                
                // Log da a√ß√£o para auditoria
                console.log('üîí AUDITORIA: Iniciando desativa√ß√£o de plano', {
                    studentId: studentId,
                    timestamp: new Date().toISOString(),
                    action: 'DEACTIVATE_PLAN',
                    reason: 'Plano com hist√≥rico - preservando dados'
                });
                
                const response = await fetch(`/api/students/${studentId}/subscription/deactivate`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: 'Desativado pelo administrador',
                        deactivatedAt: new Date().toISOString(),
                        keepHistory: true,
                        auditLog: {
                            action: 'DEACTIVATE_PLAN',
                            performedBy: 'admin', // TODO: pegar user logado
                            timestamp: new Date().toISOString(),
                            preserveData: true
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ AUDITORIA: Plano desativado com sucesso', { 
                        studentId: studentId,
                        preservedData: true 
                    });
                    showToast('‚úÖ Plano desativado com sucesso! Dados preservados para auditoria.', 'success');
                    
                    // Reload the plans tab to reflect changes
                    setTimeout(() => {
                        loadPlansTabContent();
                    }, 1000);
                } else {
                    throw new Error(data.message || 'Erro ao desativar plano');
                }
            } catch (error) {
                console.error('‚ùå AUDITORIA: Erro ao desativar plano', {
                    studentId: currentEditingStudentId,
                    error: error.message
                });
                showToast('‚ùå Erro ao desativar plano: ' + error.message, 'error');
            }
        }

        // Delete student plan permanently (hard delete)
        async function deleteStudentPlan() {
            try {
                showToast('‚è≥ Excluindo plano permanentemente...', 'info');
                
                // Log da a√ß√£o para auditoria
                console.log('üóëÔ∏è AUDITORIA: Iniciando exclus√£o permanente de plano', {
                    studentId: currentEditingStudentId,
                    timestamp: new Date().toISOString(),
                    action: 'DELETE_PLAN',
                    reason: 'Plano sem hist√≥rico de uso'
                });
                
                const response = await fetch(`/api/students/${currentEditingStudentId}/subscription`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: 'Exclus√£o permanente - plano n√£o utilizado',
                        confirmedDeletion: true,
                        auditLog: {
                            action: 'DELETE_PLAN',
                            performedBy: 'admin', // TODO: pegar user logado
                            timestamp: new Date().toISOString(),
                            permanent: true,
                            dataRemoved: true
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('üóëÔ∏è AUDITORIA: Plano exclu√≠do permanentemente', { 
                        studentId: currentEditingStudentId,
                        dataRemoved: true 
                    });
                    showToast('‚úÖ Plano exclu√≠do permanentemente! Dados removidos do sistema.', 'success');
                    
                    // Reload the plans tab to reflect changes
                    setTimeout(() => {
                        loadPlansTabContent();
                    }, 1000);
                } else {
                    throw new Error(data.message || 'Erro ao excluir plano');
                }
            } catch (error) {
                console.error('‚ùå AUDITORIA: Erro ao excluir plano', {
                    studentId: currentEditingStudentId,
                    error: error.message
                });
                showToast('‚ùå Erro ao excluir plano: ' + error.message, 'error');
            }
        }
        
        // Show all plans (expand the collapsed section)
        function showAllPlans() {
            const allPlansSection = document.getElementById('allPlansSection');
            if (allPlansSection) {
                allPlansSection.style.display = 'block';
                allPlansSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Toggle all plans view
        function toggleAllPlansView() {
            const allPlansSection = document.getElementById('allPlansSection');
            const button = event.target;
            
            if (allPlansSection.style.display === 'none') {
                allPlansSection.style.display = 'block';
                button.textContent = 'üìÅ Recolher';
                allPlansSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                allPlansSection.style.display = 'none';
                button.textContent = 'üìä Expandir';
            }
        }
        
        // Filter plans by category
        function filterPlansByCategory() {
            const filter = document.getElementById('planCategoryFilter').value;
            const planCards = document.querySelectorAll('.plan-card');
            
            planCards.forEach(card => {
                const category = card.getAttribute('data-category');
                if (!filter || category === filter) {
                    card.style.display = 'block';
                    card.style.animation = 'fadeIn 0.3s ease-in-out';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show message if no plans match filter
            const visibleCards = Array.from(planCards).filter(card => card.style.display !== 'none');
            const plansGrid = document.getElementById('plansGrid');
            
            if (visibleCards.length === 0) {
                if (!document.getElementById('noPlansMessage')) {
                    const message = document.createElement('div');
                    message.id = 'noPlansMessage';
                    message.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 2rem; color: #94A3B8;';
                    message.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üîç</div>
                        <div>Nenhum plano encontrado para a categoria selecionada</div>
                    `;
                    plansGrid.appendChild(message);
                }
            } else {
                const existingMessage = document.getElementById('noPlansMessage');
                if (existingMessage) {
                    existingMessage.remove();
                }
            }
        }
        
        // Filter plans by billing type (added for comprehensive filtering)
        function filterPlansByType() {
            const filter = document.getElementById('planBillingTypeFilter')?.value;
            if (!filter) return;
            
            const planCards = document.querySelectorAll('.plan-card, .plan-card-compact');
            
            planCards.forEach(card => {
                const billingType = card.getAttribute('data-billing');
                if (!filter || billingType === filter || filter === 'ALL') {
                    card.style.display = 'block';
                    card.style.animation = 'fadeIn 0.3s ease-in-out';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Update count of visible plans
            const visibleCards = Array.from(planCards).filter(card => card.style.display !== 'none');
            console.log(`Filtered plans by type ${filter}: ${visibleCards.length} visible`);
            
            // Show message if no plans match filter
            const plansGrid = document.getElementById('plansGrid');
            if (plansGrid) {
                if (visibleCards.length === 0) {
                    if (!document.getElementById('noPlansMessage')) {
                        const message = document.createElement('div');
                        message.id = 'noPlansMessage';
                        message.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 2rem; color: #94A3B8;';
                        message.innerHTML = `
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üí≥</div>
                            <div>Nenhum plano encontrado para o tipo de cobran√ßa selecionado</div>
                        `;
                        plansGrid.appendChild(message);
                    }
                } else {
                    const existingMessage = document.getElementById('noPlansMessage');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                }
            }
            
            showToast(`üí° Filtro aplicado: ${visibleCards.length} planos encontrados`, 'info');
        }
        
        // Show plan details (modal or expanded view)
        function showPlanDetails(planId) {
            // For now, show a detailed alert - can be enhanced to a modal later
            showToast('üí° Funcionalidade de detalhes do plano em desenvolvimento', 'info');
            console.log('Showing details for plan:', planId);
        }

        // Show plan management policies
        function showPlanManagementPolicies() {
            const modal = document.createElement('div');
            modal.id = 'planPoliciesModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1E293B, #0F172A); border-radius: 16px; 
                            padding: 2rem; max-width: 600px; width: 100%; border: 1px solid #334155; 
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h3 style="color: #F8FAFC; margin: 0; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
                            üìã Pol√≠ticas de Gest√£o de Planos
                        </h3>
                        <button onclick="closePlanPoliciesModal()" 
                                style="background: transparent; border: none; color: #94A3B8; cursor: pointer; font-size: 1.5rem; padding: 0.5rem;">
                            ‚úï
                        </button>
                    </div>
                    
                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Planos Ativos -->
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <h4 style="color: #10B981; margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                ‚úÖ Exibi√ß√£o de Planos
                            </h4>
                            <ul style="color: #F8FAFC; margin: 0; padding-left: 1.5rem; line-height: 1.6;">
                                <li>Apenas planos <strong>ATIVOS</strong> s√£o exibidos no cadastro</li>
                                <li>Planos inativos ficam ocultos mas mantidos no sistema</li>
                                <li>Administradores podem reativar planos se necess√°rio</li>
                            </ul>
                        </div>
                        
                        <!-- Exclus√£o vs Desativa√ß√£o -->
                        <div style="background: rgba(239, 68, 68, 0.1); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(239, 68, 68, 0.2);">
                            <h4 style="color: #EF4444; margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                üóëÔ∏è Remo√ß√£o de Planos
                            </h4>
                            <div style="display: grid; gap: 1rem;">
                                <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem;">
                                    <h5 style="color: #10B981; margin: 0 0 0.5rem 0; font-weight: 600;">‚úÖ EXCLUS√ÉO PERMANENTE</h5>
                                    <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">
                                        Permitida apenas para planos <strong>nunca utilizados</strong>:<br>
                                        ‚Ä¢ Sem pagamentos registrados<br>
                                        ‚Ä¢ Sem aulas frequentadas<br>
                                        ‚Ä¢ Assinatura ativa h√° menos de 7 dias
                                    </p>
                                </div>
                                <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem;">
                                    <h5 style="color: #F59E0B; margin: 0 0 0.5rem 0; font-weight: 600;">üìù DESATIVA√á√ÉO APENAS</h5>
                                    <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">
                                        Obrigat√≥ria para planos <strong>com hist√≥rico</strong>:<br>
                                        ‚Ä¢ Preserva dados para auditoria<br>
                                        ‚Ä¢ Mant√©m hist√≥rico de pagamentos<br>
                                        ‚Ä¢ Permite reativa√ß√£o futura
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Auditoria -->
                        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <h4 style="color: #3B82F6; margin: 0 0 1rem 0; font-size: 1.125rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                üîç Conformidade e Auditoria
                            </h4>
                            <ul style="color: #F8FAFC; margin: 0; padding-left: 1.5rem; line-height: 1.6;">
                                <li>Hist√≥rico de uso determina tipo de remo√ß√£o</li>
                                <li>Dados financeiros s√£o sempre preservados</li>
                                <li>Sistema previne perda acidental de dados</li>
                                <li>Todas as a√ß√µes s√£o registradas em log</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; text-align: center;">
                        <button onclick="closePlanPoliciesModal()" 
                                style="background: #3B82F6; color: white; border: none; padding: 1rem 2rem; 
                                       border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            Entendi
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePlanPoliciesModal();
                }
            });
        }
        
        // Close plan policies modal
        function closePlanPoliciesModal() {
            const modal = document.getElementById('planPoliciesModal');
            if (modal) {
                modal.remove();
            }
        }

        function loadClassesTabContent() {
            const content = document.getElementById('page-tab-classes');
            if (content) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94A3B8;">
                        ü•ã Turmas e hor√°rios em desenvolvimento
                    </div>
                `;
            }
        }

        function loadCoursesTabContent() {
            const content = document.getElementById('page-tab-courses');
            if (content) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94A3B8;">
                        üìö Cursos e progresso em desenvolvimento
                    </div>
                `;
            }
        }

        function loadProgressTabContent() {
            const content = document.getElementById('page-tab-progress');
            if (content) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94A3B8;">
                        üìà Progresso e conquistas em desenvolvimento
                    </div>
                `;
            }
        }

        // Functions for plan management
        async function createNewSubscription() {
            if (!currentEditingStudentId) {
                alert('Erro: ID do aluno n√£o encontrado');
                return;
            }
            
            // Simple implementation - could be expanded to show plan selection modal
            const planId = prompt('Digite o ID do plano para criar nova assinatura:');
            if (!planId) return;
            
            try {
                const response = await fetch('/api/financial/subscriptions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        studentId: currentEditingStudentId,
                        planId: planId,
                        status: 'ACTIVE',
                        isActive: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Assinatura criada com sucesso!');
                    // Reload the plans tab to show updated data
                    loadPlansTabContent();
                } else {
                    alert(`Erro ao criar assinatura: ${result.message}`);
                }
            } catch (error) {
                console.error('Erro ao criar assinatura:', error);
                alert(`Erro ao criar assinatura: ${error.message}`);
            }
        }
        
        async function switchToPlan(planId) {
            if (!currentEditingStudentId) {
                showToast('‚ùå Erro: ID do aluno n√£o encontrado', 'error');
                return;
            }
            
            console.log('üîÑ Switching to plan:', planId, 'for student:', currentEditingStudentId);
            
            // Use the improved assignment function which handles all fallbacks
            await assignPlanToStudent(planId);
        }

        // Navigation system with enhanced debugging
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard carregado com sucesso!');
            
            // Setup navigation
            const navButtons = document.querySelectorAll('.nav-link');
            console.log('üîç Found navigation buttons:', navButtons.length);
            
            navButtons.forEach(button => {
                const page = button.getAttribute('data-page');
                console.log('üìÑ Setting up navigation for:', page);
                
                button.addEventListener('click', function() {
                    const targetPage = this.getAttribute('data-page');
                    console.log('üîò Navigation clicked:', targetPage);
                    
                    // Special handling for payment-plans
                    if (targetPage === 'payment-plans') {
                        console.log('üí≥ Navigating to payment plans specifically');
                        
                        // Force hide plan-edit section
                        const planEditSection = document.getElementById('plan-edit');
                        if (planEditSection) {
                            planEditSection.classList.remove('active');
                            planEditSection.style.display = 'none';
                        }
                        
                        // Clear any global state
                        currentPlanId = null;
                    }
                    
                    showSection(targetPage);
                    
                    // Load the appropriate data for the section
                    switch (targetPage) {
                        case 'dashboard':
                            loadData();
                            break;
                        case 'students':
                            if (window.loadAndRenderStudents) {
                                window.loadAndRenderStudents();
                            }
                            break;
                        case 'courses':
                            if (window.loadAndRenderCourses) {
                                window.loadAndRenderCourses();
                            }
                            break;
                        case 'classes':
                            if (window.loadAndRenderClasses) {
                                window.loadAndRenderClasses();
                            }
                            break;
                        case 'financial':
                        case 'payment-plans':
                            if (window.loadAndRenderPlans) {
                                window.loadAndRenderPlans();
                            }
                            break;
                        default:
                            console.log(`No specific data loader for section: ${targetPage}`);
                    }
                });
            });
            
            // Load initial data
            loadData();
            
            // Define plan edit function globally
            window.openPlanEditPage = async function(planId) {
                console.log('üîÑ Opening plan edit page for:', planId);
                currentPlanId = planId;
                window.currentPlanId = planId;
                
                // Find the plan data
                const plan = allPlans.find(p => p.id == planId || p.id === planId);
                if (!plan) {
                    console.error('‚ùå Plan not found for edit page:', planId);
                    showNotification('Plano n√£o encontrado', 'error');
                    return;
                }
                
                // Hide all sections and show plan edit
                document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                });
                document.getElementById('plan-edit').style.display = 'block';
                
                // Update page subtitle with plan name
                document.getElementById('planEditSubtitle').textContent = `Editando: ${plan.name}`;
                
                // Set form dataset attributes
                const form = document.getElementById('planEditForm');
                if (form) {
                    form.dataset.mode = 'edit';
                    form.dataset.editingPlanId = planId;
                    console.log('‚úÖ Form data attributes set:', form.dataset);
                }
                
                // Populate form fields
                try {
                    await populatePlanEditForm(plan);
                } catch (error) {
                    console.error('‚ùå Error populating form:', error);
                    showNotification('Erro ao carregar dados do plano', 'error');
                }
                
                showNotification(`Editando plano: ${plan.name}`, 'info');
            };
            
            // Make switchPlanEditTab globally accessible
            window.switchPlanEditTab = function(tabName) {
                // Remove active class from all tabs and content
                document.querySelectorAll('.plan-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.plan-tab-content').forEach(content => content.classList.remove('active'));
                
                // Add active class to selected tab and content
                const selectedTab = document.querySelector(`.plan-tab[data-tab="${tabName}"]`);
                const selectedContent = document.getElementById(`planEditTab-${tabName}`);
                
                if (selectedTab && selectedContent) {
                    selectedTab.classList.add('active');
                    selectedContent.classList.add('active');
                }
                
                // Load content for specific tabs
                if (tabName === 'courses') {
                    // Only reload if not already loaded
                    const coursesGrid = document.getElementById('editCoursesGrid');
                    if (!coursesGrid || !coursesGrid.innerHTML.includes('planCourses')) {
                        console.log('üîÑ Tab courses - Loading for first time');
                        const currentSelection = getCurrentlySelectedCourseIds();
                        loadCoursesForPlanEdit(currentSelection);
                    } else {
                        console.log('‚úÖ Tab courses - Already loaded, skipping reload');
                    }
                } else if (tabName === 'preview') {
                    updatePlanPreview();
                }
            };
            
            // Add missing functions
            window.updatePlanEditPreview = function() {
                console.log('üîÑ Updating plan edit preview...');
                // Implementation for preview update
            };
            
            
            
            // Define populatePlanEditForm in the main DOMContentLoaded handler
            window.populatePlanEditForm = async function(plan) {
                console.log('üìù Populating comprehensive form with plan data:', plan);
                
                try {
                    // Helper function to safely set element value
                    const safeSetValue = (elementId, value) => {
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.value = value || '';
                            console.log(`‚úÖ Set ${elementId} = ${value}`);
                        } else {
                            console.warn(`‚ö†Ô∏è Element not found: ${elementId}`);
                        }
                    };

                    // Helper function to safely set checkbox
                    const safeSetCheckbox = (elementId, checked) => {
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.checked = checked;
                            console.log(`‚úÖ Set checkbox ${elementId} = ${checked}`);
                        } else {
                            console.warn(`‚ö†Ô∏è Checkbox not found: ${elementId}`);
                        }
                    };

                    // Basic information
                    safeSetValue('editPlanName', plan.name);
                    safeSetValue('editPlanDescription', plan.description);
                    safeSetValue('editPlanCategory', plan.category);
                    safeSetValue('editPlanPrice', plan.price);
                    safeSetValue('editPlanBillingType', plan.billingType || 'MONTHLY');
                    safeSetValue('editPlanWeeklyClasses', plan.classesPerWeek || 2);

                    // Set checkbox features
                    safeSetCheckbox('editPlanFeaturePersonal', plan.hasPersonalTraining || false);
                    safeSetCheckbox('editPlanFeatureNutrition', plan.hasNutrition || false);

                    // Load courses and pre-select them
                    console.log('üéì Loading courses for plan edit...');
                    console.log('üîç [DEBUG] Full plan data received:', plan);
                    console.log('üîç [DEBUG] Plan features:', plan.features);
                    console.log('üîç [DEBUG] Plan courseId:', plan.courseId);
                    
                    try {
                        // Prepare courses to pre-select
                        let coursesToSelect = [];
                        
                        // Check features.courseIds first (this is where multiple courses are saved)
                        if (plan.features && plan.features.courseIds && Array.isArray(plan.features.courseIds)) {
                            coursesToSelect = [...plan.features.courseIds];
                            console.log('‚úÖ Found courses in features.courseIds:', coursesToSelect);
                        } else {
                            console.warn('‚ö†Ô∏è No features.courseIds found or not an array');
                        }
                        
                        // Also check single courseId for backwards compatibility
                        if (plan.courseId && !coursesToSelect.includes(plan.courseId)) {
                            coursesToSelect.push(plan.courseId);
                            console.log('‚úÖ Added courseId to selection:', plan.courseId);
                        } else if (!plan.courseId) {
                            console.warn('‚ö†Ô∏è No single courseId found');
                        }
                        
                        console.log('üéì Final courses to select:', coursesToSelect);
                        
                        // Load courses with pre-selection
                        await loadCoursesForPlanEdit(coursesToSelect);
                        
                    } catch (error) {
                        console.error('‚ùå Error loading courses:', error);
                    }

                    console.log('‚úÖ Form populated successfully');
                } catch (error) {
                    console.error('‚ùå Error populating form:', error);
                    showNotification('Erro ao carregar dados do plano', 'error');
                }
            };
        });
        
        function showSection(pageName) {
            console.log('üìÑ Navegando para:', pageName);
            
            // Hide all sections with explicit display none
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
                console.log('üîí Hidden section:', section.id);
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.nav-link').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show target section with explicit display block
            const targetSection = document.getElementById(pageName);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
                console.log('‚úÖ Se√ß√£o ativa:', pageName);
                console.log('‚úÖ Display style:', targetSection.style.display);
                console.log('‚úÖ Has active class:', targetSection.classList.contains('active'));
            } else {
                console.error('‚ùå Se√ß√£o n√£o encontrada:', pageName);
                console.log('üîç Available sections:', Array.from(document.querySelectorAll('.content-section')).map(s => s.id));
            }
            
            // Activate current button
            const activeButton = document.querySelector(`[data-page="${pageName}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                console.log('‚úÖ Navigation button activated:', activeButton.textContent.trim());
            } else {
                console.error('‚ùå Navigation button not found for:', pageName);
            }

            // Load data for specific sections
            console.log('üîç Checking page data loading for:', pageName);
            if (pageName === 'course-management') {
                loadCourses();
            } else if (pageName === 'attendance') {
                loadAttendanceList();
            } else if (pageName === 'students') {
                loadStudents();
            } else if (pageName === 'student-portal') {
                // Reset student portal to login screen
                document.getElementById('studentLoginSection').style.display = 'block';
                document.getElementById('studentDashboard').style.display = 'none';
                currentStudent = null;
            } else if (pageName === 'public-checkin') {
                loadPublicCheckin();
            } else if (pageName === 'payment-plans') {
                console.log('üìÑ Loading payment plans page...');
                
                // Force hide plan-edit section
                const planEditSection = document.getElementById('plan-edit');
                if (planEditSection) {
                    planEditSection.classList.remove('active');
                    planEditSection.style.display = 'none';
                    console.log('üîí Force hidden plan-edit section');
                }
                
                // Clear any plan editing state
                currentPlanId = null;
                
                // Load the payment plans list
                loadPaymentPlansList();
            } else if (pageName === 'financial-responsibles') {
                console.log('üë• Loading financial responsibles page...');
                loadFinancialResponsiblesList();
            }
        }
        
        function loadData() {
            console.log('üìä Carregando dados...');
            
            // Students count will be updated by real API data
            
            // Try to load real data from API
            fetch('/api/students')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.length > 0) {
                        const total = data.data.length;
                        const active = data.data.filter(s => s.user && s.user.isActive).length;
                        
                        document.getElementById('total-students').textContent = total;
                        document.getElementById('active-students').textContent = active;
                        document.getElementById('students-count').textContent = total;
                        
                        console.log('‚úÖ Dados dos alunos atualizados:', total, 'total,', active, 'ativos');
                    }
                })
                .catch(error => {
                    console.log('‚ö†Ô∏è Usando dados padr√£o - API n√£o dispon√≠vel');
                });
        }
        
        // Test functions
        window.testNavigation = function(page) {
            showSection(page || 'students');
        };
        
        console.log('üéØ Sistema pronto! Teste: testNavigation("students")');
        
        // Apply showSection enhancement for knowledge base (check if function exists)
        if (typeof enhanceShowSection === 'function') {
            enhanceShowSection();
        }
        
        // Payment plans loading function
        async function loadPaymentPlansList() {
            console.log('üîÑ Loading payment plans list...');
            try {
                const loadingElement = document.getElementById('plansLoadingState');
                const emptyElement = document.getElementById('plansEmptyState');
                
                if (loadingElement) loadingElement.style.display = 'block';
                if (emptyElement) emptyElement.style.display = 'none';
                
                console.log('üì° Fetching billing plans from API...');
                const response = await fetch('/api/billing-plans');
                const result = await response.json();
                
                console.log('üìä API Response:', result);
                
                if (result.success) {
                    allPlans = result.data || [];
                    console.log('üìã Plans loaded:', allPlans.length, 'plans');
                    
                    updatePaymentPlansTable(allPlans);
                    updatePlansStats(allPlans);
                    
                    if (allPlans.length === 0) {
                        if (loadingElement) loadingElement.style.display = 'none';
                        if (emptyElement) emptyElement.style.display = 'block';
                        console.log('‚ö†Ô∏è No plans found - showing empty state');
                    } else {
                        if (loadingElement) loadingElement.style.display = 'none';
                        console.log('‚úÖ Plans table updated successfully');
                    }
                } else {
                    throw new Error(result.message || 'Failed to load plans');
                }
            } catch (error) {
                console.error('Erro ao carregar planos:', error);
                
                // Initialize allPlans as empty array to prevent undefined errors
                allPlans = [];
                updatePaymentPlansTable(allPlans);
                updatePlansStats(allPlans);
                
                const loadingElement = document.getElementById('plansLoadingState');
                if (loadingElement) {
                    loadingElement.innerHTML = `
                        <div style="text-align: center; color: #EF4444; padding: 3rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Erro ao carregar planos</div>
                            <div style="font-size: 0.9rem; opacity: 0.7;">${error.message}</div>
                        </div>
                    `;
                }
            }
        }
        
        // Global variables for payment plans
        let allPlans = [];
        let allCourses = [];
        
        // Update payment plans table
        function updatePaymentPlansTable(plans) {
            console.log('üîÑ Updating payment plans table with', plans?.length, 'plans');
            const tbody = document.getElementById('plansTableBody');
            
            if (!tbody) {
                console.error('‚ùå plansTableBody element not found in DOM');
                return;
            }
            
            if (!plans || !Array.isArray(plans)) {
                console.warn('‚ö†Ô∏è Plans data is undefined or not an array:', plans);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94A3B8; padding: 2rem;">Nenhum plano encontrado</td></tr>';
                return;
            }
            
            console.log('üìã Processing', plans.length, 'plans for table');
            
            tbody.innerHTML = plans.map(plan => {
                const courseName = (allCourses && Array.isArray(allCourses)) 
                    ? allCourses.find(c => c.id === plan.courseId)?.name || 'Geral'
                    : 'Geral';
                
                return `
                <tr ondblclick="openPlanEditPage('${plan.id}')" style="cursor: pointer;">
                    <td>
                        <div class="student-name">${plan.name || 'Plano sem nome'}</div>
                        <div style="font-size: 0.8rem; color: #94A3B8;">${plan.description || ''}</div>
                    </td>
                    <td>
                        <span class="student-email">${courseName}</span>
                    </td>
                    <td>
                        <span class="badge ${plan.category === 'ADULT' ? 'success' : 'info'}">
                            ${plan.category || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <span class="metric-value" style="color: #10B981; font-weight: bold;">
                            R$ ${(parseFloat(plan.price) || 0).toFixed(2)}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${plan.billingType === 'MONTHLY' ? 'info' : 'warning'}">
                            ${plan.billingType === 'MONTHLY' ? 'Mensal' : plan.billingType || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <span class="badge info">${plan.activeSubscriptions || 0}</span>
                    </td>
                    <td>
                        <span class="badge ${plan.isActive ? 'success' : 'danger'}">
                            ${plan.isActive ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editPlan('${plan.id}')" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="action-btn delete" onclick="deletePlan('${plan.id}')" title="Excluir">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
            
            console.log('‚úÖ Table HTML updated. Rows in tbody:', tbody.children.length);
        }
        
        // Update plans stats
        function updatePlansStats(plans) {
            if (!plans || !Array.isArray(plans)) return;
            
            const totalPlans = plans.length;
            const activePlans = plans.filter(p => p.isActive).length;
            const averagePrice = plans.length > 0 ? 
                plans.reduce((sum, plan) => sum + (parseFloat(plan.price) || 0), 0) / plans.length : 0;
            const monthlyPlans = plans.filter(p => p.billingType === 'MONTHLY').length;
            
            // Update stat cards if they exist
            const totalElement = document.getElementById('total-plans-stat');
            const activeElement = document.getElementById('active-plans-stat');
            const avgPriceElement = document.getElementById('avg-price-stat');
            const monthlyElement = document.getElementById('monthly-plans-stat');
            
            if (totalElement) totalElement.textContent = totalPlans;
            if (activeElement) activeElement.textContent = activePlans;
            if (avgPriceElement) avgPriceElement.textContent = `R$ ${averagePrice.toFixed(2)}`;
            if (monthlyElement) monthlyElement.textContent = monthlyPlans;
            
            // Update plans count badge
            const plansCountElement = document.getElementById('plans-count');
            if (plansCountElement) plansCountElement.textContent = totalPlans;
        }
        
        // Modal functions
        // Global variable to store financial responsibles
        let financialResponsibles = [];

        // Load financial responsibles
        async function loadFinancialResponsibles() {
            try {
                const response = await fetch('/api/financial-responsibles');
                const data = await response.json();
                
                if (data.success) {
                    financialResponsibles = data.data;
                    updateFinancialResponsiblesOptions();
                } else {
                    console.error('Erro ao carregar respons√°veis financeiros:', data.message);
                }
            } catch (error) {
                console.error('Erro ao carregar respons√°veis financeiros:', error);
            }
        }

        // Update both select elements with financial responsibles
        function updateFinancialResponsiblesOptions() {
            const addSelect = document.getElementById('studentFinancialResponsible');
            const editSelect = document.getElementById('editStudentFinancialResponsible');
            
            const optionsHTML = '<option value="">Selecione um respons√°vel (opcional)</option>' +
                financialResponsibles.map(responsible => 
                    `<option value="${responsible.id}">${responsible.name} - ${responsible.relationshipType || 'N√£o informado'}</option>`
                ).join('');
            
            if (addSelect) addSelect.innerHTML = optionsHTML;
            if (editSelect) editSelect.innerHTML = optionsHTML;
        }

        // Load billing plans dynamically
        async function loadBillingPlans() {
            try {
                console.log('üìã Carregando planos de pagamento...');
                const response = await fetch('/api/billing-plans');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log('üìã Planos de pagamento carregados:', data.data.length);
                    // Store plans for later use in plan preview
                    window.billingPlans = data.data;
                    updateBillingPlansOptions();
                } else {
                    console.log('üìã Nenhum plano de pagamento encontrado ou erro na API');
                    window.billingPlans = [];
                    updateBillingPlansOptions();
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar planos de pagamento:', error.message);
                window.billingPlans = [];
                updateBillingPlansOptions();
                // Don't throw - just log and continue
            }
        }

        // Update billing plans select options
        function updateBillingPlansOptions() {
            const billingPlanSelect = document.getElementById('studentBillingPlan');
            
            if (!billingPlanSelect) return;
            
            let optionsHTML = '<option value="">Selecione um plano (opcional)</option>';
            
            if (window.billingPlans && window.billingPlans.length > 0) {
                optionsHTML += window.billingPlans.map(plan => {
                    const courseName = plan.course?.name || 'Curso n√£o especificado';
                    const price = plan.price ? `R$ ${plan.price.toFixed(2)}` : 'Pre√ßo n√£o definido';
                    const category = plan.category || 'Categoria geral';
                    
                    return `<option value="${plan.id}">${plan.name} - ${price} (${category}) - ${courseName}</option>`;
                }).join('');
            }
            
            billingPlanSelect.innerHTML = optionsHTML;
        }

        function openAddStudentModal() {
            console.log('üîÑ Iniciando abertura do modal...');
            
            try {
                // ALWAYS open modal first - this is the critical part
                const modal = document.getElementById('addStudentModal');
                console.log('üîç Modal encontrado:', modal ? 'SIM' : 'N√ÉO');
                
                if (modal) {
                    console.log('üìù Classes atuais do modal:', modal.className);
                    modal.classList.add('active');
                    console.log('‚úÖ Classe "active" adicionada');
                    console.log('üìù Classes ap√≥s adi√ß√£o:', modal.className);
                    
                    // Load data after modal is open - don't block modal opening
                    console.log('üìä Iniciando carregamento de dados...');
                    loadDataForStudentModal();
                } else {
                    console.error('‚ùå Modal addStudentModal n√£o encontrado no DOM');
                    alert('Erro: Modal n√£o encontrado no DOM');
                    return;
                }
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao abrir modal:', error);
                alert('Erro cr√≠tico: ' + error.message);
            }
        }
        
        // Separate function to load data without blocking modal
        async function loadDataForStudentModal() {
            console.log('üìä Carregando dados do formul√°rio...');
            
            // Load billing plans first (planos reais)
            loadBillingPlans().catch(error => {
                console.error('‚ùå Erro ao carregar planos:', error);
            });
            
            // Load courses second (cursos reais)  
            loadCoursesForModal().catch(error => {
                console.error('‚ùå Erro ao carregar cursos:', error);
            });
            
            // Load classes third (turmas reais)
            loadClassesForModal().catch(error => {
                console.error('‚ùå Erro ao carregar turmas:', error);
            });
            
            // Load responsibles last
            loadFinancialResponsibles().catch(error => {
                console.error('‚ùå Erro ao carregar respons√°veis:', error);
            });
            
            console.log('‚úÖ Carregamento de dados iniciado');
        }

        // Load classes dynamically for the modal
        async function loadClassesForModal() {
            try {
                const response = await fetch('/api/classes');
                const data = await response.json();
                
                const classSelect = document.getElementById('studentClass');
                if (data.success && data.data && data.data.length > 0) {
                    let optionsHTML = '<option value="">Selecione uma turma...</option>';
                    data.data.forEach(classItem => {
                        const instructor = classItem.instructor ? 
                            `${classItem.instructor.user.firstName} ${classItem.instructor.user.lastName}` : 
                            'Professor n√£o definido';
                        const schedule = classItem.schedule || 
                            (classItem.startTime ? `${classItem.startTime}` : 'Hor√°rio n√£o definido');
                        const capacity = classItem.mat?.capacity || classItem.maxStudents || 'N/A';
                        const currentStudents = classItem._count?.studentCourses || 0;
                        
                        optionsHTML += `<option value="${classItem.id}">${classItem.name} - ${schedule} (${instructor}) - ${currentStudents}/${capacity} alunos</option>`;
                    });
                    classSelect.innerHTML = optionsHTML;
                } else {
                    classSelect.innerHTML = '<option value="">Nenhuma turma dispon√≠vel</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar turmas:', error);
                const classSelect = document.getElementById('studentClass');
                classSelect.innerHTML = '<option value="">Erro ao carregar turmas</option>';
            }
        }

        // Load courses dynamically for the modal
        async function loadCoursesForModal() {
            try {
                const response = await fetch('/api/courses');
                const data = await response.json();
                
                const courseSelect = document.getElementById('studentCourse');
                if (data.success && data.data && data.data.length > 0) {
                    let optionsHTML = '<option value="">Selecione um curso (opcional)</option>';
                    data.data.forEach(course => {
                        const martialArt = course.martialArt?.name || 'Arte marcial n√£o definida';
                        const classCount = course._count?.classes || 0;
                        const studentCount = course._count?.studentCourses || 0;
                        const planCount = course.billingPlans?.length || 0;
                        
                        optionsHTML += `<option value="${course.id}">${course.name} (${martialArt}) - ${classCount} turmas, ${studentCount} alunos, ${planCount} planos</option>`;
                    });
                    courseSelect.innerHTML = optionsHTML;
                } else {
                    courseSelect.innerHTML = '<option value="">Nenhum curso dispon√≠vel</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar cursos:', error);
                const courseSelect = document.getElementById('studentCourse');
                courseSelect.innerHTML = '<option value="">Erro ao carregar cursos</option>';
            }
        }
        
        // Function called by edit button in table
        async function openEditStudentModal(studentId) {
            // Redirect to dedicated page instead of modal
            console.log('üîÑ Redirecionando openEditStudentModal para tela completa:', studentId);
            await openStudentEditPage(studentId);
        }

        function closeEditStudentModal() {
            document.getElementById('editStudentModal').classList.remove('active');
            // Clear form
            document.getElementById('editStudentForm').reset();
        }

        async function saveEditStudent() {
            const studentId = currentEditingStudentId;
            
            console.log('üîç Debug saveEditStudent - currentEditingStudentId:', studentId);
            
            if (!studentId) {
                console.error('‚ùå Student ID not found');
                showToast('‚ùå Erro: ID do aluno n√£o encontrado', 'error');
                return;
            }
            
            const formData = {
                firstName: document.getElementById('editFirstName').value,
                lastName: document.getElementById('editLastName').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                cpf: document.getElementById('editCpf').value,
                birthDate: document.getElementById('editBirthDate').value,
                category: document.getElementById('editCategory').value,
                gender: document.getElementById('editGender').value,
                physicalCondition: document.getElementById('editPhysicalCondition').value,
                enrollmentDate: document.getElementById('editEnrollmentDate').value,
                medicalConditions: document.getElementById('editMedicalConditions').value,
                emergencyContact: document.getElementById('editEmergencyContact').value,
                specialNeeds: Array.from(document.getElementById('editSpecialNeeds').selectedOptions).map(option => option.value)
            };
            
            try {
                const response = await fetch(`/api/students/${studentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Aluno atualizado com sucesso!', 'success');
                    closeEditStudentModal();
                    loadData(); // Reload students data
                } else {
                    throw new Error(result.message || 'Erro ao atualizar aluno');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao atualizar aluno: ' + error.message, 'error');
            }
        }

        function editStudent(studentId) {
            // Redirect to dedicated page instead of modal
            console.log('üîÑ Redirecionando editStudent para tela completa:', studentId);
            openStudentEditPage(studentId);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            // Limpar dados do sistema de vincula√ß√£o autom√°tica quando fechar modal de adicionar aluno
            if (modalId === 'addStudentModal') {
                selectedClasses = [];
                selectedCourses = [];
                currentPlanData = null;
                
                // Esconder containers
                document.getElementById('classesSelectionContainer').style.display = 'none';
                document.getElementById('coursesSelectionContainer').style.display = 'none';
                document.getElementById('totalCostDisplay').style.display = 'none';
                
                // Resetar select de plano
                document.getElementById('studentBillingPlan').value = '';
                
                console.log('üßπ Dados de vincula√ß√£o autom√°tica limpos');
            }
        }
        
        // Form submissions
        document.getElementById('addStudentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                firstName: document.getElementById('studentName').value.split(' ')[0],
                lastName: document.getElementById('studentName').value.split(' ').slice(1).join(' '),
                email: document.getElementById('studentEmail').value,
                phone: document.getElementById('studentPhone').value,
                birthDate: document.getElementById('studentBirthDate').value,
                gender: document.getElementById('studentGender').value,
                category: document.getElementById('studentCategory').value,
                billingPlanId: document.getElementById('studentBillingPlan').value || null, // Billing plan selection
                courseId: document.getElementById('studentCourse').value || null, // For intelligent enrollment
                classId: document.getElementById('studentClass').value,
                financialResponsibleId: document.getElementById('studentFinancialResponsible').value || null,
                // Sistema de vincula√ß√£o autom√°tica - turmas e cursos baseados no plano
                selectedClasses: selectedClasses || [], // Turmas selecionadas (inclu√≠das + avulsas)
                selectedCourses: selectedCourses || [], // Cursos selecionados (inclu√≠dos + avulsos)
                planBasedSelection: currentPlanData ? {
                    planId: document.getElementById('studentBillingPlan').value,
                    includedClasses: currentPlanData.availableClasses.map(cls => cls.id),
                    includedCourses: currentPlanData.availableCourses.map(course => course.id),
                    additionalClasses: selectedClasses.filter(id => 
                        !currentPlanData.availableClasses.some(cls => cls.id === id)
                    ),
                    additionalCourses: selectedCourses.filter(id => 
                        !currentPlanData.availableCourses.some(course => course.id === id)
                    )
                } : null
            };
            
            console.log('üéØ Adicionando aluno com vincula√ß√£o autom√°tica:', formData);
            
            // In a real app, make API call here
            fetch('/api/students', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = 'Aluno adicionado com sucesso!';
                    
                    // Incluir informa√ß√µes sobre turmas e cursos selecionados
                    if (formData.selectedClasses.length > 0 || formData.selectedCourses.length > 0) {
                        message += `\n\nüéØ Vincula√ß√£o Autom√°tica:`;
                        
                        if (formData.selectedClasses.length > 0) {
                            message += `\n‚Ä¢ ${formData.selectedClasses.length} turma(s) vinculada(s)`;
                        }
                        
                        if (formData.selectedCourses.length > 0) {
                            message += `\n‚Ä¢ ${formData.selectedCourses.length} curso(s) vinculado(s)`;
                        }
                        
                        if (formData.planBasedSelection) {
                            const { additionalClasses, additionalCourses } = formData.planBasedSelection;
                            if (additionalClasses.length > 0 || additionalCourses.length > 0) {
                                message += `\n‚Ä¢ ${additionalClasses.length + additionalCourses.length} item(ns) avulso(s) adicionado(s)`;
                            }
                        }
                    }
                    
                    // Check if intelligent enrollment was used
                    if (data.data && data.data.automaticEnrollment && data.data.automaticEnrollment.courseId) {
                        if (data.data.automaticEnrollment.subscriptionCreated) {
                            message += '\n\n‚úÖ Matr√≠cula Inteligente:\n‚Ä¢ Curso selecionado automaticamente\n‚Ä¢ Plano de pagamento criado\n‚Ä¢ Assinatura ativada';
                        } else {
                            message += '\n\n‚ö†Ô∏è Matr√≠cula Inteligente:\n‚Ä¢ Curso selecionado\n‚Ä¢ Plano criado (verificar assinatura)';
                        }
                    }
                    
                    showToast(message.replace(/\n/g, ' '), 'success');
                    closeModal('addStudentModal');
                    
                    // Limpar sele√ß√µes ap√≥s sucesso
                    selectedClasses = [];
                    selectedCourses = [];
                    currentPlanData = null;
                    
                    // Reload students data
                    if (typeof loadStudents === 'function') {
                        loadStudents();
                    }
                } else {
                    showToast('Erro ao adicionar aluno: ' + (data.message || 'Erro desconhecido'), 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            });
        });
        
        document.getElementById('editStudentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const studentId = currentEditingStudentId;
            
            if (!studentId) {
                console.error('‚ùå Student ID not found in form submission');
                showToast('‚ùå Erro: ID do aluno n√£o encontrado', 'error');
                return;
            }
            
            const formData = {
                name: document.getElementById('editStudentName').value,
                email: document.getElementById('editStudentEmail').value,
                phone: document.getElementById('editStudentPhone').value,
                birthDate: document.getElementById('editStudentBirthDate').value,
                gender: document.getElementById('editStudentGender').value,
                category: document.getElementById('editStudentCategory').value,
                classId: document.getElementById('editStudentClass').value,
                financialResponsibleId: document.getElementById('editStudentFinancialResponsible').value || null
            };
            
            console.log('Editando aluno ID:', studentId, formData);
            
            // In a real app, make API call here
            fetch(`/api/students/${studentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Aluno atualizado com sucesso!');
                    closeModal('editStudentModal');
                    // Reload students data
                    loadData();
                } else {
                    alert('Erro ao atualizar aluno: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            });
        });
        
        // ========================================
        // COURSE MANAGEMENT FUNCTIONS
        // ========================================
        
        // Load courses data when navigating to course management
        function loadCourses() {
            console.log('üìö Carregando cursos...');
            
            fetch('/api/courses')
                .then(response => response.json())
                .then(data => {
                    if (data.success && Array.isArray(data.data)) {
                        updateCoursesTable(data.data);
                    } else {
                        // Show empty state
                        updateCoursesTable([]);
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar cursos:', error);
                    // Show empty state on error
                    updateCoursesTable([]);
                });
        }
        
        function updateCoursesTable(courses) {
            const tbody = document.getElementById('courses-table-body');
            
            if (courses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                            Nenhum curso cadastrado. Clique em "Novo Curso" para come√ßar.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = courses.map(course => `
                <tr class="course-row" data-course-id="${course.id}" ondblclick="openCourseDetail('${course.id}')" style="cursor: pointer; transition: background-color 0.2s;">
                    <td>${course.name}</td>
                    <td>${course.category || 'N√£o informado'}</td>
                    <td>${course.level || 'B√°sico'}</td>
                    <td>${course.totalClasses || 48}</td>
                    <td>${course.stats?.totalEnrollments || 0}</td>
                    <td>
                        <span class="status-badge ${course.isActive ? 'status-active' : 'status-inactive'}">
                            ${course.isActive ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); editCourse('${course.id}')">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); deleteCourse('${course.id}')">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Add hover effect to course rows
            document.querySelectorAll('.course-row').forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
        }
        
        // Course detail modal functions
        let currentCourseId = null;
        
        function openCourseDetail(courseId) {
            currentCourseId = courseId;
            document.getElementById('courseDetailModal').style.display = 'block';
            
            // Load course data
            fetch(`/api/courses/${courseId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayCourseDetail(data.data);
                    } else {
                        console.error('Erro ao carregar curso:', data.error);
                        showToast('Erro ao carregar dados do curso', 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar curso:', error);
                    showToast('Erro ao carregar dados do curso', 'error');
                });
        }
        
        function closeCourseDetail() {
            document.getElementById('courseDetailModal').style.display = 'none';
            currentCourseId = null;
        }
        
        function displayCourseDetail(course) {
            // Update modal title
            document.getElementById('courseDetailTitle').textContent = course.name || 'Detalhes do Curso';
            
            // Show overview tab by default
            switchCourseDetailTab('overview');
            loadCourseOverview(course);
        }
        
        function switchCourseDetailTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.modal-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = '#CBD5E1';
            });
            
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.background = 'linear-gradient(135deg, #3B82F6, #1D4ED8)';
                activeTab.style.color = 'white';
            }
            
            // Load tab content
            const contentDiv = document.getElementById('courseDetailContent');
            switch(tabName) {
                case 'overview':
                    loadCourseOverview(null);
                    break;
                case 'plans':
                    loadCoursePlans();
                    break;
                case 'classes':
                    loadCourseClasses();
                    break;
                case 'lessons':
                    loadCourseLessons();
                    break;
                case 'techniques':
                    loadCourseTechniques();
                    break;
                case 'students':
                    loadCourseStudents();
                    break;
                default:
                    contentDiv.innerHTML = '<p>Conte√∫do n√£o encontrado</p>';
            }
        }
        
        function loadCourseOverview(course) {
            const contentDiv = document.getElementById('courseDetailContent');
            contentDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                    <div>
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üìö Informa√ß√µes do Curso</h3>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                            <p><strong>Nome:</strong> ${course?.name || 'Krav Maga Faixa Branca - Defesa Pessoal 1'}</p>
                            <p><strong>Categoria:</strong> ${course?.category || 'Adulto'}</p>
                            <p><strong>N√≠vel:</strong> ${course?.level || 'B√°sico'}</p>
                            <p><strong>Total de Aulas:</strong> ${course?.totalClasses || 48}</p>
                            <p><strong>Status:</strong> ${course?.isActive ? 'Ativo' : 'Inativo'}</p>
                        </div>
                        
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üìä Estat√≠sticas</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; color: #10B981; margin-bottom: 0.5rem;">${course?.stats?.totalEnrollments || 0}</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">Alunos Matriculados</div>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; color: #F59E0B; margin-bottom: 0.5rem;">${course?.stats?.totalClasses || 2}</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">Turmas Ativas</div>
                            </div>
                            <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; color: #8B5CF6; margin-bottom: 0.5rem;">${course?.stats?.avgAttendance || 85}%</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem;">Frequ√™ncia M√©dia</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">‚ö° A√ß√µes R√°pidas</h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <button class="btn btn-primary" onclick="editCourse(currentCourseId)" style="width: 100%; justify-content: flex-start;">
                                <span>‚úèÔ∏è</span> Editar Curso
                            </button>
                            <button class="btn btn-secondary" onclick="duplicateCourse(currentCourseId)" style="width: 100%; justify-content: flex-start;">
                                <span>üìã</span> Duplicar Curso
                            </button>
                            <button class="btn btn-success" onclick="exportCourse(currentCourseId)" style="width: 100%; justify-content: flex-start;">
                                <span>üì§</span> Exportar Dados
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadCoursePlans() {
            const contentDiv = document.getElementById('courseDetailContent');
            contentDiv.innerHTML = `
                <div>
                    <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üí≥ Planos de Pagamento Associados</h3>
                    <div id="coursePlansContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
                            <h4 style="color: #3B82F6; margin-bottom: 1rem;">Plano Mensal - Adulto</h4>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Valor:</strong> R$ 180,00</p>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Categoria:</strong> ADULT</p>
                            <p style="color: #CBD5E1; margin-bottom: 1rem;"><strong>Alunos:</strong> 4 matriculados</p>
                            <button class="btn btn-secondary btn-small" onclick="editPlan('plan-1')">
                                ‚úèÔ∏è Editar Plano
                            </button>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <h4 style="color: #10B981; margin-bottom: 1rem;">Plano Mensal - Iniciante</h4>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Valor:</strong> R$ 120,00</p>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Categoria:</strong> INICIANTE1</p>
                            <p style="color: #CBD5E1; margin-bottom: 1rem;"><strong>Alunos:</strong> 2 matriculados</p>
                            <button class="btn btn-secondary btn-small" onclick="editPlan('plan-2')">
                                ‚úèÔ∏è Editar Plano
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="createNewPlan(currentCourseId)">
                            <span>‚ûï</span> Criar Novo Plano
                        </button>
                    </div>
                </div>
            `;
        }
        
        function loadCourseClasses() {
            const contentDiv = document.getElementById('courseDetailContent');
            contentDiv.innerHTML = `
                <div>
                    <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üè´ Turmas do Curso</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(139, 92, 246, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.3);">
                            <h4 style="color: #8B5CF6; margin-bottom: 1rem;">Turma 1 - Ter√ßas e Quintas</h4>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Hor√°rio:</strong> 18:00 - 19:00</p>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Capacidade:</strong> 8/20 alunos</p>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Instrutor:</strong> Jo√£o Silva</p>
                            <p style="color: #CBD5E1; margin-bottom: 1rem;"><strong>Status:</strong> <span style="color: #10B981;">Ativa</span></p>
                            <button class="btn btn-secondary btn-small" onclick="viewClassDetails('class-1')">
                                üëÅÔ∏è Ver Detalhes
                            </button>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <h4 style="color: #10B981; margin-bottom: 1rem;">Turma 2 - Segundas e Quartas</h4>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Hor√°rio:</strong> 19:00 - 20:00</p>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Capacidade:</strong> 5/20 alunos</p>
                            <p style="color: #CBD5E1; margin-bottom: 0.5rem;"><strong>Instrutor:</strong> Maria Santos</p>
                            <p style="color: #CBD5E1; margin-bottom: 1rem;"><strong>Status:</strong> <span style="color: #10B981;">Ativa</span></p>
                            <button class="btn btn-secondary btn-small" onclick="viewClassDetails('class-2')">
                                üëÅÔ∏è Ver Detalhes
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="createNewClass(currentCourseId)">
                            <span>‚ûï</span> Criar Nova Turma
                        </button>
                    </div>
                </div>
            `;
        }
        
        function loadCourseLessons() {
            const contentDiv = document.getElementById('courseDetailContent');
            contentDiv.innerHTML = `
                <div>
                    <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üìã Planos de Aula</h3>
                    <div style="background: rgba(59, 130, 246, 0.05); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <p style="color: #CBD5E1; margin-bottom: 1rem;">Total: 48 aulas organizadas em 5 unidades pedag√≥gicas</p>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; text-align: center;">
                            <div style="background: #10B981; padding: 0.5rem; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                                 onclick="showLessonsByUnit('fundamentos')" 
                                 onmouseover="this.style.borderColor='#059669'; this.style.transform='scale(1.05)';" 
                                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)';">
                                <div>üìö Fundamentos</div>
                                <div style="font-size: 0.75rem;">Aulas 1-10</div>
                            </div>
                            <div style="background: #3B82F6; padding: 0.5rem; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                                 onclick="showLessonsByUnit('golpes')" 
                                 onmouseover="this.style.borderColor='#1D4ED8'; this.style.transform='scale(1.05)';" 
                                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)';">
                                <div>üëä Golpes B√°sicos</div>
                                <div style="font-size: 0.75rem;">Aulas 11-20</div>
                            </div>
                            <div style="background: #8B5CF6; padding: 0.5rem; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                                 onclick="showLessonsByUnit('defesas')" 
                                 onmouseover="this.style.borderColor='#7C3AED'; this.style.transform='scale(1.05)';" 
                                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)';">
                                <div>üõ°Ô∏è Defesas B√°sicas</div>
                                <div style="font-size: 0.75rem;">Aulas 21-30</div>
                            </div>
                            <div style="background: #F59E0B; padding: 0.5rem; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                                 onclick="showLessonsByUnit('avancadas')" 
                                 onmouseover="this.style.borderColor='#D97706'; this.style.transform='scale(1.05)';" 
                                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)';">
                                <div>‚öîÔ∏è Defesas Avan√ßadas</div>
                                <div style="font-size: 0.75rem;">Aulas 31-40</div>
                            </div>
                            <div style="background: #EF4444; padding: 0.5rem; border-radius: 6px; color: white; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                                 onclick="showLessonsByUnit('integracao')" 
                                 onmouseover="this.style.borderColor='#DC2626'; this.style.transform='scale(1.05)';" 
                                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)';">
                                <div>üîÑ Integra√ß√£o</div>
                                <div style="font-size: 0.75rem;">Aulas 41-48</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEW: Enhanced Unit Navigation Bar -->
                    <div style="background: rgba(15, 23, 42, 0.8); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #334155;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                            <h4 style="color: #F8FAFC; margin: 0; font-size: 1rem; font-weight: 600;">üéØ Navega√ß√£o por Unidade</h4>
                            <div style="flex: 1; height: 1px; background: linear-gradient(90deg, #3B82F6, transparent);"></div>
                            <span id="current-unit-name" style="color: #10B981; font-weight: 600; font-size: 0.875rem;">Todas as Unidades</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;">
                            <button class="btn" onclick="showAllLessons()" 
                                    style="background: linear-gradient(135deg, #6B7280, #4B5563); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" 
                                    onmouseover="this.style.background='linear-gradient(135deg, #4B5563, #374151)'; this.style.transform='translateY(-2px)';" 
                                    onmouseout="this.style.background='linear-gradient(135deg, #6B7280, #4B5563)'; this.style.transform='translateY(0)';">
                                üìã Todas as Aulas
                            </button>
                            <button class="btn" onclick="showLessonsByUnit('fundamentos')" 
                                    style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" 
                                    onmouseover="this.style.background='linear-gradient(135deg, #059669, #047857)'; this.style.transform='translateY(-2px)';" 
                                    onmouseout="this.style.background='linear-gradient(135deg, #10B981, #059669)'; this.style.transform='translateY(0)';">
                                üìö Fundamentos
                            </button>
                            <button class="btn" onclick="showLessonsByUnit('golpes')" 
                                    style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" 
                                    onmouseover="this.style.background='linear-gradient(135deg, #1D4ED8, #1E40AF)'; this.style.transform='translateY(-2px)';" 
                                    onmouseout="this.style.background='linear-gradient(135deg, #3B82F6, #1D4ED8)'; this.style.transform='translateY(0)';">
                                üëä Golpes B√°sicos
                            </button>
                            <button class="btn" onclick="showLessonsByUnit('defesas')" 
                                    style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" 
                                    onmouseover="this.style.background='linear-gradient(135deg, #7C3AED, #6D28D9)'; this.style.transform='translateY(-2px)';" 
                                    onmouseout="this.style.background='linear-gradient(135deg, #8B5CF6, #7C3AED)'; this.style.transform='translateY(0)';">
                                üõ°Ô∏è Defesas B√°sicas
                            </button>
                            <button class="btn" onclick="showLessonsByUnit('avancadas')" 
                                    style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" 
                                    onmouseover="this.style.background='linear-gradient(135deg, #D97706, #B45309)'; this.style.transform='translateY(-2px)';" 
                                    onmouseout="this.style.background='linear-gradient(135deg, #F59E0B, #D97706)'; this.style.transform='translateY(0)';">
                                ‚öîÔ∏è Defesas Avan√ßadas
                            </button>
                            <button class="btn" onclick="showLessonsByUnit('integracao')" 
                                    style="background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" 
                                    onmouseover="this.style.background='linear-gradient(135deg, #DC2626, #B91C1C)'; this.style.transform='translateY(-2px)';" 
                                    onmouseout="this.style.background='linear-gradient(135deg, #EF4444, #DC2626)'; this.style.transform='translateY(0)';">
                                üîÑ Integra√ß√£o
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lesson Plans Table Container -->
                    <div id="lesson-plans-container" style="background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; border: 1px solid #334155;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="color: #F8FAFC; margin: 0; font-size: 1.125rem; font-weight: 600;">üìã Planos de Aula</h4>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="color: #10B981; font-size: 0.875rem; font-weight: 500;">‚úÖ Sistema habilitado</span>
                                <button class="btn btn-primary" onclick="manageLessonPlans(currentCourseId)" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    <span>‚öôÔ∏è</span> Gerenciar
                                </button>
                                <button class="btn btn-secondary" onclick="exportLessonPlans(currentCourseId)" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    <span>üì§</span> Exportar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Lesson Plans Table -->
                        <div style="background: rgba(30, 41, 59, 0.5); border-radius: 8px; overflow: hidden; border: 1px solid #475569;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: rgba(59, 130, 246, 0.1); border-bottom: 1px solid #475569;">
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Aula</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Semana</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">T√≠tulo</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Unidade</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">T√©cnicas</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Dura√ß√£o</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.875rem;">N√≠vel</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Status</th>
                                        <th style="color: #F8FAFC; padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.875rem;">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="lesson-plans-table-body">
                                    <tr>
                                        <td colspan="9" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üéØ</div>
                                            Clique em uma unidade acima para ver os planos de aula
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <div style="display: flex; gap: 1rem; align-items: center; justify-content: center;">
                            <button class="btn btn-primary" onclick="manageLessonPlans(currentCourseId)">
                                <span>‚öôÔ∏è</span> Gerenciar Planos de Aula
                            </button>
                            <button class="btn btn-secondary" onclick="exportLessonPlans(currentCourseId)">
                                <span>üì§</span> Exportar Planos
                            </button>
                            <button class="btn btn-secondary" onclick="showLessonPlanManager()">
                                <span>üîß</span> Modo Avan√ßado
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadCourseTechniques() {
            const contentDiv = document.getElementById('courseDetailContent');
            contentDiv.innerHTML = `
                <div>
                    <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ü•ä T√©cnicas do Curso</h3>
                    <div style="background: rgba(139, 92, 246, 0.05); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <p style="color: #CBD5E1; margin-bottom: 1rem;">Total: 42 t√©cnicas catalogadas</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #10B981; margin-bottom: 0.5rem;">Fundamentos</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">Posturas, movimenta√ß√£o b√°sica, dist√¢ncia</p>
                            </div>
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #3B82F6; margin-bottom: 0.5rem;">Golpes B√°sicos</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">Socos, chutes, joelhadas</p>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #F59E0B; margin-bottom: 0.5rem;">Defesas</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">Bloqueios, esquivas, contra-ataques</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="manageTechniques(currentCourseId)">
                            <span>‚öôÔ∏è</span> Gerenciar T√©cnicas
                        </button>
                        <button class="btn btn-secondary" onclick="viewTechniquesLibrary(currentCourseId)">
                            <span>üìö</span> Biblioteca de T√©cnicas
                        </button>
                    </div>
                </div>
            `;
        }
        
        function loadCourseStudents() {
            const contentDiv = document.getElementById('courseDetailContent');
            contentDiv.innerHTML = `
                <div>
                    <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üë• Alunos Matriculados</h3>
                    <div style="background: rgba(59, 130, 246, 0.05); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <p style="color: #CBD5E1; margin-bottom: 1rem;">Total: 4 alunos matriculados</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #10B981; margin-bottom: 0.5rem;">Maria Silva</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">Matr√≠cula: KMA0001 ‚Ä¢ Turma 1 ‚Ä¢ 85% frequ√™ncia</p>
                            </div>
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #3B82F6; margin-bottom: 0.5rem;">Pedro Costa</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">Matr√≠cula: KMA0002 ‚Ä¢ Turma 2 ‚Ä¢ 90% frequ√™ncia</p>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #F59E0B; margin-bottom: 0.5rem;">Ana Oliveira</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">Matr√≠cula: KMA0003 ‚Ä¢ Turma 1 ‚Ä¢ 75% frequ√™ncia</p>
                            </div>
                            <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px;">
                                <h4 style="color: #8B5CF6; margin-bottom: 0.5rem;">Carlos Rodrigues</h4>
                                <p style="color: #CBD5E1; font-size: 0.875rem;">Matr√≠cula: KMA0004 ‚Ä¢ Turma 2 ‚Ä¢ 80% frequ√™ncia</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="enrollNewStudent(currentCourseId)">
                            <span>‚ûï</span> Matricular Aluno
                        </button>
                        <button class="btn btn-secondary" onclick="viewStudentProgress(currentCourseId)">
                            <span>üìä</span> Ver Progresso
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Helper functions for course management
        function editCourse(courseId) {
            console.log('Editando curso:', courseId);
            // TODO: Implement course editing
            showToast('Fun√ß√£o de edi√ß√£o em desenvolvimento', 'info');
        }
        
        function deleteCourse(courseId) {
            if (confirm('Tem certeza que deseja excluir este curso?')) {
                console.log('Excluindo curso:', courseId);
                // TODO: Implement course deletion
                showToast('Fun√ß√£o de exclus√£o em desenvolvimento', 'info');
            }
        }
        
        function filterCourses() {
            const searchTerm = document.getElementById('courseSearch').value.toLowerCase();
            const rows = document.querySelectorAll('.course-row');
            
            rows.forEach(row => {
                const courseName = row.querySelector('td:first-child').textContent.toLowerCase();
                const courseCategory = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const courseLevel = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                
                if (courseName.includes(searchTerm) || courseCategory.includes(searchTerm) || courseLevel.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function refreshCourses() {
            loadCourses();
            showToast('Lista de cursos atualizada', 'success');
        }
        
        function exportCourses() {
            console.log('Exportando cursos');
            // TODO: Implement export functionality
            showToast('Fun√ß√£o de exporta√ß√£o em desenvolvimento', 'info');
        }
        
        function openCourseModal() {
            console.log('Abrindo modal de novo curso');
            // TODO: Implement course creation modal
            showToast('Modal de cria√ß√£o em desenvolvimento', 'info');
        }
        
        // Course modal functions
        function openAddCourseModal() {
            document.getElementById('addCourseModal').classList.add('active');
        }
        
        function editCourse(courseId) {
            // Load course data and open edit modal
            fetch(`/api/courses/${courseId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const course = data.data;
                        document.getElementById('editCourseId').value = course.id;
                        document.getElementById('editCourseName').value = course.name;
                        document.getElementById('editCourseDescription').value = course.description || '';
                        document.getElementById('editCourseCategory').value = course.category;
                        document.getElementById('editCourseLevel').value = course.level;
                        document.getElementById('editCourseTotalClasses').value = course.totalClasses;
                        document.getElementById('editCourseClassesPerWeek').value = course.classesPerWeek;
                        
                        document.getElementById('editCourseModal').classList.add('active');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao carregar dados do curso');
                });
        }
        
        // Lesson plans functions
        function showLessonPlans(courseId, courseName) {
            document.getElementById('current-course-name').textContent = courseName;
            document.getElementById('lesson-plans-section').style.display = 'block';
            
            // Load lesson plans
            fetch(`/api/courses-management/${courseId}/lesson-plans`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateLessonPlansTable(data.data, courseId);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
        }
        
        function hideLessonPlans() {
            document.getElementById('lesson-plans-section').style.display = 'none';
        }
        
        function updateLessonPlansTable(lessonPlans, courseId) {
            const tbody = document.getElementById('lesson-plans-table-body');
            
            if (lessonPlans.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                            Nenhum plano de aula criado. 
                            <button class="btn btn-primary btn-small" onclick="openLessonPlanModal('${courseId}', 1)">
                                Criar Primeira Aula
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = lessonPlans.map(plan => `
                <tr>
                    <td>${plan.lessonNumber}</td>
                    <td>${plan.title}</td>
                    <td>${plan.duration} min</td>
                    <td>${plan.difficulty}</td>
                    <td>
                        <button class="btn btn-secondary btn-small" onclick="openFeedbackModal('${courseId}', ${plan.lessonNumber})">
                            üí¨ Feedback
                        </button>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-small" onclick="openLessonPlanModal('${courseId}', ${plan.lessonNumber})">
                                ‚úèÔ∏è Editar
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function openLessonPlanModal(courseId, lessonNumber) {
            document.getElementById('lessonCourseId').value = courseId;
            document.getElementById('lessonNumber').value = lessonNumber;
            
            // If editing existing lesson plan, load data
            if (lessonNumber > 1) {
                // Load existing lesson plan data (simplified for demo)
                document.getElementById('lessonTitle').value = `Aula ${lessonNumber}`;
            } else {
                // Clear form for new lesson
                document.getElementById('lessonPlanForm').reset();
                document.getElementById('lessonCourseId').value = courseId;
                document.getElementById('lessonNumber').value = lessonNumber;
            }
            
            document.getElementById('lessonPlanModal').classList.add('active');
        }
        
        function openFeedbackModal(courseId, lessonNumber) {
            document.getElementById('feedbackCourseId').value = courseId;
            document.getElementById('feedbackLessonNumber').value = lessonNumber;
            document.getElementById('lessonFeedbackModal').classList.add('active');
        }
        
        // Form submissions
        document.getElementById('addCourseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('courseName').value,
                description: document.getElementById('courseDescription').value,
                category: document.getElementById('courseCategory').value,
                level: document.getElementById('courseLevel').value,
                totalClasses: document.getElementById('courseTotalClasses').value,
                classesPerWeek: document.getElementById('courseClassesPerWeek').value,
                duration: document.getElementById('courseDuration').value,
                minAge: document.getElementById('courseMinAge').value,
                maxAge: document.getElementById('courseMaxAge').value,
                objectives: document.getElementById('courseObjectives').value.split('\\n').filter(obj => obj.trim()),
                requirements: document.getElementById('courseRequirements').value.split('\\n').filter(req => req.trim())
            };
            
            fetch('/api/courses-management', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Curso criado com sucesso!');
                    closeModal('addCourseModal');
                    loadCourses();
                } else {
                    alert('Erro ao criar curso: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            });
        });
        
        document.getElementById('editCourseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const courseId = document.getElementById('editCourseId').value;
            const formData = {
                name: document.getElementById('editCourseName').value,
                description: document.getElementById('editCourseDescription').value,
                category: document.getElementById('editCourseCategory').value,
                level: document.getElementById('editCourseLevel').value,
                totalClasses: document.getElementById('editCourseTotalClasses').value,
                classesPerWeek: document.getElementById('editCourseClassesPerWeek').value
            };
            
            fetch(`/api/courses-management/${courseId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Curso atualizado com sucesso!');
                    closeModal('editCourseModal');
                    loadCourses();
                } else {
                    alert('Erro ao atualizar curso: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            });
        });
        
        document.getElementById('lessonPlanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const courseId = document.getElementById('lessonCourseId').value;
            const formData = {
                lessonNumber: document.getElementById('lessonNumber').value,
                title: document.getElementById('lessonTitle').value,
                objectives: document.getElementById('lessonObjectives').value.split('\\n').filter(obj => obj.trim()),
                warmUp: document.getElementById('lessonWarmUp').value,
                mainContent: document.getElementById('lessonMainContent').value,
                coolDown: document.getElementById('lessonCoolDown').value,
                equipment: document.getElementById('lessonEquipment').value.split(',').map(eq => eq.trim()).filter(eq => eq),
                duration: document.getElementById('lessonDuration').value,
                difficulty: document.getElementById('lessonDifficulty').value,
                adaptations: document.getElementById('lessonAdaptations').value,
                notes: document.getElementById('lessonNotes').value
            };
            
            fetch(`/api/courses-management/${courseId}/lesson-plans`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Plano de aula salvo com sucesso!');
                    closeModal('lessonPlanModal');
                    // Reload lesson plans
                    showLessonPlans(courseId, document.getElementById('current-course-name').textContent);
                } else {
                    alert('Erro ao salvar plano: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            });
        });
        
        document.getElementById('lessonFeedbackForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                courseId: document.getElementById('feedbackCourseId').value,
                lessonNumber: document.getElementById('feedbackLessonNumber').value,
                feedback: document.getElementById('feedbackGeneral').value,
                studentsPresent: document.getElementById('feedbackStudentsPresent').value,
                improvements: document.getElementById('feedbackImprovements').value,
                nextClassAdjustments: document.getElementById('feedbackImprovements').value
            };
            
            fetch('/api/lesson-feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Feedback registrado com sucesso!');
                    closeModal('lessonFeedbackModal');
                } else {
                    alert('Erro ao registrar feedback: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            });
        });
        
        // ==========================================
        // STUDENTS MANAGEMENT FUNCTIONS
        // ==========================================
        
        // ==========================================
        // SISTEMA DE ASSOCIA√á√ïES HIER√ÅRQUICAS
        // ==========================================
        
        async function loadStudentWithAssociations(studentId) {
            console.log('üîÑ Carregando aluno com associa√ß√µes:', studentId);
            
            try {
                // Buscar dados do aluno, matr√≠culas e assinaturas em paralelo
                const [studentResponse, enrollmentsResponse, subscriptionsResponse] = await Promise.all([
                    fetch(`/api/students/${studentId}`),
                    fetch(`/api/students/${studentId}/enrollments`),
                    fetch(`/api/students/${studentId}/subscriptions`)
                ]);
                
                const studentData = await studentResponse.json();
                const enrollmentsData = await enrollmentsResponse.json();
                const subscriptionsData = await subscriptionsResponse.json();
                
                if (!studentData.success) {
                    throw new Error(studentData.message || 'Erro ao carregar dados do aluno');
                }
                
                // Buscar dados complementares
                const [classesResponse, coursesResponse, plansResponse] = await Promise.all([
                    fetch('/api/classes'),
                    fetch('/api/courses'),
                    fetch('/api/billing-plans')
                ]);
                
                const classesData = await classesResponse.json();
                const coursesData = await coursesResponse.json();
                const plansData = await plansResponse.json();
                
                // Processar associa√ß√µes
                const associations = processStudentAssociations(
                    studentData.data,
                    enrollmentsData.success ? enrollmentsData.data : [],
                    subscriptionsData.success ? subscriptionsData.data : [],
                    classesData.success ? classesData.data : [],
                    coursesData.success ? coursesData.data : [],
                    plansData.success ? plansData.data : []
                );
                
                console.log('‚úÖ Associa√ß√µes processadas:', associations);
                
                return {
                    student: studentData.data,
                    associations: associations
                };
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar aluno com associa√ß√µes:', error);
                return null;
            }
        }
        
        function processStudentAssociations(student, enrollments, subscriptions, allClasses, allCourses, allPlans) {
            console.log('üîÑ Processando associa√ß√µes do aluno...');
            
            const associations = {
                plans: [],
                courses: [],
                classes: [],
                hierarchy: []
            };
            
            // Processar assinaturas de planos
            subscriptions.forEach(subscription => {
                if (subscription.plan || subscription.billingPlan) {
                    const plan = subscription.plan || subscription.billingPlan;
                    associations.plans.push({
                        subscription: subscription,
                        plan: plan
                    });
                }
            });
            
            // Processar matr√≠culas
            enrollments.forEach(enrollment => {
                if (enrollment.course) {
                    associations.courses.push({
                        enrollment: enrollment,
                        course: enrollment.course
                    });
                }
                
                if (enrollment.class) {
                    associations.classes.push({
                        enrollment: enrollment,
                        class: enrollment.class
                    });
                }
            });
            
            // Criar hierarquia
            associations.plans.forEach(planAssoc => {
                const planHierarchy = {
                    plan: planAssoc.plan,
                    subscription: planAssoc.subscription,
                    courses: [],
                    directClasses: []
                };
                
                // Encontrar cursos relacionados ao plano
                associations.courses.forEach(courseAssoc => {
                    const course = courseAssoc.course;
                    if (course.category === planAssoc.plan.category || 
                        course.level === planAssoc.plan.level ||
                        course.planId === planAssoc.plan.id ||
                        course.id === planAssoc.plan.courseId) {
                        
                        const courseInPlan = {
                            course: course,
                            enrollment: courseAssoc.enrollment,
                            classes: []
                        };
                        
                        // Encontrar turmas do curso
                        associations.classes.forEach(classAssoc => {
                            if (classAssoc.class.courseId === course.id) {
                                courseInPlan.classes.push({
                                    class: classAssoc.class,
                                    enrollment: classAssoc.enrollment
                                });
                            }
                        });
                        
                        planHierarchy.courses.push(courseInPlan);
                    }
                });
                
                // Verificar se o plano tem um courseId direto que ainda n√£o foi adicionado
                if (planAssoc.plan.courseId && allCourses && allCourses.length > 0) {
                    const planCourse = allCourses.find(course => course.id === planAssoc.plan.courseId);
                    if (planCourse) {
                        // Verificar se o curso j√° foi adicionado
                        const courseAlreadyAdded = planHierarchy.courses.some(courseInPlan => 
                            courseInPlan.course.id === planCourse.id
                        );
                        
                        if (!courseAlreadyAdded) {
                            console.log('üéì Adicionando curso direto do plano:', planCourse.name);
                            const courseInPlan = {
                                course: planCourse,
                                enrollment: null, // Sem matr√≠cula ainda
                                classes: []
                            };
                            
                            // Encontrar turmas do curso
                            associations.classes.forEach(classAssoc => {
                                if (classAssoc.class.courseId === planCourse.id) {
                                    courseInPlan.classes.push({
                                        class: classAssoc.class,
                                        enrollment: classAssoc.enrollment
                                    });
                                }
                            });
                            
                            planHierarchy.courses.push(courseInPlan);
                        }
                    }
                }
                
                // Encontrar turmas diretas do plano (sem curso)
                associations.classes.forEach(classAssoc => {
                    const isInCourse = planHierarchy.courses.some(courseInPlan => 
                        courseInPlan.classes.some(c => c.class.id === classAssoc.class.id)
                    );
                    
                    if (!isInCourse && (
                        classAssoc.class.category === planAssoc.plan.category || 
                        classAssoc.class.level === planAssoc.plan.level ||
                        classAssoc.class.planId === planAssoc.plan.id
                    )) {
                        planHierarchy.directClasses.push({
                            class: classAssoc.class,
                            enrollment: classAssoc.enrollment
                        });
                    }
                });
                
                associations.hierarchy.push(planHierarchy);
            });
            
            // Se n√£o h√° planos, criar uma estrutura b√°sica
            if (associations.hierarchy.length === 0 && (associations.courses.length > 0 || associations.classes.length > 0)) {
                associations.hierarchy.push({
                    plan: { name: 'Sem Plano Definido', category: 'Geral' },
                    subscription: null,
                    courses: associations.courses.map(courseAssoc => ({
                        course: courseAssoc.course,
                        enrollment: courseAssoc.enrollment,
                        classes: associations.classes.filter(classAssoc => 
                            classAssoc.class.courseId === courseAssoc.course.id
                        )
                    })),
                    directClasses: associations.classes.filter(classAssoc => 
                        !associations.courses.some(courseAssoc => 
                            courseAssoc.course.id === classAssoc.class.courseId
                        )
                    )
                });
            }
            
            console.log('‚úÖ Associa√ß√µes processadas:', associations);
            return associations;
        }
        
        function renderStudentClassesWithHierarchy(associations) {
            console.log('üé® Renderizando turmas com hierarquia...');
            
            const classesTab = document.getElementById('student-classes-content');
            if (!classesTab) {
                console.error('‚ùå Elemento student-classes-content n√£o encontrado');
                return;
            }
            
            if (!associations || associations.hierarchy.length === 0) {
                classesTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
                        <p>Nenhuma turma encontrada para este aluno</p>
                        <button onclick="loadStudentClassesTab()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üîÑ Recarregar
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 1.5rem; padding: 1rem;">';
            
            associations.hierarchy.forEach((planHierarchy, planIndex) => {
                const plan = planHierarchy.plan;
                const subscription = planHierarchy.subscription;
                
                // Contar total de turmas neste plano
                const totalClasses = planHierarchy.courses.reduce((total, course) => 
                    total + course.classes.length, 0
                ) + planHierarchy.directClasses.length;
                
                html += `
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05)); border: 1px solid #10B981; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(16, 185, 129, 0.3);">
                            <div>
                                <h4 style="color: #10B981; margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                                    üíé ${plan.name}
                                </h4>
                                <p style="color: #94A3B8; margin: 0.25rem 0; font-size: 0.9rem;">
                                    ${plan.price ? `R$ ${parseFloat(plan.price).toFixed(2)}/m√™s` : 'Pre√ßo n√£o definido'} ‚Ä¢ 
                                    ${plan.category || 'Categoria n√£o definida'} ‚Ä¢ 
                                    ${subscription ? subscription.status : 'Status n√£o definido'}
                                </p>
                            </div>
                            <div style="text-align: right; color: #10B981; font-size: 0.8rem;">
                                <div>${planHierarchy.courses.length} curso(s)</div>
                                <div>${totalClasses} turma(s)</div>
                            </div>
                        </div>
                `;
                
                // Renderizar cursos e suas turmas
                planHierarchy.courses.forEach(courseInPlan => {
                    const course = courseInPlan.course;
                    html += `
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; border-radius: 8px; padding: 1rem; margin: 0.5rem 0;">
                            <h5 style="color: #3B82F6; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                üìö ${course.name}
                            </h5>
                            <p style="color: #E5E7EB; margin: 0 0 1rem 0; font-size: 0.9rem;">${course.description || ''}</p>
                    `;
                    
                    // Renderizar turmas do curso
                    courseInPlan.classes.forEach(classInCourse => {
                        const classData = classInCourse.class;
                        html += `
                            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid #475569; border-radius: 6px; padding: 0.75rem; margin: 0.25rem 0; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #E5E7EB; font-weight: 500;">üïê ${classData.name}</div>
                                    <div style="color: #9CA3AF; font-size: 0.8rem; margin-top: 0.25rem;">
                                        üìÖ ${classData.schedule || 'Hor√°rio flex√≠vel'}
                                        ${classData.capacity ? ` ‚Ä¢ üë• ${classData.capacity} vagas` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="quickCheckinToClass('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #10B981; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        ‚úÖ Check-in
                                    </button>
                                    <button onclick="viewClassDetails('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        üëÅÔ∏è Detalhes
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                });
                
                // Renderizar turmas diretas do plano
                if (planHierarchy.directClasses.length > 0) {
                    html += `
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #F59E0B; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                            <h5 style="color: #F59E0B; margin: 0 0 0.75rem 0;">üéØ Turmas Diretas do Plano</h5>
                    `;
                    
                    planHierarchy.directClasses.forEach(directClass => {
                        const classData = directClass.class;
                        html += `
                            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid #475569; border-radius: 6px; padding: 0.75rem; margin: 0.25rem 0; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #E5E7EB; font-weight: 500;">üïê ${classData.name}</div>
                                    <div style="color: #9CA3AF; font-size: 0.8rem; margin-top: 0.25rem;">
                                        üìÖ ${classData.schedule || 'Hor√°rio flex√≠vel'}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="quickCheckinToClass('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #10B981; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        ‚úÖ Check-in
                                    </button>
                                    <button onclick="viewClassDetails('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        üëÅÔ∏è Detalhes
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
                
                html += `</div>`;
            });
            
            html += '</div>';
            classesTab.innerHTML = html;
        }
        
        function renderStudentCoursesWithHierarchy_OLD(associations) {
            console.log('üé® [OLD] Renderizando cursos com hierarquia...');
            console.log('üîç [OLD] Debug associations recebidas:', associations);
            
            const coursesTab = document.getElementById('student-courses-content');
            if (!coursesTab) {
                console.error('‚ùå [OLD] Elemento student-courses-content n√£o encontrado');
                return;
            }
            
            if (!associations || associations.hierarchy.length === 0) {
                coursesTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìö</div>
                        <p>Nenhum curso encontrado para este aluno</p>
                        <button onclick="loadStudentCoursesTab()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üîÑ Recarregar
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 1.5rem; padding: 1rem;">';
            
            associations.hierarchy.forEach((planHierarchy, planIndex) => {
                const plan = planHierarchy.plan;
                const subscription = planHierarchy.subscription;
                
                if (planHierarchy.courses.length === 0) return;
                
                html += `
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.05)); border: 1px solid #3B82F6; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(59, 130, 246, 0.3);">
                            <div>
                                <h4 style="color: #3B82F6; margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                                    üíé ${plan.name}
                                </h4>
                                <p style="color: #94A3B8; margin: 0.25rem 0; font-size: 0.9rem;">
                                    ${plan.price ? `R$ ${parseFloat(plan.price).toFixed(2)}/m√™s` : 'Pre√ßo n√£o definido'} ‚Ä¢ 
                                    ${plan.category || 'Categoria n√£o definida'}
                                </p>
                            </div>
                            <div style="text-align: right; color: #3B82F6; font-size: 0.8rem;">
                                <div>${planHierarchy.courses.length} curso(s)</div>
                            </div>
                        </div>
                `;
                
                // Renderizar cursos
                planHierarchy.courses.forEach(courseInPlan => {
                    const course = courseInPlan.course;
                    const enrollment = courseInPlan.enrollment;
                    
                    html += `
                        <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid #475569; border-radius: 8px; padding: 1rem; margin: 0.5rem 0; display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <h5 style="color: #E5E7EB; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    üìö ${course.name}
                                </h5>
                                <p style="color: #9CA3AF; margin: 0 0 0.5rem 0; font-size: 0.85rem;">${course.description || ''}</p>
                                <div style="color: #94A3B8; font-size: 0.75rem;">
                                    Status: ${enrollment.status} ‚Ä¢ 
                                    Matr√≠cula: ${new Date(enrollment.enrollmentDate).toLocaleDateString('pt-BR')} ‚Ä¢
                                    ${courseInPlan.classes.length} turma(s)
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-left: 1rem;">
                                <button onclick="viewCourseProgress('${course.id}')" style="padding: 0.25rem 0.5rem; background: #10B981; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; white-space: nowrap;">
                                    üìä Progresso
                                </button>
                                <button onclick="viewCourseDetails('${course.id}')" style="padding: 0.25rem 0.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; white-space: nowrap;">
                                    üëÅÔ∏è Detalhes
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            html += '</div>';
            coursesTab.innerHTML = html;
        }
        
        // Fun√ß√µes auxiliares para os bot√µes de a√ß√£o
        function quickCheckinToClass(classId) {
            console.log('‚ö° Check-in r√°pido para turma:', classId);
            alert('üöß Funcionalidade em desenvolvimento\n\n‚úÖ Check-in para turma: ' + classId);
        }
        
        function viewClassDetails(classId) {
            console.log('üëÅÔ∏è Visualizar detalhes da turma:', classId);
            alert('üöß Funcionalidade em desenvolvimento\n\nüëÅÔ∏è Detalhes da turma: ' + classId);
        }
        
        function viewCourseProgress(courseId) {
            console.log('üìä Visualizar progresso do curso:', courseId);
            alert('üöß Funcionalidade em desenvolvimento\n\nüìä Progresso do curso: ' + courseId);
        }
        
        function viewCourseDetails(courseId) {
            console.log('üëÅÔ∏è Visualizar detalhes do curso:', courseId);
            alert('üöß Funcionalidade em desenvolvimento\n\nüëÅÔ∏è Detalhes do curso: ' + courseId);
        }

        // ==========================================
        
        // Global students data storage
        let allStudents = [];
        let filteredStudents = [];
        let currentView = 'table'; // 'table' or 'grid'
        
        // Make allStudents globally accessible
        window.allStudents = allStudents;

        // Generate simple matricula
        function generateMatricula(studentId, index) {
            // Simple format: just the index number (1, 2, 3, etc.)
            return index ? index.toString() : '1';
        }

        // Enhanced student loading with matricula generation
        async function loadStudents() {
            console.log('üë• Carregando estudantes...');
            
            // Show loading state (safe version)
            try {
                showStudentsLoadingState();
            } catch (e) {
                console.log('‚ö†Ô∏è showStudentsLoadingState failed:', e);
            }
            
            try {
                const response = await fetch('/api/students');
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log(`‚úÖ ${data.data.length} estudantes carregados`);
                    
                    // Use students data directly (API already provides matricula)
                    allStudents = data.data;
                    window.allStudents = allStudents; // Keep window reference updated
                    filteredStudents = [...allStudents];
                    updateStudentsStats();
                    
                    // Use the improved complete loading function from students.js
                    if (window.loadAndRenderStudents) {
                        console.log('üöÄ Using complete loadAndRenderStudents from students.js');
                        window.loadAndRenderStudents();
                    } else if (window.renderStudentsTable && window.renderStudentsGrid) {
                        console.log('üé® Using improved rendering functions from students.js');
                        window.renderStudentsTable(allStudents);
                        window.renderStudentsGrid(allStudents);
                    } else {
                        console.log('‚ö†Ô∏è Falling back to legacy updateStudentsDisplay');
                        updateStudentsDisplay();
                    }
                    
                    // Event delegation is now handled within updateStudentsDisplay
                } else {
                    console.error('‚ùå Erro ao carregar estudantes:', data.message || 'Resposta sem dados');
                    console.error('‚ùå Resposta completa:', data);
                    allStudents = [];
                    window.allStudents = allStudents; // Keep window reference updated
                    filteredStudents = [];
                    showStudentsEmptyState();
                }
            } catch (error) {
                console.error('‚ùå Erro de conex√£o ao carregar estudantes:', error);
                allStudents = [];
                window.allStudents = allStudents; // Keep window reference updated
                filteredStudents = [];
                showStudentsEmptyState();
            }
            
            // Event delegation is handled within updateStudentsDisplay when needed
        }

        // Switch between table and grid view
        function switchView(viewType) {
            currentView = viewType;
            
            // Update button states
            document.getElementById('tableViewBtn').classList.toggle('active', viewType === 'table');
            document.getElementById('gridViewBtn').classList.toggle('active', viewType === 'grid');
            
            // Show/hide views
            document.getElementById('studentsTableView').style.display = viewType === 'table' ? 'block' : 'none';
            document.getElementById('studentsGrid').style.display = viewType === 'grid' ? 'grid' : 'none';
            
            // Update display
            updateStudentsDisplay();
        }

        // Enhanced search that works with CPF, name, matricula and email
        function filterStudentsSimple() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredStudents = [...allStudents];
            } else {
                filteredStudents = allStudents.filter(student => {
                    const user = student.user || {};
                    const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                    const email = (user.email || '').toLowerCase();
                    const cpf = (user.cpf || '').replace(/\D/g, ''); // Remove non-digits
                    const matricula = (student.matricula || '').toLowerCase();
                    const searchCpf = searchTerm.replace(/\D/g, ''); // Remove non-digits from search
                    
                    return (
                        fullName.includes(searchTerm) ||
                        email.includes(searchTerm) ||
                        matricula.includes(searchTerm) ||
                        (searchCpf && cpf.includes(searchCpf))
                    );
                });
            }
            
            updateStudentsDisplay();
        }

        // Update students display based on current view
        function updateStudentsDisplay() {
            if (currentView === 'table') {
                updateStudentsTable();
                // Setup event delegation only if needed (check done inside function)
                setupStudentTableEventDelegation();
            } else {
                updateStudentsGrid();
            }
        }

        // ========================================
        // STUDENT TABLE EVENT DELEGATION SYSTEM
        // ========================================
        
        // Set up permanent event delegation for student table
        function setupStudentTableEventDelegation() {
            const tableBody = document.getElementById('studentsTableBody');
            if (!tableBody) {
                console.warn('üö® Student table body not found for event delegation setup');
                return;
            }
            
            // Check if already set up to avoid duplicates
            if (tableBody.hasAttribute('data-delegation-setup')) {
                return; // Already set up, skip
            }
            
            // Remove existing listeners to prevent duplicates
            tableBody.removeEventListener('click', handleStudentTableClick);
            tableBody.removeEventListener('dblclick', handleStudentTableDoubleClick);
            
            // Add event listeners with delegation
            tableBody.addEventListener('click', handleStudentTableClick);
            tableBody.addEventListener('dblclick', handleStudentTableDoubleClick);
            
            // Mark as set up
            tableBody.setAttribute('data-delegation-setup', 'true');
            
            console.log('‚úÖ Student table event delegation setup complete');
        }
        
        // Handle all clicks in student table
        function handleStudentTableClick(event) {
            const target = event.target;
            const studentRow = target.closest('tr.student-table-row');
            
            if (!studentRow) return;
            
            // Handle action buttons
            if (target.dataset.action === 'checkin') {
                event.stopPropagation();
                quickCheckinFixed(target.dataset.studentId);
                return;
            }
            
            if (target.dataset.action === 'edit') {
                event.stopPropagation();
                openStudentEditPage(target.dataset.studentId);
                return;
            }
            
            // Handle row click (but not on action buttons)
            if (!target.closest('.actions-cell')) {
                // Single click on row - could add selection here if needed
                studentRow.classList.add('row-selected');
                setTimeout(() => {
                    studentRow.classList.remove('row-selected');
                }, 200);
            }
        }
        
        // Handle double-clicks in student table
        function handleStudentTableDoubleClick(event) {
            const target = event.target;
            const studentRow = target.closest('tr.student-table-row');
            
            if (!studentRow) return;
            
            // Don't trigger on action buttons
            if (target.closest('.actions-cell')) return;
            
            event.preventDefault();
            event.stopPropagation();
            
            const studentId = studentRow.dataset.studentId;
            if (studentId) {
                console.log('üñ±Ô∏è Double-click detected for student:', studentId);
                openStudentEditPage(studentId);
            }
        }
        
        // Fixed quick check-in function (prevents conflicts)
        function quickCheckinFixed(studentId) {
            if (!studentId) {
                console.error('‚ùå Student ID not provided for check-in');
                return;
            }
            
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                alert('‚ùå Aluno n√£o encontrado!');
                return;
            }
            
            const user = student.user || {};
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
            const matricula = student.matricula || generateMatricula(student.id, 1);
            
            // Show confirmation
            const confirmed = confirm(`‚úÖ Confirmar check-in para:\n\nüìã Matr√≠cula: ${matricula}\nüë§ Nome: ${fullName}\n\nProsseguir?`);
            
            if (confirmed) {
                console.log('‚úÖ Quick check-in confirmed for:', fullName);
                alert(`‚úÖ Check-in realizado com sucesso!\n\nüë§ ${fullName}\nüìã ${matricula}\n‚è∞ ${new Date().toLocaleTimeString()}`);
                
                // Here you would implement the actual check-in API call
                // For now, just show success feedback
            }
        }

        // Update table view with event delegation
        function updateStudentsTable() {
            const tableBody = document.getElementById('studentsTableBody');
            const tableView = document.getElementById('studentsTableView');
            const loadingState = document.getElementById('studentsLoadingState');
            const emptyState = document.getElementById('studentsEmptyState');
            
            if (filteredStudents.length === 0) {
                tableView.style.display = 'none';
                loadingState.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            loadingState.style.display = 'none';
            emptyState.style.display = 'none';
            tableView.style.display = 'block';
            
            tableBody.innerHTML = filteredStudents.map(student => {
                const user = student.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                const email = user.email || 'N/A';
                const cpf = user.cpf || 'N/A';
                const formattedCpf = cpf !== 'N/A' ? formatCPF(cpf) : 'N/A';
                const category = student.category || 'ADULT';
                const status = student.isActive ? 'Ativo' : 'Inativo';
                const statusClass = student.isActive ? 'success' : 'inactive';
                const matricula = student.matricula || generateMatricula(student.id, 1);
                const financialResponsible = student.financialResponsible;
                const responsibleDisplay = financialResponsible 
                    ? `<div class="responsible-name">${financialResponsible.name}</div><div class="responsible-type">${financialResponsible.relationshipType || 'N√£o informado'}</div>`
                    : '<span style="color: #94A3B8;">Pr√≥prio aluno</span>';
                
                return `
                    <tr class="student-table-row" data-student-id="${student.id}" style="cursor: pointer; position: relative;">
                        <td>
                            <span class="student-matricula">${matricula}</span>
                        </td>
                        <td class="student-name-cell">
                            <div class="student-name">${fullName}</div>
                            <div class="student-email">${email}</div>
                        </td>
                        <td>
                            <span class="student-cpf">${formattedCpf}</span>
                        </td>
                        <td>${category}</td>
                        <td class="responsible-cell">
                            ${responsibleDisplay}
                        </td>
                        <td>
                            <span class="badge ${statusClass}">${status}</span>
                        </td>
                        <td class="actions-cell">
                            <button class="action-btn checkin" data-action="checkin" data-student-id="${student.id}" title="Check-in R√°pido">
                                ‚úÖ Check-in
                            </button>
                            <button class="action-btn edit" data-action="edit" data-student-id="${student.id}" title="Editar Aluno">
                                ‚úèÔ∏è Editar
                            </button>
                            <div class="table-click-hint" style="position: absolute; bottom: 4px; right: 4px; font-size: 0.65rem; color: #10B981; opacity: 0; transition: opacity 0.3s ease; background: rgba(16, 185, 129, 0.1); padding: 0.2rem 0.4rem; border-radius: 4px; border: 1px solid rgba(16, 185, 129, 0.3); pointer-events: none; white-space: nowrap;">
                                üìù Editar aluno
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Setup event delegation after updating table
            setTimeout(() => {
                setupStudentTableEventDelegation();
            }, 50);
        }

        // Format CPF for display
        function formatCPF(cpf) {
            if (!cpf || cpf === 'N/A') return 'N/A';
            
            // Remove all non-digits
            const cleanCpf = cpf.replace(/\D/g, '');
            
            // Format as XXX.XXX.XXX-XX
            if (cleanCpf.length === 11) {
                return cleanCpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }
            
            return cpf; // Return original if not 11 digits
        }

        // Quick check-in function - COMMENTED OUT TO PREVENT CONFLICTS
        // Use quickCheckinFixed instead
        function quickCheckin_DEPRECATED(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                alert('Aluno n√£o encontrado!');
                return;
            }
            
            const user = student.user || {};
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
            const matricula = student.matricula || generateMatricula(student.id, 1);
            
            // Show confirmation
            const confirmed = confirm(`Confirmar check-in para:\n\nMatr√≠cula: ${matricula}\nNome: ${fullName}\n\nProsseguir?`);
            
            if (confirmed) {
                // Here you would call the check-in API
                console.log('üéØ Check-in confirmado para:', fullName, `(${matricula})`);
                
                // Show success feedback
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Feito!';
                btn.style.background = '#10B981';
                btn.style.color = 'white';
                btn.disabled = true;
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    btn.style.color = '#10B981';
                    btn.disabled = false;
                }, 2000);
                
                // You can add actual API call here:
                // performCheckin(studentId);
            }
        }

        // Legacy function for grid view compatibility
        function filterStudents() {
            filterStudentsSimple();
        }

        // ==========================================
        // QUICK CHECK-IN FUNCTIONS
        // ==========================================

        let checkinResults = [];

        // Search for check-in with smart matching
        function searchForCheckin() {
            const searchTerm = document.getElementById('checkinSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                checkinResults = [];
                updateCheckinTable();
                return;
            }

            // Minimum 2 characters to search
            if (searchTerm.length < 2) {
                checkinResults = [];
                updateCheckinTable();
                return;
            }

            checkinResults = allStudents.filter(student => {
                const user = student.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                const email = (user.email || '').toLowerCase();
                const cpf = (user.cpf || '').replace(/\D/g, '');
                const matricula = (student.matricula || '').toLowerCase();
                const searchCpf = searchTerm.replace(/\D/g, '');
                
                return (
                    fullName.includes(searchTerm) ||
                    email.includes(searchTerm) ||
                    matricula.includes(searchTerm) ||
                    (searchCpf && cpf.includes(searchCpf))
                );
            }).slice(0, 10); // Limit to 10 results for performance

            updateCheckinTable();
        }

        // Handle Enter key for instant check-in
        function handleCheckinEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                
                // If only one result, do instant check-in
                if (checkinResults.length === 1) {
                    quickCheckin(checkinResults[0].id);
                    clearCheckinSearch();
                }
            }
        }

        // Clear check-in search
        function clearCheckinSearch() {
            document.getElementById('checkinSearch').value = '';
            checkinResults = [];
            updateCheckinTable();
            document.getElementById('checkinSearch').focus();
        }

        // Update check-in table
        function updateCheckinTable() {
            const tableBody = document.getElementById('checkinTableBody');
            const resultsCount = document.getElementById('checkinResultsCount');
            
            resultsCount.textContent = checkinResults.length;

            if (checkinResults.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #94A3B8; padding: 2rem;">
                            ${document.getElementById('checkinSearch').value.trim() ? 'Nenhum aluno encontrado' : 'Digite acima para buscar alunos e fazer check-in'}
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = checkinResults.map(student => {
                const user = student.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                const cpf = user.cpf || 'N/A';
                const formattedCpf = cpf !== 'N/A' ? formatCPF(cpf) : 'N/A';
                const matricula = student.matricula || generateMatricula(student.id, 1);
                
                return `
                    <tr style="background: ${checkinResults.length === 1 ? 'rgba(59, 130, 246, 0.1)' : 'transparent'};">
                        <td>
                            <span class="student-matricula">${matricula}</span>
                        </td>
                        <td class="student-name-cell">
                            <div class="student-name">${fullName}</div>
                        </td>
                        <td>
                            <span class="student-cpf">${formattedCpf}</span>
                        </td>
                        <td>
                            <button class="action-btn checkin" 
                                    onclick="quickCheckin('${student.id}')" 
                                    title="Check-in R√°pido"
                                    style="font-weight: 600;">
                                ‚ö° CHECK-IN
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // DUPLICATE FUNCTION - This should be removed and use quickCheckinFixed instead
        // Simple quick check-in
        function quickCheckin(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                alert('‚ùå Aluno n√£o encontrado!');
                return;
            }
            
            const user = student.user || {};
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
            const matricula = student.matricula || generateMatricula(student.id, 1);
            
            // Simple confirmation
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            const confirmed = confirm(`Confirmar check-in?\n\n${fullName} (${matricula})\n${timeString}`);
            
            if (confirmed) {
                console.log('‚úÖ Check-in confirmado:', fullName, matricula, timeString);
                
                // Simple visual feedback
                const btn = event.target;
                btn.innerHTML = '‚úÖ Feito!';
                btn.style.background = '#10B981';
                btn.style.color = 'white';
                btn.disabled = true;
                
                // Auto-clear search after check-in
                setTimeout(() => {
                    clearCheckinSearch();
                    showToast(`‚úÖ Check-in: ${fullName} (${matricula})`, 'success');
                }, 1000);
                
                // Here you would call the actual check-in API:
                // performActualCheckin(studentId, now);
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                max-width: 400px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                ${type === 'success' ? 'background: linear-gradient(135deg, #10B981, #059669);' : ''}
                ${type === 'error' ? 'background: linear-gradient(135deg, #EF4444, #DC2626);' : ''}
                ${type === 'info' ? 'background: linear-gradient(135deg, #3B82F6, #2563EB);' : ''}
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }
        
        function showStudentsLoadingState() {
            document.getElementById('studentsLoadingState').style.display = 'block';
            document.getElementById('studentsGrid').style.display = 'none';
            document.getElementById('studentsEmptyState').style.display = 'none';
        }
        
        function showStudentsEmptyState() {
            document.getElementById('studentsLoadingState').style.display = 'none';
            document.getElementById('studentsGrid').style.display = 'none';
            document.getElementById('studentsEmptyState').style.display = 'block';
        }
        
        function updateStudentsStats() {
            const total = allStudents.length;
            const active = allStudents.filter(s => s.isActive).length;
            const avgAttendance = allStudents.length > 0 
                ? Math.round(allStudents.reduce((sum, s) => sum + (s.attendanceRate || 0), 0) / allStudents.length)
                : 0;
            const thisMonth = allStudents.filter(s => {
                const enrollDate = new Date(s.enrollmentDate);
                const now = new Date();
                return enrollDate.getMonth() === now.getMonth() && enrollDate.getFullYear() === now.getFullYear();
            }).length;
            
            document.getElementById('totalStudents').textContent = total;
            document.getElementById('activeStudents').textContent = active;
            document.getElementById('avgAttendance').textContent = `${avgAttendance}%`;
            document.getElementById('newThisMonth').textContent = thisMonth;
        }
        
        function updateStudentsGrid() {
            const grid = document.getElementById('studentsGrid');
            const loadingState = document.getElementById('studentsLoadingState');
            const emptyState = document.getElementById('studentsEmptyState');
            
            if (filteredStudents.length === 0) {
                grid.style.display = 'none';
                loadingState.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            loadingState.style.display = 'none';
            emptyState.style.display = 'none';
            grid.style.display = 'grid';
            
            grid.innerHTML = filteredStudents.map(student => {
                const user = student.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                const email = user.email || 'N/A';
                const phone = user.phone || 'N/A';
                const category = student.category || 'ADULT';
                const status = student.isActive ? 'Ativo' : 'Inativo';
                const statusClass = student.isActive ? 'status-active' : 'status-inactive';
                const matricula = student.matricula || `KMA${String(student.id).padStart(4, '0')}`;
                const attendanceRate = student.attendanceRate || 0;
                const avatar = fullName ? fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';
                
                return `
                    <div class="student-card" onclick="openStudentEditPage('${student.id}')" style="cursor: pointer;">
                        <div class="student-status">
                            <span class="status-badge ${statusClass}">${status}</span>
                        </div>
                        
                        <div class="student-card-header">
                            <div style="display: flex; align-items: center;">
                                <div class="student-avatar">${avatar}</div>
                                <div class="student-info">
                                    <div class="student-name">${fullName}</div>
                                    <div class="student-matricula">üìã ${matricula}</div>
                                    <div class="student-email">üìß ${email}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="student-stats">
                            <div class="student-stat">
                                <span class="student-stat-value">${attendanceRate}%</span>
                                <div class="student-stat-label">Frequ√™ncia</div>
                            </div>
                            <div class="student-stat">
                                <span class="student-stat-value">${category}</span>
                                <div class="student-stat-label">Categoria</div>
                            </div>
                            <div class="student-stat">
                                <span class="student-stat-value">${phone !== 'N/A' ? 'üì±' : '‚ùå'}</span>
                                <div class="student-stat-label">Contato</div>
                            </div>
                        </div>
                        
                        <div class="student-actions" onclick="event.stopPropagation()">
                            <button class="btn-student btn-student-primary" onclick="openStudentEditPage('${student.id}')">
                                ‚úèÔ∏è Editar Dados
                            </button>
                        </div>
                        
                        <!-- Hint de clique direto -->
                        <div class="click-hint" style="position: absolute; bottom: 8px; right: 12px; font-size: 0.7rem; color: #10B981; opacity: 0; transition: opacity 0.3s ease; background: rgba(16, 185, 129, 0.1); padding: 0.25rem 0.5rem; border-radius: 6px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            üìù Editar aluno
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredStudents = allStudents.filter(student => {
                const user = student.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                const email = (user.email || '').toLowerCase();
                const matricula = (student.matricula || `KMA${String(student.id).padStart(4, '0')}`).toLowerCase();
                
                // Search filter
                const matchesSearch = !searchTerm || 
                    fullName.includes(searchTerm) || 
                    email.includes(searchTerm) || 
                    matricula.includes(searchTerm);
                
                // Category filter
                const matchesCategory = !categoryFilter || student.category === categoryFilter;
                
                // Status filter
                const matchesStatus = !statusFilter || String(student.isActive) === statusFilter;
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
            
            updateStudentsGrid();
        }
        
        // Modern unified view/edit functions
        async function openStudentDetails(studentId) {
            console.log('üëÅÔ∏è Redirecionando detalhes para edi√ß√£o:', studentId);
            openStudentEditPage(studentId);
        }
        
        async function openStudentEdit(studentId) {
            console.log('‚úèÔ∏è Editando estudante:', studentId);
            openStudentEditPage(studentId);
        }
        
        async function viewStudent(studentId) {
            openStudentEditPage(studentId);
        }
        
        async function editStudent(studentId) {
            openStudentEditPage(studentId);
        }
        
        async function openStudentModal(studentId, mode = 'edit') {
            try {
                // Fetch student data
                const response = await fetch(`/api/students`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Erro ao carregar dados do estudante');
                }
                
                // Find the specific student
                const student = data.data.find(s => s.id === studentId);
                if (!student) {
                    throw new Error('Estudante n√£o encontrado');
                }
                
                // Set modal title and mode
                const isViewMode = mode === 'view';
                document.getElementById('studentModalTitle').textContent = 
                    isViewMode ? 'Visualizar Aluno' : 'Editar Aluno';
                
                // Show/hide save button
                const saveBtn = document.getElementById('saveStudentBtn');
                saveBtn.style.display = isViewMode ? 'none' : 'block';
                
                // Populate form with student data
                populateStudentForm(student, isViewMode);
                
                // Show modal
                document.getElementById('studentModal').classList.add('active');
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir modal do estudante:', error);
                alert(`Erro: ${error.message}`);
            }
        }
        
        function populateStudentForm(student, readonly = false) {
            const user = student.user || {};
            
            // Set form values
            document.getElementById('studentId').value = student.id || '';
            document.getElementById('userId').value = student.userId || '';
            document.getElementById('firstName').value = user.firstName || '';
            document.getElementById('lastName').value = user.lastName || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('cpf').value = user.cpf || '';
            document.getElementById('category').value = student.category || 'ADULT';
            document.getElementById('gender').value = student.gender || 'MASCULINO';
            document.getElementById('physicalCondition').value = student.physicalCondition || 'INICIANTE';
            document.getElementById('medicalConditions').value = student.medicalConditions || '';
            document.getElementById('emergencyContact').value = student.emergencyContact || '';
            document.getElementById('totalXP').value = student.totalXP || 0;
            document.getElementById('globalLevel').value = student.globalLevel || 1;
            document.getElementById('currentStreak').value = student.currentStreak || 0;
            
            // Format dates
            if (student.enrollmentDate) {
                const enrollDate = new Date(student.enrollmentDate).toISOString().split('T')[0];
                document.getElementById('enrollmentDate').value = enrollDate;
            }
            
            if (student.lastCheckinDate) {
                const checkinDate = new Date(student.lastCheckinDate).toISOString().slice(0, 16);
                document.getElementById('lastCheckinDate').value = checkinDate;
            }
            
            // Handle special needs (array)
            const specialNeedsSelect = document.getElementById('specialNeeds');
            if (student.specialNeeds && Array.isArray(student.specialNeeds)) {
                Array.from(specialNeedsSelect.options).forEach(option => {
                    option.selected = student.specialNeeds.includes(option.value);
                });
            }
            
            // Set readonly mode if viewing
            if (readonly) {
                const inputs = document.querySelectorAll('#studentForm input, #studentForm select, #studentForm textarea');
                inputs.forEach(input => {
                    if (!input.hasAttribute('readonly')) {
                        input.setAttribute('readonly', true);
                        input.style.background = 'rgba(255, 255, 255, 0.02)';
                        input.style.color = '#94A3B8';
                        input.style.cursor = 'not-allowed';
                    }
                });
            } else {
                // Remove readonly from editable fields
                const inputs = document.querySelectorAll('#studentForm input:not([name="totalXP"]):not([name="globalLevel"]):not([name="currentStreak"]):not([name="lastCheckinDate"]), #studentForm select:not([multiple]), #studentForm textarea');
                inputs.forEach(input => {
                    input.removeAttribute('readonly');
                    input.style.background = 'rgba(255, 255, 255, 0.05)';
                    input.style.color = '#F8FAFC';
                    input.style.cursor = 'text';
                });
            }
        }
        
        function closeStudentModal() {
            document.getElementById('studentModal').classList.remove('active');
            // Clear form
            document.getElementById('studentForm').reset();
        }
        
        async function saveStudent() {
            const saveBtn = document.getElementById('saveStudentBtn');
            const originalText = saveBtn.innerHTML;
            
            try {
                // Show loading state
                saveBtn.innerHTML = '‚è≥ Salvando...';
                saveBtn.disabled = true;
                
                const studentId = document.getElementById('studentId').value;
                const userId = document.getElementById('userId').value;
                
                if (!studentId || !userId) {
                    throw new Error('ID do estudante n√£o encontrado');
                }
                
                // Collect form data with enhanced validation
                const formData = {
                    // User data (supported by API)
                    firstName: document.getElementById('firstName').value.trim(),
                    lastName: document.getElementById('lastName').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    
                    // Student data (supported by API)
                    category: document.getElementById('category').value,
                    gender: document.getElementById('gender').value,
                    physicalCondition: document.getElementById('physicalCondition').value,
                    emergencyContact: document.getElementById('emergencyContact').value.trim(),
                    medicalConditions: document.getElementById('medicalConditions').value.trim(),
                    isActive: true
                };
                
                // Enhanced validation
                if (!formData.firstName || !formData.lastName || !formData.email) {
                    throw new Error('Nome, sobrenome e email s√£o obrigat√≥rios');
                }
                
                if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
                    throw new Error('Email deve ter um formato v√°lido');
                }
                
                console.log('üì§ Enviando dados do estudante:', formData);
                
                // Update student via API
                const response = await fetch(`/api/students/${studentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || `Erro ${response.status}: ${response.statusText}`);
                }
                
                if (!result.success) {
                    throw new Error(result.message || 'Erro ao atualizar dados');
                }
                
                console.log('‚úÖ Estudante atualizado com sucesso:', result);
                
                // Show success feedback
                saveBtn.innerHTML = '‚úÖ Salvo!';
                saveBtn.style.background = '#10B981';
                
                // Close modal and reload students
                setTimeout(() => {
                    closeStudentModal();
                    loadStudents();
                    showNotification('Dados do aluno atualizados com sucesso! üéâ', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar estudante:', error);
                
                // Show error feedback
                saveBtn.innerHTML = '‚ùå Erro';
                saveBtn.style.background = '#EF4444';
                
                showNotification(`Erro ao salvar: ${error.message}`, 'error');
                
                // Restore button after error
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }, 2000);
            }
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                ${type === 'success' ? 'background: #10B981;' : ''}
                ${type === 'error' ? 'background: #EF4444;' : ''}
                ${type === 'info' ? 'background: #3B82F6;' : ''}
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Function consolidation: All section loading is now handled in the main showSection function above

        // Students data will be loaded when navigating to the students section

        // ==========================================
        // ATTENDANCE CAPTURE FUNCTIONALITY
        // ==========================================

        // Global variables for attendance
        const currentClassId = '2e47c8b1-5d4c-4a9b-8f3e-1b2c3d4e5f60'; // Turma 1
        const currentLessonNumber = 15;
        let selectedStudentId = null;

        // Load attendance list with interactive checkboxes
        async function loadAttendanceList() {
            try {
                document.getElementById('attendanceList').innerHTML = `
                    <div class="loading-message" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                        <span style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;">üìã</span>
                        Carregando lista de presen√ßa...
                    </div>
                `;

                const studentsResponse = await fetch(`/api/students`);
                const studentsResult = await studentsResponse.json();

                const attendanceResponse = await fetch(`/api/classes/${currentClassId}/lessons/${currentLessonNumber}/attendance`);
                const attendanceResult = await attendanceResponse.json();

                if (studentsResult.success && attendanceResult.success) {
                    displayAttendanceList(studentsResult.data, attendanceResult.data);
                    updateAttendanceStats(studentsResult.data, attendanceResult.data);
                } else {
                    throw new Error('Failed to load attendance data');
                }
            } catch (error) {
                console.error('Erro ao carregar lista de presen√ßa:', error);
                document.getElementById('attendanceList').innerHTML = `
                    <div style="text-align: center; color: #EF4444; padding: 2rem;">
                        <span style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;">‚ö†Ô∏è</span>
                        Erro ao carregar lista de presen√ßa
                    </div>
                `;
            }
        }

        // Display attendance list with interactive cards
        function displayAttendanceList(students, attendanceRecords) {
            const attendanceMap = {};
            attendanceRecords.forEach(record => {
                attendanceMap[record.studentId] = record;
            });

            const html = `
                <div class="attendance-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    ${students.map(enrollment => {
                        const student = enrollment?.student;
                        if (!student || !student.id) {
                            console.warn('Invalid student data in enrollment:', enrollment);
                            return '';
                        }
                        const attendance = attendanceMap[student.id];
                        const isPresent = attendance ? attendance.present : false;
                        const isLate = attendance ? attendance.arrived_late : false;
                        const leftEarly = attendance ? attendance.left_early : false;
                        
                        // Safe access to user data
                        const user = student.user || {};
                        const firstName = user.firstName || 'N';
                        const lastName = user.lastName || 'A';
                        const email = user.email || 'sem-email@exemplo.com';
                        const initials = firstName.charAt(0) + lastName.charAt(0);
                        
                        return `
                            <div class="attendance-card" style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #3B82F6, #10B981); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                        ${initials}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: white;">${firstName} ${lastName}</div>
                                        <div style="font-size: 0.875rem; color: #CBD5E1;">${email}</div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" ${isPresent ? 'checked' : ''} 
                                               onchange="toggleAttendance('${student.id}', 'present', this.checked)"
                                               style="width: 18px; height: 18px;">
                                        <span style="color: white;">Presente</span>
                                        ${isPresent ? '<span style="color: #10B981; margin-left: auto;">‚úÖ</span>' : ''}
                                    </label>

                                    ${isPresent ? `
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-left: 1rem;">
                                            <input type="checkbox" ${isLate ? 'checked' : ''} 
                                                   onchange="toggleAttendance('${student.id}', 'arrived_late', this.checked)"
                                                   style="width: 16px; height: 16px;">
                                            <span style="color: #CBD5E1; font-size: 0.875rem;">Chegou atrasado</span>
                                        </label>
                                        
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-left: 1rem;">
                                            <input type="checkbox" ${leftEarly ? 'checked' : ''} 
                                                   onchange="toggleAttendance('${student.id}', 'left_early', this.checked)"
                                                   style="width: 16px; height: 16px;">
                                            <span style="color: #CBD5E1; font-size: 0.875rem;">Saiu mais cedo</span>
                                        </label>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.getElementById('attendanceList').innerHTML = html;
        }

        // Toggle individual attendance
        async function toggleAttendance(studentId, field, value) {
            try {
                const attendanceData = {
                    studentId: studentId,
                    classId: currentClassId,
                    courseId: '750273f9-7508-4fbf-affb-8efe189f2875', // Krav Maga course ID
                    lessonNumber: currentLessonNumber,
                    date: new Date().toISOString()
                };

                if (field === 'present') {
                    attendanceData.present = value;
                    attendanceData.arrived_late = false;
                    attendanceData.left_early = false;
                } else {
                    // Get current attendance status first
                    const currentAttendance = await fetch(`/api/classes/${currentClassId}/lessons/${currentLessonNumber}/attendance`);
                    const currentResult = await currentAttendance.json();
                    const studentAttendance = currentResult.data.find(a => a.studentId === studentId);
                    
                    attendanceData.present = studentAttendance ? studentAttendance.present : true;
                    attendanceData[field] = value;
                }

                const response = await fetch('/api/attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(attendanceData)
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Presen√ßa atualizada:', result.data);
                    showToast('Presen√ßa atualizada com sucesso!');
                    // Reload attendance list after short delay
                    setTimeout(loadAttendanceList, 500);
                } else {
                    throw new Error(result.message || 'Failed to update attendance');
                }
            } catch (error) {
                console.error('Erro ao atualizar presen√ßa:', error);
                showToast('Erro ao atualizar presen√ßa', 'error');
            }
        }

        // Mark all students present
        async function markAllPresent() {
            try {
                const studentsResponse = await fetch(`/api/students`);
                const studentsResult = await studentsResponse.json();

                if (!studentsResult.success) {
                    throw new Error('Failed to load students');
                }

                const studentsData = studentsResult.data.map(enrollment => ({
                    studentId: enrollment.student.id,
                    present: true,
                    arrived_late: false,
                    left_early: false
                }));

                const response = await fetch(`/api/classes/${currentClassId}/lessons/${currentLessonNumber}/attendance/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        students: studentsData,
                        courseId: '750273f9-7508-4fbf-affb-8efe189f2875',
                        date: new Date().toISOString()
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Todos os alunos marcados como presentes');
                    showToast('Todos os alunos marcados como presentes!');
                    loadAttendanceList();
                } else {
                    throw new Error(result.message || 'Failed to mark all present');
                }
            } catch (error) {
                console.error('Erro ao marcar todos presentes:', error);
                showToast('Erro ao marcar todos presentes', 'error');
            }
        }

        // Update attendance statistics
        function updateAttendanceStats(students, attendanceRecords) {
            const totalStudents = students.length;
            const presentStudents = attendanceRecords.filter(record => record.present).length;
            const absentStudents = totalStudents - presentStudents;
            const attendanceRate = totalStudents > 0 ? Math.round((presentStudents / totalStudents) * 100) : 0;

            document.getElementById('attendanceRate').textContent = attendanceRate + '%';
            document.getElementById('presentCount').textContent = presentStudents;
            document.getElementById('absentCount').textContent = absentStudents;
        }

        // ==========================================
        // QR CODE FUNCTIONALITY
        // ==========================================

        function showQRScanner() {
            const qrCamera = document.getElementById('qrCamera');
            const qrSection = document.getElementById('qrSection');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                qrCamera.style.display = 'block';
                qrCamera.innerHTML = `
                    <div style="background: rgba(0,0,0,0.8); padding: 1rem; border-radius: 8px;">
                        <video id="qrVideo" width="300" height="200" style="border-radius: 8px;"></video>
                        <div style="margin-top: 1rem;">
                            <button onclick="stopQRScanner()" style="background: #EF4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                                Parar Scanner
                            </button>
                        </div>
                        <div id="qrResult" style="margin-top: 1rem; color: #10B981;"></div>
                    </div>
                `;
                
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        const video = document.getElementById('qrVideo');
                        video.srcObject = stream;
                        video.play();
                        showToast('Scanner QR ativado! Aponte para o c√≥digo QR');
                    })
                    .catch(err => {
                        showToast('Erro ao acessar c√¢mera: ' + err.message, 'error');
                    });
            } else {
                showToast('C√¢mera n√£o dispon√≠vel neste dispositivo', 'error');
            }
        }

        function stopQRScanner() {
            const video = document.getElementById('qrVideo');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('qrCamera').style.display = 'none';
            showToast('Scanner QR desativado');
        }

        function generateClassQR() {
            const qrDisplay = document.getElementById('qrDisplay');
            qrDisplay.style.display = 'block';
            qrDisplay.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; display: inline-block;">
                    <div style="width: 200px; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc; color: #666;">
                        QR Code<br>Aula ${currentLessonNumber}
                    </div>
                    <div style="text-align: center; margin-top: 1rem; color: #333; font-weight: bold;">
                        Aula ${currentLessonNumber} - Turma 1<br>
                        <small>Escaneie para marcar presen√ßa</small>
                    </div>
                </div>
            `;
            showToast('QR Code da aula gerado!');
        }

        // ==========================================
        // GPS LOCATION FUNCTIONALITY
        // ==========================================

        function captureByLocation() {
            const locationResult = document.getElementById('locationResult');
            
            if (navigator.geolocation) {
                locationResult.innerHTML = '<p style="color: #F59E0B;">üìç Obtendo localiza√ß√£o...</p>';
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Coordenadas fict√≠cias da academia (exemplo)
                        const academyLat = -23.5505;
                        const academyLng = -46.6333;
                        
                        const distance = calculateDistance(lat, lng, academyLat, academyLng);
                        
                        if (distance < 0.1) { // Dentro de 100m
                            locationResult.innerHTML = `
                                <p style="color: #10B981;">‚úÖ Localiza√ß√£o confirmada!</p>
                                <p style="color: #CBD5E1;">Voc√™ est√° na academia (${distance.toFixed(3)}km)</p>
                                <button onclick="markPresentByLocation()" style="background: #10B981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-top: 0.5rem;">
                                    Marcar Presen√ßa
                                </button>
                            `;
                        } else {
                            locationResult.innerHTML = `
                                <p style="color: #EF4444;">‚ùå Localiza√ß√£o inv√°lida</p>
                                <p style="color: #CBD5E1;">Voc√™ est√° a ${distance.toFixed(2)}km da academia</p>
                            `;
                        }
                    },
                    error => {
                        locationResult.innerHTML = `<p style="color: #EF4444;">‚ùå Erro ao obter localiza√ß√£o: ${error.message}</p>`;
                    }
                );
            } else {
                locationResult.innerHTML = '<p style="color: #EF4444;">‚ùå Geolocaliza√ß√£o n√£o suportada</p>';
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function markPresentByLocation() {
            // Implementar marca√ß√£o por localiza√ß√£o
            showToast('Funcionalidade em desenvolvimento');
        }

        // ==========================================
        // SEARCH FUNCTIONALITY
        // ==========================================

        // Using the global allStudents variable declared above

        async function loadAllStudents() {
            try {
                const response = await fetch(`/api/students`);
                const result = await response.json();
                if (result.success) {
                    allStudents = result.data;
                }
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
            }
        }

        function searchStudentByName(query) {
            if (!query.trim()) {
                document.getElementById('searchResults').innerHTML = '<p>Digite para buscar alunos por nome</p>';
                selectedStudentId = null;
                return;
            }

            const filtered = allStudents.filter(enrollment => {
                const student = enrollment?.student;
                if (!student || !student.user) return false;
                const user = student.user;
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                return fullName.includes(query.toLowerCase());
            });

            displaySearchResults(filtered);
        }

        function searchStudentByID(query) {
            if (!query.trim()) {
                document.getElementById('searchResults').innerHTML = '<p>Digite para buscar por matr√≠cula</p>';
                selectedStudentId = null;
                return;
            }

            const filtered = allStudents.filter(enrollment => {
                const student = enrollment?.student;
                if (!student) return false;
                const user = student.user || {};
                return student.id?.includes(query) || 
                       (user.email || '').includes(query);
            });

            displaySearchResults(filtered);
        }

        function displaySearchResults(students) {
            if (students.length === 0) {
                document.getElementById('searchResults').innerHTML = '<p style="color: #EF4444;">Nenhum aluno encontrado</p>';
                selectedStudentId = null;
                return;
            }

            const html = students.map(enrollment => {
                const student = enrollment?.student;
                if (!student || !student.id) return '';
                
                const user = student.user || {};
                const firstName = user.firstName || 'N';
                const lastName = user.lastName || 'A';
                const email = user.email || 'sem-email@exemplo.com';
                
                return `
                    <div onclick="selectStudent('${student.id}')" 
                         style="padding: 0.5rem; margin: 0.25rem 0; background: rgba(59, 130, 246, 0.1); border-radius: 4px; cursor: pointer; border: 1px solid rgba(59, 130, 246, 0.3);"
                         onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'"
                         onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'">
                        <strong>${firstName} ${lastName}</strong><br>
                        <small style="color: #CBD5E1;">${email} | ID: ${student.id.slice(0, 8)}...</small>
                    </div>
                `;
            }).join('');

            document.getElementById('searchResults').innerHTML = html;
        }

        function selectStudent(studentId) {
            selectedStudentId = studentId;
            const student = allStudents.find(e => e.student.id === studentId);
            if (student) {
                const user = student.student.user || {};
                const firstName = user.firstName || 'N';
                const lastName = user.lastName || 'A';
                document.getElementById('searchResults').innerHTML = `
                    <p style="color: #10B981;">‚úÖ Selecionado: ${firstName} ${lastName}</p>
                `;
            }
        }

        function markSelectedPresent() {
            if (!selectedStudentId) {
                showToast('Selecione um aluno primeiro', 'error');
                return;
            }
            toggleAttendance(selectedStudentId, 'present', true);
        }

        // Enhanced toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast') || createToast();
            const icon = type === 'error' ? '‚ùå' : '‚úÖ';
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>${icon}</span>
                    <span>${message}</span>
                </div>
            `;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        function createToast() {
            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.className = 'toast';
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: rgba(16, 185, 129, 0.9); color: white; padding: 1rem;
                border-radius: 8px; display: none; max-width: 300px;
            `;
            document.body.appendChild(toast);
            return toast;
        }

        // Initialize attendance when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadAllStudents();
        });

        // ==========================================
        // STUDENT PORTAL FUNCTIONALITY
        // ==========================================

        let currentStudent = null;

        // Student login function
        async function studentLogin() {
            const name = document.getElementById('studentName').value.trim();
            const matricula = document.getElementById('studentMatricula').value.trim();

            if (!name || !matricula) {
                showToast('Por favor, preencha nome e matr√≠cula', 'error');
                return;
            }

            try {
                // Search for student by name and email/ID
                const response = await fetch(`/api/students`);
                const result = await response.json();

                if (result.success) {
                    const student = result.data.find(enrollment => {
                        const s = enrollment?.student;
                        if (!s || !s.user) return false;
                        const user = s.user;
                        const fullName = `${user.firstName || 'N'} ${user.lastName || 'A'}`.toLowerCase();
                        return fullName.includes(name.toLowerCase()) && 
                               ((user.email || '').includes(matricula) || s.id.includes(matricula));
                    });

                    if (student) {
                        currentStudent = student.student;
                        showStudentDashboard();
                        showToast(`Bem-vindo, ${currentStudent.user.firstName}!`);
                    } else {
                        showToast('Aluno n√£o encontrado. Verifique nome e matr√≠cula', 'error');
                    }
                }
            } catch (error) {
                console.error('Erro no login:', error);
                showToast('Erro ao fazer login', 'error');
            }
        }

        // Show student dashboard after login
        function showStudentDashboard() {
            document.getElementById('studentLoginSection').style.display = 'none';
            document.getElementById('studentDashboard').style.display = 'block';
            
            // Update welcome message
            document.getElementById('studentWelcome').textContent = 
                `üëã Bem-vindo, ${currentStudent.user.firstName} ${currentStudent.user.lastName}!`;

            // Load student data
            loadStudentData();
        }

        // Student logout
        function studentLogout() {
            currentStudent = null;
            document.getElementById('studentLoginSection').style.display = 'block';
            document.getElementById('studentDashboard').style.display = 'none';
            document.getElementById('studentName').value = '';
            document.getElementById('studentMatricula').value = '';
            showToast('Logout realizado com sucesso');
        }

        // Load student specific data
        async function loadStudentData() {
            try {
                // Load attendance data
                const attendanceResponse = await fetch(`/api/classes/${currentClassId}/lessons/${currentLessonNumber}/attendance`);
                const attendanceResult = await attendanceResponse.json();
                
                if (attendanceResult.success) {
                    const studentAttendance = attendanceResult.data.find(a => a.studentId === currentStudent.id);
                    updateStudentStats(studentAttendance);
                    loadStudentAttendanceHistory();
                }

                // Load progress data
                loadStudentProgress();
                loadStudentChallenges();

            } catch (error) {
                console.error('Erro ao carregar dados do aluno:', error);
            }
        }

        // Update student statistics
        function updateStudentStats(todayAttendance) {
            // No hardcoded data - will be populated by real API calls

            // Update attendance status for today
            if (todayAttendance && todayAttendance.present) {
                document.getElementById('studentManualResult').innerHTML = 
                    '<span style="color: #10B981;">‚úÖ Presen√ßa j√° confirmada!</span>';
            }
        }

        // Load student attendance history
        function loadStudentAttendanceHistory() {
            const historyHtml = `
                <div style="space-y: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <span>Aula 15 - 27/06</span>
                        <span style="color: #10B981;">‚úÖ Presente</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <span>Aula 14 - 25/06</span>
                        <span style="color: #10B981;">‚úÖ Presente</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <span>Aula 13 - 22/06</span>
                        <span style="color: #EF4444;">‚ùå Ausente</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(245, 158, 11, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <span>Aula 12 - 20/06</span>
                        <span style="color: #F59E0B;">‚è∞ Atrasado</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <span>Aula 11 - 18/06</span>
                        <span style="color: #10B981;">‚úÖ Presente</span>
                    </div>
                </div>
            `;
            document.getElementById('studentAttendanceHistory').innerHTML = historyHtml;
        }

        // Load student progress in techniques
        function loadStudentProgress() {
            const progressHtml = `
                <div style="space-y: 0.5rem;">
                    <div style="padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #10B981;">‚úÖ Postura de Guarda</div>
                        <small style="color: #CBD5E1;">Dominada - 95% precis√£o</small>
                    </div>
                    <div style="padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #10B981;">‚úÖ Soco Direto</div>
                        <small style="color: #CBD5E1;">Dominada - 88% precis√£o</small>
                    </div>
                    <div style="padding: 0.5rem; background: rgba(245, 158, 11, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #F59E0B;">üîÑ Defesa Contra Soco</div>
                        <small style="color: #CBD5E1;">Em progresso - 65% precis√£o</small>
                    </div>
                    <div style="padding: 0.5rem; background: rgba(75, 85, 99, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #6B7280;">‚è≥ Joelhada</div>
                        <small style="color: #CBD5E1;">Pr√≥xima t√©cnica</small>
                    </div>
                    <div style="padding: 0.5rem; background: rgba(75, 85, 99, 0.1); border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #6B7280;">‚è≥ Esquiva Lateral</div>
                        <small style="color: #CBD5E1;">Pr√≥xima t√©cnica</small>
                    </div>
                </div>
            `;
            document.getElementById('studentTechniquesProgress').innerHTML = progressHtml;
        }

        // Load student challenges
        function loadStudentChallenges() {
            const challengesHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                        <h5 style="color: #3B82F6; margin-bottom: 0.5rem;">üì± Desafio da Semana</h5>
                        <p style="margin-bottom: 1rem;">Pratique 10 socos diretos em casa e filme</p>
                        <button style="width: 100%; padding: 0.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Enviar V√≠deo
                        </button>
                    </div>
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                        <h5 style="color: #10B981; margin-bottom: 0.5rem;">‚úÖ Desafio Completo</h5>
                        <p style="margin-bottom: 1rem;">Postura de guarda por 2 minutos</p>
                        <div style="color: #10B981; font-weight: 600;">+50 Pontos XP</div>
                    </div>
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.3);">
                        <h5 style="color: #F59E0B; margin-bottom: 0.5rem;">‚è∞ Desafio Extra</h5>
                        <p style="margin-bottom: 1rem;">Treine cardio por 15 minutos</p>
                        <button style="width: 100%; padding: 0.5rem; background: #F59E0B; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Marcar Completo
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('studentChallenges').innerHTML = challengesHtml;
        }

        // Student QR scan function
        function studentQRScan() {
            const resultDiv = document.getElementById('studentQRResult');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                resultDiv.innerHTML = '<span style="color: #F59E0B;">üì∑ Ativando c√¢mera...</span>';
                
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        resultDiv.innerHTML = `
                            <div style="margin: 1rem 0;">
                                <video id="studentQRVideo" width="200" height="150" style="border-radius: 8px; background: #000;"></video>
                                <div style="margin-top: 0.5rem;">
                                    <button onclick="stopStudentQRScan()" style="background: #EF4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        Parar
                                    </button>
                                </div>
                            </div>
                        `;
                        const video = document.getElementById('studentQRVideo');
                        video.srcObject = stream;
                        video.play();
                        
                        // Simulate QR detection after 3 seconds
                        setTimeout(() => {
                            studentMarkPresenceQR();
                        }, 3000);
                    })
                    .catch(err => {
                        resultDiv.innerHTML = '<span style="color: #EF4444;">‚ùå Erro ao acessar c√¢mera</span>';
                    });
            } else {
                resultDiv.innerHTML = '<span style="color: #EF4444;">‚ùå C√¢mera n√£o dispon√≠vel</span>';
            }
        }

        function stopStudentQRScan() {
            const video = document.getElementById('studentQRVideo');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('studentQRResult').innerHTML = 'Escaneie o QR code mostrado pelo instrutor';
        }

        function studentMarkPresenceQR() {
            stopStudentQRScan();
            markStudentPresent('QR_CODE');
            document.getElementById('studentQRResult').innerHTML = '<span style="color: #10B981;">‚úÖ QR Code detectado! Presen√ßa confirmada</span>';
        }

        // Student GPS check
        function studentGPSCheck() {
            const resultDiv = document.getElementById('studentGPSResult');
            
            if (navigator.geolocation) {
                resultDiv.innerHTML = '<span style="color: #F59E0B;">üìç Verificando localiza√ß√£o...</span>';
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Academy coordinates (mock)
                        const academyLat = -23.5505;
                        const academyLng = -46.6333;
                        
                        const distance = calculateDistance(lat, lng, academyLat, academyLng);
                        
                        if (distance < 0.1) { // Within 100m
                            markStudentPresent('GEOLOCATION');
                            resultDiv.innerHTML = '<span style="color: #10B981;">‚úÖ Localiza√ß√£o confirmada! Presen√ßa marcada</span>';
                        } else {
                            resultDiv.innerHTML = `<span style="color: #EF4444;">‚ùå Voc√™ est√° a ${distance.toFixed(2)}km da academia</span>`;
                        }
                    },
                    error => {
                        resultDiv.innerHTML = '<span style="color: #EF4444;">‚ùå Erro ao obter localiza√ß√£o</span>';
                    }
                );
            } else {
                resultDiv.innerHTML = '<span style="color: #EF4444;">‚ùå GPS n√£o dispon√≠vel</span>';
            }
        }

        // Student manual check-in
        function studentManualCheckIn() {
            markStudentPresent('MANUAL');
            document.getElementById('studentManualResult').innerHTML = '<span style="color: #10B981;">‚úÖ Presen√ßa confirmada manualmente!</span>';
        }

        // Mark student present (unified function)
        async function markStudentPresent(method) {
            if (!currentStudent) {
                showToast('Erro: aluno n√£o identificado', 'error');
                return;
            }

            try {
                const attendanceData = {
                    studentId: currentStudent.id,
                    classId: currentClassId,
                    courseId: '750273f9-7508-4fbf-affb-8efe189f2875',
                    lessonNumber: currentLessonNumber,
                    date: new Date().toISOString(),
                    present: true,
                    arrived_late: false,
                    left_early: false,
                    method: method
                };

                const response = await fetch('/api/attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(attendanceData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast(`Presen√ßa confirmada via ${method}!`);
                    // Update stats
                    updateStudentStats({present: true});
                } else {
                    throw new Error(result.message || 'Failed to mark attendance');
                }
            } catch (error) {
                console.error('Erro ao marcar presen√ßa:', error);
                showToast('Erro ao confirmar presen√ßa', 'error');
            }
        }

        // Navigation functionality consolidated in main showSection function above

        // ==========================================
        // PUBLIC CHECK-IN KIOSK FUNCTIONALITY
        // ==========================================

        let publicCheckinStudents = [];
        let checkinCount = 0;
        let selectedStudentForCheckin = null;

        // Load public check-in interface
        async function loadPublicCheckin() {
            await loadStudentsForCheckin();
            loadRecentCheckins();
            updateCheckinCount();
            document.getElementById('quickMatricula').value = '';
            document.getElementById('quickResult').innerHTML = 'Digite sua matr√≠cula e pressione Enter';
        }

        // Load students for visual selection
        async function loadStudentsForCheckin() {
            try {
                const response = await fetch(`/api/students`);
                const result = await response.json();

                if (result.success) {
                    publicCheckinStudents = result.data;
                    displayStudentGrid();
                }
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
            }
        }

        // Display student grid with photos
        function displayStudentGrid() {
            const grid = document.getElementById('studentGrid');
            
            if (!grid) {
                console.error('studentGrid element not found');
                return;
            }
            
            const html = publicCheckinStudents.map(item => {
                // Check if data is in enrollment.student format or direct student format
                const student = item?.student || item;
                if (!student || !student.id) {
                    console.warn('Invalid student data in enrollment:', item);
                    return '';
                }
                
                // Safe access to user data
                const user = student.user || {};
                const firstName = user.firstName || 'N';
                const lastName = user.lastName || 'A';
                const initials = firstName.charAt(0) + lastName.charAt(0);
                
                return `
                    <div onclick="selectStudentForCheckin('${student.id}')" 
                         class="student-card" id="card-${student.id}"
                         style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                         onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'; this.style.borderColor='#3B82F6'"
                         onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='transparent'">
                        
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #3B82F6, #10B981); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.5rem; margin: 0 auto 0.5rem;">
                            ${initials}
                        </div>
                        
                        <div style="font-weight: 600; color: white; font-size: 0.875rem; margin-bottom: 0.25rem;">
                            ${firstName}
                        </div>
                        <div style="font-weight: 600; color: white; font-size: 0.875rem; margin-bottom: 0.5rem;">
                            ${lastName}
                        </div>
                        
                        <div style="font-size: 0.75rem; color: #CBD5E1;">
                            ID: ${student.id.slice(0, 6)}...
                        </div>
                        
                        <div id="status-${student.id}" style="margin-top: 0.5rem; font-size: 0.75rem;">
                            <span style="color: #6B7280;">üë§ Ausente</span>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = html;
        }

        // Select student for check-in
        function selectStudentForCheckin(studentId) {
            // Reset all cards
            document.querySelectorAll('.student-card').forEach(card => {
                card.style.background = 'rgba(255,255,255,0.1)';
                card.style.borderColor = 'transparent';
            });

            // Highlight selected card
            const selectedCard = document.getElementById(`card-${studentId}`);
            if (selectedCard) {
                selectedCard.style.background = 'rgba(16, 185, 129, 0.2)';
                selectedCard.style.borderColor = '#10B981';
            }

            selectedStudentForCheckin = studentId;
            
            // Find student info - handle both direct student format and enrollment format
            const studentItem = publicCheckinStudents.find(item => {
                const student = item?.student || item;
                return student && student.id === studentId;
            });
            
            if (studentItem) {
                const student = studentItem?.student || studentItem;
                const user = student.user || {};
                const firstName = user.firstName || 'N';
                const lastName = user.lastName || 'A';
                document.getElementById('quickResult').innerHTML = 
                    `<span style="color: #10B981;">‚úÖ ${firstName} ${lastName} selecionado</span>`;
                
                // Auto check-in after 2 seconds
                setTimeout(() => {
                    publicCheckinStudent(studentId);
                }, 2000);
            }
        }

        // Handle quick search by typing
        function handleQuickSearch(event) {
            const query = event.target.value.trim();
            
            if (event.key === 'Enter' && query) {
                quickCheckin();
                return;
            }

            if (!query) {
                document.getElementById('quickResult').innerHTML = 'Digite sua matr√≠cula e pressione Enter';
                return;
            }

            // Real-time search - handle both direct student format and enrollment format
            const found = publicCheckinStudents.find(item => {
                const student = item?.student || item;
                if (!student || !student.user) return false;
                const user = student.user;
                return student.id.includes(query) || 
                       (user.email || '').includes(query) ||
                       `${user.firstName || 'N'} ${user.lastName || 'A'}`.toLowerCase().includes(query.toLowerCase());
            });

            if (found) {
                const student = found?.student || found;
                selectedStudentForCheckin = student.id;
                const user = student.user || {};
                const firstName = user.firstName || 'N';
                const lastName = user.lastName || 'A';
                document.getElementById('quickResult').innerHTML = 
                    `<span style="color: #10B981;">‚úÖ ${firstName} ${lastName} encontrado - Pressione Enter</span>`;
            } else {
                selectedStudentForCheckin = null;
                document.getElementById('quickResult').innerHTML = 
                    `<span style="color: #F59E0B;">‚ö†Ô∏è Aluno n√£o encontrado</span>`;
            }
        }

        // Quick check-in function
        function quickCheckin() {
            if (!selectedStudentForCheckin) {
                document.getElementById('quickResult').innerHTML = 
                    `<span style="color: #EF4444;">‚ùå Digite uma matr√≠cula v√°lida</span>`;
                return;
            }

            publicCheckinStudent(selectedStudentForCheckin);
        }

        // Public check-in student (unified function)
        async function publicCheckinStudent(studentId) {
            try {
                const attendanceData = {
                    studentId: studentId,
                    classId: currentClassId,
                    courseId: '750273f9-7508-4fbf-affb-8efe189f2875',
                    lessonNumber: currentLessonNumber,
                    date: new Date().toISOString(),
                    present: true,
                    arrived_late: false,
                    left_early: false,
                    method: 'KIOSK'
                };

                const response = await fetch('/api/attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(attendanceData)
                });

                const result = await response.json();
                
                if (result.success) {
                    const studentItem = publicCheckinStudents.find(item => {
                        const student = item?.student || item;
                        return student && student.id === studentId;
                    });
                    
                    if (studentItem) {
                        const student = studentItem?.student || studentItem;
                        const user = student.user || {};
                        const studentName = `${user.firstName || 'N'} ${user.lastName || 'A'}`;
                        
                        // Update UI
                        updateStudentCheckinStatus(studentId, true);
                        showSuccessAnimation(studentName);
                        loadRecentCheckins();
                        updateCheckinCount();
                        
                        // Clear selection
                        selectedStudentForCheckin = null;
                        document.getElementById('quickMatricula').value = '';
                        document.getElementById('quickResult').innerHTML = 'Digite sua matr√≠cula e pressione Enter';
                    }
                    
                } else {
                    throw new Error(result.message || 'Failed to mark attendance');
                }
            } catch (error) {
                console.error('Erro no check-in:', error);
                document.getElementById('quickResult').innerHTML = 
                    `<span style="color: #EF4444;">‚ùå Erro no check-in</span>`;
            }
        }

        // Update student check-in status in the grid
        function updateStudentCheckinStatus(studentId, present) {
            const statusDiv = document.getElementById(`status-${studentId}`);
            const card = document.getElementById(`card-${studentId}`);
            
            if (present) {
                statusDiv.innerHTML = '<span style="color: #10B981;">‚úÖ Presente</span>';
                card.style.background = 'rgba(16, 185, 129, 0.1)';
                card.style.borderColor = '#10B981';
                card.onclick = null; // Disable further clicks
                card.style.cursor = 'default';
            }
        }

        // Show success animation
        function showSuccessAnimation(studentName) {
            const animation = document.createElement('div');
            animation.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(16, 185, 129, 0.95); color: white; padding: 2rem;
                border-radius: 16px; font-size: 1.5rem; font-weight: bold;
                z-index: 10000; text-align: center; min-width: 300px;
                animation: successPulse 0.5s ease-in-out;
            `;
            animation.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                <div>Check-in Realizado!</div>
                <div style="font-size: 1rem; margin-top: 0.5rem;">${studentName}</div>
            `;
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes successPulse {
                    0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                    50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(animation);
            
            setTimeout(() => {
                document.body.removeChild(animation);
                document.head.removeChild(style);
            }, 3000);
        }

        // Load recent check-ins
        async function loadRecentCheckins() {
            try {
                const response = await fetch(`/api/classes/${currentClassId}/lessons/${currentLessonNumber}/attendance`);
                const result = await response.json();

                if (result.success) {
                    displayRecentCheckins(result.data);
                }
            } catch (error) {
                console.error('Erro ao carregar check-ins:', error);
            }
        }

        // Display recent check-ins
        function displayRecentCheckins(attendanceRecords) {
            const container = document.getElementById('recentCheckins');
            
            if (!attendanceRecords || attendanceRecords.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6B7280;">
                        Nenhum check-in hoje ainda
                    </div>
                `;
                return;
            }

            const html = attendanceRecords
                .filter(record => record.present)
                .map(record => {
                    const student = publicCheckinStudents.find(e => e.student.id === record.studentId);
                    if (!student) return '';
                    
                    const time = new Date().toLocaleTimeString('pt-BR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid #10B981;">
                            <div>
                                <div style="font-weight: 600; color: white;">
                                    ${(student.student?.user?.firstName || 'N/A')} ${(student.student?.user?.lastName || '')}
                                </div>
                                <div style="font-size: 0.875rem; color: #CBD5E1;">
                                    ID: ${(student.student?.id || 'N/A').toString().slice(0, 8)}...
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #10B981; font-weight: 600;">‚úÖ Presente</div>
                                <div style="font-size: 0.875rem; color: #CBD5E1;">${time}</div>
                            </div>
                        </div>
                    `;
                })
                .join('');

            container.innerHTML = html || `
                <div style="text-align: center; padding: 2rem; color: #6B7280;">
                    Nenhum check-in hoje ainda
                </div>
            `;
        }

        // Update check-in count
        function updateCheckinCount() {
            // Count present students
            fetch(`/api/classes/${currentClassId}/lessons/${currentLessonNumber}/attendance`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const presentCount = result.data.filter(record => record.present).length;
                        const totalStudents = publicCheckinStudents.length;
                        document.getElementById('checkinCount').textContent = `${presentCount} Presentes`;
                    }
                })
                .catch(error => console.error('Erro ao atualizar contador:', error));
        }

        // Refresh student grid
        function refreshStudentGrid() {
            loadStudentsForCheckin();
            showToast('Lista de alunos atualizada');
        }

        // Public QR Scanner
        function togglePublicQRScanner() {
            const camera = document.getElementById('publicQRCamera');
            
            if (camera.style.display === 'none') {
                startPublicQRScanner();
            } else {
                stopPublicQRScanner();
            }
        }

        function startPublicQRScanner() {
            const camera = document.getElementById('publicQRCamera');
            const result = document.getElementById('publicQRResult');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                camera.style.display = 'block';
                camera.innerHTML = `
                    <div style="background: rgba(0,0,0,0.8); padding: 1rem; border-radius: 8px; display: inline-block;">
                        <video id="publicQRVideo" width="300" height="200" style="border-radius: 8px;"></video>
                        <div style="margin-top: 1rem;">
                            <button onclick="stopPublicQRScanner()" style="background: #EF4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                                Parar Scanner
                            </button>
                        </div>
                    </div>
                `;
                
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        const video = document.getElementById('publicQRVideo');
                        video.srcObject = stream;
                        video.play();
                        result.innerHTML = '<span style="color: #10B981;">üì∑ Scanner ativo - Aponte para o QR code</span>';
                        
                        // Simulate QR detection after 5 seconds
                        setTimeout(() => {
                            if (publicCheckinStudents.length > 0) {
                                const randomStudent = publicCheckinStudents[0].student; // Use first student for demo
                                publicCheckinStudent(randomStudent.id);
                                result.innerHTML = '<span style="color: #10B981;">‚úÖ QR Code detectado!</span>';
                                stopPublicQRScanner();
                            }
                        }, 5000);
                    })
                    .catch(err => {
                        result.innerHTML = '<span style="color: #EF4444;">‚ùå Erro ao acessar c√¢mera</span>';
                    });
            } else {
                result.innerHTML = '<span style="color: #EF4444;">‚ùå C√¢mera n√£o dispon√≠vel</span>';
            }
        }

        function stopPublicQRScanner() {
            const video = document.getElementById('publicQRVideo');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('publicQRCamera').style.display = 'none';
            document.getElementById('publicQRResult').innerHTML = 'Escaneie o QR code do seu cart√£o de aluno';
        }

        // ==========================================
        // STUDENT DETAILS MODAL FUNCTIONS
        // ==========================================

        // Store current students data globally for modal access
        window.currentStudents = [];

        // Update currentStudents when data is loaded
        const originalLoadStudents = loadStudents;
        loadStudents = async function() {
            await originalLoadStudents();
            window.currentStudents = allStudents || [];
        };

        // Open student details modal
        window.openStudentDetails = async function(studentId) {
            try {
                console.log('Opening student details for ID:', studentId);
                
                // Find student data from current students list
                const student = window.currentStudents?.find(s => s.id === studentId);
                
                if (!student) {
                    console.error('Student not found:', studentId);
                    showToast('Aluno n√£o encontrado', 'error');
                    return;
                }

                // Populate modal with student data
                populateStudentModal(student);
                
                // Show modal
                document.getElementById('studentDetailsModal').style.display = 'block';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                
            } catch (error) {
                console.error('Error opening student details:', error);
                showToast('Erro ao abrir detalhes do aluno', 'error');
            }
        };

        // Close student details modal
        window.closeStudentModal = function() {
            document.getElementById('studentDetailsModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        };

        // Switch between tabs in student modal
        window.switchStudentTab = function(tabName) {
            console.log(`üîÑ switchStudentTab called with: ${tabName}`);
            
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.student-tab-content');
            console.log(`üîç Found ${tabContents.length} tab contents`);
            tabContents.forEach(tab => {
                console.log(`üîí Hiding tab: ${tab.id}`);
                tab.style.display = 'none';
            });

            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.student-tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.color = '#94A3B8';
                btn.style.borderBottomColor = 'transparent';
            });

            // Show selected tab content
            const selectedTab = document.getElementById(`student-tab-${tabName}`);
            console.log(`üéØ Looking for tab: student-tab-${tabName}`);
            console.log(`üéØ Found selectedTab:`, selectedTab);
            if (selectedTab) {
                selectedTab.style.display = 'block';
                console.log(`‚úÖ Showing tab: ${selectedTab.id}`);
            } else {
                console.error(`‚ùå Tab not found: student-tab-${tabName}`);
            }

            // Add active class to selected tab button
            const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
                selectedBtn.style.color = '#3B82F6';
                selectedBtn.style.borderBottomColor = '#3B82F6';
            }

            // Load dynamic content based on tab
            loadTabContent(tabName);
        };

        // Populate student modal with data
        function populateStudentModal(student) {
            try {
                // Header information
                const user = student.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                document.getElementById('modalStudentName').textContent = fullName || 'Nome n√£o informado';
                document.getElementById('modalStudentId').textContent = `ID: ${student.id?.substring(0, 8) || 'N/A'}...`;

                // Summary information
                document.getElementById('modalStudentStatus').textContent = student.isActive ? 'Ativo' : 'Inativo';
                document.getElementById('modalStudentCategory').textContent = getCategoryText(student.category);
                document.getElementById('modalStudentClasses').textContent = '1'; // Default for now
                document.getElementById('modalStudentAttendance').textContent = '85%'; // Default for now

                // Basic Information
                document.getElementById('modalFullName').textContent = fullName || 'N√£o informado';
                document.getElementById('modalCpf').textContent = user.cpf ? formatCPF(user.cpf) : 'N√£o informado';
                document.getElementById('modalBirthDate').textContent = user.birthDate ? new Date(user.birthDate).toLocaleDateString('pt-BR') : 'N√£o informado';
                document.getElementById('modalAge').textContent = calculateAge(user.birthDate) || 'N/A';
                document.getElementById('modalGender').textContent = getGenderText(student.gender);
                document.getElementById('modalEmail').textContent = user.email || 'N√£o informado';
                document.getElementById('modalPhone').textContent = user.phone || 'N√£o informado';

                // Address Information
                document.getElementById('modalPostalCode').textContent = student.postalCode || 'N√£o informado';
                document.getElementById('modalAddress').textContent = student.address || 'N√£o informado';
                document.getElementById('modalAddressNumber').textContent = student.addressNumber || 'N√£o informado';
                document.getElementById('modalNeighborhood').textContent = student.neighborhood || 'N√£o informado';
                document.getElementById('modalCity').textContent = student.city || 'N√£o informado';
                document.getElementById('modalState').textContent = student.state || 'N√£o informado';

                // Academic Information
                document.getElementById('modalRegistration').textContent = student.matricula || student.id?.substring(0, 8) || 'N/A';
                document.getElementById('modalEnrollmentDate').textContent = student.createdAt ? new Date(student.createdAt).toLocaleDateString('pt-BR') : 'N√£o informado';
                document.getElementById('modalStudentCategoryDetails').textContent = getCategoryText(student.category);
                document.getElementById('modalStatusDetails').textContent = student.isActive ? 'Ativo' : 'Inativo';
                document.getElementById('modalSpecialNeeds').textContent = student.specialNeeds?.length > 0 ? student.specialNeeds.join(', ') : 'Nenhuma';

                // Emergency Contact (placeholder for now)
                document.getElementById('modalEmergencyName').textContent = student.emergencyContact || 'N√£o informado';
                document.getElementById('modalEmergencyPhone').textContent = 'N√£o informado';
                document.getElementById('modalEmergencyRelation').textContent = 'N√£o informado';

            } catch (error) {
                console.error('Error populating student modal:', error);
            }
        }

        // Load dynamic tab content
        function loadTabContent(tabName) {
            const tabContent = document.getElementById(`student-tab-${tabName}`);
            
            switch(tabName) {
                case 'courses':
                    if (tabContent && tabContent.innerHTML.includes('Carregando')) {
                        tabContent.innerHTML = `
                            <div style="background: rgba(59, 130, 246, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <h3 style="color: #3B82F6; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>üìö</span> Cursos Matriculados
                                </h3>
                                <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #10B981; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: #10B981; font-weight: bold;">ü•ã Krav Maga Faixa Branca - Defesa Pessoal 1</div>
                                            <div style="color: #CBD5E1; font-size: 0.875rem; margin-top: 0.25rem;">Iniciado em: 01/06/2025 ‚Ä¢ Progresso: 31%</div>
                                        </div>
                                        <div style="background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">
                                            ATIVO
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 2rem; color: #6B7280;">
                                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üéØ</div>
                                    <p style="margin: 0;">Pronto para novos desafios! Considere matricular em cursos avan√ßados.</p>
                                </div>
                            </div>
                        `;
                    }
                    break;
                case 'classes':
                    if (tabContent && tabContent.innerHTML.includes('Carregando')) {
                        tabContent.innerHTML = `
                            <div style="background: rgba(245, 158, 11, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                                <h3 style="color: #F59E0B; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>üè´</span> Turmas Participantes
                                </h3>
                                <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #3B82F6; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div style="color: #3B82F6; font-weight: bold;">Turma 1 - Ter√ßas e Quintas</div>
                                        <div style="background: #3B82F6; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">
                                            ATIVO
                                        </div>
                                    </div>
                                    <div style="color: #CBD5E1; font-size: 0.875rem;">
                                        <div>‚è∞ Hor√°rio: 18:00 - 19:00</div>
                                        <div>üë• Capacidade: 15/20 alunos</div>
                                        <div>üìÖ Pr√≥xima aula: Quinta, 05/06/2025</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    break;
                case 'progress':
                    if (tabContent && tabContent.innerHTML.includes('Carregando')) {
                        tabContent.innerHTML = `
                            <div style="display: grid; gap: 2rem;">
                                <div style="background: rgba(139, 92, 246, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                                    <h3 style="color: #8B5CF6; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>üìà</span> Progresso Geral
                                    </h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                        <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                            <div style="color: #10B981; font-size: 2rem; font-weight: bold;">5</div>
                                            <div style="color: #CBD5E1; font-size: 0.875rem;">T√©cnicas Dominadas</div>
                                        </div>
                                        <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                                            <div style="color: #3B82F6; font-size: 2rem; font-weight: bold;">65</div>
                                            <div style="color: #CBD5E1; font-size: 0.875rem;">Pontos XP</div>
                                        </div>
                                        <div style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                                            <div style="color: #F59E0B; font-size: 2rem; font-weight: bold;">85%</div>
                                            <div style="color: #CBD5E1; font-size: 0.875rem;">Frequ√™ncia</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    break;
                case 'financial':
                    if (tabContent && tabContent.innerHTML.includes('Carregando')) {
                        tabContent.innerHTML = `
                            <div style="background: rgba(16, 185, 129, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                                <h3 style="color: #10B981; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>üí∞</span> Situa√ß√£o Financeira
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                    <div>
                                        <h4 style="color: #CBD5E1; margin: 0 0 1rem 0;">Plano Atual</h4>
                                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #3B82F6;">
                                            <div style="color: #3B82F6; font-weight: bold; margin-bottom: 0.5rem;">Plano Mensal Premium</div>
                                            <div style="color: #CBD5E1; font-size: 0.875rem;">R$ 150,00/m√™s</div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 style="color: #CBD5E1; margin: 0 0 1rem 0;">Status Pagamento</h4>
                                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #10B981;">
                                            <div style="color: #10B981; font-weight: bold; margin-bottom: 0.5rem;">‚úÖ Em Dia</div>
                                            <div style="color: #CBD5E1; font-size: 0.875rem;">Pr√≥ximo vencimento: 01/07/2025</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    break;
                case 'attendance':
                    if (tabContent && tabContent.innerHTML.includes('Carregando')) {
                        tabContent.innerHTML = `
                            <div style="background: rgba(59, 130, 246, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <h3 style="color: #3B82F6; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>üìä</span> Hist√≥rico de Frequ√™ncia
                                </h3>
                                <div style="display: grid; gap: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                        <span style="color: #CBD5E1;">Aula 15 - 27/06/2025</span>
                                        <span style="color: #10B981; font-weight: bold;">‚úÖ Presente</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                        <span style="color: #CBD5E1;">Aula 14 - 25/06/2025</span>
                                        <span style="color: #10B981; font-weight: bold;">‚úÖ Presente</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                                        <span style="color: #CBD5E1;">Aula 13 - 22/06/2025</span>
                                        <span style="color: #EF4444; font-weight: bold;">‚ùå Ausente</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    break;
                case 'history':
                    if (tabContent && tabContent.innerHTML.includes('Carregando')) {
                        tabContent.innerHTML = `
                            <div style="background: rgba(139, 92, 246, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                                <h3 style="color: #8B5CF6; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>üìú</span> Hist√≥rico de Atividades
                                </h3>
                                <div style="display: grid; gap: 1rem;">
                                    <div style="padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid #3B82F6;">
                                        <div style="color: #3B82F6; font-weight: bold; margin-bottom: 0.25rem;">Matr√≠cula Realizada</div>
                                        <div style="color: #CBD5E1; font-size: 0.875rem;">01/06/2025 - Curso: Krav Maga Faixa Branca</div>
                                    </div>
                                    <div style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10B981;">
                                        <div style="color: #10B981; font-weight: bold; margin-bottom: 0.25rem;">Primeira Avalia√ß√£o</div>
                                        <div style="color: #CBD5E1; font-size: 0.875rem;">15/06/2025 - Nota: 8.5/10</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    break;
            }
        }

        // Helper functions for modal
        function calculateAge(birthDate) {
            if (!birthDate) return null;
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age + ' anos';
        }

        function getGenderText(gender) {
            const genderMap = {
                'MASCULINO': 'Masculino',
                'FEMININO': 'Feminino',
                'MALE': 'Masculino',
                'FEMALE': 'Feminino'
            };
            return genderMap[gender] || gender || 'N√£o informado';
        }

        function getCategoryText(category) {
            const categoryMap = {
                'ADULT': 'Adulto',
                'INICIANTE1': 'Iniciante 1',
                'INICIANTE2': 'Iniciante 2',
                'INTERMEDIARIO1': 'Intermedi√°rio 1',
                'INTERMEDIARIO2': 'Intermedi√°rio 2',
                'AVANCADO1': 'Avan√ßado 1',
                'AVANCADO2': 'Avan√ßado 2'
            };
            return categoryMap[category] || category || 'N√£o informado';
        }

        // Additional modal functions for footer buttons
        window.editStudentInfo = function() {
            const modal = document.getElementById('studentDetailsModal');
            const studentId = modal.dataset.currentStudentId;
            
            if (studentId) {
                closeStudentModal();
                // Use existing edit function
                openStudentEditPage(studentId);
            } else {
                showToast('Erro: ID do aluno n√£o encontrado', 'error');
            }
        };

        window.addStudentToClass = function() {
            const modal = document.getElementById('studentDetailsModal');
            const studentId = modal.dataset.currentStudentId;
            
            if (studentId) {
                const student = window.currentStudents?.find(s => s.id === studentId);
                if (student) {
                    const user = student.user || {};
                    const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                    
                    showToast(`Funcionalidade em desenvolvimento: Adicionar ${fullName} √† turma`, 'info');
                } else {
                    showToast('Aluno n√£o encontrado', 'error');
                }
            } else {
                showToast('Erro: ID do aluno n√£o encontrado', 'error');
            }
        };

        // Update the populateStudentModal function to store student ID
        const originalPopulateStudentModal = populateStudentModal;
        populateStudentModal = function(student) {
            // Store student ID in modal for footer button functions
            const modal = document.getElementById('studentDetailsModal');
            if (modal) {
                modal.dataset.currentStudentId = student.id;
            }
            
            // Call original function
            originalPopulateStudentModal(student);
        };

        // Event listeners for modal
        document.addEventListener('DOMContentLoaded', function() {
            // Close modal when clicking outside
            const modal = document.getElementById('studentDetailsModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target.id === 'studentDetailsModal') {
                        closeStudentModal();
                    }
                });
            }

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal && modal.style.display === 'block') {
                    closeStudentModal();
                }
            });
        });

        // ==========================================
        // COURSE MANAGEMENT FUNCTIONS  
        // ==========================================

        // Show course details
        function showCourseDetails() {
            showToast('Funcionalidade em desenvolvimento', 'info');
        }

        // Show lesson plan manager
        function showLessonPlanManager() {
            showSection('course-management');
            loadAllLessonPlans();
        }

        // Show lessons by unit
        function showLessonsByUnit(unit) {
            document.getElementById('current-unit-name').textContent = getUnitName(unit);
            loadLessonPlansByUnit(unit);
        }

        // Show all lessons
        function showAllLessons() {
            document.getElementById('current-unit-name').textContent = 'Todas as Unidades';
            loadAllLessonPlans();
        }

        // Get unit display name
        function getUnitName(unit) {
            const units = {
                'fundamentos': 'Fundamentos (Aulas 1-10)',
                'golpes': 'Golpes B√°sicos (Aulas 4-15)', 
                'defesas': 'Defesas B√°sicas (Aulas 10-25)',
                'avancadas': 'Defesas Avan√ßadas (Aulas 25-35)',
                'integracao': 'Integra√ß√£o (Aulas 35-48)'
            };
            return units[unit] || 'Unidade Desconhecida';
        }

        // Load all lesson plans
        async function loadAllLessonPlans() {
            console.log('üìã Carregando todos os planos de aula...');
            
            // Update current unit name indicator
            const unitNameElement = document.getElementById('current-unit-name');
            if (unitNameElement) {
                unitNameElement.textContent = 'Todas as Unidades';
            }
            
            try {
                // Show loading state
                const tbody = document.getElementById('lesson-plans-table-body');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üîÑ</div>
                                Carregando todos os planos de aula...
                            </td>
                        </tr>
                    `;
                }
                
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Generate sample lesson plans for all units
                const allPlans = [
                    ...generateSampleLessonPlansForUnit('fundamentos'),
                    ...generateSampleLessonPlansForUnit('golpes'),
                    ...generateSampleLessonPlansForUnit('defesas'),
                    ...generateSampleLessonPlansForUnit('avancadas'),
                    ...generateSampleLessonPlansForUnit('integracao')
                ];
                
                // Display all plans
                displayLessonPlans(allPlans);
                
                // Show success message
                showToast(`Carregados ${allPlans.length} planos de aula de todas as unidades`, 'success');

            } catch (error) {
                console.error('Erro ao carregar planos de aula:', error);
                showToast('Erro ao carregar planos de aula', 'error');
                
                // Show error state
                const tbody = document.getElementById('lesson-plans-table-body');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; color: #EF4444; padding: 2rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ùå</div>
                                Erro ao carregar planos de aula
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Load lessons by unit
        async function loadLessonPlansByUnit(unit) {
            console.log(`üìö Carregando planos de aula para unidade: ${unit}`);
            
            // Update current unit name indicator
            const unitNameElement = document.getElementById('current-unit-name');
            if (unitNameElement) {
                unitNameElement.textContent = getUnitName(unit);
            }
            
            // Show loading state
            const tbody = document.getElementById('lesson-plans-table-body');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üîÑ</div>
                            Carregando planos de aula para ${getUnitName(unit)}...
                        </td>
                    </tr>
                `;
            }
            
            try {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Generate sample lesson plans for the unit
                const samplePlans = generateSampleLessonPlansForUnit(unit);
                
                // Display the filtered plans
                displayLessonPlans(samplePlans);
                
                // Show success message
                showToast(`Carregados ${samplePlans.length} planos de aula para ${getUnitName(unit)}`, 'success');
                
            } catch (error) {
                console.error('Erro ao carregar planos de aula por unidade:', error);
                showToast('Erro ao carregar planos de aula', 'error');
                
                // Show error state
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; color: #EF4444; padding: 2rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ùå</div>
                                Erro ao carregar planos de aula
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Generate sample lesson plans for specific unit
        function generateSampleLessonPlansForUnit(unit) {
            const unitData = {
                'fundamentos': {
                    name: 'Fundamentos',
                    lessons: [
                        { lesson: 1, title: 'Postura e Movimenta√ß√£o B√°sica', techniques: 'Postura de combate, movimenta√ß√£o lateral' },
                        { lesson: 2, title: 'Posicionamento Defensivo', techniques: 'Dist√¢ncia de seguran√ßa, posicionamento corporal' },
                        { lesson: 3, title: 'Fundamentos de Ataque', techniques: 'Soco direto, cruzado' },
                        { lesson: 4, title: 'Fundamentos de Defesa', techniques: 'Bloqueios b√°sicos, esquivas' },
                        { lesson: 5, title: 'Coordena√ß√£o Motora', techniques: 'Coordena√ß√£o olho-m√£o, reflexos' },
                        { lesson: 6, title: 'Condicionamento F√≠sico', techniques: 'Aquecimento, condicionamento b√°sico' },
                        { lesson: 7, title: 'T√©cnicas de Respira√ß√£o', techniques: 'Respira√ß√£o em combate, controle de ansiedade' },
                        { lesson: 8, title: 'Trabalho de Pernas', techniques: 'Chutes b√°sicos, mobilidade' },
                        { lesson: 9, title: 'Integra√ß√£o de Movimentos', techniques: 'Combina√ß√£o de t√©cnicas b√°sicas' },
                        { lesson: 10, title: 'Avalia√ß√£o de Fundamentos', techniques: 'Teste pr√°tico, avalia√ß√£o de progresso' }
                    ],
                    color: '#10B981'
                },
                'golpes': {
                    name: 'Golpes B√°sicos',
                    lessons: [
                        { lesson: 11, title: 'Socos Diretos', techniques: 'Jab, cross, hook' },
                        { lesson: 12, title: 'Socos Curvos', techniques: 'Uppercut, ganchos laterais' },
                        { lesson: 13, title: 'Chutes Frontais', techniques: 'Chute frontal, chute lateral' },
                        { lesson: 14, title: 'Chutes Circulares', techniques: 'Chute circular, chute ascendente' },
                        { lesson: 15, title: 'Joelhadas', techniques: 'Joelhada frontal, joelhada lateral' },
                        { lesson: 16, title: 'Cotovelos', techniques: 'Cotovelo horizontal, cotovelo vertical' },
                        { lesson: 17, title: 'Combina√ß√µes de Golpes', techniques: 'Sequ√™ncias de socos e chutes' },
                        { lesson: 18, title: 'Trabalho de Foco', techniques: 'Precis√£o, timing, dist√¢ncia' },
                        { lesson: 19, title: 'Sparring Controlado', techniques: 'Aplica√ß√£o em combate controlado' },
                        { lesson: 20, title: 'Avalia√ß√£o de Golpes', techniques: 'Teste de t√©cnicas de ataque' }
                    ],
                    color: '#3B82F6'
                },
                'defesas': {
                    name: 'Defesas B√°sicas',
                    lessons: [
                        { lesson: 21, title: 'Defesas contra Socos', techniques: 'Bloqueios, desvios de socos' },
                        { lesson: 22, title: 'Defesas contra Chutes', techniques: 'Bloqueios de chutes, esquivas' },
                        { lesson: 23, title: 'Defesas contra Agarramentos', techniques: 'Liberta√ß√£o de agarramentos' },
                        { lesson: 24, title: 'Defesas contra Enforcamentos', techniques: 'Defesa contra enforcamento frontal' },
                        { lesson: 25, title: 'Defesas contra Empurr√µes', techniques: 'Recupera√ß√£o de equil√≠brio' },
                        { lesson: 26, title: 'Defesas contra Tapas', techniques: 'Bloqueios e contra-ataques' },
                        { lesson: 27, title: 'Defesas Combinadas', techniques: 'Defesa + contra-ataque' },
                        { lesson: 28, title: 'Mobilidade Defensiva', techniques: 'Movimenta√ß√£o defensiva' },
                        { lesson: 29, title: 'Timing Defensivo', techniques: 'Momento certo para defesa' },
                        { lesson: 30, title: 'Avalia√ß√£o de Defesas', techniques: 'Teste de defesas b√°sicas' }
                    ],
                    color: '#8B5CF6'
                },
                'avancadas': {
                    name: 'Defesas Avan√ßadas',
                    lessons: [
                        { lesson: 31, title: 'Defesas contra Armas Brancas', techniques: 'Defesa contra faca, estilete' },
                        { lesson: 32, title: 'Defesas contra Bast√µes', techniques: 'Defesa contra cassetete, vara' },
                        { lesson: 33, title: 'Defesas contra M√∫ltiplos Atacantes', techniques: 'Estrat√©gias de m√∫ltiplos oponentes' },
                        { lesson: 34, title: 'Defesas no Solo', techniques: 'Defesas ca√≠do, levantamento r√°pido' },
                        { lesson: 35, title: 'Defesas em Espa√ßos Confinados', techniques: 'Combate em elevador, corredor' },
                        { lesson: 36, title: 'Defesas contra Agarramentos Avan√ßados', techniques: 'Mata-le√£o, guilhotina' },
                        { lesson: 37, title: 'T√©cnicas de Finaliza√ß√£o', techniques: 'Imobiliza√ß√µes, pontos de press√£o' },
                        { lesson: 38, title: 'Psicologia de Combate', techniques: 'Controle emocional, tomada de decis√£o' },
                        { lesson: 39, title: 'Cen√°rios Reais', techniques: 'Simula√ß√µes de situa√ß√µes reais' },
                        { lesson: 40, title: 'Avalia√ß√£o Avan√ßada', techniques: 'Teste de t√©cnicas avan√ßadas' }
                    ],
                    color: '#F59E0B'
                },
                'integracao': {
                    name: 'Integra√ß√£o',
                    lessons: [
                        { lesson: 41, title: 'Integra√ß√£o de T√©cnicas', techniques: 'Combina√ß√£o de todas as t√©cnicas' },
                        { lesson: 42, title: 'Sparring Avan√ßado', techniques: 'Combate livre controlado' },
                        { lesson: 43, title: 'Defesa Pessoal Aplicada', techniques: 'Situa√ß√µes reais de autodefesa' },
                        { lesson: 44, title: 'Condicionamento Avan√ßado', techniques: 'Prepara√ß√£o f√≠sica intensa' },
                        { lesson: 45, title: 'T√°ticas de Sobreviv√™ncia', techniques: 'Estrat√©gias de fuga e escape' },
                        { lesson: 46, title: 'Exame Pr√°tico', techniques: 'Avalia√ß√£o pr√°tica completa' },
                        { lesson: 47, title: 'Demonstra√ß√£o de Habilidades', techniques: 'Apresenta√ß√£o de t√©cnicas dominadas' },
                        { lesson: 48, title: 'Cerim√¥nia de Gradua√ß√£o', techniques: 'Avalia√ß√£o final, certifica√ß√£o' }
                    ],
                    color: '#EF4444'
                }
            };
            
            const unitInfo = unitData[unit];
            if (!unitInfo) {
                console.error(`Unidade desconhecida: ${unit}`);
                return [];
            }
            
            return unitInfo.lessons.map(lesson => ({
                lessonNumber: lesson.lesson,
                weekNumber: Math.ceil(lesson.lesson / 2),
                title: lesson.title,
                unit: unitInfo.name,
                techniques: lesson.techniques,
                duration: '60 min',
                level: Math.min(Math.ceil(lesson.lesson / 10), 5),
                status: lesson.lesson <= 15 ? 'Conclu√≠da' : 'Pendente',
                statusColor: lesson.lesson <= 15 ? '#10B981' : '#6B7280'
            }));
        }

        // Display lesson plans in table
        function displayLessonPlans(plans) {
            const tbody = document.getElementById('lesson-plans-table-body');
            
            if (plans.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üì≠</div>
                            Nenhum plano de aula encontrado
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = plans.map(plan => `
                <tr style="border-left: 3px solid ${plan.statusColor};">
                    <td style="font-weight: bold; color: #F8FAFC;">${plan.lessonNumber}</td>
                    <td style="color: #CBD5E1;">${plan.weekNumber}</td>
                    <td style="color: #F8FAFC; font-weight: 500;">${plan.title}</td>
                    <td style="color: #CBD5E1;">${plan.unit}</td>
                    <td style="color: #CBD5E1; font-size: 0.85rem;">${plan.techniques}</td>
                    <td style="color: #CBD5E1;">${plan.duration}</td>
                    <td style="text-align: center;">
                        ${'‚≠ê'.repeat(plan.level)}
                    </td>
                    <td style="color: ${plan.statusColor}; font-weight: 500;">${plan.status}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn" onclick="viewLessonPlan(${plan.lessonNumber})" 
                                    style="background: #3B82F6; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                üëÅÔ∏è Ver
                            </button>
                            <button class="btn" onclick="editLessonPlan(${plan.lessonNumber})" 
                                    style="background: #F59E0B; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn" onclick="generateAIVariation(${plan.lessonNumber})" 
                                    style="background: #8B5CF6; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                ü§ñ IA
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // View lesson plan details
        function viewLessonPlan(lessonNumber) {
            showToast(`Visualizando plano da Aula ${lessonNumber}`, 'info');
            // TODO: Open lesson plan detail modal
        }

        // Edit lesson plan
        function editLessonPlan(lessonNumber) {
            showToast(`Editando plano da Aula ${lessonNumber}`, 'info');
            // TODO: Open lesson plan editor
        }

        // Generate AI variation
        function generateAIVariation(lessonNumber) {
            showToast(`Gerando varia√ß√£o IA para Aula ${lessonNumber}...`, 'info');
            // TODO: Call AI generation API
        }

        // Open AI lesson generator
        function openAILessonGenerator() {
            showToast('Gerador IA em desenvolvimento - Em breve!', 'info');
            // TODO: Open AI generator modal
        }

        // Show curriculum builder
        function showCurriculumBuilder() {
            showToast('Curriculum Builder em desenvolvimento', 'info');
        }

        // Show progress analytics
        function showProgressAnalytics() {
            showToast('Analytics em desenvolvimento', 'info');
        }

        // Export lesson plans
        function exportLessonPlans() {
            showToast('Exportando planos de aula...', 'info');
            // TODO: Generate PDF or CSV export
        }

        // Import lesson plans
        function importLessonPlans() {
            showToast('Importa√ß√£o em desenvolvimento', 'info');
            // TODO: File upload functionality
        }

        // Initialize course management when section loads
        window.addEventListener('load', () => {
            // Load lesson plans if course-management is the initial section
            if (window.location.hash === '#course-management') {
                setTimeout(() => loadAllLessonPlans(), 500);
            }
        });

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    </script>

    <!-- Techniques Manager Modal -->
    <div id="techniquesManagerModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>ü•ä Banco de Posi√ß√µes/T√©cnicas</h2>
                <button class="btn btn-secondary" onclick="closeTechniquesManagerModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 1.5rem;">
                    <!-- Stats Overview -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(59, 130, 246, 0.2); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #3B82F6;" id="totalTechniquesCount">42</div>
                            <div style="color: #CBD5E1; font-size: 0.9rem;">Total T√©cnicas</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.2); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #10B981;" id="categoriesCount">8</div>
                            <div style="color: #CBD5E1; font-size: 0.9rem;">Categorias</div>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.2); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #F59E0B;" id="coursesUsingCount">2</div>
                            <div style="color: #CBD5E1; font-size: 0.9rem;">Cursos Usando</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.2); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #8B5CF6;" id="reusedCount">15</div>
                            <div style="color: #CBD5E1; font-size: 0.9rem;">Reutilizadas</div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="text" id="techniqueSearch" placeholder="Buscar t√©cnica..." 
                                   style="padding: 0.5rem; border-radius: 6px; border: 1px solid #374151; background: rgba(55, 65, 81, 0.5); color: #F8FAFC; width: 300px;">
                            <select id="categoryFilter" style="padding: 0.5rem; border-radius: 6px; border: 1px solid #374151; background: rgba(55, 65, 81, 0.5); color: #F8FAFC;">
                                <option value="">Todas Categorias</option>
                                <option value="STANCE">Postura</option>
                                <option value="STRIKE">Golpes</option>
                                <option value="DEFENSE">Defesa</option>
                                <option value="GRAPPLING">Agarramento</option>
                                <option value="COMBO">Combina√ß√£o</option>
                                <option value="MOVEMENT">Movimenta√ß√£o</option>
                                <option value="SCENARIO">Cen√°rio</option>
                                <option value="CONDITIONING">Condicionamento</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="openAddTechniqueModal()">
                            <span>‚ûï</span> Nova T√©cnica
                        </button>
                    </div>

                    <!-- Techniques Table -->
                    <div style="border: 1px solid #374151; border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: rgba(55, 65, 81, 0.5);">
                                <tr>
                                    <th style="padding: 1rem; text-align: left; color: #F8FAFC; border-bottom: 1px solid #374151;">Nome</th>
                                    <th style="padding: 1rem; text-align: left; color: #F8FAFC; border-bottom: 1px solid #374151;">Categoria</th>
                                    <th style="padding: 1rem; text-align: left; color: #F8FAFC; border-bottom: 1px solid #374151;">N√≠vel</th>
                                    <th style="padding: 1rem; text-align: left; color: #F8FAFC; border-bottom: 1px solid #374151;">Usado em</th>
                                    <th style="padding: 1rem; text-align: left; color: #F8FAFC; border-bottom: 1px solid #374151;">Pr√©-requisitos</th>
                                    <th style="padding: 1rem; text-align: center; color: #F8FAFC; border-bottom: 1px solid #374151;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="techniquesTableBody" style="color: #CBD5E1;">
                                <tr>
                                    <td colspan="6" style="padding: 2rem; text-align: center;">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚è≥</div>
                                        Carregando t√©cnicas...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Technique Modal -->
    <div id="addTechniqueModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>‚ûï Adicionar Nova T√©cnica</h2>
                <button class="btn btn-secondary" onclick="closeAddTechniqueModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="addTechniqueForm" style="display: grid; gap: 1rem;">
                    <div class="form-group">
                        <label for="techniqueName">Nome da T√©cnica *</label>
                        <input type="text" id="techniqueName" required placeholder="Ex: Defesa 360¬∞ Superior">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="techniqueCategory">Categoria *</label>
                            <select id="techniqueCategory" required>
                                <option value="">Selecione</option>
                                <option value="STANCE">ü•ã Postura</option>
                                <option value="STRIKE">üëä Golpes</option>
                                <option value="DEFENSE">üõ°Ô∏è Defesa</option>
                                <option value="GRAPPLING">ü§º Agarramento</option>
                                <option value="COMBO">‚ö° Combina√ß√£o</option>
                                <option value="MOVEMENT">üèÉ Movimenta√ß√£o</option>
                                <option value="SCENARIO">üé≠ Cen√°rio</option>
                                <option value="CONDITIONING">üí™ Condicionamento</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="techniqueLevel">N√≠vel *</label>
                            <select id="techniqueLevel" required>
                                <option value="BEGINNER">‚≠ê Iniciante</option>
                                <option value="INTERMEDIATE">‚≠ê‚≠ê Intermedi√°rio</option>
                                <option value="ADVANCED">‚≠ê‚≠ê‚≠ê Avan√ßado</option>
                                <option value="EXPERT">‚≠ê‚≠ê‚≠ê‚≠ê Expert</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="techniqueDescription">Descri√ß√£o</label>
                        <textarea id="techniqueDescription" rows="3" placeholder="Descri√ß√£o detalhada da t√©cnica..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="techniqueInstructions">Instru√ß√µes Passo a Passo</label>
                        <textarea id="techniqueInstructions" rows="4" placeholder="1. Posi√ß√£o inicial...&#10;2. Movimento principal...&#10;3. Finaliza√ß√£o..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="techniquePrerequisites">Pr√©-requisitos (opcional)</label>
                        <input type="text" id="techniquePrerequisites" placeholder="Ex: Guarda de Boxe, Movimenta√ß√£o B√°sica">
                    </div>

                    <div class="form-group">
                        <label for="techniqueKeyPoints">Pontos-Chave</label>
                        <textarea id="techniqueKeyPoints" rows="3" placeholder="Aspectos importantes para execu√ß√£o correta..."></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="techniqueEquipment">Equipamentos</label>
                            <input type="text" id="techniqueEquipment" placeholder="Ex: Tatame, Pads, Luvas">
                        </div>
                        <div class="form-group">
                            <label for="techniqueDuration">Dura√ß√£o (minutos)</label>
                            <input type="number" id="techniqueDuration" min="1" max="60" value="10">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddTechniqueModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveTechnique()">
                    <span>üíæ</span> Salvar T√©cnica
                </button>
            </div>
        </div>
    </div>

    <!-- Universal Course Creator Modal -->
    <div id="universalCourseModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>üé≠ Criador Universal de Cursos</h2>
                <button class="btn btn-secondary" onclick="closeUniversalCourseModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 2rem;">
                    <!-- Martial Art & Level Selection -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ü•ã Arte Marcial e N√≠vel</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="martialArt">Arte Marcial *</label>
                                    <select id="martialArt" required onchange="updateTechniquesForArt()">
                                        <option value="">Selecione</option>
                                        <option value="KRAV_MAGA">ü•ä Krav Maga</option>
                                        <option value="JIU_JITSU">ü•ã Jiu-Jitsu</option>
                                        <option value="BOXING">üëä Boxe</option>
                                        <option value="MUAY_THAI">ü¶µ Muay Thai</option>
                                        <option value="KARATE">ü•ã Karat√™</option>
                                        <option value="TAEKWONDO">ü¶µ Taekwondo</option>
                                        <option value="MMA">ü•ä MMA</option>
                                        <option value="CAPOEIRA">ü§∏ Capoeira</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="beltLevel">Faixa/N√≠vel *</label>
                                    <select id="beltLevel" required onchange="updateBeltInfo()">
                                        <option value="">Primeiro selecione a arte</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="courseGraduation">Gradua√ß√£o/Grau</label>
                                    <select id="courseGraduation">
                                        <option value="">Sem gradua√ß√£o</option>
                                        <option value="1">1¬∫ Grau</option>
                                        <option value="2">2¬∫ Grau</option>
                                        <option value="3">3¬∫ Grau</option>
                                        <option value="4">4¬∫ Grau</option>
                                        <option value="5">5¬∫ Grau</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="beltInfo" style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #3B82F6; display: none;">
                                <div id="beltInfoContent"></div>
                            </div>
                        </div>
                    </div>

                    <!-- RAG Status Indicator -->
                    <div id="ragStatus" style="margin-bottom: 1rem;">
                        <!-- RAG status will be populated dynamically -->
                    </div>
                    
                    <!-- Course Basic Info -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üìö Informa√ß√µes do Curso</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="universalCourseTitle">Nome do Curso *</label>
                                    <input type="text" id="universalCourseTitle" placeholder="Ex: Jiu-Jitsu Faixa Azul - T√©cnicas Avan√ßadas" required>
                                </div>
                                <div class="form-group">
                                    <label for="universalCourseDuration">Dura√ß√£o (semanas) *</label>
                                    <input type="number" id="universalCourseDuration" value="20" min="4" max="52" required>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="universalCourseLevel">N√≠vel de Dificuldade</label>
                                    <select id="universalCourseLevel">
                                        <option value="BEGINNER">‚≠ê Iniciante</option>
                                        <option value="INTERMEDIATE">‚≠ê‚≠ê Intermedi√°rio</option>
                                        <option value="ADVANCED">‚≠ê‚≠ê‚≠ê Avan√ßado</option>
                                        <option value="EXPERT">‚≠ê‚≠ê‚≠ê‚≠ê Expert</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="lessonsPerWeekUniversal">Aulas por Semana</label>
                                    <select id="lessonsPerWeekUniversal">
                                        <option value="1">1 aula</option>
                                        <option value="2" selected>2 aulas</option>
                                        <option value="3">3 aulas</option>
                                        <option value="4">4 aulas</option>
                                        <option value="5">5 aulas</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="universalCourseObjectives">Objetivos do Curso</label>
                                <textarea id="universalCourseObjectives" rows="3" placeholder="Descreva os objetivos principais do curso..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Technique Selection -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ü•ä Sele√ß√£o de T√©cnicas</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #3B82F6;">
                                <h4 style="color: #3B82F6; margin-bottom: 0.5rem;">üí° Estrat√©gia de Sele√ß√£o</h4>
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1;">
                                        <input type="radio" name="selectionStrategy" value="reuse" checked>
                                        <span>üîÑ Reutilizar do Faixa Branca + Novas</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1;">
                                        <input type="radio" name="selectionStrategy" value="fresh">
                                        <span>üÜï Sele√ß√£o Completamente Nova</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1;">
                                        <input type="radio" name="selectionStrategy" value="custom">
                                        <span>‚öôÔ∏è Sele√ß√£o Manual</span>
                                    </label>
                                </div>
                            </div>

                            <div id="techniqueSelectionArea" style="border: 1px solid #374151; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                                <div style="padding: 2rem; text-align: center; color: #CBD5E1;">
                                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üéØ</div>
                                    Carregando banco de t√©cnicas para sele√ß√£o...
                                </div>
                            </div>

                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="color: #F59E0B; font-weight: bold;">T√©cnicas Selecionadas:</span>
                                    <span id="selectedTechniquesCount" style="color: #F8FAFC;">0</span>
                                </div>
                                <div id="selectedTechniquesList" style="color: #CBD5E1; font-size: 0.9rem;">
                                    Nenhuma t√©cnica selecionada ainda
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Document Upload for Yellow Belt -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üìÑ Seu Modelo de Curso</h3>
                        <div style="border: 2px dashed #374151; border-radius: 12px; padding: 2rem; text-align: center; background: rgba(55, 65, 81, 0.3);">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
                            <input type="file" id="courseModelFile" accept=".pdf,.doc,.docx,.txt,.md" 
                                   style="display: none;" onchange="handleCourseModelUpload(event)">
                            <button type="button" onclick="document.getElementById('yellowBeltModel').click()" 
                                    style="background: #F59E0B; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; margin-bottom: 1rem;">
                                üìé Upload Modelo de Curso
                            </button>
                            <p style="color: #CBD5E1; font-size: 0.9rem;">
                                Fa√ßa upload do seu modelo de curso (opcional)<br>
                                A IA usar√° este documento para estruturar o curso
                            </p>
                            <div id="courseModelFileInfo" style="margin-top: 1rem;"></div>
                        </div>
                    </div>

                    <!-- AI Configuration -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">ü§ñ Configura√ß√£o da IA</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">üéØ Gerar Planos de Aula</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="universalGeneratePlans" checked>
                                    <span style="color: #CBD5E1;">Gerar automaticamente todos os planos</span>
                                </div>
                            </div>
                            <div>
                                <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">ü§ñ Modelo IA</label>
                                <select id="universalAiModel" style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #374151; background: rgba(55, 65, 81, 0.5); color: #F8FAFC;">
                                    <option value="claude-3">Claude 3 (Recomendado)</option>
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="gemini">Gemini</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="color: #CBD5E1; font-size: 0.9rem;">
                        ‚è±Ô∏è Tempo estimado: 5-8 minutos
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="closeUniversalCourseModal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="createUniversalCourse()" id="createUniversalBtn">
                            <span>üé≠</span> Criar Curso
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Technique Audit Modal -->
    <div id="techniqueAuditModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>üîç Auditoria de T√©cnica</h2>
                <button class="btn btn-secondary" onclick="closeTechniqueAuditModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="techniqueAuditContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="approveTechnique()" id="approveBtn">
                    <span>‚úÖ</span> Aprovar
                </button>
                <button class="btn btn-warning" onclick="editTechnique()" id="editBtn" style="margin-left: 1rem;">
                    <span>‚úèÔ∏è</span> Editar
                </button>
                <button class="btn btn-danger" onclick="rejectTechnique()" id="rejectBtn" style="margin-left: 1rem;">
                    <span>‚ùå</span> Rejeitar
                </button>
                <button class="btn btn-secondary" onclick="closeTechniqueAuditModal()" style="margin-left: 1rem;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Video Upload Modal -->
    <div id="videoUploadModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üìπ Upload de V√≠deo - T√©cnica</h2>
                <button class="btn btn-secondary" onclick="closeVideoUploadModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 1.5rem;">
                    <div id="videoTechniqueInfo" style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                        <!-- Technique info will be shown here -->
                    </div>
                    
                    <div style="border: 2px dashed #374151; border-radius: 12px; padding: 2rem; text-align: center; background: rgba(55, 65, 81, 0.3);">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìπ</div>
                        <input type="file" id="techniqueVideo" accept="video/*" 
                               style="display: none;" onchange="handleVideoUpload(event)">
                        <button type="button" onclick="document.getElementById('techniqueVideo').click()" 
                                style="background: #3B82F6; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; margin-bottom: 1rem;">
                            üìé Selecionar V√≠deo
                        </button>
                        <p style="color: #CBD5E1; font-size: 0.9rem;">
                            Formatos aceitos: MP4, AVI, MOV<br>
                            Tamanho m√°ximo: 100MB
                        </p>
                        <div id="videoPreview" style="margin-top: 1rem;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="videoDescription">Descri√ß√£o do V√≠deo</label>
                        <textarea id="videoDescription" rows="3" placeholder="Descreva o que est√° sendo demonstrado no v√≠deo..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="uploadVideo()" id="uploadVideoBtn">
                    <span>üöÄ</span> Upload V√≠deo
                </button>
                <button class="btn btn-secondary" onclick="closeVideoUploadModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Document Uploader Modal -->
    <div id="documentUploaderModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>üìé Adicionar Conte√∫do √† Base de Conhecimento</h2>
                <button class="btn btn-secondary" onclick="closeDocumentUploader()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 2rem;">
                    
                    <!-- Upload Tabs -->
                    <div style="display: flex; gap: 1rem; border-bottom: 1px solid #374151; padding-bottom: 1rem;">
                        <button class="upload-tab active" onclick="switchUploadTab('documents')" id="documentsTab">
                            üìÑ Documentos
                        </button>
                        <button class="upload-tab" onclick="switchUploadTab('text')" id="textTab">
                            üìù Texto Manual
                        </button>
                        <button class="upload-tab" onclick="switchUploadTab('links')" id="linksTab">
                            üîó Links/URLs
                        </button>
                        <button class="upload-tab" onclick="switchUploadTab('youtube')" id="youtubeTab">
                            üì∫ YouTube
                        </button>
                    </div>
                    
                    <!-- Document Upload Section -->
                    <div id="documentsSection" class="upload-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üìÑ Upload de Documentos</h3>
                        <div style="border: 2px dashed #374151; border-radius: 12px; padding: 2rem; text-align: center; background: rgba(55, 65, 81, 0.3);">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üìÅ</div>
                            <input type="file" id="documentFiles" multiple accept=".pdf,.doc,.docx,.txt,.md,.rtf" 
                                   style="display: none;" onchange="handleDocumentUpload(event)">
                            <button type="button" onclick="document.getElementById('documentFiles').click()" 
                                    style="background: #8B5CF6; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; margin-bottom: 1rem;">
                                üìé Selecionar Documentos
                            </button>
                            <p style="color: #CBD5E1; font-size: 0.9rem;">
                                Formatos aceitos: PDF, DOC, DOCX, TXT, MD, RTF<br>
                                M√∫ltiplos arquivos permitidos ‚Ä¢ Tamanho m√°ximo: 50MB por arquivo
                            </p>
                            <div id="documentPreview" style="margin-top: 1rem;"></div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 1rem;">
                            <label for="documentTags">Tags (separadas por v√≠rgula)</label>
                            <input type="text" id="documentTags" placeholder="krav-maga, defesa-pessoal, iniciante, faixa-branca">
                        </div>
                    </div>
                    
                    <!-- Text Input Section -->
                    <div id="textSection" class="upload-section" style="display: none;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üìù Adicionar Texto Manual</h3>
                        <div class="form-group">
                            <label for="textTitle">T√≠tulo do Conte√∫do *</label>
                            <input type="text" id="textTitle" placeholder="Ex: Princ√≠pios Fundamentais do Krav Maga" required>
                        </div>
                        <div class="form-group">
                            <label for="textContent">Conte√∫do *</label>
                            <textarea id="textContent" rows="12" placeholder="Cole aqui seu conte√∫do de texto, manuais, instru√ß√µes, metodologias..." required></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="textCategory">Categoria</label>
                                <select id="textCategory">
                                    <option value="">Selecione</option>
                                    <option value="METHODOLOGY">Metodologia</option>
                                    <option value="TECHNIQUES">T√©cnicas</option>
                                    <option value="THEORY">Teoria</option>
                                    <option value="SAFETY">Seguran√ßa</option>
                                    <option value="PROGRESSION">Progress√£o</option>
                                    <option value="EVALUATION">Avalia√ß√£o</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="textTags">Tags</label>
                                <input type="text" id="textTags" placeholder="defesa, ataque, movimento">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Links Section -->
                    <div id="linksSection" class="upload-section" style="display: none;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üîó Adicionar Links/URLs</h3>
                        <div class="form-group">
                            <label for="linkUrl">URL *</label>
                            <input type="url" id="linkUrl" placeholder="https://exemplo.com/artigo-sobre-krav-maga" required>
                        </div>
                        <div class="form-group">
                            <label for="linkTitle">T√≠tulo (opcional)</label>
                            <input type="text" id="linkTitle" placeholder="Ser√° extra√≠do automaticamente se n√£o preenchido">
                        </div>
                        <div class="form-group">
                            <label for="linkDescription">Descri√ß√£o</label>
                            <textarea id="linkDescription" rows="3" placeholder="Breve descri√ß√£o sobre o conte√∫do do link"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="linkTags">Tags</label>
                            <input type="text" id="linkTags" placeholder="artigo, externa, refer√™ncia">
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <div style="color: #3B82F6; font-weight: bold; margin-bottom: 0.5rem;">‚ÑπÔ∏è Extra√ß√£o Autom√°tica</div>
                            <div style="color: #CBD5E1; font-size: 0.9rem;">
                                O sistema ir√° extrair automaticamente o texto do site e indexar o conte√∫do.
                            </div>
                        </div>
                    </div>
                    
                    <!-- YouTube Section -->
                    <div id="youtubeSection" class="upload-section" style="display: none;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üì∫ V√≠deos do YouTube</h3>
                        <div class="form-group">
                            <label for="youtubeUrl">URL do YouTube *</label>
                            <input type="url" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=..." required>
                        </div>
                        <div class="form-group">
                            <label for="youtubeDescription">Descri√ß√£o do Conte√∫do</label>
                            <textarea id="youtubeDescription" rows="3" placeholder="Descreva o que √© abordado no v√≠deo"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="youtubeTags">Tags</label>
                            <input type="text" id="youtubeTags" placeholder="video, demonstra√ß√£o, tutorial">
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <div style="color: #F59E0B; font-weight: bold; margin-bottom: 0.5rem;">üéØ Extra√ß√£o de Transcri√ß√£o</div>
                            <div style="color: #CBD5E1; font-size: 0.9rem;">
                                O sistema ir√° extrair a transcri√ß√£o autom√°tica do v√≠deo (se dispon√≠vel) e indexar o conte√∫do.
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="uploadContent()" id="uploadContentBtn">
                    <span>üöÄ</span> Adicionar √† Base
                </button>
                <button class="btn btn-secondary" onclick="closeDocumentUploader()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- RAG Test Modal -->
    <div id="ragTestModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üß™ Teste do Sistema RAG</h2>
                <button class="btn btn-secondary" onclick="closeRAGTest()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 1.5rem;">
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                        <h4 style="color: #3B82F6; margin-bottom: 0.5rem;">üéØ Como Funciona o Teste</h4>
                        <div style="color: #CBD5E1; font-size: 0.9rem;">
                            Fa√ßa uma pergunta ou solicite informa√ß√µes. A IA ir√° buscar na sua base de conhecimento 
                            e retornar uma resposta baseada nos seus documentos.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ragQuestion">Sua Pergunta</label>
                        <textarea id="ragQuestion" rows="3" placeholder="Ex: Como ensinar defesa contra agarramento para iniciantes?"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="ragMartialArt">Arte Marcial (opcional)</label>
                            <select id="ragMartialArt">
                                <option value="">Todas</option>
                                <option value="KRAV_MAGA">Krav Maga</option>
                                <option value="JIU_JITSU">Jiu-Jitsu</option>
                                <option value="BOXING">Boxe</option>
                                <option value="MUAY_THAI">Muay Thai</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ragLevel">N√≠vel (opcional)</label>
                            <select id="ragLevel">
                                <option value="">Todos</option>
                                <option value="BEGINNER">Iniciante</option>
                                <option value="INTERMEDIATE">Intermedi√°rio</option>
                                <option value="ADVANCED">Avan√ßado</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="ragResults" style="min-height: 200px; background: rgba(55, 65, 81, 0.3); border-radius: 8px; padding: 1rem;">
                        <div style="text-align: center; color: #9CA3AF; padding: 2rem;">
                            Digite sua pergunta e clique em "Consultar RAG" para ver a resposta
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="consultRAG()" id="consultRAGBtn">
                    <span>üß†</span> Consultar RAG
                </button>
                <button class="btn btn-secondary" onclick="closeRAGTest()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- AI Course Generator Modal -->
    <div id="aiCourseGeneratorModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>üéØ Gerador IA de Curso Completo</h2>
                <button class="btn btn-secondary" onclick="closeAICourseGeneratorModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 2rem;">
                    <!-- Modo de Cria√ß√£o -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üéõÔ∏è Modo de Cria√ß√£o</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="creation-mode-card" onclick="selectCreationMode('scratch')" 
                                 style="padding: 1.5rem; border: 2px solid #374151; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üöÄ</div>
                                <h4 style="color: #F8FAFC; margin-bottom: 0.5rem;">Do Zero</h4>
                                <p style="color: #CBD5E1; font-size: 0.9rem;">IA cria tudo baseado apenas nas informa√ß√µes b√°sicas</p>
                            </div>
                            <div class="creation-mode-card" onclick="selectCreationMode('document')" 
                                 style="padding: 1.5rem; border: 2px solid #374151; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÑ</div>
                                <h4 style="color: #F8FAFC; margin-bottom: 0.5rem;">Com Documentos</h4>
                                <p style="color: #CBD5E1; font-size: 0.9rem;">IA usa documentos modelo, curriculums, planos existentes</p>
                            </div>
                        </div>
                        <input type="hidden" id="creationMode" value="">
                    </div>

                    <!-- Informa√ß√µes B√°sicas do Curso -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üìö Informa√ß√µes B√°sicas</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="courseTitle">Nome do Curso *</label>
                                    <input type="text" id="courseTitle" placeholder="Ex: Krav Maga Faixa Preta - Instrutor" required>
                                </div>
                                <div class="form-group">
                                    <label for="courseDuration">Dura√ß√£o (semanas) *</label>
                                    <input type="number" id="courseDuration" min="1" max="52" value="24" required>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="courseLevel">N√≠vel *</label>
                                    <select id="courseLevel" required>
                                        <option value="">Selecione</option>
                                        <option value="INICIANTE">Iniciante</option>
                                        <option value="INTERMEDIARIO">Intermedi√°rio</option>
                                        <option value="AVANCADO">Avan√ßado</option>
                                        <option value="INSTRUTOR">Instrutor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="courseCategory">Categoria *</label>
                                    <select id="courseCategory" required>
                                        <option value="">Selecione</option>
                                        <option value="ADULT">Adulto</option>
                                        <option value="KIDS">Infantil</option>
                                        <option value="TEEN">Adolescente</option>
                                        <option value="SENIOR">Terceira Idade</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="lessonsPerWeek">Aulas por Semana</label>
                                    <select id="lessonsPerWeek">
                                        <option value="1">1 aula</option>
                                        <option value="2" selected>2 aulas</option>
                                        <option value="3">3 aulas</option>
                                        <option value="4">4 aulas</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="courseObjectives">Objetivos Principais</label>
                                <textarea id="courseObjectives" rows="3" 
                                          placeholder="Ex: Desenvolver habilidades de defesa pessoal, aumentar condicionamento f√≠sico, preparar instrutores..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Upload de Documentos -->
                    <div class="form-section" id="documentSection" style="display: none;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üìÅ Documentos e Contexto</h3>
                        <div style="display: grid; gap: 1.5rem;">
                            
                            <!-- Templates Pr√©-definidos -->
                            <div>
                                <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">üéØ Templates Dispon√≠veis</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <button type="button" class="template-btn" onclick="loadTemplate('krav-maga-basic')" 
                                            style="padding: 0.75rem; background: rgba(59, 130, 246, 0.2); border: 1px solid #3B82F6; border-radius: 8px; color: #3B82F6; cursor: pointer;">
                                        ü•ã Krav Maga B√°sico
                                    </button>
                                    <button type="button" class="template-btn" onclick="loadTemplate('self-defense')" 
                                            style="padding: 0.75rem; background: rgba(16, 185, 129, 0.2); border: 1px solid #10B981; border-radius: 8px; color: #10B981; cursor: pointer;">
                                        üõ°Ô∏è Defesa Pessoal
                                    </button>
                                    <button type="button" class="template-btn" onclick="loadTemplate('instructor')" 
                                            style="padding: 0.75rem; background: rgba(245, 158, 11, 0.2); border: 1px solid #F59E0B; border-radius: 8px; color: #F59E0B; cursor: pointer;">
                                        üë®‚Äçüè´ Forma√ß√£o Instrutor
                                    </button>
                                </div>
                            </div>

                            <!-- Upload de Arquivos -->
                            <div>
                                <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">üìé Upload de Documentos</label>
                                <div style="border: 2px dashed #374151; border-radius: 12px; padding: 2rem; text-align: center; background: rgba(55, 65, 81, 0.3);">
                                    <div style="font-size: 2rem; margin-bottom: 1rem;">üìÅ</div>
                                    <input type="file" id="courseDocuments" multiple accept=".pdf,.doc,.docx,.txt,.md" 
                                           style="display: none;" onchange="handleFileUpload(event)">
                                    <button type="button" onclick="document.getElementById('courseDocuments').click()" 
                                            style="background: #3B82F6; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; margin-bottom: 1rem;">
                                        Selecionar Arquivos
                                    </button>
                                    <p style="color: #CBD5E1; font-size: 0.9rem;">
                                        Aceita: PDF, DOC, DOCX, TXT, MD<br>
                                        <strong>Sugest√µes:</strong> Curriculums, planos modelo, regulamentos, metodologias
                                    </p>
                                    <div id="uploadedFiles" style="margin-top: 1rem;"></div>
                                </div>
                            </div>

                            <!-- Contexto Adicional -->
                            <div>
                                <label for="additionalContext" style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">üí≠ Contexto Adicional</label>
                                <textarea id="additionalContext" rows="4" 
                                          placeholder="Informa√ß√µes espec√≠ficas: metodologia preferida, restri√ß√µes, adapta√ß√µes necess√°rias, experi√™ncias anteriores, cultura da academia, etc."
                                          style="width: 100%; padding: 1rem; background: rgba(55, 65, 81, 0.5); border: 1px solid #374151; border-radius: 8px; color: #F8FAFC;"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Configura√ß√µes Avan√ßadas -->
                    <div class="form-section">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">‚öôÔ∏è Configura√ß√µes Avan√ßadas</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">üéØ Gerar Planos de Aula</label>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="generateLessonPlans" checked>
                                        <span style="color: #CBD5E1;">Gerar automaticamente todos os planos de aula</span>
                                    </div>
                                </div>
                                <div>
                                    <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">üèÜ Incluir Avalia√ß√µes</label>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="includeEvaluations" checked>
                                        <span style="color: #CBD5E1;">Criar sistema de avalia√ß√µes e exames</span>
                                    </div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">üß© Adapta√ß√µes Especiais</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.25rem; color: #CBD5E1; margin-right: 1rem;">
                                            <input type="checkbox" name="adaptations" value="TEA">
                                            <span>TEA</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.25rem; color: #CBD5E1; margin-right: 1rem;">
                                            <input type="checkbox" name="adaptations" value="TDAH">
                                            <span>TDAH</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.25rem; color: #CBD5E1;">
                                            <input type="checkbox" name="adaptations" value="MOBILIDADE_REDUZIDA">
                                            <span>Mobilidade Reduzida</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label for="aiModel" style="color: #F8FAFC; margin-bottom: 0.5rem; display: block;">ü§ñ Modelo de IA</label>
                                    <select id="aiModel">
                                        <option value="gpt-4">GPT-4 (Mais criativo)</option>
                                        <option value="claude-3">Claude 3 (Mais estruturado)</option>
                                        <option value="gemini">Gemini (Balanceado)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="color: #CBD5E1; font-size: 0.9rem;">
                        ‚è±Ô∏è Tempo estimado: 3-5 minutos
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="closeAICourseGeneratorModal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="generateCourseWithAI()" id="generateCourseBtn">
                            <span>üéØ</span> Gerar Curso Completo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Lesson Generator Modal -->
    <div id="aiGeneratorModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>ü§ñ Gerador IA de Planos de Aula</h2>
                <button class="btn btn-secondary" onclick="closeAIGeneratorModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="aiGeneratorForm" style="display: grid; gap: 1.5rem;">
                    <div class="form-group">
                        <label for="aiLessonNumber">N√∫mero da Aula</label>
                        <input type="number" id="aiLessonNumber" min="1" max="48" value="16" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="aiLessonUnit">Unidade do Curriculum</label>
                        <select id="aiLessonUnit" required>
                            <option value="">Selecione uma unidade</option>
                            <option value="fundamentos">ü•ä Fundamentos (Aulas 1-10)</option>
                            <option value="golpes">üëä Golpes B√°sicos (Aulas 4-15)</option>
                            <option value="defesas">üõ°Ô∏è Defesas B√°sicas (Aulas 10-25)</option>
                            <option value="avancadas">‚öîÔ∏è Defesas Avan√ßadas (Aulas 25-35)</option>
                            <option value="integracao">üé≠ Integra√ß√£o (Aulas 35-48)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="aiMainTechnique">T√©cnica Principal</label>
                        <input type="text" id="aiMainTechnique" placeholder="Ex: Defesa 360¬∞ Interior" required>
                    </div>

                    <div class="form-group">
                        <label for="aiLessonObjectives">Objetivos da Aula</label>
                        <textarea id="aiLessonObjectives" rows="3" 
                                  placeholder="Ex: Desenvolver coordena√ß√£o motora, Aplicar t√©cnica em cen√°rio real..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="aiSpecialNeeds">Adapta√ß√µes Especiais</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1;">
                                <input type="checkbox" id="aiTEA" value="TEA">
                                <span>TEA</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1;">
                                <input type="checkbox" id="aiTDAH" value="TDAH">
                                <span>TDAH</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1;">
                                <input type="checkbox" id="aiMobilidade" value="MOBILIDADE_REDUZIDA">
                                <span>Mobilidade Reduzida</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="aiDifficulty">N√≠vel de Dificuldade</label>
                        <select id="aiDifficulty" required>
                            <option value="1">‚≠ê Iniciante</option>
                            <option value="2">‚≠ê‚≠ê Intermedi√°rio</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê Avan√ßado</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAIGeneratorModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="generateLessonPlanWithAI()">
                    <span>ü§ñ</span> Gerar Plano com IA
                </button>
            </div>
        </div>
    </div>

    <script>
        // Utility function to reduce console noise in production
        function logQuiet(message, ...args) {
            // Only log important messages to reduce noise
            if (message.includes('‚úÖ') || message.includes('‚ùå') || message.includes('‚ö†Ô∏è')) {
                console.log(message, ...args);
            }
        }

        // ==========================================
        // TECHNIQUES MANAGER FUNCTIONALITY
        // ==========================================

        let allTechniques = [];
        let selectedTechniques = [];
        let courseModelFile = null;
        let beltSystems = {};
        let auditResults = [];
        let pendingTechniques = [];
        
        // RAG System Variables (declared in main script section)

        // Open Techniques Manager Modal
        function openTechniquesManager() {
            document.getElementById('techniquesManagerModal').classList.add('active');
            loadTechniquesDatabase();
        }

        // Close Techniques Manager Modal
        function closeTechniquesManagerModal() {
            document.getElementById('techniquesManagerModal').classList.remove('active');
        }

        // Load techniques database
        async function loadTechniquesDatabase() {
            try {
                // Generate mock techniques based on existing course data
                allTechniques = generateMockTechniques();
                displayTechniquesTable(allTechniques);
                updateTechniquesStats();
            } catch (error) {
                console.error('Erro ao carregar t√©cnicas:', error);
                showToast('Erro ao carregar banco de t√©cnicas', 'error');
            }
        }

        // Generate mock techniques database with audit status
        function generateMockTechniques() {
            const techniques = [
                // Krav Maga - Beginner (Practitioner 1)
                { id: '1', name: 'Guarda de Boxe', category: 'STANCE', level: 'BEGINNER', martialArt: 'KRAV_MAGA', usedIn: ['Practitioner 1'], prerequisites: '', isPreviousLevel: false, status: 'APPROVED', videoUrl: null, auditScore: 98 },
                { id: '2', name: 'Jab (Soco Direto)', category: 'STRIKE', level: 'BEGINNER', martialArt: 'KRAV_MAGA', usedIn: ['Practitioner 1'], prerequisites: 'Guarda de Boxe', isPreviousLevel: false, status: 'APPROVED', videoUrl: null, auditScore: 95 },
                { id: '3', name: 'Cross (Soco Cruzado)', category: 'STRIKE', level: 'BEGINNER', martialArt: 'KRAV_MAGA', usedIn: ['Practitioner 1'], prerequisites: 'Guarda de Boxe, Jab', isPreviousLevel: false },
                { id: '4', name: 'Hook (Gancho)', category: 'STRIKE', level: 'BEGINNER', martialArt: 'KRAV_MAGA', usedIn: ['Practitioner 1'], prerequisites: 'Jab, Cross', isPreviousLevel: false },
                { id: '5', name: 'Uppercut', category: 'STRIKE', level: 'BEGINNER', martialArt: 'KRAV_MAGA', usedIn: ['Practitioner 1'], prerequisites: 'Hook', isPreviousLevel: false },
                { id: '6', name: 'Defesa 360¬∞ Interior', category: 'DEFENSE', level: 'BEGINNER', usedIn: ['Faixa Branca'], prerequisites: 'Guarda de Boxe', isFromWhiteBelt: true },
                { id: '7', name: 'Defesa 360¬∞ Exterior', category: 'DEFENSE', level: 'BEGINNER', usedIn: ['Faixa Branca'], prerequisites: 'Defesa 360¬∞ Interior', isFromWhiteBelt: true },
                { id: '8', name: 'Joelhada Frontal', category: 'STRIKE', level: 'BEGINNER', usedIn: ['Faixa Branca'], prerequisites: 'Guarda de Boxe', isFromWhiteBelt: true },
                { id: '9', name: 'Chute Frontal', category: 'STRIKE', level: 'BEGINNER', usedIn: ['Faixa Branca'], prerequisites: 'Joelhada Frontal', isFromWhiteBelt: true },
                { id: '10', name: 'Esquiva Lateral', category: 'MOVEMENT', level: 'BEGINNER', usedIn: ['Faixa Branca'], prerequisites: 'Movimenta√ß√£o B√°sica', isFromWhiteBelt: true },
                
                // Jiu-Jitsu techniques
                { id: '23', name: 'Closed Guard', category: 'GRAPPLING', level: 'BEGINNER', martialArt: 'JIU_JITSU', usedIn: ['White Belt'], prerequisites: '', isPreviousLevel: false },
                { id: '24', name: 'Armbar from Guard', category: 'GRAPPLING', level: 'INTERMEDIATE', martialArt: 'JIU_JITSU', usedIn: ['Blue Belt'], prerequisites: 'Closed Guard', isPreviousLevel: false },
                { id: '25', name: 'Triangle Choke', category: 'GRAPPLING', level: 'INTERMEDIATE', martialArt: 'JIU_JITSU', usedIn: ['Blue Belt'], prerequisites: 'Closed Guard', isPreviousLevel: false },
                
                // Boxing techniques
                { id: '26', name: 'Orthodox Stance', category: 'STANCE', level: 'BEGINNER', martialArt: 'BOXING', usedIn: ['Beginner'], prerequisites: '', isPreviousLevel: false },
                { id: '27', name: 'Slip and Counter', category: 'COMBO', level: 'INTERMEDIATE', martialArt: 'BOXING', usedIn: ['Amateur'], prerequisites: 'Orthodox Stance, Jab', isPreviousLevel: false },
                
                // Muay Thai techniques
                { id: '28', name: 'Fighting Stance', category: 'STANCE', level: 'BEGINNER', martialArt: 'MUAY_THAI', usedIn: ['White Prajioud'], prerequisites: '', isPreviousLevel: false },
                { id: '29', name: 'Roundhouse Kick', category: 'STRIKE', level: 'INTERMEDIATE', martialArt: 'MUAY_THAI', usedIn: ['Yellow Prajioud'], prerequisites: 'Fighting Stance', isPreviousLevel: false },
                
                // General techniques (work for all martial arts)
                { id: '30', name: 'Basic Conditioning', category: 'CONDITIONING', level: 'BEGINNER', martialArt: 'GENERAL', usedIn: ['All Levels'], prerequisites: '', isPreviousLevel: false },
                { id: '31', name: 'Situational Awareness', category: 'SCENARIO', level: 'BEGINNER', martialArt: 'GENERAL', usedIn: ['All Levels'], prerequisites: '', isPreviousLevel: false },
                
                // Krav Maga - Intermediate
                { id: '11', name: 'Defesa 360¬∞ Superior', category: 'DEFENSE', level: 'INTERMEDIATE', martialArt: 'KRAV_MAGA', usedIn: [], prerequisites: 'Defesa 360¬∞ Interior, Defesa 360¬∞ Exterior', isPreviousLevel: false },
                { id: '12', name: 'Combo Jab-Cross-Hook', category: 'COMBO', level: 'INTERMEDIATE', martialArt: 'KRAV_MAGA', usedIn: [], prerequisites: 'Jab, Cross, Hook', isPreviousLevel: false },
                { id: '13', name: 'Defesa contra Agarramento de Ombros', category: 'DEFENSE', level: 'INTERMEDIATE', martialArt: 'KRAV_MAGA', usedIn: [], prerequisites: 'Defesa 360¬∞', isPreviousLevel: false },
                { id: '14', name: 'Cotovelo Horizontal', category: 'STRIKE', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Joelhada Frontal', isFromWhiteBelt: false },
                { id: '15', name: 'Chute Lateral', category: 'STRIKE', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Chute Frontal', isFromWhiteBelt: false },
                { id: '16', name: 'Defesa contra Estrangulamento Lateral', category: 'DEFENSE', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Defesa contra Estrangulamento Frontal', isFromWhiteBelt: false },
                { id: '17', name: 'Libera√ß√£o de Pegada no Punho', category: 'DEFENSE', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Movimenta√ß√£o B√°sica', isFromWhiteBelt: false },
                { id: '18', name: 'Defesa contra Empurr√£o', category: 'DEFENSE', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Esquiva Lateral', isFromWhiteBelt: false },
                { id: '19', name: 'Joelhada Diagonal', category: 'STRIKE', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Joelhada Frontal', isFromWhiteBelt: false },
                { id: '20', name: 'Combo Defesa-Contra-Ataque', category: 'COMBO', level: 'INTERMEDIATE', usedIn: [], prerequisites: 'Defesa 360¬∞, Jab-Cross', isFromWhiteBelt: false },
                
                // Avan√ßadas para futuras faixas
                { id: '21', name: 'Defesa contra M√∫ltiplos Atacantes', category: 'SCENARIO', level: 'ADVANCED', martialArt: 'KRAV_MAGA', usedIn: [], prerequisites: 'Combo Defesa-Contra-Ataque', isPreviousLevel: false },
                { id: '22', name: 'Finaliza√ß√£o e Fuga', category: 'SCENARIO', level: 'ADVANCED', martialArt: 'KRAV_MAGA', usedIn: [], prerequisites: 'Defesa contra M√∫ltiplos Atacantes', isPreviousLevel: false }
            ];

            return techniques.map(tech => ({
                ...tech,
                description: generateTechniqueDescription(tech),
                instructions: generateTechniqueInstructions(tech),
                keyPoints: generateTechniqueKeyPoints(tech),
                equipment: generateTechniqueEquipment(tech.category),
                duration: getTechniqueDuration(tech.level),
                // Audit fields
                status: tech.status || 'PENDING',
                auditScore: tech.auditScore || null,
                duplicateOf: null,
                qualityIssues: [],
                videoUrl: tech.videoUrl || null,
                createdAt: new Date().toISOString(),
                lastAuditAt: tech.status === 'APPROVED' ? new Date().toISOString() : null
            }));
        }

        // Display techniques table
        function displayTechniquesTable(techniques) {
            const tbody = document.getElementById('techniquesTableBody');
            
            if (techniques.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 2rem; text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üîç</div>
                            Nenhuma t√©cnica encontrada
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = techniques.map(tech => `
                <tr style="border-bottom: 1px solid #374151;">
                    <td style="padding: 1rem;">
                        <div style="font-weight: bold; color: #F8FAFC; margin-bottom: 0.25rem;">${tech.name}</div>
                        <div style="font-size: 0.8rem; color: #9CA3AF;">${tech.description}</div>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="background: ${getCategoryColor(tech.category)}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                            ${getCategoryIcon(tech.category)} ${getCategoryName(tech.category)}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="color: ${getLevelColor(tech.level)};">
                            ${'‚≠ê'.repeat(getLevelStars(tech.level))} ${getLevelName(tech.level)}
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="color: #CBD5E1;">
                            ${tech.usedIn.length > 0 ? tech.usedIn.join(', ') : 'N√£o usado'}
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="color: #9CA3AF; font-size: 0.8rem;">
                            ${tech.prerequisites || 'Nenhum'}
                        </div>
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="viewTechniqueDetails('${tech.id}')" style="background: #3B82F6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">
                                üëÅÔ∏è
                            </button>
                            <button onclick="editTechnique('${tech.id}')" style="background: #F59E0B; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="deleteTechnique('${tech.id}')" style="background: #EF4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update techniques stats
        function updateTechniquesStats() {
            document.getElementById('totalTechniquesCount').textContent = allTechniques.length;
            document.getElementById('categoriesCount').textContent = new Set(allTechniques.map(t => t.category)).size;
            document.getElementById('coursesUsingCount').textContent = new Set(allTechniques.flatMap(t => t.usedIn)).size;
            document.getElementById('reusedCount').textContent = allTechniques.filter(t => t.usedIn.length > 0).length;
        }

        // Helper functions for technique display
        function getCategoryColor(category) {
            const colors = {
                'STANCE': '#3B82F6',
                'STRIKE': '#EF4444', 
                'DEFENSE': '#10B981',
                'GRAPPLING': '#8B5CF6',
                'COMBO': '#F59E0B',
                'MOVEMENT': '#06B6D4',
                'SCENARIO': '#EC4899',
                'CONDITIONING': '#84CC16'
            };
            return colors[category] || '#6B7280';
        }

        function getCategoryIcon(category) {
            const icons = {
                'STANCE': 'ü•ã',
                'STRIKE': 'üëä',
                'DEFENSE': 'üõ°Ô∏è',
                'GRAPPLING': 'ü§º',
                'COMBO': '‚ö°',
                'MOVEMENT': 'üèÉ',
                'SCENARIO': 'üé≠',
                'CONDITIONING': 'üí™'
            };
            return icons[category] || 'ü•ä';
        }

        function getCategoryName(category) {
            const names = {
                'STANCE': 'Postura',
                'STRIKE': 'Golpe',
                'DEFENSE': 'Defesa',
                'GRAPPLING': 'Agarramento',
                'COMBO': 'Combina√ß√£o',
                'MOVEMENT': 'Movimento',
                'SCENARIO': 'Cen√°rio',
                'CONDITIONING': 'Condicionamento'
            };
            return names[category] || category;
        }

        function getLevelColor(level) {
            const colors = {
                'BEGINNER': '#10B981',
                'INTERMEDIATE': '#F59E0B',
                'ADVANCED': '#EF4444',
                'EXPERT': '#8B5CF6'
            };
            return colors[level] || '#6B7280';
        }

        function getLevelStars(level) {
            const stars = {
                'BEGINNER': 1,
                'INTERMEDIATE': 2,
                'ADVANCED': 3,
                'EXPERT': 4
            };
            return stars[level] || 1;
        }

        function getLevelName(level) {
            const names = {
                'BEGINNER': 'Iniciante',
                'INTERMEDIATE': 'Intermedi√°rio',
                'ADVANCED': 'Avan√ßado',
                'EXPERT': 'Expert'
            };
            return names[level] || level;
        }

        // Generate technique details
        function generateTechniqueDescription(tech) {
            const descriptions = {
                'STANCE': 'Posi√ß√£o fundamental para execu√ß√£o de t√©cnicas',
                'STRIKE': 'T√©cnica de ataque direcionada para neutralizar amea√ßas',
                'DEFENSE': 'Movimento defensivo para prote√ß√£o contra ataques',
                'GRAPPLING': 'T√©cnica de combate pr√≥ximo e controle corporal',
                'COMBO': 'Sequ√™ncia combinada de movimentos t√©cnicos',
                'MOVEMENT': 'Padr√£o de movimenta√ß√£o e posicionamento',
                'SCENARIO': 'Aplica√ß√£o pr√°tica em situa√ß√µes real√≠sticas',
                'CONDITIONING': 'Exerc√≠cio para desenvolvimento f√≠sico espec√≠fico'
            };
            return descriptions[tech.category] || 'T√©cnica de Krav Maga';
        }

        function generateTechniqueInstructions(tech) {
            return `1. Posi√ß√£o inicial: ${tech.prerequisites ? 'A partir de ' + tech.prerequisites : 'Postura neutra'}\n2. Execu√ß√£o da t√©cnica ${tech.name}\n3. Finaliza√ß√£o em posi√ß√£o segura\n4. Retorno √† guarda`;
        }

        function generateTechniqueKeyPoints(tech) {
            return `Manter postura correta, aplicar for√ßa adequada, precis√£o na execu√ß√£o, fluidez do movimento`;
        }

        function generateTechniqueEquipment(category) {
            const equipment = {
                'STANCE': 'Tatame',
                'STRIKE': 'Tatame, Pads de foco',
                'DEFENSE': 'Tatame, Equipamento de prote√ß√£o',
                'GRAPPLING': 'Tatame, Prote√ß√µes',
                'COMBO': 'Tatame, Pads, Luvas',
                'MOVEMENT': 'Tatame, Espa√ßo amplo',
                'SCENARIO': 'Tatame, Equipamentos variados',
                'CONDITIONING': 'Tatame, Equipamentos de treino'
            };
            return equipment[category] || 'Tatame';
        }

        function getTechniqueDuration(level) {
            const durations = {
                'BEGINNER': 10,
                'INTERMEDIATE': 15,
                'ADVANCED': 20,
                'EXPERT': 25
            };
            return durations[level] || 10;
        }

        // Technique actions
        function viewTechniqueDetails(techniqueId) {
            const technique = allTechniques.find(t => t.id === techniqueId);
            if (technique) {
                showToast(`Visualizando: ${technique.name}`, 'info');
                // TODO: Open technique details modal
            }
        }

        function editTechnique(techniqueId) {
            const technique = allTechniques.find(t => t.id === techniqueId);
            if (technique) {
                showToast(`Editando: ${technique.name}`, 'info');
                // TODO: Open edit technique modal
            }
        }

        function deleteTechnique(techniqueId) {
            const technique = allTechniques.find(t => t.id === techniqueId);
            if (technique && confirm(`Deseja excluir a t√©cnica "${technique.name}"?`)) {
                allTechniques = allTechniques.filter(t => t.id !== techniqueId);
                displayTechniquesTable(allTechniques);
                updateTechniquesStats();
                showToast(`T√©cnica "${technique.name}" exclu√≠da`, 'success');
            }
        }

        // Add new technique
        function openAddTechniqueModal() {
            document.getElementById('addTechniqueModal').classList.add('active');
        }

        function closeAddTechniqueModal() {
            document.getElementById('addTechniqueModal').classList.remove('active');
            document.getElementById('addTechniqueForm').reset();
        }

        function saveTechnique() {
            const formData = {
                id: Date.now().toString(),
                name: document.getElementById('techniqueName').value,
                category: document.getElementById('techniqueCategory').value,
                level: document.getElementById('techniqueLevel').value,
                description: document.getElementById('techniqueDescription').value,
                instructions: document.getElementById('techniqueInstructions').value,
                prerequisites: document.getElementById('techniquePrerequisites').value,
                keyPoints: document.getElementById('techniqueKeyPoints').value,
                equipment: document.getElementById('techniqueEquipment').value,
                duration: parseInt(document.getElementById('techniqueDuration').value),
                usedIn: [],
                isFromWhiteBelt: false
            };

            if (!formData.name || !formData.category || !formData.level) {
                showToast('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }

            allTechniques.push(formData);
            displayTechniquesTable(allTechniques);
            updateTechniquesStats();
            closeAddTechniqueModal();
            showToast(`T√©cnica "${formData.name}" adicionada com sucesso!`, 'success');
        }

        // Search and filter techniques
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('techniqueSearch');
            const categoryFilter = document.getElementById('categoryFilter');

            if (searchInput) {
                searchInput.addEventListener('input', filterTechniques);
            }
            if (categoryFilter) {
                categoryFilter.addEventListener('change', filterTechniques);
            }
        });

        function filterTechniques() {
            const searchTerm = document.getElementById('techniqueSearch')?.value.toLowerCase() || '';
            const selectedCategory = document.getElementById('categoryFilter')?.value || '';

            let filteredTechniques = allTechniques.filter(tech => {
                const matchesSearch = tech.name.toLowerCase().includes(searchTerm) || 
                                    tech.description.toLowerCase().includes(searchTerm);
                const matchesCategory = !selectedCategory || tech.category === selectedCategory;
                
                return matchesSearch && matchesCategory;
            });

            displayTechniquesTable(filteredTechniques);
        }

        // ==========================================
        // UNIVERSAL COURSE CREATOR
        // ==========================================

        // Open Universal Course Creator (RAG-Enhanced)
        function openUniversalCourseCreator() {
            document.getElementById('universalCourseModal').classList.add('active');
            loadTechniqueSelectionArea();
            initializeBeltSystems();
            updateRAGStatus(); // Add RAG status update
        }

        // Close Universal Course Creator
        function closeUniversalCourseModal() {
            document.getElementById('universalCourseModal').classList.remove('active');
            selectedTechniques = [];
            courseModelFile = null;
            updateSelectedTechniquesList();
        }

        // Initialize belt systems for different martial arts
        function initializeBeltSystems() {
            beltSystems = {
                'KRAV_MAGA': {
                    name: 'Krav Maga',
                    levels: [
                        { value: 'PRACTITIONER_1', name: 'Practitioner 1', color: '#FFFFFF' },
                        { value: 'PRACTITIONER_2', name: 'Practitioner 2', color: '#FFD700' },
                        { value: 'PRACTITIONER_3', name: 'Practitioner 3', color: '#FFA500' },
                        { value: 'GRADUATE_1', name: 'Graduate 1', color: '#32CD32' },
                        { value: 'GRADUATE_2', name: 'Graduate 2', color: '#0000FF' },
                        { value: 'EXPERT_1', name: 'Expert 1', color: '#8B4513' },
                        { value: 'EXPERT_2', name: 'Expert 2', color: '#000000' }
                    ]
                },
                'JIU_JITSU': {
                    name: 'Jiu-Jitsu',
                    levels: [
                        { value: 'WHITE', name: 'Faixa Branca', color: '#FFFFFF' },
                        { value: 'BLUE', name: 'Faixa Azul', color: '#0000FF' },
                        { value: 'PURPLE', name: 'Faixa Roxa', color: '#800080' },
                        { value: 'BROWN', name: 'Faixa Marrom', color: '#8B4513' },
                        { value: 'BLACK', name: 'Faixa Preta', color: '#000000' }
                    ]
                },
                'BOXING': {
                    name: 'Boxe',
                    levels: [
                        { value: 'BEGINNER', name: 'Iniciante', color: '#FFFFFF' },
                        { value: 'AMATEUR', name: 'Amador', color: '#C0C0C0' },
                        { value: 'SEMI_PRO', name: 'Semi-Profissional', color: '#FFD700' },
                        { value: 'PROFESSIONAL', name: 'Profissional', color: '#000000' }
                    ]
                },
                'MUAY_THAI': {
                    name: 'Muay Thai',
                    levels: [
                        { value: 'WHITE', name: 'Prajioud Branco', color: '#FFFFFF' },
                        { value: 'YELLOW', name: 'Prajioud Amarelo', color: '#FFD700' },
                        { value: 'GREEN', name: 'Prajioud Verde', color: '#008000' },
                        { value: 'BLUE', name: 'Prajioud Azul', color: '#0000FF' },
                        { value: 'RED', name: 'Prajioud Vermelho', color: '#FF0000' },
                        { value: 'BLACK', name: 'Prajioud Preto', color: '#000000' }
                    ]
                },
                'KARATE': {
                    name: 'Karat√™',
                    levels: [
                        { value: 'WHITE', name: 'Faixa Branca', color: '#FFFFFF' },
                        { value: 'YELLOW', name: 'Faixa Amarela', color: '#FFD700' },
                        { value: 'ORANGE', name: 'Faixa Laranja', color: '#FFA500' },
                        { value: 'GREEN', name: 'Faixa Verde', color: '#008000' },
                        { value: 'BLUE', name: 'Faixa Azul', color: '#0000FF' },
                        { value: 'BROWN', name: 'Faixa Marrom', color: '#8B4513' },
                        { value: 'BLACK', name: 'Faixa Preta', color: '#000000' }
                    ]
                },
                'TAEKWONDO': {
                    name: 'Taekwondo',
                    levels: [
                        { value: 'WHITE', name: 'Faixa Branca', color: '#FFFFFF' },
                        { value: 'YELLOW', name: 'Faixa Amarela', color: '#FFD700' },
                        { value: 'GREEN', name: 'Faixa Verde', color: '#008000' },
                        { value: 'BLUE', name: 'Faixa Azul', color: '#0000FF' },
                        { value: 'RED', name: 'Faixa Vermelha', color: '#FF0000' },
                        { value: 'BLACK', name: 'Faixa Preta', color: '#000000' }
                    ]
                },
                'MMA': {
                    name: 'MMA',
                    levels: [
                        { value: 'BEGINNER', name: 'Iniciante', color: '#FFFFFF' },
                        { value: 'INTERMEDIATE', name: 'Intermedi√°rio', color: '#FFD700' },
                        { value: 'ADVANCED', name: 'Avan√ßado', color: '#FFA500' },
                        { value: 'PRO', name: 'Profissional', color: '#000000' }
                    ]
                },
                'CAPOEIRA': {
                    name: 'Capoeira',
                    levels: [
                        { value: 'CRUA', name: 'Cord√£o Cru', color: '#F5F5DC' },
                        { value: 'AMARELO', name: 'Cord√£o Amarelo', color: '#FFD700' },
                        { value: 'LARANJA', name: 'Cord√£o Laranja', color: '#FFA500' },
                        { value: 'AZUL', name: 'Cord√£o Azul', color: '#0000FF' },
                        { value: 'VERDE', name: 'Cord√£o Verde', color: '#008000' },
                        { value: 'ROXO', name: 'Cord√£o Roxo', color: '#800080' },
                        { value: 'MARROM', name: 'Cord√£o Marrom', color: '#8B4513' },
                        { value: 'VERMELHO', name: 'Cord√£o Vermelho', color: '#FF0000' }
                    ]
                }
            };
        }

        // Update belt options when martial art changes
        function updateTechniquesForArt() {
            const martialArt = document.getElementById('martialArt').value;
            const beltSelect = document.getElementById('beltLevel');
            
            // Clear belt options
            beltSelect.innerHTML = '<option value="">Selecione a faixa/n√≠vel</option>';
            
            if (martialArt && beltSystems[martialArt]) {
                const system = beltSystems[martialArt];
                system.levels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level.value;
                    option.textContent = level.name;
                    option.style.color = level.color === '#FFFFFF' ? '#000000' : level.color;
                    beltSelect.appendChild(option);
                });
            }
            
            // Update techniques based on martial art
            updateTechniqueSelectionStrategy();
        }

        // Update belt info display
        function updateBeltInfo() {
            const martialArt = document.getElementById('martialArt').value;
            const beltLevel = document.getElementById('beltLevel').value;
            const beltInfo = document.getElementById('beltInfo');
            const beltInfoContent = document.getElementById('beltInfoContent');
            
            if (martialArt && beltLevel && beltSystems[martialArt]) {
                const system = beltSystems[martialArt];
                const level = system.levels.find(l => l.value === beltLevel);
                
                if (level) {
                    beltInfoContent.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <div style="width: 30px; height: 20px; background: ${level.color}; border: 1px solid #374151; border-radius: 4px;"></div>
                            <div>
                                <div style="font-weight: bold; color: #F8FAFC;">${system.name} - ${level.name}</div>
                                <div style="color: #9CA3AF; font-size: 0.9rem;">Sistema de gradua√ß√£o selecionado</div>
                            </div>
                        </div>
                    `;
                    beltInfo.style.display = 'block';
                    
                    // Auto-populate course title
                    const titleField = document.getElementById('universalCourseTitle');
                    if (!titleField.value) {
                        titleField.value = `${system.name} ${level.name} - Curso Completo`;
                    }
                } else {
                    beltInfo.style.display = 'none';
                }
            } else {
                beltInfo.style.display = 'none';
            }
        }

        // Get martial art name
        function getMartialArtName(artCode) {
            return beltSystems[artCode]?.name || artCode;
        }

        // Load technique selection area
        function loadTechniqueSelectionArea() {
            if (allTechniques.length === 0) {
                allTechniques = generateMockTechniques();
            }

            updateTechniqueSelectionStrategy();
        }

        // Update technique selection based on strategy
        function updateTechniqueSelectionStrategy() {
            const strategy = document.querySelector('input[name="selectionStrategy"]:checked')?.value || 'reuse';
            const selectionArea = document.getElementById('techniqueSelectionArea');

            let techniquesToShow = [];

            const martialArt = document.getElementById('martialArt')?.value;
            const beltLevel = document.getElementById('beltLevel')?.value;
            
            // Filter techniques by martial art if selected
            let availableTechniques = allTechniques;
            if (martialArt) {
                availableTechniques = allTechniques.filter(t => 
                    t.martialArt === martialArt || t.martialArt === 'GENERAL'
                );
            }
            
            switch (strategy) {
                case 'reuse':
                    // Show techniques from previous belt level + new ones
                    const previousLevelTechniques = availableTechniques.filter(t => t.isPreviousLevel);
                    const newTechniques = availableTechniques.filter(t => !t.isPreviousLevel && t.level === 'INTERMEDIATE');
                    selectedTechniques = [...previousLevelTechniques];
                    techniquesToShow = newTechniques;
                    break;
                    
                case 'fresh':
                    // Show techniques appropriate for the belt level
                    selectedTechniques = [];
                    techniquesToShow = availableTechniques.filter(t => {
                        if (!beltLevel) return t.level === 'BEGINNER';
                        
                        if (beltLevel === 'WHITE' || beltLevel === 'PRACTITIONER_1' || beltLevel === 'BEGINNER' || beltLevel === 'CRUA') {
                            return t.level === 'BEGINNER';
                        } else if (beltLevel === 'BLACK' || beltLevel === 'EXPERT_1' || beltLevel === 'PRO' || beltLevel === 'VERMELHO') {
                            return t.level === 'ADVANCED' || t.level === 'EXPERT';
                        } else {
                            return t.level === 'INTERMEDIATE';
                        }
                    });
                    break;
                    
                case 'custom':
                    // Show all techniques for manual selection
                    selectedTechniques = [];
                    techniquesToShow = availableTechniques;
                    break;
            }

            displayTechniqueSelection(techniquesToShow, strategy);
            updateSelectedTechniquesList();
        }

        // Display technique selection interface
        function displayTechniqueSelection(techniques, strategy) {
            const selectionArea = document.getElementById('techniqueSelectionArea');
            
            let content = '';
            
            if (strategy === 'reuse') {
                const previousTechniques = allTechniques.filter(t => t.isPreviousLevel);
                content = `
                    <div style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border-bottom: 1px solid #374151;">
                        <h4 style="color: #10B981; margin-bottom: 0.5rem;">‚úÖ T√©cnicas do N√≠vel Anterior (J√° Inclu√≠das)</h4>
                        <div style="color: #CBD5E1; font-size: 0.9rem;">
                            ${previousTechniques.length > 0 ? previousTechniques.map(t => t.name).join(', ') : 'Nenhuma t√©cnica do n√≠vel anterior'}
                        </div>
                    </div>
                    <div style="padding: 1rem;">
                        <h4 style="color: #F8FAFC; margin-bottom: 1rem;">üìù Selecione T√©cnicas Adicionais:</h4>
                `;
            } else {
                content = `
                    <div style="padding: 1rem;">
                        <h4 style="color: #F8FAFC; margin-bottom: 1rem;">üìù Selecione as T√©cnicas:</h4>
                `;
            }

            content += techniques.map(tech => `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border-bottom: 1px solid #374151; hover: background-color: rgba(255,255,255,0.05);">
                    <input type="checkbox" id="tech_${tech.id}" value="${tech.id}" onchange="toggleTechniqueSelection('${tech.id}')">
                    <label for="tech_${tech.id}" style="flex: 1; cursor: pointer; color: #F8FAFC;">
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">${tech.name}</div>
                        <div style="font-size: 0.8rem; color: #9CA3AF;">
                            ${getCategoryIcon(tech.category)} ${getCategoryName(tech.category)} ‚Ä¢ 
                            ${'‚≠ê'.repeat(getLevelStars(tech.level))} ${getLevelName(tech.level)}
                        </div>
                    </label>
                </div>
            `).join('');

            content += '</div>';
            selectionArea.innerHTML = content;
        }

        // Toggle technique selection
        function toggleTechniqueSelection(techniqueId) {
            const technique = allTechniques.find(t => t.id === techniqueId);
            const checkbox = document.getElementById(`tech_${techniqueId}`);
            
            if (checkbox.checked) {
                if (!selectedTechniques.find(t => t.id === techniqueId)) {
                    selectedTechniques.push(technique);
                }
            } else {
                selectedTechniques = selectedTechniques.filter(t => t.id !== techniqueId);
            }
            
            updateSelectedTechniquesList();
        }

        // Update selected techniques list
        function updateSelectedTechniquesList() {
            const countElement = document.getElementById('selectedTechniquesCount');
            const listElement = document.getElementById('selectedTechniquesList');
            
            countElement.textContent = selectedTechniques.length;
            
            if (selectedTechniques.length === 0) {
                listElement.textContent = 'Nenhuma t√©cnica selecionada ainda';
            } else {
                listElement.innerHTML = selectedTechniques.map(tech => 
                    `<span style="background: ${getCategoryColor(tech.category)}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; margin: 0.25rem; display: inline-block; font-size: 0.8rem;">
                        ${getCategoryIcon(tech.category)} ${tech.name}
                    </span>`
                ).join('');
            }
        }

        // Handle Course model upload
        function handleCourseModelUpload(event) {
            const file = event.target.files[0];
            if (file) {
                courseModelFile = file;
                document.getElementById('courseModelFileInfo').innerHTML = `
                    <div style="text-align: left; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border: 1px solid #F59E0B;">
                        <div style="color: #F59E0B; font-weight: bold; margin-bottom: 0.5rem;">üìé Arquivo Carregado:</div>
                        <div style="color: #F8FAFC;">${getFileIcon(file.name)} ${file.name}</div>
                        <div style="color: #9CA3AF; font-size: 0.8rem;">${formatFileSize(file.size)}</div>
                    </div>
                `;
                showToast(`Modelo "${file.name}" carregado com sucesso!`, 'success');
            }
        }

        // Create Universal Course (RAG-Enhanced)
        async function createUniversalCourse() {
            const courseData = {
                title: document.getElementById('universalCourseTitle').value,
                duration: parseInt(document.getElementById('universalCourseDuration').value),
                objectives: document.getElementById('universalCourseObjectives').value,
                martialArt: document.getElementById('martialArt').value,
                beltLevel: document.getElementById('beltLevel').value,
                graduation: document.getElementById('courseGraduation').value,
                level: document.getElementById('universalCourseLevel').value,
                lessonsPerWeek: parseInt(document.getElementById('lessonsPerWeekUniversal').value),
                selectedTechniques: selectedTechniques,
                modelFile: courseModelFile,
                generatePlans: document.getElementById('universalGeneratePlans').checked,
                aiModel: document.getElementById('universalAiModel').value,
                selectionStrategy: document.querySelector('input[name="selectionStrategy"]:checked')?.value
            };

            if (!courseData.title || !courseData.martialArt || !courseData.beltLevel || selectedTechniques.length === 0) {
                showToast('Preencha todos os campos obrigat√≥rios e selecione t√©cnicas', 'error');
                return;
            }

            // Show loading state
            const createBtn = document.getElementById('createUniversalBtn');
            const originalText = createBtn.innerHTML;
            createBtn.innerHTML = '<span>‚è≥</span> Criando Curso...';
            createBtn.disabled = true;

            try {
                // RAG Enhancement: Query knowledge base for course-relevant content
                const ragEnhancement = await queryRAGForCourseCreation(courseData);
                courseData.ragContent = ragEnhancement;
                
                await simulateUniversalCourseCreation(courseData);
                
                showToast(`Curso de ${getMartialArtName(courseData.martialArt)} criado com sucesso! ${ragEnhancement.usedSources > 0 ? 'üß† Enriquecido com ' + ragEnhancement.usedSources + ' fontes da base de conhecimento' : ''}`, 'success');
                closeUniversalCourseModal();
                
                // Refresh course data
                showSection('courses');
                
            } catch (error) {
                console.error('Erro ao criar curso:', error);
                showToast('Erro ao criar curso', 'error');
            } finally {
                // Restore button state
                createBtn.innerHTML = originalText;
                createBtn.disabled = false;
            }
        }

        // Simulate Universal course creation (RAG-Enhanced)
        async function simulateUniversalCourseCreation(courseData) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const enhancedCourse = {
                        title: courseData.title,
                        duration: courseData.duration,
                        totalTechniques: courseData.selectedTechniques.length,
                        techniques: courseData.selectedTechniques.map(t => ({
                            name: t.name,
                            category: t.category,
                            level: t.level,
                            isFromWhiteBelt: t.isFromWhiteBelt
                        })),
                        strategy: courseData.selectionStrategy,
                        modelFile: courseData.modelFile?.name,
                        generatePlans: courseData.generatePlans,
                        totalLessons: courseData.duration * courseData.lessonsPerWeek,
                        aiModel: courseData.aiModel,
                        courseStructure: generateRAGEnhancedStructure(courseData),
                        ragEnhancements: courseData.ragContent
                    };
                    
                    console.log('üéì RAG-Enhanced Universal Course Created:', enhancedCourse);
                    
                    // If lesson plans should be generated, create RAG-enhanced plans
                    if (courseData.generatePlans) {
                        enhancedCourse.lessonPlans = generateRAGEnhancedLessonPlans(courseData);
                        console.log('üìö Generated RAG-Enhanced Lesson Plans:', enhancedCourse.lessonPlans.length);
                    }
                    
                    resolve(enhancedCourse);
                }, 4000); // Simulate 4 second creation
            });
        }

        // Generate Yellow Belt course structure
        function generateYellowBeltStructure(courseData) {
            const totalLessons = courseData.duration * 2;
            const techniquesPerLesson = Math.ceil(courseData.selectedTechniques.length / totalLessons);
            
            return {
                totalWeeks: courseData.duration,
                totalLessons: totalLessons,
                lessonsPerWeek: 2,
                techniquesDistribution: courseData.selectedTechniques.reduce((acc, tech, index) => {
                    const lessonNumber = Math.floor(index / techniquesPerLesson) + 1;
                    if (!acc[lessonNumber]) acc[lessonNumber] = [];
                    acc[lessonNumber].push(tech.name);
                    return acc;
                }, {}),
                prerequisites: {
                    requiredCourse: 'Krav Maga Faixa Branca',
                    minimumGrade: '70%',
                    requiredTechniques: allTechniques.filter(t => t.isFromWhiteBelt).map(t => t.name)
                }
            };
        }

        // Listen for strategy changes
        document.addEventListener('change', function(e) {
            if (e.target.name === 'selectionStrategy') {
                updateTechniqueSelectionStrategy();
            }
        });

        // ==========================================
        // AI COURSE GENERATOR FUNCTIONALITY
        // ==========================================

        let uploadedFiles = [];
        let selectedTemplate = null;

        // Open AI Course Generator Modal
        function openAICourseGenerator() {
            document.getElementById('aiCourseGeneratorModal').classList.add('active');
            resetCourseForm();
        }

        // Close AI Course Generator Modal
        function closeAICourseGeneratorModal() {
            document.getElementById('aiCourseGeneratorModal').classList.remove('active');
            resetCourseForm();
        }

        // Select creation mode
        function selectCreationMode(mode) {
            document.getElementById('creationMode').value = mode;
            
            // Update UI
            document.querySelectorAll('.creation-mode-card').forEach(card => {
                card.style.borderColor = '#374151';
                card.style.background = '';
            });
            
            const selectedCard = event.target.closest('.creation-mode-card');
            selectedCard.style.borderColor = '#3B82F6';
            selectedCard.style.background = 'rgba(59, 130, 246, 0.1)';
            
            // Show/hide document section
            const documentSection = document.getElementById('documentSection');
            if (mode === 'document') {
                documentSection.style.display = 'block';
            } else {
                documentSection.style.display = 'none';
            }
        }

        // Load template
        function loadTemplate(templateType) {
            selectedTemplate = templateType;
            
            // Update template buttons
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.style.background = btn.style.background.replace('0.2', '0.1');
            });
            event.target.style.background = event.target.style.background.replace('0.1', '0.3');
            
            // Load template data
            const templates = {
                'krav-maga-basic': {
                    title: 'Krav Maga Faixa Branca - Defesa Pessoal 1',
                    level: 'INICIANTE',
                    category: 'ADULT',
                    duration: 24,
                    objectives: 'Desenvolver habilidades fundamentais de defesa pessoal, melhorar condicionamento f√≠sico, ensinar consci√™ncia situacional'
                },
                'self-defense': {
                    title: 'Defesa Pessoal para Mulheres',
                    level: 'INICIANTE',
                    category: 'ADULT',
                    duration: 12,
                    objectives: 'Ensinar t√©cnicas b√°sicas de defesa, desenvolver confian√ßa, promover seguran√ßa pessoal'
                },
                'instructor': {
                    title: 'Forma√ß√£o de Instrutores Krav Maga',
                    level: 'INSTRUTOR',
                    category: 'ADULT',
                    duration: 36,
                    objectives: 'Formar instrutores qualificados, ensinar metodologia de ensino, desenvolver habilidades de lideran√ßa'
                }
            };
            
            const template = templates[templateType];
            if (template) {
                document.getElementById('courseTitle').value = template.title;
                document.getElementById('courseLevel').value = template.level;
                document.getElementById('courseCategory').value = template.category;
                document.getElementById('courseDuration').value = template.duration;
                document.getElementById('courseObjectives').value = template.objectives;
            }

            showToast(`Template "${templateType}" carregado com sucesso!`, 'success');
        }

        // Handle file upload
        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            uploadedFiles = [...uploadedFiles, ...files];
            
            displayUploadedFiles();
            showToast(`${files.length} arquivo(s) carregado(s)`, 'success');
        }

        // Display uploaded files
        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            
            if (uploadedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div style="text-align: left; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #374151;">
                    <h4 style="color: #F8FAFC; margin-bottom: 0.5rem;">üìé Arquivos Carregados:</h4>
                    ${uploadedFiles.map((file, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(59, 130, 246, 0.1); border-radius: 6px; margin-bottom: 0.5rem;">
                            <span style="color: #CBD5E1;">
                                ${getFileIcon(file.name)} ${file.name} 
                                <small style="color: #9CA3AF;">(${formatFileSize(file.size)})</small>
                            </span>
                            <button onclick="removeFile(${index})" style="background: #EF4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">
                                ‚úï
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Remove file
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayUploadedFiles();
            showToast('Arquivo removido', 'info');
        }

        // Get file icon
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'üìÑ',
                'doc': 'üìù',
                'docx': 'üìù',
                'txt': 'üìÑ',
                'md': 'üìã'
            };
            return icons[ext] || 'üìÅ';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Generate course with AI
        async function generateCourseWithAI() {
            const formData = collectCourseFormData();
            
            if (!validateCourseForm(formData)) {
                return;
            }

            // Show loading state
            const generateBtn = document.getElementById('generateCourseBtn');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<span>‚è≥</span> Gerando Curso...';
            generateBtn.disabled = true;

            try {
                // Simulate AI course generation
                await simulateAICourseGeneration(formData);
                
                showToast('Curso gerado com sucesso! Criando planos de aula...', 'success');
                
                if (formData.generateLessonPlans) {
                    await simulateLessonPlansGeneration(formData);
                    showToast('Planos de aula gerados com sucesso!', 'success');
                }
                
                closeAICourseGeneratorModal();
                // Refresh course data
                loadAllLessonPlans();
                
            } catch (error) {
                console.error('Erro na gera√ß√£o do curso:', error);
                showToast('Erro ao gerar curso', 'error');
            } finally {
                // Restore button state
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        // Collect form data
        function collectCourseFormData() {
            return {
                mode: document.getElementById('creationMode').value,
                title: document.getElementById('courseTitle').value,
                duration: document.getElementById('courseDuration').value,
                level: document.getElementById('courseLevel').value,
                category: document.getElementById('courseCategory').value,
                lessonsPerWeek: document.getElementById('lessonsPerWeek').value,
                objectives: document.getElementById('courseObjectives').value,
                additionalContext: document.getElementById('additionalContext').value,
                generateLessonPlans: document.getElementById('generateLessonPlans').checked,
                includeEvaluations: document.getElementById('includeEvaluations').checked,
                aiModel: document.getElementById('aiModel').value,
                adaptations: Array.from(document.querySelectorAll('input[name="adaptations"]:checked')).map(cb => cb.value),
                uploadedFiles: uploadedFiles,
                selectedTemplate: selectedTemplate
            };
        }

        // Validate form
        function validateCourseForm(formData) {
            if (!formData.mode) {
                showToast('Selecione um modo de cria√ß√£o', 'error');
                return false;
            }
            
            if (!formData.title || !formData.level || !formData.category) {
                showToast('Preencha todos os campos obrigat√≥rios', 'error');
                return false;
            }
            
            if (formData.mode === 'document' && uploadedFiles.length === 0 && !selectedTemplate) {
                showToast('Carregue documentos ou selecione um template', 'error');
                return false;
            }
            
            return true;
        }

        // Simulate AI course generation
        async function simulateAICourseGeneration(formData) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('üéØ IA Generated Course:', {
                        title: formData.title,
                        structure: generateCourseStructure(formData),
                        curriculum: generateCourseCurriculum(formData),
                        objectives: formData.objectives.split(',').map(obj => obj.trim()),
                        totalLessons: formData.duration * formData.lessonsPerWeek,
                        weeks: formData.duration,
                        level: formData.level,
                        category: formData.category,
                        adaptations: formData.adaptations,
                        evaluationSystem: formData.includeEvaluations ? generateEvaluationSystem(formData) : null,
                        generatedWith: {
                            model: formData.aiModel,
                            mode: formData.mode,
                            documentsUsed: uploadedFiles.map(f => f.name),
                            template: selectedTemplate
                        }
                    });
                    resolve();
                }, 3000); // Simulate 3 second generation
            });
        }

        // Generate course structure
        function generateCourseStructure(formData) {
            const totalLessons = formData.duration * formData.lessonsPerWeek;
            const unitsCount = Math.ceil(totalLessons / 10);
            
            return {
                totalWeeks: formData.duration,
                lessonsPerWeek: formData.lessonsPerWeek,
                totalLessons: totalLessons,
                units: Array.from({length: unitsCount}, (_, i) => ({
                    number: i + 1,
                    name: generateUnitName(i, formData.level),
                    lessonsStart: i * 10 + 1,
                    lessonsEnd: Math.min((i + 1) * 10, totalLessons),
                    focus: generateUnitFocus(i, formData.level)
                }))
            };
        }

        // Generate unit names based on level
        function generateUnitName(unitIndex, level) {
            const unitNames = {
                'INICIANTE': ['Fundamentos', 'T√©cnicas B√°sicas', 'Defesas Simples', 'Aplica√ß√£o Pr√°tica'],
                'INTERMEDIARIO': ['Revis√£o Avan√ßada', 'T√©cnicas Complexas', 'Defesas M√∫ltiplas', 'Cen√°rios Reais'],
                'AVANCADO': ['Refinamento T√©cnico', 'Combos Avan√ßados', 'Defesas Extremas', 'Instru√ß√£o'],
                'INSTRUTOR': ['Metodologia', 'Pedagogia', 'Demonstra√ß√£o', 'Avalia√ß√£o']
            };
            
            return unitNames[level]?.[unitIndex] || `Unidade ${unitIndex + 1}`;
        }

        // Generate unit focus
        function generateUnitFocus(unitIndex, level) {
            const focuses = {
                'INICIANTE': ['Coordena√ß√£o e postura', 'T√©cnicas fundamentais', 'Rea√ß√µes b√°sicas', 'Confian√ßa'],
                'INTERMEDIARIO': ['Precis√£o t√©cnica', 'Combina√ß√µes', 'Adaptabilidade', 'Condicionamento'],
                'AVANCADO': ['Perfei√ß√£o t√©cnica', 'Criatividade', 'Lideran√ßa', 'Especializa√ß√£o'],
                'INSTRUTOR': ['Ensino efetivo', 'Comunica√ß√£o', 'Corre√ß√£o t√©cnica', 'Desenvolvimento de alunos']
            };
            
            return focuses[level]?.[unitIndex] || 'Desenvolvimento geral';
        }

        // Generate course curriculum
        function generateCourseCurriculum(formData) {
            return {
                principles: generateCoursePrinciples(formData.level),
                techniques: generateCourseTechniques(formData.level),
                progressionSystem: generateProgressionSystem(formData.level),
                equipmentNeeded: generateEquipmentList(formData.level)
            };
        }

        // Generate evaluation system
        function generateEvaluationSystem(formData) {
            return {
                evaluationMethods: ['T√©cnica individual', 'Cen√°rios pr√°ticos', 'Exame te√≥rico', 'Avalia√ß√£o cont√≠nua'],
                gradingCriteria: ['Precis√£o t√©cnica', 'Aplica√ß√£o pr√°tica', 'Conhecimento te√≥rico', 'Progress√£o'],
                examSchedule: generateExamSchedule(formData.duration),
                certificationRequirements: ['75% frequ√™ncia m√≠nima', 'Aprova√ß√£o em todas avalia√ß√µes', 'Demonstra√ß√£o pr√°tica']
            };
        }

        // Simulate lesson plans generation
        async function simulateLessonPlansGeneration(formData) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('üìö IA Generated Lesson Plans for course:', formData.title);
                    resolve();
                }, 2000);
            });
        }

        // Reset form
        function resetCourseForm() {
            document.getElementById('creationMode').value = '';
            document.querySelectorAll('.creation-mode-card').forEach(card => {
                card.style.borderColor = '#374151';
                card.style.background = '';
            });
            document.getElementById('documentSection').style.display = 'none';
            uploadedFiles = [];
            selectedTemplate = null;
            displayUploadedFiles();
        }

        // Helper functions for curriculum generation
        function generateCoursePrinciples(level) {
            const principles = {
                'INICIANTE': ['Seguran√ßa primeiro', 'Simplicidade', 'Efetividade', 'Progress√£o gradual'],
                'INTERMEDIARIO': ['Adaptabilidade', 'Flu√™ncia t√©cnica', 'Tomada de decis√£o', 'Condicionamento'],
                'AVANCADO': ['Maestria t√©cnica', 'Criatividade', 'Lideran√ßa', 'Inova√ß√£o'],
                'INSTRUTOR': ['Pedagogia efetiva', 'Comunica√ß√£o clara', 'Desenvolvimento de outros', 'Responsabilidade']
            };
            return principles[level] || principles['INICIANTE'];
        }

        function generateCourseTechniques(level) {
            const techniques = {
                'INICIANTE': ['Postura b√°sica', 'Golpes fundamentais', 'Defesas simples', 'Movimenta√ß√£o'],
                'INTERMEDIARIO': ['Combina√ß√µes', 'Defesas m√∫ltiplas', 'Contra-ataques', 'Cen√°rios variados'],
                'AVANCADO': ['T√©cnicas complexas', 'Improvisa√ß√£o', 'Ensino', 'Especializa√ß√£o'],
                'INSTRUTOR': ['Demonstra√ß√£o perfeita', 'Corre√ß√£o t√©cnica', 'Adapta√ß√£o metodol√≥gica', 'Avalia√ß√£o']
            };
            return techniques[level] || techniques['INICIANTE'];
        }

        function generateProgressionSystem(level) {
            return {
                assessmentFrequency: level === 'INSTRUTOR' ? 'Semanal' : 'Quinzenal',
                practiceHours: level === 'INICIANTE' ? '2-3 horas/semana' : '4-6 horas/semana',
                masteryLevel: level === 'INICIANTE' ? '70%' : '85%'
            };
        }

        function generateEquipmentList(level) {
            const equipment = {
                'INICIANTE': ['Tatame', 'Roupas confort√°veis'],
                'INTERMEDIARIO': ['Tatame', 'Luvas', 'Protetores'],
                'AVANCADO': ['Tatame completo', 'Equipamentos variados', 'Material de treino'],
                'INSTRUTOR': ['Todo equipamento', 'Material did√°tico', 'Recursos audiovisuais']
            };
            return equipment[level] || equipment['INICIANTE'];
        }

        function generateExamSchedule(duration) {
            const exams = [];
            for (let week = 6; week <= duration; week += 6) {
                exams.push(`Semana ${week}: Avalia√ß√£o de Unidade`);
            }
            exams.push(`Semana ${duration}: Exame Final`);
            return exams;
        }

        // ==========================================
        // AI LESSON GENERATOR FUNCTIONALITY
        // ==========================================

        // Open AI Generator Modal  
        function openAILessonGenerator() {
            document.getElementById('aiGeneratorModal').classList.add('active');
        }

        // Close AI Generator Modal
        function closeAIGeneratorModal() {
            document.getElementById('aiGeneratorModal').classList.remove('active');
        }

        // Generate lesson plan with AI
        async function generateLessonPlanWithAI() {
            const formData = {
                lessonNumber: document.getElementById('aiLessonNumber').value,
                unit: document.getElementById('aiLessonUnit').value,
                mainTechnique: document.getElementById('aiMainTechnique').value,
                objectives: document.getElementById('aiLessonObjectives').value,
                difficulty: document.getElementById('aiDifficulty').value,
                specialNeeds: Array.from(document.querySelectorAll('#aiGeneratorForm input[type="checkbox"]:checked')).map(cb => cb.value)
            };

            if (!formData.lessonNumber || !formData.unit || !formData.mainTechnique) {
                showToast('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }

            // Show loading state
            const generateBtn = document.querySelector('[onclick="generateLessonPlanWithAI()"]');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<span>‚è≥</span> Gerando...';
            generateBtn.disabled = true;

            try {
                // Simulate AI generation - replace with actual API call
                await simulateAIGeneration(formData);
                
                showToast('Plano de aula gerado com sucesso!', 'success');
                closeAIGeneratorModal();
                loadAllLessonPlans(); // Refresh the lesson plans table
                
            } catch (error) {
                console.error('Erro na gera√ß√£o IA:', error);
                showToast('Erro ao gerar plano de aula', 'error');
            } finally {
                // Restore button state
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        // ==========================================
        // CENTRAL RAG SYSTEM - MEMORIA DOS AGENTES IA
        // ==========================================
        
        // Initialize RAG knowledge base and RAG chunks (renamed to avoid conflict)
        const ragKnowledgeBase = {
            techniques: [],
            lessons: [],
            students: [],
            courses: []
        };
        
        // Central RAG Service - Memory for all AI agents
        class CentralRAGService {
            constructor() {
                this.knowledgeBase = ragKnowledgeBase;
                this.ragChunks = window.ragChunks || [];
            }
            
            // Universal query method for all AI agents
            async queryKnowledge(query, context = {}) {
                try {
                    const enhancedQuery = this.enhanceQuery(query, context);
                    const relevantChunks = this.findRelevantChunks(enhancedQuery);
                    const response = await this.generateResponse(enhancedQuery, relevantChunks, context);
                    
                    return {
                        success: true,
                        answer: response.answer,
                        sources: response.sources,
                        confidence: response.confidence,
                        chunks: relevantChunks.length,
                        context: context
                    };
                } catch (error) {
                    console.error('RAG Query Error:', error);
                    return {
                        success: false,
                        answer: 'Desculpe, n√£o consegui acessar a base de conhecimento no momento.',
                        sources: [],
                        confidence: 0
                    };
                }
            }
            
            // Enhance query with context information
            enhanceQuery(query, context) {
                let enhancedQuery = query;
                
                if (context.martialArt) {
                    enhancedQuery += ` ${context.martialArt}`;
                }
                
                if (context.level) {
                    enhancedQuery += ` ${context.level}`;
                }
                
                if (context.module) {
                    enhancedQuery += ` ${context.module}`;
                }
                
                return enhancedQuery;
            }
            
            // Find relevant chunks using enhanced search
            findRelevantChunks(query) {
                const queryWords = query.toLowerCase().split(' ').filter(word => word.length > 2);
                
                return this.ragChunks.filter(chunk => {
                    const chunkWords = chunk.content.toLowerCase();
                    const titleWords = chunk.sourceTitle.toLowerCase();
                    const tagWords = chunk.tags.join(' ').toLowerCase();
                    
                    const score = queryWords.reduce((acc, word) => {
                        let points = 0;
                        if (chunkWords.includes(word)) points += 3;
                        if (titleWords.includes(word)) points += 5;
                        if (tagWords.includes(word)) points += 2;
                        return acc + points;
                    }, 0);
                    
                    chunk.relevanceScore = score;
                    return score > 0;
                }).sort((a, b) => b.relevanceScore - a.relevanceScore).slice(0, 5);
            }
            
            // Generate contextualized response
            async generateResponse(query, chunks, context) {
                await sleep(300); // Simulate processing
                
                if (chunks.length === 0) {
                    return {
                        answer: 'N√£o encontrei informa√ß√µes espec√≠ficas sobre isso na base de conhecimento. Considere adicionar mais conte√∫do relacionado.',
                        sources: [],
                        confidence: 0
                    };
                }
                
                const contextualAnswer = this.generateContextualAnswer(query, chunks, context);
                
                return {
                    answer: contextualAnswer,
                    sources: chunks.map(chunk => ({
                        title: chunk.sourceTitle,
                        type: chunk.sourceType,
                        relevantText: chunk.content.substring(0, 150) + '...',
                        score: chunk.relevanceScore
                    })),
                    confidence: Math.min(95, Math.max(60, chunks[0]?.relevanceScore * 10 || 60))
                };
            }
            
            // Generate contextual answer based on agent type
            generateContextualAnswer(query, chunks, context) {
                const combinedContent = chunks.map(c => c.content).join('\n\n');
                const agentType = context.agent || 'general';
                
                // Agent-specific response formatting
                switch (agentType) {
                    case 'course-creator':
                        return this.formatForCourseCreator(query, combinedContent, context);
                    case 'lesson-planner':
                        return this.formatForLessonPlanner(query, combinedContent, context);
                    case 'technique-auditor':
                        return this.formatForTechniqueAuditor(query, combinedContent, context);
                    case 'instructor-assistant':
                        return this.formatForInstructorAssistant(query, combinedContent, context);
                    case 'student-advisor':
                        return this.formatForStudentAdvisor(query, combinedContent, context);
                    default:
                        return this.formatGeneralResponse(query, combinedContent, context);
                }
            }
            
            // Agent-specific formatting methods
            formatForCourseCreator(query, content, context) {
                return `üìö **Orienta√ß√£o para Cria√ß√£o de Curso:** Baseado na base de conhecimento, para ${context.martialArt || 'esta arte marcial'} ${context.level || ''}: ${content.substring(0, 300)}. Recomendo seguir essa metodologia na estrutura√ß√£o do curso.`;
            }
            
            formatForLessonPlanner(query, content, context) {
                return `üìù **Orienta√ß√£o para Plano de Aula:** Para esta aula espec√≠fica, a base de conhecimento sugere: ${content.substring(0, 250)}. Adapte conforme o n√≠vel da turma e objetivos espec√≠ficos.`;
            }
            
            formatForTechniqueAuditor(query, content, context) {
                return `üîç **An√°lise de T√©cnica:** Segundo os padr√µes documentados: ${content.substring(0, 200)}. Use estes crit√©rios para validar a qualidade e consist√™ncia das t√©cnicas.`;
            }
            
            formatForInstructorAssistant(query, content, context) {
                return `üë®‚Äçüè´ **Suporte ao Instrutor:** Com base na experi√™ncia documentada: ${content.substring(0, 250)}. Esta orienta√ß√£o pode ajudar na condu√ß√£o da aula.`;
            }
            
            formatForStudentAdvisor(query, content, context) {
                return `üéì **Orienta√ß√£o ao Aluno:** Baseado nas melhores pr√°ticas: ${content.substring(0, 250)}. Isso pode ajudar no seu desenvolvimento e progresso.`;
            }
            
            formatGeneralResponse(query, content, context) {
                return `üí° **Informa√ß√£o da Base de Conhecimento:** ${content.substring(0, 300)}. Esta informa√ß√£o est√° baseada no conte√∫do que voc√™ adicionou ao sistema.`;
            }
        }
        
        // Initialize Central RAG Service
        const centralRAG = new CentralRAGService();
        
        // RAG-Enhanced AI generation for lesson plans
        async function simulateAIGeneration(formData) {
            return new Promise(async (resolve) => {
                try {
                    // Query Central RAG for lesson planning guidance
                    const context = {
                        agent: 'lesson-planner',
                        unit: formData.unit,
                        technique: formData.mainTechnique,
                        module: 'lesson-planning'
                    };
                    
                    const ragQueries = [
                        `plano aula ${formData.unit} ${formData.mainTechnique}`,
                        `metodologia ensino ${formData.mainTechnique}`,
                        `progress√£o pedag√≥gica aquecimento t√©cnica`,
                        'adapta√ß√µes necessidades especiais ensino'
                    ];
                    
                    let ragEnhancements = [];
                    
                    for (const query of ragQueries) {
                        const ragResponse = await centralRAG.queryKnowledge(query, context);
                        if (ragResponse.success) {
                            ragEnhancements.push(ragResponse);
                        }
                    }
                    
                    setTimeout(() => {
                        const enhancedPlan = {
                            lesson: formData.lessonNumber,
                            unit: formData.unit,
                            technique: formData.mainTechnique,
                            objectives: formData.objectives.split(',').map(obj => obj.trim()),
                            warmup: generateWarmupActivities(formData.unit),
                            techniques: generateTechniqueActivities(formData.mainTechnique),
                            simulations: generateSimulationActivities(formData.mainTechnique),
                            cooldown: generateCooldownActivities(),
                            adaptations: generateAdaptations(formData.specialNeeds),
                            equipment: generateEquipmentList(formData.unit),
                            tacticalModule: generateTacticalModule(formData.unit),
                            ragEnhancements: ragEnhancements,
                            enhancedBy: 'Central RAG System'
                        };
                        
                        console.log('üß† RAG-Enhanced Lesson Plan Generated:', enhancedPlan);
                        resolve(enhancedPlan);
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error in RAG-enhanced generation:', error);
                    resolve();
                }
            });
        }

        // AI Helper Functions for generating lesson plan components
        function generateWarmupActivities(unit) {
            const warmups = {
                'fundamentos': ['Aquecimento articular', 'Corrida leve', 'Exerc√≠cios de coordena√ß√£o'],
                'golpes': ['Shadowboxing', 'Aquecimento de punhos', 'Mobilidade de ombros'],
                'defesas': ['Exerc√≠cios de rea√ß√£o', 'Aquecimento defensivo', 'Coordena√ß√£o motora'],
                'avancadas': ['Aquecimento intenso', 'Exerc√≠cios de agilidade', 'Prepara√ß√£o mental'],
                'integracao': ['Aquecimento completo', 'Prepara√ß√£o para combos', 'Exerc√≠cios de fluidez']
            };
            return warmups[unit] || ['Aquecimento geral'];
        }

        function generateTechniqueActivities(technique) {
            return [
                `Demonstra√ß√£o da t√©cnica: ${technique}`,
                'Pr√°tica em slow motion',
                'Repeti√ß√µes com parceiro',
                'Corre√ß√£o de postura',
                'Pr√°tica em velocidade normal'
            ];
        }

        function generateSimulationActivities(technique) {
            return [
                `Aplica√ß√£o de ${technique} em cen√°rio simulado`,
                'Varia√ß√µes de dist√¢ncia',
                'Cen√°rios de press√£o',
                'Combina√ß√µes com outras t√©cnicas'
            ];
        }

        function generateCooldownActivities() {
            return [
                'Alongamento geral',
                'Exerc√≠cios de respira√ß√£o',
                'Relaxamento muscular',
                'Reflex√£o sobre a aula'
            ];
        }

        function generateAdaptations(specialNeeds) {
            const adaptations = {};
            if (specialNeeds.includes('TEA')) {
                adaptations.TEA = 'Demonstra√ß√£o visual clara, instru√ß√µes estruturadas, ambiente previs√≠vel';
            }
            if (specialNeeds.includes('TDAH')) {
                adaptations.TDAH = 'Instru√ß√µes curtas, pausas frequentes, atividades din√¢micas';
            }
            if (specialNeeds.includes('MOBILIDADE_REDUZIDA')) {
                adaptations.MOBILIDADE_REDUZIDA = 'Adapta√ß√µes para movimentos limitados, exerc√≠cios sentados';
            }
            return adaptations;
        }

        function generateEquipmentList(unit) {
            const equipment = {
                'fundamentos': ['Tatame', 'Espelho'],
                'golpes': ['Tatame', 'Pads de foco', 'Luvas'],
                'defesas': ['Tatame', 'Equipamentos de prote√ß√£o'],
                'avancadas': ['Tatame', 'Equipamentos variados', 'Prote√ß√µes'],
                'integracao': ['Tatame completo', 'Todos equipamentos']
            };
            return equipment[unit] || ['Tatame b√°sico'];
        }

        function generateTacticalModule(unit) {
            const modules = {
                'fundamentos': 'Regula√ß√£o Emocional',
                'golpes': 'Precis√£o e Timing',
                'defesas': 'Consci√™ncia Situacional',
                'avancadas': 'Tomada de Decis√£o',
                'integracao': 'Aplica√ß√£o Pr√°tica'
            };
            return modules[unit] || 'Desenvolvimento T√°tico';
        }

        // Auto-fill technique based on unit selection
        document.getElementById('aiLessonUnit').addEventListener('change', function() {
            const unit = this.value;
            const techniqueField = document.getElementById('aiMainTechnique');
            const techniques = {
                'fundamentos': 'Guarda de Boxe',
                'golpes': 'Jab (Soco Direto)',
                'defesas': 'Defesa 360¬∞ Interior',
                'avancadas': 'Defesa contra Agarramento',
                'integracao': 'Combo Jab-Cross-Hook'
            };
            if (techniques[unit]) {
                techniqueField.value = techniques[unit];
            }
        });

        // ==========================================
        // SISTEMA DE AUDITORIA IA
        // ==========================================

        let currentTechniqueForAudit = null;
        let currentVideoFile = null;

        // Open audit panel
        function openTechniqueAuditPanel() {
            document.getElementById('auditPanel').style.display = 'block';
            updateAuditStats();
        }

        // Close audit panel
        function closeAuditPanel() {
            document.getElementById('auditPanel').style.display = 'none';
        }

        // Run full audit with IA
        async function runFullAudit() {
            const auditBtn = document.querySelector('#auditPanel .btn-primary');
            const originalText = auditBtn.innerHTML;
            
            auditBtn.innerHTML = '<span>ü§ñ</span> Analisando...';
            auditBtn.disabled = true;

            try {
                // Simulate IA audit process
                await simulateAIAudit();
                
                showToast('Auditoria IA conclu√≠da com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro na auditoria:', error);
                showToast('Erro durante a auditoria', 'error');
            } finally {
                auditBtn.innerHTML = originalText;
                auditBtn.disabled = false;
            }
        }

        // Simulate AI audit process
        async function simulateAIAudit() {
            const techniques = allTechniques.length > 0 ? allTechniques : generateMockTechniques();
            auditResults = [];
            
            // Step 1: Detect duplicates
            document.getElementById('auditResults').innerHTML = `
                <div style="color: #F59E0B; padding: 1rem;">
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">üîç Etapa 1/3: Detectando Duplicatas...</div>
                    <div class="progress-bar" style="background: #374151; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: #F59E0B; height: 100%; width: 33%; transition: width 0.3s;"></div>
                    </div>
                </div>
            `;
            await sleep(1000);
            
            // Step 2: Analyze quality
            document.getElementById('auditResults').innerHTML = `
                <div style="color: #3B82F6; padding: 1rem;">
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">üéØ Etapa 2/3: Analisando Qualidade...</div>
                    <div class="progress-bar" style="background: #374151; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: #3B82F6; height: 100%; width: 66%; transition: width 0.3s;"></div>
                    </div>
                </div>
            `;
            await sleep(1000);
            
            // Step 3: Generate results
            document.getElementById('auditResults').innerHTML = `
                <div style="color: #10B981; padding: 1rem;">
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">üìä Etapa 3/3: Gerando Relat√≥rio...</div>
                    <div class="progress-bar" style="background: #374151; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: #10B981; height: 100%; width: 100%; transition: width 0.3s;"></div>
                    </div>
                </div>
            `;
            await sleep(1000);
            
            // Generate audit results with RAG enhancement
            const duplicateResults = detectDuplicates(techniques);
            const qualityResults = analyzeQualityWithRAG(techniques, auditGuidance);
            
            auditResults = [...duplicateResults, ...qualityResults];
            
            // Add RAG insights to results
            if (auditGuidance.success) {
                auditResults.unshift({
                    type: 'RAG_INSIGHT',
                    technique: null,
                    severity: 'INFO',
                    message: `üß† Base de Conhecimento: ${auditGuidance.answer}`,
                    confidence: auditGuidance.confidence,
                    sources: auditGuidance.sources
                });
            }
            
            displayAuditResults();
            updateAuditStats();
        }

        // Detect duplicate techniques
        function detectDuplicates(techniques) {
            const duplicates = [];
            const seen = new Map();
            
            techniques.forEach(tech => {
                const key = `${tech.martialArt}-${tech.category}-${tech.name.toLowerCase()}`;
                if (seen.has(key)) {
                    const original = seen.get(key);
                    duplicates.push({
                        type: 'DUPLICATE',
                        technique: tech,
                        originalTechnique: original,
                        severity: 'HIGH',
                        message: `T√©cnica "${tech.name}" parece ser duplicata de "${original.name}"`
                    });
                } else {
                    seen.set(key, tech);
                }
                
                // Check for similar names (fuzzy matching)
                techniques.forEach(otherTech => {
                    if (tech.id !== otherTech.id && tech.martialArt === otherTech.martialArt) {
                        const similarity = calculateSimilarity(tech.name, otherTech.name);
                        if (similarity > 0.8) {
                            duplicates.push({
                                type: 'SIMILAR',
                                technique: tech,
                                originalTechnique: otherTech,
                                severity: 'MEDIUM',
                                similarity: similarity,
                                message: `T√©cnica "${tech.name}" √© muito similar a "${otherTech.name}" (${Math.round(similarity * 100)}% similar)`
                            });
                        }
                    }
                });
            });
            
            return duplicates;
        }

        // Analyze technique quality
        function analyzeQuality(techniques) {
            const qualityIssues = [];
            
            techniques.forEach(tech => {
                let score = 100;
                const issues = [];
                
                // Check name length
                if (tech.name.length < 3) {
                    score -= 20;
                    issues.push('Nome muito curto');
                }
                
                // Check description quality
                if (!tech.description || tech.description.length < 10) {
                    score -= 15;
                    issues.push('Descri√ß√£o insuficiente');
                }
                
                // Check prerequisites logic
                if (tech.level === 'ADVANCED' && !tech.prerequisites) {
                    score -= 10;
                    issues.push('T√©cnica avan√ßada sem pr√©-requisitos');
                }
                
                // Check martial art consistency
                if (tech.martialArt === 'BOXING' && tech.category === 'GRAPPLING') {
                    score -= 25;
                    issues.push('Incompatibilidade: Boxe n√£o inclui t√©cnicas de grappling');
                }
                
                // Check video presence for important techniques
                if (tech.level === 'BEGINNER' && !tech.videoUrl) {
                    score -= 5;
                    issues.push('T√©cnica b√°sica sem v√≠deo demonstrativo');
                }
                
                if (score < 80 || issues.length > 0) {
                    qualityIssues.push({
                        type: 'QUALITY',
                        technique: tech,
                        severity: score < 60 ? 'HIGH' : score < 80 ? 'MEDIUM' : 'LOW',
                        score: score,
                        issues: issues,
                        message: `Problemas de qualidade detectados (Score: ${score}/100)`
                    });
                }
            });
            
            return qualityIssues;
        }

        // Calculate name similarity
        function calculateSimilarity(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;
            const matrix = Array(len2 + 1).fill(null).map(() => Array(len1 + 1).fill(null));
            
            for (let i = 0; i <= len1; i++) matrix[0][i] = i;
            for (let j = 0; j <= len2; j++) matrix[j][0] = j;
            
            for (let j = 1; j <= len2; j++) {
                for (let i = 1; i <= len1; i++) {
                    const indicator = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(
                        matrix[j][i - 1] + 1,
                        matrix[j - 1][i] + 1,
                        matrix[j - 1][i - 1] + indicator
                    );
                }
            }
            
            return 1 - matrix[len2][len1] / Math.max(len1, len2);
        }

        // Display audit results
        function displayAuditResults() {
            const resultsDiv = document.getElementById('auditResults');
            
            if (auditResults.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; color: #10B981; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚úÖ</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Auditoria Conclu√≠da!</div>
                        <div>Nenhum problema detectado. Todas as t√©cnicas est√£o em ordem.</div>
                    </div>
                `;
                return;
            }
            
            const duplicates = auditResults.filter(r => r.type === 'DUPLICATE' || r.type === 'SIMILAR');
            const qualityIssues = auditResults.filter(r => r.type === 'QUALITY');
            
            let html = '';
            
            if (duplicates.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #EF4444; margin-bottom: 1rem;">üî¥ Duplicatas Detectadas (${duplicates.length})</h3>
                        ${duplicates.map(duplicate => `
                            <div class="audit-item" style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid #EF4444; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                                <div style="display: flex; justify-content: between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: #F8FAFC; margin-bottom: 0.5rem;">
                                            ${duplicate.technique.name} (${duplicate.technique.martialArt})
                                        </div>
                                        <div style="color: #CBD5E1; margin-bottom: 0.5rem;">${duplicate.message}</div>
                                        <div style="font-size: 0.9rem; color: #9CA3AF;">
                                            Severity: ${duplicate.severity}
                                            ${duplicate.similarity ? ` | Similaridade: ${Math.round(duplicate.similarity * 100)}%` : ''}
                                        </div>
                                    </div>
                                    <button onclick="auditTechnique('${duplicate.technique.id}')" 
                                            style="background: #3B82F6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                                        üîç Revisar
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (qualityIssues.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #F59E0B; margin-bottom: 1rem;">‚ö†Ô∏è Problemas de Qualidade (${qualityIssues.length})</h3>
                        ${qualityIssues.map(issue => `
                            <div class="audit-item" style="background: rgba(245, 158, 11, 0.1); border-left: 4px solid #F59E0B; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                                <div style="display: flex; justify-content: between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: #F8FAFC; margin-bottom: 0.5rem;">
                                            ${issue.technique.name} (Score: ${issue.score}/100)
                                        </div>
                                        <div style="color: #CBD5E1; margin-bottom: 0.5rem;">
                                            Problemas: ${issue.issues.join(', ')}
                                        </div>
                                        <div style="font-size: 0.9rem; color: #9CA3AF;">
                                            Severity: ${issue.severity}
                                        </div>
                                    </div>
                                    <button onclick="auditTechnique('${issue.technique.id}')" 
                                            style="background: #3B82F6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                                        üîç Revisar
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }

        // Update audit statistics
        function updateAuditStats() {
            const techniques = allTechniques.length > 0 ? allTechniques : generateMockTechniques();
            
            const approved = techniques.filter(t => t.status === 'APPROVED').length;
            const pending = techniques.filter(t => t.status === 'PENDING').length;
            const duplicates = auditResults.filter(r => r.type === 'DUPLICATE' || r.type === 'SIMILAR').length;
            const qualityIssues = auditResults.filter(r => r.type === 'QUALITY').length;
            
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('duplicatesCount').textContent = duplicates;
            document.getElementById('qualityIssuesCount').textContent = qualityIssues;
        }

        // Audit specific technique
        function auditTechnique(techniqueId) {
            const technique = allTechniques.find(t => t.id === techniqueId);
            if (!technique) return;
            
            currentTechniqueForAudit = technique;
            
            const auditData = auditResults.find(r => r.technique.id === techniqueId);
            
            document.getElementById('techniqueAuditContent').innerHTML = `
                <div style="display: grid; gap: 1.5rem;">
                    <!-- Technique Info -->
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                        <h3 style="color: #3B82F6; margin-bottom: 1rem;">üìã Informa√ß√µes da T√©cnica</h3>
                        <div style="display: grid; gap: 0.5rem;">
                            <div><strong>Nome:</strong> ${technique.name}</div>
                            <div><strong>Arte Marcial:</strong> ${getMartialArtName(technique.martialArt)}</div>
                            <div><strong>Categoria:</strong> ${getCategoryName(technique.category)}</div>
                            <div><strong>N√≠vel:</strong> ${getLevelName(technique.level)}</div>
                            <div><strong>Status:</strong> <span style="color: ${getStatusColor(technique.status)}">${getStatusName(technique.status)}</span></div>
                        </div>
                    </div>
                    
                    <!-- Audit Results -->
                    ${auditData ? `
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #EF4444;">
                            <h3 style="color: #EF4444; margin-bottom: 1rem;">‚ö†Ô∏è Problemas Detectados</h3>
                            <div style="color: #CBD5E1;">${auditData.message}</div>
                            ${auditData.issues ? `
                                <div style="margin-top: 1rem;">
                                    <strong>Detalhes:</strong>
                                    <ul style="margin-top: 0.5rem; padding-left: 1rem;">
                                        ${auditData.issues.map(issue => `<li>${issue}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Actions -->
                    <div style="background: rgba(55, 65, 81, 0.3); padding: 1rem; border-radius: 8px;">
                        <h3 style="color: #F8FAFC; margin-bottom: 1rem;">üõ†Ô∏è A√ß√µes Dispon√≠veis</h3>
                        <div style="display: grid; gap: 1rem;">
                            <button onclick="openVideoUpload('${technique.id}')" 
                                    style="background: #8B5CF6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer;">
                                üìπ Adicionar V√≠deo
                            </button>
                            <button onclick="editTechniqueDetails('${technique.id}')" 
                                    style="background: #F59E0B; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer;">
                                ‚úèÔ∏è Editar Detalhes
                            </button>
                        </div>
                    </div>
                    
                    <!-- Video Section -->
                    ${technique.videoUrl ? `
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px;">
                            <h3 style="color: #10B981; margin-bottom: 1rem;">üìπ V√≠deo Atual</h3>
                            <div style="color: #CBD5E1;">V√≠deo j√° carregado: ${technique.videoUrl}</div>
                        </div>
                    ` : `
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px;">
                            <h3 style="color: #F59E0B; margin-bottom: 1rem;">üìπ V√≠deo Pendente</h3>
                            <div style="color: #CBD5E1;">Nenhum v√≠deo carregado para esta t√©cnica</div>
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('techniqueAuditModal').classList.add('active');
        }

        // Approve technique
        function approveTechnique() {
            if (!currentTechniqueForAudit) return;
            
            currentTechniqueForAudit.status = 'APPROVED';
            currentTechniqueForAudit.lastAuditAt = new Date().toISOString();
            
            // Remove from audit results
            auditResults = auditResults.filter(r => r.technique.id !== currentTechniqueForAudit.id);
            
            updateAuditStats();
            displayAuditResults();
            closeTechniqueAuditModal();
            
            showToast('T√©cnica aprovada com sucesso!', 'success');
        }

        // Reject technique
        function rejectTechnique() {
            if (!currentTechniqueForAudit) return;
            
            currentTechniqueForAudit.status = 'REJECTED';
            currentTechniqueForAudit.lastAuditAt = new Date().toISOString();
            
            updateAuditStats();
            displayAuditResults();
            closeTechniqueAuditModal();
            
            showToast('T√©cnica rejeitada', 'warning');
        }

        // Edit technique
        function editTechnique() {
            if (!currentTechniqueForAudit) return;
            
            // Open technique for editing
            closeTechniqueAuditModal();
            openTechniquesManager();
            
            // Simulate finding and editing the technique
            showToast('Abrindo t√©cnica para edi√ß√£o...', 'info');
        }

        // Close audit modal
        function closeTechniqueAuditModal() {
            document.getElementById('techniqueAuditModal').classList.remove('active');
            currentTechniqueForAudit = null;
        }

        // ==========================================
        // SISTEMA DE V√çDEOS
        // ==========================================

        // Open video upload
        function openVideoUpload(techniqueId) {
            const technique = allTechniques.find(t => t.id === techniqueId);
            if (!technique) return;
            
            currentTechniqueForAudit = technique;
            
            document.getElementById('videoTechniqueInfo').innerHTML = `
                <h4 style="color: #3B82F6; margin-bottom: 0.5rem;">üìã T√©cnica: ${technique.name}</h4>
                <div style="color: #CBD5E1; font-size: 0.9rem;">
                    ${getMartialArtName(technique.martialArt)} ‚Ä¢ ${getCategoryName(technique.category)} ‚Ä¢ ${getLevelName(technique.level)}
                </div>
            `;
            
            document.getElementById('videoUploadModal').classList.add('active');
        }

        // Handle video upload
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/quicktime'];
            if (!validTypes.includes(file.type)) {
                showToast('Formato de v√≠deo n√£o suportado', 'error');
                return;
            }
            
            // Validate file size (100MB)
            if (file.size > 100 * 1024 * 1024) {
                showToast('Arquivo muito grande. M√°ximo: 100MB', 'error');
                return;
            }
            
            currentVideoFile = file;
            
            // Show preview
            const preview = document.getElementById('videoPreview');
            const videoUrl = URL.createObjectURL(file);
            
            preview.innerHTML = `
                <div style="text-align: left; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid #10B981;">
                    <div style="color: #10B981; font-weight: bold; margin-bottom: 0.5rem;">üìπ V√≠deo Selecionado:</div>
                    <div style="color: #F8FAFC; margin-bottom: 0.5rem;">${file.name}</div>
                    <div style="color: #9CA3AF; font-size: 0.8rem; margin-bottom: 1rem;">${formatFileSize(file.size)}</div>
                    <video controls style="width: 100%; max-width: 300px; border-radius: 6px;">
                        <source src="${videoUrl}" type="${file.type}">
                        Seu navegador n√£o suporta o elemento de v√≠deo.
                    </video>
                </div>
            `;
            
            showToast('V√≠deo carregado e pronto para upload!', 'success');
        }

        // Upload video
        async function uploadVideo() {
            if (!currentVideoFile || !currentTechniqueForAudit) {
                showToast('Selecione um v√≠deo primeiro', 'error');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadVideoBtn');
            const originalText = uploadBtn.innerHTML;
            
            uploadBtn.innerHTML = '<span>‚è≥</span> Fazendo Upload...';
            uploadBtn.disabled = true;
            
            try {
                // Simulate upload process
                await sleep(2000);
                
                // Update technique with video URL (simulated)
                const videoUrl = `videos/${currentTechniqueForAudit.id}/${currentVideoFile.name}`;
                currentTechniqueForAudit.videoUrl = videoUrl;
                currentTechniqueForAudit.videoDescription = document.getElementById('videoDescription').value;
                
                showToast('V√≠deo carregado com sucesso!', 'success');
                closeVideoUploadModal();
                
                // Update audit stats
                updateAuditStats();
                
            } catch (error) {
                console.error('Erro no upload:', error);
                showToast('Erro durante o upload', 'error');
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            }
        }

        // Close video upload modal
        function closeVideoUploadModal() {
            document.getElementById('videoUploadModal').classList.remove('active');
            currentVideoFile = null;
            document.getElementById('videoPreview').innerHTML = '';
            document.getElementById('videoDescription').value = '';
        }

        // ==========================================
        // UTILITY FUNCTIONS FOR AUDIT
        // ==========================================

        function getStatusColor(status) {
            const colors = {
                'APPROVED': '#10B981',
                'PENDING': '#F59E0B',
                'REJECTED': '#EF4444'
            };
            return colors[status] || '#6B7280';
        }

        function getStatusName(status) {
            const names = {
                'APPROVED': 'Aprovada',
                'PENDING': 'Pendente',
                'REJECTED': 'Rejeitada'
            };
            return names[status] || status;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ==========================================
        // SISTEMA RAG - BASE DE CONHECIMENTO
        // ==========================================

        // Initialize knowledge base with sample data
        function initializeKnowledgeBase() {
            // Try to load from localStorage first
            const hasStoredData = loadKnowledgeBaseFromStorage();
            
            // If no stored data, initialize with sample data
            if (!hasStoredData) {
                knowledgeBase = [
                {
                    id: '1',
                    type: 'DOCUMENT',
                    title: 'Manual Krav Maga Faixa Branca',
                    content: 'O Krav Maga √© um sistema de defesa pessoal desenvolvido para as for√ßas de defesa israelenses. Princ√≠pios fundamentais: 1) Evitar conflitos sempre que poss√≠vel, 2) Neutralizar amea√ßas rapidamente, 3) Usar movimentos naturais e instintivos...',
                    tags: ['krav-maga', 'defesa-pessoal', 'iniciante', 'principios'],
                    category: 'METHODOLOGY',
                    martialArt: 'KRAV_MAGA',
                    level: 'BEGINNER',
                    createdAt: new Date().toISOString(),
                    chunked: true
                },
                {
                    id: '2',
                    type: 'TEXT',
                    title: 'Progress√£o Metodol√≥gica para Iniciantes',
                    content: 'A progress√£o no Krav Maga deve seguir uma ordem l√≥gica: 1) Consci√™ncia situacional e preven√ß√£o, 2) Posturas e movimentos b√°sicos, 3) T√©cnicas de golpes b√°sicos, 4) Defesas contra ataques simples, 5) Combina√ß√µes e fluxo...',
                    tags: ['progressao', 'metodologia', 'ensino'],
                    category: 'PROGRESSION',
                    martialArt: 'KRAV_MAGA',
                    level: 'BEGINNER',
                    createdAt: new Date().toISOString(),
                    chunked: true
                },
                {
                    id: '3',
                    type: 'LINK',
                    title: 'Fundamentos da Biomec√¢nica no Krav Maga',
                    content: 'A biomec√¢nica no Krav Maga enfatiza o uso eficiente do corpo para maximizar a for√ßa enquanto minimiza o gasto energ√©tico. Conceitos chave incluem: transfer√™ncia de peso, rota√ß√£o de quadril, alinhamento corporal...',
                    url: 'https://exemplo.com/biomecanica-krav-maga',
                    tags: ['biomecanica', 'tecnica', 'fundamentos'],
                    category: 'THEORY',
                    martialArt: 'KRAV_MAGA',
                    level: 'INTERMEDIATE',
                    createdAt: new Date().toISOString(),
                    chunked: true
                }
                ];
                
                // Generate chunks for RAG
                generateRAGChunks();
                
                // Save initial data to localStorage
                saveKnowledgeBaseToStorage();
            }
        }

        // Generate chunks for semantic search
        function generateRAGChunks() {
            ragChunks = [];
            let chunkId = 1;
            
            knowledgeBase.forEach(item => {
                // Split content into chunks of ~200 words
                const words = item.content.split(' ');
                const chunkSize = 200;
                
                for (let i = 0; i < words.length; i += chunkSize) {
                    const chunkWords = words.slice(i, i + chunkSize);
                    const chunkContent = chunkWords.join(' ');
                    
                    ragChunks.push({
                        id: chunkId++,
                        sourceId: item.id,
                        sourceType: item.type,
                        sourceTitle: item.title,
                        content: chunkContent,
                        tags: item.tags,
                        category: item.category,
                        martialArt: item.martialArt,
                        level: item.level,
                        embedding: generateMockEmbedding(chunkContent) // Simulated embedding
                    });
                }
            });
            
            // Save chunks to localStorage after generation
            saveKnowledgeBaseToStorage();
        }

        // Generate mock embedding (in real implementation, use actual AI embedding)
        function generateMockEmbedding(text) {
            // This is a simplified mock - in real implementation, use OpenAI embeddings or similar
            const words = text.toLowerCase().split(' ');
            const vector = new Array(384).fill(0); // 384-dimensional vector
            
            words.forEach((word, index) => {
                const hash = word.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0);
                vector[Math.abs(hash) % 384] += 1;
            });
            
            // Normalize vector
            const magnitude = Math.sqrt(vector.reduce((sum, val) => sum + val * val, 0));
            return vector.map(val => magnitude > 0 ? val / magnitude : 0);
        }

        // Open knowledge base panel
        function openKnowledgeBase() {
            document.getElementById('knowledgeBasePanel').style.display = 'block';
            if (knowledgeBase.length === 0) {
                initializeKnowledgeBase();
            }
            updateKnowledgeBaseStats();
            displayKnowledgeContent();
        }

        // Close knowledge base panel
        function closeKnowledgeBase() {
            document.getElementById('knowledgeBasePanel').style.display = 'none';
        }

        // Update knowledge base statistics
        function updateKnowledgeBaseStats() {
            const documents = knowledgeBase.filter(item => item.type === 'DOCUMENT').length;
            const texts = knowledgeBase.filter(item => item.type === 'TEXT').length;
            const links = knowledgeBase.filter(item => item.type === 'LINK').length;
            const chunks = ragChunks.length;
            
            document.getElementById('documentsCount').textContent = documents;
            document.getElementById('textsCount').textContent = texts;
            document.getElementById('linksCount').textContent = links;
            document.getElementById('chunksCount').textContent = chunks;
            
            const lastIndexed = knowledgeBase.length > 0 ? 'Agora mesmo' : 'Nunca';
            document.getElementById('lastIndexed').textContent = lastIndexed;
        }

        // Display knowledge content
        function displayKnowledgeContent() {
            const contentDiv = document.getElementById('knowledgeContent');
            
            if (knowledgeBase.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; color: #CBD5E1; padding: 2rem;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üß†</div>
                        Sua base de conhecimento est√° vazia. Clique em "Adicionar Conte√∫do" para come√ßar.
                    </div>
                `;
                return;
            }
            
            const groupedByType = {
                'DOCUMENT': knowledgeBase.filter(item => item.type === 'DOCUMENT'),
                'TEXT': knowledgeBase.filter(item => item.type === 'TEXT'),
                'LINK': knowledgeBase.filter(item => item.type === 'LINK'),
                'YOUTUBE': knowledgeBase.filter(item => item.type === 'YOUTUBE')
            };
            
            let html = '';
            
            Object.entries(groupedByType).forEach(([type, items]) => {
                if (items.length === 0) return;
                
                const typeInfo = {
                    'DOCUMENT': { icon: 'üìÑ', name: 'Documentos', color: '#8B5CF6' },
                    'TEXT': { icon: 'üìù', name: 'Textos', color: '#10B981' },
                    'LINK': { icon: 'üîó', name: 'Links', color: '#3B82F6' },
                    'YOUTUBE': { icon: 'üì∫', name: 'YouTube', color: '#EF4444' }
                };
                
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: ${typeInfo[type].color}; margin-bottom: 1rem;">${typeInfo[type].icon} ${typeInfo[type].name} (${items.length})</h3>
                        ${items.map(item => `
                            <div style="background: rgba(55, 65, 81, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid ${typeInfo[type].color};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: #F8FAFC; margin-bottom: 0.5rem;">${item.title}</div>
                                        <div style="color: #CBD5E1; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                            ${item.content.length > 100 ? item.content.substring(0, 100) + '...' : item.content}
                                        </div>
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                                            ${item.tags.map(tag => `
                                                <span style="background: ${typeInfo[type].color}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                                    ${tag}
                                                </span>
                                            `).join('')}
                                        </div>
                                        <div style="font-size: 0.8rem; color: #9CA3AF;">
                                            ${getMartialArtName(item.martialArt)} ‚Ä¢ ${item.category} ‚Ä¢ ${item.level}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button onclick="editKnowledgeItem('${item.id}')" 
                                                style="background: #F59E0B; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="deleteKnowledgeItem('${item.id}')" 
                                                style="background: #EF4444; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
        }

        // Open document uploader
        function openDocumentUploader() {
            console.log('üìé Abrindo modal de upload...');
            const modal = document.getElementById('documentUploaderModal');
            if (modal) {
                modal.classList.add('active');
                switchUploadTab('documents');
                console.log('‚úÖ Modal de upload aberto com sucesso!');
            } else {
                console.error('‚ùå Modal documentUploaderModal n√£o encontrado!');
            }
        }

        // Close document uploader
        function closeDocumentUploader() {
            document.getElementById('documentUploaderModal').classList.remove('active');
            resetUploadForm();
        }

        // Switch upload tab
        function switchUploadTab(tabName) {
            currentUploadTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.upload-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Show/hide sections
            document.querySelectorAll('.upload-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(tabName + 'Section').style.display = 'block';
        }

        // Handle document upload
        function handleDocumentUpload(event) {
            const files = Array.from(event.target.files);
            uploadedDocuments = files;
            
            displayDocumentPreview(files);
        }

        // Display document preview
        function displayDocumentPreview(files) {
            const preview = document.getElementById('documentPreview');
            
            if (files.length === 0) {
                preview.innerHTML = '';
                return;
            }
            
            preview.innerHTML = `
                <div style="text-align: left; margin-top: 1rem; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid #8B5CF6;">
                    <div style="color: #8B5CF6; font-weight: bold; margin-bottom: 0.5rem;">üìé ${files.length} Arquivo(s) Selecionado(s):</div>
                    ${files.map(file => `
                        <div style="color: #F8FAFC; margin-bottom: 0.25rem;">
                            ${getFileIcon(file.name)} ${file.name} (${formatFileSize(file.size)})
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Upload content to knowledge base
        async function uploadContent() {
            console.log('üöÄ Iniciando upload de conte√∫do...');
            const uploadBtn = document.getElementById('uploadContentBtn');
            const originalText = uploadBtn.innerHTML;
            
            uploadBtn.innerHTML = '<span>‚è≥</span> Processando...';
            uploadBtn.disabled = true;
            
            try {
                console.log('üìä Tab atual:', currentUploadTab);
                let newItems = [];
                
                switch (currentUploadTab) {
                    case 'documents':
                        console.log('üìÑ Processando documentos...');
                        newItems = await processDocuments();
                        break;
                    case 'text':
                        console.log('üìù Processando texto...');
                        newItems = await processTextInput();
                        break;
                    case 'links':
                        console.log('üîó Processando links...');
                        newItems = await processLink();
                        break;
                    case 'youtube':
                        console.log('üì∫ Processando YouTube...');
                        newItems = await processYouTube();
                        break;
                }
                
                // Add to knowledge base
                console.log('üìö Itens processados:', newItems.length);
                console.log('üìÅ Base antes:', knowledgeBase.length);
                
                knowledgeBase.push(...newItems);
                
                console.log('üìÅ Base depois:', knowledgeBase.length);
                
                // Regenerate chunks
                console.log('‚ö° Gerando chunks RAG...');
                generateRAGChunks();
                
                // Save to localStorage (generateRAGChunks already saves, but being explicit)
                console.log('üíæ Salvando no localStorage...');
                saveKnowledgeBaseToStorage();
                
                // Update display
                console.log('üîÑ Atualizando interface...');
                updateKnowledgeBaseStats();
                displayKnowledgeContent();
                
                // Also update main section if it's open
                const currentSection = document.querySelector('.content-section:not([style*="display: none"])');
                if (currentSection && currentSection.id === 'knowledge-base') {
                    displayKnowledgeContentInMain();
                }
                
                closeDocumentUploader();
                
                // Show detailed success message
                const successMessage = `‚úÖ SUCESSO! ${newItems.length} item(s) processado(s):
üìÅ Base: ${knowledgeBase.length} itens total
üß† Chunks: ${ragChunks.length} chunks RAG
üíæ Salvo no localStorage
üîÑ Interface atualizada`;
                
                showToast(successMessage, 'success');
                
                // Also log detailed info to console
                console.log('üéâ UPLOAD COMPLETO!');
                console.log('üìä Estat√≠sticas finais:');
                console.log('  üìÅ Total na base:', knowledgeBase.length);
                console.log('  üß† Total chunks:', ragChunks.length);
                console.log('  üíæ Salvo no localStorage:', !!localStorage.getItem('academiaKnowledgeBase'));
                console.log('  üìã Itens adicionados:', newItems.map(item => item.title));
                
            } catch (error) {
                console.error('Erro no upload:', error);
                showToast('Erro ao processar conte√∫do', 'error');
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            }
        }

        // Process documents
        async function processDocuments() {
            if (uploadedDocuments.length === 0) {
                throw new Error('Nenhum documento selecionado');
            }
            
            const tags = document.getElementById('documentTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const items = [];
            
            for (const file of uploadedDocuments) {
                // Simulate document processing
                await sleep(500);
                
                const content = await simulateDocumentExtraction(file);
                
                items.push({
                    id: generateId(),
                    type: 'DOCUMENT',
                    title: file.name.replace(/\.[^/.]+$/, ''),
                    content: content,
                    filename: file.name,
                    fileSize: file.size,
                    tags: tags,
                    category: 'METHODOLOGY',
                    martialArt: 'GENERAL',
                    level: 'BEGINNER',
                    createdAt: new Date().toISOString(),
                    chunked: false
                });
            }
            
            return items;
        }

        // Process text input
        async function processTextInput() {
            console.log('‚úèÔ∏è Processando entrada de texto...');
            const title = document.getElementById('textTitle').value.trim();
            const content = document.getElementById('textContent').value.trim();
            const category = document.getElementById('textCategory').value || 'METHODOLOGY';
            const tags = document.getElementById('textTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            console.log('üìù Dados coletados:', { title, content: content.substring(0, 50) + '...', category, tags });
            
            if (!title || !content) {
                console.error('‚ùå T√≠tulo ou conte√∫do vazio');
                throw new Error('T√≠tulo e conte√∫do s√£o obrigat√≥rios');
            }
            
            const newItem = {
                id: generateId(),
                type: 'TEXT',
                title: title,
                content: content,
                tags: tags,
                category: category,
                martialArt: 'GENERAL',
                level: 'BEGINNER',
                createdAt: new Date().toISOString(),
                chunked: false
            };
            
            console.log('‚úÖ Item de texto criado:', newItem);
            return [newItem];
        }

        // Process link
        async function processLink() {
            const url = document.getElementById('linkUrl').value.trim();
            const title = document.getElementById('linkTitle').value.trim();
            const description = document.getElementById('linkDescription').value.trim();
            const tags = document.getElementById('linkTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            if (!url) {
                throw new Error('URL √© obrigat√≥ria');
            }
            
            // Simulate web scraping
            await sleep(1000);
            const extractedContent = await simulateWebScraping(url);
            
            return [{
                id: generateId(),
                type: 'LINK',
                title: title || extractedContent.title,
                content: description || extractedContent.content,
                url: url,
                tags: tags,
                category: 'THEORY',
                martialArt: 'GENERAL',
                level: 'INTERMEDIATE',
                createdAt: new Date().toISOString(),
                chunked: false
            }];
        }

        // Process YouTube
        async function processYouTube() {
            const url = document.getElementById('youtubeUrl').value.trim();
            const description = document.getElementById('youtubeDescription').value.trim();
            const tags = document.getElementById('youtubeTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            if (!url || !url.includes('youtube.com')) {
                throw new Error('URL v√°lida do YouTube √© obrigat√≥ria');
            }
            
            // Simulate YouTube transcript extraction
            await sleep(1500);
            const transcriptData = await simulateYouTubeTranscript(url);
            
            return [{
                id: generateId(),
                type: 'YOUTUBE',
                title: transcriptData.title,
                content: description || transcriptData.transcript,
                url: url,
                videoId: transcriptData.videoId,
                duration: transcriptData.duration,
                tags: tags,
                category: 'TECHNIQUES',
                martialArt: 'GENERAL',
                level: 'INTERMEDIATE',
                createdAt: new Date().toISOString(),
                chunked: false
            }];
        }

        // Simulate document extraction (in real implementation, use PDF.js, mammoth.js, etc.)
        async function simulateDocumentExtraction(file) {
            const sampleContents = {
                'pdf': 'Conte√∫do extra√≠do do PDF: Este documento cont√©m informa√ß√µes detalhadas sobre t√©cnicas de defesa pessoal, incluindo posturas b√°sicas, movimentos fundamentais e princ√≠pios de seguran√ßa...',
                'doc': 'Conte√∫do extra√≠do do DOC: Manual de treinamento com metodologia estruturada para ensino de artes marciais, progress√£o pedag√≥gica e avalia√ß√£o de alunos...',
                'txt': 'Conte√∫do do arquivo TXT: Notas e observa√ß√µes sobre a aplica√ß√£o pr√°tica de t√©cnicas em situa√ß√µes reais, considera√ß√µes de seguran√ßa e adapta√ß√µes para diferentes p√∫blicos...'
            };
            
            const extension = file.name.split('.').pop().toLowerCase();
            return sampleContents[extension] || 'Conte√∫do extra√≠do do documento carregado com informa√ß√µes relevantes para a base de conhecimento.';
        }

        // Simulate web scraping
        async function simulateWebScraping(url) {
            return {
                title: 'Artigo sobre Biomec√¢nica em Artes Marciais',
                content: 'Artigo t√©cnico sobre a aplica√ß√£o de princ√≠pios biomec√¢nicos no treinamento de artes marciais, incluindo an√°lise de movimento, efici√™ncia energ√©tica e preven√ß√£o de les√µes...'
            };
        }

        // Simulate YouTube transcript
        async function simulateYouTubeTranscript(url) {
            const videoId = url.split('v=')[1] || 'mock-video-id';
            
            return {
                title: 'Tutorial: T√©cnica de Defesa B√°sica',
                videoId: videoId,
                duration: '8:45',
                transcript: 'Transcri√ß√£o do v√≠deo: Hoje vamos aprender a t√©cnica b√°sica de defesa contra agarramento frontal. Primeiro, posicionem os p√©s na largura dos ombros...'
            };
        }

        // Reset upload form
        function resetUploadForm() {
            uploadedDocuments = [];
            
            // Clear all form fields
            document.getElementById('documentFiles').value = '';
            document.getElementById('documentTags').value = '';
            document.getElementById('documentPreview').innerHTML = '';
            
            document.getElementById('textTitle').value = '';
            document.getElementById('textContent').value = '';
            document.getElementById('textCategory').value = '';
            document.getElementById('textTags').value = '';
            
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkTitle').value = '';
            document.getElementById('linkDescription').value = '';
            document.getElementById('linkTags').value = '';
            
            document.getElementById('youtubeUrl').value = '';
            document.getElementById('youtubeDescription').value = '';
            document.getElementById('youtubeTags').value = '';
        }

        // Search knowledge base
        function searchKnowledge() {
            const query = document.getElementById('knowledgeSearch').value.trim();
            if (!query) {
                displayKnowledgeContent();
                return;
            }
            
            // Simple text search (in real implementation, use semantic search)
            const results = knowledgeBase.filter(item => 
                item.title.toLowerCase().includes(query.toLowerCase()) ||
                item.content.toLowerCase().includes(query.toLowerCase()) ||
                item.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
            );
            
            displaySearchResults(results, query);
        }

        // Display search results
        function displaySearchResults(results, query) {
            const contentDiv = document.getElementById('knowledgeContent');
            
            if (results.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; color: #CBD5E1; padding: 2rem;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üîç</div>
                        Nenhum resultado encontrado para "${query}"
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                    <h3 style="color: #3B82F6; margin-bottom: 0.5rem;">üîç Resultados da Busca</h3>
                    <div style="color: #CBD5E1;">Encontrados ${results.length} resultado(s) para "${query}"</div>
                </div>
            `;
            
            results.forEach(item => {
                const typeInfo = {
                    'DOCUMENT': { icon: 'üìÑ', color: '#8B5CF6' },
                    'TEXT': { icon: 'üìù', color: '#10B981' },
                    'LINK': { icon: 'üîó', color: '#3B82F6' },
                    'YOUTUBE': { icon: 'üì∫', color: '#EF4444' }
                };
                
                const info = typeInfo[item.type];
                
                html += `
                    <div style="background: rgba(55, 65, 81, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid ${info.color};">
                        <div style="font-weight: bold; color: #F8FAFC; margin-bottom: 0.5rem;">
                            ${info.icon} ${item.title}
                        </div>
                        <div style="color: #CBD5E1; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            ${highlightQuery(item.content.substring(0, 200) + '...', query)}
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${item.tags.map(tag => `
                                <span style="background: ${info.color}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                    ${highlightQuery(tag, query)}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
        }

        // Highlight query in text
        function highlightQuery(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark style="background: #F59E0B; color: #000;">$1</mark>');
        }

        // Test RAG system
        function testRAG() {
            document.getElementById('ragTestModal').classList.add('active');
        }

        // Close RAG test modal
        function closeRAGTest() {
            document.getElementById('ragTestModal').classList.remove('active');
            document.getElementById('ragQuestion').value = '';
            document.getElementById('ragResults').innerHTML = `
                <div style="text-align: center; color: #9CA3AF; padding: 2rem;">
                    Digite sua pergunta e clique em "Consultar RAG" para ver a resposta
                </div>
            `;
        }

        // Consult RAG system
        async function consultRAG() {
            const question = document.getElementById('ragQuestion').value.trim();
            const martialArt = document.getElementById('ragMartialArt').value;
            const level = document.getElementById('ragLevel').value;
            
            if (!question) {
                showToast('Digite uma pergunta primeiro', 'error');
                return;
            }
            
            const consultBtn = document.getElementById('consultRAGBtn');
            const originalText = consultBtn.innerHTML;
            
            consultBtn.innerHTML = '<span>üß†</span> Consultando...';
            consultBtn.disabled = true;
            
            try {
                // Simulate RAG query
                const response = await simulateRAGQuery(question, martialArt, level);
                displayRAGResponse(response);
                
            } catch (error) {
                console.error('Erro na consulta RAG:', error);
                showToast('Erro na consulta', 'error');
            } finally {
                consultBtn.innerHTML = originalText;
                consultBtn.disabled = false;
            }
        }

        // Simulate RAG query (in real implementation, use vector search + LLM)
        async function simulateRAGQuery(question, martialArt, level) {
            await sleep(1500);
            
            // Find relevant chunks based on keywords
            const queryWords = question.toLowerCase().split(' ');
            const relevantChunks = ragChunks.filter(chunk => {
                const chunkWords = chunk.content.toLowerCase();
                return queryWords.some(word => chunkWords.includes(word)) ||
                       (martialArt && chunk.martialArt === martialArt) ||
                       (level && chunk.level === level);
            }).slice(0, 3); // Top 3 most relevant chunks
            
            if (relevantChunks.length === 0) {
                return {
                    answer: 'Desculpe, n√£o encontrei informa√ß√µes relevantes na sua base de conhecimento para responder essa pergunta. Considere adicionar mais conte√∫do relacionado ao tema.',
                    sources: [],
                    confidence: 0
                };
            }
            
            // Simulate LLM response based on retrieved chunks
            const context = relevantChunks.map(chunk => chunk.content).join('\n\n');
            
            return {
                answer: `Baseado na sua base de conhecimento, posso responder: ${generateContextualAnswer(question, context)}`,
                sources: relevantChunks.map(chunk => ({
                    title: chunk.sourceTitle,
                    type: chunk.sourceType,
                    relevantText: chunk.content.substring(0, 150) + '...'
                })),
                confidence: Math.round(Math.random() * 30 + 70) // 70-100%
            };
        }

        // Generate contextual answer
        function generateContextualAnswer(question, context) {
            const questionLower = question.toLowerCase();
            
            if (questionLower.includes('defesa') && questionLower.includes('iniciante')) {
                return 'Para iniciantes, a defesa deve come√ßar com consci√™ncia situacional e preven√ß√£o. As t√©cnicas b√°sicas incluem posturas defensivas, movimentos naturais e contra-ataques simples. √â importante sempre priorizar a fuga e buscar ajuda quando poss√≠vel.';
            }
            
            if (questionLower.includes('progress√£o') || questionLower.includes('metodologia')) {
                return 'A progress√£o metodol√≥gica deve seguir uma sequ√™ncia l√≥gica: primeiro os fundamentos (postura, dist√¢ncia), depois t√©cnicas b√°sicas (golpes simples), defesas contra ataques comuns, e por fim combina√ß√µes mais complexas. Cada etapa deve ser dominada antes de avan√ßar.';
            }
            
            if (questionLower.includes('ensinar') || questionLower.includes('instrutor')) {
                return 'Para ensinar efetivamente, utilize demonstra√ß√£o clara, pr√°tica repetitiva, corre√ß√£o individual e progress√£o gradual. Adapte as t√©cnicas conforme a capacidade de cada aluno e sempre enfatize a seguran√ßa e os princ√≠pios fundamentais.';
            }
            
            return 'Baseado no contexto da sua base de conhecimento, esta informa√ß√£o est√° relacionada aos princ√≠pios e metodologias que voc√™ documentou. Recomendo revisar os documentos espec√≠ficos para detalhes mais aprofundados.';
        }

        // Display RAG response
        function displayRAGResponse(response) {
            const resultsDiv = document.getElementById('ragResults');
            
            resultsDiv.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <!-- Answer -->
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #10B981;">
                        <h4 style="color: #10B981; margin-bottom: 0.5rem;">ü§ñ Resposta da IA</h4>
                        <div style="color: #F8FAFC; line-height: 1.6;">${response.answer}</div>
                    </div>
                    
                    <!-- Confidence -->
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #3B82F6; font-weight: bold;">Confian√ßa da Resposta:</span>
                            <span style="color: #F8FAFC; font-size: 1.1rem;">${response.confidence}%</span>
                        </div>
                        <div style="background: #374151; height: 6px; border-radius: 3px; margin-top: 0.5rem; overflow: hidden;">
                            <div style="background: #3B82F6; height: 100%; width: ${response.confidence}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <!-- Sources -->
                    ${response.sources.length > 0 ? `
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px;">
                            <h4 style="color: #F59E0B; margin-bottom: 0.5rem;">üìö Fontes Consultadas</h4>
                            ${response.sources.map(source => `
                                <div style="background: rgba(55, 65, 81, 0.5); padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 6px;">
                                    <div style="font-weight: bold; color: #F8FAFC; margin-bottom: 0.25rem;">
                                        ${getTypeIcon(source.type)} ${source.title}
                                    </div>
                                    <div style="color: #CBD5E1; font-size: 0.9rem;">${source.relevantText}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Get type icon
        function getTypeIcon(type) {
            const icons = {
                'DOCUMENT': 'üìÑ',
                'TEXT': 'üìù',
                'LINK': 'üîó',
                'YOUTUBE': 'üì∫'
            };
            return icons[type] || 'üìÑ';
        }

        // Reindex knowledge base
        async function reindexKnowledgeBase() {
            const reindexBtn = document.querySelector('#knowledgeBasePanel .btn-success');
            const originalText = reindexBtn.innerHTML;
            
            reindexBtn.innerHTML = '<span>‚ö°</span> Reindexando...';
            reindexBtn.disabled = true;
            
            try {
                await sleep(2000);
                generateRAGChunks();
                updateKnowledgeBaseStats();
                
                showToast('Base de conhecimento reindexada com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro na reindexa√ß√£o:', error);
                showToast('Erro durante a reindexa√ß√£o', 'error');
            } finally {
                reindexBtn.innerHTML = originalText;
                reindexBtn.disabled = false;
            }
        }

        // Edit knowledge item (placeholder)
        function editKnowledgeItem(itemId) {
            showToast('Funcionalidade de edi√ß√£o ser√° implementada', 'info');
        }

        // Delete knowledge item
        function deleteKnowledgeItem(itemId) {
            if (confirm('Tem certeza que deseja remover este item da base de conhecimento?')) {
                knowledgeBase = knowledgeBase.filter(item => item.id !== itemId);
                generateRAGChunks();
                updateKnowledgeBaseStats();
                displayKnowledgeContent();
                showToast('Item removido da base de conhecimento', 'success');
            }
        }

        // RAG-Enhanced audit helper functions
        function analyzeQualityWithRAG(techniques, ragGuidance) {
            const qualityIssues = [];
            
            // Extract quality criteria from RAG if available
            const ragCriteria = extractQualityCriteria(ragGuidance);
            
            techniques.forEach(tech => {
                let score = 100;
                const issues = [];
                
                // Standard quality checks
                if (tech.name.length < 3) {
                    score -= 20;
                    issues.push('Nome muito curto');
                }
                
                if (!tech.description || tech.description.length < 10) {
                    score -= 15;
                    issues.push('Descri√ß√£o insuficiente');
                }
                
                if (tech.level === 'ADVANCED' && !tech.prerequisites) {
                    score -= 10;
                    issues.push('T√©cnica avan√ßada sem pr√©-requisitos');
                }
                
                // RAG-Enhanced quality checks
                if (ragCriteria.length > 0) {
                    ragCriteria.forEach(criterion => {
                        if (!evaluateCriterion(tech, criterion)) {
                            score -= criterion.penalty;
                            issues.push(`üß† RAG: ${criterion.message}`);
                        }
                    });
                }
                
                // Check consistency with RAG standards
                if (ragGuidance.success) {
                    if (tech.description && !containsKeyElements(tech.description, ragGuidance)) {
                        score -= 5;
                        issues.push('üß† RAG: Descri√ß√£o n√£o segue padr√µes documentados');
                    }
                }
                
                if (issues.length > 0) {
                    qualityIssues.push({
                        type: 'QUALITY',
                        technique: tech,
                        severity: score < 60 ? 'HIGH' : (score < 80 ? 'MEDIUM' : 'LOW'),
                        score: score,
                        issues: issues,
                        message: `T√©cnica "${tech.name}" - Score: ${score}/100`,
                        ragEnhanced: ragGuidance.success
                    });
                }
            });
            
            return qualityIssues;
        }
        
        // Extract quality criteria from RAG guidance
        function extractQualityCriteria(ragGuidance) {
            if (!ragGuidance || !ragGuidance.success) {
                return [];
            }
            
            const criteria = [];
            const content = ragGuidance.answer.toLowerCase();
            
            // Look for common quality indicators in RAG content
            if (content.includes('seguranca') || content.includes('seguran√ßa')) {
                criteria.push({
                    field: 'safetyNotes',
                    required: true,
                    penalty: 15,
                    message: 'Faltam considera√ß√µes de seguran√ßa'
                });
            }
            
            if (content.includes('prerequisito') || content.includes('pr√©-requisito')) {
                criteria.push({
                    field: 'prerequisites',
                    required: true,
                    penalty: 10,
                    message: 'Pr√©-requisitos n√£o especificados'
                });
            }
            
            if (content.includes('progressao') || content.includes('progress√£o')) {
                criteria.push({
                    field: 'progressionNotes',
                    required: false,
                    penalty: 5,
                    message: 'Notas de progress√£o ausentes'
                });
            }
            
            return criteria;
        }
        
        // Evaluate a criterion against a technique
        function evaluateCriterion(technique, criterion) {
            const field = technique[criterion.field];
            
            if (criterion.required) {
                return field && field.length > 0;
            }
            
            return true; // Non-required criteria pass by default
        }
        
        // Check if description contains key elements from RAG
        function containsKeyElements(description, ragGuidance) {
            const content = ragGuidance.answer.toLowerCase();
            const desc = description.toLowerCase();
            
            // Extract key terms from RAG guidance
            const keyTerms = ['tecnica', 'movimento', 'posicao', 'defensiva', 'ataque'];
            const foundTerms = keyTerms.filter(term => content.includes(term) && desc.includes(term));
            
            return foundTerms.length >= 2; // At least 2 key terms should match
        }
        
        // Global RAG query function for any agent
        async function queryRAGForAgent(query, agentType, context = {}) {
            const fullContext = {
                ...context,
                agent: agentType
            };
            
            return await centralRAG.queryKnowledge(query, fullContext);
        }
        
        // ==========================================
        // KNOWLEDGE BASE FRONTEND FUNCTIONS
        // ==========================================
        
        // Open knowledge uploader modal (Global function)
        window.openKnowledgeUploader = function() {
            console.log('üìö Abrindo base de conhecimento...');
            // Call the existing document uploader function
            openDocumentUploader();
        };
        
        // Test RAG system (Global function)
        window.testRAGSystem = function() {
            document.getElementById('ragTestModal').classList.add('active');
            // Reset the form
            document.getElementById('ragQuestion').value = '';
            document.getElementById('ragMartialArt').value = '';
            document.getElementById('ragLevel').value = '';
            document.getElementById('ragResults').innerHTML = `
                <div style="text-align: center; color: #9CA3AF; padding: 2rem;">
                    Digite sua pergunta e clique em "Consultar RAG" para ver a resposta
                </div>
            `;
        };
        
        // Enhanced reindex function (Global function)
        window.reindexKnowledgeBase = function() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<span>‚ö°</span> Reindexando...';
            btn.disabled = true;
            
            setTimeout(() => {
                generateRAGChunks();
                updateKnowledgeBaseStats();
                displayKnowledgeContentInMain();
                
                showToast('Base de conhecimento reindexada com sucesso!', 'success');
                
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        };
        
        // Search knowledge base (Global function)
        window.searchKnowledgeBase = function() {
            const query = document.getElementById('knowledgeSearchInput').value.trim();
            if (query) {
                searchKnowledgeContentInMain(query);
            } else {
                displayKnowledgeContentInMain();
            }
        };
        
        // Search function specifically for main section
        function searchKnowledgeContentInMain(query) {
            const results = knowledgeBase.filter(item => {
                const searchText = `${item.title} ${item.content} ${item.tags.join(' ')}`.toLowerCase();
                return searchText.includes(query.toLowerCase());
            });
            
            const contentDiv = document.getElementById('knowledgeContentDisplay');
            if (!contentDiv) return;
            
            if (results.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; color: #CBD5E1; padding: 2rem;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üîç</div>
                        Nenhum resultado encontrado para "${query}"
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="displayKnowledgeContentInMain()">
                                üìã Mostrar Tudo
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                    <h3 style="color: #3B82F6; margin-bottom: 0.5rem;">üîç Resultados da Busca</h3>
                    <div style="color: #CBD5E1;">Encontrados ${results.length} resultado(s) para "${query}"</div>
                    <button class="btn btn-sm btn-secondary" onclick="displayKnowledgeContentInMain()" style="margin-top: 0.5rem;">
                        üìã Mostrar Tudo
                    </button>
                </div>
            `;
            
            results.forEach(item => {
                const typeInfo = {
                    'DOCUMENT': { icon: 'üìÑ', color: '#8B5CF6' },
                    'TEXT': { icon: 'üìù', color: '#10B981' },
                    'LINK': { icon: 'üîó', color: '#3B82F6' },
                    'YOUTUBE': { icon: 'üì∫', color: '#EF4444' }
                };
                
                const info = typeInfo[item.type];
                
                // Highlight query in text
                const highlightedContent = item.content.substring(0, 200).replace(
                    new RegExp(`(${query})`, 'gi'),
                    '<mark style="background: #F59E0B; color: #000;">$1</mark>'
                );
                
                html += `
                    <div style="background: rgba(55, 65, 81, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid ${info.color};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div style="font-weight: bold; color: #F8FAFC;">
                                ${info.icon} ${item.title}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="editKnowledgeItem('${item.id}')" style="background: none; border: none; color: #3B82F6; cursor: pointer; padding: 0.25rem; font-size: 1rem;" title="Editar">‚úèÔ∏è</button>
                                <button onclick="deleteKnowledgeItem('${item.id}')" style="background: none; border: none; color: #EF4444; cursor: pointer; padding: 0.25rem; font-size: 1rem;" title="Excluir">‚ùå</button>
                            </div>
                        </div>
                        <div style="color: #CBD5E1; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            ${highlightedContent}${item.content.length > 200 ? '...' : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                            ${item.tags.map(tag => {
                                const highlightedTag = tag.replace(new RegExp(`(${query})`, 'gi'), '<mark style="background: rgba(255,255,255,0.3); color: white;">$1</mark>');
                                return `<span style="background: ${info.color}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${highlightedTag}</span>`;
                            }).join('')}
                        </div>
                        <div style="font-size: 0.75rem; color: #9CA3AF;">
                            Adicionado: ${new Date(item.createdAt).toLocaleDateString('pt-BR')}
                        </div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
        }
        
        // Update knowledge base stats in the main section
        function updateKnowledgeBaseStats() {
            const documentsCount = knowledgeBase.length;
            const chunksCount = ragChunks.length;
            const lastUpdate = documentsCount > 0 ? 'Agora mesmo' : 'Nunca';
            const status = documentsCount > 0 ? 'Ativo' : 'Vazio';
            
            // Main section stats
            const documentsEl = document.getElementById('knowledgeStatsDocuments');
            const chunksEl = document.getElementById('knowledgeStatsChunks');
            const lastUpdateEl = document.getElementById('knowledgeStatsLastUpdate');
            const statusEl = document.getElementById('knowledgeStatsStatus');
            
            if (documentsEl) documentsEl.textContent = documentsCount;
            if (chunksEl) chunksEl.textContent = chunksCount;
            if (lastUpdateEl) lastUpdateEl.textContent = lastUpdate;
            if (statusEl) statusEl.textContent = status;
            
            // Update badge
            const badge = document.getElementById('knowledge-base-badge');
            if (badge) {
                if (documentsCount > 0) {
                    badge.textContent = documentsCount.toString();
                    badge.style.background = '#10B981';
                } else {
                    badge.textContent = 'RAG';
                    badge.style.background = '#8B5CF6';
                }
            }
        }
        
        // Display knowledge base content in the main section
        function displayKnowledgeContentInMain() {
            const contentDiv = document.getElementById('knowledgeContentDisplay');
            if (!contentDiv) return;
            
            if (knowledgeBase.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; color: #9CA3AF; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìö</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Base de Conhecimento Vazia</div>
                        <div style="font-size: 0.9rem;">Adicione documentos, textos, links ou v√≠deos para come√ßar</div>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="openKnowledgeUploader()">
                                ‚ûï Adicionar Primeiro Conte√∫do
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            knowledgeBase.forEach(item => {
                const typeInfo = {
                    'DOCUMENT': { icon: 'üìÑ', color: '#8B5CF6' },
                    'TEXT': { icon: 'üìù', color: '#10B981' },
                    'LINK': { icon: 'üîó', color: '#3B82F6' },
                    'YOUTUBE': { icon: 'üì∫', color: '#EF4444' }
                };
                
                const info = typeInfo[item.type];
                
                html += `
                    <div style="background: rgba(55, 65, 81, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid ${info.color};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div style="font-weight: bold; color: #F8FAFC;">
                                ${info.icon} ${item.title}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="editKnowledgeItem('${item.id}')" style="background: none; border: none; color: #3B82F6; cursor: pointer; padding: 0.25rem; font-size: 1rem;" title="Editar">‚úèÔ∏è</button>
                                <button onclick="deleteKnowledgeItem('${item.id}')" style="background: none; border: none; color: #EF4444; cursor: pointer; padding: 0.25rem; font-size: 1rem;" title="Excluir">‚ùå</button>
                            </div>
                        </div>
                        <div style="color: #CBD5E1; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            ${item.content.substring(0, 200)}${item.content.length > 200 ? '...' : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                            ${item.tags.map(tag => `
                                <span style="background: ${info.color}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                    ${tag}
                                </span>
                            `).join('')}
                        </div>
                        <div style="font-size: 0.75rem; color: #9CA3AF;">
                            Adicionado: ${new Date(item.createdAt).toLocaleDateString('pt-BR')}
                        </div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
        }
        
        // Override existing upload function to update main section
        const originalUploadContent = uploadContent;
        if (typeof uploadContent === 'function') {
            uploadContent = function() {
                const result = originalUploadContent.apply(this, arguments);
                setTimeout(() => {
                    updateKnowledgeBaseStats();
                    displayKnowledgeContentInMain();
                }, 500);
                return result;
            };
        }
        
        // Override delete function to update main section
        const originalDeleteKnowledgeItem = deleteKnowledgeItem;
        if (typeof deleteKnowledgeItem === 'function') {
            deleteKnowledgeItem = function(itemId) {
                const result = originalDeleteKnowledgeItem.apply(this, arguments);
                setTimeout(() => {
                    updateKnowledgeBaseStats();
                    displayKnowledgeContentInMain();
                }, 100);
                return result;
            };
        }
        
        // Enhanced showSection to handle knowledge base - will be defined later
        function enhanceShowSection() {
            if (typeof showSection === 'function') {
                const originalShowSection = showSection;
                window.showSection = function(sectionName) {
                    originalShowSection(sectionName);
                    
                    if (sectionName === 'knowledge-base') {
                        setTimeout(() => {
                            if (typeof updateKnowledgeBaseStats === 'function') updateKnowledgeBaseStats();
                            if (typeof displayKnowledgeContentInMain === 'function') displayKnowledgeContentInMain();
                        }, 100);
                    }
                };
            }
        }
        
        // Test function for debugging
        function testKnowledgeBase() {
            console.log('üß™ Testando base de conhecimento...');
            console.log('üìÅ Base atual:', knowledgeBase);
            console.log('üï∞Ô∏è Chunks atuais:', ragChunks);
            
            // Add test item
            const testItem = {
                id: 'test-' + Date.now(),
                type: 'TEXT',
                title: 'Teste de Funcionamento',
                content: 'Este √© um item de teste para verificar se a base de conhecimento est√° funcionando.',
                tags: ['teste', 'debug'],
                category: 'TEST',
                martialArt: 'GENERAL',
                level: 'BEGINNER',
                createdAt: new Date().toISOString(),
                chunked: false
            };
            
            knowledgeBase.push(testItem);
            generateRAGChunks();
            updateKnowledgeBaseStats();
            displayKnowledgeContentInMain();
            
            console.log('‚úÖ Item de teste adicionado!');
            console.log('üìÅ Base ap√≥s teste:', knowledgeBase);
            
            // Add clear storage button for testing
            setTimeout(() => {
                const clearBtn = document.createElement('button');
                clearBtn.className = 'btn btn-danger';
                clearBtn.innerHTML = 'üóëÔ∏è Limpar Storage';
                clearBtn.onclick = function() {
                    if (confirm('Limpar toda a base de conhecimento do localStorage?')) {
                        clearKnowledgeBaseStorage();
                        updateKnowledgeBaseStats();
                        displayKnowledgeContentInMain();
                        showToast('Base de conhecimento limpa!', 'success');
                    }
                };
                clearBtn.style.margin = '1rem';
                clearBtn.style.marginLeft = '0.5rem';
                
                const knowledgeSection = document.getElementById('knowledge-base');
                if (knowledgeSection) {
                    knowledgeSection.appendChild(clearBtn);
                }
            }, 100);
        }
        
        // Initialize knowledge base on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando base de conhecimento...');
            
            // Test basic functionality first
            try {
                updateKnowledgeBaseStats();
                console.log('‚úÖ updateKnowledgeBaseStats executado com sucesso');
            } catch (error) {
                console.error('‚ùå Erro em updateKnowledgeBaseStats:', error);
            }
            
            // Test if functions are available
            console.log('üîç Verificando fun√ß√µes...');
            console.log('openKnowledgeUploader:', typeof window.openKnowledgeUploader);
            console.log('testRAGSystem:', typeof window.testRAGSystem);
            console.log('reindexKnowledgeBase:', typeof window.reindexKnowledgeBase);
            console.log('searchKnowledgeBase:', typeof window.searchKnowledgeBase);
            
            // Add test button for debugging (remove in production)
            setTimeout(() => {
                const knowledgeSection = document.getElementById('knowledge-base');
                if (knowledgeSection) {
                    const testBtn = document.createElement('button');
                    testBtn.className = 'btn btn-warning';
                    testBtn.innerHTML = 'üß™ Teste Debug';
                    testBtn.onclick = testKnowledgeBase;
                    testBtn.style.margin = '1rem';
                    knowledgeSection.appendChild(testBtn);
                    // Test button removed - no longer needed
                } else {
                    console.log('‚ö†Ô∏è Se√ß√£o knowledge-base n√£o encontrada');
                }
            }, 1000);
        });
        
        // Functions now defined at the top of the script
        
        // Generate unique ID
        function generateId() {
            return 'kb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Delete knowledge item
        function deleteKnowledgeItem(itemId) {
            if (!confirm('Tem certeza que deseja excluir este item da base de conhecimento?')) {
                return;
            }
            
            try {
                const index = knowledgeBase.findIndex(item => item.id === itemId);
                if (index !== -1) {
                    const deletedItem = knowledgeBase.splice(index, 1)[0];
                    console.log('üóëÔ∏è Item removido:', deletedItem.title);
                    
                    // Regenerate chunks and save
                    generateRAGChunks();
                    
                    // Update display
                    updateKnowledgeBaseStats();
                    displayKnowledgeContentInMain();
                    
                    showToast('Item removido da base de conhecimento', 'success');
                } else {
                    console.error('‚ùå Item n√£o encontrado:', itemId);
                    showToast('Item n√£o encontrado', 'error');
                }
            } catch (error) {
                console.error('‚ùå Erro ao excluir item:', error);
                showToast('Erro ao excluir item', 'error');
            }
        }
        
        // Edit knowledge item (placeholder for future implementation)
        function editKnowledgeItem(itemId) {
            const item = knowledgeBase.find(item => item.id === itemId);
            if (item) {
                // For now, show item details in alert (can be enhanced with a modal later)
                const details = `
T√≠tulo: ${item.title}
Tipo: ${item.type}
Conte√∫do: ${item.content.substring(0, 200)}...
Tags: ${item.tags.join(', ')}
Categoria: ${item.category}
Arte Marcial: ${item.martialArt}
N√≠vel: ${item.level}
                `.trim();
                
                alert(`Edi√ß√£o de itens ser√° implementada em breve.\n\nDetalhes do item:\n${details}`);
            } else {
                showToast('Item n√£o encontrado', 'error');
            }
        }
        
        // Initialize knowledge base on page load
        window.addEventListener('load', function() {
            console.log('üöÄ Inicializando sistema de persist√™ncia...');
            
            // Load knowledge base from storage
            const hasData = loadKnowledgeBaseFromStorage();
            
            if (hasData) {
                console.log('‚úÖ Dados carregados do localStorage');
                // Update UI if knowledge base section is visible
                setTimeout(() => {
                    updateKnowledgeBaseStats();
                    displayKnowledgeContentInMain();
                }, 500);
            } else {
                console.log('üìù Nenhum dado encontrado no localStorage');
            }
        });

    </script>

    <!-- Simple Widgets Sidebar -->
    <aside class="dashboard-widgets" id="dashboardWidgets">
            <!-- Quick Actions Widget -->
            <div class="widget">
                <div class="widget-header">
                    <div class="widget-title">
                        <span>‚ö°</span>
                        A√ß√µes R√°pidas
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <button class="btn btn-primary" onclick="openKnowledgeUploader()" style="width: 100%; justify-content: center;">
                        üìö Upload RAG
                    </button>
                    <button class="btn btn-secondary" onclick="testRAGSystem()" style="width: 100%; justify-content: center;">
                        üß† Testar IA
                    </button>
                </div>
            </div>

            <!-- Students Info -->
            <div class="widget">
                <div class="widget-header">
                    <div class="widget-title">
                        <span>üë•</span>
                        Resumo Alunos
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #CBD5E1; font-size: 0.875rem;">Total</span>
                        <span style="color: #3B82F6; font-weight: 600;" id="widget-total-students">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #CBD5E1; font-size: 0.875rem;">Ativos</span>
                        <span style="color: #10B981; font-weight: 600;" id="widget-active-students">0</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Enhanced JavaScript Functions -->
    <script>
        // UX-Enhanced Navigation Functions
        function toggleSidebar() {
            const container = document.getElementById('dashboardContainer');
            const sidebar = document.getElementById('dashboardSidebar');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('open');
            } else {
                container.classList.toggle('collapsed');
            }
        }

        // Second showSection function removed - was duplicated

        // Update main header based on current section
        function updateMainHeader(sectionName) {
            const titles = {
                'dashboard': { title: 'Dashboard', subtitle: 'Vis√£o geral da academia' },
                'students': { title: 'Gest√£o de Alunos', subtitle: 'Cadastro e acompanhamento de alunos' },
                'courses': { title: 'Cursos', subtitle: 'Gest√£o de cursos e turmas' },
                'quick-checkin': { title: 'Check-in R√°pido', subtitle: 'Sistema de presen√ßa simplificado' },
                'course-creator': { title: 'Criador de Cursos', subtitle: 'Ferramenta de cria√ß√£o de conte√∫do' },
                'knowledge-base': { title: 'Base de Conhecimento', subtitle: 'Documentos e recursos' },
                'attendance': { title: 'Controle de Frequ√™ncia', subtitle: 'Gest√£o de presen√ßa' },
                'evaluations': { title: 'Avalia√ß√µes', subtitle: 'Sistema de avalia√ß√µes' }
            };

            const config = titles[sectionName] || { title: 'Academia', subtitle: 'Sistema de gest√£o' };
            
            document.getElementById('mainTitle').textContent = config.title;
            document.getElementById('mainSubtitle').textContent = config.subtitle;
        }

        // Generate AI insights for current section
        function generateSectionInsight(sectionName) {
            const insights = {
                'dashboard': [
                    'IA detectou aumento de 15% no engajamento dos alunos nas √∫ltimas 2 semanas',
                    'Recomenda√ß√£o: Maria Silva est√° pronta para t√©cnicas avan√ßadas',
                    'Tend√™ncia positiva: Taxa de reten√ß√£o subiu para 94% este m√™s'
                ],
                'students': [
                    'IA identificou 2 alunos com padr√£o de baixa frequ√™ncia - interven√ß√£o recomendada',
                    'Carlos Rodrigues mostra aptid√£o excepcional para contra-ataques',
                    'Sugest√£o: Ana Oliveira pode ser mentora para novos alunos'
                ],
                'courses': [
                    'IA sugere ajuste no m√≥dulo de defesas b√°sicas baseado no feedback dos alunos',
                    'Novo curso "Defesa Feminina" recomendado pela an√°lise de demanda',
                    'Progress√£o √≥tima detectada: 85% dos alunos dominam fundamentos'
                ]
            };

            const sectionInsights = insights[sectionName] || insights['dashboard'];
            const randomInsight = sectionInsights[Math.floor(Math.random() * sectionInsights.length)];
            
            const aiInsightElement = document.getElementById('aiInsightText');
            if (aiInsightElement) {
                aiInsightElement.textContent = randomInsight;
            }
        }

        // Generate AI insight on demand
        function generateAIInsight() {
            const insights = [
                'IA detectou padr√£o: alunos respondem melhor a t√©cnicas demonstradas em duplas',
                'Recomenda√ß√£o: implementar aquecimento espec√≠fico para joelho direito (3 alunos)',
                'Tend√™ncia: hor√°rio das 19h tem 20% mais engajamento que o das 18h',
                'IA sugere: quebra de 5 minutos a cada 25 minutos melhora reten√ß√£o em 30%',
                'Insight comportamental: m√∫sica instrumental aumenta foco durante t√©cnicas complexas'
            ];

            const randomInsight = insights[Math.floor(Math.random() * insights.length)];
            const aiInsightElement = document.getElementById('aiInsightText');
            if (aiInsightElement) {
                aiInsightElement.textContent = randomInsight;
            }
            
            // Show brief animation
            const banner = document.getElementById('aiInsightsBanner');
            if (banner) {
                banner.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    banner.style.transform = 'scale(1)';
                }, 200);
            }
        }

        // Load section-specific data
        function loadSectionData(sectionName) {
            if (sectionName === 'students') {
                loadStudents();
            } else if (sectionName === 'knowledge-base') {
                displayKnowledgeContentInMain();
                updateKnowledgeBaseStats();
            }
            
            // Update RAG items count in widget
            document.getElementById('ragItemsCount').textContent = `${knowledgeBase.length} itens`;
        }

        // Enhanced page initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize dashboard
            generateSectionInsight('dashboard');
            
            // Set up responsive behavior
            window.addEventListener('resize', function() {
                const container = document.getElementById('dashboardContainer');
                if (window.innerWidth <= 768) {
                    container.classList.add('mobile');
                } else {
                    container.classList.remove('mobile');
                    document.getElementById('dashboardSidebar').classList.remove('open');
                }
            });

            // Initialize mobile state if needed
            if (window.innerWidth <= 768) {
                document.getElementById('dashboardContainer').classList.add('mobile');
            }

            // Update RAG items count
            setTimeout(() => {
                const ragItemsElement = document.getElementById('ragItemsCount');
                if (ragItemsElement) {
                    ragItemsElement.textContent = `${knowledgeBase.length} itens`;
                }
            }, 1000);
            
            // Load financial data when page loads
            loadFinancialData();
        });

        // ===== FINANCIAL MODULE FUNCTIONS =====
        
        // Global financial data (reuse existing allPlans variable)
        // let allPlans = []; // Already declared above
        let allSubscriptions = [];
        let allPayments = [];

        // Tab switching function
        function switchFinancialTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.financial-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.financial-tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            const contentElement = document.getElementById(`financial-${tabName}`);
            contentElement.classList.add('active');
            contentElement.style.display = 'block';
            
            // Load data for the selected tab
            switch(tabName) {
                case 'plans':
                    loadPlans();
                    break;
                case 'expenses':
                    // Load expenses data - to be implemented
                    console.log('Loading expenses data...');
                    break;
                case 'payments':
                    loadPayments();
                    break;
                case 'settings':
                    // Load financial settings - to be implemented
                    console.log('Loading financial settings...');
                    break;
            }
        }

        // Load all financial data
        async function loadFinancialData() {
            await Promise.all([
                loadPlans(),
                loadPayments()
                // loadSubscriptions removed - replaced with expenses
            ]);
            updateFinancialOverview();
        }

        // Load billing plans
        async function loadPlans() {
            try {
                const response = await fetch('/api/billing-plans');
                const data = await response.json();
                
                if (data.success) {
                    allPlans = data.data || [];
                    updatePlansTable();
                } else {
                    console.error('Erro ao carregar planos:', data.message);
                    // Show empty state
                    allPlans = [];
                    updatePlansTable();
                }
            } catch (error) {
                console.error('Erro ao carregar planos:', error);
                // Show empty state on error
                allPlans = [];
                updatePlansTable();
            }
        }

        // Update plans table
        function updatePlansTable() {
            const tbody = document.getElementById('plansTableBody');
            
            if (!tbody) {
                console.error('plansTableBody element not found');
                return;
            }
            
            if (!allPlans || !Array.isArray(allPlans) || allPlans.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                            Nenhum plano cadastrado. Clique em "Novo Plano" para come√ßar.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = allPlans.map(plan => {
                const billingTypeMap = {
                    'MONTHLY': 'Mensal',
                    'QUARTERLY': 'Trimestral', 
                    'YEARLY': 'Anual'
                };
                
                const categoryMap = {
                    'ADULT': 'Adulto',
                    'INICIANTE1': 'Iniciante 1',
                    'INICIANTE2': 'Iniciante 2',
                    'INICIANTE3': 'Iniciante 3'
                };
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: #E2E8F0;">${plan.name}</div>
                            ${plan.description ? `<div style="font-size: 0.75rem; color: #94A3B8; margin-top: 0.25rem;">${plan.description}</div>` : ''}
                        </td>
                        <td>
                            <span style="font-weight: 600; color: #10B981;">R$ ${parseFloat(plan.price).toFixed(2)}</span>
                        </td>
                        <td>${billingTypeMap[plan.billingType] || plan.billingType}</td>
                        <td>${plan.classesPerWeek}x/semana</td>
                        <td>${categoryMap[plan.category] || 'Todas'}</td>
                        <td>
                            <span class="badge ${plan.isActive ? 'success' : 'inactive'}">
                                ${plan.isActive ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn edit" onclick="editPlan('${plan.id}')" title="Editar Plano">
                                ‚úèÔ∏è Editar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load subscriptions from API (DEPRECATED - replaced with expenses)
        async function loadSubscriptions() {
            try {
                console.log('loadSubscriptions called - function deprecated, expenses section used instead');
                
                // Set empty data to prevent errors
                allSubscriptions = [];
                
                // Don't try to update table that no longer exists
                return;
            } catch (error) {
                console.error('Erro ao carregar assinaturas:', error);
                allSubscriptions = [];
                // Don't call updateSubscriptionsTable - function deprecated
            }
        }

        // Update subscriptions table (DEPRECATED - now using expenses)
        function updateSubscriptionsTable() {
            // This function is deprecated since subscriptions section was replaced with expenses
            console.log('updateSubscriptionsTable called - function deprecated, using expenses section instead');
            return;
            
            tbody.innerHTML = allSubscriptions.map(sub => {
                const studentName = sub.student?.name || 'Nome n√£o informado';
                const planName = sub.plan?.name || 'Plano n√£o informado';
                const price = parseFloat(sub.currentPrice || 0);
                const nextBilling = sub.nextBillingDate ? new Date(sub.nextBillingDate).toLocaleDateString('pt-BR') : 'N√£o definido';
                
                // Status mapping
                const statusMap = {
                    'ACTIVE': { text: 'Ativa', class: 'success' },
                    'INACTIVE': { text: 'Inativa', class: 'inactive' },
                    'CANCELLED': { text: 'Cancelada', class: 'warning' },
                    'EXPIRED': { text: 'Expirada', class: 'warning' },
                    'SUSPENDED': { text: 'Suspensa', class: 'warning' }
                };
                
                const statusInfo = statusMap[sub.status] || { text: sub.status, class: 'inactive' };
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: #E2E8F0;">${studentName}</div>
                            ${sub.student?.email ? `<div style="font-size: 0.75rem; color: #94A3B8; margin-top: 0.25rem;">${sub.student.email}</div>` : ''}
                        </td>
                        <td>
                            <div style="font-weight: 500; color: #E2E8F0;">${planName}</div>
                            ${sub.plan?.classesPerWeek ? `<div style="font-size: 0.75rem; color: #94A3B8; margin-top: 0.25rem;">${sub.plan.classesPerWeek}x/semana</div>` : ''}
                        </td>
                        <td>
                            <span style="font-weight: 600; color: #10B981;">R$ ${price.toFixed(2)}</span>
                        </td>
                        <td>${nextBilling}</td>
                        <td>
                            <span class="badge ${statusInfo.class}">
                                ${statusInfo.text}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn edit" onclick="editSubscription('${sub.id}')" title="Editar Assinatura">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="action-btn view" onclick="viewSubscriptionDetails('${sub.id}')" title="Ver Detalhes">
                                üëÅÔ∏è Ver
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load payments 
        async function loadPayments() {
            // No mock data - show empty state
            allPayments = [];
            updatePaymentsTable();
        }

        // Update payments table
        function updatePaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');
            
            if (!tbody) {
                console.error('paymentsTableBody element not found');
                return;
            }
            
            if (!allPayments || allPayments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #CBD5E1; padding: 2rem;">
                            Nenhum pagamento encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = allPayments.map(payment => `
                <tr>
                    <td>${new Date(payment.date).toLocaleDateString('pt-BR')}</td>
                    <td>${payment.student.name}</td>
                    <td>R$ ${parseFloat(payment.amount).toFixed(2)}</td>
                    <td>
                        <span class="badge ${payment.status === 'PAID' ? 'success' : 'warning'}">
                            ${payment.status === 'PAID' ? 'Pago' : 'Pendente'}
                        </span>
                    </td>
                    <td>${payment.method}</td>
                    <td>
                        <button class="action-btn view" onclick="viewPayment('${payment.id}')" title="Ver Detalhes">
                            üëÅÔ∏è Ver
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Load reports (mock)
        function loadFinancialSettings() {
            // Load financial settings - placeholder
            console.log('Financial settings loaded');
        }

        // Update financial overview
        function updateFinancialOverview() {
            const totalRevenue = allPayments.reduce((sum, payment) => 
                payment.status === 'PAID' ? sum + payment.amount : sum, 0
            );
            
            document.getElementById('total-revenue').textContent = `R$ ${totalRevenue.toFixed(2)}`;
            document.getElementById('active-subscriptions').textContent = allSubscriptions.filter(s => s.status === 'ACTIVE').length;
            document.getElementById('pending-payments').textContent = allPayments.filter(p => p.status !== 'PAID').length;
            document.getElementById('total-plans').textContent = allPlans.filter(p => p.isActive).length;
            document.getElementById('financial-count').textContent = allSubscriptions.length;
        }

        // Modal functions

        function openAddSubscriptionModal() {
            // Load students and plans for selection
            loadStudentsForSubscription();
            loadPlansForSubscription();
            document.getElementById('addSubscriptionModal').classList.add('active');
        }

        // Load students for subscription modal
        async function loadStudentsForSubscription() {
            try {
                const response = await fetch('/api/students');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('subscriptionStudent');
                    select.innerHTML = '<option value="">Selecione um aluno...</option>' +
                        data.data.map(student => {
                            const user = student.user || {};
                            const firstName = user.firstName || 'N';
                            const lastName = user.lastName || 'A';
                            const name = `${firstName} ${lastName}`;
                            return `<option value="${student.id}">${name}</option>`;
                        }).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
            }
        }

        // Load plans for subscription modal
        function loadPlansForSubscription() {
            const select = document.getElementById('subscriptionPlan');
            select.innerHTML = '<option value="">Selecione um plano...</option>' +
                allPlans.filter(plan => plan.isActive).map(plan => 
                    `<option value="${plan.id}">${plan.name} - R$ ${parseFloat(plan.price).toFixed(2)}</option>`
                ).join('');
        }

        // Form handlers
        document.getElementById('addSubscriptionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                studentId: document.getElementById('subscriptionStudent').value,
                planId: document.getElementById('subscriptionPlan').value,
                startDate: document.getElementById('subscriptionStartDate').value,
                customPrice: document.getElementById('subscriptionCustomPrice').value || null
            };
            
            if (!formData.studentId || !formData.planId) {
                alert('Por favor, selecione um aluno e um plano');
                return;
            }
            
            try {
                const response = await fetch('/api/subscriptions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Assinatura criada com sucesso!');
                    closeModal('addSubscriptionModal');
                    loadSubscriptions();
                    updateFinancialOverview();
                } else {
                    alert('Erro ao criar assinatura: ' + data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao criar assinatura');
            }
        });


        // Subscription details function
        function viewSubscriptionDetails(subId) {
            const subscription = allSubscriptions.find(sub => sub.id === subId);
            if (!subscription) {
                alert('Assinatura n√£o encontrada');
                return;
            }
            
            const details = `
DETALHES DA ASSINATURA

üë§ Aluno: ${subscription.student.name}
üìß Email: ${subscription.student.email || 'N√£o informado'}

üìã Plano: ${subscription.plan.name}
üí∞ Valor: R$ ${parseFloat(subscription.currentPrice).toFixed(2)}
üìÖ Tipo: ${subscription.plan.billingType === 'MONTHLY' ? 'Mensal' : subscription.plan.billingType === 'QUARTERLY' ? 'Trimestral' : 'Anual'}
ü•ã Aulas: ${subscription.plan.classesPerWeek}x por semana

üìÖ Data de In√≠cio: ${new Date(subscription.startDate).toLocaleDateString('pt-BR')}
üîÑ Pr√≥ximo Vencimento: ${subscription.nextBillingDate ? new Date(subscription.nextBillingDate).toLocaleDateString('pt-BR') : 'N√£o definido'}
üìä Status: ${subscription.status === 'ACTIVE' ? 'Ativa' : subscription.status}

${subscription.financialResponsible ? `üí≥ Respons√°vel Financeiro: ${subscription.financialResponsible.name}` : 'üí≥ Respons√°vel: Pr√≥prio aluno'}
            `;
            
            alert(details);
        }

        // Placeholder functions  
        // editPlan function moved to avoid duplicates - see line 16469

        function editSubscription(subId) {
            alert('Funcionalidade de edi√ß√£o de assinatura em desenvolvimento.\n\nAssinatura ID: ' + subId);
        }

        function viewPayment(paymentId) {
            alert('Visualiza√ß√£o de pagamento em desenvolvimento');
        }

        // ==========================================
        // FINANCIAL RESPONSIBLES MANAGEMENT
        // ==========================================

        let allResponsibles = [];

        // Load financial responsibles
        async function loadFinancialResponsiblesList() {
            try {
                document.getElementById('responsiblesLoadingState').style.display = 'block';
                document.getElementById('responsiblesEmptyState').style.display = 'none';
                
                const response = await fetch('/api/financial-responsibles');
                const result = await response.json();
                
                if (result.success) {
                    allResponsibles = result.data;
                    updateResponsiblesTable(allResponsibles);
                    updateResponsiblesStats(allResponsibles);
                    
                    if (allResponsibles.length === 0) {
                        document.getElementById('responsiblesLoadingState').style.display = 'none';
                        document.getElementById('responsiblesEmptyState').style.display = 'block';
                    } else {
                        document.getElementById('responsiblesLoadingState').style.display = 'none';
                    }
                } else {
                    throw new Error(result.message || 'Failed to load responsibles');
                }
            } catch (error) {
                console.error('Erro ao carregar respons√°veis:', error);
                document.getElementById('responsiblesLoadingState').innerHTML = `
                    <div style="text-align: center; color: #EF4444; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Erro ao carregar respons√°veis</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">${error.message}</div>
                    </div>
                `;
            }
        }

        // Update responsibles table
        function updateResponsiblesTable(responsibles) {
            const tbody = document.getElementById('responsiblesTableBody');
            
            tbody.innerHTML = responsibles.map(responsible => `
                <tr>
                    <td>
                        <div class="student-name">${responsible.name}</div>
                    </td>
                    <td>
                        <span class="student-cpf">${formatCPF(responsible.cpfCnpj)}</span>
                    </td>
                    <td>
                        <span class="student-email">${responsible.email}</span>
                    </td>
                    <td>
                        <span class="student-phone">${responsible.phone || 'N/A'}</span>
                    </td>
                    <td>
                        <span class="badge ${responsible.relationshipType === 'PARENT' ? 'success' : 'info'}">
                            ${responsible.relationshipType || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <span class="badge info">${responsible.studentsCount || 0}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="openEditResponsibleModal('${responsible.id}')" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="action-btn delete" onclick="deleteResponsible('${responsible.id}')" title="Excluir">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update responsibles stats
        function updateResponsiblesStats(responsibles) {
            document.getElementById('totalResponsibles').textContent = responsibles.length;
            document.getElementById('activeResponsibles').textContent = responsibles.length;
            
            const totalStudents = responsibles.reduce((sum, r) => sum + (r.studentsCount || 0), 0);
            document.getElementById('studentsWithResponsibles').textContent = totalStudents;
            
            const avgStudents = responsibles.length > 0 ? (totalStudents / responsibles.length).toFixed(1) : '0';
            document.getElementById('avgStudentsPerResponsible').textContent = avgStudents;
            
            // Update badge count
            document.getElementById('responsibles-count').textContent = responsibles.length;
        }

        // Filter responsibles
        function filterResponsibles() {
            const searchTerm = document.getElementById('responsibleSearch').value.toLowerCase();
            const filtered = allResponsibles.filter(responsible => 
                responsible.name.toLowerCase().includes(searchTerm) ||
                responsible.cpfCnpj.includes(searchTerm) ||
                responsible.email.toLowerCase().includes(searchTerm)
            );
            updateResponsiblesTable(filtered);
        }

        // Open add responsible modal
        function openAddResponsibleModal() {
            document.getElementById('addResponsibleForm').reset();
            document.getElementById('addResponsibleModal').classList.add('active');
        }

        // Open edit responsible modal
        async function openEditResponsibleModal(responsibleId) {
            const responsible = allResponsibles.find(r => r.id === responsibleId);
            if (!responsible) {
                alert('Respons√°vel n√£o encontrado');
                return;
            }
            
            // Populate form
            document.getElementById('editResponsibleId').value = responsible.id;
            document.getElementById('editResponsibleName').value = responsible.name;
            document.getElementById('editResponsibleCpfCnpj').value = responsible.cpfCnpj;
            document.getElementById('editResponsibleEmail').value = responsible.email;
            document.getElementById('editResponsiblePhone').value = responsible.phone || '';
            document.getElementById('editResponsibleBirthDate').value = responsible.birthDate ? responsible.birthDate.split('T')[0] : '';
            document.getElementById('editResponsibleRelationType').value = responsible.relationshipType || '';
            
            document.getElementById('editResponsibleModal').classList.add('active');
        }

        // Delete responsible
        async function deleteResponsible(responsibleId) {
            const responsible = allResponsibles.find(r => r.id === responsibleId);
            if (!responsible) return;
            
            if (!confirm(`Tem certeza que deseja excluir o respons√°vel "${responsible.name}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/financial-responsibles/${responsibleId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('Respons√°vel exclu√≠do com sucesso!', 'success');
                    loadFinancialResponsiblesList();
                } else {
                    throw new Error('Erro ao excluir respons√°vel');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao excluir respons√°vel', 'error');
            }
        }

        
        // ==========================================
        // PAYMENT PLANS MANAGEMENT (CONTINUATION)
        // ==========================================

        // Load payment plans
        async function loadPaymentPlansList() {
            console.log('üîÑ Loading payment plans list...');
            try {
                const loadingElement = document.getElementById('plansLoadingState');
                const emptyElement = document.getElementById('plansEmptyState');
                
                if (loadingElement) loadingElement.style.display = 'block';
                if (emptyElement) emptyElement.style.display = 'none';
                
                console.log('üì° Fetching billing plans from API...');
                const response = await fetch('/api/billing-plans');
                const result = await response.json();
                
                console.log('üìä API Response:', result);
                
                if (result.success) {
                    allPlans = result.data || [];
                    console.log('üìã Plans loaded:', allPlans.length, 'plans');
                    
                    updatePaymentPlansTable(allPlans);
                    updatePlansStats(allPlans);
                    
                    if (allPlans.length === 0) {
                        if (loadingElement) loadingElement.style.display = 'none';
                        if (emptyElement) emptyElement.style.display = 'block';
                        console.log('‚ö†Ô∏è No plans found - showing empty state');
                    } else {
                        if (loadingElement) loadingElement.style.display = 'none';
                        console.log('‚úÖ Plans table updated successfully');
                    }
                } else {
                    throw new Error(result.message || 'Failed to load plans');
                }
            } catch (error) {
                console.error('Erro ao carregar planos:', error);
                
                // Initialize allPlans as empty array to prevent undefined errors
                allPlans = [];
                updatePaymentPlansTable(allPlans);
                updatePlansStats(allPlans);
                
                document.getElementById('plansLoadingState').innerHTML = `
                    <div style="text-align: center; color: #EF4444; padding: 3rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Erro ao carregar planos</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">${error.message}</div>
                    </div>
                `;
            }
        }

        // Load courses for plan modal
        async function loadCoursesForPlanModal() {
            try {
                console.log('üìö Carregando cursos para modal de planos...');
                const response = await fetch('/api/courses');
                const result = await response.json();
                
                if (result.success && result.data) {
                    allCourses = result.data;
                    const select = document.getElementById('planCourse');
                    
                    // Para sele√ß√£o m√∫ltipla, n√£o inclu√≠mos op√ß√£o vazia
                    // Cada curso √© uma op√ß√£o selecion√°vel independente
                    select.innerHTML = allCourses.map(course => {
                        const level = course.level || 'BEGINNER';
                        const duration = course.duration || 24;
                        const category = course.category || 'ADULT';
                        
                        return `<option value="${course.id}" title="${course.description || course.name}">
                            ${course.name} (${level} - ${duration} semanas - ${category})
                        </option>`;
                    }).join('');
                    
                    console.log(`‚úÖ ${allCourses.length} cursos carregados para sele√ß√£o m√∫ltipla`);
                } else {
                    console.error('‚ùå Nenhum curso encontrado:', result);
                    const select = document.getElementById('planCourse');
                    select.innerHTML = '<option value="" disabled>Nenhum curso dispon√≠vel</option>';
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar cursos:', error);
                const select = document.getElementById('planCourse');
                select.innerHTML = '<option value="" disabled>Erro ao carregar cursos</option>';
            }
        }

        // Update plans table (for payment plans section)
        function updatePaymentPlansTable(plans) {
            console.log('üîÑ Updating payment plans table with', plans?.length, 'plans');
            const tbody = document.getElementById('plansTableBody');
            
            // Check if tbody exists and plans is an array
            if (!tbody) {
                console.error('‚ùå plansTableBody element not found in DOM');
                return;
            }
            
            if (!plans || !Array.isArray(plans)) {
                console.warn('‚ö†Ô∏è Plans data is undefined or not an array:', plans);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94A3B8; padding: 2rem;">Nenhum plano encontrado</td></tr>';
                return;
            }
            
            console.log('üìã Processing', plans.length, 'plans for table');
            
            tbody.innerHTML = plans.map(plan => {
                const courseName = (allCourses && Array.isArray(allCourses)) 
                    ? allCourses.find(c => c.id === plan.courseId)?.name || 'Geral'
                    : 'Geral';
                
                return `
                <tr ondblclick="openPlanEditPage('${plan.id}')" style="cursor: pointer;">
                    <td>
                        <div class="student-name">${plan.name}</div>
                        <div style="font-size: 0.8rem; color: #94A3B8;">${plan.description || ''}</div>
                    </td>
                    <td>
                        <span class="student-email">${courseName}</span>
                    </td>
                    <td>
                        <span class="badge ${plan.category === 'ADULT' ? 'success' : 'info'}">
                            ${plan.category}
                        </span>
                    </td>
                    <td>
                        <span class="metric-value" style="color: #10B981; font-weight: bold;">
                            R$ ${parseFloat(plan.price).toFixed(2)}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${plan.billingType === 'MONTHLY' ? 'info' : 'warning'}">
                            ${plan.billingType === 'MONTHLY' ? 'Mensal' : plan.billingType}
                        </span>
                    </td>
                    <td>
                        <span class="badge info">${plan.activeSubscriptions || 0}</span>
                    </td>
                    <td>
                        <span class="badge ${plan.isActive ? 'success' : 'danger'}">
                            ${plan.isActive ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editPlan('${plan.id}')" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="action-btn delete" onclick="deletePlan('${plan.id}')" title="Excluir">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
            
            console.log('‚úÖ Table HTML updated. Rows in tbody:', tbody.children.length);
        }

        // Update plans stats
        function updatePlansStats(plans) {
            // Check if plans is an array
            if (!plans || !Array.isArray(plans)) {
                console.warn('Plans data is undefined or not an array for stats:', plans);
                const totalElement = document.getElementById('totalPlansCount');
                const activeElement = document.getElementById('activePlansCount');
                if (totalElement) totalElement.textContent = '0';
                if (activeElement) activeElement.textContent = '0';
                return;
            }
            
            const totalElement = document.getElementById('totalPlansCount');
            const activeElement = document.getElementById('activePlansCount');
            
            if (totalElement) totalElement.textContent = plans.length;
            if (activeElement) activeElement.textContent = plans.filter(p => p.isActive !== false).length;
            
            const avgPrice = plans.length > 0 ? 
                (plans.reduce((sum, p) => sum + parseFloat(p.price || 0), 0) / plans.length).toFixed(2) : '0.00';
            const avgPriceElement = document.getElementById('avgPlanPrice');
            if (avgPriceElement) avgPriceElement.textContent = `R$ ${avgPrice}`;
            
            const monthlyPlans = plans.filter(p => p.billingType === 'MONTHLY').length;
            const monthlyElement = document.getElementById('monthlyPlansCount');
            if (monthlyElement) monthlyElement.textContent = monthlyPlans;
            
            // Update badge count (if exists)
            const countElement = document.getElementById('plans-count');
            if (countElement) countElement.textContent = plans.length;
        }

        // Open add plan modal
        function openAddPlanModal() {
            loadCoursesForPlanModal();
            document.getElementById('addPlanForm').reset();
            
            // Reset modal to create mode
            document.querySelector('#addPlanModal .modal-title').textContent = 'Novo Plano de Pagamento';
            document.querySelector('#addPlanModal button[type="submit"]').textContent = 'Criar Plano';
            delete document.getElementById('addPlanForm').dataset.editingPlanId;
            
            // Reset to first tab
            switchPlanTab('basic');
            
            document.getElementById('addPlanModal').classList.add('active');
        }

        // Switch between plan modal tabs
        function switchPlanTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.plan-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.plan-tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            const selectedTab = document.querySelector(`.plan-tab[data-tab="${tabName}"]`);
            const selectedContent = document.getElementById(`planTab-${tabName}`);
            
            if (selectedTab && selectedContent) {
                selectedTab.classList.add('active');
                selectedContent.classList.add('active');
            }
            
            // Load content for specific tabs
            if (tabName === 'courses') {
                loadCoursesForPlanSelection();
            } else if (tabName === 'preview') {
                updatePlanPreview();
            }
        }

        // Load courses for plan selection (enhanced version)
        async function loadCoursesForPlanSelection() {
            const coursesGrid = document.getElementById('coursesGrid');
            
            try {
                // Show loading state
                coursesGrid.innerHTML = `
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Carregando cursos dispon√≠veis...</p>
                    </div>
                `;
                
                const response = await fetch('/api/courses');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const courses = result.data;
                    
                    // Update stats
                    document.getElementById('coursesTotalCount').textContent = `${courses.length} cursos dispon√≠veis`;
                    updateSelectedCoursesCount();
                    
                    // Render courses grid
                    coursesGrid.innerHTML = courses.map(course => `
                        <div class="course-card" onclick="toggleCourseSelection('${course.id}', this)">
                            <div class="course-card-header">
                                <div>
                                    <h4 style="color: #E2E8F0; margin: 0 0 0.5rem 0; font-size: 1.1rem;">${course.name}</h4>
                                    <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">${course.description || 'Descri√ß√£o n√£o dispon√≠vel'}</p>
                                </div>
                                <input type="checkbox" class="course-checkbox" data-course-id="${course.id}">
                            </div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                                <div style="color: #94A3B8; font-size: 0.875rem;">
                                    <div>üéì ${course.totalLessons || 48} aulas</div>
                                    <div>‚è±Ô∏è ${course.duration || '12 meses'}</div>
                                    <div>üë• ${course.maxStudents || 20} alunos max</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    coursesGrid.innerHTML = `
                        <div style="text-align: center; color: #94A3B8; padding: 3rem;">
                            <h4>üìö Nenhum curso dispon√≠vel</h4>
                            <p>Crie cursos primeiro para associ√°-los aos planos.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar cursos:', error);
                coursesGrid.innerHTML = `
                    <div style="text-align: center; color: #EF4444; padding: 3rem;">
                        <h4>‚ùå Erro ao carregar cursos</h4>
                        <p>Tente novamente ou verifique a conex√£o.</p>
                    </div>
                `;
            }
        }

        // Toggle course selection
        function toggleCourseSelection(courseId, cardElement) {
            const checkbox = cardElement.querySelector('.course-checkbox');
            const isSelected = checkbox.checked;
            
            // Toggle selection
            checkbox.checked = !isSelected;
            
            // Update visual state
            if (!isSelected) {
                cardElement.classList.add('selected');
            } else {
                cardElement.classList.remove('selected');
            }
            
            // Update legacy multi-select field
            updateLegacyPlanCourseField();
            updateSelectedCoursesCount();
            updatePlanPreview();
        }

        // Select all courses
        function selectAllCourses() {
            document.querySelectorAll('.course-card').forEach(card => {
                const checkbox = card.querySelector('.course-checkbox');
                checkbox.checked = true;
                card.classList.add('selected');
            });
            updateLegacyPlanCourseField();
            updateSelectedCoursesCount();
            updatePlanPreview();
        }

        // Clear all course selections
        function clearAllCourses() {
            document.querySelectorAll('.course-card').forEach(card => {
                const checkbox = card.querySelector('.course-checkbox');
                checkbox.checked = false;
                card.classList.remove('selected');
            });
            updateLegacyPlanCourseField();
            updateSelectedCoursesCount();
            updatePlanPreview();
        }

        // Update selected courses count
        function updateSelectedCoursesCount() {
            const selectedCount = document.querySelectorAll('.course-checkbox:checked').length;
            document.getElementById('coursesSelectedCount').textContent = `${selectedCount} cursos selecionados`;
        }

        // Update legacy plan course field for compatibility
        function updateLegacyPlanCourseField() {
            const legacySelect = document.getElementById('planCourse');
            const selectedCourses = document.querySelectorAll('.course-checkbox:checked');
            
            // Clear existing options
            legacySelect.innerHTML = '';
            
            // Add selected courses as options
            selectedCourses.forEach(checkbox => {
                const courseId = checkbox.dataset.courseId;
                const card = checkbox.closest('.course-card');
                const courseName = card.querySelector('h4').textContent;
                
                const option = document.createElement('option');
                option.value = courseId;
                option.textContent = courseName;
                option.selected = true;
                legacySelect.appendChild(option);
            });
        }

        // Update plan preview (Enhanced for new tab system)
        function updatePlanPreview() {
            const courseSelect = document.getElementById('planCourse');
            const categorySelect = document.getElementById('planCategory');
            const billingTypeSelect = document.getElementById('planBillingType');
            const classesPerWeekSelect = document.getElementById('planClassesPerWeek');
            
            const selectedCourses = Array.from(courseSelect.selectedOptions).map(option => option.text);
            const courseName = selectedCourses.length > 0 ? selectedCourses.join(', ') : 'Nenhum curso selecionado';
            const category = categorySelect.value;
            const billingType = billingTypeSelect?.value || 'MONTHLY';
            const classesPerWeek = classesPerWeekSelect?.value || '2';
            
            // Suggested category prices mapping (not enforced)
            const suggestedCategoryPrices = {
                'ADULT': '180.00',
                'FEMALE': '170.00',
                'SENIOR': '130.00',
                'CHILD': '120.00',
                'INICIANTE1': '120.00',
                'INICIANTE2': '130.00',
                'INICIANTE3': '140.00',
                'HEROI1': '160.00',
                'HEROI2': '170.00',
                'HEROI3': '180.00',
                'MASTER_1': '200.00',
                'MASTER_2': '220.00',
                'MASTER_3': '250.00'
            };
            
            const selectedCount = courseSelect.selectedOptions.length;
            const planName = selectedCount === 0 ? 'Novo Plano' :
                selectedCount === 1 ? `${courseName} - ${category}` : 
                `Multi-Curso (${selectedCount} cursos) - ${category}`;
            
            const customPrice = document.getElementById('planCustomPrice').value;
            
            // Only suggest price if field is completely empty, don't enforce it
            if (!customPrice && category) {
                const suggestedPrice = suggestedCategoryPrices[category] || '150.00';
                const adjustedPrice = selectedCount > 1 ? 
                    (parseFloat(suggestedPrice) * 1.5).toFixed(2) : suggestedPrice;
                
                // Set placeholder instead of value, so user can choose
                document.getElementById('planCustomPrice').placeholder = `Sugest√£o: R$ ${adjustedPrice}`;
            }
            
            const price = customPrice || '0.00';
            
            // Update preview elements
            document.getElementById('previewPlanName').textContent = planName;
            document.getElementById('previewPlanPrice').textContent = `R$ ${parseFloat(price || 0).toFixed(2)}`;
            
            const description = selectedCount === 0 ? 'Selecione pelo menos um curso para continuar' :
                selectedCount === 1 ? `Plano ${category.toLowerCase()} para ${courseName}` :
                `Plano ${category.toLowerCase()} com acesso a ${selectedCount} cursos: ${courseName}`;
            document.getElementById('previewPlanDescription').textContent = description;
            
            // Update detailed preview information
            const categoryNames = {
                'ADULT': 'Adulto',
                'FEMALE': 'Feminino',
                'SENIOR': 'Senior/Idoso',
                'CHILD': 'Infantil/Crian√ßa',
                'INICIANTE1': 'Iniciante 1',
                'INICIANTE2': 'Iniciante 2',
                'INICIANTE3': 'Iniciante 3',
                'HEROI1': 'Her√≥i 1',
                'HEROI2': 'Her√≥i 2',
                'HEROI3': 'Her√≥i 3',
                'MASTER_1': 'Master 1',
                'MASTER_2': 'Master 2',
                'MASTER_3': 'Master 3'
            };
            
            const billingTypeNames = {
                'MONTHLY': 'Mensal',
                'WEEKLY': 'Semanal',
                'QUARTERLY': 'Trimestral',
                'YEARLY': 'Anual'
            };
            
            document.getElementById('previewCategory').textContent = categoryNames[category] || category || 'N√£o definida';
            document.getElementById('previewBillingType').textContent = billingTypeNames[billingType] || billingType;
            document.getElementById('previewCourses').textContent = selectedCount > 0 ? courseName : 'Nenhum curso selecionado';
            document.getElementById('previewClassesPerWeek').textContent = classesPerWeek === 'unlimited' ? 'Ilimitado' : `${classesPerWeek} aulas`;
            
            // Auto-fill form fields
            if (!document.getElementById('planName').value) {
                document.getElementById('planName').value = planName;
            }
            if (!document.getElementById('planDescription').value && selectedCount > 0) {
                document.getElementById('planDescription').value = description;
            }
        }

        // Edit plan
        async function editPlanOldModal(planId) {
            try {
                console.log('üîß Editando plano (Old Modal):', planId);
                
                // Fetch plan data from server
                const response = await fetch(`/api/billing-plans/${planId}`);
                const result = await response.json();
                
                if (!result.success) {
                    console.error('‚ùå Erro ao buscar plano:', result.error);
                    showToast('Erro ao carregar dados do plano: ' + result.message, 'error');
                    return;
                }
                
                const plan = result.data;
                console.log('üìã Dados do plano carregados:', plan);
                
                // Load courses first and wait for completion
                await loadCoursesForPlanModal();
                
                // Fill form with plan data
                const courseSelect = document.getElementById('planCourse');
                
                // Handle multiple course selection for editing
                if (plan.courseIds && Array.isArray(plan.courseIds)) {
                    // Clear all selections first
                    for (let option of courseSelect.options) {
                        option.selected = false;
                    }
                    // Select the courses associated with this plan
                    plan.courseIds.forEach(courseId => {
                        const option = courseSelect.querySelector(`option[value="${courseId}"]`);
                        if (option) option.selected = true;
                    });
                } else if (plan.courseId) {
                    // Backward compatibility for single course
                    courseSelect.value = plan.courseId;
                }
            
            document.getElementById('planCategory').value = plan.category || '';
            document.getElementById('planName').value = plan.name || '';
            document.getElementById('planCustomPrice').value = plan.price || '';
            document.getElementById('planDescription').value = plan.description || '';
            document.getElementById('planBillingType').value = plan.billingType || 'MONTHLY';
            document.getElementById('planClassesPerWeek').value = plan.classesPerWeek || 2;
            
            // Update modal title and button
            document.querySelector('#addPlanModal .modal-title').textContent = 'Editar Plano de Pagamento';
            document.querySelector('#addPlanModal button[type="submit"]').textContent = 'Atualizar Plano';
            
            // Store plan ID for update
            document.getElementById('addPlanForm').dataset.editingPlanId = planId;
            
            // Show modal
            document.getElementById('addPlanModal').classList.add('active');
            
                // Update preview
                setTimeout(() => updatePlanPreview(), 100);
                
            } catch (error) {
                console.error('‚ùå Erro ao editar plano:', error);
                showToast('Erro ao carregar plano para edi√ß√£o: ' + error.message, 'error');
            }
        }

        // Delete plan
        async function deletePlan(planId) {
            console.log('üóëÔ∏è Attempting to delete plan:', planId);
            console.log('üìä Available plans:', allPlans);
            
            const plan = allPlans.find(p => p.id == planId || p.id === planId);
            if (!plan) {
                console.error('‚ùå Plan not found in allPlans array');
                console.error('üîç Searched for ID:', planId, 'Type:', typeof planId);
                console.error('üìã Available IDs:', allPlans.map(p => ({id: p.id, type: typeof p.id})));
                showNotification('Plano n√£o encontrado', 'error');
                return;
            }
            
            if (!confirm(`Tem certeza que deseja excluir o plano "${plan.name}"?`)) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Deleting plan via API...');
                
                const response = await fetch(`/api/billing-plans/${planId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Remove from local array
                    const planIndex = allPlans.findIndex(p => p.id == planId || p.id === planId);
                    if (planIndex !== -1) {
                        allPlans.splice(planIndex, 1);
                    }
                    
                    // Update display
                    updatePaymentPlansTable(allPlans);
                    updatePlansStats(allPlans);
                    
                    showToast('Plano exclu√≠do com sucesso!', 'success');
                } else {
                    throw new Error(data.message || data.error || 'Erro ao excluir plano');
                }
                
            } catch (error) {
                console.error('Erro:', error);
                showToast(`Erro ao excluir plano: ${error.message}`, 'error');
            }
        }

        // ==========================================
        // ADVANCED PLAN FORM CONTROLS
        // ==========================================
        
        // Toggle installment options based on billing type
        function toggleInstallmentOptions() {
            const billingType = document.getElementById('planBillingType').value;
            const installmentOptions = document.getElementById('installmentOptions');
            const recurringOptions = document.getElementById('recurringOptions');
            
            if (billingType === 'CREDIT_CARD_INSTALLMENT') {
                installmentOptions.style.display = 'block';
                recurringOptions.style.display = 'none';
            } else if (billingType === 'RECURRING') {
                installmentOptions.style.display = 'none';
                recurringOptions.style.display = 'block';
            } else {
                installmentOptions.style.display = 'none';
                recurringOptions.style.display = 'none';
            }
        }
        
        // Toggle unlimited access options
        function toggleUnlimitedOptions() {
            const accessType = document.getElementById('planAccessType').value;
            const limitedOptions = document.getElementById('limitedAccessOptions');
            
            if (accessType === 'unlimited') {
                limitedOptions.style.display = 'none';
                // Set unlimited values
                document.getElementById('planClassesPerWeek').value = '7';
                document.getElementById('planMaxClasses').value = '';
            } else {
                limitedOptions.style.display = 'block';
            }
        }
        
        // Enhanced category pricing with new categories
        const categoryPricing = {
            'ADULT': { price: 180.00, name: 'Adulto' },
            'FEMALE': { price: 170.00, name: 'Feminino' },
            'SENIOR': { price: 130.00, name: 'Senior/Idoso' },
            'CHILD': { price: 120.00, name: 'Infantil/Crian√ßa' },
            'INICIANTE1': { price: 120.00, name: 'Iniciante 1' },
            'INICIANTE2': { price: 130.00, name: 'Iniciante 2' },
            'INICIANTE3': { price: 140.00, name: 'Iniciante 3' },
            'HEROI1': { price: 160.00, name: 'Her√≥i 1' },
            'HEROI2': { price: 170.00, name: 'Her√≥i 2' },
            'HEROI3': { price: 180.00, name: 'Her√≥i 3' },
            'MASTER_1': { price: 200.00, name: 'Master 1' },
            'MASTER_2': { price: 220.00, name: 'Master 2' },
            'MASTER_3': { price: 250.00, name: 'Master 3' }
        };
        
        // Billing type translations
        const billingTypeNames = {
            'MONTHLY': 'Mensal',
            'QUARTERLY': 'Trimestral', 
            'YEARLY': 'Anual',
            'CREDIT_CARD_INSTALLMENT': 'Cart√£o Parcelado',
            'RECURRING': 'Assinatura Recorrente',
            'LIFETIME': 'Vital√≠cio'
        };

        // ==========================================
        // NAVIGATION AND INITIALIZATION
        // ==========================================

        // Enhanced navigation handling
        document.addEventListener('DOMContentLoaded', function() {
            // Add navigation click handlers
            document.querySelectorAll('.nav-link[data-page]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    showSection(page);
                });
            });

            // Initial page load
            showSection('dashboard');
        });

        // Third showSection function removed - was duplicated

        // Load section-specific data
        function loadSectionData(sectionName) {
            switch (sectionName) {
                case 'students':
                    loadStudents();
                    break;
                case 'financial-responsibles':
                    loadFinancialResponsiblesList();
                    break;
                case 'payment-plans':
                    loadPaymentPlansList();
                    break;
                case 'financial':
                    if (typeof loadFinancialData === 'function') {
                        loadFinancialData();
                    }
                    break;
                case 'attendance':
                    if (typeof loadAttendanceList === 'function') {
                        loadAttendanceList();
                    }
                    break;
                case 'quick-checkin':
                    if (typeof loadStudentsForCheckin === 'function') {
                        loadStudentsForCheckin();
                    }
                    break;
                case 'public-checkin':
                    if (typeof loadStudentsForPublicCheckin === 'function') {
                        loadStudentsForPublicCheckin();
                    }
                    break;
                default:
                    // No specific loading needed
                    break;
            }
        }

        // ==========================================
        // STUDENT ENROLLMENT WITH AUTOMATIC PLAN PREVIEW
        // ==========================================

        // Load courses for student modal
        async function loadCoursesForStudentModal() {
            try {
                const response = await fetch('/api/courses');
                const result = await response.json();
                
                if (result.success) {
                    const select = document.getElementById('studentCourse');
                    select.innerHTML = '<option value="">Selecione um curso (opcional)</option>' +
                        result.data.map(course => 
                            `<option value="${course.id}">${course.name}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar cursos:', error);
            }
        }

        // Update student plan preview based on category and course
        function updateStudentPlanPreview() {
            const courseSelect = document.getElementById('studentCourse');
            const categorySelect = document.getElementById('studentCategory');
            const courseName = courseSelect.options[courseSelect.selectedIndex]?.text || '';
            const category = categorySelect.value;
            
            if (courseSelect.value && category) {
                const planName = `${courseName} - ${category}`;
                // Use flexible pricing instead of hardcoded values
                const price = '0.00'; // Let user set their own price
                
                document.getElementById('previewStudentPlanName').textContent = planName;
                document.getElementById('previewStudentPlanPrice').textContent = `R$ ${parseFloat(price).toFixed(2)}`;
                document.getElementById('previewStudentPlanDescription').textContent = 
                    `Plano autom√°tico para ${courseName} categoria ${category}`;
                
                document.getElementById('studentPlanPreview').style.display = 'block';
            } else {
                document.getElementById('studentPlanPreview').style.display = 'none';
            }
        }

        function updateEditStudentPlanPreview() {
            const courseSelect = document.getElementById('editStudentCourse');
            const categorySelect = document.getElementById('editStudentCategory');
            const courseName = courseSelect.options[courseSelect.selectedIndex]?.text || '';
            const category = categorySelect.value;
            
            if (courseSelect.value && category) {
                const planName = `${courseName} - ${category}`;
                // Use flexible pricing instead of hardcoded values
                const price = '0.00'; // Let user set their own price
                
                document.getElementById('previewEditStudentPlanName').textContent = planName;
                document.getElementById('previewEditStudentPlanPrice').textContent = `R$ ${parseFloat(price).toFixed(2)}`;
                document.getElementById('previewEditStudentPlanDescription').textContent = 
                    `Plano autom√°tico para ${courseName} categoria ${category}`;
                
                document.getElementById('editStudentPlanPreview').style.display = 'block';
            } else {
                document.getElementById('editStudentPlanPreview').style.display = 'none';
            }
        }

        // Enhanced switch between tabs in edit modal with UX improvements
        function switchEditTab(tabName) {
            // Hide all tab contents with fade effect
            const tabContents = document.querySelectorAll('.edit-tab-content');
            tabContents.forEach(tab => {
                tab.style.opacity = '0';
                setTimeout(() => tab.style.display = 'none', 150);
            });

            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.edit-tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains('primary')) {
                    btn.style.background = 'transparent';
                    btn.style.color = '#94A3B8';
                } else {
                    btn.style.color = '#94A3B8';
                    btn.style.borderBottomColor = 'transparent';
                }
            });

            // Show selected tab content with fade in
            setTimeout(() => {
                const selectedTab = document.getElementById(`edit-tab-${tabName}`);
                if (selectedTab) {
                    selectedTab.style.display = 'block';
                    setTimeout(() => selectedTab.style.opacity = '1', 50);
                }
            }, 150);

            // Add active class to selected tab button
            const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
                if (selectedBtn.classList.contains('primary')) {
                    selectedBtn.style.background = 'linear-gradient(135deg, #3B82F6, #1D4ED8)';
                    selectedBtn.style.color = 'white';
                } else {
                    selectedBtn.style.color = '#3B82F6';
                    selectedBtn.style.borderBottomColor = '#3B82F6';
                }
            }

            // Load content and populate overview tab
            if (tabName === 'overview') {
                populateOverviewTab();
            }
            
            // Load financial tab content
            if (tabName === 'financial') {
                loadStudentFinancialTab();
            }
        }

        // Form progress tracking
        function updateFormProgress() {
            const form = document.getElementById('editStudentForm');
            const inputs = form.querySelectorAll('input[required], select[required]');
            let completed = 0;
            
            inputs.forEach(input => {
                if (input.value && input.value.trim() !== '') {
                    completed++;
                }
            });
            
            const progress = Math.round((completed / inputs.length) * 100);
            const progressBar = document.getElementById('editFormProgress');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
        }

        // Auto-fill demo data
        function autoFillDemo() {
            document.getElementById('editFirstName').value = 'Jo√£o';
            document.getElementById('editLastName').value = 'Silva';
            document.getElementById('editEmail').value = 'joao.silva@email.com';
            document.getElementById('editPhone').value = '(11) 99999-9999';
            document.getElementById('editCpf').value = '123.456.789-00';
            document.getElementById('editBirthDate').value = '1985-05-15';
            document.getElementById('editCategory').value = 'ADULT';
            document.getElementById('editGender').value = 'MASCULINO';
            
            updateFormProgress();
            showToast('‚úÖ Dados demo preenchidos com sucesso!', 'success');
        }

        // Populate overview tab with current data
        function populateOverviewTab() {
            const firstName = document.getElementById('editFirstName').value;
            const lastName = document.getElementById('editLastName').value;
            const email = document.getElementById('editEmail').value;
            const phone = document.getElementById('editPhone').value;
            const cpf = document.getElementById('editCpf').value;
            const category = document.getElementById('editCategory').value;
            
            // Update overview fields
            document.getElementById('overviewFullName').textContent = `${firstName} ${lastName}`.trim() || '-';
            document.getElementById('overviewEmail').textContent = email || '-';
            document.getElementById('overviewPhone').textContent = phone || '-';
            document.getElementById('overviewCpf').textContent = cpf || '-';
            document.getElementById('overviewCategory').textContent = category || '-';
            document.getElementById('overviewStatus').textContent = 'Ativo';
            document.getElementById('overviewEnrollment').textContent = new Date().toLocaleDateString('pt-BR');
            document.getElementById('overviewPhysical').textContent = 'Intermedi√°rio';
        }

        // Update student summary card
        function updateStudentSummary(student) {
            const user = student.user || {};
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
            
            document.getElementById('editStudentSummaryName').textContent = fullName || 'Nome do Aluno';
            document.getElementById('editStudentSummaryId').textContent = `ID: ${student.id || '-'}`;
            document.getElementById('editStudentSummaryCategory').textContent = `Categoria: ${student.category || '-'}`;
            document.getElementById('editStudentLastModified').textContent = 'agora mesmo';
        }

        // Placeholder functions for tab content loading
        function loadStudentProgressTab() {
            const progressTab = document.getElementById('edit-tab-progress');
            if (progressTab) {
                progressTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìà</div>
                        <p>Funcionalidade de progresso em desenvolvimento...</p>
                    </div>
                `;
            }
        }

        window.loadStudentFinancialTab = async function() {
            const studentId = currentEditingStudentId || document.getElementById('editStudentForm')?.dataset.editingStudentId;
            if (!studentId) {
                console.error('Student ID not found for financial tab');
                return;
            }
            
            try {
                // Load current plan information
                await loadStudentCurrentPlan(studentId);
                
                // Load payment status
                await loadStudentPaymentStatus(studentId);
                
                // Load payment history  
                await loadStudentPaymentHistory(studentId);
                
                // Load available plans for upgrade
                await loadAvailablePlansForUpgrade(studentId);
                
            } catch (error) {
                console.error('Error loading student financial data:', error);
                showToast('Erro ao carregar informa√ß√µes financeiras', 'error');
            }
        };

        // Enhanced load student's current plan with better UX
        async function loadStudentCurrentPlan(studentId) {
            const container = document.getElementById('currentPlanContainer');
            
            // Show loading state with better UX
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; padding: 2rem; gap: 1rem;">
                    <div style="width: 20px; height: 20px; border: 2px solid #3B82F6; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span style="color: #94A3B8;">Carregando informa√ß√µes do plano...</span>
                </div>
            `;
            
            try {
                console.log('üîÑ [UX] Loading plan for student:', studentId);
                
                // Force refresh subscription data with retry logic
                let subscription = null;
                let attempts = 0;
                const maxAttempts = 3;
                
                while (!subscription && attempts < maxAttempts) {
                    attempts++;
                    console.log(`üîÑ [UX] Attempt ${attempts}/${maxAttempts}`);
                    
                    const subscriptionResponse = await fetch(`/api/students/${studentId}/subscription?_=${Date.now()}`);
                    
                    if (subscriptionResponse.ok) {
                        const subscriptionResult = await subscriptionResponse.json();
                        console.log('üîç [UX] Subscription API response:', subscriptionResult);
                        
                        if (subscriptionResult.success && subscriptionResult.data) {
                            subscription = subscriptionResult.data;
                            console.log('‚úÖ [UX] Subscription found:', subscription);
                            console.log('üîç [UX] Plan in subscription:', subscription.plan);
                            console.log('üîç [UX] Has plan?', !!subscription.plan);
                            break;
                        }
                    }
                    
                    // Wait before retry
                    if (attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                console.log('üîç [FINAL CHECK] subscription:', subscription);
                console.log('üîç [FINAL CHECK] subscription.plan:', subscription?.plan);
                console.log('üîç [FINAL CHECK] condition result:', !!(subscription && subscription.plan));
                
                // Force debug: if we have subscription but no plan, try to fix it
                if (subscription && !subscription.plan && subscription.planId) {
                    console.log('üîß [FORCE FIX] Subscription has planId but no plan object, forcing plan load...');
                    try {
                        const planResponse = await fetch(`/api/billing-plans`);
                        const plansData = await planResponse.json();
                        const matchingPlan = plansData.data?.find(p => p.id === subscription.planId);
                        if (matchingPlan) {
                            subscription.plan = matchingPlan;
                            console.log('‚úÖ [FORCE FIX] Plan loaded manually:', matchingPlan.name);
                        }
                    } catch (e) {
                        console.error('‚ùå [FORCE FIX] Failed to load plan:', e);
                    }
                }
                
                if (subscription && subscription.plan) {
                    // Student has an active subscription - Enhanced UI
                    const plan = subscription.plan;
                    console.log('‚úÖ [UX] Plan data loaded:', plan);
                    
                    container.innerHTML = `
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05)); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 16px; padding: 2rem; position: relative; overflow: hidden;">
                            <!-- Success indicator -->
                            <div style="position: absolute; top: 1rem; right: 1rem; background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(16, 185, 129, 0.3);">
                                ‚úÖ ATIVO
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: start;">
                                <div>
                                    <h3 style="color: #10B981; margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 700;">${plan.name}</h3>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                        <div style="background: rgba(15, 23, 42, 0.3); padding: 1rem; border-radius: 8px;">
                                            <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">VALOR MENSAL</div>
                                            <div style="color: #F8FAFC; font-size: 1.1rem; font-weight: 600;">R$ ${parseFloat(plan.price).toFixed(2)}</div>
                                        </div>
                                        <div style="background: rgba(15, 23, 42, 0.3); padding: 1rem; border-radius: 8px;">
                                            <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">CATEGORIA</div>
                                            <div style="color: #F8FAFC; font-size: 1.1rem; font-weight: 600;">${plan.category}</div>
                                        </div>
                                        <div style="background: rgba(15, 23, 42, 0.3); padding: 1rem; border-radius: 8px;">
                                            <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">AULAS/SEMANA</div>
                                            <div style="color: #F8FAFC; font-size: 1.1rem; font-weight: 600;">${plan.classesPerWeek || 'Ilimitado'}</div>
                                        </div>
                                    </div>
                                    
                                    ${plan.description ? `<p style="color: #CBD5E1; font-size: 0.875rem; margin: 0; opacity: 0.8;">${plan.description}</p>` : ''}
                                </div>
                                
                                <div style="text-align: center;">
                                    <div style="background: linear-gradient(135deg, #10B981, #059669); border-radius: 16px; padding: 2rem; min-width: 140px; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);">
                                        <div style="color: white; font-size: 1.8rem; font-weight: bold; margin-bottom: 0.5rem;">R$ ${parseFloat(plan.price).toFixed(2)}</div>
                                        <div style="color: rgba(255, 255, 255, 0.8); font-size: 0.875rem;">${plan.billingType === 'MONTHLY' ? 'por m√™s' : 'total'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Update sidebar with success
                    updateSidebarFinancialStatus(true, plan);
                    console.log('‚úÖ [UX] Plan UI updated successfully');
                    
                } else {
                    // No subscription found - Enhanced empty state
                    console.log('‚ÑπÔ∏è [UX] No active subscription found');
                    container.innerHTML = `
                        <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(217, 119, 6, 0.05)); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 16px; padding: 3rem; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.6;">üìã</div>
                            <h3 style="color: #F59E0B; margin: 0 0 1rem 0; font-size: 1.3rem;">Nenhum plano ativo</h3>
                            <p style="color: #94A3B8; margin: 0 0 2rem 0; font-size: 0.875rem; max-width: 300px; margin-left: auto; margin-right: auto;">Este aluno precisa de um plano de pagamento para acessar as aulas e funcionalidades da academia.</p>
                            
                            <button onclick="assignPlanToStudent('${studentId}')" 
                                    style="background: linear-gradient(135deg, #F59E0B, #D97706); border: none; color: white; padding: 1rem 2rem; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(245, 158, 11, 0.4)';"
                                    onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)';">
                                üìã Atribuir Plano de Pagamento
                            </button>
                        </div>
                    `;
                    
                    // Update sidebar to show no plan
                    updateSidebarFinancialStatus(false, null);
                }
                
            } catch (error) {
                console.error('‚ùå [UX] Error loading current plan:', error);
                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(220, 38, 38, 0.05)); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 16px; padding: 3rem; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem; color: #EF4444;">‚ö†Ô∏è</div>
                        <h3 style="color: #EF4444; margin: 0 0 1rem 0;">Erro ao carregar plano</h3>
                        <p style="color: #94A3B8; margin: 0 0 2rem 0; font-size: 0.875rem;">N√£o foi poss√≠vel carregar as informa√ß√µes do plano. Tente novamente.</p>
                        
                        <button onclick="loadStudentCurrentPlan('${studentId}')" 
                                style="background: #374151; border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                `;
                
                // Update sidebar to show error state
                updateSidebarFinancialStatus(false, null);
            }
        }

        // Load student payment status
        async function loadStudentPaymentStatus(studentId) {
            const container = document.getElementById('paymentStatusContainer');
            
            try {
                // Mock payment status for now - replace with real API call
                const paymentStatus = {
                    status: 'NO_PLAN',
                    lastPayment: null,
                    nextDueDate: null,
                    amount: 0.00
                };
                
                const statusColor = paymentStatus.status === 'UP_TO_DATE' ? '#10B981' : 
                                  paymentStatus.status === 'OVERDUE' ? '#EF4444' : '#F59E0B';
                
                const statusText = paymentStatus.status === 'UP_TO_DATE' ? '‚úÖ Em dia' :
                                 paymentStatus.status === 'OVERDUE' ? '‚ùå Em atraso' : '‚ö†Ô∏è Vencendo';
                
                container.innerHTML = `
                    <div style="margin-bottom: 0.5rem;"><strong>√öltimo Pagamento:</strong> ${new Date(paymentStatus.lastPayment).toLocaleDateString('pt-BR')}</div>
                    <div style="margin-bottom: 0.5rem;"><strong>Pr√≥ximo Vencimento:</strong> ${new Date(paymentStatus.nextDueDate).toLocaleDateString('pt-BR')}</div>
                    <div style="margin-bottom: 0.5rem;"><strong>Valor:</strong> R$ ${paymentStatus.amount.toFixed(2)}</div>
                    <div style="margin-bottom: 0.5rem;"><strong>Status:</strong> <span style="color: ${statusColor};">${statusText}</span></div>
                `;
            } catch (error) {
                console.error('Error loading payment status:', error);
                container.innerHTML = `<p style="color: #EF4444;">Erro ao carregar status de pagamento</p>`;
            }
        }

        // Load student payment history
        async function loadStudentPaymentHistory(studentId) {
            const container = document.getElementById('paymentHistoryContainer');
            
            try {
                // Mock payment history for now - replace with real API call
                const paymentHistory = [
                    // No hardcoded payments - will load from API when implemented
                ];
                
                if (paymentHistory.length > 0) {
                    container.innerHTML = paymentHistory.map(payment => {
                        const statusIcon = payment.status === 'PAID' ? '‚úÖ' : payment.status === 'PENDING' ? '‚è≥' : '‚ùå';
                        const statusColor = payment.status === 'PAID' ? '#10B981' : payment.status === 'PENDING' ? '#F59E0B' : '#EF4444';
                        
                        return `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                                <span>${new Date(payment.date).toLocaleDateString('pt-BR')}</span>
                                <span style="color: ${statusColor};">${statusIcon} R$ ${payment.amount.toFixed(2)}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p style="color: #94A3B8; text-align: center;">Nenhum pagamento registrado</p>';
                }
            } catch (error) {
                console.error('Error loading payment history:', error);
                container.innerHTML = `<p style="color: #EF4444;">Erro ao carregar hist√≥rico</p>`;
            }
        }

        // Load available plans for upgrade
        async function loadAvailablePlansForUpgrade(studentId) {
            const container = document.getElementById('availablePlansContainer');
            
            try {
                const response = await fetch('/api/billing-plans');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const plans = result.data.slice(0, 3); // Show top 3 plans
                    
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            ${plans.map(plan => `
                                <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; padding: 1.5rem; text-align: center;">
                                    <h5 style="color: #3B82F6; margin: 0 0 0.5rem 0; font-size: 1rem;">${plan.name}</h5>
                                    <div style="color: #E2E8F0; font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">R$ ${parseFloat(plan.price).toFixed(2)}</div>
                                    <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 1rem;">${plan.billingType === 'MONTHLY' ? 'Mensal' : plan.billingType}</div>
                                    <button class="btn btn-sm btn-outline" onclick="upgradeToPlan('${studentId}', '${plan.id}')" style="width: 100%; padding: 0.5rem;">
                                        Upgrade
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #94A3B8;">
                            <p>Nenhum plano dispon√≠vel para upgrade</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading available plans:', error);
                container.innerHTML = `
                    <div style="text-align: center; color: #EF4444;">
                        <p>Erro ao carregar planos dispon√≠veis</p>
                    </div>
                `;
            }
        }

        // Open edit student plan modal
        function openEditStudentPlan() {
            const studentId = document.getElementById('editStudentForm')?.dataset.editingStudentId;
            if (!studentId) {
                showToast('ID do aluno n√£o encontrado', 'error');
                return;
            }
            
            showToast('Funcionalidade de edi√ß√£o de plano em desenvolvimento', 'info');
            // TODO: Implement plan editing modal
        }

        // Assign plan to student
        function assignPlanToStudent(studentId) {
            showToast('Funcionalidade de atribui√ß√£o de plano em desenvolvimento', 'info');
            // TODO: Implement plan assignment modal
        }

        // Upgrade student to new plan
        function upgradeToPlan(studentId, planId) {
            showToast(`Upgrade para plano ${planId} em desenvolvimento`, 'info');
            // TODO: Implement plan upgrade functionality
        }

        function loadStudentAttendanceTab() {
            const attendanceTab = document.getElementById('edit-tab-attendance');
            if (attendanceTab) {
                attendanceTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìä</div>
                        <p>Hist√≥rico de frequ√™ncia em desenvolvimento...</p>
                    </div>
                `;
            }
        }

        // Fun√ß√£o removida - agora usando loadStudentCoursesTab do students.js

        // Fun√ß√£o removida - agora usando loadStudentClassesTab do students.js

        function loadStudentHistoryTab() {
            const historyTab = document.getElementById('edit-tab-history');
            if (historyTab) {
                historyTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìú</div>
                        <p>Hist√≥rico do aluno em desenvolvimento...</p>
                    </div>
                `;
            }
        }

        // NOTE: openAddStudentModal is defined earlier in the file, this is a duplicate - removed

        // Form submission handlers
        document.getElementById('addResponsibleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('responsibleName').value,
                cpfCnpj: document.getElementById('responsibleCpfCnpj').value,
                email: document.getElementById('responsibleEmail').value,
                phone: document.getElementById('responsiblePhone').value,
                birthDate: document.getElementById('responsibleBirthDate').value,
                address: document.getElementById('responsibleAddress').value,
                addressNumber: document.getElementById('responsibleAddressNumber').value,
                complement: document.getElementById('responsibleComplement').value,
                neighborhood: document.getElementById('responsibleNeighborhood').value,
                city: document.getElementById('responsibleCity').value,
                state: document.getElementById('responsibleState').value,
                zipCode: document.getElementById('responsibleZipCode').value,
                relationshipType: document.getElementById('responsibleRelationType').value
            };
            
            try {
                const response = await fetch('/api/financial-responsibles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Respons√°vel criado com sucesso!', 'success');
                    closeModal('addResponsibleModal');
                    loadFinancialResponsiblesList();
                } else {
                    throw new Error(result.message || 'Erro ao criar respons√°vel');
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao criar respons√°vel: ' + error.message, 'error');
            }
        });

        document.getElementById('addPlanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const isEditing = form.dataset.editingPlanId;
            
            const courseSelect = document.getElementById('planCourse');
            const selectedCourseIds = Array.from(courseSelect.selectedOptions).map(option => option.value);
            
            const formData = {
                courseIds: selectedCourseIds,
                // Backward compatibility: if only one course selected, also send courseId
                courseId: selectedCourseIds.length === 1 ? selectedCourseIds[0] : null,
                category: document.getElementById('planCategory').value,
                name: document.getElementById('planName').value,
                customPrice: document.getElementById('planCustomPrice').value,
                description: document.getElementById('planDescription').value,
                billingType: document.getElementById('planBillingType').value,
                classesPerWeek: parseInt(document.getElementById('planClassesPerWeek').value)
            };
            
            try {
                let response, result;
                
                if (isEditing) {
                    // Update existing plan
                    response = await fetch(`/api/billing-plans/${isEditing}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: formData.name,
                            description: formData.description,
                            price: parseFloat(formData.customPrice),
                            billingType: formData.billingType,
                            classesPerWeek: formData.classesPerWeek,
                            category: formData.category,
                            courseIds: selectedCourseIds,
                            courseId: selectedCourseIds.length === 1 ? selectedCourseIds[0] : null
                        })
                    });
                    result = await response.json();
                    
                    if (result.success) {
                        showToast('Plano atualizado com sucesso!', 'success');
                        closeModal('addPlanModal');
                        loadPaymentPlansList();
                    } else {
                        throw new Error(result.message || 'Erro ao atualizar plano');
                    }
                } else {
                    // Create new plan
                    response = await fetch('/api/payment-plans', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    result = await response.json();
                    
                    if (result.success) {
                        const message = result.data.isExisting ? 
                            'Plano existente encontrado!' : 
                            'Plano criado com sucesso!';
                        showToast(message, 'success');
                        closeModal('addPlanModal');
                        loadPaymentPlansList();
                    } else {
                        throw new Error(result.message || 'Erro ao criar plano');
                    }
                }
            } catch (error) {
                console.error('Erro:', error);
                const action = isEditing ? 'atualizar' : 'criar';
                showToast(`Erro ao ${action} plano: ` + error.message, 'error');
            }
        });

        // ========================================
        // üéØ NOVO SISTEMA UX DE CURSOS - FUN√á√ïES JAVASCRIPT
        // ========================================

        // Global variables for new courses interface
        let currentCourseData = null;
        let currentCoursesTab = 'overview';
        let lessonsData = [];
        let techniquesData = [];
        let ragDocuments = [];

        // Tab Management
        function switchCourseTab(tabName) {
            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = '#CBD5E1';
            });
            
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = 'linear-gradient(135deg, #3B82F6, #1D4ED8)';
                activeBtn.style.color = 'white';
            }

            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Show selected tab content
            const tabContent = document.getElementById(`tab-${tabName}`);
            if (tabContent) {
                tabContent.style.display = 'block';
                currentCoursesTab = tabName;
                
                // Load content based on tab
                switch(tabName) {
                    case 'lessons':
                        loadLessonsTable();
                        break;
                    case 'techniques':
                        loadTechniquesDisplay();
                        break;
                    case 'evaluations':
                        loadEvaluationsDisplay();
                        break;
                    case 'ai-rag':
                        loadRAGInterface();
                        break;
                }
            }
        }

        // Lessons Table Management
        async function loadLessonsTable() {
            try {
                lessonsData = generateMockLessons();
                renderLessonsTable();
            } catch (error) {
                console.error('Error loading lessons:', error);
                lessonsData = generateMockLessons();
                renderLessonsTable();
            }
        }

        function generateMockLessons() {
            const lessons = [];
            const units = {
                1: { name: 'Fundamentos', color: '#10B981' },
                2: { name: 'Golpes B√°sicos', color: '#3B82F6' },
                3: { name: 'Defesas B√°sicas', color: '#8B5CF6' },
                4: { name: 'Defesas Avan√ßadas', color: '#F59E0B' },
                5: { name: 'Integra√ß√£o', color: '#EF4444' }
            };

            const techniquesPool = [
                ['Guarda de Boxe', 'Movimenta√ß√£o B√°sica'],
                ['Jab', 'Cross'],
                ['Hook', 'Uppercut'],
                ['Joelhada Frontal', 'Chute Frontal'],
                ['Defesa 360¬∞ Interior', 'Defesa 360¬∞ Exterior'],
                ['Esquiva Lateral', 'Bloqueio Ativo'],
                ['Combo Jab-Cross', 'Contra-ataque'],
                ['Defesa contra Estrangulamento', 'Libera√ß√£o de Pegada'],
                ['Integra√ß√£o T√©cnicas', 'Cen√°rio Real']
            ];

            for (let i = 1; i <= 48; i++) {
                const unitNum = Math.ceil(i / 10);
                const unit = units[Math.min(unitNum, 5)];
                const isCompleted = i <= 15;
                const isCurrent = i === 16;
                
                lessons.push({
                    number: i,
                    status: isCompleted ? 'completed' : (isCurrent ? 'current' : 'upcoming'),
                    unit: unit.name,
                    unitColor: unit.color,
                    techniques: techniquesPool[Math.floor((i-1) / 5) % techniquesPool.length],
                    objectives: [
                        'Desenvolver coordena√ß√£o motora',
                        'Aplicar t√©cnica em cen√°rio real',
                        'Melhorar precis√£o e timing'
                    ],
                    sequence: `Aula ${i} de 48`,
                    tacticalModule: ['Regula√ß√£o Emocional', 'Consci√™ncia Situacional', 'Tomada de Decis√£o'][Math.floor(i / 4) % 3]
                });
            }

            return lessons;
        }

        function renderLessonsTable() {
            const tbody = document.getElementById('lessonsTableBody');
            if (!tbody) return;

            const filteredLessons = filterLessonsData();
            
            tbody.innerHTML = filteredLessons.map(lesson => `
                <tr style="border-bottom: 1px solid #374151; transition: background-color 0.2s;" 
                    onmouseover="this.style.backgroundColor='rgba(59, 130, 246, 0.05)'" 
                    onmouseout="this.style.backgroundColor='transparent'">
                    <td style="padding: 1rem; color: #F8FAFC; font-weight: 600;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: ${lesson.unitColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">
                                ${lesson.number}
                            </span>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        ${getStatusBadge(lesson.status)}
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 8px; height: 8px; background: ${lesson.unitColor}; border-radius: 50%;"></div>
                            ${lesson.unit}
                        </div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                            ${lesson.techniques.map(tech => `
                                <span style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                    ${tech}
                                </span>
                            `).join('')}
                        </div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1; font-size: 0.875rem;">
                        <div>${lesson.objectives[0]}</div>
                        <div style="color: #94A3B8; margin-top: 0.25rem;">+ ${lesson.objectives.length - 1} mais</div>
                    </td>
                    <td style="padding: 1rem; color: #94A3B8; font-size: 0.875rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                ${lesson.sequence}
                            </span>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="viewLessonDetails(${lesson.number})" 
                                    class="btn btn-small btn-secondary" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                üëÅÔ∏è Ver
                            </button>
                            <button onclick="editLesson(${lesson.number})" 
                                    class="btn btn-small btn-primary" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                ‚úèÔ∏è Editar
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusBadge(status) {
            const badges = {
                completed: '<span style="background: #059669; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">‚úÖ Conclu√≠da</span>',
                current: '<span style="background: #3B82F6; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">üîÑ Atual</span>',
                upcoming: '<span style="background: #6B7280; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">‚è≥ Pr√≥xima</span>'
            };
            return badges[status] || badges.upcoming;
        }

        function filterLessonsData() {
            const unitFilter = document.getElementById('unitFilter')?.value || 'all';
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            const searchTerm = document.getElementById('searchLessons')?.value.toLowerCase() || '';

            return lessonsData.filter(lesson => {
                const unitMatch = unitFilter === 'all' || lesson.unit.includes(unitFilter);
                const statusMatch = statusFilter === 'all' || lesson.status === statusFilter;
                const searchMatch = searchTerm === '' || 
                    lesson.techniques.some(tech => tech.toLowerCase().includes(searchTerm)) ||
                    lesson.objectives.some(obj => obj.toLowerCase().includes(searchTerm));
                
                return unitMatch && statusMatch && searchMatch;
            });
        }

        // Filter functions
        function filterLessonsByUnit() { renderLessonsTable(); }
        function filterLessonsByStatus() { renderLessonsTable(); }
        function searchLessons() { renderLessonsTable(); }

        // Techniques Management
        async function loadTechniquesDisplay() {
            techniquesData = generateMockTechniques();
            renderTechniquesDisplay();
        }

        function generateMockTechniques() {
            return [
                {
                    name: 'Fundamentos',
                    color: '#10B981',
                    techniques: [
                        { name: 'Guarda de Boxe', description: 'Posi√ß√£o b√°sica de defesa', difficulty: 1 },
                        { name: 'Movimenta√ß√£o B√°sica', description: 'Deslocamentos fundamentais', difficulty: 1 },
                        { name: 'Postura de Combate', description: 'Stance ideal para defesa', difficulty: 1 }
                    ]
                },
                {
                    name: 'Golpes B√°sicos',
                    color: '#3B82F6',
                    techniques: [
                        { name: 'Jab', description: 'Soco direto com a m√£o da frente', difficulty: 2 },
                        { name: 'Cross', description: 'Soco cruzado com for√ßa', difficulty: 2 },
                        { name: 'Hook', description: 'Gancho lateral potente', difficulty: 3 }
                    ]
                },
                {
                    name: 'Defesas B√°sicas',
                    color: '#8B5CF6',
                    techniques: [
                        { name: 'Defesa 360¬∞', description: 'Bloqueio circular universal', difficulty: 3 },
                        { name: 'Esquiva Lateral', description: 'Desvio do corpo para os lados', difficulty: 2 },
                        { name: 'Defesa contra Estrangulamento', description: 'Libera√ß√£o de pegada no pesco√ßo', difficulty: 4 }
                    ]
                }
            ];
        }

        function renderTechniquesDisplay() {
            const container = document.getElementById('techniquesContainer');
            if (!container) return;

            container.innerHTML = techniquesData.map(unit => `
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: ${unit.color}; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: rgba(${hexToRgb(unit.color)}, 0.1); border-radius: 8px;">
                        <div style="width: 10px; height: 10px; background: ${unit.color}; border-radius: 50%;"></div>
                        ${unit.name} (${unit.techniques.length} t√©cnicas)
                    </h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        ${unit.techniques.map(technique => `
                            <div onclick="showTechniqueDetails('${technique.name}')" 
                                 style="padding: 1rem; background: rgba(59, 130, 246, 0.05); border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent;"
                                 onmouseover="this.style.borderColor='${unit.color}'; this.style.background='rgba(${hexToRgb(unit.color)}, 0.1)'"
                                 onmouseout="this.style.borderColor='transparent'; this.style.background='rgba(59, 130, 246, 0.05)'">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.25rem;">${technique.name}</div>
                                        <div style="color: #CBD5E1; font-size: 0.875rem;">${technique.description}</div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div style="color: #F59E0B;">
                                            ${'‚≠ê'.repeat(technique.difficulty)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function showTechniqueDetails(techniqueName) {
            const detailsContainer = document.getElementById('techniqueDetails');
            if (!detailsContainer) return;

            // Find technique in data
            let foundTechnique = null;
            let foundUnit = null;
            
            for (const unit of techniquesData) {
                const technique = unit.techniques.find(t => t.name === techniqueName);
                if (technique) {
                    foundTechnique = technique;
                    foundUnit = unit;
                    break;
                }
            }

            if (!foundTechnique) return;

            detailsContainer.innerHTML = `
                <div style="padding: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: rgba(${hexToRgb(foundUnit.color)}, 0.1); border-radius: 8px;">
                        <div style="width: 40px; height: 40px; background: ${foundUnit.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                            ü•ä
                        </div>
                        <div>
                            <h3 style="color: #F8FAFC; margin: 0; margin-bottom: 0.25rem;">${foundTechnique.name}</h3>
                            <div style="color: ${foundUnit.color}; font-size: 0.875rem; font-weight: 600;">${foundUnit.name}</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #F8FAFC; margin-bottom: 0.75rem;">üìã Descri√ß√£o</h4>
                        <p style="color: #CBD5E1; line-height: 1.6;">${foundTechnique.description}</p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #F8FAFC; margin-bottom: 0.75rem;">‚≠ê Dificuldade</h4>
                        <div style="color: #F59E0B; font-size: 1.25rem;">
                            ${'‚≠ê'.repeat(foundTechnique.difficulty)} (${foundTechnique.difficulty}/5)
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.75rem;">
                        <button onclick="editTechnique('${foundTechnique.name}')" class="btn btn-primary" style="flex: 1;">
                            <span>‚úèÔ∏è</span> Editar T√©cnica
                        </button>
                        <button onclick="addToLesson('${foundTechnique.name}')" class="btn btn-secondary" style="flex: 1;">
                            <span>‚ûï</span> Adicionar √† Aula
                        </button>
                    </div>
                </div>
            `;
        }

        // Evaluations Management
        function loadEvaluationsDisplay() {
            const container = document.getElementById('evaluationsContainer');
            if (!container) return;

            const evaluations = [
                { module: 1, name: 'Fundamentos', lesson: 8, status: 'completed', date: '15/06/2025', average: 8.5 },
                { module: 2, name: 'Golpes B√°sicos', lesson: 16, status: 'completed', date: '29/06/2025', average: 7.8 },
                { module: 3, name: 'Defesas B√°sicas', lesson: 24, status: 'upcoming', date: '13/07/2025', average: null },
                { module: 4, name: 'Defesas Avan√ßadas', lesson: 32, status: 'upcoming', date: '27/07/2025', average: null },
                { module: 5, name: 'Integra√ß√£o Final', lesson: 40, status: 'upcoming', date: '10/08/2025', average: null }
            ];

            container.innerHTML = evaluations.map(eval => `
                <div style="background: rgba(59, 130, 246, 0.05); border-radius: 12px; padding: 1.5rem; border: 1px solid #374151;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="color: #F8FAFC; margin: 0;">M√≥dulo ${eval.module}: ${eval.name}</h4>
                        ${eval.status === 'completed' ? 
                            `<span style="background: #059669; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">‚úÖ Realizada</span>` :
                            `<span style="background: #6B7280; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">‚è≥ Pendente</span>`
                        }
                    </div>
                    
                    <div style="color: #CBD5E1; margin-bottom: 1rem;">
                        <div style="margin-bottom: 0.5rem;"><strong>üìÖ Data:</strong> ${eval.date}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>üìã Aula:</strong> ${eval.lesson}/48</div>
                        ${eval.average ? 
                            `<div><strong>üìä M√©dia da Turma:</strong> <span style="color: #10B981; font-weight: bold;">${eval.average}/10</span></div>` :
                            `<div><strong>üìä M√©dia:</strong> <span style="color: #6B7280;">Pendente</span></div>`
                        }
                    </div>

                    <div style="display: flex; gap: 0.75rem;">
                        ${eval.status === 'completed' ? 
                            `<button onclick="viewEvaluationResults(${eval.module})" class="btn btn-secondary" style="flex: 1; font-size: 0.875rem;">
                                <span>üìä</span> Ver Resultados
                            </button>` :
                            `<button onclick="scheduleEvaluation(${eval.module})" class="btn btn-primary" style="flex: 1; font-size: 0.875rem;">
                                <span>üìÖ</span> Agendar
                            </button>`
                        }
                        <button onclick="editEvaluation(${eval.module})" class="btn btn-secondary" style="flex: 1; font-size: 0.875rem;">
                            <span>‚úèÔ∏è</span> Editar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // RAG Interface
        function loadRAGInterface() {
            initializeRAGDocuments();
        }

        function initializeRAGDocuments() {
            ragDocuments = [
                {
                    id: 'agenda',
                    name: 'Agenda do Aluno Faixa Branca.pdf',
                    description: 'Estrutura pedag√≥gica e cronograma',
                    type: 'pdf',
                    indexed: true
                },
                {
                    id: 'plano',
                    name: 'Plano de Curso Faixa Branca.pdf', 
                    description: 'Metodologia e t√©cnicas detalhadas',
                    type: 'pdf',
                    indexed: true
                }
            ];
        }

        async function sendRAGQuery() {
            const input = document.getElementById('ragChatInput');
            const chatContainer = document.getElementById('ragChatContainer');
            
            if (!input || !chatContainer || !input.value.trim()) return;

            const query = input.value.trim();
            input.value = '';

            // Add user message
            addChatMessage(chatContainer, query, 'user');
            
            // Add loading message
            const loadingId = addChatMessage(chatContainer, 'Processando consulta com IA...', 'assistant', true);

            try {
                // Simulate RAG query processing
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Remove loading message
                document.getElementById(loadingId)?.remove();
                
                // Add AI response
                const response = generateRAGResponse(query);
                addChatMessage(chatContainer, response, 'assistant');
                
            } catch (error) {
                document.getElementById(loadingId)?.remove();
                addChatMessage(chatContainer, 'Erro ao processar consulta. Tente novamente.', 'error');
            }
        }

        function addChatMessage(container, message, type, isLoading = false) {
            const messageId = 'msg-' + Date.now();
            const colors = {
                user: { bg: 'rgba(59, 130, 246, 0.1)', text: '#3B82F6', icon: 'üë§' },
                assistant: { bg: 'rgba(16, 185, 129, 0.1)', text: '#10B981', icon: 'ü§ñ' },
                error: { bg: 'rgba(239, 68, 68, 0.1)', text: '#EF4444', icon: '‚ùå' }
            };
            
            const style = colors[type] || colors.assistant;
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.style.cssText = `
                display: flex; gap: 0.75rem; margin-bottom: 1rem; padding: 1rem; 
                background: ${style.bg}; border-radius: 8px; align-items: flex-start;
            `;
            
            messageDiv.innerHTML = `
                <div style="color: ${style.text}; font-size: 1.25rem;">${style.icon}</div>
                <div style="flex: 1; color: #CBD5E1; line-height: 1.6;">
                    ${message}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            return messageId;
        }

        function generateRAGResponse(query) {
            const responses = {
                'tea': 'Para alunos com TEA, recomendo: 1) Demonstra√ß√µes visuais claras e repetitivas, 2) Ambiente com menos est√≠mulos sonoros, 3) Rotina previs√≠vel e sinais visuais, 4) Pausas quando necess√°rio.',
                'adapta√ß√£o': 'Adapta√ß√µes incluem: modificar intensidade, usar apoios visuais, ajustar tempo de execu√ß√£o, e personalizar instru√ß√µes conforme necessidades especiais.',
                't√©cnica': 'Baseado nos documentos, cada t√©cnica deve seguir: explica√ß√£o clara, demonstra√ß√£o, pr√°tica supervisionada, corre√ß√£o individual, e aplica√ß√£o em cen√°rio.',
                'avalia√ß√£o': 'O sistema de avalia√ß√£o modular inclui 5 etapas: Fundamentos (aula 8), Golpes (16), Defesas b√°sicas (24), Defesas avan√ßadas (32), e Integra√ß√£o (40).'
            };

            const lowQuery = query.toLowerCase();
            for (const [key, response] of Object.entries(responses)) {
                if (lowQuery.includes(key)) {
                    return response;
                }
            }

            return 'Com base nos documentos RAG, posso ajudar com informa√ß√µes sobre estrutura pedag√≥gica, adapta√ß√µes para necessidades especiais, metodologia de ensino, e sistema de avalia√ß√µes. Poderia ser mais espec√≠fico sobre sua d√∫vida?';
        }

        // Course Generator
        async function generateCourseWithRAG(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const courseData = {
                martialArt: formData.get('martialArt'),
                level: formData.get('level'),
                targetAudience: formData.get('targetAudience'),
                duration: formData.get('duration'),
                objectives: formData.get('objectives'),
                document: formData.get('document')
            };

            // Show loading state
            const generateBtn = event.target.querySelector('button[type="submit"]');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<span>‚è≥</span> Gerando...';
            generateBtn.disabled = true;

            try {
                // Simulate course generation
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Success message
                showNotification('Curso gerado com sucesso! üéâ', 'success');
                
                // Reset form
                event.target.reset();
                
            } catch (error) {
                showNotification('Erro ao gerar curso. Tente novamente.', 'error');
            } finally {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        // ========================================
        // SIMPLE COURSE CREATOR FUNCTIONS
        // ========================================

        // Store course preview data globally
        let coursePreviewData = null;

        // Open simple course creator (show the interface)
        function openSimpleCourseCreator() {
            const simpleCourseCreator = document.getElementById('simpleCourseCreator');
            const advancedForm = document.getElementById('courseGeneratorForm');
            
            // Show simple creator, hide advanced form
            simpleCourseCreator.style.display = 'block';
            advancedForm.style.display = 'none';
            
            // Focus on the course name input
            document.getElementById('quickCourseName').focus();
            
            showNotification('‚ú® Modo de cria√ß√£o r√°pida ativado! Digite apenas o nome do curso.', 'success');
        }

        // Show advanced course form
        function showAdvancedCourseForm() {
            const simpleCourseCreator = document.getElementById('simpleCourseCreator');
            const advancedForm = document.getElementById('courseGeneratorForm');
            
            // Hide simple creator, show advanced form
            simpleCourseCreator.style.display = 'none';
            advancedForm.style.display = 'block';
            
            showNotification('üéõÔ∏è Modo avan√ßado ativado! Personalize todos os detalhes do curso.', 'info');
        }

        // Create course automatically with AI
        async function createQuickCourse() {
            const courseName = document.getElementById('quickCourseName').value.trim();
            
            if (!courseName) {
                showNotification('‚ùå Por favor, digite o nome do curso.', 'error');
                return;
            }

            try {
                showNotification('ü§ñ IA analisando e gerando curso automaticamente...', 'info');
                
                // Generate course data using AI
                const courseData = await generateCourseDataFromName(courseName);
                
                // Create course via API
                await createCourseViaAPI(courseData);
                
                // Clear input and show success
                document.getElementById('quickCourseName').value = '';
                document.getElementById('coursePreviewArea').style.display = 'none';
                
                showNotification('üéâ Curso criado com sucesso!', 'success');
                
                // Refresh courses list if function exists
                if (typeof updateCoursesTable === 'function') {
                    updateCoursesTable();
                }
                
            } catch (error) {
                showNotification('‚ùå Erro ao criar curso: ' + error.message, 'error');
            }
        }

        // Preview course before creating
        async function previewQuickCourse() {
            const courseName = document.getElementById('quickCourseName').value.trim();
            
            if (!courseName) {
                showNotification('‚ùå Por favor, digite o nome do curso para gerar preview.', 'error');
                return;
            }

            try {
                showNotification('üîç Gerando preview do curso...', 'info');
                
                // Generate course data
                const courseData = await generateCourseDataFromName(courseName);
                coursePreviewData = courseData;
                
                // Show preview
                displayCoursePreview(courseData);
                
            } catch (error) {
                showNotification('‚ùå Erro ao gerar preview: ' + error.message, 'error');
            }
        }

        // Generate course data from just the name using AI
        async function generateCourseDataFromName(courseName) {
            // Smart parsing of course name
            const lowerName = courseName.toLowerCase();
            
            // Detect martial art
            let martialArt = 'krav-maga'; // default
            let martialArtDisplay = 'Krav Maga';
            
            if (lowerName.includes('jiu-jitsu') || lowerName.includes('jiujitsu')) {
                martialArt = 'jiu-jitsu';
                martialArtDisplay = 'Jiu-Jitsu';
            } else if (lowerName.includes('boxe')) {
                martialArt = 'boxe';
                martialArtDisplay = 'Boxe';
            } else if (lowerName.includes('muay thai')) {
                martialArt = 'muay-thai';
                martialArtDisplay = 'Muay Thai';
            } else if (lowerName.includes('karate') || lowerName.includes('karat√™')) {
                martialArt = 'karate';
                martialArtDisplay = 'Karat√™';
            } else if (lowerName.includes('taekwondo')) {
                martialArt = 'taekwondo';
                martialArtDisplay = 'Taekwondo';
            } else if (lowerName.includes('judo') || lowerName.includes('jud√¥')) {
                martialArt = 'judo';
                martialArtDisplay = 'Jud√¥';
            } else if (lowerName.includes('mma')) {
                martialArt = 'mma';
                martialArtDisplay = 'MMA';
            }
            
            // Detect level/belt and map to CourseLevel enum
            let level = 'BEGINNER';
            let levelDisplay = 'Faixa Branca';
            
            if (lowerName.includes('amarela') || lowerName.includes('yellow')) {
                level = 'BEGINNER';
                levelDisplay = 'Faixa Amarela';
            } else if (lowerName.includes('laranja') || lowerName.includes('orange')) {
                level = 'INTERMEDIATE';
                levelDisplay = 'Faixa Laranja';
            } else if (lowerName.includes('verde') || lowerName.includes('green')) {
                level = 'INTERMEDIATE';
                levelDisplay = 'Faixa Verde';
            } else if (lowerName.includes('azul') || lowerName.includes('blue')) {
                level = 'INTERMEDIATE';
                levelDisplay = 'Faixa Azul';
            } else if (lowerName.includes('roxa') || lowerName.includes('purple')) {
                level = 'ADVANCED';
                levelDisplay = 'Faixa Roxa';
            } else if (lowerName.includes('marrom') || lowerName.includes('brown')) {
                level = 'ADVANCED';
                levelDisplay = 'Faixa Marrom';
            } else if (lowerName.includes('preta') || lowerName.includes('black')) {
                level = 'EXPERT';
                levelDisplay = 'Faixa Preta';
            } else if (lowerName.includes('master') || lowerName.includes('mestre')) {
                level = 'MASTER';
                levelDisplay = 'Mestre';
            }
            
            // Detect audience
            let audience = 'adultos';
            let ageGroup = '18-65';
            
            if (lowerName.includes('crian√ßa') || lowerName.includes('infantil') || lowerName.includes('kids')) {
                audience = 'crian√ßas';
                ageGroup = '6-12';
            } else if (lowerName.includes('adolescent') || lowerName.includes('teen')) {
                audience = 'adolescentes';
                ageGroup = '13-17';
            } else if (lowerName.includes('senior') || lowerName.includes('idoso')) {
                audience = 'seniors';
                ageGroup = '65+';
            }
            
            // Generate course structure
            const courseData = {
                name: courseName,
                martialArt: martialArt,
                level: level,
                description: `Curso de ${martialArtDisplay} - ${levelDisplay} para ${audience}. Metodologia adaptada e progressiva focada em t√©cnicas fundamentais, desenvolvimento f√≠sico e mental, com √™nfase em aplica√ß√£o pr√°tica e seguran√ßa.`,
                ageGroup: ageGroup,
                duration: audience === 'crian√ßas' ? 16 : 24, // weeks
                totalLessons: audience === 'crian√ßas' ? 32 : 48,
                objectives: [
                    'Desenvolver t√©cnicas fundamentais de ' + martialArtDisplay,
                    'Melhorar condicionamento f√≠sico e flexibilidade',
                    'Aumentar consci√™ncia situacional e autoconfian√ßa',
                    'Promover disciplina e respeito',
                    'Preparar para evolu√ß√£o para pr√≥ximo n√≠vel'
                ],
                evaluationCriteria: [
                    'Execu√ß√£o correta das t√©cnicas b√°sicas',
                    'Conhecimento te√≥rico dos princ√≠pios',
                    'Progress√£o f√≠sica e mental',
                    'Frequ√™ncia e dedica√ß√£o nas aulas',
                    'Demonstra√ß√£o pr√°tica em situa√ß√µes controladas'
                ]
            };
            
            return courseData;
        }

        // Display course preview
        function displayCoursePreview(courseData) {
            const previewArea = document.getElementById('coursePreviewArea');
            const previewContent = document.getElementById('coursePreviewContent');
            
            previewContent.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <strong style="color: #3B82F6;">üìö Nome:</strong><br>
                        <span style="color: #CBD5E1;">${courseData.name}</span>
                    </div>
                    <div>
                        <strong style="color: #3B82F6;">ü•ã Arte Marcial:</strong><br>
                        <span style="color: #CBD5E1;">${courseData.martialArt}</span>
                    </div>
                    <div>
                        <strong style="color: #3B82F6;">üéØ N√≠vel:</strong><br>
                        <span style="color: #CBD5E1;">${courseData.level}</span>
                    </div>
                    <div>
                        <strong style="color: #3B82F6;">üë• Faixa Et√°ria:</strong><br>
                        <span style="color: #CBD5E1;">${courseData.ageGroup} anos</span>
                    </div>
                    <div>
                        <strong style="color: #3B82F6;">‚è±Ô∏è Dura√ß√£o:</strong><br>
                        <span style="color: #CBD5E1;">${courseData.duration} semanas</span>
                    </div>
                    <div>
                        <strong style="color: #3B82F6;">üìã Aulas:</strong><br>
                        <span style="color: #CBD5E1;">${courseData.totalLessons} aulas (${courseData.lessonDuration}min cada)</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <strong style="color: #3B82F6;">üìù Descri√ß√£o:</strong><br>
                    <span style="color: #CBD5E1; font-size: 0.9rem; line-height: 1.4;">${courseData.description}</span>
                </div>
                
                <div>
                    <strong style="color: #3B82F6;">üéØ Objetivos:</strong><br>
                    <ul style="color: #CBD5E1; font-size: 0.9rem; margin: 0.5rem 0; padding-left: 1.2rem;">
                        ${courseData.objectives.map(obj => `<li>${obj}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            previewArea.style.display = 'block';
            showNotification('üëÅÔ∏è Preview gerado! Revise os detalhes antes de criar.', 'success');
        }

        // Confirm and create course from preview
        async function confirmCreateCourse() {
            if (!coursePreviewData) {
                showNotification('‚ùå Nenhum curso para confirmar. Gere um preview primeiro.', 'error');
                return;
            }

            try {
                await createCourseViaAPI(coursePreviewData);
                
                // Clear everything
                document.getElementById('quickCourseName').value = '';
                document.getElementById('coursePreviewArea').style.display = 'none';
                coursePreviewData = null;
                
                showNotification('üéâ Curso confirmado e criado com sucesso!', 'success');
                
                // Refresh courses list
                if (typeof updateCoursesTable === 'function') {
                    updateCoursesTable();
                }
                
            } catch (error) {
                showNotification('‚ùå Erro ao confirmar cria√ß√£o: ' + error.message, 'error');
            }
        }

        // Edit course details (switch to advanced form)
        function editCourseDetails() {
            if (!coursePreviewData) {
                showNotification('‚ùå Nenhum curso para editar. Gere um preview primeiro.', 'error');
                return;
            }

            // Fill advanced form with preview data
            fillAdvancedFormWithData(coursePreviewData);
            
            // Switch to advanced form
            showAdvancedCourseForm();
            
            showNotification('‚úèÔ∏è Dados carregados no formul√°rio avan√ßado para edi√ß√£o.', 'info');
        }

        // Fill advanced form with course data
        function fillAdvancedFormWithData(courseData) {
            // Fill form fields if they exist
            const fields = {
                'martialArtSelect': courseData.martialArt,
                'courseLevelSelect': courseData.level,
                'courseNameInput': courseData.name,
                'courseDescriptionInput': courseData.description,
                'courseDurationInput': courseData.duration,
                'totalLessonsInput': courseData.totalLessons,
                'courseObjectivesInput': courseData.objectives.join('\\n'),
                'evaluationCriteriaInput': courseData.evaluationCriteria.join('\\n')
            };
            
            for (const [fieldId, value] of Object.entries(fields)) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = value;
                }
            }
        }

        // Create course via API
        async function createCourseViaAPI(courseData) {
            try {
                const response = await fetch('/api/courses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(courseData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Erro desconhecido ao criar curso');
                }

                return result.data;
                
            } catch (error) {
                console.error('Error creating course via API:', error);
                throw error;
            }
        }

        // Utility Functions
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? 
                `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
                '59, 130, 246';
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: '#10B981',
                error: '#EF4444',
                info: '#3B82F6',
                warning: '#F59E0B'
            };

            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                background: ${colors[type]}; color: white; padding: 1rem 1.5rem;
                border-radius: 8px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transform: translateX(100%); transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Slide in
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            
            // Auto remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Placeholder functions for buttons
        function loadSelectedCourse() { console.log('Loading selected course...'); }
        function editCourseDetails() { showNotification('Funcionalidade em desenvolvimento', 'info'); }
        function openLessonPlanManager() { switchCourseTab('lessons'); }
        function openTechniquesLibrary() { switchCourseTab('techniques'); }
        function generateProgressReport() { showNotification('Gerando relat√≥rio...', 'info'); }
        function openRAGInterface() { switchCourseTab('ai-rag'); }
        function viewLessonDetails(num) { showNotification(`Visualizando aula ${num}`, 'info'); }
        function editLesson(num) { showNotification(`Editando aula ${num}`, 'info'); }
        function editTechnique(name) { showNotification(`Editando t√©cnica: ${name}`, 'info'); }
        function addToLesson(name) { showNotification(`Adicionando ${name} √† aula`, 'success'); }
        function viewEvaluationResults(module) { showNotification(`Resultados do m√≥dulo ${module}`, 'info'); }
        
        // Assign functions to window after they are defined
        window.editLesson = editLesson;
        function scheduleEvaluation(module) { showNotification(`Agendando avalia√ß√£o m√≥dulo ${module}`, 'info'); }
        function editEvaluation(module) { showNotification(`Editando m√≥dulo ${module}`, 'info'); }
        function uploadRAGDocument() { showNotification('Funcionalidade de upload em desenvolvimento', 'info'); }
        function viewRAGDocument(id) { showNotification(`Visualizando documento: ${id}`, 'info'); }
        function exportLessonPlans() { showNotification('Exportando planos de aula...', 'info'); }
        function useExistingTemplate() { showNotification('Usando template do Faixa Branca...', 'info'); }
        function openRAGCourseCreator() { switchCourseTab('ai-rag'); }
        function importCourseDocument() { document.getElementById('courseDocument')?.click(); }

        // Initialize courses interface when tab is switched
        function showCourses() {
            showSection('courses');
            // Initialize default tab when courses section is opened
            setTimeout(() => switchCourseTab('overview'), 100);
            // Load courses data to populate the table
            loadCourses();
        }

        // Add CSS animations for courses interface
        const coursesStyle = document.createElement('style');
        coursesStyle.textContent = `
            @keyframes pulse {
                0%, 100% { opacity: 0.4; }
                50% { opacity: 1; }
            }
            .tab-btn:hover {
                background: rgba(59, 130, 246, 0.1) !important;
                color: #3B82F6 !important;
            }
            .tab-content {
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(coursesStyle);

        // ===============================
        // CLASSES (TURMAS) FUNCTIONS
        // ===============================
        
        function createNewClass() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div class="create-class-modal" style="
                    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
                    border-radius: 20px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 90vh;
                    overflow-y: auto;
                    border: 1px solid #334155;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
                    transform: translateY(20px) scale(0.95);
                    transition: all 0.3s ease;
                ">
                    <!-- Header -->
                    <div style="padding: 2rem 2rem 1rem 2rem; border-bottom: 1px solid #334155;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="color: #F8FAFC; margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700;">‚ûï Criar Nova Turma</h2>
                                <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">Configure uma nova turma para o curso</p>
                            </div>
                            <button onclick="closeCreateClassModal()" style="
                                background: rgba(239, 68, 68, 0.1);
                                border: 1px solid rgba(239, 68, 68, 0.3);
                                color: #EF4444;
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 1.2rem;
                                transition: all 0.2s;
                            ">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    
                    <!-- Form Content -->
                    <div style="padding: 2rem;">
                        <form id="createClassForm" style="display: grid; gap: 1.5rem;">
                            <!-- Course Selection -->
                            <div>
                                <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">üìö Curso Base</label>
                                <select id="courseSelect" required style="
                                    width: 100%;
                                    background: #1E293B;
                                    border: 1px solid #475569;
                                    color: #F8FAFC;
                                    padding: 0.75rem;
                                    border-radius: 8px;
                                    font-size: 0.875rem;
                                ">
                                    <option value="">Selecione um curso</option>
                                    <option value="krav-maga-basic">Krav Maga - Faixa Branca</option>
                                    <option value="krav-maga-advanced">Krav Maga - Faixa Amarela</option>
                                    <option value="self-defense">Defesa Pessoal B√°sica</option>
                                </select>
                            </div>
                            
                            <!-- Class Details -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">üè∑Ô∏è Nome da Turma</label>
                                    <input type="text" id="className" required placeholder="Ex: Turma 3 - Tarde" style="
                                        width: 100%;
                                        background: #1E293B;
                                        border: 1px solid #475569;
                                        color: #F8FAFC;
                                        padding: 0.75rem;
                                        border-radius: 8px;
                                        font-size: 0.875rem;
                                    ">
                                </div>
                                <div>
                                    <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">üë• Capacidade M√°xima</label>
                                    <input type="number" id="classCapacity" required value="20" min="5" max="50" style="
                                        width: 100%;
                                        background: #1E293B;
                                        border: 1px solid #475569;
                                        color: #F8FAFC;
                                        padding: 0.75rem;
                                        border-radius: 8px;
                                        font-size: 0.875rem;
                                    ">
                                </div>
                            </div>
                            
                            <!-- Schedule Configuration -->
                            <div>
                                <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">üìÖ Dias da Semana</label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="monday" style="accent-color: #3B82F6;"> Segunda
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="tuesday" style="accent-color: #3B82F6;"> Ter√ßa
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="wednesday" style="accent-color: #3B82F6;"> Quarta
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="thursday" style="accent-color: #3B82F6;"> Quinta
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="friday" style="accent-color: #3B82F6;"> Sexta
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="saturday" style="accent-color: #3B82F6;"> S√°bado
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #CBD5E1; font-size: 0.875rem;">
                                        <input type="checkbox" value="sunday" style="accent-color: #3B82F6;"> Domingo
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Time Configuration -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">üïê Hor√°rio de In√≠cio</label>
                                    <input type="time" id="startTime" required value="08:00" style="
                                        width: 100%;
                                        background: #1E293B;
                                        border: 1px solid #475569;
                                        color: #F8FAFC;
                                        padding: 0.75rem;
                                        border-radius: 8px;
                                        font-size: 0.875rem;
                                    ">
                                </div>
                                <div>
                                    <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">‚è±Ô∏è Dura√ß√£o (minutos)</label>
                                    <select id="classDuration" required style="
                                        width: 100%;
                                        background: #1E293B;
                                        border: 1px solid #475569;
                                        color: #F8FAFC;
                                        padding: 0.75rem;
                                        border-radius: 8px;
                                        font-size: 0.875rem;
                                    ">
                                        <option value="60">60 minutos</option>
                                        <option value="90">90 minutos</option>
                                        <option value="120">120 minutos</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Instructor Selection -->
                            <div>
                                <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">üë®‚Äçüè´ Instrutor Respons√°vel</label>
                                <select id="instructorSelect" required style="
                                    width: 100%;
                                    background: #1E293B;
                                    border: 1px solid #475569;
                                    color: #F8FAFC;
                                    padding: 0.75rem;
                                    border-radius: 8px;
                                    font-size: 0.875rem;
                                ">
                                    <option value="">Selecione um instrutor</option>
                                    <option value="prof-silva">Prof. Silva</option>
                                    <option value="prof-costa">Prof. Costa</option>
                                    <option value="prof-santos">Prof. Santos</option>
                                </select>
                            </div>
                            
                            <!-- Start Date -->
                            <div>
                                <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">üìÖ Data de In√≠cio</label>
                                <input type="date" id="startDate" required style="
                                    width: 100%;
                                    background: #1E293B;
                                    border: 1px solid #475569;
                                    color: #F8FAFC;
                                    padding: 0.75rem;
                                    border-radius: 8px;
                                    font-size: 0.875rem;
                                ">
                            </div>
                            
                            <!-- Additional Notes -->
                            <div>
                                <label style="color: #F8FAFC; font-weight: 600; margin-bottom: 0.5rem; display: block;">üìù Observa√ß√µes (Opcional)</label>
                                <textarea id="classNotes" placeholder="Informa√ß√µes adicionais sobre a turma..." style="
                                    width: 100%;
                                    background: #1E293B;
                                    border: 1px solid #475569;
                                    color: #F8FAFC;
                                    padding: 0.75rem;
                                    border-radius: 8px;
                                    font-size: 0.875rem;
                                    min-height: 80px;
                                    resize: vertical;
                                "></textarea>
                            </div>
                        </form>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                            <button onclick="closeCreateClassModal()" style="
                                background: rgba(107, 114, 128, 0.1);
                                border: 1px solid #6B7280;
                                color: #9CA3AF;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                                transition: all 0.2s;
                            ">
                                Cancelar
                            </button>
                            <button onclick="submitCreateClass()" style="
                                background: linear-gradient(135deg, #10B981, #059669);
                                border: none;
                                color: white;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                                transition: all 0.2s;
                            ">
                                ‚ûï Criar Turma
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default start date to next Monday
            const nextMonday = new Date();
            const day = nextMonday.getDay();
            const daysUntilMonday = day === 0 ? 1 : 8 - day;
            nextMonday.setDate(nextMonday.getDate() + daysUntilMonday);
            document.getElementById('startDate').value = nextMonday.toISOString().split('T')[0];
            
            // Animate modal in
            setTimeout(() => {
                modal.style.opacity = '1';
                const modalContent = modal.querySelector('.create-class-modal');
                modalContent.style.transform = 'translateY(0) scale(1)';
            }, 50);
        }
        
        function viewClassSchedule() {
            alert('üöß Fun√ß√£o em desenvolvimento: Cronograma de Turmas\n\nExibir√°:\n‚Ä¢ Calend√°rio completo\n‚Ä¢ Aulas agendadas\n‚Ä¢ Conflitos de hor√°rio\n‚Ä¢ Feriados e pausas');
        }
        
        function viewClassDetails(classId) {
            alert(`üöß Visualizando detalhes da Turma ${classId}\n\nInforma√ß√µes dispon√≠veis:\n‚Ä¢ Lista de alunos\n‚Ä¢ Progresso da turma\n‚Ä¢ Hist√≥rico de frequ√™ncia\n‚Ä¢ Avalia√ß√µes realizadas`);
        }
        
        function manageClassSchedule(classId) {
            alert(`üöß Gerenciando agenda da Turma ${classId}\n\nFuncionalidades:\n‚Ä¢ Reagendar aulas\n‚Ä¢ Marcar faltas do instrutor\n‚Ä¢ Aulas de reposi√ß√£o\n‚Ä¢ Altera√ß√µes de hor√°rio`);
        }
        
        function filterClasses() {
            const filter = document.getElementById('classStatusFilter').value;
            console.log('Filtering classes by:', filter);
            // Implementar filtragem das turmas
        }
        
        // Update classes count in sidebar
        function updateClassesCount() {
            // No hardcoded data - will be populated by real API calls
        }
        
        // Initialize classes data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateClassesCount();
        });

        // ===============================
        // COURSE GENERATION FUNCTIONS
        // ===============================
        
        function generateCourseWithRAG(event) {
            event.preventDefault();
            
            // Collect form data
            const formData = {
                martialArt: document.getElementById('martialArtSelect').value,
                courseLevel: document.getElementById('courseLevelSelect').value,
                courseName: document.getElementById('courseName').value,
                courseDescription: document.getElementById('courseDescription').value,
                targetAudience: document.getElementById('targetAudienceSelect').value,
                genderTarget: document.getElementById('genderTargetSelect').value,
                context: document.getElementById('contextSelect').value,
                courseDuration: document.getElementById('courseDuration').value,
                totalLessons: document.getElementById('totalLessons').value,
                lessonDuration: document.getElementById('lessonDuration').value,
                courseObjectives: document.getElementById('courseObjectives').value,
                evaluationCriteria: document.getElementById('evaluationCriteria').value,
                teachingStyle: document.getElementById('teachingStyle').value,
                aiInstructions: document.getElementById('aiInstructions').value,
                
                // Special adaptations
                adaptations: {
                    TEA: document.getElementById('adaptTEA').checked,
                    TDAH: document.getElementById('adaptTDH').checked,
                    mobility: document.getElementById('adaptMobility').checked,
                    visual: document.getElementById('adaptVisual').checked,
                    auditory: document.getElementById('adaptAuditory').checked,
                    cardiac: document.getElementById('adaptCardiac').checked
                }
            };

            // Validate required fields
            if (!formData.martialArt || !formData.courseLevel || !formData.courseName || 
                !formData.courseDescription || !formData.targetAudience || !formData.courseObjectives) {
                showToast('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }

            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span>‚è≥</span> Gerando com IA...';
            submitBtn.disabled = true;

            // Simulate RAG-powered course generation
            setTimeout(() => {
                console.log('Course data to be sent to RAG system:', formData);
                
                // Create course based on form data
                const generatedCourse = createCourseFromRAG(formData);
                
                // Add to courses list (simulate API call)
                addNewCourseToInterface(generatedCourse);
                
                // Show success message
                showToast(`‚úÖ Curso "${formData.courseName}" gerado com sucesso usando IA + RAG!`, 'success');
                
                // Reset form
                document.getElementById('courseGeneratorForm').reset();
                
                // Restore button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
            }, 3000);
        }

        function createCourseFromRAG(formData) {
            // Simulate RAG processing using knowledge base
            const course = {
                id: Date.now(),
                name: formData.courseName,
                description: formData.courseDescription,
                martialArt: formData.martialArt,
                level: formData.courseLevel,
                targetAudience: formData.targetAudience,
                duration: parseInt(formData.courseDuration),
                totalLessons: parseInt(formData.totalLessons),
                lessonDuration: parseInt(formData.lessonDuration),
                objectives: formData.courseObjectives.split(',').map(obj => obj.trim()),
                evaluationCriteria: formData.evaluationCriteria,
                teachingStyle: formData.teachingStyle,
                adaptations: formData.adaptations,
                
                // Generate lesson structure based on RAG knowledge
                lessons: generateLessonsFromRAG(formData),
                
                // Generate techniques based on RAG
                techniques: generateTechniquesFromRAG(formData),
                
                createdAt: new Date().toISOString(),
                status: 'active'
            };
            
            return course;
        }

        function generateLessonsFromRAG(formData) {
            // Base knowledge from RAG (simulated)
            const baseStructure = {
                'krav-maga': {
                    'branca': ['Fundamentos', 'Golpes B√°sicos', 'Defesas B√°sicas', 'Defesas Avan√ßadas', 'Integra√ß√£o'],
                    'amarela': ['Revis√£o', 'Combina√ß√µes', 'Cen√°rios Real√≠sticos', 'Defesas Complexas', 'Condicionamento'],
                    'laranja': ['T√©cnicas Avan√ßadas', 'M√∫ltiplos Atacantes', 'Armas Brancas', 'Situa√ß√µes Extremas', 'Lideran√ßa']
                }
            };
            
            const totalLessons = parseInt(formData.totalLessons);
            const modules = baseStructure[formData.martialArt]?.[formData.courseLevel] || 
                           ['M√≥dulo 1', 'M√≥dulo 2', 'M√≥dulo 3', 'M√≥dulo 4', 'M√≥dulo 5'];
            
            const lessons = [];
            const lessonsPerModule = Math.floor(totalLessons / modules.length);
            
            modules.forEach((module, moduleIndex) => {
                for (let i = 0; i < lessonsPerModule; i++) {
                    const lessonNumber = moduleIndex * lessonsPerModule + i + 1;
                    lessons.push({
                        number: lessonNumber,
                        module: module,
                        title: `${module} - Aula ${i + 1}`,
                        objectives: [`Objetivo espec√≠fico da aula ${lessonNumber}`],
                        techniques: [`T√©cnica ${lessonNumber}A`, `T√©cnica ${lessonNumber}B`],
                        duration: parseInt(formData.lessonDuration)
                    });
                }
            });
            
            return lessons;
        }

        function generateTechniquesFromRAG(formData) {
            // RAG-based technique generation (simulated)
            const baseTechniques = {
                'krav-maga': {
                    'branca': ['Guarda de Boxe', 'Jab', 'Cross', 'Joelhada Frontal', 'Chute Frontal', 'Defesa 360¬∞'],
                    'amarela': ['Hook', 'Uppercut', 'Combina√ß√£o Jab-Cross', 'Defesa Dupla', 'Contra-ataque'],
                    'laranja': ['T√©cnicas de Solo', 'Defesa vs Faca', 'Defesa vs Bast√£o', 'M√∫ltiplos Atacantes']
                }
            };
            
            return baseTechniques[formData.martialArt]?.[formData.courseLevel] || 
                   ['T√©cnica 1', 'T√©cnica 2', 'T√©cnica 3', 'T√©cnica 4', 'T√©cnica 5'];
        }

        function addNewCourseToInterface(course) {
            // Update courses count in header
            const coursesCount = document.getElementById('totalCoursesCount');
            if (coursesCount) {
                const currentCount = parseInt(coursesCount.textContent) || 0;
                coursesCount.textContent = currentCount + 1;
            }
            
            // Add to course selector
            const courseSelector = document.getElementById('courseSelector');
            if (courseSelector) {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.name;
                courseSelector.appendChild(option);
            }
            
            // Store in local storage (simulate backend)
            const existingCourses = JSON.parse(localStorage.getItem('generatedCourses') || '[]');
            existingCourses.push(course);
            localStorage.setItem('generatedCourses', JSON.stringify(existingCourses));
            
            console.log('Course added to interface:', course);
        }

        function useExistingTemplate() {
            const templates = [
                'Krav Maga Faixa Branca - Defesa Pessoal 1',
                'Krav Maga Faixa Amarela - Defesa Pessoal 2',
                'Jiu-Jitsu Fundamentos - Faixa Branca',
                'Boxe Iniciante - T√©cnicas B√°sicas'
            ];
            
            const selectedTemplate = prompt('Escolha um template:\n' + 
                templates.map((t, i) => `${i + 1}. ${t}`).join('\n'));
            
            if (selectedTemplate && selectedTemplate > 0 && selectedTemplate <= templates.length) {
                const template = templates[selectedTemplate - 1];
                showToast(`üìã Template "${template}" carregado!`, 'info');
                
                // Auto-fill form with template data (simplified)
                if (template.includes('Krav Maga Faixa Branca')) {
                    document.getElementById('martialArtSelect').value = 'krav-maga';
                    document.getElementById('courseLevelSelect').value = 'branca';
                    document.getElementById('courseName').value = template;
                    document.getElementById('targetAudienceSelect').value = 'adultos';
                    document.getElementById('courseObjectives').value = 'Desenvolver defesa pessoal, melhorar condicionamento f√≠sico, construir autoconfian√ßa';
                }
            }
        }

        function previewCourse() {
            // Collect current form data
            const formData = {
                name: document.getElementById('courseName').value || 'Novo Curso',
                martialArt: document.getElementById('martialArtSelect').value || 'N√£o especificado',
                level: document.getElementById('courseLevelSelect').value || 'N√£o especificado',
                duration: document.getElementById('courseDuration').value || '0',
                totalLessons: document.getElementById('totalLessons').value || '0'
            };
            
            const previewContent = `
üìö PREVIEW DO CURSO

ü•ã Nome: ${formData.name}
üéØ Arte Marcial: ${formData.martialArt}
üéñÔ∏è N√≠vel: ${formData.level}
‚è±Ô∏è Dura√ß√£o: ${formData.duration} semanas
üìñ Total de Aulas: ${formData.totalLessons}

üß† Gera√ß√£o com RAG:
‚Ä¢ Base de conhecimento: Agenda + Plano Faixa Branca
‚Ä¢ IA adaptar√° metodologia para seus par√¢metros
‚Ä¢ Estrutura pedag√≥gica comprovada
‚Ä¢ Adapta√ß√µes autom√°ticas por p√∫blico-alvo

üí° Pr√≥ximos passos:
1. Complete todos os campos
2. Clique em "Gerar com IA + RAG"
3. Aguarde processamento (3-5s)
4. Curso ser√° adicionado √† biblioteca
            `;
            
            alert(previewContent);
        }

        // Edit existing course template
        function editCourseTemplate(courseId) {
            showToast('üöß Fun√ß√£o em desenvolvimento: Editar Template de Curso\n\nPermitir√°:\n‚Ä¢ Modificar estrutura do curso\n‚Ä¢ Alterar sequ√™ncia de t√©cnicas\n‚Ä¢ Adaptar planos de aula\n‚Ä¢ Personalizar avalia√ß√µes', 'info');
        }

        // Duplicate existing course
        function duplicateCourse() {
            const selectedCourse = document.getElementById('courseSelector').value;
            const courseName = document.getElementById('courseSelector').selectedOptions[0].text;
            
            const newCourseName = prompt(`Digite o nome para o curso duplicado:\n\nOriginal: ${courseName}`, `${courseName} - C√≥pia`);
            
            if (newCourseName && newCourseName.trim()) {
                showToast(`üìã Curso "${newCourseName}" duplicado com sucesso!\n\nAgora voc√™ pode edit√°-lo independentemente.`, 'success');
                
                // Add the duplicated course to selector
                const courseSelector = document.getElementById('courseSelector');
                const option = document.createElement('option');
                option.value = `curso-${Date.now()}`;
                option.textContent = newCourseName.trim();
                courseSelector.appendChild(option);
                courseSelector.value = option.value;
                
                // Update courses count
                const coursesCount = document.getElementById('totalCoursesCount');
                if (coursesCount) {
                    const currentCount = parseInt(coursesCount.textContent) || 0;
                    coursesCount.textContent = currentCount + 1;
                }
            }
        }

        // ==========================================
        // STUDENT EDIT PAGE (DEDICATED) FUNCTIONS
        // ==========================================
        // (Function moved to top of file for proper scope)

        function saveStudentEdit(studentId) {
            const firstName = document.getElementById('editFirstName').value;
            const lastName = document.getElementById('editLastName').value;
            const email = document.getElementById('editEmail').value;
            const phone = document.getElementById('editPhone').value;
            const cpf = document.getElementById('editCpf').value;
            
            const updateData = {
                firstName,
                lastName,
                email,
                phone,
                cpf
            };
            
            fetch(`/api/students/${studentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('‚úÖ Aluno atualizado com sucesso!', 'success');
                    closeEditToast();
                    // Reload students data
                    if (typeof loadStudents === 'function') {
                        loadStudents();
                    } else {
                        loadData(); // fallback
                    }
                } else {
                    showToast('‚ùå Erro ao atualizar aluno: ' + (data.message || 'Erro desconhecido'), 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao atualizar aluno:', error);
                showToast('‚ùå Erro ao atualizar aluno: ' + error.message, 'error');
            });
        }

        function showCustomToast(content, type = 'info', duration = 3000) {
            const existingToast = document.querySelector('.custom-toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.innerHTML = content;
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 10000;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                border: 1px solid #374151;
                animation: slideIn 0.3s ease-out;
            `;

            document.body.appendChild(toast);

            if (duration > 0) {
                setTimeout(() => {
                    if (toast && toast.parentNode) {
                        toast.remove();
                    }
                }, duration);
            }
        }

        function closeEditToast() {
            const toast = document.querySelector('.custom-toast');
            if (toast) {
                toast.remove();
            }
        }

        // OLD COMPLEX FUNCTION BELOW - REPLACED WITH SIMPLE VERSION ABOVE
        async function openStudentEditPage_OLD(studentId) {
            try {
                console.log('üîÑ Abrindo p√°gina de edi√ß√£o do aluno:', studentId);
                currentEditingStudentId = studentId;

                // Fetch student data
                const response = await fetch(`/api/students`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Erro ao carregar dados do estudante');
                }
                
                // Find the specific student
                const student = data.data.find(s => s.id === studentId);
                if (!student) {
                    throw new Error('Estudante n√£o encontrado');
                }

                currentEditingStudent = student;
                
                // Hide students list and show edit page
                document.getElementById('students').style.display = 'none';
                document.getElementById('student-edit-page').style.display = 'block';
                
                // Update page header with student info
                updateEditPageHeader(student);
                
                // Load the edit form
                loadEditPageForm(student);
                
                // Update sidebar with student stats
                updateEditPageSidebar(student);
                
                // Set active tab to edit
                switchPageTab('edit');
                
                console.log('‚úÖ P√°gina de edi√ß√£o carregada com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir p√°gina de edi√ß√£o:', error);
                showNotification(`Erro: ${error.message}`, 'error');
            }
        }


        // Load overview tab content
        function loadOverviewTabContent() {
            const overviewTab = document.getElementById('page-tab-overview');
            const student = currentEditingStudent;
            const user = student.user || {};

            overviewTab.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="color: #F8FAFC; margin: 0 0 1rem 0;">üë§ Dados Pessoais</h4>
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem; border: 1px solid #334155;">
                            <div style="margin-bottom: 0.75rem;">
                                <div style="color: #94A3B8; font-size: 0.875rem;">Nome Completo</div>
                                <div style="color: #F8FAFC; font-weight: 600;">${user.firstName || ''} ${user.lastName || ''}</div>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <div style="color: #94A3B8; font-size: 0.875rem;">Email</div>
                                <div style="color: #F8FAFC;">${user.email || 'N√£o informado'}</div>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <div style="color: #94A3B8; font-size: 0.875rem;">Telefone</div>
                                <div style="color: #F8FAFC;">${user.phone || 'N√£o informado'}</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #F8FAFC; margin: 0 0 1rem 0;">ü•ã Dados Acad√™micos</h4>
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem; border: 1px solid #334155;">
                            <div style="margin-bottom: 0.75rem;">
                                <div style="color: #94A3B8; font-size: 0.875rem;">Categoria</div>
                                <div style="color: #F8FAFC; font-weight: 600;">${student.category || 'N/A'}</div>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <div style="color: #94A3B8; font-size: 0.875rem;">N√≠vel</div>
                                <div style="color: #F8FAFC;">N√≠vel ${student.globalLevel || '1'}</div>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <div style="color: #94A3B8; font-size: 0.875rem;">XP Total</div>
                                <div style="color: #F8FAFC;">${student.totalXP || '0'} pontos</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Progress tab with detailed content
        function loadProgressTabContent() {
            const progressTab = document.getElementById('progressContent');
            progressTab.innerHTML = `
                <!-- Overall Progress -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #10B981; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        üìä Progresso Geral
                        <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                            EM ALTA
                        </div>
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                        <div style="text-align: center;">
                            <div style="position: relative; display: inline-block; margin-bottom: 1rem;">
                                <svg width="140" height="140" viewBox="0 0 140 140">
                                    <circle cx="70" cy="70" r="60" fill="none" stroke="#334155" stroke-width="12"/>
                                    <circle cx="70" cy="70" r="60" fill="none" stroke="#10B981" stroke-width="12"
                                            stroke-dasharray="377" stroke-dashoffset="260" stroke-linecap="round"
                                            transform="rotate(-90 70 70)"/>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                    <div style="color: #10B981; font-size: 1.75rem; font-weight: bold;">31%</div>
                                    <div style="color: #94A3B8; font-size: 0.8rem;">COMPLETO</div>
                                </div>
                            </div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">Aula 15 de 48</div>
                        </div>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1;">Frequ√™ncia m√©dia:</span>
                                <span style="color: #10B981; font-weight: 600;">95%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1;">T√©cnicas dominadas:</span>
                                <span style="color: #F8FAFC; font-weight: 600;">13 de 42</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1;">XP total acumulado:</span>
                                <span style="color: #8B5CF6; font-weight: 600;">1,250 XP</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1;">Ranking na turma:</span>
                                <span style="color: #F59E0B; font-weight: 600;">3¬∫ de 15</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1;">Tempo at√© pr√≥xima faixa:</span>
                                <span style="color: #3B82F6; font-weight: 600;">~8 semanas</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- T√©cnicas por Categoria -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">ü•ã Progresso por Categoria de T√©cnica</h4>
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem; border: 1px solid #475569;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: #F8FAFC; font-weight: 600;">üëä Golpes B√°sicos</span>
                                <span style="color: #10B981;">85%</span>
                            </div>
                            <div style="background: #1E293B; border-radius: 4px; height: 6px; width: 100%; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #10B981, #059669); height: 100%; width: 85%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="color: #94A3B8; font-size: 0.75rem; margin-top: 0.25rem;">Socos, chutes, cotoveladas ‚Ä¢ 6 de 7 t√©cnicas</div>
                        </div>
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem; border: 1px solid #475569;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: #F8FAFC; font-weight: 600;">üõ°Ô∏è Defesas B√°sicas</span>
                                <span style="color: #F59E0B;">65%</span>
                            </div>
                            <div style="background: #1E293B; border-radius: 4px; height: 6px; width: 100%; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #F59E0B, #D97706); height: 100%; width: 65%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="color: #94A3B8; font-size: 0.75rem; margin-top: 0.25rem;">Bloqueios, esquivas ‚Ä¢ 4 de 6 t√©cnicas</div>
                        </div>
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem; border: 1px solid #475569;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: #F8FAFC; font-weight: 600;">ü§∏ Movimenta√ß√£o</span>
                                <span style="color: #10B981;">90%</span>
                            </div>
                            <div style="background: #1E293B; border-radius: 4px; height: 6px; width: 100%; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #10B981, #059669); height: 100%; width: 90%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="color: #94A3B8; font-size: 0.75rem; margin-top: 0.25rem;">Postura, deslocamento ‚Ä¢ 3 de 3 t√©cnicas</div>
                        </div>
                        <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1rem; border: 1px solid #475569;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: #F8FAFC; font-weight: 600;">‚öîÔ∏è T√©cnicas Avan√ßadas</span>
                                <span style="color: #64748B;">0%</span>
                            </div>
                            <div style="background: #1E293B; border-radius: 4px; height: 6px; width: 100%; overflow: hidden;">
                                <div style="background: #64748B; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="color: #94A3B8; font-size: 0.75rem; margin-top: 0.25rem;">N√£o iniciado ‚Ä¢ 0 de 26 t√©cnicas</div>
                        </div>
                    </div>
                </div>

                <!-- Evolu√ß√£o Temporal -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #8B5CF6; margin: 0 0 1rem 0;">üìà Evolu√ß√£o nas √öltimas Semanas</h4>
                    <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.5rem; align-items: end; height: 120px; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px; border: 1px solid #475569;">
                        <div style="text-align: center;">
                            <div style="background: #10B981; height: 60px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S1</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #10B981; height: 75px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S2</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #F59E0B; height: 45px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S3</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #10B981; height: 85px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S4</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #10B981; height: 90px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S5</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #3B82F6; height: 70px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S6</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #10B981; height: 95px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S7</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: #8B5CF6; height: 100px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 0.5rem;"></div>
                            <div style="color: #94A3B8; font-size: 0.7rem;">S8</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; background: #10B981; border-radius: 2px;"></div>
                            <span style="color: #CBD5E1; font-size: 0.875rem;">Excelente (90%+)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; background: #3B82F6; border-radius: 2px;"></div>
                            <span style="color: #CBD5E1; font-size: 0.875rem;">Bom (70-89%)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; background: #F59E0B; border-radius: 2px;"></div>
                            <span style="color: #CBD5E1; font-size: 0.875rem;">Regular (50-69%)</span>
                        </div>
                    </div>
                </div>

                <!-- Achievements -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                    <h4 style="color: #F59E0B; margin: 0 0 1rem 0;">üèÜ Conquistas e Badges</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üéØ</div>
                            <div style="color: #10B981; font-weight: 600; font-size: 0.875rem;">Frequ√™ncia Exemplar</div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">95% nas √∫ltimas 4 semanas</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üî•</div>
                            <div style="color: #8B5CF6; font-weight: 600; font-size: 0.875rem;">Sequ√™ncia de Ouro</div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">7 aulas consecutivas</div>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö°</div>
                            <div style="color: #F59E0B; font-weight: 600; font-size: 0.875rem;">Progresso R√°pido</div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">31% em 6 semanas</div>
                        </div>
                        <div style="background: rgba(71, 85, 105, 0.1); border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid rgba(71, 85, 105, 0.2); opacity: 0.6;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ü•ã</div>
                            <div style="color: #94A3B8; font-weight: 600; font-size: 0.875rem;">Primeiro Sparring</div>
                            <div style="color: #64748B; font-size: 0.75rem;">Em breve</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== NOVAS FUN√á√ïES DAS ABAS =====

        // AI Dashboard Tab
        function loadAIDashboardContent() {
            const aiTab = document.getElementById('aiDashboardContent');
            aiTab.innerHTML = `
                <!-- AI Dashboard Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <!-- Performance Score -->
                    <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                        <h4 style="color: #10B981; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            üéØ Score de Performance IA
                        </h4>
                        <div style="text-align: center;">
                            <div style="position: relative; display: inline-block;">
                                <svg width="120" height="120" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" fill="none" stroke="#334155" stroke-width="8"/>
                                    <circle cx="60" cy="60" r="54" fill="none" stroke="#10B981" stroke-width="8"
                                            stroke-dasharray="339" stroke-dashoffset="82" stroke-linecap="round"
                                            transform="rotate(-90 60 60)"/>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                    <div style="color: #10B981; font-size: 1.5rem; font-weight: bold;">87%</div>
                                    <div style="color: #94A3B8; font-size: 0.7rem;">EXCELENTE</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; color: #94A3B8; font-size: 0.875rem; text-align: center;">
                            Baseado em frequ√™ncia, evolu√ß√£o t√©cnica e engajamento
                        </div>
                    </div>

                    <!-- Risk Assessment -->
                    <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                        <h4 style="color: #F59E0B; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            ‚ö†Ô∏è An√°lise de Risco
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1; font-size: 0.875rem;">Risco de Abandono</span>
                                <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                                    BAIXO (15%)
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1; font-size: 0.875rem;">Pontualidade</span>
                                <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                                    √ìTIMA
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #CBD5E1; font-size: 0.875rem;">Evolu√ß√£o T√©cnica</span>
                                <div style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; border: 1px solid rgba(245, 158, 11, 0.3);">
                                    ACIMA DA M√âDIA
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #8B5CF6; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        üß† Insights IA Personalizados
                    </h4>
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="color: #C4B5FD; font-weight: 600; margin-bottom: 0.5rem;">‚ú® Pontos Fortes</div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">
                                ‚Ä¢ Excelente frequ√™ncia (95% nas √∫ltimas 4 semanas)<br>
                                ‚Ä¢ Evolu√ß√£o consistente em t√©cnicas de defesa<br>
                                ‚Ä¢ Alta motiva√ß√£o em treinamentos de sparring
                            </div>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <div style="color: #FCD34D; font-weight: 600; margin-bottom: 0.5rem;">üí° Oportunidades</div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">
                                ‚Ä¢ Focar em t√©cnicas de ground fighting (score atual: 65%)<br>
                                ‚Ä¢ Participar mais dos desafios semanais<br>
                                ‚Ä¢ Considerar treinamento adicional de flexibilidade
                            </div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div style="color: #6EE7B7; font-weight: 600; margin-bottom: 0.5rem;">üéØ Recomenda√ß√£o IA</div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">
                                Aluno modelo com evolu√ß√£o exemplar. Sugest√£o: promover para instrutor assistente volunt√°rio para motivar outros alunos iniciantes.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Prediction -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                    <h4 style="color: #3B82F6; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        üìà Predi√ß√µes e Tend√™ncias
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="color: #60A5FA; font-size: 1.25rem; font-weight: bold;">92%</div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">Chance de completar faixa</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div style="color: #34D399; font-size: 1.25rem; font-weight: bold;">4.8</div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">Score satisfa√ß√£o (IA)</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <div style="color: #FBBF24; font-size: 1.25rem; font-weight: bold;">8 sem</div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">Tempo para pr√≥xima faixa</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o removida - agora usando loadPlansTabContent do students.js

        // Function to update sidebar financial status
        function updateSidebarFinancialStatus(hasActiveSubscription, currentPlan) {
            console.log('üîÑ updateSidebarFinancialStatus called:', { 
                hasActiveSubscription, 
                planName: currentPlan?.name,
                planObject: currentPlan 
            });
            const sidebarFinancial = document.getElementById('sidebarFinancialStatus');
            if (!sidebarFinancial) {
                console.error('‚ùå Elemento sidebarFinancialStatus n√£o encontrado');
                return;
            }
            
            if (hasActiveSubscription && currentPlan) {
                const planName = currentPlan.name || currentPlan.title || 'Plano sem nome';
                const planPrice = currentPlan.price || currentPlan.amount || '0';
                const billingType = currentPlan.billingType || currentPlan.billingCycle || '';
                
                sidebarFinancial.innerHTML = `
                    <div style="color: #10B981; font-weight: bold; margin-bottom: 0.5rem;">‚úÖ Plano Ativo</div>
                    <div style="color: #CBD5E1; font-size: 0.875rem;">R$ ${planPrice}${billingType === 'MONTHLY' ? '/m√™s' : billingType === 'YEARLY' ? '/ano' : ''}</div>
                    <div style="color: #94A3B8; font-size: 0.75rem; margin-top: 0.25rem;">${planName}</div>
                `;
                console.log('‚úÖ Sidebar atualizado com plano:', planName);
                sidebarFinancial.style.background = 'rgba(16, 185, 129, 0.1)';
                sidebarFinancial.style.borderColor = 'rgba(16, 185, 129, 0.3)';
            } else {
                sidebarFinancial.innerHTML = `
                    <div style="color: #F59E0B; font-weight: bold; margin-bottom: 0.5rem;">‚ö†Ô∏è Sem Plano</div>
                    <div style="color: #CBD5E1; font-size: 0.875rem;">Atribuir plano de pagamento</div>
                    <div style="color: #94A3B8; font-size: 0.75rem; margin-top: 0.25rem;">Acesso limitado</div>
                `;
                sidebarFinancial.style.background = 'rgba(245, 158, 11, 0.1)';
                sidebarFinancial.style.borderColor = 'rgba(245, 158, 11, 0.3)';
            }
        }

        // Function to assign a plan to the current student
        async function assignPlanToStudent(planId) {
            const studentId = window.getCurrentEditingStudentId ? window.getCurrentEditingStudentId() : currentEditingStudentId;
            if (!studentId) {
                showToast('Erro: ID do aluno n√£o encontrado', 'error');
                return;
            }
            
            try {
                showToast('‚è≥ Atribuindo plano e inscrevendo em cursos...', 'info');
                
                let success = false;
                let responseData = null;
                let lastError = null;
                
                // Try new auto-enrollment route first
                try {
                    console.log('üîÑ Tentando rota com inscri√ß√£o autom√°tica...');
                    const response = await fetch(`/api/students/${currentEditingStudentId}/assign-plan-with-courses`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            planId: planId
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            success = true;
                            responseData = data;
                            console.log('‚úÖ Rota com inscri√ß√£o autom√°tica funcionou:', data);
                            
                            // Show detailed success message with enrollment info
                            const summary = data.data.autoEnrollmentSummary;
                            if (summary.coursesEnrolled > 0 || summary.classesAssigned > 0) {
                                showToast(`‚úÖ Plano "${summary.planAssigned}" atribu√≠do!\nüìö ${summary.coursesEnrolled} curso(s) inscrito(s)\nüïê ${summary.classesAssigned} turma(s) atribu√≠da(s)`, 'success');
                            } else {
                                showToast(`‚úÖ Plano "${summary.planAssigned}" atribu√≠do com sucesso!`, 'success');
                            }
                        }
                    } else {
                        const errorData = await response.json();
                        lastError = errorData.error || errorData.message || `HTTP ${response.status}`;
                        console.log('‚ö†Ô∏è Rota com inscri√ß√£o autom√°tica falhou:', lastError);
                    }
                } catch (error) {
                    lastError = error.message;
                    console.log('‚ö†Ô∏è Erro na rota com inscri√ß√£o autom√°tica:', error.message);
                }
                
                // Fallback to financial route if auto-enrollment failed
                if (!success) {
                    try {
                        console.log('üîÑ Tentando rota financeira como fallback...');
                        const response = await fetch('/api/financial/subscriptions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                studentId: currentEditingStudentId,
                                planId: planId,
                                startDate: new Date().toISOString()
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                success = true;
                                responseData = data;
                                console.log('‚úÖ Rota financeira funcionou:', data);
                                showToast('‚úÖ Plano atribu√≠do (sem inscri√ß√£o autom√°tica)', 'success');
                            }
                        } else {
                            const errorData = await response.json();
                            lastError = errorData.error || errorData.message || `HTTP ${response.status}`;
                            console.log('‚ö†Ô∏è Rota financeira falhou:', lastError);
                        }
                    } catch (error) {
                        lastError = error.message;
                        console.log('‚ö†Ô∏è Erro na rota financeira:', error.message);
                    }
                }
                
                // Final fallback to student subscription route
                if (!success) {
                    try {
                        console.log('üîÑ Tentando rota alternativa de subscription...');
                        const response = await fetch(`/api/students/${currentEditingStudentId}/subscription`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                planId: planId,
                                startDate: new Date().toISOString()
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                success = true;
                                responseData = data;
                                console.log('‚úÖ Rota alternativa funcionou:', data);
                                showToast('‚úÖ Plano atribu√≠do (m√©todo alternativo)', 'success');
                            }
                        } else {
                            const errorData = await response.json();
                            lastError = errorData.error || errorData.message || `HTTP ${response.status}`;
                            console.log('‚ö†Ô∏è Rota alternativa falhou:', lastError);
                        }
                    } catch (error) {
                        lastError = error.message;
                        console.log('‚ö†Ô∏è Erro na rota alternativa:', error.message);
                    }
                }
                
                // Handle the result
                if (success) {
                    showToast('‚úÖ Plano atribu√≠do com sucesso!', 'success');
                    
                    // Enhanced reload with immediate visual feedback
                    showToast('üîÑ Atualizando interface...', 'info');
                    
                    setTimeout(async () => {
                        console.log('üîÑ [UX] Recarregando ap√≥s atribui√ß√£o de plano...');
                        
                        try {
                            // Multiple verification attempts for robustness
                            let verificationSuccess = false;
                            for (let i = 0; i < 3; i++) {
                                const checkResponse = await fetch(`/api/students/${currentEditingStudentId}/subscription?_=${Date.now()}`);
                                const checkData = await checkResponse.json();
                                console.log(`üîç [UX] Verification attempt ${i + 1}:`, checkData);
                                
                                if (checkData.success && checkData.data && checkData.data.plan) {
                                    verificationSuccess = true;
                                    console.log('‚úÖ [UX] Plan verification successful!');
                                    break;
                                }
                                
                                // Wait before next attempt
                                if (i < 2) await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                            
                            // Force UI reload
                            await Promise.all([
                                loadPlansTabContent(currentEditingStudentId),
                                loadStudentFinancialTab()
                            ]);
                            
                            if (verificationSuccess) {
                                showToast('‚úÖ Plano atualizado com sucesso!', 'success');
                            } else {
                                showToast('‚ö†Ô∏è Plano atribu√≠do, recarregue a p√°gina se n√£o aparecer', 'warning');
                            }
                            
                        } catch (error) {
                            console.error('‚ùå [UX] Error during reload:', error);
                            showToast('‚ùå Erro ao atualizar interface', 'error');
                        }
                    }, 800);
                    
                } else {
                    // Show error message - no more fallback
                    const errorMessage = lastError || 'Erro desconhecido';
                    console.error('‚ùå Todas as rotas falharam:', errorMessage);
                    showToast(`‚ùå Erro ao atribuir plano: ${errorMessage}`, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Erro geral:', error);
                showToast(`‚ùå Erro inesperado: ${error.message}`, 'error');
            }
        }

        // Function to edit current student plan - Enhanced with full functionality
        async function editStudentPlan() {
            if (!currentEditingStudentId) {
                showToast('‚ùå Erro: ID do aluno n√£o encontrado', 'error');
                return;
            }
            
            try {
                // Get current subscription and available plans
                showToast('üîÑ Carregando dados para edi√ß√£o...', 'info');
                
                const [subscriptionResponse, plansResponse] = await Promise.all([
                    fetch(`/api/students/${currentEditingStudentId}/subscription`),
                    fetch('/api/billing-plans')
                ]);
                
                const subscriptionData = await subscriptionResponse.json();
                const plansData = await plansResponse.json();
                
                if (!subscriptionData.success || !subscriptionData.data) {
                    showToast('‚ùå Este aluno n√£o possui plano ativo para editar', 'error');
                    return;
                }
                
                const currentSubscription = subscriptionData.data;
                console.log('üîç [DEBUG] currentSubscription in editStudentPlan:', currentSubscription);
                console.log('üîç [DEBUG] currentSubscription.plan:', currentSubscription.plan);
                
                const currentPlan = currentSubscription.plan;
                if (!currentPlan) {
                    showToast('‚ùå Dados do plano n√£o encontrados. Recarregue a p√°gina e tente novamente.', 'error');
                    return;
                }
                
                const availablePlans = plansData.success ? plansData.data : [];
                
                // Create edit plan modal
                openEditPlanModal(currentSubscription, currentPlan, availablePlans);
                
            } catch (error) {
                console.error('Error opening plan editor:', error);
                showToast('‚ùå Erro ao carregar dados para edi√ß√£o', 'error');
            }
        }

        // Function to open edit plan modal with modern UI
        function openEditPlanModal(currentSubscription, currentPlan, availablePlans) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div class="edit-plan-modal" style="
                    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
                    border-radius: 20px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 90vh;
                    overflow-y: auto;
                    border: 1px solid #334155;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
                    transform: translateY(20px) scale(0.95);
                    transition: all 0.3s ease;
                ">
                    <!-- Header -->
                    <div style="padding: 2rem 2rem 1rem 2rem; border-bottom: 1px solid #334155;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="color: #F8FAFC; margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700;">‚úèÔ∏è Editar Plano</h2>
                                <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">Altere o plano de pagamento do aluno</p>
                            </div>
                            <button onclick="closeEditPlanModal()" style="
                                background: rgba(239, 68, 68, 0.1);
                                border: 1px solid rgba(239, 68, 68, 0.3);
                                color: #EF4444;
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 1.2rem;
                                transition: all 0.2s;
                            " onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    
                    <!-- Current Plan Display -->
                    <div style="padding: 2rem;">
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05)); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #10B981; margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                                üìã Plano Atual
                                <span style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">ATIVO</span>
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">PLANO</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">${currentPlan.name}</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">VALOR</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">R$ ${parseFloat(currentPlan.price).toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">CATEGORIA</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">${currentPlan.category}</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem; margin-bottom: 0.25rem;">AULAS/SEMANA</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">${currentPlan.classesPerWeek || 'Ilimitado'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Plan Selection -->
                        <h3 style="color: #F8FAFC; margin: 0 0 1rem 0; font-size: 1.1rem;">üîÑ Alterar para:</h3>
                        <div style="display: grid; gap: 1rem; max-height: 400px; overflow-y: auto; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 12px; border: 1px solid #334155;">
                            ${availablePlans.filter(plan => plan.id !== currentPlan.id && plan.isActive).map(plan => `
                                <div class="plan-option" data-plan-id="${plan.id}" style="
                                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(29, 78, 216, 0.05));
                                    border: 1px solid rgba(59, 130, 246, 0.2);
                                    border-radius: 12px;
                                    padding: 1.5rem;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    position: relative;
                                " onmouseover="this.style.borderColor='#3B82F6'; this.style.background='linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.1))'" onmouseout="this.style.borderColor='rgba(59, 130, 246, 0.2)'; this.style.background='linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(29, 78, 216, 0.05))'" onclick="selectNewPlan('${plan.id}', '${plan.name}', '${plan.price}', '${plan.category}')">
                                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: start;">
                                        <div>
                                            <h4 style="color: #3B82F6; margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 600;">${plan.name}</h4>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 0.75rem;">
                                                <div>
                                                    <span style="color: #94A3B8; font-size: 0.75rem;">CATEGORIA:</span>
                                                    <span style="color: #CBD5E1; font-size: 0.875rem; margin-left: 0.25rem;">${plan.category}</span>
                                                </div>
                                                <div>
                                                    <span style="color: #94A3B8; font-size: 0.75rem;">AULAS:</span>
                                                    <span style="color: #CBD5E1; font-size: 0.875rem; margin-left: 0.25rem;">${plan.classesPerWeek || 'Ilimitado'}/sem</span>
                                                </div>
                                                <div>
                                                    <span style="color: #94A3B8; font-size: 0.75rem;">TIPO:</span>
                                                    <span style="color: #CBD5E1; font-size: 0.875rem; margin-left: 0.25rem;">${plan.billingType === 'MONTHLY' ? 'Mensal' : plan.billingType}</span>
                                                </div>
                                            </div>
                                            ${plan.description ? `<p style="color: #94A3B8; font-size: 0.875rem; margin: 0; opacity: 0.8;">${plan.description}</p>` : ''}
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); border-radius: 12px; padding: 1rem; min-width: 100px;">
                                                <div style="color: white; font-size: 1.2rem; font-weight: bold; margin-bottom: 0.25rem;">R$ ${parseFloat(plan.price).toFixed(2)}</div>
                                                <div style="color: rgba(255, 255, 255, 0.8); font-size: 0.75rem;">${plan.billingType === 'MONTHLY' ? 'mensal' : 'total'}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: space-between;">
                            <!-- Remove Plan Button -->
                            <button onclick="console.log('üóëÔ∏è Remove button clicked!'); confirmRemovePlan()" style="
                                background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
                                border: 1px solid #EF4444;
                                color: #EF4444;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                                transition: all 0.2s;
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                            " onmouseover="this.style.background='linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1))'">
                                üóëÔ∏è Remover Plano
                            </button>
                            
                            <!-- Right side buttons -->
                            <div style="display: flex; gap: 1rem;">
                                <button onclick="closeEditPlanModal()" style="
                                    background: rgba(107, 114, 128, 0.1);
                                    border: 1px solid #6B7280;
                                    color: #9CA3AF;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='rgba(107, 114, 128, 0.2)'" onmouseout="this.style.background='rgba(107, 114, 128, 0.1)'">
                                    Cancelar
                                </button>
                                <button id="confirmPlanChangeBtn" onclick="console.log('‚úèÔ∏è Confirm change button clicked!'); confirmPlanChange()" disabled style="
                                    background: linear-gradient(135deg, #10B981, #059669);
                                    border: none;
                                    color: white;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: not-allowed;
                                    font-weight: 600;
                                    opacity: 0.5;
                                    transition: all 0.2s;
                                ">
                                    Confirmar Altera√ß√£o
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Animate modal in
            setTimeout(() => {
                modal.style.opacity = '1';
                const modalContent = modal.querySelector('.edit-plan-modal');
                modalContent.style.transform = 'translateY(0) scale(1)';
            }, 50);
            
            // Store current subscription for later use
            window.currentEditingSubscription = currentSubscription;
            window.selectedNewPlanId = null;
        }

        // Function to select a new plan
        function selectNewPlan(planId, planName, planPrice, planCategory) {
            console.log('üéØ [DEBUG] selectNewPlan called:', { planId, planName, planPrice, planCategory });
            
            // Clear previous selections
            document.querySelectorAll('.plan-option').forEach(option => {
                option.style.borderColor = 'rgba(59, 130, 246, 0.2)';
                option.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(29, 78, 216, 0.05))';
            });
            
            // Highlight selected plan
            const selectedOption = document.querySelector(`[data-plan-id="${planId}"]`);
            if (selectedOption) {
                selectedOption.style.borderColor = '#10B981';
                selectedOption.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1))';
                console.log('‚úÖ [DEBUG] Plan option highlighted');
            } else {
                console.error('‚ùå [DEBUG] Plan option not found for planId:', planId);
            }
            
            // Enable confirm button
            const confirmBtn = document.getElementById('confirmPlanChangeBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.style.cursor = 'pointer';
                confirmBtn.style.opacity = '1';
                confirmBtn.innerHTML = `Alterar para ${planName} (R$ ${parseFloat(planPrice).toFixed(2)})`;
                console.log('‚úÖ [DEBUG] Confirm button enabled');
            } else {
                console.error('‚ùå [DEBUG] Confirm button not found');
            }
            
            // Store selected plan
            window.selectedNewPlanId = planId;
            console.log('‚úÖ [DEBUG] Selected plan stored:', planId);
        }

        // Function to confirm plan change
        async function confirmPlanChange() {
            console.log('üîÑ [DEBUG] confirmPlanChange called - START');
            console.log('üîÑ [DEBUG] selectedNewPlanId:', window.selectedNewPlanId);
            console.log('üîÑ [DEBUG] currentEditingSubscription:', window.currentEditingSubscription);
            console.log('üîÑ [DEBUG] currentEditingStudentId:', currentEditingStudentId);
            
            if (!window.selectedNewPlanId || !window.currentEditingSubscription) {
                console.error('‚ùå [DEBUG] Missing required data for plan change');
                showToast('‚ùå Erro: Dados de altera√ß√£o n√£o encontrados', 'error');
                return;
            }
            
            try {
                showToast('üîÑ Alterando plano...', 'info');
                
                // Disable button during processing
                const confirmBtn = document.getElementById('confirmPlanChangeBtn');
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = 'üîÑ Processando...';
                }
                
                // Update subscription with new plan
                const response = await fetch(`/api/students/${currentEditingStudentId}/subscription`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        planId: window.selectedNewPlanId,
                        subscriptionId: window.currentEditingSubscription.id
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast('‚úÖ Plano alterado com sucesso!', 'success');
                    closeEditPlanModal();
                    
                    // Reload financial tab to show changes
                    setTimeout(() => {
                        loadStudentFinancialTab();
                        loadPlansTabContent(currentEditingStudentId);
                    }, 1000);
                    
                } else {
                    throw new Error(result.message || 'Erro ao alterar plano');
                }
                
            } catch (error) {
                console.error('Error changing plan:', error);
                showToast(`‚ùå Erro ao alterar plano: ${error.message}`, 'error');
                
                // Re-enable button
                const confirmBtn = document.getElementById('confirmPlanChangeBtn');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = 'Confirmar Altera√ß√£o';
                }
            }
        }

        // Function to confirm plan removal
        async function confirmRemovePlanStandalone() {
            console.log('üîÑ [DEBUG] confirmRemovePlanStandalone called - START');
            console.log('üîÑ [DEBUG] currentEditingStudentId:', currentEditingStudentId);
            
            if (!currentEditingStudentId) {
                console.error('‚ùå [DEBUG] Missing currentEditingStudentId for plan removal');
                showToast('‚ùå Erro: Aluno n√£o identificado', 'error');
                return;
            }
            
            // Show confirmation dialog
            const confirmRemoval = confirm('‚ö†Ô∏è Tem certeza que deseja REMOVER o plano deste aluno?\n\nEsta a√ß√£o n√£o pode ser desfeita.');
            
            if (!confirmRemoval) {
                console.log('üîÑ [DEBUG] Plan removal cancelled by user');
                return;
            }
            
            try {
                showToast('üîÑ Removendo plano...', 'info');
                
                // Get current subscription to remove
                const subscriptionResponse = await fetch(`/api/students/${currentEditingStudentId}/subscription`);
                const subscriptionData = await subscriptionResponse.json();
                
                if (!subscriptionData.success || !subscriptionData.data) {
                    showToast('‚ùå Erro: Plano n√£o encontrado', 'error');
                    return;
                }
                
                const subscriptionId = subscriptionData.data.id;
                
                // Remove subscription by setting status to CANCELLED
                const response = await fetch(`/api/students/${currentEditingStudentId}/subscription`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ [DEBUG] Plan removed successfully');
                    showToast('‚úÖ Plano removido com sucesso!', 'success');
                    
                    // Refresh the plan data
                    await forceRefreshPlanData();
                    
                    // Update UI to show no plan
                    updateSidebarFinancialStatus({
                        hasActiveSubscription: false,
                        planName: null,
                        planObject: null
                    });
                    
                } else {
                    throw new Error(result.message || 'Erro desconhecido');
                }
                
            } catch (error) {
                console.error('Error removing plan:', error);
                showToast(`‚ùå Erro ao remover plano: ${error.message}`, 'error');
            }
        }

        // Function to close edit plan modal
        function closeEditPlanModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.style.opacity = '0';
                const modalContent = modal.querySelector('.edit-plan-modal');
                modalContent.style.transform = 'translateY(20px) scale(0.95)';
                
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
            
            // Clean up global variables
            window.currentEditingSubscription = null;
            window.selectedNewPlanId = null;
        }

        // Function to force refresh plan data - DEBUG
        async function forceRefreshPlanData() {
            console.log('üîÑ [FORCE REFRESH] Recarregando dados do plano...');
            try {
                // Reload both plan sections
                await loadStudentCurrentPlan(currentEditingStudentId);
                await loadPlansTabContent(currentEditingStudentId);
                showToast('üîÑ Dados recarregados', 'info');
            } catch (error) {
                console.error('‚ùå [FORCE REFRESH] Erro:', error);
                showToast('‚ùå Erro ao recarregar dados', 'error');
            }
        }

        // Function to view plan history
        function viewPlanHistory() {
            showToast('üìä Funcionalidade de hist√≥rico ser√° implementada em breve', 'info');
            console.log('üìä Plan history requested for student:', currentEditingStudentId);
        }

        // ========== CLASSES/TURMAS FUNCTIONS ==========

        // Function to handle class transfer actions
        function transferClassActions() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div class="transfer-modal" style="
                    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
                    border-radius: 20px;
                    width: 90%;
                    max-width: 600px;
                    max-height: 90vh;
                    overflow-y: auto;
                    border: 1px solid #334155;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
                    transform: translateY(20px) scale(0.95);
                    transition: all 0.3s ease;
                ">
                    <!-- Header -->
                    <div style="padding: 2rem 2rem 1rem 2rem; border-bottom: 1px solid #334155;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="color: #F8FAFC; margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700;">üîÑ Transferir de Turma</h2>
                                <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">Mover aluno para outra turma dispon√≠vel</p>
                            </div>
                            <button onclick="closeTransferModal()" style="
                                background: rgba(239, 68, 68, 0.1);
                                border: 1px solid rgba(239, 68, 68, 0.3);
                                color: #EF4444;
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 1.2rem;
                                transition: all 0.2s;
                            ">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding: 2rem;">
                        <!-- Current Class -->
                        <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #3B82F6; margin: 0 0 1rem 0; font-size: 1.1rem;">üìç Turma Atual</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem;">TURMA</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Turma 1 - Manh√£</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem;">HOR√ÅRIO</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Ter/Qui 08:00</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.75rem;">INSTRUTOR</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Prof. Silva</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Available Classes -->
                        <h3 style="color: #F8FAFC; margin: 0 0 1rem 0; font-size: 1.1rem;">üéØ Turmas Dispon√≠veis</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div class="transfer-option" onclick="selectTransferClass('class2')" style="
                                background: rgba(139, 92, 246, 0.05);
                                border: 1px solid rgba(139, 92, 246, 0.2);
                                border-radius: 12px;
                                padding: 1.5rem;
                                cursor: pointer;
                                transition: all 0.2s;
                            " onmouseover="this.style.borderColor='#8B5CF6'" onmouseout="this.style.borderColor='rgba(139, 92, 246, 0.2)'">
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center;">
                                    <div>
                                        <div style="color: #A855F7; font-weight: 600; margin-bottom: 0.5rem;">Turma 2 - Noite</div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem;">
                                            <div>
                                                <span style="color: #94A3B8; font-size: 0.75rem;">HOR√ÅRIO:</span>
                                                <span style="color: #CBD5E1; font-size: 0.875rem; margin-left: 0.25rem;">Seg/Qua 19:00</span>
                                            </div>
                                            <div>
                                                <span style="color: #94A3B8; font-size: 0.75rem;">INSTRUTOR:</span>
                                                <span style="color: #CBD5E1; font-size: 0.875rem; margin-left: 0.25rem;">Prof. Costa</span>
                                            </div>
                                            <div>
                                                <span style="color: #94A3B8; font-size: 0.75rem;">VAGAS:</span>
                                                <span style="color: #10B981; font-size: 0.875rem; margin-left: 0.25rem;">8 livres</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="background: rgba(139, 92, 246, 0.1); color: #A855F7; padding: 0.75rem; border-radius: 8px; font-weight: 600;">
                                        üîÑ Transferir
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                            <button onclick="closeTransferModal()" style="
                                background: rgba(107, 114, 128, 0.1);
                                border: 1px solid #6B7280;
                                color: #9CA3AF;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                                transition: all 0.2s;
                            ">
                                Cancelar
                            </button>
                            <button id="confirmTransferBtn" onclick="confirmClassTransfer()" disabled style="
                                background: linear-gradient(135deg, #3B82F6, #1D4ED8);
                                border: none;
                                color: white;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: not-allowed;
                                font-weight: 600;
                                opacity: 0.5;
                                transition: all 0.2s;
                            ">
                                Confirmar Transfer√™ncia
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Animate modal in
            setTimeout(() => {
                modal.style.opacity = '1';
                const modalContent = modal.querySelector('.transfer-modal');
                modalContent.style.transform = 'translateY(0) scale(1)';
            }, 50);
        }

        // Function to close transfer modal
        function closeTransferModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.style.opacity = '0';
                const modalContent = modal.querySelector('.transfer-modal');
                modalContent.style.transform = 'translateY(20px) scale(0.95)';
                
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // Function to select transfer class
        function selectTransferClass(classId) {
            // Clear previous selections
            document.querySelectorAll('.transfer-option').forEach(option => {
                option.style.borderColor = 'rgba(139, 92, 246, 0.2)';
                option.style.background = 'rgba(139, 92, 246, 0.05)';
            });
            
            // Highlight selected option
            const selectedOption = document.querySelector(`[onclick="selectTransferClass('${classId}')"]`);
            if (selectedOption) {
                selectedOption.style.borderColor = '#10B981';
                selectedOption.style.background = 'rgba(16, 185, 129, 0.1)';
            }
            
            // Enable confirm button
            const confirmBtn = document.getElementById('confirmTransferBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.style.cursor = 'pointer';
                confirmBtn.style.opacity = '1';
            }
            
            // Store selected class
            window.selectedTransferClass = classId;
        }

        // Function to confirm class transfer
        function confirmClassTransfer() {
            if (!window.selectedTransferClass) {
                showToast('‚ùå Selecione uma turma para transferir', 'error');
                return;
            }
            
            showToast('üîÑ Transferindo aluno...', 'info');
            
            // Simulate transfer process
            setTimeout(() => {
                showToast('‚úÖ Aluno transferido com sucesso para Turma 2!', 'success');
                closeTransferModal();
                
                // Reload classes tab
                loadClassesTabContent();
            }, 2000);
        }

        // Function to handle pause class actions
        function pauseClassActions() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
                    border-radius: 20px;
                    width: 90%;
                    max-width: 500px;
                    border: 1px solid #334155;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
                    transform: translateY(20px) scale(0.95);
                    transition: all 0.3s ease;
                ">
                    <div style="padding: 2rem;">
                        <h2 style="color: #F59E0B; margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                            ‚è∏Ô∏è Pausar Temporariamente
                        </h2>
                        <p style="color: #94A3B8; margin: 0 0 2rem 0; font-size: 0.875rem;">
                            Suspender temporariamente as aulas do aluno. Escolha o per√≠odo de pausa:
                        </p>
                        
                        <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                            <div onclick="selectPausePeriod('1week')" class="pause-option" style="
                                background: rgba(245, 158, 11, 0.05);
                                border: 1px solid rgba(245, 158, 11, 0.2);
                                border-radius: 8px;
                                padding: 1rem;
                                cursor: pointer;
                                transition: all 0.2s;
                            ">
                                <div style="color: #F59E0B; font-weight: 600;">üìÖ 1 Semana</div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">Pausa at√© ${new Date(Date.now() + 7*24*60*60*1000).toLocaleDateString()}</div>
                            </div>
                            
                            <div onclick="selectPausePeriod('1month')" class="pause-option" style="
                                background: rgba(245, 158, 11, 0.05);
                                border: 1px solid rgba(245, 158, 11, 0.2);
                                border-radius: 8px;
                                padding: 1rem;
                                cursor: pointer;
                                transition: all 0.2s;
                            ">
                                <div style="color: #F59E0B; font-weight: 600;">üìÖ 1 M√™s</div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">Pausa at√© ${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString()}</div>
                            </div>
                            
                            <div onclick="selectPausePeriod('custom')" class="pause-option" style="
                                background: rgba(245, 158, 11, 0.05);
                                border: 1px solid rgba(245, 158, 11, 0.2);
                                border-radius: 8px;
                                padding: 1rem;
                                cursor: pointer;
                                transition: all 0.2s;
                            ">
                                <div style="color: #F59E0B; font-weight: 600;">üìÖ Data Personalizada</div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">Escolher data espec√≠fica</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="closePauseModal()" style="
                                background: rgba(107, 114, 128, 0.1);
                                border: 1px solid #6B7280;
                                color: #9CA3AF;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                            ">
                                Cancelar
                            </button>
                            <button id="confirmPauseBtn" onclick="confirmPause()" disabled style="
                                background: linear-gradient(135deg, #F59E0B, #D97706);
                                border: none;
                                color: white;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: not-allowed;
                                font-weight: 600;
                                opacity: 0.5;
                            ">
                                Confirmar Pausa
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.querySelector('div').style.transform = 'translateY(0) scale(1)';
            }, 50);
        }

        // Function to close pause modal
        function closePauseModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // Function to select pause period
        function selectPausePeriod(period) {
            document.querySelectorAll('.pause-option').forEach(option => {
                option.style.borderColor = 'rgba(245, 158, 11, 0.2)';
                option.style.background = 'rgba(245, 158, 11, 0.05)';
            });
            
            event.target.closest('.pause-option').style.borderColor = '#10B981';
            event.target.closest('.pause-option').style.background = 'rgba(16, 185, 129, 0.1)';
            
            const confirmBtn = document.getElementById('confirmPauseBtn');
            confirmBtn.disabled = false;
            confirmBtn.style.cursor = 'pointer';
            confirmBtn.style.opacity = '1';
            
            window.selectedPausePeriod = period;
        }

        // Function to confirm pause
        function confirmPause() {
            if (!window.selectedPausePeriod) return;
            
            showToast('‚è∏Ô∏è Pausando aulas do aluno...', 'info');
            
            setTimeout(() => {
                const periodText = window.selectedPausePeriod === '1week' ? '1 semana' : 
                                 window.selectedPausePeriod === '1month' ? '1 m√™s' : 'per√≠odo personalizado';
                showToast(`‚úÖ Aulas pausadas por ${periodText}`, 'success');
                closePauseModal();
            }, 1500);
        }

        // Function to handle add class actions
        function addClassActions() {
            showToast('‚ûï Adicionando turma extra...', 'info');
            
            setTimeout(() => {
                showToast('‚úÖ Turma extra adicionada! O aluno pode participar de aulas de reposi√ß√£o.', 'success');
                
                // Reload classes tab to show changes
                loadClassesTabContent();
            }, 2000);
        }

        // Functions for Create Class Modal
        function closeCreateClassModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.style.opacity = '0';
                const modalContent = modal.querySelector('.create-class-modal');
                modalContent.style.transform = 'translateY(20px) scale(0.95)';
                
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        function submitCreateClass() {
            const form = document.getElementById('createClassForm');
            const formData = new FormData(form);
            
            // Validate required fields
            const courseSelect = document.getElementById('courseSelect');
            const className = document.getElementById('className');
            const classCapacity = document.getElementById('classCapacity');
            const startTime = document.getElementById('startTime');
            const classDuration = document.getElementById('classDuration');
            const instructorSelect = document.getElementById('instructorSelect');
            const startDate = document.getElementById('startDate');
            
            if (!courseSelect.value) {
                showToast('‚ùå Selecione um curso base', 'error');
                courseSelect.focus();
                return;
            }
            
            if (!className.value.trim()) {
                showToast('‚ùå Digite o nome da turma', 'error');
                className.focus();
                return;
            }
            
            if (!classCapacity.value || classCapacity.value < 5) {
                showToast('‚ùå Capacidade m√≠nima √© 5 alunos', 'error');
                classCapacity.focus();
                return;
            }
            
            if (!instructorSelect.value) {
                showToast('‚ùå Selecione um instrutor', 'error');
                instructorSelect.focus();
                return;
            }
            
            if (!startDate.value) {
                showToast('‚ùå Selecione a data de in√≠cio', 'error');
                startDate.focus();
                return;
            }
            
            // Check if at least one day is selected
            const selectedDays = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            if (selectedDays.length === 0) {
                showToast('‚ùå Selecione pelo menos um dia da semana', 'error');
                return;
            }
            
            // Collect all form data
            const classData = {
                course: courseSelect.value,
                name: className.value.trim(),
                capacity: parseInt(classCapacity.value),
                startTime: startTime.value,
                duration: parseInt(classDuration.value),
                instructor: instructorSelect.value,
                startDate: startDate.value,
                selectedDays: selectedDays,
                notes: document.getElementById('classNotes').value.trim()
            };
            
            // Show loading state
            const submitBtn = document.querySelector('button[onclick="submitCreateClass()"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'üîÑ Criando...';
            submitBtn.disabled = true;
            
            showToast('üîÑ Criando nova turma...', 'info');
            
            // Real API call
            fetch('/api/classes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(classData)
            })
            .then(response => response.json())
            .then(result => {
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                if (result.success) {
                    // Show success message
                    showToast(`‚úÖ Turma "${classData.name}" criada com sucesso!`, 'success');
                    
                    console.log('üìù Nova turma criada:', result.data);
                    
                    // Close modal
                    closeCreateClassModal();
                    
                    // Reload classes page if we're on it
                    if (window.location.hash === '#classes' || document.querySelector('.nav-item.active')?.textContent?.includes('Classes')) {
                        setTimeout(() => {
                            location.reload(); // Reload to show new class
                        }, 1000);
                    }
                } else {
                    throw new Error(result.message || 'Failed to create class');
                }
            })
            .catch(error => {
                console.error('‚ùå Error creating class:', error);
                
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                // Show error message
                showToast(`‚ùå Erro ao criar turma: ${error.message}`, 'error');
            });
        }

        // Function to assign plan when student has none
        function assignStudentPlan() {
            showToast('Selecione um plano dispon√≠vel abaixo para atribuir ao aluno', 'info');
        }

        // Classes Tab
        function loadClassesTabContent() {
            const classesTab = document.getElementById('classesContent');
            classesTab.innerHTML = `
                <!-- Current Classes -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #10B981; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        üïê Turmas Ativas
                        <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                            2 TURMAS
                        </div>
                    </h4>
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div style="color: #60A5FA; font-weight: 600;">Turma 1 - Manh√£</div>
                                <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                                    PRINCIPAL
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.875rem;">Hor√°rio</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Ter/Qui 08:00</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.875rem;">Instrutor</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Prof. Silva</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.875rem;">Alunos</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">15/20</div>
                                </div>
                            </div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div style="color: #C4B5FD; font-weight: 600;">Turma 2 - Noite</div>
                                <div style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; border: 1px solid rgba(245, 158, 11, 0.3);">
                                    SECUND√ÅRIA
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.875rem;">Hor√°rio</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Seg/Qua 19:00</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.875rem;">Instrutor</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">Prof. Costa</div>
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 0.875rem;">Alunos</div>
                                    <div style="color: #F8FAFC; font-weight: 600;">12/20</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule View -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">üìÖ Cronograma Semanal</h4>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">DOM</div>
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">SEG</div>
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">TER</div>
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">QUA</div>
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">QUI</div>
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">SEX</div>
                        <div style="text-align: center; padding: 0.5rem; color: #94A3B8; font-weight: 600; font-size: 0.875rem;">S√ÅB</div>
                        
                        <div style="text-align: center; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px;">-</div>
                        <div style="text-align: center; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="color: #C4B5FD; font-size: 0.75rem;">19:00</div>
                            <div style="color: #F8FAFC; font-size: 0.75rem; font-weight: 600;">T2</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="color: #60A5FA; font-size: 0.75rem;">08:00</div>
                            <div style="color: #F8FAFC; font-size: 0.75rem; font-weight: 600;">T1</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="color: #C4B5FD; font-size: 0.75rem;">19:00</div>
                            <div style="color: #F8FAFC; font-size: 0.75rem; font-weight: 600;">T2</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="color: #60A5FA; font-size: 0.75rem;">08:00</div>
                            <div style="color: #F8FAFC; font-size: 0.75rem; font-weight: 600;">T1</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px;">-</div>
                        <div style="text-align: center; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px;">-</div>
                    </div>
                </div>

                <!-- Class Actions -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                    <h4 style="color: #F59E0B; margin: 0 0 1rem 0;">‚ö° A√ß√µes de Turma</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <button onclick="transferClassActions()" style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üîÑ Transferir Turma
                        </button>
                        <button onclick="pauseClassActions()" style="background: rgba(245, 158, 11, 0.1); border: 1px solid #F59E0B; color: #F59E0B; padding: 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ‚è∏Ô∏è Pausar Temporariamente
                        </button>
                        <button onclick="addClassActions()" style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10B981; color: #10B981; padding: 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ‚ûï Adicionar Turma Extra
                        </button>
                    </div>
                </div>
            `;
        }

        // Courses Tab
        function loadCoursesTabContent() {
            const coursesTab = document.getElementById('coursesContent');
            coursesTab.innerHTML = `
                <!-- Current Course -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #10B981; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        üìö Curso Atual
                        <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                            EM PROGRESSO
                        </div>
                    </h4>
                    <div style="background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 1.5rem; border: 1px solid #475569;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h5 style="color: #F8FAFC; margin: 0; font-size: 1.125rem;">Krav Maga Faixa Branca - Defesa Pessoal 1</h5>
                            <div style="color: #10B981; font-weight: 600;">31% completo</div>
                        </div>
                        <div style="background: #1E293B; border-radius: 6px; height: 8px; width: 100%; overflow: hidden; margin-bottom: 1rem;">
                            <div style="background: linear-gradient(90deg, #10B981, #059669); height: 100%; width: 31%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">Aula Atual</div>
                                <div style="color: #F8FAFC; font-weight: 600;">15 de 48</div>
                            </div>
                            <div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">T√©cnicas Aprendidas</div>
                                <div style="color: #F8FAFC; font-weight: 600;">13 de 42</div>
                            </div>
                            <div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">In√≠cio</div>
                                <div style="color: #F8FAFC; font-weight: 600;">01/06/2025</div>
                            </div>
                            <div>
                                <div style="color: #94A3B8; font-size: 0.875rem;">Previs√£o Conclus√£o</div>
                                <div style="color: #F8FAFC; font-weight: 600;">15/12/2025</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Course Modules -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; margin-bottom: 2rem;">
                    <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">üìñ M√≥dulos do Curso</h4>
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="color: #6EE7B7; font-weight: 600;">‚úÖ M√≥dulo 1: Fundamentos</div>
                                <div style="background: rgba(16, 185, 129, 0.2); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem;">
                                    COMPLETO
                                </div>
                            </div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">Postura, dist√¢ncia, movimenta√ß√£o b√°sica ‚Ä¢ 8 aulas</div>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="color: #60A5FA; font-weight: 600;">üîÑ M√≥dulo 2: Golpes B√°sicos</div>
                                <div style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem;">
                                    EM PROGRESSO
                                </div>
                            </div>
                            <div style="color: #CBD5E1; font-size: 0.875rem;">Socos, chutes, joelhadas e cotoveladas ‚Ä¢ 7 de 12 aulas</div>
                        </div>
                        <div style="background: rgba(71, 85, 105, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(71, 85, 105, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="color: #94A3B8; font-weight: 600;">‚è≥ M√≥dulo 3: Defesas B√°sicas</div>
                                <div style="background: rgba(71, 85, 105, 0.2); color: #94A3B8; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem;">
                                    PENDENTE
                                </div>
                            </div>
                            <div style="color: #64748B; font-size: 0.875rem;">Defesas contra socos e agarr√µes ‚Ä¢ 12 aulas</div>
                        </div>
                        <div style="background: rgba(71, 85, 105, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(71, 85, 105, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="color: #94A3B8; font-weight: 600;">‚è≥ M√≥dulo 4: T√©cnicas Avan√ßadas</div>
                                <div style="background: rgba(71, 85, 105, 0.2); color: #94A3B8; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem;">
                                    PENDENTE
                                </div>
                            </div>
                            <div style="color: #64748B; font-size: 0.875rem;">Defesas no solo e m√∫ltiplos atacantes ‚Ä¢ 10 aulas</div>
                        </div>
                        <div style="background: rgba(71, 85, 105, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(71, 85, 105, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="color: #94A3B8; font-weight: 600;">‚è≥ M√≥dulo 5: Integra√ß√£o e Sparring</div>
                                <div style="background: rgba(71, 85, 105, 0.2); color: #94A3B8; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem;">
                                    PENDENTE
                                </div>
                            </div>
                            <div style="color: #64748B; font-size: 0.875rem;">Aplica√ß√£o pr√°tica e simula√ß√µes ‚Ä¢ 8 aulas</div>
                        </div>
                    </div>
                </div>

                <!-- Available Courses -->
                <div style="background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #334155;">
                    <h4 style="color: #F59E0B; margin: 0 0 1rem 0;">üéØ Pr√≥ximos Cursos Dispon√≠veis</h4>
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="color: #C4B5FD; font-weight: 600; margin-bottom: 0.5rem;">ü•ã Krav Maga Faixa Amarela - Defesa Pessoal 2</div>
                            <div style="color: #CBD5E1; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                T√©cnicas avan√ßadas, defesa contra armas brancas, m√∫ltiplos atacantes
                            </div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">
                                Prerequisito: Completar Faixa Branca ‚Ä¢ Dura√ß√£o: 6 meses
                            </div>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); border-radius: 8px; padding: 1rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <div style="color: #FCD34D; font-weight: 600; margin-bottom: 0.5rem;">üèÜ Curso de Instrutor Assistente</div>
                            <div style="color: #CBD5E1; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                Metodologia de ensino, gest√£o de turma, primeiros socorros
                            </div>
                            <div style="color: #94A3B8; font-size: 0.75rem;">
                                Prerequisito: Faixa Amarela ‚Ä¢ Dura√ß√£o: 3 meses
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Financial tab placeholder
        function loadFinancialTabContent() {
            const financialTab = document.getElementById('page-tab-financial');
            financialTab.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #94A3B8;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üí∞</div>
                    <h3 style="color: #F8FAFC; margin-bottom: 0.5rem;">Financeiro em Desenvolvimento</h3>
                    <p>Esta funcionalidade ser√° implementada em breve.</p>
                </div>
            `;
        }

        // Activity tab placeholder
        function loadActivityTabContent() {
            const activityTab = document.getElementById('page-tab-activity');
            activityTab.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #94A3B8;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìà</div>
                    <h3 style="color: #F8FAFC; margin-bottom: 0.5rem;">Atividades em Desenvolvimento</h3>
                    <p>Esta funcionalidade ser√° implementada em breve.</p>
                </div>
            `;
        }


        // Back to students list
        function backToStudentsList() {
            document.getElementById('student-edit-page').style.display = 'none';
            document.getElementById('students').style.display = 'block';
            
            currentEditingStudentId = null;
            currentEditingStudent = null;
        }

        // Cancel student edit
        function cancelStudentEdit() {
            if (confirm('Tem certeza que deseja cancelar? Todas as altera√ß√µes n√£o salvas ser√£o perdidas.')) {
                backToStudentsList();
            }
        }

        // Save student from page
        async function saveStudentPage() {
            if (!currentEditingStudentId) {
                showNotification('Erro: ID do aluno n√£o encontrado', 'error');
                return;
            }

            const saveBtn = document.querySelector('button[onclick="saveStudentPage()"]');
            const originalText = saveBtn.innerHTML;
            
            try {
                // Show loading state
                saveBtn.innerHTML = '‚è≥ Salvando...';
                saveBtn.disabled = true;
                
                // Collect form data
                const formData = {
                    firstName: document.getElementById('pageFirstName').value.trim(),
                    lastName: document.getElementById('pageLastName').value.trim(),
                    email: document.getElementById('pageEmail').value.trim(),
                    phone: document.getElementById('pagePhone').value.trim(),
                    category: document.getElementById('pageCategory').value,
                    gender: document.getElementById('pageGender').value,
                    physicalCondition: document.getElementById('pagePhysicalCondition').value,
                    emergencyContact: document.getElementById('pageEmergencyContact').value.trim(),
                    medicalConditions: document.getElementById('pageMedicalConditions').value.trim(),
                    isActive: true
                };
                
                // Enhanced validation
                if (!formData.firstName || !formData.lastName || !formData.email) {
                    throw new Error('Nome, sobrenome e email s√£o obrigat√≥rios');
                }
                
                if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
                    throw new Error('Email deve ter um formato v√°lido');
                }
                
                console.log('üì§ Enviando dados do estudante:', formData);
                
                // Update student via API
                const response = await fetch(`/api/students/${currentEditingStudentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || `Erro ${response.status}: ${response.statusText}`);
                }
                
                if (!result.success) {
                    throw new Error(result.message || 'Erro ao atualizar dados');
                }
                
                console.log('‚úÖ Estudante atualizado com sucesso:', result);
                
                // Show success feedback
                saveBtn.innerHTML = '‚úÖ Salvo!';
                saveBtn.style.background = '#10B981';
                
                // Update header with new data
                updateEditPageHeader({
                    id: currentEditingStudentId,
                    category: formData.category,
                    user: {
                        firstName: formData.firstName,
                        lastName: formData.lastName
                    }
                });
                
                // Go back to students list after success
                setTimeout(() => {
                    backToStudentsList();
                    loadStudents(); // Reload students to show updated data
                    showNotification('Dados do aluno atualizados com sucesso! üéâ', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar estudante:', error);
                
                // Show error feedback
                saveBtn.innerHTML = '‚ùå Erro';
                saveBtn.style.background = '#EF4444';
                
                showNotification(`Erro ao salvar: ${error.message}`, 'error');
                
                // Restore button after error
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }, 2000);
            }
        }

        // Quick actions from edit page
        function quickCheckinFromEdit() {
            showNotification('Check-in r√°pido em desenvolvimento', 'info');
        }

        function viewStudentProgress() {
            switchPageTab('progress');
        }

        function managePayments() {
            switchPageTab('financial');
        }

        // Update the existing openStudentEdit function to use the dedicated page
        async function openStudentEdit(studentId) {
            console.log('‚úèÔ∏è Redirecionando para p√°gina de edi√ß√£o:', studentId);
            await openStudentEditPage(studentId);
        }

        // ==========================================
        // UNIFIED STUDENT INTERACTION SYSTEM
        // ==========================================

        // Central function for all student interactions
        function handleStudentInteraction(studentId, action, event = null) {
            switch (action) {
                case 'view':
                    openStudentDetails(studentId);
                    break;
                case 'edit':
                    openStudentEditPage(studentId);
                    break;
                case 'doubleclick':
                    if (event) {
                        handleStudentDoubleClick(event, studentId);
                    } else {
                        openStudentEditPage(studentId);
                    }
                    break;
                case 'checkin':
                    quickCheckin(studentId);
                    break;
                default:
                    console.warn('A√ß√£o n√£o reconhecida:', action);
                    openStudentDetails(studentId);
            }
        }

        // Enhanced function to handle all edit actions consistently
        function openStudentEditAction(studentId) {
            console.log('üéØ A√ß√£o unificada de edi√ß√£o para aluno:', studentId);
            openStudentEditPage(studentId);
        }

        // ==========================================
        // CLEAN UX - SIMPLIFIED STUDENT INTERACTION
        // ==========================================

        // Unified clean function - ONE action for everything
        function openStudentEditor(studentId) {
            console.log('üöÄ UX Limpa: Abrindo editor de aluno:', studentId);
            showNotification('üìù Carregando editor...', 'info');
            openStudentEditPage(studentId);
        }

        // Redirect old functions to new clean UX
        function openStudentDetails(studentId) {
            console.log('üîÑ Redirecionando visualiza√ß√£o para edi√ß√£o direta:', studentId);
            openStudentEditPage(studentId);
        }

        // Simplified student interaction - No more double click complexity
        function handleStudentClick(studentId) {
            console.log('üéØ UX Limpa: Abrindo editor direto para aluno:', studentId);
            showNotification('üìù Carregando editor de aluno...', 'info');
            openStudentEditPage(studentId);
        }

        // Add visual feedback for double click
        function addDoubleClickFeedback(event) {
            const card = event.currentTarget;
            
            // Create ripple effect
            const ripple = document.createElement('div');
            ripple.style.cssText = `
                position: absolute;
                width: 100px;
                height: 100px;
                background: radial-gradient(circle, rgba(59, 130, 246, 0.6) 0%, transparent 70%);
                border-radius: 50%;
                transform: translate(-50%, -50%) scale(0);
                pointer-events: none;
                animation: ripple 0.6s ease-out;
                left: ${event.offsetX}px;
                top: ${event.offsetY}px;
                z-index: 10;
            `;
            
            card.style.position = 'relative';
            card.appendChild(ripple);
            
            // Remove ripple after animation
            setTimeout(() => {
                if (card.contains(ripple)) {
                    card.removeChild(ripple);
                }
            }, 600);
        }

        // Add ripple animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes ripple {
                0% {
                    transform: translate(-50%, -50%) scale(0);
                    opacity: 1;
                }
                100% {
                    transform: translate(-50%, -50%) scale(4);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // ==========================================
        // INFRASTRUCTURE MANAGEMENT FUNCTIONS
        // ==========================================

        // Global variables for infrastructure data
        let allUnits = [];
        let allMats = [];
        let allInstructors = [];

        // ==========================================
        // SISTEMA DE ASSOCIA√á√ïES HIER√ÅRQUICAS
        // ==========================================
        
        async function loadStudentWithAssociations(studentId) {
            console.log('üîÑ Carregando aluno com associa√ß√µes:', studentId);
            
            try {
                // Buscar dados do aluno, matr√≠culas e assinaturas em paralelo
                const [studentResponse, enrollmentsResponse, subscriptionsResponse] = await Promise.all([
                    fetch(`/api/students/${studentId}`),
                    fetch(`/api/students/${studentId}/enrollments`),
                    fetch(`/api/students/${studentId}/subscriptions`)
                ]);
                
                const studentData = await studentResponse.json();
                const enrollmentsData = await enrollmentsResponse.json();
                const subscriptionsData = await subscriptionsResponse.json();
                
                if (!studentData.success) {
                    throw new Error(studentData.message || 'Erro ao carregar dados do aluno');
                }
                
                // Buscar dados complementares
                const [classesResponse, coursesResponse, plansResponse] = await Promise.all([
                    fetch('/api/classes'),
                    fetch('/api/courses'),
                    fetch('/api/billing-plans')
                ]);
                
                const classesData = await classesResponse.json();
                const coursesData = await coursesResponse.json();
                const plansData = await plansResponse.json();
                
                // Processar associa√ß√µes
                const associations = processStudentAssociations(
                    studentData.data,
                    enrollmentsData.success ? enrollmentsData.data : [],
                    subscriptionsData.success ? subscriptionsData.data : [],
                    classesData.success ? classesData.data : [],
                    coursesData.success ? coursesData.data : [],
                    plansData.success ? plansData.data : []
                );
                
                console.log('‚úÖ Associa√ß√µes processadas:', associations);
                
                return {
                    student: studentData.data,
                    associations: associations
                };
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar aluno com associa√ß√µes:', error);
                return null;
            }
        }
        
        function processStudentAssociations(student, enrollments, subscriptions, allClasses, allCourses, allPlans) {
            console.log('üîÑ Processando associa√ß√µes do aluno...');
            
            const associations = {
                plans: [],
                courses: [],
                classes: [],
                hierarchy: []
            };
            
            // Processar assinaturas de planos
            subscriptions.forEach(subscription => {
                if (subscription.plan || subscription.billingPlan) {
                    const plan = subscription.plan || subscription.billingPlan;
                    associations.plans.push({
                        subscription: subscription,
                        plan: plan
                    });
                }
            });
            
            // Processar matr√≠culas
            enrollments.forEach(enrollment => {
                if (enrollment.course) {
                    associations.courses.push({
                        enrollment: enrollment,
                        course: enrollment.course
                    });
                }
                
                if (enrollment.class) {
                    associations.classes.push({
                        enrollment: enrollment,
                        class: enrollment.class
                    });
                }
            });
            
            // Criar hierarquia
            associations.plans.forEach(planAssoc => {
                const planHierarchy = {
                    plan: planAssoc.plan,
                    subscription: planAssoc.subscription,
                    courses: [],
                    directClasses: []
                };
                
                // Encontrar cursos relacionados ao plano
                associations.courses.forEach(courseAssoc => {
                    const course = courseAssoc.course;
                    if (course.category === planAssoc.plan.category || 
                        course.level === planAssoc.plan.level ||
                        course.planId === planAssoc.plan.id ||
                        course.id === planAssoc.plan.courseId) {
                        
                        const courseInPlan = {
                            course: course,
                            enrollment: courseAssoc.enrollment,
                            classes: []
                        };
                        
                        // Encontrar turmas do curso
                        associations.classes.forEach(classAssoc => {
                            if (classAssoc.class.courseId === course.id) {
                                courseInPlan.classes.push({
                                    class: classAssoc.class,
                                    enrollment: classAssoc.enrollment
                                });
                            }
                        });
                        
                        planHierarchy.courses.push(courseInPlan);
                    }
                });
                
                // Verificar se o plano tem um courseId direto que ainda n√£o foi adicionado
                if (planAssoc.plan.courseId && allCourses && allCourses.length > 0) {
                    const planCourse = allCourses.find(course => course.id === planAssoc.plan.courseId);
                    if (planCourse) {
                        // Verificar se o curso j√° foi adicionado
                        const courseAlreadyAdded = planHierarchy.courses.some(courseInPlan => 
                            courseInPlan.course.id === planCourse.id
                        );
                        
                        if (!courseAlreadyAdded) {
                            console.log('üéì Adicionando curso direto do plano:', planCourse.name);
                            const courseInPlan = {
                                course: planCourse,
                                enrollment: null, // Sem matr√≠cula ainda
                                classes: []
                            };
                            
                            // Encontrar turmas do curso
                            associations.classes.forEach(classAssoc => {
                                if (classAssoc.class.courseId === planCourse.id) {
                                    courseInPlan.classes.push({
                                        class: classAssoc.class,
                                        enrollment: classAssoc.enrollment
                                    });
                                }
                            });
                            
                            planHierarchy.courses.push(courseInPlan);
                        }
                    }
                }
                
                // Encontrar turmas diretas do plano (sem curso)
                associations.classes.forEach(classAssoc => {
                    const isInCourse = planHierarchy.courses.some(courseInPlan => 
                        courseInPlan.classes.some(c => c.class.id === classAssoc.class.id)
                    );
                    
                    if (!isInCourse && (
                        classAssoc.class.category === planAssoc.plan.category || 
                        classAssoc.class.level === planAssoc.plan.level ||
                        classAssoc.class.planId === planAssoc.plan.id
                    )) {
                        planHierarchy.directClasses.push({
                            class: classAssoc.class,
                            enrollment: classAssoc.enrollment
                        });
                    }
                });
                
                associations.hierarchy.push(planHierarchy);
            });
            
            // Se n√£o h√° planos, criar uma estrutura b√°sica
            if (associations.hierarchy.length === 0 && (associations.courses.length > 0 || associations.classes.length > 0)) {
                associations.hierarchy.push({
                    plan: { name: 'Sem Plano Definido', category: 'Geral' },
                    subscription: null,
                    courses: associations.courses.map(courseAssoc => ({
                        course: courseAssoc.course,
                        enrollment: courseAssoc.enrollment,
                        classes: associations.classes.filter(classAssoc => 
                            classAssoc.class.courseId === courseAssoc.course.id
                        )
                    })),
                    directClasses: associations.classes.filter(classAssoc => 
                        !associations.courses.some(courseAssoc => 
                            courseAssoc.course.id === classAssoc.class.courseId
                        )
                    )
                });
            }
            
            console.log('‚úÖ Associa√ß√µes processadas:', associations);
            return associations;
        }
        
        function renderStudentClassesWithHierarchy(associations) {
            console.log('üé® Renderizando turmas com hierarquia...');
            
            const classesTab = document.getElementById('student-classes-content');
            if (!classesTab) {
                console.error('‚ùå Elemento student-classes-content n√£o encontrado');
                return;
            }
            
            if (!associations || associations.hierarchy.length === 0) {
                classesTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
                        <p>Nenhuma turma encontrada para este aluno</p>
                        <button onclick="loadStudentClassesTab()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üîÑ Recarregar
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 1.5rem; padding: 1rem;">';
            
            associations.hierarchy.forEach((planHierarchy, planIndex) => {
                const plan = planHierarchy.plan;
                const subscription = planHierarchy.subscription;
                
                // Contar total de turmas neste plano
                const totalClasses = planHierarchy.courses.reduce((total, course) => 
                    total + course.classes.length, 0
                ) + planHierarchy.directClasses.length;
                
                html += `
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05)); border: 1px solid #10B981; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(16, 185, 129, 0.3);">
                            <div>
                                <h4 style="color: #10B981; margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                                    üíé ${plan.name}
                                </h4>
                                <p style="color: #94A3B8; margin: 0.25rem 0; font-size: 0.9rem;">
                                    ${plan.price ? `R$ ${parseFloat(plan.price).toFixed(2)}/m√™s` : 'Pre√ßo n√£o definido'} ‚Ä¢ 
                                    ${plan.category || 'Categoria n√£o definida'} ‚Ä¢ 
                                    ${subscription ? subscription.status || 'Ativo' : 'Sem assinatura'}
                                </p>
                            </div>
                            <div style="text-align: right; color: #10B981; font-size: 0.8rem;">
                                <div style="font-weight: bold; font-size: 1.2rem;">${totalClasses}</div>
                                <div>turma(s)</div>
                            </div>
                        </div>
                `;
                
                // Renderizar cursos com suas turmas
                if (planHierarchy.courses.length > 0) {
                    planHierarchy.courses.forEach(courseInPlan => {
                        const course = courseInPlan.course;
                        
                        html += `
                            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <h5 style="color: #3B82F6; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    üìö ${course.name}
                                </h5>
                                <p style="color: #E5E7EB; margin: 0 0 1rem 0; font-size: 0.85rem;">
                                    ${course.description || 'Descri√ß√£o n√£o dispon√≠vel'}
                                </p>
                        `;
                        
                        // Renderizar turmas do curso
                        if (courseInPlan.classes.length > 0) {
                            courseInPlan.classes.forEach(classInCourse => {
                                const classData = classInCourse.class;
                                const enrollment = classInCourse.enrollment;
                                
                                html += `
                                    <div style="background: rgba(15, 23, 42, 0.7); border: 1px solid #475569; border-radius: 6px; padding: 0.75rem; margin: 0.5rem 0; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: #E5E7EB; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                                üïê ${classData.name}
                                            </div>
                                            <div style="color: #9CA3AF; font-size: 0.75rem; margin-top: 0.25rem;">
                                                üìÖ ${classData.schedule || 'Hor√°rio flex√≠vel'} ‚Ä¢ 
                                                üë• ${classData.capacity || 'Sem limite'} vagas ‚Ä¢ 
                                                Status: ${enrollment.status || 'Ativo'}
                                            </div>
                                            ${classData.description ? `<div style="color: #6B7280; font-size: 0.7rem; margin-top: 0.25rem;">${classData.description}</div>` : ''}
                                        </div>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button onclick="quickCheckinToClass('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #10B981; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                                ‚úì Check-in
                                            </button>
                                            <button onclick="viewClassDetails('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                                üëÅÔ∏è Detalhes
                                            </button>
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            html += `
                                <div style="color: #9CA3AF; font-style: italic; text-align: center; padding: 1rem; background: rgba(107, 114, 128, 0.1); border-radius: 6px;">
                                    üìñ Curso te√≥rico - sem turmas pr√°ticas associadas
                                </div>
                            `;
                        }
                        
                        html += '</div>';
                    });
                }
                
                // Renderizar turmas diretas do plano
                if (planHierarchy.directClasses.length > 0) {
                    html += `
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #F59E0B; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                            <h5 style="color: #F59E0B; margin: 0 0 0.75rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                üéØ Turmas Diretas do Plano
                            </h5>
                    `;
                    
                    planHierarchy.directClasses.forEach(directClass => {
                        const classData = directClass.class;
                        const enrollment = directClass.enrollment;
                        
                        html += `
                            <div style="background: rgba(15, 23, 42, 0.7); border: 1px solid #475569; border-radius: 6px; padding: 0.75rem; margin: 0.5rem 0; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #E5E7EB; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                        üïê ${classData.name}
                                    </div>
                                    <div style="color: #9CA3AF; font-size: 0.75rem; margin-top: 0.25rem;">
                                        üìÖ ${classData.schedule || 'Hor√°rio flex√≠vel'} ‚Ä¢ 
                                        üë• ${classData.capacity || 'Sem limite'} vagas ‚Ä¢ 
                                        Status: ${enrollment.status || 'Ativo'}
                                    </div>
                                    ${classData.description ? `<div style="color: #6B7280; font-size: 0.7rem; margin-top: 0.25rem;">${classData.description}</div>` : ''}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="quickCheckinToClass('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #10B981; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        ‚úì Check-in
                                    </button>
                                    <button onclick="viewClassDetails('${classData.id}')" style="padding: 0.25rem 0.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        üëÅÔ∏è Detalhes
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            classesTab.innerHTML = html;
            
            console.log('‚úÖ Turmas renderizadas com hierarquia');
        }
        
        function renderStudentCoursesWithHierarchy(associations) {
            console.log('üé® [MAIN] Renderizando cursos com hierarquia...');
            console.log('üîç [MAIN] Debug associations recebidas:', associations);
            
            const coursesTab = document.getElementById('student-courses-content');
            if (!coursesTab) {
                console.error('‚ùå Elemento student-courses-content n√£o encontrado');
                return;
            }
            
            if (!associations || associations.hierarchy.length === 0) {
                coursesTab.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6B7280;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìö</div>
                        <p>Nenhum curso encontrado para este aluno</p>
                        <button onclick="loadStudentCoursesTab()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üîÑ Recarregar
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 1.5rem; padding: 1rem;">';
            
            associations.hierarchy.forEach((planHierarchy, planIndex) => {
                const plan = planHierarchy.plan;
                const subscription = planHierarchy.subscription;
                
                console.log(`üîç Debug plano ${planIndex}:`, {
                    plan: plan.name,
                    coursesLength: planHierarchy.courses.length,
                    courses: planHierarchy.courses
                });
                
                if (planHierarchy.courses.length === 0) {
                    console.log(`‚ö†Ô∏è Plano ${plan.name} n√£o tem cursos, pulando...`);
                    return; // Pular planos sem cursos
                }
                
                html += `
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05)); border: 1px solid #10B981; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(16, 185, 129, 0.3);">
                            <div>
                                <h4 style="color: #10B981; margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                                    üíé ${plan.name}
                                </h4>
                                <p style="color: #94A3B8; margin: 0.25rem 0; font-size: 0.9rem;">
                                    ${plan.price ? `R$ ${parseFloat(plan.price).toFixed(2)}/m√™s` : 'Pre√ßo n√£o definido'} ‚Ä¢ 
                                    ${plan.category || 'Categoria n√£o definida'} ‚Ä¢ 
                                    ${subscription ? subscription.status || 'Ativo' : 'Sem assinatura'}
                                </p>
                            </div>
                            <div style="text-align: right; color: #10B981; font-size: 0.8rem;">
                                <div style="font-weight: bold; font-size: 1.2rem;">${planHierarchy.courses.length}</div>
                                <div>curso(s)</div>
                            </div>
                        </div>
                `;
                
                // Renderizar cursos
                planHierarchy.courses.forEach(courseInPlan => {
                    const course = courseInPlan.course;
                    const enrollment = courseInPlan.enrollment;
                    
                    html += `
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h5 style="color: #3B82F6; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                        üìö ${course.name}
                                    </h5>
                                    <p style="color: #E5E7EB; margin: 0 0 0.75rem 0; font-size: 0.85rem;">
                                        ${course.description || 'Descri√ß√£o n√£o dispon√≠vel'}
                                    </p>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; font-size: 0.75rem; color: #9CA3AF;">
                                        <div>üìä N√≠vel: ${course.level || 'N/A'}</div>
                                        <div>üè∑Ô∏è Categoria: ${course.category || 'N/A'}</div>
                                        <div>üìÖ Matr√≠cula: ${enrollment.enrolledAt ? new Date(enrollment.enrolledAt).toLocaleDateString('pt-BR') : 'N/A'}</div>
                                        <div>‚ö° Status: ${enrollment.status || 'Ativo'}</div>
                                    </div>
                                    ${courseInPlan.classes.length > 0 ? `
                                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(59, 130, 246, 0.3);">
                                            <div style="color: #3B82F6; font-size: 0.8rem; margin-bottom: 0.5rem; font-weight: 600;">
                                                üïê Turmas Associadas (${courseInPlan.classes.length})
                                            </div>
                                            <div style="display: grid; gap: 0.25rem;">
                                                ${courseInPlan.classes.map(classInCourse => `
                                                    <div style="background: rgba(15, 23, 42, 0.5); border-radius: 4px; padding: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                                        <span style="color: #E5E7EB; font-size: 0.75rem;">
                                                            ${classInCourse.class.name} ‚Ä¢ ${classInCourse.class.schedule || 'Hor√°rio flex√≠vel'}
                                                        </span>
                                                        <button onclick="quickCheckinToClass('${classInCourse.class.id}')" style="padding: 0.125rem 0.375rem; background: #10B981; color: white; border: none; border-radius: 3px; font-size: 0.625rem; cursor: pointer;">
                                                            ‚úì
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-left: 1rem;">
                                    <button onclick="viewCourseProgress('${course.id}')" style="padding: 0.5rem 0.75rem; background: #8B5CF6; color: white; border: none; border-radius: 6px; font-size: 0.75rem; cursor: pointer; white-space: nowrap;">
                                        üìà Progresso
                                    </button>
                                    <button onclick="viewCourseDetails('${course.id}')" style="padding: 0.5rem 0.75rem; background: #3B82F6; color: white; border: none; border-radius: 6px; font-size: 0.75rem; cursor: pointer; white-space: nowrap;">
                                        üëÅÔ∏è Detalhes
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            
            console.log('üîç HTML gerado:', html.substring(0, 200) + '...');
            console.log('üîç Element coursesTab:', coursesTab);
            
            coursesTab.innerHTML = html;
            
            // Debug: Force visibility
            coursesTab.style.display = 'block';
            coursesTab.style.visibility = 'visible';
            coursesTab.style.opacity = '1';
            
            // Debug: Check parent elements
            let parent = coursesTab.parentElement;
            while (parent) {
                console.log('üîç Parent element:', parent.tagName, parent.id, parent.style.display);
                if (parent.style.display === 'none' || parent.style.visibility === 'hidden') {
                    console.log('‚ùå Parent element is hidden!', parent);
                    if (parent.id === 'student-tab-courses') {
                        console.log('‚ö†Ô∏è A aba de assinatura n√£o est√° ativa! Clique na aba "üí≥ Assinatura" para ver o conte√∫do.');
                    }
                }
                parent = parent.parentElement;
                if (parent === document.body) break;
            }
            
            console.log('‚úÖ Cursos renderizados com hierarquia');
            console.log('üîç HTML final inserido no DOM:', coursesTab.innerHTML.substring(0, 200) + '...');
            console.log('üîç coursesTab styles:', {
                display: coursesTab.style.display,
                visibility: coursesTab.style.visibility,
                opacity: coursesTab.style.opacity
            });
        }

        // Fun√ß√µes de a√ß√£o para os bot√µes (placeholders)
        function quickCheckinToClass(classId) {
            console.log('üéØ Quick check-in para turma:', classId);
            alert(`üéØ Check-in r√°pido na turma ${classId}\n\n(Funcionalidade em desenvolvimento)`);
        }

        function viewClassDetails(classId) {
            console.log('üëÅÔ∏è Visualizar detalhes da turma:', classId);
            alert(`üëÅÔ∏è Detalhes da turma ${classId}\n\n(Funcionalidade em desenvolvimento)`);
        }

        function viewCourseProgress(courseId) {
            console.log('üìà Visualizar progresso do curso:', courseId);
            alert(`üìà Progresso do curso ${courseId}\n\n(Funcionalidade em desenvolvimento)`);
        }

        function viewCourseDetails(courseId) {
            console.log('üëÅÔ∏è Visualizar detalhes do curso:', courseId);
            alert(`üëÅÔ∏è Detalhes do curso ${courseId}\n\n(Funcionalidade em desenvolvimento)`);
        }

        // ==========================================
        // UNITS MANAGEMENT
        // ==========================================

        // Load units data
        async function loadUnits() {
            try {
                document.getElementById('unitsLoadingState').style.display = 'block';
                document.getElementById('unitsEmptyState').style.display = 'none';
                
                const response = await fetch('/api/units');
                const data = await response.json();
                
                if (data.success) {
                    allUnits = data.data;
                    displayUnits(allUnits);
                    updateUnitsStats();
                } else {
                    throw new Error(data.message || 'Erro ao carregar unidades');
                }
            } catch (error) {
                console.error('Erro ao carregar unidades:', error);
                showToast('Erro ao carregar unidades: ' + error.message, 'error');
                document.getElementById('unitsEmptyState').style.display = 'block';
            } finally {
                document.getElementById('unitsLoadingState').style.display = 'none';
            }
        }

        // Display units in table
        function displayUnits(units) {
            const tbody = document.getElementById('unitsTableBody');
            
            if (!units || units.length === 0) {
                document.getElementById('unitsEmptyState').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }
            
            document.getElementById('unitsEmptyState').style.display = 'none';
            
            tbody.innerHTML = units.map(unit => `
                <tr style="border-bottom: 1px solid #334155;">
                    <td style="padding: 1rem; color: #F8FAFC;">
                        <div style="font-weight: 600;">${unit.name}</div>
                        <div style="font-size: 0.875rem; color: #94A3B8;">${unit.description || 'Sem descri√ß√£o'}</div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        <div style="font-size: 0.875rem;">${unit.address}</div>
                        <div style="font-size: 0.75rem; color: #94A3B8;">${unit.city}, ${unit.state}</div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                        <div style="background: rgba(139, 92, 246, 0.1); color: #8B5CF6; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                            ${unit._count?.mats || 0}
                        </div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                        <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                            ${unit.capacity}
                        </div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                        <div style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                            ${unit._count?.classes || 0}
                        </div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        ${unit.responsibleName || 'N√£o informado'}
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <span style="background: ${unit.isActive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; color: ${unit.isActive ? '#10B981' : '#EF4444'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">
                            ${unit.isActive ? 'ATIVO' : 'INATIVO'}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editUnit('${unit.id}')" style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="viewUnitDetails('${unit.id}')" style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8B5CF6; color: #8B5CF6; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                üëÅÔ∏è Ver
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update units statistics
        function updateUnitsStats() {
            const totalUnits = allUnits.length;
            const totalMats = allUnits.reduce((sum, unit) => sum + (unit._count?.mats || 0), 0);
            const totalCapacity = allUnits.reduce((sum, unit) => sum + unit.capacity, 0);
            const totalClasses = allUnits.reduce((sum, unit) => sum + (unit._count?.classes || 0), 0);
            
            document.getElementById('totalUnitsCount').textContent = totalUnits;
            document.getElementById('totalMatsCount').textContent = totalMats;
            document.getElementById('totalCapacityCount').textContent = totalCapacity;
            document.getElementById('activeClassesCount').textContent = totalClasses;
        }

        // Search units
        function searchUnits() {
            const searchTerm = document.getElementById('unitsSearchInput').value.toLowerCase();
            const filteredUnits = allUnits.filter(unit => 
                unit.name.toLowerCase().includes(searchTerm) ||
                unit.description?.toLowerCase().includes(searchTerm) ||
                unit.address.toLowerCase().includes(searchTerm) ||
                unit.city.toLowerCase().includes(searchTerm)
            );
            displayUnits(filteredUnits);
        }

        // Modal functions for units
        function openAddUnitModal() {
            showToast('Modal de adicionar unidade em desenvolvimento', 'info');
        }

        function editUnit(unitId) {
            showToast(`Editando unidade ${unitId}`, 'info');
        }

        function viewUnitDetails(unitId) {
            showToast(`Visualizando detalhes da unidade ${unitId}`, 'info');
        }

        function exportUnitsReport() {
            showToast('Relat√≥rio de unidades em desenvolvimento', 'info');
        }

        // ==========================================
        // MATS MANAGEMENT
        // ==========================================

        // Load mats data
        async function loadMats() {
            try {
                document.getElementById('matsLoadingState').style.display = 'block';
                document.getElementById('matsEmptyState').style.display = 'none';
                
                const response = await fetch('/api/mats');
                const data = await response.json();
                
                if (data.success) {
                    allMats = data.data;
                    displayMats(allMats);
                    updateMatsStats();
                    loadUnitFilterOptions();
                } else {
                    throw new Error(data.message || 'Erro ao carregar tatames');
                }
            } catch (error) {
                console.error('Erro ao carregar tatames:', error);
                showToast('Erro ao carregar tatames: ' + error.message, 'error');
                document.getElementById('matsEmptyState').style.display = 'block';
            } finally {
                document.getElementById('matsLoadingState').style.display = 'none';
            }
        }

        // Display mats in table
        function displayMats(mats) {
            const tbody = document.getElementById('matsTableBody');
            
            if (!mats || mats.length === 0) {
                document.getElementById('matsEmptyState').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }
            
            document.getElementById('matsEmptyState').style.display = 'none';
            
            tbody.innerHTML = mats.map(mat => `
                <tr style="border-bottom: 1px solid #334155;">
                    <td style="padding: 1rem; color: #F8FAFC;">
                        <div style="font-weight: 600;">${mat.name}</div>
                        <div style="font-size: 0.875rem; color: #94A3B8;">${mat.description || 'Sem descri√ß√£o'}</div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        ${mat.unit?.name || 'Sem unidade'}
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                        <div style="background: rgba(16, 185, 129, 0.1); color: #10B981; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                            ${mat.capacity}
                        </div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        ${mat.dimensions || 'N√£o informado'}
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1;">
                        <div style="font-size: 0.875rem;">${mat.equipment?.join(', ') || 'Nenhum'}</div>
                    </td>
                    <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                        <div style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                            ${mat._count?.classes || 0}
                        </div>
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <span style="background: ${mat.isActive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; color: ${mat.isActive ? '#10B981' : '#EF4444'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">
                            ${mat.isActive ? 'ATIVO' : 'INATIVO'}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editMat('${mat.id}')" style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="viewMatDetails('${mat.id}')" style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8B5CF6; color: #8B5CF6; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                üëÅÔ∏è Ver
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update mats statistics
        function updateMatsStats() {
            const totalMats = allMats.length;
            const totalCapacity = allMats.reduce((sum, mat) => sum + mat.capacity, 0);
            const matsInUse = allMats.filter(mat => mat._count?.classes > 0).length;
            const matsAvailable = allMats.filter(mat => mat.isActive && !mat._count?.classes).length;
            
            document.getElementById('matsCount').textContent = totalMats;
            document.getElementById('matsCapacity').textContent = totalCapacity;
            document.getElementById('matsInUse').textContent = matsInUse;
            document.getElementById('matsAvailable').textContent = matsAvailable;
        }

        // Load unit filter options
        function loadUnitFilterOptions() {
            const select = document.getElementById('unitFilter');
            if (!select) return;
            
            const units = [...new Set(allMats.map(mat => mat.unit?.name).filter(Boolean))];
            const optionsHTML = '<option value="">Todas as Unidades</option>' +
                units.map(unitName => `<option value="${unitName}">${unitName}</option>`).join('');
            
            select.innerHTML = optionsHTML;
        }

        // Filter mats by unit
        function filterMatsByUnit() {
            const selectedUnit = document.getElementById('unitFilter').value;
            const filteredMats = selectedUnit 
                ? allMats.filter(mat => mat.unit?.name === selectedUnit)
                : allMats;
            displayMats(filteredMats);
        }

        // Clear mat filters
        function clearMatFilters() {
            document.getElementById('unitFilter').value = '';
            document.getElementById('matsSearchInput').value = '';
            displayMats(allMats);
        }

        // Search mats
        function searchMats() {
            const searchTerm = document.getElementById('matsSearchInput').value.toLowerCase();
            const filteredMats = allMats.filter(mat => 
                mat.name.toLowerCase().includes(searchTerm) ||
                mat.description?.toLowerCase().includes(searchTerm) ||
                mat.unit?.name.toLowerCase().includes(searchTerm)
            );
            displayMats(filteredMats);
        }

        // Modal functions for mats
        function openAddMatModal() {
            showToast('Modal de adicionar tatame em desenvolvimento', 'info');
        }

        function editMat(matId) {
            showToast(`Editando tatame ${matId}`, 'info');
        }

        function viewMatDetails(matId) {
            showToast(`Visualizando detalhes do tatame ${matId}`, 'info');
        }

        function exportMatsReport() {
            showToast('Relat√≥rio de tatames em desenvolvimento', 'info');
        }

        // ==========================================
        // INSTRUCTORS MANAGEMENT
        // ==========================================

        // Load instructors data
        async function loadInstructors() {
            try {
                document.getElementById('instructorsLoadingState').style.display = 'block';
                document.getElementById('instructorsEmptyState').style.display = 'none';
                
                const response = await fetch('/api/instructors');
                const data = await response.json();
                
                if (data.success) {
                    allInstructors = data.data;
                    displayInstructors(allInstructors);
                    updateInstructorsStats();
                } else {
                    throw new Error(data.message || 'Erro ao carregar professores');
                }
            } catch (error) {
                console.error('Erro ao carregar professores:', error);
                showToast('Erro ao carregar professores: ' + error.message, 'error');
                document.getElementById('instructorsEmptyState').style.display = 'block';
            } finally {
                document.getElementById('instructorsLoadingState').style.display = 'none';
            }
        }

        // Display instructors in table
        function displayInstructors(instructors) {
            const tbody = document.getElementById('instructorsTableBody');
            
            if (!instructors || instructors.length === 0) {
                document.getElementById('instructorsEmptyState').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }
            
            document.getElementById('instructorsEmptyState').style.display = 'none';
            
            tbody.innerHTML = instructors.map(instructor => {
                const user = instructor.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                
                return `
                    <tr style="border-bottom: 1px solid #334155;">
                        <td style="padding: 1rem; color: #F8FAFC;">
                            <div style="font-weight: 600;">${fullName || 'Nome n√£o informado'}</div>
                            <div style="font-size: 0.875rem; color: #94A3B8;">${instructor.bio ? instructor.bio.substring(0, 50) + '...' : 'Sem biografia'}</div>
                        </td>
                        <td style="padding: 1rem; color: #CBD5E1;">
                            ${user.email || 'Email n√£o informado'}
                        </td>
                        <td style="padding: 1rem; color: #CBD5E1;">
                            <div style="font-size: 0.875rem;">${instructor.specializations?.join(', ') || 'Nenhuma'}</div>
                        </td>
                        <td style="padding: 1rem; color: #CBD5E1;">
                            <div style="font-size: 0.875rem;">${instructor.martialArts?.join(', ') || 'Nenhuma'}</div>
                        </td>
                        <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                            <div style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                                ${instructor.experience || 0} anos
                            </div>
                        </td>
                        <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                            <div style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; display: inline-block;">
                                ${instructor._count?.classes || 0}
                            </div>
                        </td>
                        <td style="padding: 1rem; color: #CBD5E1; text-align: center;">
                            ${instructor.hourlyRate ? `R$ ${instructor.hourlyRate.toFixed(2)}` : 'N√£o informado'}
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <span style="background: ${instructor.isActive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; color: ${instructor.isActive ? '#10B981' : '#EF4444'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">
                                ${instructor.isActive ? 'ATIVO' : 'INATIVO'}
                            </span>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="editInstructor('${instructor.id}')" style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3B82F6; color: #3B82F6; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="viewInstructorDetails('${instructor.id}')" style="background: rgba(139, 92, 246, 0.1); border: 1px solid #8B5CF6; color: #8B5CF6; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                    üëÅÔ∏è Ver
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update instructors statistics
        function updateInstructorsStats() {
            const totalInstructors = allInstructors.length;
            const activeInstructors = allInstructors.filter(inst => inst.isActive).length;
            const instructorsWithClasses = allInstructors.filter(inst => inst._count?.classes > 0).length;
            const avgExperience = allInstructors.length > 0 
                ? Math.round(allInstructors.reduce((sum, inst) => sum + (inst.experience || 0), 0) / allInstructors.length)
                : 0;
            
            document.getElementById('instructorsCount').textContent = totalInstructors;
            document.getElementById('instructorsActive').textContent = activeInstructors;
            document.getElementById('instructorsWithClasses').textContent = instructorsWithClasses;
            document.getElementById('avgExperience').textContent = avgExperience;
        }

        // Search instructors
        function searchInstructors() {
            const searchTerm = document.getElementById('instructorsSearchInput').value.toLowerCase();
            const filteredInstructors = allInstructors.filter(instructor => {
                const user = instructor.user || {};
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                return fullName.includes(searchTerm) ||
                       user.email?.toLowerCase().includes(searchTerm) ||
                       instructor.specializations?.some(spec => spec.toLowerCase().includes(searchTerm)) ||
                       instructor.martialArts?.some(art => art.toLowerCase().includes(searchTerm));
            });
            displayInstructors(filteredInstructors);
        }

        // Modal functions for instructors
        function openAddInstructorModal() {
            showToast('Modal de adicionar professor em desenvolvimento', 'info');
        }

        function editInstructor(instructorId) {
            showToast(`Editando professor ${instructorId}`, 'info');
        }

        function viewInstructorDetails(instructorId) {
            showToast(`Visualizando detalhes do professor ${instructorId}`, 'info');
        }

        function exportInstructorsReport() {
            showToast('Relat√≥rio de professores em desenvolvimento', 'info');
        }

        // ==========================================
        // PAYMENT PLANS MISSING FUNCTIONS
        // ==========================================

        // Open Add Plan Page (full screen instead of modal)
        function openAddPlanPage() {
            console.log('üÜï Opening Add Plan Page...');
            
            // Navigate to full-screen plan edit page in creation mode
            clearPlanEditForm();
            updatePlanEditPageTitle('Criar Novo Plano', 'Preencha as informa√ß√µes para criar um novo plano');
            showSection('plan-edit');
            
            // Set form to creation mode
            document.getElementById('planEditForm').dataset.mode = 'create';
            delete document.getElementById('planEditForm').dataset.editingPlanId;
            
            // Reset to first tab and load courses
            switchPlanEditTab('basic');
            loadCoursesForPlanEdit();
            
            showToast('Abrindo formul√°rio de novo plano', 'info');
        }

        // Switch between plan edit tabs (for full-screen page)
        window.switchPlanEditTab = function(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.plan-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.plan-tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            const selectedTab = document.querySelector(`.plan-tab[data-tab="${tabName}"]`);
            const selectedContent = document.getElementById(`planEditTab-${tabName}`);
            
            if (selectedTab && selectedContent) {
                selectedTab.classList.add('active');
                selectedContent.classList.add('active');
            }
            
            // Load content for specific tabs
            if (tabName === 'courses') {
                // Only reload if not already loaded
                const coursesGrid = document.getElementById('editCoursesGrid');
                if (!coursesGrid || !coursesGrid.innerHTML.includes('planCourses')) {
                    console.log('üîÑ switchPlanEditTab courses - Loading for first time');
                    const currentSelection = getCurrentlySelectedCourseIds();
                    loadCoursesForPlanEdit(currentSelection);
                } else {
                    console.log('‚úÖ switchPlanEditTab courses - Already loaded, skipping reload');
                }
            } else if (tabName === 'preview') {
                updatePlanEditPreview();
            }
        }

        // Helper function to get currently selected course IDs
        function getCurrentlySelectedCourseIds() {
            const checkboxes = document.querySelectorAll('#editCoursesGrid .course-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-course-id'));
        }

        // Load courses for plan edit selection
        async function loadCoursesForPlanEdit(preselectCourseIds = []) {
            console.log('üéì loadCoursesForPlanEdit started with preselect:', preselectCourseIds);
            const coursesGrid = document.getElementById('editCoursesGrid');
            
            try {
                // Show loading state
                coursesGrid.innerHTML = `
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Carregando cursos dispon√≠veis...</p>
                    </div>
                `;
                
                console.log('üéì Fetching courses from /api/courses...');
                const response = await fetch('/api/courses');
                const result = await response.json();
                console.log('üéì Courses API response:', result);
                
                if (result.success && result.data.length > 0) {
                    const courses = result.data;
                    
                    console.log('üéì Courses loaded for edit:', courses.length);
                    console.log('üéì First course:', courses[0]);
                    
                    // Update stats
                    document.getElementById('editCoursesTotalCount').textContent = `${courses.length} cursos dispon√≠veis`;
                    updateSelectedEditCoursesCount();
                    
                    // Simplified course selection interface
                    coursesGrid.innerHTML = `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: #E2E8F0; margin: 0 0 1rem 0;">Selecionar Cursos para o Plano</h4>
                            <p style="color: #94A3B8; margin: 0 0 1rem 0; font-size: 0.875rem;">Marque os cursos que fazem parte deste plano:</p>
                        </div>
                        
                        <div style="display: grid; gap: 0.75rem;">
                            ${courses.map(course => `
                                <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.8); border: 2px solid rgba(148, 163, 184, 0.2); border-radius: 8px; cursor: pointer; transition: all 0.2s ease;" 
                                       onmouseover="this.style.borderColor='rgba(59, 130, 246, 0.5)'" 
                                       onmouseout="this.style.borderColor='rgba(148, 163, 184, 0.2)'">
                                    <input type="checkbox" 
                                           name="planCourses" 
                                           value="${course.id}" 
                                           ${preselectCourseIds.includes(course.id) ? 'checked' : ''}
                                           style="width: 20px; height: 20px; accent-color: #10B981; cursor: pointer;"
                                           onchange="updateCourseSelection(this)">
                                    <div style="flex: 1;">
                                        <h5 style="color: #E2E8F0; margin: 0 0 0.25rem 0; font-size: 1rem; font-weight: 600;">${course.name}</h5>
                                        <p style="color: #94A3B8; margin: 0; font-size: 0.875rem;">${course.description || 'Descri√ß√£o n√£o dispon√≠vel'}</p>
                                    </div>
                                    <div style="color: #94A3B8; font-size: 0.75rem; text-align: right;">
                                        <div>üéì ${course.totalClasses || 48} aulas</div>
                                        <div>üë• ${course._count?.studentCourses || 0} alunos</div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                        
                        <div id="selectedCoursesDisplay" style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px;">
                            <h5 style="color: #E2E8F0; margin: 0 0 0.5rem 0;">Cursos Selecionados: <span id="selectedCount">0</span></h5>
                            <div id="selectedCourseNames" style="color: #94A3B8; font-size: 0.875rem;">Nenhum curso selecionado</div>
                        </div>
                    `;
                    
                    // Update the display immediately
                    updateSimpleCourseDisplay();
                } else {
                    coursesGrid.innerHTML = `
                        <div style="text-align: center; color: #94A3B8; padding: 3rem;">
                            <h4>üìö Nenhum curso dispon√≠vel</h4>
                            <p>Crie cursos primeiro para associ√°-los aos planos.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar cursos:', error);
                coursesGrid.innerHTML = `
                    <div style="text-align: center; color: #EF4444; padding: 3rem;">
                        <h4>‚ùå Erro ao carregar cursos</h4>
                        <p>Tente novamente ou verifique a conex√£o.</p>
                    </div>
                `;
                throw error; // Re-throw to ensure promise rejects
            }
            
            console.log('üéì loadCoursesForPlanEdit completed successfully');
            return true; // Ensure promise resolves
        }

        // Simple course selection function
        function updateCourseSelection(checkbox) {
            const label = checkbox.closest('label');
            
            // Visual feedback
            if (checkbox.checked) {
                label.style.borderColor = '#10B981';
                label.style.background = 'rgba(16, 185, 129, 0.1)';
            } else {
                label.style.borderColor = 'rgba(148, 163, 184, 0.2)';
                label.style.background = 'rgba(15, 23, 42, 0.8)';
            }
            
            updateSimpleCourseDisplay();
            updateLegacyEditPlanCourseField();
        }

        // Simple display update
        function updateSimpleCourseDisplay() {
            const checkboxes = document.querySelectorAll('#editCoursesGrid input[name="planCourses"]:checked');
            const countElement = document.getElementById('selectedCount');
            const namesElement = document.getElementById('selectedCourseNames');
            
            if (!countElement || !namesElement) return;
            
            const count = checkboxes.length;
            countElement.textContent = count;
            
            if (count === 0) {
                namesElement.textContent = 'Nenhum curso selecionado';
            } else {
                const names = Array.from(checkboxes).map(cb => {
                    const label = cb.closest('label');
                    return label.querySelector('h5').textContent;
                });
                namesElement.textContent = names.join(', ');
            }
            
            updateSelectedEditCoursesCount();
        }

        // Select all courses in edit page with visual feedback
        function selectAllEditCourses() {
            document.querySelectorAll('#editCoursesGrid .course-card').forEach(card => {
                const checkbox = card.querySelector('.course-checkbox');
                const selectionIndicator = card.querySelector('.selection-indicator');
                
                checkbox.checked = true;
                card.classList.add('selected');
                
                // Apply visual state
                card.style.border = '2px solid #3B82F6';
                card.style.background = 'rgba(59, 130, 246, 0.1)';
                card.style.transform = 'scale(1.02)';
                
                if (selectionIndicator) {
                    selectionIndicator.style.display = 'block';
                }
            });
            updateLegacyEditPlanCourseField();
            updateSelectedEditCoursesCount();
            updatePlanEditPreview();
            showToast('Todos os cursos foram selecionados', 'success');
        }

        // Clear all course selections in edit page with visual feedback
        function clearAllEditCourses() {
            document.querySelectorAll('#editCoursesGrid .course-card').forEach(card => {
                const checkbox = card.querySelector('.course-checkbox');
                const selectionIndicator = card.querySelector('.selection-indicator');
                
                checkbox.checked = false;
                card.classList.remove('selected');
                
                // Reset visual state
                card.style.border = '2px solid rgba(148, 163, 184, 0.2)';
                card.style.background = 'rgba(15, 23, 42, 0.8)';
                card.style.transform = 'scale(1)';
                
                if (selectionIndicator) {
                    selectionIndicator.style.display = 'none';
                }
            });
            updateLegacyEditPlanCourseField();
            updateSelectedEditCoursesCount();
            updatePlanEditPreview();
            showToast('Sele√ß√£o de cursos foi limpa', 'info');
        }

        // Update selected courses count in edit page
        function updateSelectedEditCoursesCount() {
            const selectedCount = document.querySelectorAll('#editCoursesGrid input[name="planCourses"]:checked').length;
            const element = document.getElementById('editCoursesSelectedCount');
            if (element) {
                element.textContent = `${selectedCount} cursos selecionados`;
            }
            
            // Show/hide validation alerts
            const validationAlert = document.getElementById('coursesValidationAlert');
            const successAlert = document.getElementById('coursesSuccessAlert');
            
            if (selectedCount === 0) {
                if (validationAlert) {
                    validationAlert.style.display = 'block';
                }
                if (successAlert) {
                    successAlert.style.display = 'none';
                }
            } else {
                if (validationAlert) {
                    validationAlert.style.display = 'none';
                }
                if (successAlert) {
                    successAlert.style.display = 'block';
                }
            }
        }

        // Update legacy plan course field for compatibility in edit page
        function updateLegacyEditPlanCourseField() {
            const legacySelect = document.getElementById('editPlanCourse');
            const selectedCourses = document.querySelectorAll('#editCoursesGrid .course-checkbox:checked');
            
            // Clear existing options
            legacySelect.innerHTML = '';
            
            // Add selected courses as options
            selectedCourses.forEach(checkbox => {
                const courseId = checkbox.dataset.courseId;
                const card = checkbox.closest('.course-card');
                const courseName = card.querySelector('h4').textContent;
                
                const option = document.createElement('option');
                option.value = courseId;
                option.textContent = courseName;
                option.selected = true;
                legacySelect.appendChild(option);
            });
        }

        // Update plan preview in edit page (Enhanced for new tab system)
        function updatePlanEditPreview() {
            const courseSelect = document.getElementById('editPlanCourse');
            const categorySelect = document.getElementById('editPlanCategory');
            const billingTypeSelect = document.getElementById('editPlanBillingType');
            const classesPerWeekSelect = document.getElementById('editPlanClassesPerWeek');
            
            const selectedCourses = Array.from(courseSelect.selectedOptions).map(option => option.text);
            const courseName = selectedCourses.length > 0 ? selectedCourses.join(', ') : 'Nenhum curso selecionado';
            const category = categorySelect.value;
            const billingType = billingTypeSelect?.value || 'MONTHLY';
            const classesPerWeek = classesPerWeekSelect?.value || '2';
            
            // Suggested category prices mapping (not enforced)
            const suggestedCategoryPrices = {
                'ADULT': '180.00',
                'FEMALE': '170.00',
                'SENIOR': '130.00',
                'CHILD': '120.00',
                'INICIANTE1': '120.00',
                'INICIANTE2': '130.00',
                'INICIANTE3': '140.00',
                'HEROI1': '160.00',
                'HEROI2': '170.00',
                'HEROI3': '180.00',
                'MASTER_1': '200.00',
                'MASTER_2': '220.00',
                'MASTER_3': '250.00'
            };
            
            const selectedCount = courseSelect.selectedOptions.length;
            const planName = selectedCount === 0 ? 'Novo Plano' :
                selectedCount === 1 ? `${courseName} - ${category}` : 
                `Multi-Curso (${selectedCount} cursos) - ${category}`;
            
            const customPrice = document.getElementById('editPlanPrice')?.value || '';
            
            // Only suggest price if field is completely empty, don't enforce it
            if (!customPrice && category) {
                const suggestedPrice = suggestedCategoryPrices[category] || '150.00';
                const adjustedPrice = selectedCount > 1 ? 
                    (parseFloat(suggestedPrice) * 1.5).toFixed(2) : suggestedPrice;
                
                // Set placeholder instead of value, so user can choose
                document.getElementById('editPlanPrice').placeholder = `Sugest√£o: R$ ${adjustedPrice}`;
            }
            
            const price = customPrice || '0.00';
            
            // Update preview elements
            document.getElementById('editPreviewPlanName').textContent = planName;
            document.getElementById('editPreviewPlanPrice').textContent = `R$ ${parseFloat(price || 0).toFixed(2)}`;
            
            const description = selectedCount === 0 ? 'Selecione pelo menos um curso para continuar' :
                selectedCount === 1 ? `Plano ${category.toLowerCase()} para ${courseName}` :
                `Plano ${category.toLowerCase()} com acesso a ${selectedCount} cursos: ${courseName}`;
            document.getElementById('editPreviewPlanDescription').textContent = description;
            
            // Update detailed preview information
            const categoryNames = {
                'ADULT': 'Adulto',
                'FEMALE': 'Feminino',
                'SENIOR': 'Senior/Idoso',
                'CHILD': 'Infantil/Crian√ßa',
                'INICIANTE1': 'Iniciante 1',
                'INICIANTE2': 'Iniciante 2',
                'INICIANTE3': 'Iniciante 3',
                'HEROI1': 'Her√≥i 1',
                'HEROI2': 'Her√≥i 2',
                'HEROI3': 'Her√≥i 3',
                'MASTER_1': 'Master 1',
                'MASTER_2': 'Master 2',
                'MASTER_3': 'Master 3'
            };
            
            const billingTypeNames = {
                'MONTHLY': 'Mensal',
                'WEEKLY': 'Semanal',
                'QUARTERLY': 'Trimestral',
                'YEARLY': 'Anual'
            };
            
            document.getElementById('editPreviewCategory').textContent = categoryNames[category] || category || 'N√£o definida';
            document.getElementById('editPreviewBillingType').textContent = billingTypeNames[billingType] || billingType;
            document.getElementById('editPreviewCourses').textContent = selectedCount > 0 ? courseName : 'Nenhum curso selecionado';
            document.getElementById('editPreviewClassesPerWeek').textContent = classesPerWeek === 'unlimited' ? 'Ilimitado' : `${classesPerWeek} aulas`;
            
            // Auto-fill form fields
            const nameField = document.getElementById('editPlanName');
            const descField = document.getElementById('editPlanDescription');
            
            if (nameField && !nameField.value) {
                nameField.value = planName;
            }
            if (descField && !descField.value && selectedCount > 0) {
                descField.value = description;
            }
        }

        // Edit Plan function - open plan edit page in edit mode
        function editPlan(planId) {
            console.log('‚úèÔ∏è Opening edit plan page for:', planId);
            console.log('üîç Debug: allPlans array:', allPlans);
            
            // Find the plan to edit
            const plan = allPlans.find(p => p.id === planId);
            if (!plan) {
                console.error('‚ùå Plan not found in allPlans:', planId);
                console.error('üìã Available plans:', allPlans.map(p => ({ id: p.id, name: p.name })));
                showToast('Plano n√£o encontrado', 'error');
                return;
            }
            
            console.log('‚úÖ Plan found:', plan);
            
            // Clear form and populate with existing data
            clearPlanEditForm();
            populatePlanEditForm(plan);
            
            // Update page title
            updatePlanEditPageTitle('Editar Plano', `Editando: ${plan.name}`);
            
            // Navigate to plan edit page
            showSection('plan-edit');
            
            // Set form to edit mode
            const form = document.getElementById('planEditForm');
            if (form) {
                form.dataset.mode = 'edit';
                form.dataset.editingPlanId = planId;
                console.log('‚úÖ Form mode set to edit, plan ID:', planId);
                console.log('üîç Form dataset after setting:', form.dataset);
            } else {
                console.error('‚ùå Form not found: planEditForm');
            }
            
            // Store current plan ID globally
            window.currentPlanId = planId;
            console.log('‚úÖ Global currentPlanId set to:', planId);
            
            showToast('Carregando dados do plano...', 'info');
        }

        

        // Filter Plans function
        function filterPlans() {
            console.log('üîç Filtering payment plans...');
            
            const searchTerm = document.getElementById('planSearchInput')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('categoryFilterSelect')?.value || '';
            const billingTypeFilter = document.getElementById('billingTypeFilter')?.value || '';
            
            // Make sure allPlans is available
            if (!allPlans || !Array.isArray(allPlans)) {
                console.log('No plans data available for filtering');
                return;
            }
            
            // Filter the plans based on criteria
            const filteredPlans = allPlans.filter(plan => {
                // Search term filter (check name, description, course name)
                const matchesSearch = !searchTerm || 
                    plan.name?.toLowerCase().includes(searchTerm) ||
                    plan.description?.toLowerCase().includes(searchTerm) ||
                    (plan.course?.name || '').toLowerCase().includes(searchTerm);
                
                // Category filter
                const matchesCategory = !categoryFilter || plan.category === categoryFilter;
                
                // Billing type filter
                const matchesBillingType = !billingTypeFilter || plan.billingType === billingTypeFilter;
                
                return matchesSearch && matchesCategory && matchesBillingType;
            });
            
            console.log(`Filtered ${filteredPlans.length} plans from ${allPlans.length} total`);
            
            // Update the table with filtered results
            updatePaymentPlansTable(filteredPlans);
            
            // Update the count text
            document.getElementById('plansCountText').textContent = 
                `${filteredPlans.length} plano(s) encontrado(s) ${filteredPlans.length !== allPlans.length ? `(filtrado de ${allPlans.length})` : ''}`;
        }

        // Edit Plan function
        async function editPlanModal(planId) {
            try {
                console.log(`‚úèÔ∏è Editing plan ${planId} (Modal Version)`);
                
                // Fetch plan details from API
                const response = await fetch(`/api/billing-plans`);
                const result = await response.json();
                
                if (!result.success) {
                    console.error('‚ùå Error fetching plans:', result.error);
                    showToast('Erro ao carregar planos: ' + result.message, 'error');
                    return;
                }
                
                // Find the specific plan
                const plan = result.data.find(p => p.id === planId);
                if (!plan) {
                    showToast('Plano n√£o encontrado', 'error');
                    return;
                }
                
                console.log('üìã Plan data loaded:', plan);
                
                // Populate form with current values
                const editForm = `
                <div style="max-width: 600px; margin: 0 auto; padding: 2rem; background: #1E293B; border-radius: 12px;">
                    <h3 style="color: #3B82F6; margin-bottom: 1.5rem;">‚úèÔ∏è Editar Plano</h3>
                    <form id="editPlanForm" onsubmit="submitPlanEdit(event, '${planId}')">
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">Nome do Plano:</label>
                            <input type="text" id="editPlanName" value="${plan.name || ''}" 
                                   style="width: 100%; padding: 0.75rem; background: #374151; border: 1px solid #4B5563; border-radius: 8px; color: white;" required>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">Descri√ß√£o:</label>
                            <textarea id="editPlanDescription" rows="3" 
                                      style="width: 100%; padding: 0.75rem; background: #374151; border: 1px solid #4B5563; border-radius: 8px; color: white;">${plan.description || ''}</textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">Categoria:</label>
                                <select id="editPlanCategory" style="width: 100%; padding: 0.75rem; background: #374151; border: 1px solid #4B5563; border-radius: 8px; color: white;">
                                    <option value="ADULT" ${plan.category === 'ADULT' ? 'selected' : ''}>Adulto</option>
                                    <option value="CHILD" ${plan.category === 'CHILD' ? 'selected' : ''}>Infantil</option>
                                    <option value="SENIOR" ${plan.category === 'SENIOR' ? 'selected' : ''}>Senior</option>
                                    <option value="FEMALE" ${plan.category === 'FEMALE' ? 'selected' : ''}>Feminino</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">Pre√ßo (R$):</label>
                                <input type="number" id="editPlanPrice" value="${plan.price || ''}" step="0.01" 
                                       style="width: 100%; padding: 0.75rem; background: #374151; border: 1px solid #4B5563; border-radius: 8px; color: white;" required>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">Tipo de Cobran√ßa:</label>
                                <select id="editPlanBillingType" style="width: 100%; padding: 0.75rem; background: #374151; border: 1px solid #4B5563; border-radius: 8px; color: white;">
                                    <option value="MONTHLY" ${plan.billingType === 'MONTHLY' ? 'selected' : ''}>Mensal</option>
                                    <option value="QUARTERLY" ${plan.billingType === 'QUARTERLY' ? 'selected' : ''}>Trimestral</option>
                                    <option value="YEARLY" ${plan.billingType === 'YEARLY' ? 'selected' : ''}>Anual</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">Aulas por Semana:</label>
                                <input type="number" id="editPlanClassesPerWeek" value="${plan.classesPerWeek || 2}" min="1" max="7" 
                                       style="width: 100%; padding: 0.75rem; background: #374151; border: 1px solid #4B5563; border-radius: 8px; color: white;">
                            </div>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="color: #CBD5E1; margin-bottom: 0.5rem; display: block;">
                                <input type="checkbox" id="editPlanIsActive" ${plan.isActive ? 'checked' : ''} style="margin-right: 0.5rem;">
                                Plano Ativo
                            </label>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" onclick="closeEditPlanModal()" 
                                    style="padding: 0.75rem 1.5rem; background: #4B5563; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Cancelar
                            </button>
                            <button type="submit" 
                                    style="padding: 0.75rem 1.5rem; background: #3B82F6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Salvar Altera√ß√µes
                            </button>
                        </div>
                    </form>
                </div>`;
                
                // Create modal overlay
                const modalOverlay = document.createElement('div');
                modalOverlay.id = 'editPlanModal';
                modalOverlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; 
                    justify-content: center; z-index: 1000;
                `;
                modalOverlay.innerHTML = editForm;
                
                document.body.appendChild(modalOverlay);
                
            } catch (error) {
                console.error('‚ùå Error in editPlan:', error);
                showToast('Erro ao abrir editor de plano: ' + error.message, 'error');
            }
        }

        // Submit plan edit
        async function submitPlanEdit(event, planId) {
            event.preventDefault();
            
            try {
                // Get the form element
                const form = event.target;
                
                const formData = {
                    name: form.querySelector('#editPlanName').value,
                    description: form.querySelector('#editPlanDescription').value,
                    category: form.querySelector('#editPlanCategory').value,
                    price: parseFloat(form.querySelector('#editPlanPrice').value),
                    billingType: form.querySelector('#editPlanBillingType').value,
                    classesPerWeek: parseInt(form.querySelector('#editPlanClassesPerWeek').value),
                    isActive: form.querySelector('#editPlanIsActive').checked
                };
                
                console.log('üì§ Updating plan:', formData);
                
                const response = await fetch(`/api/billing-plans/${planId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('‚úÖ Plano atualizado com sucesso!', 'success');
                    closeEditPlanModal();
                    // Reload plans table
                    loadPaymentPlansList();
                } else {
                    showToast('‚ùå Erro ao atualizar plano: ' + result.message, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Error updating plan:', error);
                showToast('Erro ao atualizar plano: ' + error.message, 'error');
            }
        }

        // Close edit plan modal
        function closeEditPlanModal() {
            const modal = document.getElementById('editPlanModal');
            if (modal) {
                modal.remove();
            }
        }

        // Delete Plan function for table (REMOVED - using deletePlanFromTable instead)

        // ==========================================
        // REMOVED DUPLICATE FUNCTION - USING VERSION ABOVE
        // ==========================================

        // ==========================================
        // AUTO-LOAD DATA FOR INFRASTRUCTURE SECTIONS (Already handled above)
        // ==========================================

        // ==========================================
        // STUDENT TABLE INITIALIZATION (PERMANENT FIX)
        // ==========================================
        
        // Initialize student table event delegation when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing student table event delegation...');
            
            // Setup event delegation after a small delay to ensure DOM is ready
            setTimeout(() => {
                setupStudentTableEventDelegation();
                console.log('‚úÖ Student table event delegation initialized on page load');
            }, 500);
        });
        
        // Backup initialization for cases where DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            // DOMContentLoaded will handle it
        } else {
            // DOM is already ready
            setTimeout(() => {
                setupStudentTableEventDelegation();
                console.log('‚úÖ Student table event delegation initialized (DOM already ready)');
            }, 100);
        }

        // Plan Edit Functions
        let currentPlanId = null;
        
        // Emergency navigation function for payment plans
        function forceNavigateToPaymentPlans() {
            console.log('üö® Emergency navigation to payment plans');
            
            // Method 1: Hide all sections manually
            const allSections = document.querySelectorAll('.content-section');
            allSections.forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            // Method 2: Show payment plans section
            const paymentPlansSection = document.getElementById('payment-plans');
            if (paymentPlansSection) {
                paymentPlansSection.classList.add('active');
                paymentPlansSection.style.display = 'block';
                console.log('‚úÖ Payment plans section shown');
            }
            
            // Method 3: Update navigation state
            const navButtons = document.querySelectorAll('.nav-link');
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            const plansButton = document.querySelector('[data-page="payment-plans"]');
            if (plansButton) {
                plansButton.classList.add('active');
                console.log('‚úÖ Navigation button activated');
            }
            
            // Method 4: Reload plans list
            if (typeof loadPaymentPlansList === 'function') {
                loadPaymentPlansList();
            }
            
            // Clear any global state
            currentPlanId = null;
            
            console.log('‚úÖ Emergency navigation completed');
        }
        
        // Debug function to test navigation
        window.debugNavigation = function() {
            console.log('üîç DEBUGGING NAVIGATION');
            console.log('Current sections:', Array.from(document.querySelectorAll('.content-section')).map(s => ({
                id: s.id,
                active: s.classList.contains('active'),
                display: s.style.display || 'default'
            })));
            console.log('Payment plans section:', document.getElementById('payment-plans'));
            console.log('Plan edit section:', document.getElementById('plan-edit'));
            console.log('Navigation buttons:', Array.from(document.querySelectorAll('.nav-link')).map(b => ({
                text: b.textContent.trim(),
                page: b.getAttribute('data-page'),
                active: b.classList.contains('active')
            })));
        };

        // openPlanEditPage function moved to DOMContentLoaded event handler above

        window.populatePlanEditForm = async function(plan) {
            console.log('üìù Populating comprehensive form with plan data:', plan);
            
            try {
                // Helper function to safely set element value
                const safeSetValue = (elementId, value) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.value = value || '';
                        console.log(`‚úÖ Set ${elementId} = ${value}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Element not found: ${elementId}`);
                    }
                };

                // Helper function to safely set checkbox
                const safeSetCheckbox = (elementId, checked) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.checked = checked;
                        console.log(`‚úÖ Set checkbox ${elementId} = ${checked}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Checkbox not found: ${elementId}`);
                    }
                };

                // Basic information
                safeSetValue('editPlanName', plan.name);
                safeSetValue('editPlanDescription', plan.description);
                safeSetValue('editPlanCourse', plan.courseId);
                safeSetValue('editPlanCategory', plan.category);
                
                // Financial settings
                safeSetValue('editPlanPrice', plan.price);
                safeSetValue('editPlanBillingType', plan.billingType || 'MONTHLY');
                safeSetValue('editPlanClassesPerWeek', plan.weeklyClasses || 2);
                safeSetValue('editPlanWeeklyClasses', plan.weeklyClasses || 2);
                safeSetValue('editPlanDuration', plan.duration || 12);
                safeSetValue('editPlanGracePeriod', plan.gracePeriod || 0);
                
                // Sync the fields if the function exists
                if (typeof syncWeeklyClassesField === 'function') {
                    syncWeeklyClassesField();
                }
                
                // Features (default to checked for demonstration)
                safeSetCheckbox('editPlanFeatureAccess', true);
                safeSetCheckbox('editPlanFeatureEquipment', plan.category === 'ADULT');
                safeSetCheckbox('editPlanFeatureNutrition', plan.hasNutrition || plan.category === 'ADULT');
                safeSetCheckbox('editPlanFeaturePersonal', plan.hasPersonalTraining || false);
                safeSetCheckbox('editPlanFeatureEvents', true);
                safeSetCheckbox('editPlanFeatureMaterial', true);
                
                // Status and configurations
                safeSetCheckbox('editPlanIsActive', plan.isActive !== false);
                safeSetCheckbox('editPlanAllowUpgrade', true);
                safeSetCheckbox('editPlanAutoRenewal', true);
                safeSetValue('editPlanStudentLimit', plan.studentLimit);
                safeSetValue('editPlanNotes', plan.notes);

                console.log('‚úÖ Comprehensive form populated successfully');
            } catch (error) {
                console.error('‚ùå Error populating comprehensive form:', error);
                showNotification('Erro ao carregar dados do plano', 'error');
            }
        }

        // Note: backToPlans() function is defined later in the code to avoid duplication

        // Clear plan edit form for creation mode
        function clearPlanEditForm() {
            console.log('üßπ Clearing plan edit form...');
            
            // Helper function to safely clear element value
            const safeClearValue = (elementId, value = '') => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = value;
                }
            };
            
            // Helper function to safely set checkbox
            const safeClearCheckbox = (elementId, checked = false) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.checked = checked;
                }
            };
            
            // Clear all form fields
            safeClearValue('editPlanName');
            safeClearValue('editPlanDescription');
            safeClearValue('editPlanCourse');
            safeClearValue('editPlanCategory');
            safeClearValue('editPlanPrice');
            safeClearValue('editPlanBillingType', 'MONTHLY');
            safeClearValue('editPlanWeeklyClasses', '2');
            safeClearValue('editPlanDuration', '30');
            safeClearValue('editPlanGracePeriod', '5');
            safeClearCheckbox('editPlanIsActive', true);
            safeClearCheckbox('editPlanAllowUpgrade', true);
            safeClearCheckbox('editPlanAutoRenewal', false);
            safeClearValue('editPlanStudentLimit');
            safeClearValue('editPlanNotes');
        }

        // Sync the visible select field with the hidden field
        function syncWeeklyClassesField() {
            const selectField = document.getElementById('editPlanClassesPerWeek');
            const hiddenField = document.getElementById('editPlanWeeklyClasses');
            
            if (selectField && hiddenField) {
                const value = selectField.value;
                hiddenField.value = value === 'unlimited' ? 999 : value;
            }
        }

        // Update plan edit page title and subtitle
        function updatePlanEditPageTitle(title, subtitle) {
            console.log('üìù Updating plan edit page title:', title);
            
            const titleElement = document.querySelector('#plan-edit h1');
            const subtitleElement = document.getElementById('planEditSubtitle');
            
            if (titleElement) {
                titleElement.innerHTML = title.includes('‚úèÔ∏è') ? title : `‚úèÔ∏è ${title}`;
            }
            
            if (subtitleElement) {
                subtitleElement.textContent = subtitle;
            }
        }

        // Back to plans function with enhanced debugging
        function backToPlans() {
            console.log('üîô Returning to plans list...');
            console.log('üìç Current section before:', document.querySelector('.content-section.active')?.id);
            
            // Clear any plan-specific data
            currentPlanId = null;
            
            // Try multiple approaches to ensure navigation works
            try {
                // Method 1: Hide current section and show target section directly
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });
                
                // Show payment plans section
                const paymentPlansSection = document.getElementById('payment-plans');
                if (paymentPlansSection) {
                    paymentPlansSection.classList.add('active');
                    paymentPlansSection.style.display = 'block';
                    console.log('‚úÖ Payment plans section shown directly');
                } else {
                    console.error('‚ùå Payment plans section not found');
                }
                
                // Method 2: Also try with showSection function
                if (typeof showSection === 'function') {
                    showSection('payment-plans');
                    console.log('‚úÖ Called showSection function');
                } else {
                    console.error('‚ùå showSection function not found');
                }
                
                // Method 3: Emergency navigation as fallback
                setTimeout(() => {
                    const currentSection = document.querySelector('.content-section.active');
                    if (!currentSection || currentSection.id !== 'payment-plans') {
                        console.log('üö® Normal navigation failed, using emergency method');
                        forceNavigateToPaymentPlans();
                    }
                }, 100);
                
                // Update navigation button state
                document.querySelectorAll('.nav-link').forEach(button => {
                    button.classList.remove('active');
                });
                
                const plansNavButton = document.querySelector('[data-page="payment-plans"]');
                if (plansNavButton) {
                    plansNavButton.classList.add('active');
                    console.log('‚úÖ Navigation button activated');
                } else {
                    console.error('‚ùå Navigation button not found');
                }
                
                // Refresh the plans list
                if (typeof loadPaymentPlansList === 'function') {
                    loadPaymentPlansList();
                    console.log('‚úÖ Plans list refreshed');
                }
                
                console.log('üìç Current section after:', document.querySelector('.content-section.active')?.id);
                
                // Show success message
                if (typeof showToast === 'function') {
                    showToast('Voltou para lista de planos', 'info');
                } else {
                    console.log('‚úÖ Voltou para lista de planos');
                }
                
            } catch (error) {
                console.error('‚ùå Error in backToPlans:', error);
                alert('Erro ao voltar para lista de planos. Veja o console para detalhes.');
            }
        }

        // Fun√ß√£o de teste para debug do salvamento
        function testSavePlanDebug() {
            console.log('üß™ ===== TESTE DE DEBUG DO SALVAMENTO =====');
            
            // Preencher campos obrigat√≥rios automaticamente
            const nameField = document.getElementById('editPlanName');
            const categoryField = document.getElementById('editPlanCategory');
            const priceField = document.getElementById('editPlanPrice');
            
            if (nameField) nameField.value = 'Plano Teste Debug';
            if (categoryField) categoryField.value = 'ADULT';
            if (priceField) priceField.value = '150';
            
            console.log('‚úÖ Campos obrigat√≥rios preenchidos automaticamente');
            
            // Tentar executar salvamento
            if (typeof savePlanChanges === 'function') {
                console.log('‚úÖ Fun√ß√£o savePlanChanges encontrada, executando...');
                savePlanChanges();
            } else {
                console.log('‚ùå Fun√ß√£o savePlanChanges n√£o encontrada');
            }
            
            console.log('üß™ ===== FIM DO TESTE =====');
        }

        async function savePlanChanges() {
            console.log('üíæ Iniciando salvamento de plano...');
            
            const form = document.getElementById('planEditForm');
            
            // Enhanced form mode detection
            const formMode = form?.dataset?.mode;
            const formEditingPlanId = form?.dataset?.editingPlanId;
            const globalCurrentPlanId = window.currentPlanId;
            
            // Determine if we're in create mode
            const isCreateMode = formMode === 'create';
            
            // Determine the current plan ID for edit mode
            const currentPlanId = formEditingPlanId || globalCurrentPlanId;
            
            console.log('üîç ID Resolution Debug:');
            console.log('  - formEditingPlanId:', formEditingPlanId);
            console.log('  - globalCurrentPlanId:', globalCurrentPlanId);
            console.log('  - Final currentPlanId:', currentPlanId);
            
            console.log('üìã Modo de opera√ß√£o:', isCreateMode ? 'Cria√ß√£o' : 'Edi√ß√£o');
            console.log('üìã Form encontrado:', !!form);
            
            // Enhanced debugging - log current status
            console.log('üîç Enhanced Debug - Current State:');
            console.log('- Form element:', form);
            console.log('- Form mode:', formMode);
            console.log('- Form editing plan ID:', formEditingPlanId);
            console.log('- Global current plan ID:', globalCurrentPlanId);
            console.log('- Final current plan ID:', currentPlanId);
            console.log('- isCreateMode:', isCreateMode);
            
            // Validate that we have a plan ID for edit mode
            if (!isCreateMode && !currentPlanId) {
                console.error('‚ùå Erro: Tentando editar plano sem ID v√°lido');
                showToast('Erro: ID do plano n√£o encontrado para edi√ß√£o', 'error');
                return;
            }
            
            // Helper function to safely get element value
            const safeGetValue = (elementId, defaultValue = '') => {
                const element = document.getElementById(elementId);
                return element ? element.value : defaultValue;
            };
            
            // Helper function to safely get checkbox state
            const safeGetChecked = (elementId, defaultValue = false) => {
                const element = document.getElementById(elementId);
                return element ? element.checked : defaultValue;
            };
            
            // Collect selected courses from the simplified interface
            const selectedCourseCheckboxes = document.querySelectorAll('#editCoursesGrid input[name="planCourses"]:checked');
            const selectedCourseIds = Array.from(selectedCourseCheckboxes).map(cb => cb.value);
            
            console.log('üéì Cursos selecionados:', selectedCourseIds);
            console.log('üéì Checkboxes encontradas:', selectedCourseCheckboxes.length);
            console.log('üéì Grid de cursos:', document.getElementById('editCoursesGrid'));
            
            // Debug: Log all form elements before collecting data
            console.log('üîç Debug - Verificando elementos do formul√°rio:');
            console.log('- editPlanMaxClasses:', document.getElementById('editPlanMaxClasses')?.value);
            console.log('- editPlanDuration:', document.getElementById('editPlanDuration')?.value);
            console.log('- editPlanGracePeriod:', document.getElementById('editPlanGracePeriod')?.value);
            console.log('- editPlanPersonalTraining:', document.getElementById('editPlanPersonalTraining')?.checked);
            console.log('- editPlanNotes:', document.getElementById('editPlanNotes')?.value);
            
            // Enhanced course data for API (moved before formData)
            const courseData = {
                primaryCourseId: selectedCourseIds.length > 0 ? selectedCourseIds[0] : null,
                allCourseIds: selectedCourseIds,
                courseCount: selectedCourseIds.length
            };
            
            console.log('üéì [SAVE_DEBUG] Checkboxes encontradas:', selectedCourseCheckboxes);
            console.log('üéì [SAVE_DEBUG] Dados de curso para API:', courseData);
            console.log('üéì [SAVE_DEBUG] IDs extra√≠dos:', selectedCourseIds);
            
            // Collect form data with correct field IDs
            const formData = {
                // Basic Information (Schema Fields)
                name: safeGetValue('editPlanName'),
                description: safeGetValue('editPlanDescription'),
                courseId: courseData.primaryCourseId,
                courseIds: selectedCourseIds, // Add courseIds at top level for backend compatibility
                category: safeGetValue('editPlanCategory'),
                price: parseFloat(safeGetValue('editPlanPrice', '0')),
                billingType: safeGetValue('editPlanBillingType', 'MONTHLY'),
                
                // Schema Fields - Advanced Configuration
                classesPerWeek: parseInt(safeGetValue('editPlanClassesPerWeek', '2')) || 2,
                maxClasses: safeGetValue('editPlanMaxClasses') ? parseInt(safeGetValue('editPlanMaxClasses')) : null,
                isUnlimitedAccess: safeGetChecked('editPlanFeatureAccess', true),
                
                // Schema Fields - Features
                hasPersonalTraining: safeGetChecked('editPlanPersonalTraining') || safeGetChecked('editPlanFeaturePersonal'),
                hasNutrition: safeGetChecked('editPlanNutrition') || safeGetChecked('editPlanFeatureNutrition'),
                accessAllModalities: safeGetChecked('editPlanAllModalities'),
                allowFreeze: safeGetChecked('editPlanFreezeOption'),
                freezeMaxDays: 30,
                
                // Schema Fields - Payment Configuration  
                allowInstallments: false,
                maxInstallments: 1,
                isRecurring: safeGetValue('editPlanBillingType', 'MONTHLY') === 'MONTHLY',
                recurringInterval: safeGetValue('editPlanBillingType', 'MONTHLY') === 'MONTHLY' ? 30 : null,
                
                // Schema Fields - Status
                isActive: safeGetChecked('editPlanIsActive', true),
                
                // Custom Features (JSON field) - Store additional configurations
                features: {
                    // Advanced Configuration (not in schema)
                    duration: safeGetValue('editPlanDuration') ? parseInt(safeGetValue('editPlanDuration')) : 12,
                    gracePeriod: safeGetValue('editPlanGracePeriod') ? parseInt(safeGetValue('editPlanGracePeriod')) : 5,
                    studentLimit: safeGetValue('editPlanStudentLimit') ? parseInt(safeGetValue('editPlanStudentLimit')) : null,
                    
                    // Extra Features (not in schema)
                    hasFullAccess: safeGetChecked('editPlanFeatureAccess'),
                    hasEquipmentAccess: safeGetChecked('editPlanFeatureEquipment'),
                    hasEventAccess: safeGetChecked('editPlanFeatureEvents'),
                    hasMaterialAccess: safeGetChecked('editPlanFeatureMaterial'),
                    
                    // Plan Configuration (not in schema)
                    allowUpgrade: safeGetChecked('editPlanAllowUpgrade'),
                    autoRenewal: safeGetChecked('editPlanAutoRenewal'),
                    notes: safeGetValue('editPlanNotes'),
                    
                    // Course Configuration
                    courseIds: selectedCourseIds
                }
            };
            
            // Debug: Log collected form data
            console.log('üìã Dados coletados do formul√°rio:', JSON.stringify(formData, null, 2));
            console.log('üìã Validando campos obrigat√≥rios...');
            console.log('- Nome:', formData.name || 'VAZIO');
            console.log('- Categoria:', formData.category || 'VAZIO');
            console.log('- Pre√ßo:', formData.price || 'VAZIO');
            
            // Validate required fields
            if (!formData.name || !formData.price) {
                showToast('Preencha todos os campos obrigat√≥rios (Nome e Pre√ßo)', 'error');
                return;
            }
            
            // Set default category if empty
            if (!formData.category) {
                formData.category = 'ADULT'; // Default category
                console.log('üìã Categoria definida como padr√£o: ADULT');
            }
            
            // Validate course selection (relaxed validation)
            if (selectedCourseIds.length === 0) {
                console.log('‚ö†Ô∏è Nenhum curso selecionado, mas permitindo salvamento');
                showToast('Aviso: Nenhum curso foi associado ao plano', 'warning');
                // Continue with saving instead of blocking
            } else {
                console.log(`‚úÖ ${selectedCourseIds.length} curso(s) selecionado(s)`);
                showToast(`${selectedCourseIds.length} curso(s) associado(s) ao plano`, 'success');
            }
            
            try {
                console.log('üöÄ Preparando para enviar dados para API...');
                console.log('üîç Debug - Dados que ser√£o enviados:', JSON.stringify(formData, null, 2));
                
                if (isCreateMode) {
                    console.log('‚ú® Modo cria√ß√£o - enviando para POST /api/billing-plans');
                    showToast('Criando novo plano...', 'info');
                    
                    console.log('üì° Fazendo requisi√ß√£o POST para /api/billing-plans');
                    
                    // Create new plan via API
                    const response = await fetch('/api/billing-plans', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    console.log('üì° Resposta recebida:', response.status, response.statusText);
                    
                    const result = await response.json();
                    console.log('üì° Dados da resposta:', result);
                    
                    if (response.ok && result.success) {
                        console.log('‚úÖ Plano criado com sucesso via API');
                        // Add to local array
                        allPlans.push(result.data);
                        showToast('Plano criado com sucesso!', 'success');
                    } else {
                        console.error('‚ùå Erro na resposta da API:', result);
                        throw new Error(result.message || result.error || 'Erro ao criar plano');
                    }
                    
                } else {
                    console.log('üîÑ Modo edi√ß√£o - enviando para PUT /api/billing-plans/' + currentPlanId);
                    console.log('üéì [SAVE_DEBUG] Cursos sendo enviados:', formData.features.courseIds);
                    console.log('üîç [SAVE_DEBUG] FormData completo antes do envio:', JSON.stringify(formData, null, 2));
                    showToast('Atualizando plano...', 'info');
                    
                    console.log('üì° Fazendo requisi√ß√£o PUT para /api/billing-plans/' + currentPlanId);
                    
                    // Update existing plan via API
                    const response = await fetch(`/api/billing-plans/${currentPlanId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    console.log('üì° Resposta recebida:', response.status, response.statusText);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('üì° Dados da resposta:', result);
                        
                        if (result.success) {
                            console.log('‚úÖ Plano atualizado com sucesso via API');
                            
                            // Update local data with the actual response data
                            const planIndex = allPlans.findIndex(p => p.id === currentPlanId);
                            if (planIndex !== -1) {
                                // Update with data from API response
                                allPlans[planIndex] = { ...allPlans[planIndex], ...result.data };
                                console.log('‚úÖ Local data updated with API response');
                            } else {
                                console.warn('‚ö†Ô∏è Plan not found in allPlans array for local update');
                            }
                            
                            showToast('Plano atualizado com sucesso!', 'success');
                        } else {
                            console.error('‚ùå Erro na resposta da API:', result);
                            throw new Error(result.message || 'Erro ao atualizar plano');
                        }
                    } else {
                        console.error('‚ùå Erro HTTP:', response.status, response.statusText);
                        throw new Error('Erro na API ao atualizar plano');
                    }
                }
                
                console.log('üîô Voltando para lista de planos...');
                // Go back to plans list and refresh
                backToPlans();
                console.log('‚úÖ Processo de salvamento conclu√≠do!');
                
            } catch (error) {
                console.error('üí• Erro durante salvamento:', error);
                console.error('üí• Stack trace:', error.stack);
                showToast(`Erro ao salvar plano: ${error.message}`, 'error');
            }
        }

        // Test function to debug the save plan process
        function testSavePlanDebugEnhanced() {
            console.log('üß¶ ===== TESTE DE DEBUG MELHORADO =====');
            
            // Test form presence
            const form = document.getElementById('planEditForm');
            console.log('1. Form encontrado:', !!form);
            
            if (!form) {
                console.error('‚ùå Form n√£o encontrado! Verifique se est√° na tela de edi√ß√£o de plano.');
                return;
            }
            
            console.log('2. Form mode:', form.dataset.mode);
            console.log('3. currentPlanId:', window.currentPlanId);
            
            // Test required fields
            const nameField = document.getElementById('editPlanName');
            const categoryField = document.getElementById('editPlanCategory');
            const priceField = document.getElementById('editPlanPrice');
            
            console.log('4. Campos obrigat√≥rios:');
            console.log('   - Nome:', nameField?.value || 'VAZIO');
            console.log('   - Categoria:', categoryField?.value || 'VAZIO');
            console.log('   - Pre√ßo:', priceField?.value || 'VAZIO');
            
            // Auto-fill if empty
            if (!nameField?.value) {
                nameField.value = 'Plano Teste Debug Enhanced';
                console.log('   ‚úÖ Nome preenchido automaticamente');
            }
            if (!categoryField?.value) {
                categoryField.value = 'ADULT';
                console.log('   ‚úÖ Categoria preenchida automaticamente');
            }
            if (!priceField?.value) {
                priceField.value = '199.99';
                console.log('   ‚úÖ Pre√ßo preenchido automaticamente');
            }
            
            console.log('5. Testando fun√ß√£o savePlanChanges...');
            
            if (typeof savePlanChanges === 'function') {
                console.log('   ‚úÖ Fun√ß√£o savePlanChanges encontrada');
                console.log('   üöÄ Executando savePlanChanges...');
                
                try {
                    savePlanChanges();
                    console.log('   ‚úÖ savePlanChanges executada sem erro s√≠ncrono');
                } catch (error) {
                    console.error('   ‚ùå Erro ao executar savePlanChanges:', error);
                }
            } else {
                console.error('   ‚ùå Fun√ß√£o savePlanChanges n√£o encontrada');
            }
        }
        
        // Test function to verify form state
        function testFormState() {
            console.log('üìã ===== TESTE DO ESTADO DO FORMUL√ÅRIO =====');
            
            const form = document.getElementById('planEditForm');
            if (!form) {
                console.error('‚ùå Form n√£o encontrado');
                return;
            }
            
            console.log('1. Form encontrado:', form);
            console.log('2. Form dataset:', form.dataset);
            console.log('3. Form mode:', form.dataset.mode);
            console.log('4. Editing plan ID:', form.dataset.editingPlanId);
            console.log('5. Global currentPlanId:', window.currentPlanId);
            
            // Test individual fields
            const nameField = document.getElementById('editPlanName');
            const categoryField = document.getElementById('editPlanCategory');
            const priceField = document.getElementById('editPlanPrice');
            
            console.log('6. Campos:');
            console.log('   - Nome:', nameField?.value);
            console.log('   - Categoria:', categoryField?.value);
            console.log('   - Pre√ßo:', priceField?.value);
            
            // Test if we can manually set form mode
            if (form.dataset.mode !== 'edit') {
                console.log('‚ö†Ô∏è Tentando definir modo de edi√ß√£o manualmente...');
                form.dataset.mode = 'edit';
                form.dataset.editingPlanId = 'test-plan-id';
                window.currentPlanId = 'test-plan-id';
                console.log('‚úÖ Modo definido manualmente');
            }
        }
        
        async function deleteCurrentPlan() {
            if (!currentPlanId) {
                showNotification('Erro: ID do plano n√£o encontrado', 'error');
                return;
            }
            
            const plan = allPlans.find(p => p.id == currentPlanId || p.id === currentPlanId);
            if (!plan) {
                console.error('‚ùå Current plan not found in allPlans array');
                console.error('üîç Searched for ID:', currentPlanId, 'Type:', typeof currentPlanId);
                console.error('üìã Available IDs:', allPlans.map(p => ({id: p.id, type: typeof p.id})));
                showNotification('Plano n√£o encontrado', 'error');
                return;
            }
            
            if (!confirm(`Tem certeza que deseja excluir o plano "${plan.name}"?`)) {
                return;
            }
            
            try {
                showNotification('Excluindo plano...', 'info');
                
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Remove from local data
                const planIndex = allPlans.findIndex(p => p.id === currentPlanId);
                if (planIndex !== -1) {
                    allPlans.splice(planIndex, 1);
                }
                
                showNotification('Plano exclu√≠do com sucesso!', 'success');
                
                // Go back to plans list and refresh
                backToPlans();
                updatePaymentPlansTable(allPlans);
                updatePlansStats(allPlans);
                
            } catch (error) {
                console.error('Error deleting plan:', error);
                showNotification('Erro ao excluir plano', 'error');
            }
        }

        // ==========================================
        // STUDENT SUBSCRIPTION TAB LOADER
        // ==========================================

        // Load student subscription tab content
        window.loadStudentSubscriptionTab = async function() {
            console.log('üí≥ Loading student subscription tab...');
            
            const container = document.getElementById('coursesContent');
            if (!container) {
                console.error('‚ùå coursesContent container not found');
                return;
            }

            // Show loading state
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #94A3B8;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üí≥</div>
                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Carregando dados da assinatura...</div>
                    <div style="font-size: 0.9rem; opacity: 0.7;">Conectando com a base de dados</div>
                </div>
            `;

            try {
                // Import and call the subscription function from students.js
                const { getCurrentStudentSubscriptionDetails } = await import('./js/students.js');
                const subscriptionDetails = await getCurrentStudentSubscriptionDetails();
                
                // Import and call the render function
                const studentsModule = await import('./js/students.js');
                if (studentsModule.renderStudentSubscriptionDetails) {
                    studentsModule.renderStudentSubscriptionDetails(subscriptionDetails, container);
                } else {
                    // Fallback to manual rendering
                    console.log('üìä Subscription details loaded:', subscriptionDetails);
                    
                    if (!subscriptionDetails.hasSubscription) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: #94A3B8;">
                                <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">üí≥</div>
                                <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">
                                    Nenhuma assinatura ativa
                                </div>
                                <div style="font-size: 0.875rem; margin-bottom: 2rem;">
                                    Este aluno n√£o possui uma assinatura de plano ativa
                                </div>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 1.5rem;">
                                <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">üí≥ Assinatura Ativa</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                    <div>
                                        <div style="color: #94A3B8; font-size: 0.875rem;">Plano</div>
                                        <div style="color: #F8FAFC; font-weight: 600;">${subscriptionDetails.plan?.name || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="color: #94A3B8; font-size: 0.875rem;">Status</div>
                                        <div style="color: #10B981; font-weight: 600;">${subscriptionDetails.paymentStatus}</div>
                                    </div>
                                    <div>
                                        <div style="color: #94A3B8; font-size: 0.875rem;">Valor</div>
                                        <div style="color: #10B981; font-weight: 600;">R$ ${parseFloat(subscriptionDetails.plan?.price || 0).toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                console.log('‚úÖ Student subscription tab loaded successfully');

            } catch (error) {
                console.error('‚ùå Error loading subscription tab:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #EF4444;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Erro ao carregar assinatura</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Verifique a conex√£o com o servidor</div>
                        <button onclick="window.loadStudentSubscriptionTab()" 
                                style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 1rem;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        };

        // Make renderStudentSubscriptionDetails globally available
        window.createSubscriptionForStudent = function() {
            console.log('‚ûï Creating subscription for current student...');
            // TODO: Open subscription creation modal with current student pre-selected
            if (window.openAddSubscriptionModal) {
                window.openAddSubscriptionModal();
                // Pre-select current student if possible
                const currentStudentId = window.currentEditingStudentId;
                if (currentStudentId) {
                    setTimeout(() => {
                        const studentSelect = document.getElementById('subscriptionStudent');
                        if (studentSelect) {
                            studentSelect.value = currentStudentId;
                        }
                    }, 500);
                }
            }
        };

        window.editStudentSubscription = function() {
            console.log('‚úèÔ∏è Editing subscription for current student...');
            // TODO: Open subscription edit modal
            showToast('Funcionalidade em desenvolvimento', 'info');
        };

        window.viewSubscriptionHistory = function() {
            console.log('üìä Viewing subscription history for current student...');
            // TODO: Show subscription payment history
            showToast('Funcionalidade em desenvolvimento', 'info');
        };

        window.viewCourseDetails = function(courseId) {
            console.log('üìñ Viewing course details:', courseId);
            // TODO: Open course details modal or navigate to course page
            showToast('Abrindo detalhes do curso...', 'info');
            // For now, redirect to courses management with course highlighted
            setTimeout(() => {
                showSection('courses');
                // TODO: Add course highlighting logic
            }, 500);
        };

        // ==========================================
        // SUBSCRIPTIONS MANAGEMENT
        // ==========================================

        // Note: allSubscriptions is already declared at line ~18118
        let allStudentsForSubscriptions = [];
        let allPlansForSubscriptions = [];

        // Load subscriptions list
        async function loadSubscriptionsList() {
            console.log('üîÑ Loading subscriptions list...');
            try {
                const loadingElement = document.getElementById('subscriptionsLoadingState');
                const emptyElement = document.getElementById('subscriptionsEmptyState');
                const tableContainer = document.querySelector('#subscriptions .table-container');
                
                if (loadingElement) loadingElement.style.display = 'block';
                if (emptyElement) emptyElement.style.display = 'none';
                if (tableContainer) tableContainer.style.display = 'none';

                // Fetch subscriptions data
                console.log('üì° Fetching subscriptions from API...');
                const subscriptionsResponse = await fetch('/api/subscriptions');
                
                if (subscriptionsResponse.ok) {
                    const subscriptionsData = await subscriptionsResponse.json();
                    allSubscriptions = subscriptionsData.data || [];
                    console.log('‚úÖ Subscriptions loaded:', allSubscriptions.length);
                } else {
                    console.warn('‚ö†Ô∏è Subscriptions API not available, using empty array');
                    allSubscriptions = [];
                }

                // Update UI
                updateSubscriptionsTable(allSubscriptions);
                updateSubscriptionsStats(allSubscriptions);
                updateSubscriptionsCount();

                if (loadingElement) loadingElement.style.display = 'none';
                
                if (allSubscriptions.length === 0) {
                    if (emptyElement) emptyElement.style.display = 'block';
                } else {
                    if (tableContainer) tableContainer.style.display = 'block';
                }

            } catch (error) {
                console.error('‚ùå Error loading subscriptions:', error);
                const loadingElement = document.getElementById('subscriptionsLoadingState');
                if (loadingElement) {
                    loadingElement.innerHTML = `
                        <div style="text-align: center; color: #EF4444; padding: 3rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Erro ao carregar assinaturas</div>
                            <div style="font-size: 0.9rem; opacity: 0.7;">Verifique a conex√£o com a API</div>
                        </div>
                    `;
                }
            }
        }

        // Update subscriptions table
        function updateSubscriptionsTable(subscriptions) {
            const tableBody = document.getElementById('subscriptionsTableBody');
            if (!tableBody) return;

            if (!subscriptions || subscriptions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #94A3B8; padding: 2rem;">Nenhuma assinatura encontrada</td></tr>';
                return;
            }

            tableBody.innerHTML = subscriptions.map(subscription => {
                const statusColors = {
                    'ACTIVE': '#10B981',
                    'PENDING': '#F59E0B',
                    'SUSPENDED': '#EF4444',
                    'CANCELLED': '#6B7280',
                    'EXPIRED': '#374151'
                };

                const statusLabels = {
                    'ACTIVE': 'Ativa',
                    'PENDING': 'Pendente',
                    'SUSPENDED': 'Suspensa',
                    'CANCELLED': 'Cancelada',
                    'EXPIRED': 'Expirada'
                };

                const paymentMethodLabels = {
                    'CREDIT_CARD': 'Cart√£o de Cr√©dito',
                    'DEBIT_CARD': 'Cart√£o de D√©bito',
                    'PIX': 'PIX',
                    'BANK_SLIP': 'Boleto',
                    'CASH': 'Dinheiro',
                    'BANK_TRANSFER': 'Transfer√™ncia'
                };

                return `
                    <tr style="cursor: pointer;" ondblclick="editSubscription('${subscription.id}')">
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #3B82F6, #1D4ED8); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem;">
                                    ${subscription.student?.firstName?.charAt(0) || '?'}${subscription.student?.lastName?.charAt(0) || ''}
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #F8FAFC;">${subscription.student?.firstName || 'N/A'} ${subscription.student?.lastName || ''}</div>
                                    <div style="font-size: 0.875rem; color: #94A3B8;">${subscription.student?.email || 'Email n√£o dispon√≠vel'}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #F8FAFC;">${subscription.plan?.name || 'Plano n√£o encontrado'}</div>
                            <div style="font-size: 0.875rem; color: #94A3B8;">${subscription.plan?.category || 'N/A'}</div>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #10B981; font-size: 1.1rem;">R$ ${parseFloat(subscription.plan?.price || 0).toFixed(2)}</div>
                        </td>
                        <td>
                            <span style="background: ${statusColors[subscription.status] || '#6B7280'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                                ${statusLabels[subscription.status] || subscription.status}
                            </span>
                        </td>
                        <td style="color: #CBD5E1;">${new Date(subscription.startDate).toLocaleDateString('pt-BR')}</td>
                        <td style="color: #CBD5E1;">${subscription.nextPaymentDate ? new Date(subscription.nextPaymentDate).toLocaleDateString('pt-BR') : 'N/A'}</td>
                        <td style="color: #CBD5E1;">${paymentMethodLabels[subscription.paymentMethod] || subscription.paymentMethod}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="editSubscription('${subscription.id}')" style="background: linear-gradient(135deg, #3B82F6, #1D4ED8); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="deleteSubscription('${subscription.id}')" style="background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;" title="Excluir">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update subscriptions stats
        function updateSubscriptionsStats(subscriptions) {
            const totalElement = document.getElementById('totalSubscriptionsCount');
            const activeElement = document.getElementById('activeSubscriptionsCount');
            const pendingElement = document.getElementById('pendingSubscriptionsCount');
            const revenueElement = document.getElementById('totalSubscriptionRevenue');

            if (totalElement) totalElement.textContent = subscriptions.length;
            
            const activeCount = subscriptions.filter(s => s.status === 'ACTIVE').length;
            if (activeElement) activeElement.textContent = activeCount;
            
            const pendingCount = subscriptions.filter(s => s.status === 'PENDING').length;
            if (pendingElement) pendingElement.textContent = pendingCount;
            
            const totalRevenue = subscriptions
                .filter(s => s.status === 'ACTIVE')
                .reduce((sum, s) => sum + parseFloat(s.plan?.price || 0), 0);
            if (revenueElement) revenueElement.textContent = `R$ ${totalRevenue.toFixed(2)}`;
        }

        // Update subscriptions count in menu
        function updateSubscriptionsCount() {
            const countElement = document.getElementById('subscriptions-count');
            if (countElement && allSubscriptions) {
                countElement.textContent = allSubscriptions.length;
            }
        }

        // Open add subscription modal
        async function openAddSubscriptionModal() {
            console.log('üîÑ Opening add subscription modal...');
            
            // Load students and plans for dropdowns
            await loadStudentsAndPlansForSubscriptions();
            
            // Clear form
            document.getElementById('subscriptionForm').reset();
            document.getElementById('subscriptionModalTitle').textContent = '‚ûï Nova Assinatura';
            document.getElementById('subscriptionForm').dataset.mode = 'add';
            
            // Set default start date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('subscriptionStartDate').value = today;
            
            // Show modal
            document.getElementById('subscriptionModal').style.display = 'block';
        }

        // Load students and plans for subscription form
        async function loadStudentsAndPlansForSubscriptions() {
            try {
                // Load students
                const studentsResponse = await fetch('/api/students');
                if (studentsResponse.ok) {
                    const studentsData = await studentsResponse.json();
                    allStudentsForSubscriptions = studentsData.data || [];
                    
                    const studentSelect = document.getElementById('subscriptionStudent');
                    studentSelect.innerHTML = '<option value="">Selecione um aluno</option>' +
                        allStudentsForSubscriptions.map(student => 
                            `<option value="${student.id}">${student.user.firstName} ${student.user.lastName} - ${student.user.email}</option>`
                        ).join('');
                }

                // Load plans
                const plansResponse = await fetch('/api/financial/plans');
                if (plansResponse.ok) {
                    const plansData = await plansResponse.json();
                    allPlansForSubscriptions = plansData.data || [];
                    
                    const planSelect = document.getElementById('subscriptionPlan');
                    const planFilter = document.getElementById('subscriptionPlanFilter');
                    
                    const planOptions = allPlansForSubscriptions.map(plan => 
                        `<option value="${plan.id}">${plan.name} - R$ ${parseFloat(plan.price).toFixed(2)} (${plan.category})</option>`
                    ).join('');
                    
                    planSelect.innerHTML = '<option value="">Selecione um plano</option>' + planOptions;
                    planFilter.innerHTML = '<option value="">Todos Planos</option>' + planOptions;
                }
                
            } catch (error) {
                console.error('Error loading students and plans:', error);
            }
        }

        // Update subscription plan details display
        function updateSubscriptionPlanDetails() {
            const planSelect = document.getElementById('subscriptionPlan');
            const planDetailsDiv = document.getElementById('subscriptionPlanDetails');
            const planDetailsContent = document.getElementById('planDetailsContent');
            
            const selectedPlanId = planSelect.value;
            
            if (!selectedPlanId) {
                planDetailsDiv.style.display = 'none';
                return;
            }
            
            const selectedPlan = allPlansForSubscriptions.find(plan => plan.id === selectedPlanId);
            
            if (selectedPlan) {
                planDetailsContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <strong>üí∞ Valor:</strong> R$ ${parseFloat(selectedPlan.price).toFixed(2)}
                        </div>
                        <div>
                            <strong>üìÇ Categoria:</strong> ${selectedPlan.category}
                        </div>
                        <div>
                            <strong>üîÑ Cobran√ßa:</strong> ${selectedPlan.billingType || 'N/A'}
                        </div>
                        <div>
                            <strong>‚è±Ô∏è Dura√ß√£o:</strong> ${selectedPlan.duration || 'N/A'} meses
                        </div>
                    </div>
                    ${selectedPlan.description ? `<div style="margin-top: 0.5rem;"><strong>üìù Descri√ß√£o:</strong> ${selectedPlan.description}</div>` : ''}
                `;
                planDetailsDiv.style.display = 'block';
            }
        }

        // Close subscription modal
        function closeSubscriptionModal() {
            document.getElementById('subscriptionModal').style.display = 'none';
        }

        // Edit subscription
        async function editSubscription(subscriptionId) {
            console.log('‚úèÔ∏è Editing subscription:', subscriptionId);
            
            const subscription = allSubscriptions.find(s => s.id === subscriptionId);
            if (!subscription) {
                showToast('Assinatura n√£o encontrada', 'error');
                return;
            }
            
            // Load students and plans for dropdowns
            await loadStudentsAndPlansForSubscriptions();
            
            // Populate form with subscription data
            document.getElementById('subscriptionStudent').value = subscription.studentId;
            document.getElementById('subscriptionPlan').value = subscription.planId;
            document.getElementById('subscriptionStartDate').value = subscription.startDate.split('T')[0];
            document.getElementById('subscriptionPaymentMethod').value = subscription.paymentMethod;
            document.getElementById('subscriptionPaymentDay').value = subscription.paymentDay || '';
            document.getElementById('subscriptionStatus').value = subscription.status;
            document.getElementById('subscriptionNotes').value = subscription.notes || '';
            
            // Update modal title and mode
            document.getElementById('subscriptionModalTitle').textContent = '‚úèÔ∏è Editar Assinatura';
            document.getElementById('subscriptionForm').dataset.mode = 'edit';
            document.getElementById('subscriptionForm').dataset.subscriptionId = subscriptionId;
            
            // Update plan details display
            updateSubscriptionPlanDetails();
            
            // Show modal
            document.getElementById('subscriptionModal').style.display = 'block';
        }

        // Delete subscription
        async function deleteSubscription(subscriptionId) {
            const subscription = allSubscriptions.find(s => s.id === subscriptionId);
            if (!subscription) {
                showToast('Assinatura n√£o encontrada', 'error');
                return;
            }
            
            const studentName = subscription.student ? `${subscription.student.firstName} ${subscription.student.lastName}` : 'Aluno desconhecido';
            
            if (!confirm(`Tem certeza que deseja excluir a assinatura de ${studentName}?`)) {
                return;
            }
            
            try {
                showToast('Excluindo assinatura...', 'info');
                
                const response = await fetch(`/api/subscriptions/${subscriptionId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('Assinatura exclu√≠da com sucesso!', 'success');
                    await loadSubscriptionsList(); // Reload list
                } else {
                    throw new Error('Erro na API ao excluir assinatura');
                }
                
            } catch (error) {
                console.error('Error deleting subscription:', error);
                showToast('Erro ao excluir assinatura', 'error');
            }
        }

        // Handle subscription form submission
        document.addEventListener('DOMContentLoaded', function() {
            const subscriptionForm = document.getElementById('subscriptionForm');
            if (subscriptionForm) {
                subscriptionForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const mode = this.dataset.mode;
                    const subscriptionId = this.dataset.subscriptionId;
                    
                    const subscriptionData = {
                        studentId: document.getElementById('subscriptionStudent').value,
                        planId: document.getElementById('subscriptionPlan').value,
                        startDate: document.getElementById('subscriptionStartDate').value,
                        paymentMethod: document.getElementById('subscriptionPaymentMethod').value,
                        paymentDay: document.getElementById('subscriptionPaymentDay').value || null,
                        status: document.getElementById('subscriptionStatus').value,
                        notes: document.getElementById('subscriptionNotes').value || null
                    };
                    
                    try {
                        showToast(mode === 'add' ? 'Criando assinatura...' : 'Atualizando assinatura...', 'info');
                        
                        const url = mode === 'add' ? '/api/subscriptions' : `/api/subscriptions/${subscriptionId}`;
                        const method = mode === 'add' ? 'POST' : 'PUT';
                        
                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(subscriptionData)
                        });
                        
                        if (response.ok) {
                            showToast(mode === 'add' ? 'Assinatura criada com sucesso!' : 'Assinatura atualizada com sucesso!', 'success');
                            closeSubscriptionModal();
                            await loadSubscriptionsList(); // Reload list
                        } else {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Erro na API');
                        }
                        
                    } catch (error) {
                        console.error('Error saving subscription:', error);
                        showToast('Erro ao salvar assinatura: ' + error.message, 'error');
                    }
                });
            }
        });

        // Filter subscriptions
        function filterSubscriptions() {
            const searchTerm = document.getElementById('subscriptionSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('subscriptionStatusFilter').value;
            const planFilter = document.getElementById('subscriptionPlanFilter').value;
            
            const filteredSubscriptions = allSubscriptions.filter(subscription => {
                const matchesSearch = !searchTerm || 
                    subscription.student?.firstName?.toLowerCase().includes(searchTerm) ||
                    subscription.student?.lastName?.toLowerCase().includes(searchTerm) ||
                    subscription.student?.email?.toLowerCase().includes(searchTerm) ||
                    subscription.plan?.name?.toLowerCase().includes(searchTerm);
                    
                const matchesStatus = !statusFilter || subscription.status === statusFilter;
                const matchesPlan = !planFilter || subscription.planId === planFilter;
                
                return matchesSearch && matchesStatus && matchesPlan;
            });
            
            updateSubscriptionsTable(filteredSubscriptions);
        }

    </script>
</body>
</html>