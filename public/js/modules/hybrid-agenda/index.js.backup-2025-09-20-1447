/**
 * Hybrid Agenda Module - AGENTS.md Compliant
 * Multi-file structure following Activities template
 * 
 * Features:
 * - Unified modal system for create/edit
 * - Premium UI components
 * - AcademyApp integration
 * - API-first design
 * - Loading/Empty/Error states
 */

// Module state and dependencies
let moduleAPI = null;
let currentView = 'calendar';
let currentDate = new Date();
let agendaData = [];
let stats = {};

class HybridAgendaModule {
    constructor() {
        this.name = 'hybrid-agenda';
        this.version = '2.0.0';
        this.controllers = {};
        this.services = {};
        this.views = {};
        this.isInitialized = false;
    }

    async initialize(container, route) {
        try {
            console.log('ğŸ›ï¸ Initializing Hybrid Agenda Module (AGENTS.md compliant)...', this.name);
            console.log('ğŸ”§ Container received:', container);
            console.log('ğŸ”§ Route received:', route);

            if (!container) {
                throw new Error('Container element is required');
            }

            // Initialize API client following AGENTS.md patterns
            await this.initializeAPI();

            // Handle different routes (SPA integration from simple.js)
            const routeParts = route ? route.split('/') : [];
            
            if (routeParts.length > 2) {
                const action = routeParts[2]; // edit, details
                const itemId = routeParts[3];
                
                switch (action) {
                    case 'edit':
                        return await this.renderEditPage(container, itemId);
                    case 'details':
                        return await this.renderDetailsPage(container, itemId);
                    default:
                        break;
                }
            }

            // Render main interface with Premium UI
            await this.renderMainInterface(container);

            // Setup event listeners
            this.setupEventListeners();

            // Load initial data
            await this.loadInitialData();

            // AcademyApp integration
            this.registerWithAcademyApp();

            this.isInitialized = true;
            console.log('âœ… Hybrid Agenda Module initialized successfully');

            // Dispatch module loaded event (from simple.js)
            if (window.app) {
                window.app.dispatchEvent('module:loaded', { name: 'hybrid-agenda' });
            }

            return this;

        } catch (error) {
            console.error('âŒ Failed to initialize Hybrid Agenda Module:', error);
            window.app?.handleError(error, 'hybrid-agenda-init');
            throw error;
        }
    }

    async initializeAPI() {
        console.log('ğŸ”§ Initializing API...');
        
        // Check for API client (AGENTS.md requirement)
        console.log('ğŸ”§ Checking for API client...');
        console.log('ğŸ”§ window.createModuleAPI:', typeof window.createModuleAPI);

        if (typeof window.createModuleAPI !== 'function') {
            console.log('â³ Waiting for API client...');
            await this.waitForAPIClient();
        }

        console.log('âœ… Creating module API...');
        moduleAPI = window.createModuleAPI('HybridAgenda');
        console.log('âœ… Module API created:', moduleAPI.constructor.name);
        console.log('âœ… API initialized successfully');
    }

    async waitForAPIClient() {
        return new Promise((resolve) => {
            const checkAPI = () => {
                if (typeof window.createModuleAPI === 'function') {
                    resolve();
                } else {
                    setTimeout(checkAPI, 100);
                }
            };
            checkAPI();
        });
    }

    async renderMainInterface(container) {
        console.log('ğŸ”§ Rendering main interface with Premium UI...');

        container.innerHTML = this.getMainHTML();
        
        console.log('âœ… Main interface rendered');
    }

    getMainHTML() {
        return `
            <div class="module-isolated-hybrid-agenda">
                <!-- Premium Header (AGENTS.md requirement) -->
                <div class="module-header-premium">
                    <div class="header-content">
                        <div class="header-title">
                            <h2>ğŸ›ï¸ Agenda HÃ­brida</h2>
                            <p>GestÃ£o unificada de turmas e personal training</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn-primary create-agenda-btn" onclick="hybridAgenda.showUnifiedModal()">
                                â• Criar Agendamento
                            </button>
                        </div>
                    </div>
                    
                    <!-- Breadcrumb Navigation -->
                    <div class="breadcrumb-nav">
                        <span class="breadcrumb-item active">ğŸ“… Agenda</span>
                    </div>
                </div>

                <!-- Enhanced Stats Cards (AGENTS.md requirement) -->
                <div class="stats-container">
                    <div class="stat-card-enhanced" data-stat="turmas">
                        <div class="stat-icon">ğŸ¥‹</div>
                        <div class="stat-content">
                            <div class="stat-number" id="stat-turmas">0</div>
                            <div class="stat-label">Turmas</div>
                        </div>
                    </div>
                    <div class="stat-card-enhanced" data-stat="personal">
                        <div class="stat-icon">ğŸ‘¤</div>
                        <div class="stat-content">
                            <div class="stat-number" id="stat-personal">0</div>
                            <div class="stat-label">Personal Training</div>
                        </div>
                    </div>
                    <div class="stat-card-enhanced" data-stat="instructors">
                        <div class="stat-icon">ğŸ‘¨â€ğŸ«</div>
                        <div class="stat-content">
                            <div class="stat-number" id="stat-instructors">0</div>
                            <div class="stat-label">Instrutores</div>
                        </div>
                    </div>
                </div>

                <!-- View Switcher -->
                <div class="view-switcher">
                    <button class="view-switcher-btn active" data-view="calendar" onclick="hybridAgenda.switchView('calendar')">
                        ğŸ“… CalendÃ¡rio
                    </button>
                    <button class="view-switcher-btn" data-view="list" onclick="hybridAgenda.switchView('list')">
                        ğŸ“‹ Lista
                    </button>
                </div>

                <!-- Loading State -->
                <div id="agenda-loading" class="loading-state" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Carregando agenda...</p>
                </div>

                <!-- Empty State -->
                <div id="agenda-empty" class="empty-state" style="display: none;">
                    <div class="empty-icon">ğŸ“…</div>
                    <h3>Nenhum agendamento encontrado</h3>
                    <p>Crie o primeiro agendamento para comeÃ§ar</p>
                    <button class="btn-primary" onclick="hybridAgenda.showUnifiedModal()">
                        â• Criar Agendamento
                    </button>
                </div>

                <!-- Error State -->
                <div id="agenda-error" class="error-state" style="display: none;">
                    <div class="error-icon">âš ï¸</div>
                    <h3>Erro ao carregar agenda</h3>
                    <p id="error-message">Ocorreu um erro inesperado</p>
                    <button class="btn-secondary" onclick="hybridAgenda.reload()">
                        ğŸ”„ Tentar Novamente
                    </button>
                </div>

                <!-- Main Content -->
                <div id="agenda-content" class="agenda-content">
                    <!-- Content will be rendered here -->
                </div>
            </div>
        `;
    }

    setupEventListeners() {
        console.log('ğŸ”§ Setting up event listeners...');
        
        // Click delegation for agenda items
        document.addEventListener('click', (event) => {
            // Handle agenda item clicks
            const agendaItem = event.target.closest('.agenda-item');
            if (agendaItem) {
                const itemId = agendaItem.dataset.id;
                const itemType = agendaItem.dataset.type;
                this.handleAgendaItemClick(itemId, itemType);
                return;
            }
        });

        console.log('âœ… Event listeners set up');
    }

    async loadInitialData() {
        console.log('ğŸ”§ Loading initial data...');
        
        try {
            // Show loading state
            this.showLoadingState();

            // Load agenda data and stats in parallel
            await Promise.all([
                this.loadAgendaData(),
                this.loadStats()
            ]);

            // Hide loading and show content
            this.hideLoadingState();
            this.renderCurrentView();

        } catch (error) {
            console.error('âŒ Failed to load initial data:', error);
            this.showErrorState(error);
            window.app?.handleError(error, 'hybrid-agenda-load');
        }
    }

    async loadAgendaData() {
        try {
            const response = await moduleAPI.fetchWithStates('/api/hybrid-agenda', {
                onSuccess: (response) => {
                    console.log('âœ… Agenda data loaded:', response);
                    
                    if (response && response.items && Array.isArray(response.items)) {
                        agendaData = response.items;
                        
                        // Check for empty state
                        if (agendaData.length === 0) {
                            this.showEmptyState();
                            return;
                        }
                    } else {
                        console.warn('âš ï¸ Unexpected API response format:', response);
                        agendaData = [];
                        this.showEmptyState();
                        return;
                    }
                },
                onError: (error) => {
                    console.error('âŒ Failed to load agenda data:', error);
                    throw error;
                }
            });
        } catch (error) {
            console.error('Error loading agenda data:', error);
            throw error;
        }
    }

    async loadStats() {
        try {
            const response = await moduleAPI.fetchWithStates('/api/hybrid-agenda', {
                onSuccess: (response) => {
                    console.log('âœ… Stats loaded:', response);
                    
                    if (response && response.summary) {
                        const summary = response.summary;
                        stats = {
                            turmas: { total: summary.totalTurmas || 0 },
                            personalSessions: { total: summary.totalPersonalSessions || 0 },
                            instructors: { active: summary.totalInstructors || 0 }
                        };
                        
                        this.updateStatsDisplay();
                    }
                },
                onError: (error) => {
                    console.error('âŒ Failed to load stats:', error);
                }
            });
        } catch (error) {
            console.error('Error loading stats:', error);
            // Stats failure is not critical
        }
    }

    updateStatsDisplay() {
        const turmasEl = document.getElementById('stat-turmas');
        const personalEl = document.getElementById('stat-personal');
        const instructorsEl = document.getElementById('stat-instructors');

        if (turmasEl) turmasEl.textContent = stats.turmas?.total || 0;
        if (personalEl) personalEl.textContent = stats.personalSessions?.total || 0;
        if (instructorsEl) instructorsEl.textContent = stats.instructors?.active || 0;
    }

    async loadInitialData() {
        await Promise.all([
            this.loadAgendaData(),
            this.loadStats()
        ]);
        this.renderCurrentView();
    }

    async loadAgendaData() {
        const startDate = this.getWeekStart(this.currentDate).toISOString();
        const endDate = this.getWeekEnd(this.currentDate).toISOString();
        
        const params = {
            startDate,
            endDate,
            ...this.selectedFilters
        };

        await this.api.fetchWithStates('/api/hybrid-agenda', {
            method: 'GET',
            loadingElement: document.getElementById('agenda-container'),
            onSuccess: (data) => {
                this.agendaData = data.items || [];
                this.renderCurrentView();
            },
            onEmpty: () => {
                this.showEmptyState();
            },
            onError: (error) => {
                this.showErrorState(error);
            }
        });
    }

    async loadStats() {
        const dateStr = this.currentDate.toISOString().split('T')[0];
        
        await this.api.fetchWithStates(`/api/hybrid-agenda/stats?date=${dateStr}`, {
            method: 'GET',
            onSuccess: (data) => {
                this.stats = data;
                this.renderStats();
            }
        });
    }

    renderCurrentView() {
        const container = document.getElementById('agenda-container');
        if (!container) return;

        switch (this.currentView) {
            case 'calendar':
                this.renderCalendarView(container);
                break;
            case 'list':
                this.renderListView(container);
                break;
            case 'timeline':
                this.renderTimelineView(container);
                break;
            default:
                this.renderCalendarView(container);
        }
    }

    renderCalendarView(container) {
        const calendarHtml = `
            <div class="module-isolated-hybrid-agenda">
                ${this.renderHeader()}
                ${this.renderFilters()}
                ${this.renderStats()}
                
                <div class="calendar-view">
                    <div class="calendar-header">
                        <button class="date-nav-btn" data-direction="prev">â€¹</button>
                        <h3 class="current-week">${this.formatWeekRange()}</h3>
                        <button class="date-nav-btn" data-direction="next">â€º</button>
                    </div>
                    
                    <div class="calendar-grid">
                        ${this.renderWeekDays()}
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = calendarHtml;
    }

    renderListView(container) {
        const listHtml = `
            <div class="module-isolated-hybrid-agenda">
                ${this.renderHeader()}
                ${this.renderFilters()}
                ${this.renderStats()}
                
                <div class="list-view">
                    <div class="agenda-list">
                        ${this.agendaData.map(item => this.renderAgendaItem(item)).join('')}
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = listHtml;
    }

    renderTimelineView(container) {
        const timelineHtml = `
            <div class="module-isolated-hybrid-agenda">
                ${this.renderHeader()}
                ${this.renderFilters()}
                ${this.renderStats()}
                
                <div class="timeline-view">
                    <div class="timeline-header">
                        <div class="timeline-hours">
                            ${this.renderTimelineHours()}
                        </div>
                    </div>
                    
                    <div class="timeline-content">
                        ${this.renderTimelineItems()}
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = timelineHtml;
    }

    renderHeader() {
        return `
            <div class="module-header-premium">
                <div class="module-header-content">
                    <div class="module-title-section">
                        <h1>ğŸ“… Agenda HÃ­brida</h1>
                        <p class="module-subtitle">GestÃ£o unificada de turmas e personal training</p>
                    </div>
                    
                    <div class="module-actions">
                        <div class="view-switcher">
                            <button class="view-switcher-btn ${this.currentView === 'calendar' ? 'active' : ''}" data-view="calendar">
                                ğŸ“… CalendÃ¡rio
                            </button>
                            <button class="view-switcher-btn ${this.currentView === 'list' ? 'active' : ''}" data-view="list">
                                ğŸ“‹ Lista
                            </button>
                            <button class="view-switcher-btn ${this.currentView === 'timeline' ? 'active' : ''}" data-view="timeline">
                                â° Timeline
                            </button>
                        </div>
                        
                        <button class="btn-primary create-agenda-btn">
                            â• Criar Agendamento
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    renderFilters() {
        return `
            <div class="module-filters-premium">
                <div class="filter-group">
                    <label>Tipo:</label>
                    <select class="filter-select" data-filter="type">
                        <option value="">Todos</option>
                        <option value="TURMA" ${this.selectedFilters.type === 'TURMA' ? 'selected' : ''}>Turmas</option>
                        <option value="PERSONAL_SESSION" ${this.selectedFilters.type === 'PERSONAL_SESSION' ? 'selected' : ''}>Personal Training</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Status:</label>
                    <select class="filter-select" data-filter="status">
                        <option value="">Todos</option>
                        <option value="SCHEDULED" ${this.selectedFilters.status === 'SCHEDULED' ? 'selected' : ''}>Agendado</option>
                        <option value="CONFIRMED" ${this.selectedFilters.status === 'CONFIRMED' ? 'selected' : ''}>Confirmado</option>
                        <option value="IN_PROGRESS" ${this.selectedFilters.status === 'IN_PROGRESS' ? 'selected' : ''}>Em Andamento</option>
                        <option value="COMPLETED" ${this.selectedFilters.status === 'COMPLETED' ? 'selected' : ''}>ConcluÃ­do</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Data:</label>
                    <input type="date" id="agenda-date-picker" class="filter-input" 
                           value="${this.currentDate.toISOString().split('T')[0]}">
                </div>
            </div>
        `;
    }

    renderStats() {
        if (!this.stats || Object.keys(this.stats).length === 0) {
            return '';
        }

        return `
            <div class="stats-container">
                <div class="stat-card-enhanced turmas-stat">
                    <div class="stat-icon">ğŸ«</div>
                    <div class="stat-content">
                        <div class="stat-number">${this.stats.turmas?.total || 0}</div>
                        <div class="stat-label">Turmas</div>
                    </div>
                </div>
                
                <div class="stat-card-enhanced personal-stat">
                    <div class="stat-icon">ğŸ‘¤</div>
                    <div class="stat-content">
                        <div class="stat-number">${this.stats.personalSessions?.total || 0}</div>
                        <div class="stat-label">Personal Training</div>
                    </div>
                </div>
                
                <div class="stat-card-enhanced instructors-stat">
                    <div class="stat-icon">ğŸ‘¨â€ğŸ«</div>
                    <div class="stat-content">
                        <div class="stat-number">${this.stats.instructors?.active || 0}</div>
                        <div class="stat-label">Instrutores Ativos</div>
                    </div>
                </div>
                
                <div class="stat-card-enhanced utilization-stat">
                    <div class="stat-icon">ğŸ“Š</div>
                    <div class="stat-content">
                        <div class="stat-number">${this.stats.facilities?.utilizationRate || 0}%</div>
                        <div class="stat-label">Taxa de UtilizaÃ§Ã£o</div>
                    </div>
                </div>
            </div>
        `;
    }

    renderWeekDays() {
        const weekStart = this.getWeekStart(this.currentDate);
        const days = [];
        
        for (let i = 0; i < 7; i++) {
            const day = new Date(weekStart);
            day.setDate(weekStart.getDate() + i);
            
            const dayItems = this.agendaData.filter(item => {
                const itemDate = new Date(item.startTime);
                return itemDate.toDateString() === day.toDateString();
            });
            
            days.push(`
                <div class="calendar-day">
                    <div class="day-header">
                        <div class="day-name">${this.getDayName(day)}</div>
                        <div class="day-number">${day.getDate()}</div>
                    </div>
                    
                    <div class="day-items">
                        ${dayItems.map(item => this.renderDayItem(item)).join('')}
                    </div>
                </div>
            `);
        }
        
        return days.join('');
    }

    renderDayItem(item) {
        const startTime = new Date(item.startTime);
        const typeClass = item.type === 'TURMA' ? 'turma-item' : 'personal-item';
        
        return `
            <div class="day-item ${typeClass} agenda-item" data-id="${item.id}" data-type="${item.type}">
                <div class="item-time">${startTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
                <div class="item-title">${item.title}</div>
                <div class="item-instructor">${item.instructor?.name || 'N/A'}</div>
                <div class="item-status status-${item.status.toLowerCase()}">${this.getStatusLabel(item.status)}</div>
            </div>
        `;
    }

    renderAgendaItem(item) {
        const startTime = new Date(item.startTime);
        const endTime = new Date(item.endTime);
        const typeClass = item.type === 'TURMA' ? 'turma-item' : 'personal-item';
        const typeIcon = item.type === 'TURMA' ? 'ğŸ«' : 'ğŸ‘¤';
        
        return `
            <div class="data-card-premium agenda-item ${typeClass}" data-id="${item.id}" data-type="${item.type}">
                <div class="agenda-item-header">
                    <div class="agenda-item-type">
                        <span class="type-icon">${typeIcon}</span>
                        <span class="type-label">${item.type === 'TURMA' ? 'Turma' : 'Personal Training'}</span>
                    </div>
                    <div class="agenda-item-status status-${item.status.toLowerCase()}">
                        ${this.getStatusLabel(item.status)}
                    </div>
                </div>
                
                <div class="agenda-item-content">
                    <h3 class="agenda-item-title">${item.title}</h3>
                    <p class="agenda-item-description">${item.description || ''}</p>
                    
                    <div class="agenda-item-details">
                        <div class="detail-group">
                            <span class="detail-icon">â°</span>
                            <span class="detail-text">
                                ${startTime.toLocaleString('pt-BR')} - ${endTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                            </span>
                        </div>
                        
                        <div class="detail-group">
                            <span class="detail-icon">ğŸ‘¨â€ğŸ«</span>
                            <span class="detail-text">${item.instructor?.name || 'N/A'}</span>
                        </div>
                        
                        <div class="detail-group">
                            <span class="detail-icon">ğŸ“</span>
                            <span class="detail-text">${item.trainingArea?.name || 'N/A'}</span>
                        </div>
                        
                        <div class="detail-group">
                            <span class="detail-icon">ğŸ‘¥</span>
                            <span class="detail-text">${item.actualStudents}/${item.maxStudents} alunos</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    renderTimelineHours() {
        const hours = [];
        for (let hour = 6; hour <= 22; hour++) {
            hours.push(`
                <div class="timeline-hour">
                    ${hour.toString().padStart(2, '0')}:00
                </div>
            `);
        }
        return hours.join('');
    }

    renderTimelineItems() {
        const todayItems = this.agendaData.filter(item => {
            const itemDate = new Date(item.startTime);
            return itemDate.toDateString() === this.currentDate.toDateString();
        });

        return todayItems.map(item => {
            const startTime = new Date(item.startTime);
            const endTime = new Date(item.endTime);
            const startHour = startTime.getHours();
            const startMinute = startTime.getMinutes();
            const duration = (endTime - startTime) / (1000 * 60); // em minutos
            
            const top = ((startHour - 6) * 60 + startMinute) * 1; // 1px por minuto
            const height = duration * 1; // 1px por minuto
            
            const typeClass = item.type === 'TURMA' ? 'turma-timeline' : 'personal-timeline';
            
            return `
                <div class="timeline-item ${typeClass} agenda-item" 
                     data-id="${item.id}" 
                     data-type="${item.type}"
                     style="top: ${top}px; height: ${height}px;">
                    <div class="timeline-item-content">
                        <div class="timeline-item-title">${item.title}</div>
                        <div class="timeline-item-time">
                            ${startTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} - 
                            ${endTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                        </div>
                        <div class="timeline-item-instructor">${item.instructor?.name || 'N/A'}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Event Handlers
    handleViewSwitch(view) {
        this.currentView = view;
        this.renderCurrentView();
        
        // Update active button
        document.querySelectorAll('.view-switcher-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === view);
        });
    }

    handleFilterToggle(filterElement) {
        const filterType = filterElement.dataset.filter;
        const filterValue = filterElement.value;
        
        this.selectedFilters[filterType] = filterValue;
        this.loadAgendaData();
    }

    async handleAgendaItemClick(itemId, itemType) {
        console.log('ğŸ¯ Agenda item clicked:', itemId, itemType);
        
        try {
            // Load item data for editing
            const response = await moduleAPI.request(`/api/hybrid-agenda/${itemId}`);
            if (response.success && response.data) {
                // Use unified modal for editing (consolidated from simple.js)
                this.showUnifiedModal(response.data);
            } else {
                throw new Error('Falha ao carregar dados do item');
            }
        } catch (error) {
            console.error('âŒ Error loading item for edit:', error);
            window.app?.handleError(error, 'hybrid-agenda-item-load');
        }
    }

    handleCreateAgenda() {
        this.showCreateAgendaModal();
    }

    handleDateNavigation(direction) {
        if (direction === 'prev') {
            this.currentDate.setDate(this.currentDate.getDate() - 7);
        } else if (direction === 'next') {
            this.currentDate.setDate(this.currentDate.getDate() + 7);
        }
        
        this.loadAgendaData();
        this.loadStats();
    }

    handleDateChange(dateValue) {
        this.currentDate = new Date(dateValue);
        this.loadAgendaData();
        this.loadStats();
    }

    // Navigation methods (AGENTS.md: Full-screen pages, no modals)
    navigateToTurmaDetails(turmaId) {
        console.log('ğŸ”§ Navigating to turma details:', turmaId);
        this.showTurmaDetailsPage(turmaId);
    }

    navigateToPersonalSessionDetails(sessionId) {
        console.log('ğŸ”§ Navigating to personal session details:', sessionId);
        this.showPersonalSessionDetailsPage(sessionId);
    }

    async showTurmaDetailsPage(turmaId) {
        const container = document.getElementById('agenda-container');
        if (!container) return;

        try {
            // Show loading state
            container.innerHTML = this.getLoadingStateHTML('Carregando detalhes da turma...');

            // Fetch turma details
            const response = await moduleAPI.request(`/api/turmas/${turmaId}`);
            
            if (response.success && response.data) {
                container.innerHTML = this.getTurmaDetailsPageHTML(response.data);
                this.setupTurmaDetailsEvents(turmaId);
            } else {
                throw new Error('Turma nÃ£o encontrada');
            }

        } catch (error) {
            console.error('âŒ Error loading turma details:', error);
            container.innerHTML = this.getErrorStateHTML('Erro ao carregar detalhes da turma', error.message);
            window.app?.handleError(error, 'turma-details-load');
        }
    }

    async showPersonalSessionDetailsPage(sessionId) {
        const container = document.getElementById('agenda-container');
        if (!container) return;

        try {
            // Show loading state
            container.innerHTML = this.getLoadingStateHTML('Carregando detalhes da sessÃ£o...');

            // Fetch session details
            const response = await moduleAPI.request(`/api/personal-sessions/${sessionId}`);
            
            if (response.success && response.data) {
                container.innerHTML = this.getPersonalSessionDetailsPageHTML(response.data);
                this.setupPersonalSessionDetailsEvents(sessionId);
            } else {
                throw new Error('SessÃ£o nÃ£o encontrada');
            }

        } catch (error) {
            console.error('âŒ Error loading session details:', error);
            container.innerHTML = this.getErrorStateHTML('Erro ao carregar detalhes da sessÃ£o', error.message);
            window.app?.handleError(error, 'session-details-load');
        }
    }

    getTurmaDetailsPageHTML(turma) {
        return `
            <div class="module-isolated-hybrid-agenda">
                <!-- Premium Header with Breadcrumb -->
                <div class="module-header-premium">
                    <div class="breadcrumb-nav">
                        <span class="breadcrumb-item" onclick="hybridAgenda.backToMain()">ğŸ›ï¸ Agenda HÃ­brida</span>
                        <span class="breadcrumb-separator">â†’</span>
                        <span class="breadcrumb-item active">Turma: ${turma.title}</span>
                    </div>
                    <div class="header-content">
                        <div class="header-title">
                            <h2>ğŸ‘¥ ${turma.title}</h2>
                            <p>Detalhes da aula coletiva</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn-secondary" onclick="hybridAgenda.backToMain()">
                                â† Voltar
                            </button>
                            <button class="btn-primary" onclick="hybridAgenda.editTurma('${turma.id}')">
                                âœï¸ Editar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Details Card -->
                <div class="details-full-screen">
                    <div class="details-card-premium">
                        <div class="details-header" style="background: var(--gradient-primary);">
                            <div class="details-title">
                                <div class="details-icon">ğŸ‘¥</div>
                                <div>
                                    <h2>${turma.title}</h2>
                                    <p>${turma.description || 'Aula coletiva de Krav Maga'}</p>
                                </div>
                            </div>
                            <div class="status-badge status-${turma.status.toLowerCase()}">
                                ${this.getStatusLabel(turma.status)}
                            </div>
                        </div>
                        
                        <div class="details-content">
                            <div class="details-grid">
                                <div class="detail-item">
                                    <span class="detail-label">ğŸ“… Data</span>
                                    <span class="detail-value">${this.formatDateForDisplay(turma.date)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">â° HorÃ¡rio</span>
                                    <span class="detail-value">${turma.startTime} - ${turma.endTime}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">â±ï¸ DuraÃ§Ã£o</span>
                                    <span class="detail-value">${turma.duration} minutos</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">ğŸ‘¨â€ğŸ« Instrutor</span>
                                    <span class="detail-value">${turma.instructor?.name || 'NÃ£o definido'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">ğŸ‘¥ Alunos</span>
                                    <span class="detail-value">${turma.currentStudents || 0}/${turma.maxStudents || 0}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">ğŸ“ Local</span>
                                    <span class="detail-value">${turma.trainingArea?.name || 'NÃ£o definido'}</span>
                                </div>
                            </div>
                            
                            ${turma.description ? `
                                <div class="detail-description">
                                    <h3>DescriÃ§Ã£o</h3>
                                    <p>${turma.description}</p>
                                </div>
                            ` : ''}
                            
                            <div class="details-actions">
                                <button class="btn-secondary" onclick="hybridAgenda.backToMain()">
                                    â† Voltar Ã  Agenda
                                </button>
                                <button class="btn-primary" onclick="hybridAgenda.editTurma('${turma.id}')">
                                    âœï¸ Editar Turma
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    getPersonalSessionDetailsPageHTML(session) {
        return `
            <div class="module-isolated-hybrid-agenda">
                <!-- Premium Header with Breadcrumb -->
                <div class="module-header-premium">
                    <div class="breadcrumb-nav">
                        <span class="breadcrumb-item" onclick="hybridAgenda.backToMain()">ğŸ›ï¸ Agenda HÃ­brida</span>
                        <span class="breadcrumb-separator">â†’</span>
                        <span class="breadcrumb-item active">Personal: ${session.title}</span>
                    </div>
                    <div class="header-content">
                        <div class="header-title">
                            <h2>ğŸƒâ€â™‚ï¸ ${session.title}</h2>
                            <p>Detalhes da sessÃ£o personal</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn-secondary" onclick="hybridAgenda.backToMain()">
                                â† Voltar
                            </button>
                            <button class="btn-primary" onclick="hybridAgenda.editPersonalSession('${session.id}')">
                                âœï¸ Editar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Details Card -->
                <div class="details-full-screen">
                    <div class="details-card-premium">
                        <div class="details-header" style="background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);">
                            <div class="details-title">
                                <div class="details-icon">ğŸƒâ€â™‚ï¸</div>
                                <div>
                                    <h2>${session.title}</h2>
                                    <p>${session.description || 'SessÃ£o personal de Krav Maga'}</p>
                                </div>
                            </div>
                            <div class="status-badge status-${session.status.toLowerCase()}">
                                ${this.getStatusLabel(session.status)}
                            </div>
                        </div>
                        
                        <div class="details-content">
                            <div class="details-grid">
                                <div class="detail-item">
                                    <span class="detail-label">ğŸ“… Data</span>
                                    <span class="detail-value">${this.formatDateForDisplay(session.date)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">â° HorÃ¡rio</span>
                                    <span class="detail-value">${session.startTime} - ${session.endTime}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">â±ï¸ DuraÃ§Ã£o</span>
                                    <span class="detail-value">${session.duration} minutos</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">ğŸ‘¨â€ğŸ« Instrutor</span>
                                    <span class="detail-value">${session.instructor?.name || 'NÃ£o definido'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">ğŸ‘¤ Aluno</span>
                                    <span class="detail-value">${session.student?.name || 'NÃ£o definido'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">ğŸ“ Local</span>
                                    <span class="detail-value">${session.trainingArea?.name || 'NÃ£o definido'}</span>
                                </div>
                            </div>
                            
                            ${session.description ? `
                                <div class="detail-description">
                                    <h3>DescriÃ§Ã£o</h3>
                                    <p>${session.description}</p>
                                </div>
                            ` : ''}
                            
                            <div class="details-actions">
                                <button class="btn-secondary" onclick="hybridAgenda.backToMain()">
                                    â† Voltar Ã  Agenda
                                </button>
                                <button class="btn-primary" onclick="hybridAgenda.editPersonalSession('${session.id}')">
                                    âœï¸ Editar SessÃ£o
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    setupTurmaDetailsEvents(turmaId) {
        // Setup any specific event handlers for turma details page
        console.log('ğŸ”§ Setting up turma details events for:', turmaId);
    }

    setupPersonalSessionDetailsEvents(sessionId) {
        // Setup any specific event handlers for personal session details page
        console.log('ğŸ”§ Setting up personal session details events for:', sessionId);
    }

    editTurma(turmaId) {
        console.log('ğŸ”§ Editing turma:', turmaId);
        // TODO: Implement turma editing page (full-screen)
        this.showUnifiedModal(); // For now, use unified modal
    }

    editPersonalSession(sessionId) {
        console.log('ğŸ”§ Editing personal session:', sessionId);
        // TODO: Implement personal session editing page (full-screen)
        this.showUnifiedModal(); // For now, use unified modal
    }

    getLoadingStateHTML(message = 'Carregando...') {
        return `
            <div class="module-isolated-hybrid-agenda">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <h3>${message}</h3>
                </div>
            </div>
        `;
    }

    getErrorStateHTML(title, message) {
        return `
            <div class="module-isolated-hybrid-agenda">
                <div class="error-state">
                    <div class="error-icon">âš ï¸</div>
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <button class="btn-secondary" onclick="hybridAgenda.backToMain()">
                        â† Voltar Ã  Agenda
                    </button>
                </div>
            </div>
        `;
    }

    showCreateAgendaModal() {
        this.showSchedulingOptions(new Date(), '09:00');
    }

    // Agenda Scheduler Integration
    showSchedulingOptions(date, time) {
        const schedulingMenu = this.createSchedulingMenu(date, time);
        
        // Posicionar menu no centro da tela
        schedulingMenu.style.position = 'fixed';
        schedulingMenu.style.top = '50%';
        schedulingMenu.style.left = '50%';
        schedulingMenu.style.transform = 'translate(-50%, -50%)';
        schedulingMenu.style.zIndex = '2000';
        
        document.body.appendChild(schedulingMenu);
        
        // Remover menu ao clicar fora
        setTimeout(() => {
            document.addEventListener('click', (e) => {
                if (!schedulingMenu.contains(e.target)) {
                    schedulingMenu.remove();
                }
            }, { once: true });
        }, 100);
    }

    createSchedulingMenu(date, time) {
        const menu = document.createElement('div');
        menu.className = 'scheduling-menu module-isolated-hybrid-agenda';
        
        const dateStr = typeof date === 'string' ? date : date.toISOString().split('T')[0];
        
        menu.innerHTML = `
            <div class="scheduling-menu-content">
                <div class="scheduling-menu-header">
                    <h4>ğŸ—“ï¸ Agendar para ${this.formatDateForDisplay(dateStr)} Ã s ${time}</h4>
                </div>
                <div class="scheduling-options">
                    <button class="scheduling-option personal-training" 
                            data-type="personal" data-date="${dateStr}" data-time="${time}">
                        <div class="option-icon">ğŸ‘¤</div>
                        <div class="option-content">
                            <div class="option-title">Personal Training</div>
                            <div class="option-description">SessÃ£o individual com aluno especÃ­fico</div>
                        </div>
                    </button>
                    
                    <button class="scheduling-option collective-class" 
                            data-type="collective" data-date="${dateStr}" data-time="${time}">
                        <div class="option-icon">ğŸ¥‹</div>
                        <div class="option-content">
                            <div class="option-title">Aula Coletiva</div>
                            <div class="option-description">Turma com mÃºltiplos alunos</div>
                        </div>
                    </button>
                    
                    <button class="scheduling-option event-workshop" 
                            data-type="event" data-date="${dateStr}" data-time="${time}">
                        <div class="option-icon">ğŸ¯</div>
                        <div class="option-content">
                            <div class="option-title">Evento/Workshop</div>
                            <div class="option-description">Atividade especial ou treinamento</div>
                        </div>
                    </button>
                </div>
                <div class="scheduling-menu-footer">
                    <button class="btn-secondary close-menu-btn">Cancelar</button>
                </div>
            </div>
        `;
        
        // Event listeners para as opÃ§Ãµes
        menu.querySelectorAll('.scheduling-option').forEach(option => {
            option.addEventListener('click', (e) => {
                const type = option.dataset.type;
                const optionDate = option.dataset.date;
                const optionTime = option.dataset.time;
                
                this.startSchedulingFlow(type, optionDate, optionTime);
                menu.remove();
            });
        });

        // Event listener para botÃ£o de cancelar
        menu.querySelector('.close-menu-btn').addEventListener('click', () => {
            menu.remove();
        });
        
        return menu;
    }

    async startSchedulingFlow(type, date, time) {
        try {
            switch (type) {
                case 'personal':
                    await this.schedulePersonalTraining(date, time);
                    break;
                case 'collective':
                    await this.scheduleCollectiveClass(date, time);
                    break;
                case 'event':
                    await this.scheduleEvent(date, time);
                    break;
                default:
                    throw new Error(`Tipo de agendamento nÃ£o reconhecido: ${type}`);
            }
        } catch (error) {
            console.error('âŒ Error starting scheduling flow:', error);
            if (window.app) {
                window.app.handleError(error, 'HybridAgenda.startSchedulingFlow');
            }
        }
    }

    async schedulePersonalTraining(date, time) {
        const formData = await this.showPersonalTrainingForm(date, time);
        
        if (formData) {
            await this.createPersonalSession(formData);
        }
    }

    async scheduleCollectiveClass(date, time) {
        const formData = await this.showCollectiveClassForm(date, time);
        
        if (formData) {
            await this.createCollectiveClass(formData);
        }
    }

    async scheduleEvent(date, time) {
        alert('Funcionalidade de eventos serÃ¡ implementada em breve!');
    }

    async showPersonalTrainingForm(date, time) {
        return new Promise((resolve) => {
            const formContainer = this.createFormContainer('Personal Training', date, time);
            
            formContainer.innerHTML = `
                <form class="scheduling-form personal-training-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ğŸ‘¥ Aluno *</label>
                            <select name="studentId" required>
                                <option value="">Selecione o aluno...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ğŸ‘¨â€ğŸ« Instrutor *</label>
                            <select name="instructorId" required>
                                <option value="">Selecione o instrutor...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ğŸ“ Curso</label>
                            <select name="courseId">
                                <option value="">Selecione o curso...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ğŸ“ Local</label>
                            <select name="trainingAreaId">
                                <option value="">Selecione o local...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>â±ï¸ DuraÃ§Ã£o (minutos)</label>
                            <input type="number" name="duration" value="60" min="30" max="180" step="15">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>ğŸ“ ObservaÃ§Ãµes</label>
                            <textarea name="notes" placeholder="ObservaÃ§Ãµes sobre a sessÃ£o..."></textarea>
                        </div>
                        
                        <input type="hidden" name="date" value="${date}">
                        <input type="hidden" name="time" value="${time}">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary cancel-btn">Cancelar</button>
                        <button type="submit" class="btn-primary">ğŸ“… Agendar Personal</button>
                    </div>
                </form>
            `;
            
            this.setupFormHandlers(formContainer, resolve);
            this.loadFormDependencies(formContainer);
        });
    }

    async showCollectiveClassForm(date, time) {
        return new Promise((resolve) => {
            const formContainer = this.createFormContainer('Aula Coletiva', date, time);
            
            formContainer.innerHTML = `
                <form class="scheduling-form collective-class-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ğŸ·ï¸ Nome da Turma *</label>
                            <input type="text" name="turmaName" required 
                                   placeholder="Ex: Krav Maga Iniciante - TerÃ§a 19h">
                        </div>
                        
                        <div class="form-group">
                            <label>ğŸ‘¨â€ğŸ« Instrutor *</label>
                            <select name="instructorId" required>
                                <option value="">Selecione o instrutor...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ğŸ“ Curso *</label>
                            <select name="courseId" required>
                                <option value="">Selecione o curso...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ğŸ“ Local</label>
                            <select name="trainingAreaId">
                                <option value="">Selecione o local...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ğŸ‘¥ Capacidade MÃ¡xima</label>
                            <input type="number" name="maxStudents" value="20" min="1" max="50">
                        </div>
                        
                        <div class="form-group">
                            <label>â±ï¸ DuraÃ§Ã£o (minutos)</label>
                            <input type="number" name="duration" value="60" min="30" max="180" step="15">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>ğŸ“ DescriÃ§Ã£o</label>
                            <textarea name="description" placeholder="DescriÃ§Ã£o da turma..."></textarea>
                        </div>
                        
                        <input type="hidden" name="date" value="${date}">
                        <input type="hidden" name="time" value="${time}">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary cancel-btn">Cancelar</button>
                        <button type="submit" class="btn-primary">ğŸ¥‹ Criar Turma</button>
                    </div>
                </form>
            `;
            
            this.setupFormHandlers(formContainer, resolve);
            this.loadFormDependencies(formContainer);
        });
    }

    createFormContainer(title, date, time) {
        // Remove formulÃ¡rio existente se houver
        const existingForm = document.querySelector('.scheduling-form-overlay');
        if (existingForm) {
            existingForm.remove();
        }
        
        const overlay = document.createElement('div');
        overlay.className = 'scheduling-form-overlay module-isolated-hybrid-agenda';
        
        const displayDate = this.formatDateForDisplay(date);
        
        overlay.innerHTML = `
            <div class="scheduling-form-container">
                <div class="form-header">
                    <h3>ğŸ“… ${title}</h3>
                    <p class="form-subtitle">${displayDate} Ã s ${time}</p>
                    <button class="close-btn" type="button">Ã—</button>
                </div>
                <div class="form-content">
                    <!-- ConteÃºdo serÃ¡ inserido aqui -->
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Event listener para fechar
        overlay.querySelector('.close-btn').addEventListener('click', () => {
            overlay.remove();
        });
        
        return overlay.querySelector('.form-content');
    }

    setupFormHandlers(formContainer, resolve) {
        const form = formContainer.querySelector('form');
        const cancelBtn = formContainer.querySelector('.cancel-btn');
        const overlay = formContainer.closest('.scheduling-form-overlay');
        
        // Cancel button
        cancelBtn?.addEventListener('click', () => {
            overlay.remove();
            resolve(null);
        });
        
        // Form submission
        form?.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            overlay.remove();
            resolve(data);
        });
    }

    async loadFormDependencies(formContainer) {
        try {
            // Mock data para desenvolvimento - na implementaÃ§Ã£o real, faria requests para as APIs
            const mockStudents = [
                { id: 'student-1', name: 'Lorraine C S M Barbosa Claudio' },
                { id: 'student-2', name: 'JoÃ£o Silva' },
                { id: 'student-3', name: 'Maria Santos' }
            ];
            
            const mockInstructors = [
                { id: 'instructor-1', name: 'Prof. Marcus Silva' },
                { id: 'instructor-2', name: 'Prof. Amanda Santos' },
                { id: 'instructor-3', name: 'Prof. Carlos Lima' }
            ];
            
            const mockCourses = [
                { id: 'course-1', name: 'Krav Maga Iniciante' },
                { id: 'course-2', name: 'Krav Maga IntermediÃ¡rio' },
                { id: 'course-3', name: 'Krav Maga AvanÃ§ado' }
            ];
            
            const mockTrainingAreas = [
                { id: 'area-1', name: 'Tatame Principal' },
                { id: 'area-2', name: 'Sala Personal' },
                { id: 'area-3', name: 'Ãrea Externa' }
            ];
            
            // Popular select de alunos
            const studentSelect = formContainer.querySelector('select[name="studentId"]');
            if (studentSelect) {
                mockStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    studentSelect.appendChild(option);
                });
            }
            
            // Popular select de instrutores
            const instructorSelect = formContainer.querySelector('select[name="instructorId"]');
            if (instructorSelect) {
                mockInstructors.forEach(instructor => {
                    const option = document.createElement('option');
                    option.value = instructor.id;
                    option.textContent = instructor.name;
                    instructorSelect.appendChild(option);
                });
            }
            
            // Popular select de cursos
            const courseSelect = formContainer.querySelector('select[name="courseId"]');
            if (courseSelect) {
                mockCourses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.name;
                    courseSelect.appendChild(option);
                });
            }
            
            // Popular select de Ã¡reas de treinamento
            const areaSelect = formContainer.querySelector('select[name="trainingAreaId"]');
            if (areaSelect) {
                mockTrainingAreas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    areaSelect.appendChild(option);
                });
            }
            
        } catch (error) {
            console.error('âŒ Error loading form dependencies:', error);
            if (window.app) {
                window.app.handleError(error, 'HybridAgenda.loadFormDependencies');
            }
        }
    }

    async createPersonalSession(formData) {
        try {
            const sessionData = {
                studentId: formData.studentId,
                instructorId: formData.instructorId,
                courseId: formData.courseId || null,
                trainingAreaId: formData.trainingAreaId || null,
                scheduledDate: `${formData.date}T${formData.time}:00.000Z`,
                duration: parseInt(formData.duration) || 60,
                notes: formData.notes || '',
                status: 'SCHEDULED',
                type: 'PERSONAL'
            };
            
            // Mock success - na implementaÃ§Ã£o real faria request para API
            console.log('Creating personal session:', sessionData);
            
            this.showSuccessMessage('Personal Training agendado com sucesso!');
            
            // Simular adiÃ§Ã£o no calendÃ¡rio
            this.addMockSessionToCalendar(sessionData, 'PERSONAL_SESSION');
            
        } catch (error) {
            console.error('âŒ Error creating personal session:', error);
            if (window.app) {
                window.app.handleError(error, 'HybridAgenda.createPersonalSession');
            }
        }
    }

    async createCollectiveClass(formData) {
        try {
            const classData = {
                title: formData.turmaName,
                courseId: formData.courseId,
                instructorId: formData.instructorId,
                trainingAreaId: formData.trainingAreaId,
                scheduledDate: `${formData.date}T${formData.time}:00.000Z`,
                duration: parseInt(formData.duration) || 60,
                maxStudents: parseInt(formData.maxStudents) || 20,
                description: formData.description || '',
                type: 'COLLECTIVE',
                status: 'SCHEDULED'
            };
            
            // Mock success - na implementaÃ§Ã£o real faria request para API
            console.log('Creating collective class:', classData);
            
            this.showSuccessMessage('Aula coletiva agendada com sucesso!');
            
            // Simular adiÃ§Ã£o no calendÃ¡rio
            this.addMockSessionToCalendar(classData, 'TURMA');
            
        } catch (error) {
            console.error('âŒ Error creating collective class:', error);
            if (window.app) {
                window.app.handleError(error, 'HybridAgenda.createCollectiveClass');
            }
        }
    }

    addMockSessionToCalendar(sessionData, type) {
        // Adiciona sessÃ£o mockup aos dados do calendÃ¡rio
        const mockItem = {
            id: `mock-${Date.now()}`,
            type: type,
            referenceId: `ref-${Date.now()}`,
            title: sessionData.title || `${type === 'PERSONAL_SESSION' ? 'Personal Training' : 'Aula Coletiva'}`,
            description: sessionData.notes || sessionData.description || '',
            startTime: sessionData.scheduledDate,
            endTime: new Date(new Date(sessionData.scheduledDate).getTime() + (sessionData.duration * 60000)).toISOString(),
            instructor: { name: 'Instrutor Selecionado' },
            unit: { name: 'Unidade Centro' },
            trainingArea: { name: 'Local Selecionado' },
            status: 'SCHEDULED',
            maxStudents: type === 'PERSONAL_SESSION' ? 1 : (sessionData.maxStudents || 20),
            actualStudents: 0,
            isRecurring: false,
            color: type === 'PERSONAL_SESSION' ? '#764ba2' : '#667eea'
        };
        
        // Adicionar aos dados existentes
        this.agendaData.push(mockItem);
        
        // Re-renderizar vista atual
        this.renderCurrentView();
    }

    showSuccessMessage(message) {
        // Criar toast de sucesso
        const toast = document.createElement('div');
        toast.className = 'success-toast module-isolated-hybrid-agenda';
        toast.innerHTML = `
            <div class="toast-content">
                <div class="toast-icon">âœ…</div>
                <div class="toast-message">${message}</div>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Remover apÃ³s 3 segundos
        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    formatDateForDisplay(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR', {
            weekday: 'long',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    // Utility methods
    getWeekStart(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Domingo = 0, entÃ£o ajustamos para segunda
        return new Date(d.setDate(diff));
    }

    getWeekEnd(date) {
        const weekStart = this.getWeekStart(date);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        return weekEnd;
    }

    formatWeekRange() {
        const start = this.getWeekStart(this.currentDate);
        const end = this.getWeekEnd(this.currentDate);
        
        return `${start.toLocaleDateString('pt-BR')} - ${end.toLocaleDateString('pt-BR')}`;
    }

    getDayName(date) {
        const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
        return days[date.getDay()];
    }

    getStatusLabel(status) {
        const statusLabels = {
            'SCHEDULED': 'Agendado',
            'CONFIRMED': 'Confirmado',
            'IN_PROGRESS': 'Em Andamento',
            'COMPLETED': 'ConcluÃ­do',
            'CANCELLED': 'Cancelado',
            'POSTPONED': 'Adiado'
        };
        
        return statusLabels[status] || status;
    }

    showEmptyState() {
        const container = document.getElementById('agenda-container');
        if (container) {
            container.innerHTML = `
                <div class="module-isolated-hybrid-agenda">
                    ${this.renderHeader()}
                    ${this.renderFilters()}
                    
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“…</div>
                        <h3>Nenhum agendamento encontrado</h3>
                        <p>NÃ£o hÃ¡ turmas ou sessÃµes de personal training agendadas para este perÃ­odo.</p>
                        <button class="btn-primary create-agenda-btn">
                            â• Criar Primeiro Agendamento
                        </button>
                    </div>
                </div>
            `;
        }
    }

    showErrorState(error) {
        const container = document.getElementById('agenda-container');
        if (container) {
            container.innerHTML = `
                <div class="module-isolated-hybrid-agenda">
                    ${this.renderHeader()}
                    
                    <div class="error-state">
                        <div class="error-state-icon">âš ï¸</div>
                        <h3>Erro ao carregar agenda</h3>
                        <p>Ocorreu um erro ao carregar os dados da agenda.</p>
                        <button class="btn-secondary" onclick="location.reload()">
                            ğŸ”„ Tentar Novamente
                        </button>
                    </div>
                </div>
            `;
        }
        
        if (window.app) {
            window.app.handleError(error, 'hybrid-agenda-load');
        }
    }

    // ==================== UNIFIED MODAL (FULL-SCREEN PAGE) ====================
    // Following AGENTS.md: No modals, use full-screen pages instead
    // Supports both create and edit modes (consolidated from simple.js)
    showUnifiedModal(editData = null) {
        const isEditMode = !!editData;
        const modeText = isEditMode ? 'Editar' : 'Criar';
        const modeIcon = isEditMode ? 'âœï¸' : 'â•';
        
        console.log(`ğŸ”§ Showing unified ${isEditMode ? 'edit' : 'create'} page (full-screen)...`);
        
        const container = document.getElementById('agenda-container');
        if (!container) {
            console.error('âŒ Container not found');
            return;
        }

        container.innerHTML = this.getUnifiedCreatePageHTML(editData, isEditMode, modeText, modeIcon);
        this.setupUnifiedFormEvents(editData, isEditMode);
        this.loadUnifiedFormData(editData);
    }

    getUnifiedCreatePageHTML(editData = null, isEditMode = false, modeText = 'Criar', modeIcon = 'â•') {
        const formTitle = isEditMode ? `${modeIcon} ${modeText} Agendamento` : `${modeIcon} ${modeText} Novo Agendamento`;
        const formSubtitle = isEditMode ? 'Edite os dados do agendamento' : 'Agende uma sessÃ£o personal ou aula coletiva';
        const hiddenIdField = isEditMode ? `<input type="hidden" name="id" value="${editData.id}">` : '';
        
        // Set default values for edit mode
        const defaultType = editData ? editData.type : 'PERSONAL_SESSION';
        const defaultTitle = editData ? editData.title : '';
        const defaultDescription = editData ? editData.description || '' : '';
        const defaultDate = editData ? new Date(editData.startTime).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
        const defaultTime = editData ? new Date(editData.startTime).toTimeString().slice(0, 5) : '';
        const defaultDuration = editData ? Math.round((new Date(editData.endTime) - new Date(editData.startTime)) / (1000 * 60)) : 60;
        
        return `
            <div class="module-isolated-hybrid-agenda">
                <!-- Premium Header with Breadcrumb (AGENTS.md requirement) -->
                <div class="module-header-premium">
                    <div class="breadcrumb-nav">
                        <span class="breadcrumb-item" onclick="hybridAgenda.backToMain()">ğŸ›ï¸ Agenda HÃ­brida</span>
                        <span class="breadcrumb-separator">â†’</span>
                        <span class="breadcrumb-item active">${formTitle}</span>
                    </div>
                    <div class="header-content">
                        <div class="header-title">
                            <h2>âœ¨ ${formTitle}</h2>
                            <p>${formSubtitle}</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn-secondary" onclick="hybridAgenda.backToMain()">
                                â† Voltar
                            </button>
                            ${isEditMode ? `
                                <button class="btn-danger" onclick="hybridAgenda.deleteAgendaItem('${editData.id}')">
                                    ğŸ—‘ï¸ Excluir
                                </button>
                            ` : ''}
                        </div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Creation/Edit Form -->
                <div class="unified-form-container">
                    <form id="unified-agenda-form" class="unified-form">
                        ${hiddenIdField}
                        
                        <!-- Type Selection -->
                        <div class="form-section">
                            <h3>ğŸ“‹ Tipo de Agendamento</h3>
                            <div class="type-selector">
                                <label class="type-option data-card-premium">
                                    <input type="radio" name="type" value="PERSONAL_SESSION" 
                                           ${defaultType === 'PERSONAL_SESSION' ? 'checked' : ''} 
                                           ${isEditMode ? 'disabled' : ''} 
                                           onchange="hybridAgenda.toggleFormFields()">
                                    <span class="type-card">
                                        <div class="type-icon">ğŸƒâ€â™‚ï¸</div>
                                        <strong>Personal Training</strong>
                                        <small>SessÃ£o individual com instrutor</small>
                                    </span>
                                </label>
                                <label class="type-option data-card-premium">
                                    <input type="radio" name="type" value="TURMA" 
                                           ${defaultType === 'TURMA' ? 'checked' : ''} 
                                           ${isEditMode ? 'disabled' : ''} 
                                           onchange="hybridAgenda.toggleFormFields()">
                                    <span class="type-card">
                                        <div class="type-icon">ğŸ‘¥</div>
                                        <strong>Aula Coletiva</strong>
                                        <small>Turma com mÃºltiplos alunos</small>
                                    </span>
                                </label>
                            </div>
                            ${isEditMode ? `<input type="hidden" name="type" value="${defaultType}">` : ''}
                        </div>
                        
                        <!-- Basic Information -->
                        <div class="form-section">
                            <h3>ğŸ“ InformaÃ§Ãµes BÃ¡sicas</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="title">TÃ­tulo *</label>
                                    <input type="text" id="title" name="title" required class="form-input" value="${defaultTitle}">
                                </div>
                                
                                <div class="form-group full-width">
                                    <label for="description">DescriÃ§Ã£o</label>
                                    <textarea id="description" name="description" rows="3" class="form-textarea">${defaultDescription}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Date & Time -->
                        <div class="form-section">
                            <h3>ğŸ“… Data e HorÃ¡rio</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="date">Data *</label>
                                    <input type="date" id="date" name="date" required class="form-input" value="${defaultDate}">
                                </div>
                                <div class="form-group">
                                    <label for="startTime">HorÃ¡rio *</label>
                                    <input type="time" id="startTime" name="startTime" required class="form-input" value="${defaultTime}">
                                </div>
                                <div class="form-group">
                                    <label for="duration">DuraÃ§Ã£o *</label>
                                    <select id="duration" name="duration" required class="form-select">
                                        <option value="30" ${defaultDuration === 30 ? 'selected' : ''}>30 min</option>
                                        <option value="45" ${defaultDuration === 45 ? 'selected' : ''}>45 min</option>
                                        <option value="60" ${defaultDuration === 60 ? 'selected' : ''}>60 min</option>
                                        <option value="90" ${defaultDuration === 90 ? 'selected' : ''}>90 min</option>
                                        <option value="120" ${defaultDuration === 120 ? 'selected' : ''}>120 min</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Assignment -->
                        <div class="form-section">
                            <h3>ğŸ‘¨â€ğŸ« AtribuiÃ§Ã£o</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="instructorId">Instrutor *</label>
                                    <select id="instructorId" name="instructorId" required class="form-select">
                                        <option value="">Carregando...</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="unitId">Unidade</label>
                                    <select id="unitId" name="unitId" class="form-select">
                                        <option value="">Carregando...</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="trainingAreaId">Ãrea de Treino</label>
                                    <select id="trainingAreaId" name="trainingAreaId" class="form-select">
                                        <option value="">Carregando...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status -->
                        <div class="form-section">
                            <h3>ğŸ“Š Status e ConfiguraÃ§Ãµes</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="status">Status</label>
                                    <select id="status" name="status" class="form-select">
                                        <option value="SCHEDULED" selected>Agendado</option>
                                        <option value="CONFIRMED">Confirmado</option>
                                        <option value="CANCELLED">Cancelado</option>
                                        <option value="COMPLETED">ConcluÃ­do</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="recurring">RecorrÃªncia</label>
                                    <select id="recurring" name="recurring" class="form-select">
                                        <option value="false">Agendamento Ãºnico</option>
                                        <option value="weekly">Semanal</option>
                                        <option value="monthly">Mensal</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Turma-specific fields -->
                        <div id="turma-fields" class="form-section" style="display: none;">
                            <h3>ğŸ‘¥ ConfiguraÃ§Ãµes da Turma</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="maxStudents">MÃ¡ximo de Alunos *</label>
                                    <input type="number" id="maxStudents" name="maxStudents" min="1" max="50" value="10" class="form-input">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="form-actions">
                            <button type="button" onclick="hybridAgenda.backToMain()" class="btn-secondary">
                                â† Cancelar
                            </button>
                            <button type="submit" class="btn-primary">
                                âœ… ${isEditMode ? 'Salvar AlteraÃ§Ãµes' : 'Criar Agendamento'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
    }

    setupUnifiedFormEvents(editData = null, isEditMode = false) {
        const form = document.getElementById('unified-agenda-form');
        if (form) {
            form.addEventListener('submit', (e) => this.handleUnifiedFormSubmit(e, editData, isEditMode));
        }
    }

    async loadUnifiedFormData(editData = null) {
        console.log('ğŸ”§ Loading unified form data...', editData ? 'with edit data' : 'for creation');
        
        try {
            // Load instructors, units, and training areas in parallel
            await Promise.all([
                this.loadInstructors(editData),
                this.loadUnits(editData),
                this.loadTrainingAreas(editData)
            ]);

            // If in edit mode, set additional form values after data is loaded
            if (editData) {
                this.setEditFormValues(editData);
            }

        } catch (error) {
            console.error('âŒ Error loading form data:', error);
            window.app?.handleError(error, 'hybrid-agenda-form-load');
        }
    }

    setEditFormValues(editData) {
        // Set instructor selection
        const instructorSelect = document.getElementById('instructorId');
        if (instructorSelect && editData.instructorId) {
            instructorSelect.value = editData.instructorId;
        }

        // Set unit selection
        const unitSelect = document.getElementById('unitId');
        if (unitSelect && editData.unitId) {
            unitSelect.value = editData.unitId;
        }

        // Set training area selection
        const areaSelect = document.getElementById('trainingAreaId');
        if (areaSelect && editData.trainingAreaId) {
            areaSelect.value = editData.trainingAreaId;
        }

        // Set status selection
        const statusSelect = document.getElementById('status');
        if (statusSelect && editData.status) {
            statusSelect.value = editData.status;
        }

        // Set max students for TURMA
        if (editData.type === 'TURMA') {
            const maxStudentsInput = document.getElementById('maxStudents');
            if (maxStudentsInput && editData.maxStudents) {
                maxStudentsInput.value = editData.maxStudents;
            }
        }

        // Trigger form field toggle based on type
        this.toggleFormFields();
    }

    async loadInstructors(editData = null) {
        try {
            const instructors = await moduleAPI.request('/api/instructors');
            const select = document.getElementById('instructorId');
            if (select && instructors.data) {
                select.innerHTML = '<option value="">Selecione um instrutor</option>';
                instructors.data.forEach(instructor => {
                    const isSelected = editData && editData.instructorId === instructor.userId;
                    select.innerHTML += `<option value="${instructor.userId}" ${isSelected ? 'selected' : ''}>${instructor.name}</option>`;
                });
            }
        } catch (error) {
            console.error('Error loading instructors:', error);
        }
    }

    async loadUnits(editData = null) {
        try {
            const units = await moduleAPI.request('/api/units');
            const select = document.getElementById('unitId');
            if (select && units.data) {
                select.innerHTML = '<option value="">Selecione uma unidade</option>';
                units.data.forEach(unit => {
                    const isSelected = editData && editData.unitId === unit.id;
                    select.innerHTML += `<option value="${unit.id}" ${isSelected ? 'selected' : ''}>${unit.name}</option>`;
                });
            }
        } catch (error) {
            console.error('Error loading units:', error);
        }
    }

    async loadTrainingAreas(editData = null) {
        try {
            const areas = await moduleAPI.request('/api/training-areas');
            const select = document.getElementById('trainingAreaId');
            if (select && areas.data) {
                select.innerHTML = '<option value="">Selecione uma Ã¡rea</option>';
                areas.data.forEach(area => {
                    const isSelected = editData && editData.trainingAreaId === area.id;
                    select.innerHTML += `<option value="${area.id}" ${isSelected ? 'selected' : ''}>${area.name}</option>`;
                });
            }
        } catch (error) {
            console.error('Error loading training areas:', error);
        }
    }

    toggleFormFields() {
        const typeRadios = document.querySelectorAll('input[name="type"]');
        const selectedType = Array.from(typeRadios).find(radio => radio.checked)?.value;
        const turmaFields = document.getElementById('turma-fields');
        
        if (turmaFields) {
            turmaFields.style.display = selectedType === 'TURMA' ? 'block' : 'none';
        }
    }

    async handleUnifiedFormSubmit(e, editData = null, isEditMode = false) {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        try {
            // CREATE DATE IN LOCAL TIMEZONE (TIMEZONE FIX)
            const startDate = new Date(`${data.date}T${data.startTime}:00`);
            const endDate = new Date(startDate.getTime() + parseInt(data.duration) * 60000);
            const startDateTime = startDate.toISOString();
            const endDateTime = endDate.toISOString();
            
            // Convert to proper format
            const agendaData = {
                type: data.type,
                title: data.title,
                description: data.description,
                startTime: startDateTime, // Use proper ISO format with timezone
                endTime: endDateTime, // Use proper ISO format with timezone
                instructorId: data.instructorId,
                unitId: data.unitId || null,
                trainingAreaId: data.trainingAreaId || null,
                status: data.status || 'SCHEDULED',
                isRecurring: data.recurring !== 'false',
                recurrenceRule: data.recurring !== 'false' ? data.recurring.toUpperCase() : null
            };

            // Add type-specific fields
            if (data.type === 'TURMA') {
                agendaData.maxStudents = parseInt(data.maxStudents) || 10;
            }

            console.log(`ğŸ”§ Submitting agenda data (${isEditMode ? 'UPDATE' : 'CREATE'}) with timezone fix:`, agendaData);

            // Create or Update via API
            const url = isEditMode ? `/api/hybrid-agenda/${data.id}` : '/api/hybrid-agenda';
            const method = isEditMode ? 'PUT' : 'POST';
            
            const response = await moduleAPI.request(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(agendaData)
            });

            if (response.success) {
                const successMessage = isEditMode ? 'Agendamento atualizado com sucesso!' : 'Agendamento criado com sucesso!';
                this.showSuccessMessage(successMessage);
                this.backToMain();
            } else {
                const errorMessage = isEditMode ? 'Erro ao atualizar agendamento' : 'Erro ao criar agendamento';
                throw new Error(response.error || errorMessage);
            }

        } catch (error) {
            const context = isEditMode ? 'hybrid-agenda-update' : 'hybrid-agenda-create';
            console.error(`âŒ Error ${isEditMode ? 'updating' : 'creating'} agenda:`, error);
            window.app?.handleError(error, context);
        }
    }

    // SPA Routing methods migrated from simple.js
    async renderDetailsPage(container, itemId) {
        // Get item data from session storage or API
        const itemData = sessionStorage.getItem('agenda-item-details');
        let item = null;
        
        if (itemData) {
            item = JSON.parse(itemData);
        } else {
            // Fallback: find item in current data
            item = agendaData.find(data => data.id === itemId);
            
            // If not found and agendaData is empty, try to load data first
            if (!item && agendaData.length === 0) {
                container.innerHTML = `
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Carregando detalhes do agendamento...</p>
                    </div>
                `;
                
                try {
                    await this.loadAgendaData();
                    item = agendaData.find(data => data.id === itemId);
                } catch (error) {
                    console.error('Error loading agenda data for details:', error);
                }
            }
        }
        
        if (!item) {
            container.innerHTML = `
                <div class="error-state">
                    <h2>Item nÃ£o encontrado</h2>
                    <p>O agendamento solicitado nÃ£o foi encontrado.</p>
                    <button class="btn-primary" onclick="window.location.hash = '#/hybrid-agenda'">â† Voltar para Agenda</button>
                </div>
            `;
            return;
        }
        
        // Render details page with Premium UI
        const typeInfo = item.type === 'PERSONAL_SESSION' 
            ? { icon: 'ğŸ‘¤', name: 'Personal Training', color: '#764ba2' }
            : { icon: 'ğŸ¥‹', name: 'Aula Coletiva', color: '#667eea' };
            
        container.innerHTML = `
            <div class="module-header-premium">
                <div class="breadcrumb">
                    <a href="#/hybrid-agenda" class="breadcrumb-link">ğŸ“… Agenda HÃ­brida</a>
                    <span class="breadcrumb-separator">â€º</span>
                    <span class="breadcrumb-current">${typeInfo.icon} Detalhes</span>
                </div>
                <div class="header-actions">
                    <button class="btn-secondary" onclick="window.location.hash = '#/hybrid-agenda'">â† Voltar</button>
                    <button class="btn-primary" onclick="window.location.hash = '#/hybrid-agenda/edit/${item.id}'">âœï¸ Editar</button>
                </div>
            </div>
            
            <div class="data-card-premium">
                <div class="card-header">
                    <h2>${typeInfo.icon} ${item.title}</h2>
                    <span class="status-badge status-${item.status?.toLowerCase()}">${item.status}</span>
                </div>
                
                <div class="card-content">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Tipo:</strong>
                            <span style="color: ${typeInfo.color}">${typeInfo.name}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Instrutor:</strong>
                            <span>${item.instructor?.name || 'NÃ£o informado'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Data/Hora:</strong>
                            <span>${new Date(item.startTime).toLocaleString('pt-BR')}</span>
                        </div>
                        <div class="detail-item">
                            <strong>DuraÃ§Ã£o:</strong>
                            <span>${Math.round((new Date(item.endTime) - new Date(item.startTime)) / (1000 * 60))} minutos</span>
                        </div>
                        ${item.unit ? `
                            <div class="detail-item">
                                <strong>Unidade:</strong>
                                <span>${item.unit.name}</span>
                            </div>
                        ` : ''}
                        ${item.trainingArea ? `
                            <div class="detail-item">
                                <strong>Ãrea de Treino:</strong>
                                <span>${item.trainingArea.name}</span>
                            </div>
                        ` : ''}
                        ${item.maxStudents ? `
                            <div class="detail-item">
                                <strong>MÃ¡ximo de Alunos:</strong>
                                <span>${item.maxStudents}</span>
                            </div>
                        ` : ''}
                        ${item.description ? `
                            <div class="detail-item full-width">
                                <strong>DescriÃ§Ã£o:</strong>
                                <p>${item.description}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    async renderEditPage(container, itemId) {
        console.log(`ğŸ”§ Rendering edit page for item: ${itemId}`);
        
        // Buscar dados do item
        let itemData = agendaData?.find(item => item.id === itemId);
        
        if (!itemData) {
            try {
                const response = await moduleAPI.request(`/api/hybrid-agenda/${itemId}`);
                itemData = response.data;
            } catch (error) {
                console.error('Error loading item for edit:', error);
                container.innerHTML = `
                    <div class="module-header-premium">
                        <div class="breadcrumb">
                            <a href="#/hybrid-agenda" class="breadcrumb-link">ğŸ“… Agenda HÃ­brida</a>
                            <span class="breadcrumb-separator">â€º</span>
                            <span class="breadcrumb-current">âŒ Erro ao Carregar</span>
                        </div>
                    </div>
                    <div class="error-container">
                        <h3>Erro ao carregar item para ediÃ§Ã£o</h3>
                        <p>${error.message}</p>
                        <button onclick="window.location.hash = '#/hybrid-agenda'" class="btn-secondary">
                            â† Voltar para Agenda
                        </button>
                    </div>
                `;
                return;
            }
        }
        
        const isPersonalTraining = itemData.type === 'PERSONAL_SESSION';
        const pageTitle = isPersonalTraining ? 'Editar Personal Training' : 'Editar Aula Coletiva';
        const pageIcon = isPersonalTraining ? 'ğŸ‘¤' : 'ğŸ¥‹';
        
        // Use the unified modal for editing - reuse existing showUnifiedModal with edit data
        this.showUnifiedModal(itemData);
    }

    backToMain() {
        console.log('ğŸ”§ Returning to main agenda view...');
        this.initialize(document.getElementById('agenda-container'));
    }

    // Delete agenda item (consolidated from simple.js)
    async deleteAgendaItem(itemId) {
        if (!confirm('Tem certeza que deseja excluir este agendamento?')) {
            return;
        }

        try {
            const response = await moduleAPI.request(`/api/hybrid-agenda/${itemId}`, {
                method: 'DELETE'
            });

            if (response.success) {
                this.showSuccessMessage('Agendamento excluÃ­do com sucesso!');
                this.backToMain();
            } else {
                throw new Error(response.error || 'Erro ao excluir agendamento');
            }

        } catch (error) {
            console.error('âŒ Error deleting agenda item:', error);
            window.app?.handleError(error, 'hybrid-agenda-delete');
        }
    }

    // Success message helper
    showSuccessMessage(message) {
        if (window.app && window.app.showMessage) {
            window.app.showMessage(message, 'success');
        } else {
            alert(message);
        }
    }
}

// Initialize module for SPA integration (consolidated from simple.js)
window.initHybridAgendaModule = async function initHybridAgendaModule(container, route) {
    try {
        if (!container) {
            throw new Error('Container element is required');
        }
        
        // Create agenda container if it doesn't exist
        if (!container.querySelector('#agenda-container')) {
            container.innerHTML = '<div id="agenda-container"></div>';
        }
        
        const agendaContainer = container.querySelector('#agenda-container');
        const hybridAgendaModule = new HybridAgendaModule();
        
        // Initialize with route support (SPA integration)
        await hybridAgendaModule.initialize(agendaContainer, route);
        
        // Expose for other modules
        window.hybridAgenda = hybridAgendaModule;
        window.hybridAgendaModule = hybridAgendaModule;
        
        return hybridAgendaModule;
        
    } catch (error) {
        console.error('âŒ Failed to initialize Hybrid Agenda module:', error);
        if (window.app) {
            window.app.handleError(error, 'hybrid-agenda:init');
        }
        
        container.innerHTML = `
            <div class="error-state">
                <h3>âŒ Erro ao carregar Agenda HÃ­brida</h3>
                <p>NÃ£o foi possÃ­vel inicializar o mÃ³dulo. Verifique a conexÃ£o e tente novamente.</p>
            </div>
        `;
        throw error;
    }
};

// Export for global access (consolidated from simple.js)
window.hybridAgenda = HybridAgendaModule;

// Global functions for onclick compatibility (from simple.js)
window.showCreateModal = function() {
    if (window.hybridAgenda) {
        window.hybridAgenda.showUnifiedModal();
    }
};

window.closeCreateModal = function() {
    if (window.hybridAgenda) {
        window.hybridAgenda.backToMain();
    }
};

window.handleAgendaItemClick = function(itemId, itemType) {
    if (window.hybridAgenda) {
        window.hybridAgenda.handleAgendaItemClick(itemId, itemType);
    }
};

window.deleteAgendaItem = function(itemId) {
    if (window.hybridAgenda) {
        window.hybridAgenda.deleteAgendaItem(itemId);
    }
};

// Register module
window['hybrid-agenda'] = window.initHybridAgendaModule;

console.log('âœ… Hybrid Agenda module loaded (AGENTS.md compliant)');