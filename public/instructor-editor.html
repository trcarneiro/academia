<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Instrutor</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/modules/instructors.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .editor-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            position: relative;
        }
        .header h1 {
            color: #333;
            margin: 0;
            font-size: 2em;
        }
        .header .subtitle {
            color: #666;
            margin-top: 10px;
        }
        .debug-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            color: #666;
        }
        .debug-toggle:hover {
            background: #e9ecef;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        .loading, .error, .success {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .loading {
            background: #e3f2fd;
            color: #1976d2;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .debug-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="header">
            <h1>üë®‚Äçüè´ <span id="editor-title">Editor de Instrutor</span></h1>
            <div class="subtitle" id="editor-subtitle">Preencha os dados do instrutor</div>
            <button class="debug-toggle" onclick="toggleDebugInfo()">üîß Debug</button>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="loading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
            Carregando dados...
        </div>

        <!-- Error State -->
        <div id="error-state" class="error" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="error-message">Erro ao carregar dados</span>
        </div>

        <!-- Success State -->
        <div id="success-state" class="success" style="display: none;">
            <i class="fas fa-check-circle"></i>
            <span id="success-message">Opera√ß√£o realizada com sucesso!</span>
        </div>

        <!-- Debug Info (Hidden in production) -->
        <div id="debug-info" class="debug-info" style="display: none;">
            <strong>Debug Info:</strong><br>
            URL: <span id="url-debug"></span><br>
            Mode: <span id="mode-debug"></span><br>
            ID: <span id="id-debug"></span><br>
            API: <span id="api-debug"></span>
        </div>

        <!-- Form -->
        <form id="instructor-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="firstName">Nome *</label>
                    <input type="text" id="firstName" name="firstName" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Sobrenome *</label>
                    <input type="text" id="lastName" name="lastName" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">Telefone</label>
                    <input type="tel" id="phone" name="phone">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="cpf">CPF</label>
                    <input type="text" id="cpf" name="cpf">
                </div>
                <div class="form-group">
                    <label for="birthDate">Data de Nascimento</label>
                    <input type="date" id="birthDate" name="birthDate">
                </div>
            </div>

            <div class="form-group">
                <label for="bio">Biografia</label>
                <textarea id="bio" name="bio" rows="4" placeholder="Informa√ß√µes sobre o instrutor..."></textarea>
            </div>

            <div class="form-group">
                <label for="isActive">Status</label>
                <select id="isActive" name="isActive">
                    <option value="true">Ativo</option>
                    <option value="false">Inativo</option>
                </select>
            </div>

            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i>
                    Voltar
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    <span id="save-btn-text">Salvar</span>
                </button>
                <button type="button" id="delete-btn" class="btn btn-danger" style="display: none;" onclick="deleteInstructor()">
                    <i class="fas fa-trash"></i>
                    Excluir
                </button>
            </div>
        </form>
    </div>

    <script>
        class InstructorEditor {
            constructor() {
                this.instructorId = null;
                this.mode = 'create';
                this.isLoading = false;
            }

            async init() {
                try {
                    console.log('üîß Initializing Instructor Editor...');
                    
                    // Get URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    this.instructorId = urlParams.get('id');
                    this.mode = urlParams.get('mode') || (this.instructorId ? 'edit' : 'create');
                    
                    // Update debug info
                    document.getElementById('url-debug').textContent = window.location.href;
                    document.getElementById('mode-debug').textContent = this.mode;
                    document.getElementById('id-debug').textContent = this.instructorId || 'none';
                    document.getElementById('api-debug').textContent = 'Checking...';
                    
                    // Update UI based on mode
                    this.updateUI();
                    
                    // Setup form
                    this.setupForm();
                    
                    // Load instructor data if editing
                    if (this.instructorId && this.mode === 'edit') {
                        await this.loadInstructor();
                    }
                    
                    document.getElementById('api-debug').textContent = 'Ready ‚úÖ';
                    console.log('‚úÖ Instructor Editor initialized');
                    
                } catch (error) {
                    console.error('‚ùå Error initializing editor:', error);
                    this.showError('Erro ao inicializar editor: ' + error.message);
                }
            }

            updateUI() {
                const titleElement = document.getElementById('editor-title');
                const subtitleElement = document.getElementById('editor-subtitle');
                const saveBtnText = document.getElementById('save-btn-text');
                const deleteBtn = document.getElementById('delete-btn');

                if (this.mode === 'edit' && this.instructorId) {
                    titleElement.textContent = 'Editar Instrutor';
                    subtitleElement.textContent = `Editando instrutor ID: ${this.instructorId}`;
                    saveBtnText.textContent = 'Atualizar';
                    deleteBtn.style.display = 'inline-block';
                } else {
                    titleElement.textContent = 'Novo Instrutor';
                    subtitleElement.textContent = 'Preencha os dados do novo instrutor';
                    saveBtnText.textContent = 'Criar';
                    deleteBtn.style.display = 'none';
                }
            }

            setupForm() {
                const form = document.getElementById('instructor-form');
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveInstructor();
                });

                // Format CPF input
                const cpfInput = document.getElementById('cpf');
                cpfInput.addEventListener('input', (e) => {
                    this.formatCPF(e.target);
                });

                // Format phone input
                const phoneInput = document.getElementById('phone');
                phoneInput.addEventListener('input', (e) => {
                    this.formatPhone(e.target);
                });
            }

            formatCPF(input) {
                let value = input.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                    input.value = value;
                }
            }

            formatPhone(input) {
                let value = input.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    if (value.length === 11) {
                        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                    } else if (value.length === 10) {
                        value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                    }
                    input.value = value;
                }
            }

            async loadInstructor() {
                try {
                    this.showLoading('Carregando dados do instrutor...');
                    
                    const response = await fetch(`/api/instructors/${this.instructorId}`);
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        this.populateForm(data.data);
                        this.hideLoading();
                        console.log('‚úÖ Instructor data loaded');
                    } else {
                        throw new Error(data.error || 'Instrutor n√£o encontrado');
                    }
                } catch (error) {
                    console.error('‚ùå Error loading instructor:', error);
                    this.showError('Erro ao carregar instrutor: ' + error.message);
                }
            }

            populateForm(instructor) {
                console.log('üìù Populando formul√°rio com dados:', instructor);
                
                // Split name if it exists
                const fullName = instructor.name || '';
                const nameParts = fullName.split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';

                document.getElementById('firstName').value = firstName;
                document.getElementById('lastName').value = lastName;
                document.getElementById('email').value = instructor.email || '';
                document.getElementById('phone').value = instructor.phone || '';
                document.getElementById('cpf').value = instructor.cpf || '';
                
                // Format birth date properly for input[type="date"]
                if (instructor.birthDate) {
                    const date = new Date(instructor.birthDate);
                    if (!isNaN(date.getTime())) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        document.getElementById('birthDate').value = `${year}-${month}-${day}`;
                    }
                }
                
                document.getElementById('bio').value = instructor.bio || '';
                document.getElementById('isActive').value = instructor.isActive ? 'true' : 'false';
                
                // Format phone and CPF if they have values
                const phoneInput = document.getElementById('phone');
                const cpfInput = document.getElementById('cpf');
                
                if (phoneInput.value) {
                    this.formatPhone(phoneInput);
                }
                
                if (cpfInput.value) {
                    this.formatCPF(cpfInput);
                }
                
                console.log('‚úÖ Formul√°rio populado com sucesso');
            }

            async saveInstructor() {
                try {
                    if (this.isLoading) return;
                    
                    this.isLoading = true;
                    this.showLoading('Salvando instrutor...');
                    
                    const formData = new FormData(document.getElementById('instructor-form'));
                    
                    // Combine firstName and lastName into name
                    const firstName = formData.get('firstName')?.trim() || '';
                    const lastName = formData.get('lastName')?.trim() || '';
                    const fullName = `${firstName} ${lastName}`.trim();
                    
                    const data = {
                        name: fullName,
                        email: formData.get('email'),
                        phone: formData.get('phone'),
                        cpf: formData.get('cpf'),
                        birthDate: formData.get('birthDate') || null,
                        bio: formData.get('bio'),
                        isActive: formData.get('isActive') === 'true'
                    };

                    const url = this.mode === 'edit' ? `/api/instructors/${this.instructorId}` : '/api/instructors';
                    const method = this.mode === 'edit' ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showSuccess(this.mode === 'edit' ? 'Instrutor atualizado com sucesso!' : 'Instrutor criado com sucesso!');
                        
                        // Redirect after 2 seconds
                        setTimeout(() => {
                            this.goBack();
                        }, 2000);
                    } else {
                        throw new Error(result.error || 'Erro ao salvar instrutor');
                    }
                } catch (error) {
                    console.error('‚ùå Error saving instructor:', error);
                    this.showError('Erro ao salvar: ' + error.message);
                } finally {
                    this.isLoading = false;
                }
            }

            async deleteInstructor() {
                if (!this.instructorId) return;
                
                if (!confirm('Tem certeza que deseja excluir este instrutor? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }

                try {
                    this.showLoading('Excluindo instrutor...');
                    
                    const response = await fetch(`/api/instructors/${this.instructorId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showSuccess('Instrutor exclu√≠do com sucesso!');
                        
                        // Redirect after 2 seconds
                        setTimeout(() => {
                            this.goBack();
                        }, 2000);
                    } else {
                        throw new Error(result.error || 'Erro ao excluir instrutor');
                    }
                } catch (error) {
                    console.error('‚ùå Error deleting instructor:', error);
                    this.showError('Erro ao excluir: ' + error.message);
                }
            }

            showLoading(message) {
                document.getElementById('loading-state').style.display = 'block';
                document.getElementById('loading-state').innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${message}`;
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('success-state').style.display = 'none';
            }

            hideLoading() {
                document.getElementById('loading-state').style.display = 'none';
            }

            showError(message) {
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-message').textContent = message;
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('success-state').style.display = 'none';
            }

            showSuccess(message) {
                document.getElementById('success-state').style.display = 'block';
                document.getElementById('success-message').textContent = message;
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
            }

            goBack() {
                // Try to go back to the instructors list
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    // Fallback: navigate to main app
                    window.location.href = '/#/instructors';
                }
            }
        }

        // Global functions
        function goBack() {
            if (window.instructorEditor) {
                window.instructorEditor.goBack();
            } else {
                window.history.back();
            }
        }

        function deleteInstructor() {
            if (window.instructorEditor) {
                window.instructorEditor.deleteInstructor();
            }
        }

        // Toggle debug info visibility
        function toggleDebugInfo() {
            const debugSection = document.getElementById('debug-section');
            if (debugSection.style.display === 'none') {
                debugSection.style.display = 'block';
            } else {
                debugSection.style.display = 'none';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            window.instructorEditor = new InstructorEditor();
            await window.instructorEditor.init();
        });
    </script>
</body>
</html>
