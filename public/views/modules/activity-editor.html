<div class="activities-isolated-container">
  <div class="activities-isolated-page-header">
    <button class="activities-isolated-back-btn" onclick="history.back()">
      <i class="fas fa-arrow-left"></i> Voltar
    </button>
    <h1 id="editor-title">Nova Atividade</h1>
  </div>

  <div class="activities-isolated-content">
    <form id="activity-form">
      <input type="hidden" id="activity-id">
      
      <div class="activities-isolated-form-row">
        <div class="activities-isolated-form-group">
          <label for="title">T√≠tulo*</label>
          <input type="text" id="title" name="title" required class="activities-isolated-input">
        </div>

        <div class="activities-isolated-form-group">
          <label for="type">Tipo*</label>
          <select id="type" name="type" required class="activities-isolated-select">
            <option value="">Selecione...</option>
            <option value="TECHNIQUE">T√©cnica</option>
            <option value="STRETCH">Alongamento</option>
            <option value="DRILL">Drill</option>
            <option value="EXERCISE">Exerc√≠cio</option>
            <option value="GAME">Jogo</option>
            <option value="CHALLENGE">Desafio</option>
            <option value="ASSESSMENT">Avalia√ß√£o</option>
          </select>
        </div>
      </div>

      <div class="activities-isolated-form-row">
        <div class="activities-isolated-form-group">
          <label for="difficulty">Dificuldade (1-5)</label>
          <input type="number" id="difficulty" name="difficulty" min="1" max="5"
                 class="activities-isolated-input">
          <small class="activities-isolated-help">1 = Muito F√°cil, 5 = Muito Dif√≠cil</small>
        </div>

        <div class="activities-isolated-form-group">
          <label for="refTechniqueId">T√©cnica Relacionada</label>
          <select id="refTechniqueId" name="refTechniqueId" class="activities-isolated-select">
            <option value="">Nenhuma</option>
            <!-- Op√ß√µes ser√£o carregadas dinamicamente -->
          </select>
        </div>
      </div>

      <div class="activities-isolated-form-group">
        <label for="description">Descri√ß√£o</label>
        <textarea id="description" name="description" rows="4" 
                  placeholder="Descreva os objetivos e como executar a atividade..."
                  class="activities-isolated-textarea"></textarea>
      </div>

      <div class="activities-isolated-form-group">
        <label for="equipment">Equipamentos Necess√°rios</label>
        <input type="text" id="equipment" name="equipment" 
               placeholder="Ex: tatame, luvas, escudo (separados por v√≠rgula)"
               class="activities-isolated-input">
        <small class="activities-isolated-help">Separe m√∫ltiplos equipamentos por v√≠rgula</small>
      </div>

      <div class="activities-isolated-form-group">
        <label for="safety">Observa√ß√µes de Seguran√ßa</label>
        <textarea id="safety" name="safety" rows="3"
                  placeholder="Cuidados especiais, contraindica√ß√µes, etc..."
                  class="activities-isolated-textarea"></textarea>
      </div>

      <div class="activities-isolated-form-group">
        <label for="adaptations">Adapta√ß√µes Poss√≠veis</label>
        <input type="text" id="adaptations" name="adaptations"
               placeholder="Ex: reduzir intensidade, usar prote√ß√£o extra (separados por v√≠rgula)"
               class="activities-isolated-input">
        <small class="activities-isolated-help">Separe m√∫ltiplas adapta√ß√µes por v√≠rgula</small>
      </div>

      <div class="activities-isolated-form-actions">
        <button type="submit" class="activities-isolated-btn activities-isolated-btn-primary">
          üíæ Salvar Atividade
        </button>
        <button type="button" id="delete-btn" class="activities-isolated-btn activities-isolated-btn-danger" style="display:none">
          üóëÔ∏è Excluir Atividade
        </button>
      </div>
    </form>
  </div>
</div>

<script type="module">
  import { ActivitiesService } from '/js/modules/activities-service.js';

  document.addEventListener('DOMContentLoaded', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const activityId = urlParams.get('id');
    const form = document.getElementById('activity-form');
    const deleteBtn = document.getElementById('delete-btn');
    const titleElement = document.getElementById('editor-title');

    // Configurar feedback se dispon√≠vel
    if (window.feedback) {
      console.log('üü¢ Feedback utilities dispon√≠vel');
    }
    
    // Carregar atividade existente se houver ID
    if (activityId) {
      try {
        const response = await ActivitiesService.get(activityId);
        const activity = response.data || response;
        populateForm(activity);
        titleElement.textContent = 'Editar Atividade';
        deleteBtn.style.display = 'block';
      } catch (error) {
        console.error('Erro ao carregar atividade:', error);
        window.feedback?.showError?.('Falha ao carregar dados da atividade') || 
        alert('Falha ao carregar dados da atividade');
      }
    }

    // Configurar evento de exclus√£o
    deleteBtn.addEventListener('click', async () => {
      if (confirm('Tem certeza que deseja excluir esta atividade?')) {
        try {
          window.feedback?.setButtonLoading?.(deleteBtn, true);
          
          await ActivitiesService.delete(activityId);
          window.feedback?.showSuccess?.('Atividade exclu√≠da com sucesso!') ||
          alert('Atividade exclu√≠da com sucesso!');
          history.back();
        } catch (error) {
          console.error('Erro ao excluir atividade:', error);
          window.feedback?.showError?.('Falha ao excluir atividade') ||
          alert('Falha ao excluir atividade');
        } finally {
          window.feedback?.setButtonLoading?.(deleteBtn, false);
        }
      }
    });

    // Configurar envio do formul√°rio
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = form.querySelector('button[type="submit"]');
      
      // Evita duplo envio
      if (submitBtn.disabled) return;

      // Coletar dados do formul√°rio
      const formData = new FormData(form);
      const activityData = {
        title: formData.get('title'),
        type: formData.get('type'),
        description: formData.get('description') || '',
        difficulty: formData.get('difficulty') ? parseInt(formData.get('difficulty')) : null,
        refTechniqueId: formData.get('refTechniqueId') || null,
        safety: formData.get('safety') || '',
        equipment: formData.get('equipment') ? 
          formData.get('equipment').split(',').map(s => s.trim()).filter(s => s) : [],
        adaptations: formData.get('adaptations') ? 
          formData.get('adaptations').split(',').map(s => s.trim()).filter(s => s) : []
      };

      // Valida√ß√£o b√°sica
      if (!activityData.title || !activityData.type) {
        window.feedback?.showError?.('T√≠tulo e tipo s√£o obrigat√≥rios') ||
        alert('T√≠tulo e tipo s√£o obrigat√≥rios');
        return;
      }

      // Loading state
      window.feedback?.setButtonLoading?.(submitBtn, true);

      try {
        let response;
        if (activityId) {
          response = await ActivitiesService.update(activityId, activityData);
          window.feedback?.showSuccess?.('Atividade atualizada com sucesso!') ||
          alert('Atividade atualizada com sucesso!');
        } else {
          response = await ActivitiesService.create(activityData);
          window.feedback?.showSuccess?.('Atividade criada com sucesso!') ||
          alert('Atividade criada com sucesso!');
        }
        
        // Voltar ap√≥s sucesso
        setTimeout(() => history.back(), 1000);
      } catch (error) {
        console.error('Erro ao salvar atividade:', error);
        const errorMessage = error?.message || 'Falha ao salvar atividade';
        window.feedback?.showError?.(errorMessage) ||
        alert(errorMessage);
      } finally {
        window.feedback?.setButtonLoading?.(submitBtn, false);
      }
    });

    function populateForm(activity) {
      document.getElementById('activity-id').value = activity.id || '';
      document.getElementById('title').value = activity.title || '';
      document.getElementById('type').value = activity.type || '';
      document.getElementById('description').value = activity.description || '';
      document.getElementById('difficulty').value = activity.difficulty || '';
      document.getElementById('refTechniqueId').value = activity.refTechniqueId || '';
      document.getElementById('safety').value = activity.safety || '';
      
      // Equipamentos como array para string
      if (activity.equipment && Array.isArray(activity.equipment)) {
        document.getElementById('equipment').value = activity.equipment.join(', ');
      }
      
      // Adapta√ß√µes como array para string
      if (activity.adaptations && Array.isArray(activity.adaptations)) {
        document.getElementById('adaptations').value = activity.adaptations.join(', ');
      }
    }
  });
</script>
        </button>
        <button type="button" id="delete-btn" class="activities-isolated-btn activities-isolated-btn-danger" style="display:none">
          Excluir Atividade
        </button>
      </div>
    </form>
  </div>
</div>

<script type="module">
  import { ActivitiesService } from '/js/modules/activities-service.js';

  document.addEventListener('DOMContentLoaded', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const activityId = urlParams.get('id');
    const form = document.getElementById('activity-form');
    const deleteBtn = document.getElementById('delete-btn');
    const titleElement = document.getElementById('editor-title');

    // Definir data m√≠nima como hoje
    document.getElementById('date').min = new Date().toISOString().split('T')[0];
    
    // Carregar atividade existente se houver ID
    if (activityId) {
      try {
        const { data } = await ActivitiesService.get(activityId);
        populateForm(data);
        titleElement.textContent = 'Editar Atividade';
        deleteBtn.style.display = 'block';
      } catch (error) {
        console.error('Erro ao carregar atividade:', error);
        alert('Falha ao carregar dados da atividade');
      }
    }

    // Configurar evento de exclus√£o
    deleteBtn.addEventListener('click', async () => {
      if (confirm('Tem certeza que deseja excluir esta atividade?')) {
        try {
          deleteBtn.disabled = true;
          const originalDeleteText = deleteBtn.textContent;
          deleteBtn.textContent = 'Excluindo...';

          await ActivitiesService.delete(activityId);
          alert('Atividade exclu√≠da com sucesso!');
          history.back();
        } catch (error) {
          console.error('Erro ao excluir atividade:', error);
          alert('Falha ao excluir atividade');
        } finally {
          // re-enable if we didn't navigate away
          try { deleteBtn.disabled = false; deleteBtn.textContent = originalDeleteText; } catch(e){}
        }
      }
    });

    // Configurar envio do formul√°rio
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Evita duplo envio
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn.disabled) return;

      // Valida√ß√£o de data
      const dateInput = document.getElementById('date');
      const dateError = document.getElementById('date-error');
      const selectedDate = new Date(dateInput.value);
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (selectedDate < today) {
        dateError.style.display = 'block';
        dateInput.focus();
        return;
      }
      dateError.style.display = 'none';

      // Coletar dados do formul√°rio
      const activityData = {
        id: document.getElementById('activity-id').value || null,
        title: document.getElementById('title').value,
        type: document.getElementById('type').value,
        date: document.getElementById('date').value,
        duration: parseInt(document.getElementById('duration').value),
        description: document.getElementById('description').value
      };

      // Disable submit UI and show feedback
      submitBtn.disabled = true;
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Salvando...';
      submitBtn.setAttribute('aria-busy', 'true');

      try {
        // Atualizar ou criar atividade
        if (activityId) {
          await ActivitiesService.update(activityId, activityData);
          alert('Atividade atualizada com sucesso!');
        } else {
          await ActivitiesService.create(activityData);
          alert('Atividade criada com sucesso!');
        }
        history.back();
      } catch (error) {
        console.error('Erro ao salvar atividade:', error);
        alert(`Falha ao salvar atividade: ${error?.message || error}`);
      } finally {
        // re-enable in case we didn't navigate away
        try {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          submitBtn.removeAttribute('aria-busy');
        } catch (e) {}
      }
    });

    function populateForm(activity) {
      document.getElementById('activity-id').value = activity.id;
      document.getElementById('title').value = activity.title;
      document.getElementById('type').value = activity.type;
      document.getElementById('date').value = new Date(activity.date).toISOString().split('T')[0];
      document.getElementById('duration').value = activity.duration;
      document.getElementById('description').value = activity.description || '';
    }
  });
</script>