<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in Kiosk - Academia Krav Maga</title>
    <link rel="stylesheet" href="/css/core/variables.css">
    <link rel="stylesheet" href="/css/core/reset.css">
    <link rel="stylesheet" href="/css/core/layout.css">
    <link rel="stylesheet" href="/css/core/components.css">
    <link rel="stylesheet" href="/css/modules/frequency.css">
    <link rel="stylesheet" href="/css/modules/checkin-kiosk.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="kiosk-mode">
    <div id="app">
        <!-- Loading Screen -->
        <div id="loading-screen" class="loading-screen">
            <div class="loading-spinner">
                <i class="fas fa-fist-raised fa-spin"></i>
            </div>
            <p>Carregando sistema de check-in...</p>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="main-content" style="display: none;">
            
            <!-- Header -->
            <header class="kiosk-header">
                <div class="header-content">
                    <div class="logo-section">
                        <i class="fas fa-fist-raised"></i>
                        <h1>Academia Krav Maga</h1>
                    </div>
                    <div class="header-actions">
                        <button id="kiosk-mode-btn" class="btn-kiosk-mode" title="Modo Kiosk - Tela Limpa">
                            <i class="fas fa-tv" id="kiosk-mode-icon"></i>
                            <span class="btn-text">Modo Kiosk</span>
                        </button>
                        <button id="fullscreen-btn" class="btn-fullscreen" title="Tela Cheia (F11)">
                            <i class="fas fa-expand" id="fullscreen-icon"></i>
                            <span class="btn-text">Tela Cheia</span>
                        </button>
                        <div class="current-time">
                            <span id="current-time"></span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Student Lookup Stage -->
            <div id="lookup-stage" class="stage active">
                <div class="stage-container">
                    <div class="welcome-section">
                        <h2><i class="fas fa-user-check"></i> Bem-vindo!</h2>
                        <p>Digite sua matr√≠cula ou nome para fazer check-in</p>
                    </div>

                    <div class="lookup-form">
                        <div class="input-group">
                            <label for="registration-input">Matr√≠cula ou Nome</label>
                            <input 
                                type="text" 
                                id="registration-input" 
                                placeholder="Digite sua matr√≠cula ou nome..."
                                autocomplete="off"
                                maxlength="50"
                            >
                            <div class="input-hint">
                                <i class="fas fa-info-circle"></i>
                                Busque por matr√≠cula (ex: 12345) ou nome (ex: Jo√£o Silva)
                            </div>
                        </div>

                        <button id="lookup-btn" class="btn-primary" disabled>
                            <i class="fas fa-search"></i>
                            Buscar Aluno
                        </button>

                        <div id="lookup-error" class="error-message" style="display: none;"></div>
                        
                        <!-- Search Results -->
                        <div id="search-results" class="search-results" style="display: none;"></div>
                    </div>

                    <div class="quick-actions">
                        <div class="action-card">
                            <i class="fas fa-qrcode"></i>
                            <span>QR Code em breve</span>
                        </div>
                        <div class="action-card">
                            <i class="fas fa-mobile-alt"></i>
                            <span>App Mobile em breve</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Dashboard Stage -->
            <div id="dashboard-stage" class="stage">
                <div class="stage-container">
                    <!-- Student Info -->
                    <div class="student-header">
                        <div class="student-info">
                            <div class="student-avatar">
                                <img id="student-avatar" src="/images/default-avatar.svg" alt="Avatar">
                            </div>
                            <div class="student-details">
                                <h2 id="student-name">Nome do Aluno</h2>
                                <div class="student-meta">
                                    <span id="student-registration">Matr√≠cula: </span>
                                    <span id="student-level">Faixa: </span>
                                    <span id="student-plan">Plano: -</span>
                                    <span id="student-plan-validity">Validade: -</span>
                                    <span id="student-course">Curso: -</span>
                                    <span id="student-turma">Turma: -</span>
                                </div>
                            </div>
                        </div>
                        <button id="logout-btn" class="btn-secondary">
                            <i class="fas fa-sign-out-alt"></i>
                            Sair
                        </button>
                    </div>

                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card-enhanced progress-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="attendance-rate">0%</div>
                                <div class="stat-label">Taxa de Presen√ßa</div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" id="attendance-progress-bar">
                                        <div class="progress-fill" id="attendance-progress-fill"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card-enhanced">
                            <div class="stat-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="classes-month">0</div>
                                <div class="stat-label">Aulas este M√™s</div>
                            </div>
                        </div>
                        <div class="stat-card-enhanced">
                            <div class="stat-icon">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="graduation-level">Iniciante</div>
                                <div class="stat-label">N√≠vel Atual</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Recommendations -->
                    <div class="recommendations-section">
                        <h3><i class="fas fa-brain"></i> Recomenda√ß√µes para Voc√™</h3>
                        <div id="ai-recommendations" class="recommendations-grid">
                            <!-- AI recommendations will be loaded here -->
                        </div>
                    </div>

                    <!-- Available Classes -->
                    <div class="classes-section">
                        <h3><i class="fas fa-clock"></i> Aulas Dispon√≠veis Agora</h3>
                        <div id="available-classes" class="classes-grid">
                            <!-- Classes will be loaded here -->
                        </div>
                    </div>

                    <!-- Upcoming Classes -->
                    <div class="classes-section">
                        <h3><i class="fas fa-calendar-alt"></i> Pr√≥ximas Aulas</h3>
                        <div id="upcoming-classes" class="classes-grid">
                            <!-- Upcoming classes will be loaded here -->
                        </div>
                    </div>

                    <!-- Payments Summary -->
                    <div class="activity-section">
                        <h3><i class="fas fa-receipt"></i> Resumo Financeiro</h3>
                        <div id="payments-summary" class="payments-grid">
                            <div class="stat-card-enhanced">
                                <div class="stat-icon">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="payments-overdue-count">0</div>
                                    <div class="stat-label">Boletos em Atraso</div>
                                </div>
                            </div>
                            <div class="stat-card-enhanced">
                                <div class="stat-icon">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="payments-overdue-amount">R$ 0,00</div>
                                    <div class="stat-label">Total em Atraso</div>
                                </div>
                            </div>
                            <div class="stat-card-enhanced">
                                <div class="stat-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="payments-last">‚Äî</div>
                                    <div class="stat-label">√öltimo Pagamento</div>
                                </div>
                            </div>
                            <div class="stat-card-enhanced">
                                <div class="stat-icon">
                                    <i class="fas fa-calendar-day"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-number" id="payments-next-due">‚Äî</div>
                                    <div class="stat-label">Pr√≥ximo Vencimento</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="activity-section">
                        <h3><i class="fas fa-history"></i> √öltimas Presen√ßas</h3>
                        <div id="recent-activity" class="activity-list">
                            <!-- Recent activity will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Check-in Confirmation -->
            <div id="confirmation-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-check-circle"></i> Confirmar Check-in</h3>
                    </div>
                    <div class="modal-body">
                        <p>Confirmar check-in para a aula:</p>
                        <div class="class-details">
                            <h4 id="confirm-class-name"></h4>
                            <div class="class-meta">
                                <span id="confirm-class-time"></span>
                                <span id="confirm-instructor"></span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button id="cancel-checkin" class="btn-secondary">Cancelar</button>
                        <button id="confirm-checkin" class="btn-primary">
                            <i class="fas fa-check"></i> Confirmar Check-in
                        </button>
                    </div>
                </div>
            </div>

            <!-- Success Modal -->
            <div id="success-modal" class="modal" style="display: none;">
                <div class="modal-content success">
                    <div class="modal-header">
                        <h3><i class="fas fa-check-circle"></i> Check-in Realizado!</h3>
                    </div>
                    <div class="modal-body">
                        <div class="success-animation">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <p>Seu check-in foi registrado com sucesso!</p>
                        <div class="success-details">
                            <span id="success-class-name"></span>
                            <span id="success-time"></span>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button id="success-ok" class="btn-primary">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- face-api.js Library for Face Detection -->
    <script async defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <!-- Check-in Kiosk Module - Services Layer -->
    <script src="/js/modules/checkin-kiosk/services/FaceRecognitionService.js"></script>
    <script src="/js/modules/checkin-kiosk/services/CameraService.js"></script>
    <script src="/js/modules/checkin-kiosk/services/BiometricService.js"></script>
    <script src="/js/modules/checkin-kiosk/services/AttendanceService.js"></script>

    <!-- Check-in Kiosk Module - Views Layer -->
    <script src="/js/modules/checkin-kiosk/views/CameraView.js"></script>
    <script src="/js/modules/checkin-kiosk/views/ConfirmationView.js"></script>
    <script src="/js/modules/checkin-kiosk/views/SuccessView.js"></script>

    <!-- Check-in Kiosk Module - Controller & Entry Point -->
    <script src="/js/modules/checkin-kiosk/controllers/CheckinController.js"></script>
    <script src="/js/modules/checkin-kiosk/index.js"></script>

    <script>
        // ============================================================
        // FULLSCREEN CONTROL
        // ============================================================
        (function initFullscreen() {
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            
            if (!fullscreenBtn) return;
            
            function updateFullscreenButton() {
                const isFullscreen = document.fullscreenElement || 
                                     document.webkitFullscreenElement || 
                                     document.mozFullScreenElement;
                if (fullscreenIcon) {
                    fullscreenIcon.className = isFullscreen ? 'fas fa-compress' : 'fas fa-expand';
                }
                const btnText = fullscreenBtn.querySelector('.btn-text');
                if (btnText) {
                    btnText.textContent = isFullscreen ? 'Sair' : 'Tela Cheia';
                }
            }
            
            function toggleFullscreen() {
                const elem = document.documentElement;
                
                if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                    // Enter fullscreen
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    } else if (elem.webkitRequestFullscreen) {
                        elem.webkitRequestFullscreen();
                    } else if (elem.mozRequestFullScreen) {
                        elem.mozRequestFullScreen();
                    }
                } else {
                    // Exit fullscreen
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    }
                }
            }
            
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            
            // Update button on fullscreen change
            document.addEventListener('fullscreenchange', updateFullscreenButton);
            document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
            document.addEventListener('mozfullscreenchange', updateFullscreenButton);
            
            // F11 key support
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreen();
                }
            });
        })();

        // ============================================================
        // KIOSK MODE (CLEAN MODE) HANDLER
        // ============================================================
        (function() {
            const kioskModeBtn = document.getElementById('kiosk-mode-btn');
            const kioskModeIcon = document.getElementById('kiosk-mode-icon');
            
            if (!kioskModeBtn) return;
            
            let isKioskMode = localStorage.getItem('kioskCleanMode') === 'true';
            
            function updateKioskModeButton() {
                if (isKioskMode) {
                    kioskModeIcon.className = 'fas fa-times';
                    kioskModeBtn.querySelector('.btn-text').textContent = 'Sair Kiosk';
                    kioskModeBtn.classList.add('active');
                    kioskModeBtn.title = 'Sair do Modo Kiosk';
                } else {
                    kioskModeIcon.className = 'fas fa-tv';
                    kioskModeBtn.querySelector('.btn-text').textContent = 'Modo Kiosk';
                    kioskModeBtn.classList.remove('active');
                    kioskModeBtn.title = 'Modo Kiosk - Tela Limpa';
                }
            }
            
            function toggleKioskMode() {
                isKioskMode = !isKioskMode;
                localStorage.setItem('kioskCleanMode', isKioskMode);
                document.body.classList.toggle('kiosk-clean-mode', isKioskMode);
                updateKioskModeButton();
                console.log(`üñ•Ô∏è Kiosk Clean Mode: ${isKioskMode ? 'ATIVADO' : 'DESATIVADO'}`);
            }
            
            // Apply saved state on load
            if (isKioskMode) {
                document.body.classList.add('kiosk-clean-mode');
            }
            updateKioskModeButton();
            
            kioskModeBtn.addEventListener('click', toggleKioskMode);
            
            // K key shortcut for kiosk mode
            document.addEventListener('keydown', (e) => {
                if (e.key === 'k' && e.ctrlKey) {
                    e.preventDefault();
                    toggleKioskMode();
                }
            });
        })();

        // ============================================================
        // INITIALIZE CHECK-IN KIOSK
        // ============================================================
        (async function() {
            try {
                // Ensure API client is available
                if (typeof window.createModuleAPI === 'undefined') {
                    console.warn('‚ö†Ô∏è API client not yet loaded, waiting...');
                    let retries = 0;
                    while (retries < 50 && typeof window.createModuleAPI === 'undefined') {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        retries++;
                    }
                }

                // Initialize the module
                if (typeof window.CheckinKiosk !== 'undefined') {
                    console.log('üé¨ Initializing CheckinKiosk module...');
                    await window.CheckinKiosk.init('main-content');
                    console.log('‚úÖ CheckinKiosk module initialized successfully');
                } else {
                    console.error('‚ùå CheckinKiosk module not found!');
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('main-content').innerHTML = `
                        <div class="error-state" style="text-align: center; padding: 40px;">
                            <h2>‚ùå Erro ao Carregar</h2>
                            <p>O m√≥dulo Check-in Kiosk n√£o foi carregado corretamente.</p>
                            <p>Detalhes: Arquivo checkin-kiosk/index.js n√£o foi encontrado.</p>
                            <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px;">Recarregar P√°gina</button>
                        </div>
                    `;
                    document.getElementById('main-content').style.display = 'block';
                }
            } catch (error) {
                console.error('‚ùå Error initializing CheckinKiosk:', error);
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-content').innerHTML = `
                    <div class="error-state" style="text-align: center; padding: 40px;">
                        <h2>‚ùå Erro na Inicializa√ß√£o</h2>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px;">Recarregar P√°gina</button>
                    </div>
                `;
                document.getElementById('main-content').style.display = 'block';
            }
        })();
    </script>
</body>
</html>
