<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš™ï¸ ConfiguraÃ§Ãµes - Krav Maga Academy</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/modules/settings.css">
</head>
<body>
    <div class="settings-isolated">
        <!-- Settings Header -->
        <div class="settings-header">
            <h2>âš™ï¸ ConfiguraÃ§Ãµes do Sistema</h2>
            <div class="settings-actions">
                <button class="btn btn-primary" id="saveSettingsBtn" disabled>
                    ğŸ’¾ Salvar ConfiguraÃ§Ãµes
                </button>
                <button class="btn btn-secondary" id="resetSettingsBtn">
                    ğŸ”„ Restaurar PadrÃµes
                </button>
                <button class="btn btn-secondary" onclick="window.history.back()">
                    â† Voltar
                </button>
            </div>
        </div>

        <!-- Settings Content -->
        <div id="settings-container">
            <!-- Loading state -->
            <div class="settings-loading">
                <div class="loading-spinner">âš™ï¸</div>
                <p>Carregando configuraÃ§Ãµes...</p>
            </div>
        </div>
    </div>

    <!-- Settings Module -->
    <script src="/js/modules/settings.js"></script>
    <script>
        // Initialize settings when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âš™ï¸ Settings page loaded');
            
            // Load settings data if function exists
            if (typeof loadSettings === 'function') {
                loadSettings();
            }
            
            // Setup form validation
            setupFormValidation();
        });
        
        function setupFormValidation() {
            // Add real-time validation for form fields
            document.addEventListener('input', function(e) {
                if (e.target.type === 'email') {
                    validateEmail(e.target);
                } else if (e.target.type === 'tel') {
                    validatePhone(e.target);
                }
            });
        }
        
        function validateEmail(input) {
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isValid = emailPattern.test(input.value);
            
            input.classList.toggle('invalid', input.value && !isValid);
            input.classList.toggle('valid', isValid);
            
            // Show/hide error message
            let errorMsg = input.parentNode.querySelector('.error-message');
            if (input.value && !isValid) {
                if (!errorMsg) {
                    errorMsg = document.createElement('small');
                    errorMsg.className = 'error-message';
                    errorMsg.style.color = '#EF4444';
                    errorMsg.style.fontSize = '0.75rem';
                    errorMsg.style.marginTop = '0.25rem';
                    errorMsg.style.display = 'block';
                    errorMsg.textContent = 'Por favor, insira um email vÃ¡lido';
                    input.parentNode.appendChild(errorMsg);
                }
            } else if (errorMsg) {
                errorMsg.remove();
            }
        }
        
        function validatePhone(input) {
            const phonePattern = /^\(\d{2}\)\s\d{4,5}-\d{4}$/;
            let value = input.value.replace(/\D/g, '');
            
            // Format phone number
            if (value.length >= 10) {
                if (value.length === 10) {
                    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                } else if (value.length === 11) {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                }
                input.value = value;
            }
            
            const isValid = phonePattern.test(value);
            input.classList.toggle('invalid', input.value && !isValid);
            input.classList.toggle('valid', isValid);
        }
        
        // Enhanced settings save with validation
        function saveSettingsWithValidation() {
            const form = document.querySelector('.settings-form');
            if (!form) return;
            
            // Validate all required fields
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('invalid');
                    isValid = false;
                } else {
                    field.classList.remove('invalid');
                }
            });
            
            // Validate email fields
            const emailFields = form.querySelectorAll('[type="email"]');
            emailFields.forEach(field => {
                if (field.value && !field.classList.contains('valid')) {
                    isValid = false;
                }
            });
            
            if (isValid) {
                if (typeof saveSettings === 'function') {
                    saveSettings();
                }
            } else {
                if (typeof showToast === 'function') {
                    showToast('Por favor, corrija os campos invÃ¡lidos', 'error');
                }
            }
        }
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    saveSettingsWithValidation();
                } else if (e.key === 'r') {
                    e.preventDefault();
                    if (typeof resetSettings === 'function') {
                        resetSettings();
                    }
                }
            }
        });
        
        // Auto-save draft functionality
        let saveTimeout;
        document.addEventListener('input', function(e) {
            if (e.target.closest('.settings-form')) {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveDraft();
                }, 2000); // Save draft after 2 seconds of inactivity
            }
        });
        
        function saveDraft() {
            const form = document.querySelector('.settings-form');
            if (!form) return;
            
            const formData = new FormData(form);
            const draft = {};
            
            for (let [key, value] of formData.entries()) {
                draft[key] = value;
            }
            
            localStorage.setItem('settings-draft', JSON.stringify(draft));
            console.log('ğŸ’¾ Draft saved to localStorage');
        }
        
        function loadDraft() {
            const draft = localStorage.getItem('settings-draft');
            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    Object.entries(draftData).forEach(([key, value]) => {
                        const field = document.querySelector(`[name="${key}"]`);
                        if (field) {
                            if (field.type === 'checkbox') {
                                field.checked = value === 'on';
                            } else {
                                field.value = value;
                            }
                        }
                    });
                    console.log('ğŸ“‹ Draft loaded from localStorage');
                } catch (error) {
                    console.error('Error loading draft:', error);
                }
            }
        }
        
        // Clear draft when settings are saved successfully
        document.addEventListener('settings:saved', function() {
            localStorage.removeItem('settings-draft');
            console.log('ğŸ—‘ï¸ Draft cleared');
        });
    </script>
</body>
</html>