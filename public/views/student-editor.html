<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Aluno - Academia Krav Maga</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/modules/students.css">
    <style>
        /* Enhanced UX Improvements */
        .page-header {
            background: linear-gradient(135deg, #1E293B 0%, #334155 100%);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3B82F6, #8B5CF6, #10B981);
        }
        
        .tab-navigation {
            display: flex;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 12px;
            padding: 0.5rem;
            border: 1px solid #334155;
            position: relative;
        }
        
        .page-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            color: #CBD5E1;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .page-tab.active {
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .page-tab:hover:not(.active) {
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
        }
        
        .form-section {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #334155;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .form-section:hover {
            border-color: #3B82F6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        
        .form-section h4 {
            color: #F8FAFC;
            margin: 0 0 1.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group label {
            color: #94A3B8;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            display: block;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #475569;
            border-radius: 8px;
            color: #F8FAFC;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .sidebar-card {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #334155;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .sidebar-card:hover {
            border-color: #3B82F6;
            transform: translateY(-2px);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3B82F6;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-state {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #F87171;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .empty-state {
            background: rgba(107, 114, 128, 0.1);
            border: 1px solid rgba(107, 114, 128, 0.3);
            color: #9CA3AF;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #10B981, #059669);
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #10B981;
            color: white;
        }
        
        .status-inactive {
            background: #EF4444;
            color: white;
        }
        
        .status-pending {
            background: #F59E0B;
            color: white;
        }
        
        @media (max-width: 768px) {
            .page-header {
                padding: 1rem;
            }
            
            .page-header > div {
                flex-direction: column;
                gap: 1rem;
            }
            
            .tab-navigation {
                flex-direction: column;
            }
            
            .main-content {
                display: block !important;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="students-isolated">
        <!-- Page Header with Student Info -->
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 id="editPageStudentName" style="margin: 0; font-size: 2rem; background: linear-gradient(135deg, #3B82F6, #8B5CF6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Carregando...</h1>
                    <p id="editPageStudentId" style="margin: 0.5rem 0 0 0; color: #94A3B8;">ID: --</p>
                    <p id="editPageStudentCategory" style="margin: 0.25rem 0 0 0; color: #94A3B8;">Categoria: --</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button onclick="returnToStudentsList()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">
                        <span>‚Üê</span> Voltar
                    </button>
                    <button onclick="saveStudentChanges()" class="btn btn-primary" style="background: linear-gradient(135deg, #059669, #10B981); padding: 0.75rem 1.5rem;">
                        <span>üíæ</span> Salvar Altera√ß√µes
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-container" style="margin-bottom: 2rem;">
            <div class="tab-navigation">
                <button class="page-tab active" data-tab="profile" onclick="switchPageTab('profile')">
                    üë§ Perfil
                </button>
                <button class="page-tab" data-tab="financial" onclick="switchPageTab('financial')">
                    üí≥ Financeiro
                </button>
                <button class="page-tab" data-tab="enrollments" onclick="switchPageTab('enrollments')">
                    üìö Cursos Matriculados
                </button>
                <button class="page-tab" data-tab="classes" onclick="switchPageTab('classes')">
                    üè´ Turmas Ativas
                </button>
                <button class="page-tab" data-tab="progress" onclick="switchPageTab('progress')">
                    üìä Progresso Geral
                </button>
                <button class="page-tab" data-tab="insights" onclick="switchPageTab('insights')">
                    ü§ñ Dashboard IA
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <!-- Left Column - Form Container -->
            <div>
                <!-- Dynamic Form Container -->
                <!-- Tab Content Containers -->
                <div id="profile-content" class="tab-content active">
                    <form id="student-form">
                        <!-- Personal Data Section -->
                        <div class="form-section">
                            <h4>Dados Pessoais</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="student-firstName">Nome</label>
                                    <input type="text" id="student-firstName" name="firstName">
                                </div>
                                <div class="form-group">
                                    <label for="student-lastName">Sobrenome</label>
                                    <input type="text" id="student-lastName" name="lastName">
                                </div>
                                <div class="form-group">
                                    <label for="student-email">Email</label>
                                    <input type="email" id="student-email" name="email">
                                </div>
                                <div class="form-group">
                                    <label for="student-phone">Telefone</label>
                                    <input type="tel" id="student-phone" name="phone">
                                </div>
                                <div class="form-group">
                                    <label for="student-cpf">CPF</label>
                                    <input type="text" id="student-cpf" name="cpf">
                                </div>
                                <div class="form-group">
                                    <label for="student-birthDate">Data de Nascimento</label>
                                    <input type="date" id="student-birthDate" name="birthDate">
                                </div>
                                <div class="form-group">
                                    <label for="student-gender">G√™nero</label>
                                    <select id="student-gender" name="gender">
                                        <option value="MASCULINO">Masculino</option>
                                        <option value="FEMININO">Feminino</option>
                                        <option value="OUTRO">Outro</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Academic Data Section -->
                        <div class="form-section">
                            <h4>Dados Acad√™micos</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="student-category">Categoria</label>
                                    <input type="text" id="student-category" name="category">
                                </div>
                                <div class="form-group">
                                    <label for="student-enrollmentDate">Data de Matr√≠cula</label>
                                    <input type="date" id="student-enrollmentDate" name="enrollmentDate" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="student-status">Status</label>
                                    <select id="student-status" name="isActive">
                                        <option value="true">Ativo</option>
                                        <option value="false">Inativo</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Emergency & Medical Section -->
                        <div class="form-section">
                            <h4>Informa√ß√µes de Emerg√™ncia</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="student-emergencyContact">Contato de Emerg√™ncia</label>
                                    <input type="text" id="student-emergencyContact" name="emergencyContact">
                                </div>
                                <div class="form-group">
                                    <label for="student-medicalConditions">Condi√ß√µes M√©dicas</label>
                                    <textarea id="student-medicalConditions" name="medicalConditions" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div id="financial-content" class="tab-content" style="display: none;">
                    <div class="loading-state" style="text-align: center; padding: 3rem; color: #CBD5E1;">
                        <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                        <p>Carregando dados financeiros...</p>
                    </div>
                </div>
                
                <div id="enrollments-content" class="tab-content" style="display: none;">
                    <div class="loading-state" style="text-align: center; padding: 3rem; color: #CBD5E1;">
                        <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                        <p>Carregando matr√≠culas...</p>
                    </div>
                </div>
                
                <div id="classes-content" class="tab-content" style="display: none;">
                    <div class="loading-state" style="text-align: center; padding: 3rem; color: #CBD5E1;">
                        <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                        <p>Carregando turmas...</p>
                    </div>
                </div>
                
                <div id="progress-content" class="tab-content" style="display: none;">
                    <div class="loading-state" style="text-align: center; padding: 3rem; color: #CBD5E1;">
                        <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                        <p>Carregando progresso...</p>
                    </div>
                </div>
                
                <div id="insights-content" class="tab-content" style="display: none;">
                    <div class="loading-state" style="text-align: center; padding: 3rem; color: #CBD5E1;">
                        <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                        <p>Carregando insights...</p>
                    </div>
                </div>
            </div>

            <!-- Right Column - Sidebar -->
            <div id="editPageSidebar">
                <!-- Student Statistics -->
                <div class="sidebar-card">
                    <h4 style="color: #F8FAFC; margin: 0 0 1rem 0;">üìä Estat√≠sticas</h4>
                    <div class="stats-grid" style="display: grid; gap: 1rem;">
                        <div class="stat-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #CBD5E1;">Cursos Ativos:</span>
                            <span id="sidebarActiveCourses" style="color: #10B981; font-weight: bold;">--</span>
                        </div>
                        <div class="stat-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #CBD5E1;">Turmas:</span>
                            <span id="sidebarActiveClasses" style="color: #3B82F6; font-weight: bold;">--</span>
                        </div>
                        <div class="stat-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #CBD5E1;">Taxa Presen√ßa:</span>
                            <span id="sidebarAttendanceRate" style="color: #F59E0B; font-weight: bold;">--</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="sidebar-card">
                    <h4 style="color: #F8FAFC; margin: 0 0 1rem 0;">‚ö° A√ß√µes R√°pidas</h4>
                    <div class="actions-grid" style="display: grid; gap: 0.75rem;">
                        <button onclick="generateStudentQR()" class="btn btn-outline" style="width: 100%; padding: 0.75rem; border: 1px solid #374151; background: transparent; color: #CBD5E1; border-radius: 8px;">
                            üì± Gerar QR Code
                        </button>
                        <button onclick="exportStudentData()" class="btn btn-outline" style="width: 100%; padding: 0.75rem; border: 1px solid #374151; background: transparent; color: #CBD5E1; border-radius: 8px;">
                            üìä Exportar Dados
                        </button>
                        <button onclick="sendNotification()" class="btn btn-outline" style="width: 100%; padding: 0.75rem; border: 1px solid #374151; background: transparent; color: #CBD5E1; border-radius: 8px;">
                            üìß Enviar Notifica√ß√£o
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; text-align: center; border: 1px solid #334155;">
            <div style="color: #3B82F6; font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
            <p style="color: #F8FAFC; margin: 0;">Carregando dados do aluno...</p>
        </div>
    </div>

    <!-- Include students module -->
    <script src="../js/modules/students.js"></script>
    
    <!-- Remove api.js - usando fetch direto -->
    <script>
        // Get student ID and mode from localStorage (SPA navigation)
        let studentId = null;
        let mode = 'edit';
        
        try {
            const storedMode = localStorage.getItem('studentEditorMode');
            if (storedMode) {
                const modeData = JSON.parse(storedMode);
                studentId = modeData.studentId;
                mode = modeData.mode || 'edit';
                console.log('üìã Student editor mode from localStorage:', modeData);
            }
        } catch (error) {
            console.error('Error reading student editor mode:', error);
        }
        
        // Fallback to URL parameters if localStorage is empty
        if (!studentId) {
            const urlParams = new URLSearchParams(window.location.search);
            studentId = urlParams.get('id');
            mode = urlParams.get('mode') || 'edit';
        }
        
        let currentStudent = null;
        let currentTab = 'profile';

        // Initialize page - works with SPA navigation
        function initializeStudentEditor() {
            console.log('üîß Initializing student editor with ID:', studentId);
            
            try {
                if (studentId) {
                    console.log('üì° Loading student data...');
                    loadStudentData(studentId);
                    // Load the default tab (profile)
                    switchPageTab('profile');
                } else {
                    console.log('üìù Setting up new student form...');
                    // New student form - start with profile tab
                    switchPageTab('profile');
                    
                    const nameElement = document.getElementById('editPageStudentName');
                    const idElement = document.getElementById('editPageStudentId');
                    const categoryElement = document.getElementById('editPageStudentCategory');
                    
                    if (nameElement) nameElement.textContent = 'Novo Aluno';
                    if (idElement) idElement.textContent = 'ID: Ser√° gerado';
                    if (categoryElement) categoryElement.textContent = 'Categoria: A definir';
                    
                    console.log('üìù Loading personal info form...');
                    loadPersonalInfoForm();
                    console.log('‚úÖ Personal info form loaded');
                }
            } catch (error) {
                console.error('‚ùå Error in initializeStudentEditor:', error);
                if (loadingState) loadingState.style.display = 'none';
            }
        }

        // Initialize immediately for SPA, or on DOM ready for direct access
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeStudentEditor);
        } else {
            // DOM is already loaded (SPA navigation case)
            setTimeout(initializeStudentEditor, 100);
        }

        // Load student data from API
        async function loadStudentData(id) {
            try {
                console.log('üì° Fetching student data for ID:', id);
                const response = await fetch(`/api/students/${id}`);
                console.log('üì° API response status:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä Student data loaded:', data);
                    currentStudent = data.data || data;
                    updateStudentHeader(currentStudent);
                    loadStudentStats(id);
                    loadPersonalInfoForm();
                } else {
                    throw new Error('Aluno n√£o encontrado');
                }
            } catch (error) {
                console.error('‚ùå Error loading student:', error);
                showError('Erro ao carregar dados do aluno: ' + error.message);
                setTimeout(() => returnToStudentsList(), 3000);
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        // Update student header information
        function updateStudentHeader(student) {
            const user = student.user || {};
            
            document.getElementById('editPageStudentName').textContent = 
                `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'Aluno sem nome';
            document.getElementById('editPageStudentId').textContent = `ID: ${student.id || 'N/A'}`;
            document.getElementById('editPageStudentCategory').textContent = `Categoria: ${student.category || 'N/A'}`;

            // Set read-only if view mode
            if (mode === 'view') {
                document.querySelector('button[onclick="saveStudentChanges()"]').style.display = 'none';
            }
        }

        // Load student statistics from real APIs
        async function loadStudentStats(id) {
            try {
                // Show loading state
                document.getElementById('sidebarActiveCourses').innerHTML = '<span class="loading-spinner"></span>';
                document.getElementById('sidebarActiveClasses').innerHTML = '<span class="loading-spinner"></span>';
                document.getElementById('sidebarAttendanceRate').innerHTML = '<span class="loading-spinner"></span>';
                
                // Fetch real data from new APIs
                const [coursesResponse, classesResponse, attendanceResponse] = await Promise.all([
                    fetch(`/api/students/${id}/courses`).catch(() => ({ ok: false })),
                    fetch(`/api/students/${id}/classes`).catch(() => ({ ok: false })),
                    fetch(`/api/students/${id}/attendance/stats`).catch(() => ({ ok: false }))
                ]);
                
                // Process courses data
                let activeCourses = 0;
                if (coursesResponse.ok) {
                    const coursesData = await coursesResponse.json();
                    activeCourses = coursesData.success ? (coursesData.data?.length || 0) : 0;
                }
                document.getElementById('sidebarActiveCourses').textContent = activeCourses;
                
                // Process classes data
                let availableClasses = 0;
                if (classesResponse.ok) {
                    const classesData = await classesResponse.json();
                    availableClasses = classesData.success ? (classesData.data?.length || 0) : 0;
                }
                document.getElementById('sidebarActiveClasses').textContent = availableClasses;
                
                // Process attendance data
                let attendanceRate = '0%';
                if (attendanceResponse.ok) {
                    const attendanceData = await attendanceResponse.json();
                    attendanceRate = attendanceData.success ? (attendanceData.data?.rate || 0) + '%' : '0%';
                }
                document.getElementById('sidebarAttendanceRate').textContent = attendanceRate;
                
            } catch (error) {
                console.error('Error loading stats:', error);
                // Show error state
                document.getElementById('sidebarActiveCourses').textContent = '--';
                document.getElementById('sidebarActiveClasses').textContent = '--';
                document.getElementById('sidebarAttendanceRate').textContent = '--';
            }
        }

        // Switch between tabs
        function switchPageTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.page-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Hide all tab content containers
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // Show current tab content container
            const currentContent = document.getElementById(`${tabName}-content`);
            if (currentContent) {
                currentContent.style.display = 'block';
                currentContent.classList.add('active');
            }
            
            // Load tab content using module functions
            loadTabContent(tabName);
        }

        // Load content for specific tab using module functions
        async function loadTabContent(tabName) {
            // No need to manipulate container manually since module functions handle their own containers
            
            try {
                // Ensure students module is available
                if (typeof window.studentsModule === 'undefined') {
                    console.error('Students module not loaded');
                    return;
                }
                
                // Set the current editing student ID
                if (studentId) {
                    window.studentsModule.setCurrentEditingStudent(studentId);
                }
                
                switch(tabName) {
                    case 'profile':
                        await window.studentsModule.loadProfileTab();
                        break;
                        
                    case 'financial':
                        await window.studentsModule.loadFinancialTab();
                        break;
                        
                    case 'enrollments':
                        await window.studentsModule.loadEnrollmentsTab();
                        break;
                        
                    case 'classes':
                        await window.studentsModule.loadClassesTab();
                        break;
                        
                    case 'progress':
                        await window.studentsModule.loadProgressTab();
                        break;
                        
                    case 'insights':
                        await window.studentsModule.loadInsightsTab();
                        break;
                        
                    default:
                        console.warn(`Unknown tab: ${tabName}`);
                }
            } catch (error) {
                console.error(`Error loading ${tabName}:`, error);
                const container = document.getElementById(`${tabName}-content`);
                if (container) {
                    container.innerHTML = `
                        <div class="error-state" style="text-align: center; padding: 3rem; color: #EF4444;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                            <h3>Erro ao carregar dados</h3>
                            <p>${error.message}</p>
                            <button onclick="loadTabContent('${tabName}')" style="margin-top: 1rem; background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                                üîÑ Tentar Novamente
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        function getTabName(tabName) {
            const names = {
                'edit': 'informa√ß√µes pessoais',
                'subscription': 'dados de assinatura', 
                'courses': 'cursos',
                'classes': 'turmas',
                'insights': 'insights de IA'
            };
            return names[tabName] || tabName;
        }

        // Load personal information form
        async function loadPersonalInfoForm() {
            console.log('üìù Starting loadPersonalInfoForm...');
            const container = document.getElementById('pageFormContainer');
            
            if (!container) {
                console.error('‚ùå pageFormContainer not found!');
                return;
            }
            
            console.log('üìù Setting form HTML...');
            container.innerHTML = `
                <form id="editPageStudentForm" style="display: grid; gap: 2rem;">
                    <!-- Personal Information Section -->
                    <div class="form-section">
                        <h4>üë§ Informa√ß√µes Pessoais</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="pageFirstName">Nome *</label>
                                <input type="text" id="pageFirstName" required ${mode === 'view' ? 'disabled' : ''}>
                            </div>
                            <div class="form-group">
                                <label for="pageLastName">Sobrenome *</label>
                                <input type="text" id="pageLastName" required ${mode === 'view' ? 'disabled' : ''}>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="pageEmail">Email *</label>
                                <input type="email" id="pageEmail" required ${mode === 'view' ? 'disabled' : ''}>
                            </div>
                            <div class="form-group">
                                <label for="pagePhone">Telefone</label>
                                <input type="tel" id="pagePhone" ${mode === 'view' ? 'disabled' : ''}>
                            </div>
                        </div>
                    </div>

                    <!-- Academic Information Section -->
                    <div class="form-section">
                        <h4>üéì Informa√ß√µes Acad√™micas</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="pageCategory">Categoria</label>
                                <select id="pageCategory" ${mode === 'view' ? 'disabled' : ''}>
                                    <option value="ADULT">Adulto</option>
                                    <option value="KIDS">Infantil</option>
                                    <option value="TEEN">Adolescente</option>
                                    <option value="SENIOR">Terceira Idade</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pageStatus">Status</label>
                                <select id="pageStatus" ${mode === 'view' ? 'disabled' : ''}>
                                    <option value="true">Ativo</option>
                                    <option value="false">Inativo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            `;

            // Populate form if editing existing student
            if (currentStudent) {
                const user = currentStudent.user || {};
                document.getElementById('pageFirstName').value = user.firstName || '';
                document.getElementById('pageLastName').value = user.lastName || '';
                document.getElementById('pageEmail').value = user.email || '';
                document.getElementById('pagePhone').value = user.phone || '';
                document.getElementById('pageCategory').value = currentStudent.category || 'ADULT';
                document.getElementById('pageStatus').value = user.isActive !== false ? 'true' : 'false';
            }
            
            console.log('‚úÖ loadPersonalInfoForm completed successfully');
        }

        // Load subscription content from real API
        async function loadSubscriptionContent() {
            const container = document.getElementById('pageFormContainer');
            
            if (!studentId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üí≥</div>
                        <h3>Novo Aluno</h3>
                        <p>Aluno ainda n√£o possui assinatura. Crie uma assinatura para come√ßar.</p>
                        <button onclick="createSubscription()" style="margin-top: 1rem; background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            ‚ûï Criar Assinatura
                        </button>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`/api/students/${studentId}/subscription`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        container.innerHTML = generateSubscriptionHTML(data.data);
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üí≥</div>
                                <h3>Nenhuma assinatura ativa</h3>
                                <p>Aluno n√£o possui assinatura no momento.</p>
                                <button onclick="createSubscription()" style="margin-top: 1rem; background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                                    ‚ûï Criar Assinatura
                                </button>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Erro ao carregar assinatura');
                }
            } catch (error) {
                console.error('Error loading subscription:', error);
                container.innerHTML = `
                    <div class="error-state">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <h3>Erro ao carregar assinatura</h3>
                        <p>N√£o foi poss√≠vel carregar dados de assinatura: ${error.message}</p>
                        <button onclick="loadSubscriptionContent()" style="margin-top: 1rem; background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // Load courses content from real API
        async function loadCoursesContent() {
            const container = document.getElementById('pageFormContainer');
            
            if (!studentId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìö</div>
                        <h3>Novo Aluno</h3>
                        <p>Aluno ainda n√£o est√° matriculado em cursos.</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`/api/students/${studentId}/courses`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = generateCoursesHTML(data.data);
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üìö</div>
                                <h3>Nenhum curso matriculado</h3>
                                <p>Aluno ainda n√£o est√° matriculado em nenhum curso.</p>
                                <button onclick="enrollInCourse()" style="margin-top: 1rem; background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                                    ‚ûï Matricular em Curso
                                </button>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Erro ao carregar cursos');
                }
            } catch (error) {
                console.error('Error loading courses:', error);
                container.innerHTML = `
                    <div class="error-state">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <h3>Erro ao carregar cursos</h3>
                        <p>N√£o foi poss√≠vel carregar informa√ß√µes dos cursos: ${error.message}</p>
                        <button onclick="loadCoursesContent()" style="margin-top: 1rem; background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // Load classes content from real API
        async function loadClassesContent() {
            const container = document.getElementById('pageFormContainer');
            
            if (!studentId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üè´</div>
                        <h3>Novo Aluno</h3>
                        <p>Aluno ainda n√£o participa de turmas.</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`/api/students/${studentId}/classes`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = generateClassesHTML(data.data);
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üè´</div>
                                <h3>Nenhuma turma dispon√≠vel</h3>
                                <p>${data.message || 'Aluno n√£o est√° participando de turmas no momento.'}</p>
                                ${data.message?.includes('no active course') ? `
                                    <p style="color: #F59E0B; margin-top: 1rem;">
                                        üí° Dica: Primeiro matricule o aluno em um curso para ver turmas dispon√≠veis.
                                    </p>
                                ` : ''}
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Erro ao carregar turmas');
                }
            } catch (error) {
                console.error('Error loading classes:', error);
                container.innerHTML = `
                    <div class="error-state">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <h3>Erro ao carregar turmas</h3>
                        <p>N√£o foi poss√≠vel carregar informa√ß√µes das turmas: ${error.message}</p>
                        <button onclick="loadClassesContent()" style="margin-top: 1rem; background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // Load insights content from real API
        async function loadInsightsContent() {
            const container = document.getElementById('pageFormContainer');
            
            if (!studentId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ü§ñ</div>
                        <h3>Novo Aluno</h3>
                        <p>Insights ser√£o gerados ap√≥s o aluno ter dados suficientes.</p>
                    </div>
                `;
                return;
            }
            
            try {
                const response = await fetch(`/api/students/${studentId}/insights`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.length > 0) {
                        container.innerHTML = generateInsightsHTML(data.data);
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">ü§ñ</div>
                                <h3>Nenhum insight dispon√≠vel</h3>
                                <p>N√£o foram encontrados dados suficientes para gerar insights sobre este aluno.</p>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Erro ao carregar insights');
                }
            } catch (error) {
                console.error('Error loading insights:', error);
                container.innerHTML = `
                    <div class="error-state">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <h3>Erro ao carregar insights</h3>
                        <p>N√£o foi poss√≠vel carregar insights: ${error.message}</p>
                        <button onclick="loadInsightsContent()" style="margin-top: 1rem; background: #3B82F6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // Generate insights HTML
        function generateInsightsHTML(insights) {
            return `
                <div style="background: rgba(59, 130, 246, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                    <h3 style="color: #3B82F6; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        <span>ü§ñ</span> Dashboard de Insights - IA
                    </h3>
                    <p style="color: #94A3B8; margin-bottom: 2rem; font-size: 0.9rem;">An√°lise inteligente baseada nos dados do aluno</p>
                    
                    <div style="display: grid; gap: 1rem;">
                        ${insights.map(insight => `
                            <div style="background: ${insight.type === 'warning' ? 'rgba(251, 191, 36, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; border-radius: 8px; padding: 1.5rem; border-left: 4px solid ${insight.type === 'warning' ? '#F59E0B' : '#10B981'}; display: flex; align-items: flex-start; gap: 1rem;">
                                <div style="font-size: 1.5rem; flex-shrink: 0;">
                                    ${insight.type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ'}
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: #E2E8F0; font-weight: 600;">${insight.title}</h4>
                                    <p style="margin: 0; color: #94A3B8; font-size: 0.9rem; line-height: 1.4;">${insight.message}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #334155;">
                        <p style="color: #64748B; font-size: 0.85rem; line-height: 1.4; margin: 0;">
                            üí° <strong>Dica:</strong> Os insights s√£o gerados automaticamente com base nos dados dispon√≠veis. 
                            Use-os como apoio para tomadas de decis√£o pedag√≥gicas e administrativas.
                        </p>
                    </div>
                </div>
            `;
        }

        // Generate subscription HTML
        function generateSubscriptionHTML(subscription) {
            return `
                <div style="background: rgba(16, 185, 129, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                    <h3 style="color: #10B981; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üí≥</span> Assinatura Atual
                    </h3>
                    
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid #3B82F6; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <div style="color: #3B82F6; font-weight: bold; font-size: 1.1rem;">üìã ${subscription.plan?.name || 'Plano n√£o informado'}</div>
                                <div style="color: #CBD5E1; font-size: 0.875rem; margin-top: 0.25rem;">${subscription.plan?.description || ''}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #10B981; font-weight: bold; font-size: 1.2rem;">R$ ${(subscription.plan?.price || 0).toLocaleString('pt-BR')}</div>
                                <div style="color: #CBD5E1; font-size: 0.75rem;">${subscription.plan?.billingType || 'mensal'}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div style="text-align: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                                <div style="color: #F8FAFC; font-weight: bold;">In√≠cio</div>
                                <div style="color: #10B981; font-size: 0.875rem;">${new Date(subscription.startDate).toLocaleDateString('pt-BR')}</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                                <div style="color: #F8FAFC; font-weight: bold;">Pr√≥ximo Pagamento</div>
                                <div style="color: #F59E0B; font-size: 0.875rem;">${subscription.nextPayment ? new Date(subscription.nextPayment).toLocaleDateString('pt-BR') : 'N/A'}</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                                <div style="color: #F8FAFC; font-weight: bold;">Status</div>
                                <div class="status-badge status-${subscription.status?.toLowerCase() || 'pending'}">${subscription.status || 'PENDENTE'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate courses HTML
        function generateCoursesHTML(courses) {
            return `
                <div style="background: rgba(59, 130, 246, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                    <h3 style="color: #3B82F6; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üìö</span> Cursos Matriculados
                    </h3>
                    
                    ${courses.map(course => `
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #10B981; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #10B981; font-weight: bold;">ü•ã ${course.name || 'Curso sem nome'}</div>
                                    <div style="color: #CBD5E1; font-size: 0.875rem; margin-top: 0.25rem;">
                                        Iniciado em: ${course.startDate ? new Date(course.startDate).toLocaleDateString('pt-BR') : 'N/A'} ‚Ä¢ 
                                        Progresso: ${course.progress || 0}%
                                    </div>
                                </div>
                                <div class="status-badge status-${(course.status || 'active').toLowerCase()}">
                                    ${course.status || 'ATIVO'}
                                </div>
                            </div>
                            
                            ${course.progress ? `
                                <div style="margin-top: 1rem;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${course.progress}%;"></div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem; color: #CBD5E1;">
                                        <span>Aula ${course.currentLesson || 0} de ${course.totalLessons || 0}</span>
                                        <span>${course.progress}% conclu√≠do</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Generate classes HTML
        function generateClassesHTML(classes) {
            return `
                <div style="background: rgba(245, 158, 11, 0.05); border-radius: 12px; padding: 2rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                    <h3 style="color: #F59E0B; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üè´</span> Turmas Dispon√≠veis
                        <span style="background: rgba(245, 158, 11, 0.2); color: #F59E0B; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; margin-left: auto;">
                            ${classes.length} turma${classes.length !== 1 ? 's' : ''}
                        </span>
                    </h3>
                    
                    ${classes.map(classItem => {
                        const classDate = new Date(classItem.date);
                        const isToday = classDate.toDateString() === new Date().toDateString();
                        const isPast = classDate < new Date();
                        
                        return `
                            <div style="background: ${isPast ? 'rgba(107, 114, 128, 0.1)' : isToday ? 'rgba(16, 185, 129, 0.1)' : 'rgba(59, 130, 246, 0.1)'}; padding: 1rem; border-radius: 8px; border: 1px solid ${isPast ? '#6B7280' : isToday ? '#10B981' : '#3B82F6'}; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="color: ${isPast ? '#6B7280' : isToday ? '#10B981' : '#3B82F6'}; font-weight: bold;">
                                        ${classItem.title}
                                    </div>
                                    <div class="status-badge status-${classItem.status.toLowerCase()}">
                                        ${classItem.hasAttended ? '‚úÖ PARTICIPOU' : isPast ? '‚è∞ PASSADA' : isToday ? 'üî¥ HOJE' : 'üìÖ AGENDADA'}
                                    </div>
                                </div>
                                
                                <div style="color: #CBD5E1; font-size: 0.875rem; margin-bottom: 0.75rem;">
                                    üìÖ ${classDate.toLocaleDateString('pt-BR')} √†s ${classItem.schedule} <br>
                                    üë®‚Äçüè´ Instrutor: ${classItem.instructor.name}<br>
                                    üìö Curso: ${classItem.courseName}
                                    ${classItem.unit ? `<br>üè¢ Unidade: ${classItem.unit}` : ''}
                                    ${classItem.mat ? `<br>ü•ã Tatame: ${classItem.mat}` : ''}
                                </div>
                                
                                ${classItem.description ? `
                                    <div style="background: rgba(255, 255, 255, 0.05); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem;">
                                        <div style="color: #F8FAFC; font-size: 0.875rem;">${classItem.description}</div>
                                    </div>
                                ` : ''}
                                
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="color: #CBD5E1; font-size: 0.875rem;">
                                        üë• ${classItem.actualStudents}/${classItem.maxStudents} alunos
                                    </div>
                                    ${!isPast && classItem.qrCode ? `
                                        <button onclick="showQRCode('${classItem.qrCode}')" style="background: #10B981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                                            üì± QR Check-in
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Return to students list
        function returnToStudentsList() {
            if (window.navigateToModule) {
                window.navigateToModule('students');
            } else {
                window.location.href = '/views/students.html';
            }
        }

        // Save student changes
        async function saveStudentChanges() {
            if (mode === 'view') return;
            
            try {
                const formData = {
                    firstName: document.getElementById('pageFirstName').value,
                    lastName: document.getElementById('pageLastName').value,
                    email: document.getElementById('pageEmail').value,
                    phone: document.getElementById('pagePhone').value,
                    category: document.getElementById('pageCategory').value,
                    isActive: document.getElementById('pageStatus').value === 'true'
                };

                let response;
                if (studentId) {
                    // Update existing student
                    response = await fetch(`/api/students/${studentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Create new student
                    response = await fetch('/api/students', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }

                if (response.ok) {
                    showSuccess('Aluno salvo com sucesso!');
                    setTimeout(() => returnToStudentsList(), 2000);
                } else {
                    throw new Error('Erro ao salvar aluno');
                }
            } catch (error) {
                console.error('Error saving student:', error);
                showError('Erro ao salvar aluno: ' + error.message);
            }
        }

        // Show error message
        function showError(message) {
            alert('‚ùå ' + message);
        }

        // Show success message  
        function showSuccess(message) {
            alert('‚úÖ ' + message);
        }

        // Quick action functions
        function generateStudentQR() {
            showError('Fun√ß√£o QR Code em desenvolvimento');
        }

        function exportStudentData() {
            showError('Fun√ß√£o de exporta√ß√£o em desenvolvimento');
        }

        function sendNotification() {
            showError('Fun√ß√£o de notifica√ß√£o em desenvolvimento');
        }

        // Smart CTA functions for contextual actions
        function createSubscription() {
            showError('Fun√ß√£o de cria√ß√£o de assinatura em desenvolvimento');
        }

        function enrollInCourse() {
            showError('Fun√ß√£o de matr√≠cula em curso em desenvolvimento');
        }

        function showQRCode(qrCode) {
            alert(`QR Code para check-in: ${qrCode}\n\nFun√ß√£o de exibi√ß√£o de QR em desenvolvimento`);
        }
    </script>
</body>
</html>