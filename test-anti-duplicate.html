<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö´ Anti-Duplicate Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .test-card { 
            background: rgba(255,255,255,0.1); 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 12px; 
            backdrop-filter: blur(10px);
        }
        .success { background: rgba(40, 167, 69, 0.2); border-left: 4px solid #28a745; }
        .error { background: rgba(220, 53, 69, 0.2); border-left: 4px solid #dc3545; }
        .warning { background: rgba(255, 193, 7, 0.2); border-left: 4px solid #ffc107; }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            border: none;
            border-radius: 8px;
            cursor: pointer; 
            font-weight: bold;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        .btn-danger { background: linear-gradient(45deg, #dc3545, #fd7e14); }
        .console-log { 
            background: rgba(0,0,0,0.5); 
            padding: 10px; 
            border-radius: 6px; 
            margin: 10px 0;
            font-family: monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
        }
        .stats { 
            display: flex; 
            gap: 20px; 
            margin: 20px 0;
        }
        .stat-box { 
            background: rgba(255,255,255,0.2); 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center;
            flex: 1;
        }
        .stat-number { 
            font-size: 2em; 
            font-weight: bold; 
            color: #4ecdc4;
        }
        .stat-label { 
            font-size: 0.9em; 
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <h1>üö´ Anti-Duplicate Test - Instructors Module</h1>
    <p><strong>Objetivo:</strong> Verificar se a corre√ß√£o eliminou os objetos duplicados na interface.</p>

    <div class="stats">
        <div class="stat-box">
            <div class="stat-number" id="init-count">0</div>
            <div class="stat-label">Inicializa√ß√µes</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="render-count">0</div>
            <div class="stat-label">Renderiza√ß√µes</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="api-calls">0</div>
            <div class="stat-label">Chamadas API</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="duplicates">0</div>
            <div class="stat-label">Duplicatas</div>
        </div>
    </div>

    <div class="test-card">
        <h2>üß™ Test 1: Multiple Navigation Simulation</h2>
        <p>Simula m√∫ltiplas navega√ß√µes para o m√≥dulo de instrutores</p>
        <button onclick="testMultipleNavigation()">Simulate Multiple Navigation</button>
        <button onclick="resetTest()" class="btn-danger">Reset Test</button>
        <div id="navigation-result"></div>
    </div>

    <div class="test-card">
        <h2>üîç Test 2: DOM Duplicate Detection</h2>
        <p>Verifica se existem elementos duplicados no DOM</p>
        <button onclick="detectDuplicates()">Detect DOM Duplicates</button>
        <div id="duplicate-result"></div>
    </div>

    <div class="test-card">
        <h2>üìä Test 3: Module State Monitoring</h2>
        <p>Monitora o estado do m√≥dulo em tempo real</p>
        <button onclick="startMonitoring()">Start Monitoring</button>
        <button onclick="stopMonitoring()" class="btn-danger">Stop Monitoring</button>
        <div id="monitoring-result"></div>
    </div>

    <div class="test-card">
        <h2>üñ•Ô∏è Live Module Container</h2>
        <div id="module-container" style="margin-top: 20px; min-height: 400px; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 20px;">
            <div style="text-align: center; padding: 50px; opacity: 0.6;">
                Module will be loaded here...
            </div>
        </div>
    </div>

    <div class="test-card">
        <h2>üìã Console Logs</h2>
        <button onclick="clearConsole()">Clear</button>
        <div id="console-output" class="console-log">
            <div>üîç Console logs will appear here...</div>
        </div>
    </div>

    <script>
        // Statistics tracking
        let stats = {
            initCount: 0,
            renderCount: 0,
            apiCalls: 0,
            duplicates: 0
        };

        let monitoringInterval = null;

        // Enhanced console capture
        const originalLog = console.log;
        const originalError = console.error;
        const consoleOutput = document.getElementById('console-output');

        function addToConsole(type, message) {
            const div = document.createElement('div');
            div.style.color = type === 'error' ? '#ff6b6b' : '#4ecdc4';
            div.style.marginBottom = '5px';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${type.toUpperCase()}: ${message}`;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;

            // Update statistics based on log content
            updateStatsFromLog(message);
        }

        function updateStatsFromLog(message) {
            if (message.includes('Instructors Module - Starting') || message.includes('initInstructorsModule called')) {
                stats.initCount++;
                document.getElementById('init-count').textContent = stats.initCount;
            }
            if (message.includes('Rendering instructors') || message.includes('renderInstructors')) {
                stats.renderCount++;
                document.getElementById('render-count').textContent = stats.renderCount;
            }
            if (message.includes('GET /api/instructors')) {
                stats.apiCalls++;
                document.getElementById('api-calls').textContent = stats.apiCalls;
            }
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole('log', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('error', args.join(' '));
        };

        function clearConsole() {
            consoleOutput.innerHTML = '<div>üîç Console cleared...</div>';
        }

        function resetTest() {
            stats = { initCount: 0, renderCount: 0, apiCalls: 0, duplicates: 0 };
            document.getElementById('init-count').textContent = '0';
            document.getElementById('render-count').textContent = '0';
            document.getElementById('api-calls').textContent = '0';
            document.getElementById('duplicates').textContent = '0';
            
            document.getElementById('module-container').innerHTML = `
                <div style="text-align: center; padding: 50px; opacity: 0.6;">
                    Module will be loaded here...
                </div>
            `;
            
            clearConsole();
            console.log('üîÑ Test reset completed');
        }

        async function testMultipleNavigation() {
            const resultDiv = document.getElementById('navigation-result');
            resultDiv.innerHTML = '<div>üîÑ Testing multiple navigation...</div>';

            try {
                console.log('üß™ Starting multiple navigation test');
                
                // Load required scripts
                await loadScript('/js/shared/api-client.js');
                await loadScript('/js/modules/instructors/controllers/InstructorsController.js');
                await loadScript('/js/modules/instructors/index.js');

                const container = document.getElementById('module-container');
                
                // Simulate multiple rapid calls (the problem scenario)
                console.log('üß™ Simulating multiple rapid navigation calls...');
                
                const promises = [];
                for (let i = 0; i < 3; i++) {
                    promises.push(
                        window.initInstructorsModule(container).catch(err => {
                            console.error(`Navigation ${i + 1} failed:`, err);
                        })
                    );
                }

                await Promise.all(promises);
                
                console.log('üß™ Multiple navigation test completed');
                resultDiv.innerHTML = '<div class="success">‚úÖ Multiple navigation test completed! Check stats above.</div>';
                
            } catch (error) {
                console.error('Multiple navigation test failed:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå Test failed: ${error.message}</div>`;
            }
        }

        function detectDuplicates() {
            const resultDiv = document.getElementById('duplicate-result');
            resultDiv.innerHTML = '<div>üîç Scanning for duplicates...</div>';

            try {
                const container = document.getElementById('module-container');
                
                // Check for duplicate elements by class
                const duplicateClasses = [
                    'module-header-premium',
                    'stat-card-enhanced',
                    'data-card-premium',
                    'instructors-list',
                    'instructor-card'
                ];

                let duplicatesFound = 0;
                let duplicateReport = [];

                duplicateClasses.forEach(className => {
                    const elements = container.querySelectorAll(`.${className}`);
                    if (elements.length > 1) {
                        duplicatesFound += elements.length - 1;
                        duplicateReport.push(`${className}: ${elements.length} instances`);
                    }
                });

                // Check for duplicate instructors by data-id
                const instructorElements = container.querySelectorAll('[data-id]');
                const instructorIds = {};
                instructorElements.forEach(el => {
                    const id = el.dataset.id;
                    if (instructorIds[id]) {
                        instructorIds[id]++;
                    } else {
                        instructorIds[id] = 1;
                    }
                });

                Object.keys(instructorIds).forEach(id => {
                    if (instructorIds[id] > 1) {
                        duplicatesFound += instructorIds[id] - 1;
                        duplicateReport.push(`Instructor ID ${id}: ${instructorIds[id]} instances`);
                    }
                });

                stats.duplicates = duplicatesFound;
                document.getElementById('duplicates').textContent = duplicatesFound;

                if (duplicatesFound === 0) {
                    resultDiv.innerHTML = '<div class="success">‚úÖ No duplicates found! Module is clean.</div>';
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Found ${duplicatesFound} duplicates:
                            <ul style="margin: 10px 0 0 20px;">
                                ${duplicateReport.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                console.log(`üîç Duplicate detection completed: ${duplicatesFound} duplicates found`);
                
            } catch (error) {
                console.error('Duplicate detection failed:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå Detection failed: ${error.message}</div>`;
            }
        }

        function startMonitoring() {
            const resultDiv = document.getElementById('monitoring-result');
            
            if (monitoringInterval) {
                resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Monitoring already active</div>';
                return;
            }

            resultDiv.innerHTML = '<div>üìä Monitoring started...</div>';
            
            monitoringInterval = setInterval(() => {
                detectDuplicates();
                
                // Check module state
                const moduleState = {
                    moduleExists: typeof window.InstructorsModule !== 'undefined',
                    moduleInitialized: window.InstructorsModule?.initialized || false,
                    controllerExists: typeof window.InstructorsController !== 'undefined',
                    apiClientExists: typeof window.createModuleAPI !== 'undefined'
                };

                resultDiv.innerHTML = `
                    <div class="success">
                        üìä Monitoring active - Last check: ${new Date().toLocaleTimeString()}
                        <pre style="margin-top: 10px;">${JSON.stringify(moduleState, null, 2)}</pre>
                    </div>
                `;
            }, 2000);

            console.log('üìä Module monitoring started');
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                document.getElementById('monitoring-result').innerHTML = '<div>üìä Monitoring stopped</div>';
                console.log('üìä Module monitoring stopped');
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve(); // Script already loaded
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Auto-start monitoring on page load
        window.addEventListener('load', () => {
            console.log('üö´ Anti-Duplicate Test page loaded');
            setTimeout(() => {
                console.log('üîÑ Starting initial duplicate detection...');
                detectDuplicates();
            }, 1000);
        });
    </script>
</body>
</html>
