<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Valida√ß√£o de organizationId</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #667eea; }
        h2 { color: #764ba2; margin-top: 0; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { opacity: 0.9; }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            border-left: 4px solid #667eea;
        }
        .success { border-left-color: #28a745; }
        .warning { border-left-color: #ffc107; }
        .error { border-left-color: #dc3545; }
        .info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîí Teste de Valida√ß√£o de organizationId</h1>
    
    <div class="test-section">
        <h2>1Ô∏è‚É£ Configurar Cen√°rio de Teste</h2>
        <div class="info">
            <strong>organizationId Correto:</strong> ff5ee00e-d8a3-4291-9428-d28b852fb472<br>
            <strong>organizationId Inv√°lido:</strong> 452c0b35-1822-4890-851e-922356c812fb
        </div>
        
        <button onclick="setInvalidOrg()">‚ùå Injetar org INV√ÅLIDA no localStorage</button>
        <button onclick="setValidOrg()">‚úÖ Injetar org V√ÅLIDA no localStorage</button>
        <button onclick="clearStorage()">üßπ Limpar todo o storage</button>
        
        <div id="storage-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>2Ô∏è‚É£ Verificar Estado Atual</h2>
        <button onclick="checkStorage()">üîç Verificar localStorage/sessionStorage</button>
        <button onclick="checkOrganizationContext()">üè¢ Verificar OrganizationContext</button>
        
        <div id="check-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>3Ô∏è‚É£ Simular Inicializa√ß√£o</h2>
        <div class="info">
            Isso simula o que acontece quando a p√°gina carrega.<br>
            Se houver organizationId inv√°lida, ela deve ser <strong>automaticamente removida</strong>.
        </div>
        
        <button onclick="simulateInit()">‚ñ∂Ô∏è Simular inicializa√ß√£o do OrganizationContext</button>
        
        <div id="init-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>4Ô∏è‚É£ Teste Completo</h2>
        <button onclick="runFullTest()">üß™ Executar teste completo</button>
        
        <div id="full-test-result" class="result" style="display:none;"></div>
    </div>

    <script>
        const INVALID_ORG = '452c0b35-1822-4890-851e-922356c812fb';
        const VALID_ORG = 'ff5ee00e-d8a3-4291-9428-d28b852fb472';

        function log(elementId, message, className = '') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'result ' + className;
            element.textContent = message;
        }

        function setInvalidOrg() {
            localStorage.setItem('activeOrganizationId', INVALID_ORG);
            sessionStorage.setItem('activeOrganizationId', INVALID_ORG);
            log('storage-result', 
                '‚ùå organizationId INV√ÅLIDA injetada:\n' +
                'localStorage: ' + INVALID_ORG + '\n' +
                'sessionStorage: ' + INVALID_ORG + '\n\n' +
                'üìå Agora simule a inicializa√ß√£o para ver a prote√ß√£o funcionando!',
                'warning'
            );
        }

        function setValidOrg() {
            localStorage.setItem('activeOrganizationId', VALID_ORG);
            sessionStorage.setItem('activeOrganizationId', VALID_ORG);
            log('storage-result', 
                '‚úÖ organizationId V√ÅLIDA injetada:\n' +
                'localStorage: ' + VALID_ORG + '\n' +
                'sessionStorage: ' + VALID_ORG,
                'success'
            );
        }

        function clearStorage() {
            localStorage.removeItem('activeOrganizationId');
            sessionStorage.removeItem('activeOrganizationId');
            log('storage-result', 
                'üßπ Storage limpo!\n' +
                'localStorage: null\n' +
                'sessionStorage: null',
                'info'
            );
        }

        function checkStorage() {
            const local = localStorage.getItem('activeOrganizationId');
            const session = sessionStorage.getItem('activeOrganizationId');
            
            let message = 'üìä Estado atual do storage:\n\n';
            message += 'localStorage: ' + (local || 'null') + '\n';
            message += 'sessionStorage: ' + (session || 'null') + '\n\n';
            
            if (local === VALID_ORG) {
                message += '‚úÖ localStorage tem org V√ÅLIDA';
            } else if (local === INVALID_ORG) {
                message += '‚ùå localStorage tem org INV√ÅLIDA (ser√° limpa automaticamente)';
            } else {
                message += '‚ÑπÔ∏è localStorage vazio';
            }
            
            log('check-result', message, local === VALID_ORG ? 'success' : (local === INVALID_ORG ? 'warning' : 'info'));
        }

        function checkOrganizationContext() {
            if (typeof window.organizationContext === 'undefined') {
                log('check-result', 
                    '‚ö†Ô∏è OrganizationContext n√£o est√° carregado.\n' +
                    'Abra o sistema principal para testar.',
                    'warning'
                );
                return;
            }

            const currentOrg = window.organizationContext.currentOrgId;
            let message = 'üè¢ Estado do OrganizationContext:\n\n';
            message += 'currentOrgId: ' + (currentOrg || 'null') + '\n';
            message += 'userOrganizations: ' + (window.organizationContext.userOrganizations?.length || 0) + ' organiza√ß√µes\n\n';
            
            if (currentOrg === VALID_ORG) {
                message += '‚úÖ Organiza√ß√£o ativa √© V√ÅLIDA';
            } else if (currentOrg === INVALID_ORG) {
                message += '‚ùå Organiza√ß√£o ativa √© INV√ÅLIDA';
            } else {
                message += '‚ÑπÔ∏è Nenhuma organiza√ß√£o ativa';
            }
            
            log('check-result', message, currentOrg === VALID_ORG ? 'success' : 'warning');
        }

        function simulateInit() {
            // Mock do OrganizationContext para teste
            const mockUserOrganizations = [{
                id: VALID_ORG,
                name: 'Smart Defence',
                slug: 'smart-defence'
            }];

            const isValidOrganization = (orgId) => {
                if (!orgId) return false;
                return mockUserOrganizations.some(org => org.id === orgId);
            };

            const resolveActiveOrganization = () => {
                let logs = [];

                // 1. Check localStorage
                const storedOrgId = localStorage.getItem('activeOrganizationId');
                if (storedOrgId) {
                    if (isValidOrganization(storedOrgId)) {
                        logs.push('‚úÖ localStorage: org V√ÅLIDA encontrada');
                        return { orgId: storedOrgId, logs };
                    } else {
                        logs.push('‚ö†Ô∏è localStorage: org INV√ÅLIDA detectada ‚Üí LIMPANDO');
                        localStorage.removeItem('activeOrganizationId');
                        logs.push('üßπ localStorage limpo com sucesso');
                    }
                }

                // 2. Check sessionStorage
                const sessionOrgId = sessionStorage.getItem('activeOrganizationId');
                if (sessionOrgId) {
                    if (isValidOrganization(sessionOrgId)) {
                        logs.push('‚úÖ sessionStorage: org V√ÅLIDA encontrada');
                        return { orgId: sessionOrgId, logs };
                    } else {
                        logs.push('‚ö†Ô∏è sessionStorage: org INV√ÅLIDA detectada ‚Üí LIMPANDO');
                        sessionStorage.removeItem('activeOrganizationId');
                        logs.push('üßπ sessionStorage limpo com sucesso');
                    }
                }

                // 3. Fallback para primeira org dispon√≠vel
                logs.push('üìå Usando primeira org dispon√≠vel: ' + VALID_ORG);
                return { orgId: VALID_ORG, logs };
            };

            const result = resolveActiveOrganization();
            
            let message = 'üîÑ Simula√ß√£o de Inicializa√ß√£o:\n\n';
            message += result.logs.join('\n') + '\n\n';
            message += 'üéØ Resultado final:\n';
            message += 'organizationId resolvida: ' + result.orgId + '\n\n';
            
            if (result.orgId === VALID_ORG) {
                message += '‚úÖ SUCESSO: Sistema usar√° a organiza√ß√£o correta!';
                log('init-result', message, 'success');
            } else {
                message += '‚ùå ERRO: Sistema ainda est√° usando org inv√°lida!';
                log('init-result', message, 'error');
            }
        }

        async function runFullTest() {
            let output = 'üß™ TESTE COMPLETO - Valida√ß√£o de organizationId\n';
            output += '='.repeat(60) + '\n\n';

            // Teste 1: Cen√°rio com org inv√°lida
            output += 'üìù TESTE 1: Org inv√°lida no localStorage\n';
            output += '-'.repeat(60) + '\n';
            localStorage.setItem('activeOrganizationId', INVALID_ORG);
            output += '1. Injetado: ' + INVALID_ORG + '\n';
            
            // Simular valida√ß√£o
            const mockUserOrgs = [{ id: VALID_ORG, name: 'Smart Defence' }];
            const isValid = mockUserOrgs.some(org => org.id === INVALID_ORG);
            output += '2. Valida√ß√£o: ' + (isValid ? '‚úÖ V√ÅLIDA' : '‚ùå INV√ÅLIDA') + '\n';
            
            if (!isValid) {
                localStorage.removeItem('activeOrganizationId');
                output += '3. A√ß√£o: üßπ Cache limpo automaticamente\n';
                output += '4. Resultado: ‚úÖ Sistema preveniu uso de org inv√°lida\n';
            }
            
            const afterTest1 = localStorage.getItem('activeOrganizationId');
            output += '5. localStorage final: ' + (afterTest1 || 'null (limpo com sucesso)') + '\n\n';

            // Teste 2: Cen√°rio com org v√°lida
            output += 'üìù TESTE 2: Org v√°lida no localStorage\n';
            output += '-'.repeat(60) + '\n';
            localStorage.setItem('activeOrganizationId', VALID_ORG);
            output += '1. Injetado: ' + VALID_ORG + '\n';
            
            const isValid2 = mockUserOrgs.some(org => org.id === VALID_ORG);
            output += '2. Valida√ß√£o: ' + (isValid2 ? '‚úÖ V√ÅLIDA' : '‚ùå INV√ÅLIDA') + '\n';
            
            if (isValid2) {
                output += '3. A√ß√£o: ‚úÖ Cache mantido (org v√°lida)\n';
                output += '4. Resultado: ‚úÖ Sistema usar√° esta organiza√ß√£o\n';
            }
            
            const afterTest2 = localStorage.getItem('activeOrganizationId');
            output += '5. localStorage final: ' + afterTest2 + '\n\n';

            // Resumo
            output += '='.repeat(60) + '\n';
            output += 'üìä RESUMO DOS TESTES\n';
            output += '='.repeat(60) + '\n';
            output += '‚úÖ Teste 1: Org inv√°lida foi detectada e removida\n';
            output += '‚úÖ Teste 2: Org v√°lida foi mantida\n';
            output += '‚úÖ Prote√ß√£o funcionando corretamente!\n\n';
            output += 'üéâ Sistema agora est√° protegido contra organizationIds inv√°lidas!';

            log('full-test-result', output, 'success');
        }
    </script>
</body>
</html>
