<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - Agenda H√≠brida</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/modules/hybrid-agenda.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-actions { margin: 20px 0; }
        .test-btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #1976d2; color: white; }
        .test-results { background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        #module-container { margin-top: 20px; min-height: 500px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .info { color: #2196f3; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Teste Final - Agenda H√≠brida</h1>
        <p>Testando se a agenda h√≠brida funciona completamente...</p>
        
        <div class="test-actions">
            <button class="test-btn" onclick="runFullTest()">üöÄ Executar Teste Completo</button>
            <button class="test-btn" onclick="testSPAIntegration()">üîÑ Testar Integra√ß√£o SPA</button>
            <button class="test-btn" onclick="clearResults()">üßπ Limpar</button>
        </div>
        
        <div class="test-results" id="test-results">
            <div id="results-content">Pronto para executar testes...</div>
        </div>
        
        <!-- Simular elementos do sistema principal -->
        <div class="module-header">
            <h1>Agenda H√≠brida</h1>
            <div class="breadcrumb">Home / Agenda H√≠brida</div>
        </div>
        
        <div id="module-container">
            <p>Container aguardando carregamento do m√≥dulo...</p>
        </div>
    </div>

    <!-- Load dependencies exactly like main system -->
    <script src="/js/shared/utils/feedback.js"></script>
    <script src="/js/shared/api-client.js"></script>
    <script src="/js/shared/design-tokens.js"></script>
    
    <script>
        let testResults = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            
            testResults.push({ timestamp, icon, message, type });
            updateResults();
        }
        
        function updateResults() {
            const content = document.getElementById('results-content');
            content.innerHTML = testResults.map(r => 
                `<div class="${r.type}">[${r.timestamp}] ${r.icon} ${r.message}</div>`
            ).join('');
            content.scrollTop = content.scrollHeight;
        }
        
        function clearResults() {
            testResults = [];
            updateResults();
        }
        
        async function runFullTest() {
            clearResults();
            log('üîß Iniciando teste completo da Agenda H√≠brida...', 'info');
            
            try {
                // Test 1: Check dependencies
                log('1Ô∏è‚É£ Verificando depend√™ncias...', 'info');
                await checkDependencies();
                
                // Test 2: Load module script
                log('2Ô∏è‚É£ Carregando script do m√≥dulo...', 'info');
                await loadModuleScript();
                
                // Test 3: Initialize module
                log('3Ô∏è‚É£ Inicializando m√≥dulo...', 'info');
                await initializeModule();
                
                // Test 4: Test interactions
                log('4Ô∏è‚É£ Testando intera√ß√µes...', 'info');
                await testInteractions();
                
                log('üéâ Teste completo finalizado com sucesso!', 'success');
                
            } catch (error) {
                log(`‚ùå Teste falhou: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        }
        
        async function checkDependencies() {
            // Check API client
            if (typeof window.createModuleAPI === 'function') {
                log('‚úÖ createModuleAPI dispon√≠vel', 'success');
            } else {
                log('‚è≥ Aguardando createModuleAPI...', 'info');
                
                let attempts = 0;
                while (!window.createModuleAPI && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (window.createModuleAPI) {
                    log('‚úÖ createModuleAPI carregado', 'success');
                } else {
                    throw new Error('createModuleAPI n√£o dispon√≠vel ap√≥s 5 segundos');
                }
            }
            
            // Check other utilities
            if (typeof window.waitForAPIClient === 'function') {
                log('‚úÖ waitForAPIClient dispon√≠vel', 'success');
            } else {
                log('‚ö†Ô∏è waitForAPIClient n√£o encontrado', 'error');
            }
        }
        
        async function loadModuleScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = '/js/modules/hybrid-agenda/index.js';
                script.type = 'text/javascript';
                
                script.onload = () => {
                    log('‚úÖ Script carregado com sucesso', 'success');
                    
                    // Wait for module to be available
                    setTimeout(() => {
                        if (typeof window.initHybridAgendaModule === 'function') {
                            log('‚úÖ initHybridAgendaModule dispon√≠vel', 'success');
                            resolve();
                        } else {
                            log('‚ùå initHybridAgendaModule n√£o encontrado', 'error');
                            reject(new Error('Module function not available'));
                        }
                    }, 500);
                };
                
                script.onerror = () => {
                    log('‚ùå Erro ao carregar script', 'error');
                    reject(new Error('Script load failed'));
                };
                
                document.head.appendChild(script);
            });
        }
        
        async function initializeModule() {
            const container = document.getElementById('module-container');
            
            if (!container) {
                throw new Error('Container n√£o encontrado');
            }
            
            if (typeof window.initHybridAgendaModule !== 'function') {
                throw new Error('Fun√ß√£o de inicializa√ß√£o n√£o encontrada');
            }
            
            log('üöÄ Executando inicializa√ß√£o...', 'info');
            await window.initHybridAgendaModule(container);
            log('‚úÖ M√≥dulo inicializado com sucesso', 'success');
            
            // Check if content was rendered
            if (container.querySelector('.module-isolated-hybrid-agenda')) {
                log('‚úÖ Interface renderizada corretamente', 'success');
            } else {
                log('‚ö†Ô∏è Interface pode n√£o ter sido renderizada', 'error');
            }
        }
        
        async function testInteractions() {
            // Test view switcher
            const calendarBtn = document.querySelector('[data-view="calendar"]');
            const listBtn = document.querySelector('[data-view="list"]');
            
            if (calendarBtn && listBtn) {
                log('‚úÖ Bot√µes de visualiza√ß√£o encontrados', 'success');
                
                // Test switching to list view
                listBtn.click();
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (listBtn.classList.contains('active')) {
                    log('‚úÖ Mudan√ßa para visualiza√ß√£o de lista funcionou', 'success');
                } else {
                    log('‚ö†Ô∏è Mudan√ßa de visualiza√ß√£o pode n√£o estar funcionando', 'error');
                }
                
                // Switch back to calendar
                calendarBtn.click();
                await new Promise(resolve => setTimeout(resolve, 100));
                
            } else {
                log('‚ö†Ô∏è Bot√µes de visualiza√ß√£o n√£o encontrados', 'error');
            }
            
            // Test create button
            const createBtn = document.querySelector('.create-agenda-btn');
            if (createBtn) {
                log('‚úÖ Bot√£o de criar agendamento encontrado', 'success');
                
                // Test clicking (should show menu)
                createBtn.click();
                await new Promise(resolve => setTimeout(resolve, 200));
                
                const menu = document.querySelector('.scheduling-menu-overlay');
                if (menu) {
                    log('‚úÖ Menu de agendamento abriu corretamente', 'success');
                    
                    // Close menu
                    if (window.closeCreateMenu) {
                        window.closeCreateMenu();
                        log('‚úÖ Menu fechado com sucesso', 'success');
                    }
                } else {
                    log('‚ö†Ô∏è Menu de agendamento n√£o abriu', 'error');
                }
                
            } else {
                log('‚ö†Ô∏è Bot√£o de criar agendamento n√£o encontrado', 'error');
            }
        }
        
        async function testSPAIntegration() {
            log('üîÑ Testando integra√ß√£o com SPA Router...', 'info');
            
            try {
                // Load SPA router if not loaded
                if (!window.router) {
                    log('üì¶ Carregando SPA Router...', 'info');
                    
                    const script = document.createElement('script');
                    script.src = '/js/dashboard/spa-router.js';
                    
                    await new Promise((resolve, reject) => {
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    
                    // Wait for router initialization
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                if (window.router && typeof window.router.navigateTo === 'function') {
                    log('‚úÖ SPA Router dispon√≠vel', 'success');
                    
                    // Test navigation
                    log('üîÑ Testando navega√ß√£o para hybrid-agenda...', 'info');
                    window.router.navigateTo('hybrid-agenda');
                    
                    // Wait for navigation
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    log('‚úÖ Navega√ß√£o SPA testada', 'success');
                    
                } else {
                    log('‚ùå SPA Router n√£o dispon√≠vel', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste SPA: ${error.message}`, 'error');
            }
        }
        
        // Auto-start basic test
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                log('üîç Sistema carregado, pronto para testes', 'info');
                log('üí° Clique em "Executar Teste Completo" para iniciar', 'info');
            }, 1000);
        });
    </script>
</body>
</html>