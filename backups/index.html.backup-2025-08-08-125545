<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ü•ã Krav Maga Academy - Dashboard</title>
    
    <!-- Core CSS -->
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/modules/dashboard.css">
    <link rel="stylesheet" href="/css/enhanced-tabs.css">
    
    <!-- Loading Styles -->
    <style>
        .loading-dashboard {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            padding: 2rem;
            background: #0f172a;
            color: #f8fafc;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Dashboard Container -->
    <div id="dashboardContainer" class="dashboard-container">
        <!-- Loading state -->
        <div id="loadingState" class="loading-dashboard">
            <div class="loading-spinner"></div>
            <div class="loading-text">Carregando Dashboard...</div>
        </div>
    </div>

    <!-- Core JavaScript -->
    <script src="/js/modules/dashboard-optimized.js"></script>
    <script src="/js/enhanced-tabs.js"></script>
    
    <!-- Navigation and utility functions -->
    <script>
        // Module Loader functionality
        window.ModuleLoader = {
            loadedModules: new Map(),
            isModuleLoaded: function(moduleName) {
                return this.loadedModules.has(moduleName);
            },
            getLoadedModules: function() {
                return Array.from(this.loadedModules.keys());
            }
        };

        // Map modules to their URLs
        const moduleRoutes = {
            'dashboard': '/views/dashboard.html',
            'students': '/views/students.html',
            'student-editor': '/views/student-editor.html',
            'plans': '/views/plans.html',
            'plan-editor': '/views/plan-editor.html',
            'courses': '/views/courses.html',
            'course-editor': '/views/course-editor.html',
            'financial': '/views/financial.html',
            'administrative': '/views/administrative.html',
            'operational': '/views/operational.html',
            'pedagogical': '/views/pedagogical.html'
        };

        // Navigation function
        async function navigateToModule(moduleName, queryParams = '') {
            console.log('üîÑ Navigating to:', moduleName, queryParams ? 'with params: ' + queryParams : '');
            
            // Store query parameters for module use
            if (queryParams) {
                window.history.replaceState(null, '', `?module=${moduleName}${queryParams}`);
            }
            
            if (moduleName === 'dashboard') {
                showDashboard();
                return;
            }

            const route = moduleRoutes[moduleName];
            if (!route) {
                console.error('‚ùå Unknown module:', moduleName);
                return;
            }

            await loadModuleContent(moduleName, route);
        }

        // Load module content
        async function loadModuleContent(moduleName, url) {
            console.log('üîß Loading module content:', moduleName, url);

            try {
                const response = await fetch(url);
                const html = await response.text();
                
                // Extract body content from the HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const bodyContent = doc.body.innerHTML;
                
                console.log('üìÑ Extracted body content preview:', bodyContent.substring(0, 200) + '...');
                
                // Get main content area
                const contentContainer = document.getElementById('contentContainer') || document.getElementById('dashboardContainer');
                
                if (!contentContainer) {
                    console.error('‚ùå Content container not found');
                    return;
                }

                // Hide dashboard content
                const dashboardSection = document.getElementById('dashboard');
                if (dashboardSection) {
                    dashboardSection.style.display = 'none';
                }

                // Remove any existing module content
                const existingModule = document.querySelector('.module-content');
                if (existingModule) {
                    existingModule.remove();
                }

                // Create new module container
                const moduleContainer = document.createElement('div');
                moduleContainer.className = 'module-content';
                moduleContainer.innerHTML = bodyContent;

                // Append to content container
                contentContainer.appendChild(moduleContainer);

                // Enhanced DOM readiness verification
                await new Promise(resolve => {
                    let cycles = 0;
                    const maxCycles = 3;
                    
                    function checkAndWait() {
                        cycles++;
                        
                        const verifyContent = document.querySelector('.module-content');
                        const hasContent = verifyContent && verifyContent.innerHTML.length > 100;
                        
                        console.log(`üîç DOM cycle ${cycles}: Content length = ${hasContent ? verifyContent.innerHTML.length : 0}`);
                        
                        if (cycles >= maxCycles && hasContent) {
                            resolve();
                        } else {
                            requestAnimationFrame(() => {
                                if (cycles < maxCycles) {
                                    checkAndWait();
                                } else {
                                    resolve();
                                }
                            });
                        }
                    }
                    
                    requestAnimationFrame(checkAndWait);
                });

                // Load module assets
                await loadModuleAssets(moduleName);

            } catch (error) {
                console.error('‚ùå Error loading module:', error);
            }
        }

        // Load module assets
        async function loadModuleAssets(moduleName) {
            console.log('üîå Loading assets for module:', moduleName);

            // Load CSS
            const cssPath = `/css/modules/${moduleName}.css`;
            if (!document.querySelector(`link[href="${cssPath}"]`)) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = cssPath;
                document.head.appendChild(link);
            }

            // Load JS
            let jsPath = `/js/modules/${moduleName}.js`;
            if (moduleName === 'student-editor') {
                jsPath = '/js/modules/student-editor/main.js';
            }
            if (!document.querySelector(`script[src="${jsPath}"]`)) {
                const script = document.createElement('script');
                script.src = jsPath;
                
                if (moduleName === 'student-editor') {
                    script.type = 'module';
                }
                
                script.onload = function() {
                    console.log(`‚úÖ Module ${moduleName} JS loaded successfully`);
                    // Initialize module if initialization function exists
                    const initFunctions = {
                        'students': 'initializeStudentsModule',
                        'courses': 'initializeCoursesModule',
                        'course-editor': 'initializeCourseEditorSimpleModule',
                        'plans': 'initializePlansModule',
                        'plan-editor': 'initializePlanEditor',
                        'lesson-plans': 'initializeLessonPlansModule',
                        'lessons': 'initializeLessonsModule',
                        // ADD: ensure student-editor initializes on first load too
                        'student-editor': 'initializeStudentEditor'
                    };
                    
                    const initFunctionName = initFunctions[moduleName];
                    if (initFunctionName && typeof window[initFunctionName] === 'function') {
                        setTimeout(() => {
                            console.log(`üîß Auto-initializing ${moduleName} Module...`);
                            window[initFunctionName]();
                        }, 100);
                    }
                };
                script.onerror = function() {
                    console.error(`‚ùå Failed to load ${moduleName} JS module`);
                };
                document.head.appendChild(script);
            } else {
                // Module already loaded, check if needs initialization
                const initFunctions = {
                    'students': 'initializeStudentsModule',
                    'student-editor': 'initializeStudentEditor',
                    'plans': 'initializePlansModule',
                    'plan-editor': 'initializePlanEditor',
                    'lesson-plans': 'initializeLessonPlansModule',
                    'lessons': 'initializeLessonsModule'
                };
                
                const initFunctionName = initFunctions[moduleName];
                if (initFunctionName && typeof window[initFunctionName] === 'function') {
                    setTimeout(() => {
                        console.log(`üîß Re-initializing ${moduleName} Module...`);
                        window[initFunctionName]();
                    }, 100);
                }
            }
        }

        // Show dashboard function
        function showDashboard() {
            // Remove any module content
            const existingModule = document.querySelector('.module-content');
            if (existingModule) {
                existingModule.remove();
            }

            // Show dashboard content
            const dashboardSection = document.getElementById('dashboard');
            if (dashboardSection) {
                dashboardSection.style.display = 'block';
            }

            // Load dashboard if not already loaded
            if (typeof loadDashboard === 'function') {
                loadDashboard();
            }
        }

        // Export navigation functions
        window.navigateToModule = navigateToModule;
        window.loadModule = navigateToModule;
        window.showDashboard = showDashboard;
        window.goBack = function() {
            console.log('üîÑ Going back to dashboard');
            showDashboard();
        };

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Initializing Dashboard...');
            
            setTimeout(() => {
                if (typeof loadDashboard === 'function') {
                    loadDashboard();
                    console.log('‚úÖ Dashboard initialized');
                } else {
                    console.warn('‚ö†Ô∏è Dashboard module not loaded, retrying...');
                    setTimeout(() => {
                        if (typeof loadDashboard === 'function') {
                            loadDashboard();
                            console.log('‚úÖ Dashboard initialized (retry)');
                        } else {
                            console.error('‚ùå Dashboard module failed to load');
                        }
                    }, 500);
                }
            }, 100);
        });

        console.log('‚úÖ Index initialized');
    </script>
</body>
</html>