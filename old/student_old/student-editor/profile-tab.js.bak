/**
 * Student Editor - Profile Tab Component
 * Gerencia todas as funcionalidades da aba de perfil do estudante
 */

export class ProfileTab {
    constructor(mainController) {
        this.main = mainController;
        this.formData = {};
        this.hasUnsavedChanges = false;
        
        this.init();
    }

    init() {
        console.log('üë§ Inicializando aba de Perfil...');
        this.setupFormElements();
        this.setupValidation();
        this.setupAutoSave();
    }

    setupFormElements() {
        // Mapear todos os campos do formul√°rio (IDs alinhados com student-editor.html)
        this.fields = {
            name: document.getElementById('student-name'),
            email: document.getElementById('student-email'),
            phone: document.getElementById('student-phone'),
            birthdate: document.getElementById('student-birth'),
            cpf: document.getElementById('student-cpf'),
            status: document.getElementById('student-status'),
            whatsapp: document.getElementById('student-whatsapp'),
            emergencyContact: document.getElementById('student-emergency'),
            address: document.getElementById('student-address'),
            medicalObservations: document.getElementById('student-observations'),
            internalNotes: document.getElementById('student-notes')
        };

        // Configurar eventos de mudan√ßa
        Object.entries(this.fields).forEach(([key, element]) => {
            if (element) {
                element.addEventListener('input', () => this.onFieldChange(key, element.value));
                element.addEventListener('blur', () => this.validateField(key, element.value));
            }
        });
    }

    setupValidation() {
        this.validators = {
            name: (value) => {
                if (!value || value.trim().length < 2) {
                    return 'Nome deve ter pelo menos 2 caracteres';
                }
                return null;
            },
            email: (value) => {
                if (!value) return null;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(value)) {
                    return 'Email deve ter um formato v√°lido';
                }
                return null;
            },
            cpf: (value) => {
                if (!value) return null;
                const cleanCPF = value.replace(/\D/g, '');
                if (cleanCPF.length !== 11) {
                    return 'CPF deve ter 11 d√≠gitos';
                }
                return null;
            },
            phone: (value) => {
                if (!value) return null;
                const cleanPhone = value.replace(/\D/g, '');
                if (cleanPhone.length < 10 || cleanPhone.length > 11) {
                    return 'Telefone deve ter 10 ou 11 d√≠gitos';
                }
                return null;
            }
        };
    }

    setupAutoSave() {
        // Auto-salvar a cada 30 segundos se houver mudan√ßas
        setInterval(() => {
            if (this.hasUnsavedChanges) {
                console.log('üíæ Auto-salvando dados do perfil...');
                this.saveToLocalStorage();
            }
        }, 30000);
    }

    onFieldChange(fieldName, value) {
        this.formData[fieldName] = value;
        this.hasUnsavedChanges = true;
        
        // Aplicar m√°scaras
        this.applyMasks(fieldName, value);
        
        // Remover erros visuais ao come√ßar a digitar
        this.clearFieldError(fieldName);
        
        console.log(`üìù Campo ${fieldName} alterado:`, value);
    }

    applyMasks(fieldName, value) {
        const element = this.fields[fieldName];
        if (!element) return;

        switch (fieldName) {
            case 'cpf':
                element.value = this.formatCPF(value);
                break;
            case 'phone':
            case 'whatsapp':
                element.value = this.formatPhone(value);
                break;
        }
    }

    formatCPF(value) {
        const cleanValue = value.replace(/\D/g, '');
        return cleanValue.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    formatPhone(value) {
        const cleanValue = value.replace(/\D/g, '');
        if (cleanValue.length <= 10) {
            return cleanValue.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
        } else {
            return cleanValue.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }
    }

    validateField(fieldName, value) {
        const validator = this.validators[fieldName];
        if (!validator) return true;

        const error = validator(value);
        if (error) {
            this.showFieldError(fieldName, error);
            return false;
        } else {
            this.clearFieldError(fieldName);
            return true;
        }
    }

    showFieldError(fieldName, message) {
        const field = this.fields[fieldName];
        if (!field) return;

        field.style.borderColor = '#EF4444';
        
        // Remover erro anterior
        const existingError = field.parentElement.querySelector('.field-error');
        if (existingError) {
            existingError.remove();
        }

        // Adicionar novo erro
        const errorElement = document.createElement('div');
        errorElement.className = 'field-error';
        errorElement.style.cssText = 'color: #EF4444; font-size: 0.75rem; margin-top: 0.25rem;';
        errorElement.textContent = message;
        
        field.parentElement.appendChild(errorElement);
    }

    clearFieldError(fieldName) {
        const field = this.fields[fieldName];
        if (!field) return;

        field.style.borderColor = '';
        
        const existingError = field.parentElement.querySelector('.field-error');
        if (existingError) {
            existingError.remove();
        }
    }

    validateAllFields() {
        let isValid = true;
        
        Object.entries(this.formData).forEach(([fieldName, value]) => {
            if (!this.validateField(fieldName, value)) {
                isValid = false;
            }
        });

        // Validar campos obrigat√≥rios
        const requiredFields = ['name', 'email', 'status'];
        requiredFields.forEach(fieldName => {
            const field = this.fields[fieldName];
            if (field && !field.value.trim()) {
                this.showFieldError(fieldName, 'Este campo √© obrigat√≥rio');
                isValid = false;
            }
        });

        return isValid;
    }

    // M√©todos do ciclo de vida
    onDataLoaded(studentData) {
        console.log('üì• Carregando dados do perfil...');
        
        // Preencher formul√°rio
        Object.entries(this.fields).forEach(([fieldName, element]) => {
            if (element && studentData[fieldName] !== undefined) {
                element.value = studentData[fieldName] || '';
                this.formData[fieldName] = studentData[fieldName] || '';
            }
        });

        this.hasUnsavedChanges = false;
        console.log('‚úÖ Dados do perfil carregados');
    }

    onTabActivated() {
        console.log('üë§ Aba de perfil ativada');
        
        // Focar no primeiro campo se estiver vazio
        if (this.fields.name && !this.fields.name.value) {
            this.fields.name.focus();
        }
    }

    async collectData() {
        console.log('üìä Coletando dados do perfil...');
        
        // Validar antes de coletar
        if (!this.validateAllFields()) {
            throw new Error('Existem campos inv√°lidos no perfil');
        }

        // Coletar dados atuais dos campos
        const currentData = {};
        Object.entries(this.fields).forEach(([fieldName, element]) => {
            if (element) {
                currentData[fieldName] = element.value.trim();
            }
        });

        this.formData = currentData;
        this.hasUnsavedChanges = false;
        
        return currentData;
    }

    saveToLocalStorage() {
        try {
            const storageKey = `student_profile_${this.main.currentStudentId}`;
            localStorage.setItem(storageKey, JSON.stringify(this.formData));
            console.log('üíæ Dados do perfil salvos localmente');
        } catch (error) {
            console.error('‚ùå Erro ao salvar localmente:', error);
        }
    }

    loadFromLocalStorage() {
        try {
            const storageKey = `student_profile_${this.main.currentStudentId}`;
            const savedData = localStorage.getItem(storageKey);
            
            if (savedData) {
                this.formData = JSON.parse(savedData);
                
                // Preencher campos com dados salvos
                Object.entries(this.formData).forEach(([fieldName, value]) => {
                    const field = this.fields[fieldName];
                    if (field && value) {
                        field.value = value;
                    }
                });
                
                this.hasUnsavedChanges = true;
                console.log('üì• Dados do perfil carregados do localStorage');
                return true;
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar do localStorage:', error);
        }
        
        return false;
    }

    clearLocalStorage() {
        try {
            const storageKey = `student_profile_${this.main.currentStudentId}`;
            localStorage.removeItem(storageKey);
            console.log('üóëÔ∏è Dados locais do perfil removidos');
        } catch (error) {
            console.error('‚ùå Erro ao limpar localStorage:', error);
        }
    }

    // M√©todos p√∫blicos para controle externo
    reset() {
        this.formData = {};
        this.hasUnsavedChanges = false;
        
        Object.values(this.fields).forEach(field => {
            if (field) {
                field.value = '';
                this.clearFieldError(field.name);
            }
        });
        
        this.clearLocalStorage();
    }

    hasChanges() {
        return this.hasUnsavedChanges;
    }
}
