<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Plans Module - Fixed</title>
    <link rel="stylesheet" href="public/css/design-system.css">
    <link rel="stylesheet" href="public/css/modules.css">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-primary);
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-output {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            margin: 10px 0;
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a87;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Plans Module Test - Fixed Version</h1>
        
        <div style="margin: 20px 0;">
            <button class="test-button" onclick="testElementSearch()">1. Test Element Search</button>
            <button class="test-button" onclick="testAPIDirectly()">2. Test API</button>
            <button class="test-button" onclick="testPlansModule()">3. Test Plans Module</button>
            <button class="test-button" onclick="createTableManually()">4. Create Table</button>
        </div>
        
        <div id="debug-output" class="debug-output">Ready for testing...\n</div>
        
        <!-- Plans Module Container with correct structure -->
        <div class="plans-isolated" id="plansContainer">
            <div class="module-header">
                <h2>Planos de Cobrança</h2>
                <div class="module-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="totalPlans">0</span>
                        <span class="stat-label">Total de Planos</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="activePlans">0</span>
                        <span class="stat-label">Planos Ativos</span>
                    </div>
                </div>
            </div>
            
            <div class="module-content">
                <div class="table-container">
                    <table class="module-isolated-table">
                        <thead>
                            <tr>
                                <th>Nome do Plano</th>
                                <th>Categoria</th>
                                <th>Valor Mensal</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="plansTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px;">
                                    Carregando planos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts -->
    <script src="public/js/shared/api-client.js"></script>
    <script src="public/js/modules/plans.js"></script>

    <script>
        const debugOutput = document.getElementById('debug-output');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugOutput.textContent += `[${timestamp}] ${message}\n`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
            console.log(message);
        }

        function testElementSearch() {
            log('=== Testing Element Search ===');
            
            // Test different ways to find the table body
            const methods = [
                { name: 'getElementById', fn: () => document.getElementById('plansTableBody') },
                { name: 'querySelector #plansTableBody', fn: () => document.querySelector('#plansTableBody') },
                { name: 'querySelector tbody', fn: () => document.querySelector('tbody') },
                { name: 'querySelectorAll tbody', fn: () => document.querySelectorAll('tbody') },
                { name: 'plans container', fn: () => document.querySelector('.plans-isolated') },
                { name: 'module content', fn: () => document.querySelector('.module-content') }
            ];
            
            methods.forEach(method => {
                try {
                    const result = method.fn();
                    log(`✓ ${method.name}: ${result ? 'Found' : 'Not found'} ${result ? `(${result.tagName})` : ''}`);
                } catch (error) {
                    log(`✗ ${method.name}: Error - ${error.message}`);
                }
            });
        }

        async function testAPIDirectly() {
            log('=== Testing API Directly ===');
            
            try {
                const response = await fetch('/api/billing-plans');
                const data = await response.json();
                log(`✓ API Response: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                log(`✗ API Error: ${error.message}`);
            }
        }

        async function testPlansModule() {
            log('=== Testing Plans Module ===');
            
            try {
                log('1. Checking if PlansModule exists...');
                if (typeof window.PlansModule === 'undefined') {
                    log('✗ PlansModule not found');
                    return;
                }
                log('✓ PlansModule found');
                
                log('2. Checking if init function exists...');
                if (typeof window.PlansModule.init !== 'function') {
                    log('✗ PlansModule.init not found');
                    return;
                }
                log('✓ PlansModule.init found');
                
                log('3. Initializing module...');
                await window.PlansModule.init();
                log('✓ Module initialized');
                
            } catch (error) {
                log(`✗ Module test error: ${error.message}`);
            }
        }

        function createTableManually() {
            log('=== Creating Table Manually ===');
            
            const tableBody = document.getElementById('plansTableBody');
            if (!tableBody) {
                log('✗ Table body not found');
                return;
            }
            
            const testPlans = [
                { id: 1, name: 'Plano Básico', price: 99.9, category: 'ADULT', isActive: true },
                { id: 2, name: 'Plano Premium', price: 149.9, category: 'ADULT', isActive: true }
            ];
            
            let html = '';
            testPlans.forEach(plan => {
                html += `
                    <tr>
                        <td>${plan.name}</td>
                        <td>${plan.category}</td>
                        <td>R$ ${plan.price}</td>
                        <td>${plan.isActive ? 'Ativo' : 'Inativo'}</td>
                        <td>
                            <button class="test-button">Editar</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            log('✓ Table created manually with test data');
            
            // Update stats
            document.getElementById('totalPlans').textContent = testPlans.length;
            document.getElementById('activePlans').textContent = testPlans.filter(p => p.isActive).length;
        }

        // Auto-run when page loads
        window.addEventListener('DOMContentLoaded', function() {
            log('Page loaded, running automatic tests...');
            setTimeout(() => {
                testElementSearch();
                setTimeout(() => {
                    testAPIDirectly();
                }, 1000);
            }, 500);
        });
    </script>
</body>
</html>
